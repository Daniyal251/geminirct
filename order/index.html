<!DOCTYPE html><html lang="ru"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5.0">
<title>–ó–∞–∫–∞–∑–∞—Ç—å ‚Äî RCT</title>
<meta name="description" content="–û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É —Å–∞–π—Ç–∞, AI-–∫–æ–Ω—Ç–µ–Ω—Ç, –ò–ò-–∞–≥–µ–Ω—Ç–∞ –∏–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ –º–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;500;600;700;800;900&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#060a14;--bg2:#0c1220;--bg3:#121a2c;--bg4:#1a2540;
--accent:#00e5a0;--accent2:#00c48c;
--blue:#3b82f6;--purple:#8b5cf6;--orange:#f59e0b;
--text:#edf2f7;--text2:#94a3b8;--text3:#64748b;
--border:rgba(255,255,255,.06);--border2:rgba(255,255,255,.1);
--font-d:'Unbounded',sans-serif;--font-b:'Manrope',sans-serif;--max:1240px}
html{scroll-behavior:smooth}
body{font-family:var(--font-b);background:var(--bg);color:var(--text);overflow-x:hidden;-webkit-font-smoothing:antialiased;line-height:1.6}
a{color:inherit;text-decoration:none}
::selection{background:var(--accent);color:var(--bg)}

/* NAV */
.nav{position:fixed;top:0;left:0;width:100%;z-index:100;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;transition:all .3s;background:rgba(6,10,20,.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
.nav-logo{font-family:var(--font-d);font-size:15px;font-weight:700;color:var(--accent)}
.nav-logo span{color:var(--text2);font-weight:400;font-size:11px;margin-left:6px}
.nav-links{display:flex;gap:20px;align-items:center}
.nav-links a{font-size:12.5px;font-weight:500;color:var(--text2);transition:color .2s}
.nav-links a:hover{color:var(--text)}
.nav-r{display:flex;gap:10px;align-items:center}
.nav-login{font-size:12px;color:var(--text2);padding:6px 14px;border:1px solid var(--border2);border-radius:8px;transition:all .25s}
.nav-login:hover{border-color:var(--accent);color:var(--accent)}
.burger{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:8px}
.burger span{width:20px;height:2px;background:var(--text);transition:all .3s}
.mob-menu{display:none;position:fixed;top:56px;left:0;width:100%;background:var(--bg2);border-bottom:1px solid var(--border);padding:16px 20px;flex-direction:column;gap:12px;z-index:99}
.mob-menu.show{display:flex}
.mob-menu a{font-size:13px;color:var(--text2);padding:8px 0}
@media(max-width:900px){.nav-links,.nav-r{display:none}.burger{display:flex}}

/* FORM */
.page{padding:100px 20px 60px}
.w{max-width:680px;margin:0 auto}
.page-title{font-family:var(--font-d);font-size:28px;font-weight:800;margin-bottom:8px;text-align:center}
.page-sub{font-size:14px;color:var(--text2);text-align:center;margin-bottom:40px;line-height:1.7}

.form-card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:32px}
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.form-input,.form-select,.form-textarea{width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:10px;padding:12px 14px;font-size:14px;font-family:var(--font-b);color:var(--text);transition:border-color .2s;outline:none}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent)}
.form-input::placeholder,.form-textarea::placeholder{color:var(--text3)}
.form-select{appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}
.form-select option{background:var(--bg2);color:var(--text)}
.form-textarea{min-height:100px;resize:vertical}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:520px){.form-row{grid-template-columns:1fr}}

.form-dir{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:24px}
.form-dir-btn{padding:10px 8px;border-radius:10px;border:1px solid var(--border2);background:var(--bg3);cursor:pointer;text-align:center;font-size:11px;font-weight:600;color:var(--text2);transition:all .25s;font-family:var(--font-b)}
.form-dir-btn:hover,.form-dir-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(0,229,160,.04)}
.form-dir-btn .dir-icon{font-size:20px;display:block;margin-bottom:4px}
@media(max-width:520px){.form-dir{grid-template-columns:1fr 1fr}}

.btn-submit{width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:var(--bg);font-family:var(--font-d);font-size:14px;font-weight:700;cursor:pointer;transition:all .3s;margin-top:8px}
.btn-submit:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,229,160,.3)}
.btn-submit:disabled{opacity:.5;cursor:not-allowed;transform:none}

.form-success{display:none;text-align:center;padding:40px 20px}
.form-success.show{display:block}
.form-success .check{font-size:48px;margin-bottom:16px}
.form-success h3{font-family:var(--font-d);font-size:20px;margin-bottom:8px}
.form-success p{color:var(--text2);font-size:14px}

.form-alt{text-align:center;margin-top:24px;padding-top:20px;border-top:1px solid var(--border)}
.form-alt p{font-size:12px;color:var(--text3);margin-bottom:10px}
.form-alt-links{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.form-alt-link{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;border:1px solid var(--border2);font-size:12px;font-weight:600;color:var(--text2);transition:all .25s}
.form-alt-link:hover{border-color:var(--accent);color:var(--accent)}

/* Footer */
.ft{border-top:1px solid var(--border);padding:24px;text-align:center}
.ft-copy{font-size:11px;color:var(--text3);line-height:1.8}

/* Animations */
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.form-card{animation:fadeUp .6s ease}

/* Dynamic fields */
.type-fields{display:none}
.type-fields.show{display:block}

/* ‚îÄ‚îÄ ANKETA CHAT ‚îÄ‚îÄ */
.anketa-section{margin-top:24px;background:var(--bg2);border:1px solid var(--border2);border-radius:16px;overflow:hidden}
.anketa-header{padding:20px;text-align:center;border-bottom:1px solid var(--border)}
.anketa-title{font-family:var(--font-d);font-size:16px;font-weight:700;margin-bottom:4px}
.anketa-sub{font-size:12px;color:var(--text2);margin-bottom:12px}
.anketa-progress{height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.anketa-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .5s}
.anketa-progress-text{font-size:11px;color:var(--text3);margin-top:4px}
.anketa-chat{max-height:360px;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth}
.anketa-msg{max-width:85%;padding:10px 14px;border-radius:14px;font-size:13.5px;line-height:1.55;word-wrap:break-word;white-space:pre-wrap}
.anketa-msg.bot{align-self:flex-start;background:var(--bg3);color:var(--text);border-bottom-left-radius:4px}
.anketa-msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent),var(--accent2));color:var(--bg);font-weight:500;border-bottom-right-radius:4px}
.anketa-quick{display:flex;flex-wrap:wrap;gap:6px;padding:0 16px 8px}
.anketa-quick-btn{background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;transition:all .2s;white-space:nowrap;font-family:var(--font-b)}
.anketa-quick-btn:hover{background:var(--accent);color:var(--bg);border-color:var(--accent)}
.anketa-typing{display:none;padding:8px 16px;gap:4px}
.anketa-typing.show{display:flex}
.anketa-typing span{width:6px;height:6px;border-radius:50%;background:var(--text3);animation:dotB 1.4s infinite}
.anketa-typing span:nth-child(2){animation-delay:.2s}
.anketa-typing span:nth-child(3){animation-delay:.4s}
.anketa-input-row{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center}
.anketa-input{flex:1;background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:10px 14px;border-radius:12px;font-size:13.5px;outline:none;font-family:var(--font-b)}
.anketa-input::placeholder{color:var(--text3)}
.anketa-input:focus{border-color:var(--accent)}
.anketa-send{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:var(--bg);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.anketa-send:hover{transform:scale(1.05)}
.anketa-send:disabled{opacity:.4;cursor:not-allowed;transform:none}
.anketa-attach-btn{cursor:pointer;font-size:20px;padding:8px;border-radius:8px;transition:all .2s}
.anketa-attach-btn:hover{background:var(--bg3)}
.anketa-file-preview{padding:0 16px 8px;display:flex;gap:6px;flex-wrap:wrap}
.anketa-file-preview img{width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid var(--border2)}
.anketa-skip{display:block;width:100%;padding:10px;background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;text-align:center;transition:color .2s;font-family:var(--font-b)}
.anketa-skip:hover{color:var(--text)}

/* ‚îÄ‚îÄ REGISTER SUGGESTION ‚îÄ‚îÄ */
.register-section{margin-top:16px}
.register-card{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:24px;text-align:center}
.register-title{font-family:var(--font-d);font-size:15px;font-weight:700;margin-bottom:4px}
.register-sub{font-size:12px;color:var(--text2);margin-bottom:16px}
.register-card .form-input{margin-bottom:8px}
/* ‚îÄ‚îÄ AI CHAT v10 ‚îÄ‚îÄ */
.ai-fab{position:fixed;bottom:24px;right:24px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--accent,#00e5a0),#00b894);border:none;cursor:pointer;z-index:10000;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 20px rgba(0,229,160,.4);transition:all .3s}
.ai-fab:hover{transform:scale(1.1);box-shadow:0 6px 28px rgba(0,229,160,.5)}.ai-fab.open{transform:rotate(90deg) scale(1.1)}
.ai-panel{position:fixed;bottom:96px;right:24px;width:380px;max-width:calc(100vw - 32px);height:520px;max-height:calc(100vh - 140px);background:var(--bg2,#0c1220);border:1px solid var(--border2,rgba(255,255,255,.1));border-radius:20px;z-index:10001;display:none;flex-direction:column;overflow:hidden;box-shadow:0 12px 48px rgba(0,0,0,.5);animation:chatUp .3s}
.ai-panel.show{display:flex}
@keyframes chatUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.ai-head{padding:16px 20px;background:linear-gradient(135deg,rgba(0,229,160,.1),rgba(0,184,148,.05));border-bottom:1px solid var(--border,rgba(255,255,255,.06));display:flex;align-items:center;gap:12px}
.ai-head-info{flex:1}.ai-head-title{font-size:15px;font-weight:700;color:var(--text,#edf2f7)}.ai-head-sub{font-size:12px;color:var(--text2,#94a3b8);margin-top:2px}
.ai-head-dot{width:8px;height:8px;border-radius:50%;background:#00e5a0;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.ai-close{background:none;border:none;color:var(--text3,#64748b);font-size:22px;cursor:pointer;padding:4px 8px;border-radius:8px}.ai-close:hover{background:rgba(255,255,255,.05);color:var(--text,#edf2f7)}
.ai-body{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
.ai-msg{max-width:85%;padding:10px 14px;border-radius:14px;font-size:13.5px;line-height:1.55;word-wrap:break-word;white-space:pre-wrap}
.ai-msg.bot{align-self:flex-start;background:var(--bg3,#121a2c);color:var(--text,#edf2f7);border-bottom-left-radius:4px}
.ai-msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent,#00e5a0),#00b894);color:var(--bg,#060a14);font-weight:500;border-bottom-right-radius:4px}
.ai-msg .ai-model{display:block;font-size:10px;color:var(--text3,#64748b);margin-top:6px;font-style:italic}
.ai-typing{align-self:flex-start;padding:12px 16px;background:var(--bg3,#121a2c);border-radius:14px;border-bottom-left-radius:4px;display:none;gap:4px}
.ai-typing.show{display:flex}
.ai-typing span{width:6px;height:6px;border-radius:50%;background:var(--text3,#64748b);animation:dotB 1.4s infinite}.ai-typing span:nth-child(2){animation-delay:.2s}.ai-typing span:nth-child(3){animation-delay:.4s}
@keyframes dotB{0%,60%,100%{opacity:.3;transform:translateY(0)}30%{opacity:1;transform:translateY(-4px)}}
.ai-quick{display:flex;flex-wrap:wrap;gap:6px;padding:0 16px 10px}
.ai-quick-btn{background:var(--bg3,#121a2c);border:1px solid var(--border2,rgba(255,255,255,.1));color:var(--text,#edf2f7);padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;transition:all .2s;white-space:nowrap}.ai-quick-btn:hover{background:var(--accent,#00e5a0);color:var(--bg,#060a14);border-color:var(--accent,#00e5a0)}
.ai-foot{padding:12px 16px;border-top:1px solid var(--border,rgba(255,255,255,.06));display:flex;gap:8px;align-items:center}
.ai-foot input{flex:1;background:var(--bg3,#121a2c);border:1px solid var(--border2,rgba(255,255,255,.1));color:var(--text,#edf2f7);padding:10px 14px;border-radius:12px;font-size:13.5px;outline:none;font-family:inherit}.ai-foot input::placeholder{color:var(--text3,#64748b)}.ai-foot input:focus{border-color:var(--accent,#00e5a0)}
.ai-foot button{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent,#00e5a0),#00b894);border:none;color:var(--bg,#060a14);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}.ai-foot button:hover{transform:scale(1.05)}.ai-foot button:disabled{opacity:.4;cursor:not-allowed;transform:none}
@media(max-width:480px){.ai-panel{bottom:0;right:0;width:100%;height:100vh;max-height:100vh;border-radius:0}.ai-fab{bottom:16px;right:16px;width:52px;height:52px;font-size:24px}}

/* Toast notifications */
.order-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--bg3,#121a2c);color:var(--text,#edf2f7);padding:12px 24px;border-radius:12px;font-size:13px;font-weight:500;z-index:10000;transition:transform .3s ease;border:1px solid var(--border2);box-shadow:0 8px 32px rgba(0,0,0,.4);max-width:90vw;text-align:center}
.order-toast.show{transform:translateX(-50%) translateY(0)}
.order-toast.error{border-color:rgba(255,107,107,.3);background:rgba(255,107,107,.1)}
.order-toast.success{border-color:rgba(0,229,160,.3);background:rgba(0,229,160,.1)}

</style>
</head><body>
<div id="orderToast" class="order-toast"></div>

<!-- NAV -->
<nav class="nav">
<a href="/" class="nav-logo">RCT<span>–≥—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π</span></a>
<div class="nav-links">
<a href="/med/">–ú–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>
<a href="/sites/">–°–∞–π—Ç—ã</a>
<a href="/content/">AI-–∫–æ–Ω—Ç–µ–Ω—Ç</a>
<a href="/ai/">–ò–ò-–∞–≥–µ–Ω—Ç—ã</a>
<a href="/about/">–û –∫–æ–º–ø–∞–Ω–∏–∏</a>
</div>
<div class="nav-r"><a href="/login/" class="nav-login">–í–æ–π—Ç–∏</a></div>
<div class="burger" onclick="document.getElementById('mobMenu').classList.toggle('show')"><span></span><span></span><span></span></div>
</nav>
<div class="mob-menu" id="mobMenu">
<a href="/med/">–ú–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a><a href="/sites/">–°–∞–π—Ç—ã</a><a href="/content/">AI-–∫–æ–Ω—Ç–µ–Ω—Ç</a><a href="/ai/">–ò–ò-–∞–≥–µ–Ω—Ç—ã</a><a href="/about/">–û –∫–æ–º–ø–∞–Ω–∏–∏</a>
<a href="/login/">–í–æ–π—Ç–∏</a>
</div>

<!-- FORM -->
<div class="page">
<div class="w">
<h1 class="page-title">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É</h1>
<p class="page-sub">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É ‚Äî —Å–≤—è–∂–µ–º—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞.</p>

<div class="form-card" id="formCard">

<!-- Direction selector -->
<div class="form-label" style="margin-bottom:10px">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
<div class="form-dir">
<button class="form-dir-btn active" data-dir="sites" onclick="selectDir(this)"><span class="dir-icon">üåê</span>–°–∞–π—Ç</button>
<button class="form-dir-btn" data-dir="content" onclick="selectDir(this)"><span class="dir-icon">üé¨</span>AI-–∫–æ–Ω—Ç–µ–Ω—Ç</button>
<button class="form-dir-btn" data-dir="ai" onclick="selectDir(this)"><span class="dir-icon">ü§ñ</span>–ò–ò-–∞–≥–µ–Ω—Ç</button>
<button class="form-dir-btn" data-dir="med" onclick="selectDir(this)"><span class="dir-icon">üè•</span>–ú–µ–¥–æ–±–æ—Ä—É–¥.</button>
</div>

<!-- Common fields -->
<div class="form-row">
<div class="form-group">
<label class="form-label">–í–∞—à–µ –∏–º—è</label>
<input class="form-input" id="fName" placeholder="–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è">
</div>
<div class="form-group">
<label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
<input class="form-input" id="fPhone" type="tel" placeholder="+7 (___) ___-__-__">
</div>
</div>

<div class="form-row">
<div class="form-group">
<label class="form-label">Telegram</label>
<input class="form-input" id="fTelegram" placeholder="@username">
</div>
<div class="form-group">
<label class="form-label">–ö–æ–º–ø–∞–Ω–∏—è / –ü—Ä–æ–µ–∫—Ç</label>
<input class="form-input" id="fCompany" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞">
</div>
</div>

<div class="form-row">
<div class="form-group">
<label class="form-label">–ì–æ—Ä–æ–¥</label>
<input class="form-input" id="fCity" placeholder="–ö–∞–∑–∞–Ω—å" value="–ö–∞–∑–∞–Ω—å">
</div>
<div class="form-group">
<!-- –ø—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è -->
</div>
</div>

<!-- Sites-specific -->
<div class="type-fields show" id="fieldsSites">
<div class="form-row">
<div class="form-group">
<label class="form-label">–¢–∏–ø —Å–∞–π—Ç–∞</label>
<select class="form-select" id="fSiteType" onchange="toggleSiteUpgrade()">
<option value="–í–∏–∑–∏—Ç–∫–∞">–í–∏–∑–∏—Ç–∫–∞ ‚Äî 5 000 ‚ÇΩ</option>
<option value="–õ–µ–Ω–¥–∏–Ω–≥" selected>–õ–µ–Ω–¥–∏–Ω–≥ ‚Äî 10 000 ‚ÇΩ</option>
<option value="–ö–∞—Ç–∞–ª–æ–≥">–ö–∞—Ç–∞–ª–æ–≥ ‚Äî 15 000 ‚ÇΩ</option>
<option value="–ü—Ä–µ–º–∏—É–º">–ü—Ä–µ–º–∏—É–º ‚Äî 25 000 ‚ÇΩ</option>
<option value="–£–ª—É—á—à–µ–Ω–∏–µ">üîß –£–ª—É—á—à–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–∞–π—Ç–∞ ‚Äî –æ—Ç 3 000 ‚ÇΩ</option>
</select>
</div>
<div class="form-group">
<label class="form-label">–ü—Ä–∏–º–µ—Ä / –†–µ—Ñ–µ—Ä–µ–Ω—Å</label>
<input class="form-input" id="fRef" placeholder="https://example.com">
</div>
</div>
<div id="upgradeFields" style="display:none;margin-bottom:16px">
<div class="form-group">
<label class="form-label">üåê –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à —Ç–µ–∫—É—â–∏–π —Å–∞–π—Ç</label>
<input class="form-input" id="fCurrentSite" placeholder="https://–≤–∞—à-—Å–∞–π—Ç.ru">
</div>
<div class="form-group">
<label class="form-label">–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–ª—É—á—à–∏—Ç—å?</label>
<select class="form-select" id="fUpgradeType">
<option value="–î–∏–∑–∞–π–Ω">üé® –û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∑–∞–π–Ω</option>
<option value="–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å">üì± –°–¥–µ–ª–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)</option>
<option value="–°–∫–æ—Ä–æ—Å—Ç—å">‚ö° –£—Å–∫–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É</option>
<option value="SEO">üîç SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</option>
<option value="–ö–æ–Ω—Ç–µ–Ω—Ç">üìù –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∏ —Ç–µ–∫—Å—Ç—ã</option>
<option value="–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª">‚öôÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (—Ñ–æ—Ä–º—ã, —á–∞—Ç, CRM)</option>
<option value="–ü–æ–ª–Ω—ã–π —Ä–µ–¥–∏–∑–∞–π–Ω">üîÑ –ü–æ–ª–Ω—ã–π —Ä–µ–¥–∏–∑–∞–π–Ω</option>
<option value="–î—Ä—É–≥–æ–µ">üí¨ –î—Ä—É–≥–æ–µ (–æ–ø–∏—à—É –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)</option>
</select>
</div>
</div>
</div>

<!-- Content-specific -->
<div class="type-fields" id="fieldsContent">
<div class="form-group">
<label class="form-label">–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
<select class="form-select" id="fContentType">
<option value="–†–µ–∫–ª–∞–º–Ω–æ–µ –≤–∏–¥–µ–æ">–†–µ–∫–ª–∞–º–Ω–æ–µ –≤–∏–¥–µ–æ (Reels/Shorts)</option>
<option value="–§–æ—Ç–æ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞">–§–æ—Ç–æ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞</option>
<option value="–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∏–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä">–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∏–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä</option>
<option value="–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π">–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π</option>
<option value="–î–∏–∑–∞–π–Ω –∏ –≥—Ä–∞—Ñ–∏–∫–∞">–î–∏–∑–∞–π–Ω –∏ –≥—Ä–∞—Ñ–∏–∫–∞</option>
<option value="–§–æ—Ç–æ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤">–§–æ—Ç–æ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤</option>
</select>
</div>
</div>

<!-- AI-specific -->
<div class="type-fields" id="fieldsAi">
<div class="form-group">
<label class="form-label">–ó–∞–¥–∞—á–∞</label>
<select class="form-select" id="fAiType">
<option value="Telegram-–±–æ—Ç">Telegram-–±–æ—Ç —Å –ò–ò</option>
<option value="CRM-–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è">CRM-–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</option>
<option value="–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (n8n)</option>
<option value="–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤</option>
<option value="–ò–ò –¥–ª—è —Å–∞–π—Ç–∞">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Å–∞–π—Ç–∞</option>
<option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
</select>
</div>
</div>

<!-- Med-specific -->
<div class="type-fields" id="fieldsMed">
<div class="form-group">
<label class="form-label">–†–æ–ª—å</label>
<select class="form-select" id="fMedRole">
<option value="–ú–µ–¥—É—á—Ä–µ–∂–¥–µ–Ω–∏–µ">–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ (–∑–∞–∫—É–ø–∫–∞)</option>
<option value="–ò–Ω–≤–µ—Å—Ç–æ—Ä">–ò–Ω–≤–µ—Å—Ç–æ—Ä</option>
<option value="–î–∏—Å—Ç—Ä–∏–±—å—é—Ç–æ—Ä">–î–∏—Å—Ç—Ä–∏–±—å—é—Ç–æ—Ä / –ø–∞—Ä—Ç–Ω—ë—Ä</option>
<option value="–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</option>
<option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
</select>
</div>
</div>

<div class="form-group">
<label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
<textarea class="form-textarea" id="fMessage" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –∑–∞–¥–∞—á–µ –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–µ"></textarea>
</div>

<label style="display:flex;align-items:flex-start;gap:8px;font-size:12px;color:#aaa;cursor:pointer;margin-top:8px">
  <input type="checkbox" id="orderConsent" style="margin-top:2px;accent-color:#00d4aa;flex-shrink:0">
  <span>–Ø —Å–æ–≥–ª–∞—à–∞—é—Å—å —Å <a href="https://rct-hub.ru/hub/#privacy" onclick="if(typeof showLegalPage==='function'){showLegalPage('privacy');return false;}" style="color:#00d4aa">–ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a> –∏ –¥–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</span>
</label>
<button class="btn-submit" id="btnSubmit" onclick="submitForm()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
</div>

<!-- Success + Anketa Chat -->
<div class="form-success" id="formSuccess">
<div class="check">‚úÖ</div>
<h3>–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h3>
<p>–°–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞.</p>

<!-- Anketa AI Chat -->
<div class="anketa-section" id="anketaSection" style="display:none">
<div class="anketa-header">
  <div class="anketa-title">ü§ñ –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –ø—Ä–æ–µ–∫—Ç–µ</div>
  <div class="anketa-sub">–ù–∞—à –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –∑–∞–¥–∞—Å—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ —Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</div>
  <div class="anketa-progress">
    <div class="anketa-progress-bar" id="anketaProgressBar" style="width:0%"></div>
  </div>
  <div class="anketa-progress-text" id="anketaProgressText">–ó–∞–ø–æ–ª–Ω–µ–Ω–æ: 0%</div>
</div>
<div class="anketa-chat" id="anketaBody"></div>
<div class="anketa-quick" id="anketaQuick"></div>
<div class="anketa-typing" id="anketaTyping"><span></span><span></span><span></span></div>
<div class="anketa-input-row">
  <label class="anketa-attach-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ">
    üìé
    <input type="file" id="anketaFiles" multiple accept="image/*" style="display:none" onchange="handleAnketaFiles(event)">
  </label>
  <input class="anketa-input" id="anketaInput" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAnketaMessage()}">
  <button class="anketa-send" id="anketaSendBtn" onclick="sendAnketaMessage()">‚û§</button>
</div>
<div class="anketa-file-preview" id="anketaFilePreview"></div>
<button class="anketa-skip" onclick="skipAnketa()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å ‚Üí —Å–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π –Ω–∞–ø—Ä—è–º—É—é</button>
</div>

<!-- Register suggestion -->
<div class="register-section" id="registerSection" style="display:none">
<div class="register-card">
  <div class="register-title">üí° –•–æ—Ç–∏—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞?</div>
  <div class="register-sub">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ ‚Äî —ç—Ç–æ 15 —Å–µ–∫—É–Ω–¥</div>
  <input class="form-input" id="regName" placeholder="–ò–º—è" disabled>
  <input class="form-input" id="regPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" disabled>
  <input class="form-input" id="regTelegram" placeholder="Telegram" disabled>
  <input class="form-input" id="regPassword" type="password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
  <button class="btn-submit" onclick="quickRegister()" style="margin-top:8px">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <button class="anketa-skip" onclick="skipRegister()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
</div>
</div>

<div class="form-alt-links" style="margin-top:16px" id="directLinks">
<a href="https://t.me/AIhroject_bot" target="_blank" class="form-alt-link">ü§ñ @AIhroject_bot</a>
<a href="mailto:info@rct-hub.ru" class="form-alt-link">üìß info@rct-hub.ru</a>
<a href="tel:+79872255225" class="form-alt-link">üìû +7 987 225-52-25</a>
</div>
</div>

<div class="form-alt">
<p>–ò–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å –Ω–∞–ø—Ä—è–º—É—é</p>
<div class="form-alt-links">
<a href="https://t.me/AIhroject_bot" target="_blank" class="form-alt-link">ü§ñ Telegram-–±–æ—Ç</a>
<a href="tel:+79872255225" class="form-alt-link">üìû +7 987 225-52-25</a>
<a href="mailto:info@rct-hub.ru" class="form-alt-link">üìß Email</a>
</div>
</div>
</div>
</div>

<!-- FOOTER -->
<footer class="ft">
<div class="ft-copy">¬© 2025‚Äì2026 RCT ‚Äî –†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ¬∑ –ö–∞–∑–∞–Ω—å ¬∑ –û–≠–ó ¬´–ò–Ω–Ω–æ–ø–æ–ª–∏—Å¬ª ¬∑ <a href="mailto:info@rct-hub.ru" style="color:var(--accent)">info@rct-hub.ru</a></div>
</footer>

<script>
function toast(msg, type) {
  var el = document.getElementById('orderToast');
  if (!el) return;
  el.textContent = msg;
  el.className = 'order-toast ' + (type || 'success') + ' show';
  setTimeout(function() { el.classList.remove('show'); }, 3500);
}

const SUPABASE_URL = 'https://prparzgqevfelwsndmkc.supabase.co';
const SUPABASE_KEY = 'sb_publishable_gFeXATQGYxKx08BpeOedZg_7buTwVJq';
const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentDir = 'sites';
let lastDirectionId = null; // ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–Ω–∫–µ—Ç—ã

// –ú–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–∞ —Å–∞–π—Ç–∞ ‚Üí —Ü–µ–Ω–∞
const PRICE_MAP = { '–í–∏–∑–∏—Ç–∫–∞': 5000, '–õ–µ–Ω–¥–∏–Ω–≥': 10000, '–ö–∞—Ç–∞–ª–æ–≥': 15000, '–ü—Ä–µ–º–∏—É–º': 25000, '–£–ª—É—á—à–µ–Ω–∏–µ': 3000 };

function toggleSiteUpgrade() {
  var st = document.getElementById('fSiteType').value;
  var uf = document.getElementById('upgradeFields');
  var rf = document.getElementById('fRef');
  if (st === '–£–ª—É—á—à–µ–Ω–∏–µ') {
    uf.style.display = 'block';
    rf.placeholder = '–ü—Ä–∏–º–µ—Ä –Ω–æ–≤–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)';
  } else {
    uf.style.display = 'none';
    rf.placeholder = 'https://example.com';
  }
}

function selectDir(btn) {
  document.querySelectorAll('.form-dir-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentDir = btn.dataset.dir;
  document.querySelectorAll('.type-fields').forEach(f => f.classList.remove('show'));
  const map = {sites:'fieldsSites', content:'fieldsContent', ai:'fieldsAi', med:'fieldsMed'};
  document.getElementById(map[currentDir]).classList.add('show');
}

// –ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø —É—Å–ª—É–≥–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
function getServiceType() {
  if (currentDir === 'sites') return document.getElementById('fSiteType').value;
  if (currentDir === 'content') return document.getElementById('fContentType').value;
  if (currentDir === 'ai') return document.getElementById('fAiType').value;
  if (currentDir === 'med') return document.getElementById('fMedRole').value;
  return '';
}

// –ü–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É
function getServicePrice() {
  if (currentDir === 'sites') return PRICE_MAP[document.getElementById('fSiteType').value] || 0;
  return 0;
}

async function submitForm() {
  const btn = document.getElementById('btnSubmit');
  btn.disabled = true;
  btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

  const name = document.getElementById('fName').value.trim();
  const phone = document.getElementById('fPhone').value.trim();
  const telegram = document.getElementById('fTelegram').value.trim();
  const company = document.getElementById('fCompany').value.trim();
  const city = document.getElementById('fCity').value.trim();
  const message = document.getElementById('fMessage').value.trim();

  if (!document.getElementById('orderConsent')?.checked) {
    toast('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö','error');
    btn.disabled = false;
    btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
    return;
  }
  if (!name || (!phone && !telegram)) {
    toast('–£–∫–∞–∂–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Telegram','error');
    btn.disabled = false;
    btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
    return;
  }

  // Build direction-specific info
  let details = '';
  const serviceType = getServiceType();
  const servicePrice = getServicePrice();

  if (currentDir === 'sites') {
    details = '–¢–∏–ø: ' + serviceType + ' (' + servicePrice.toLocaleString('ru') + '‚ÇΩ)';
    if (serviceType === '–£–ª—É—á—à–µ–Ω–∏–µ') {
      var curSite = (document.getElementById('fCurrentSite')?.value || '').trim();
      var upgradeType = (document.getElementById('fUpgradeType')?.value || '');
      if (curSite) details += ', –¢–µ–∫—É—â–∏–π —Å–∞–π—Ç: ' + curSite;
      if (upgradeType) details += ', –£–ª—É—á—à–µ–Ω–∏–µ: ' + upgradeType;
    }
    if (document.getElementById('fRef').value) details += ', –†–µ—Ñ: ' + document.getElementById('fRef').value;
  }
  if (currentDir === 'content') details = '–¢–∏–ø: ' + serviceType;
  if (currentDir === 'ai') details = '–ó–∞–¥–∞—á–∞: ' + serviceType;
  if (currentDir === 'med') details = '–†–æ–ª—å: ' + serviceType;

  const dirMap = {sites:'–°–∞–π—Ç—ã', content:'AI-–∫–æ–Ω—Ç–µ–Ω—Ç', ai:'–ò–ò-–∞–≥–µ–Ω—Ç—ã', med:'–ú–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'};
  const dirId = 'DIR' + Date.now().toString(36).toUpperCase();

  // Save to Supabase client_requests table (using supabase-js)
  try {
    const comment = [details, message].filter(Boolean).join(' | ');
    const payload = {
      name: name,
      phone: phone,
      telegram: telegram || null,
      company: company,
      city: city,
      direction: dirMap[currentDir],
      details: details,
      message: message,
      comment: comment,
      status: 'new',
      source: 'website_order',
      created_at: new Date().toISOString()
    };

    const { error } = await SB.from('client_requests').insert(payload);

    if (error) {
      console.error('Supabase INSERT error:', error);
      toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏: ' + error.message + '. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.','error');
      btn.disabled = false;
      btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
      return;
    }

    // CRM direction ‚Äî —Å —Ü–µ–Ω–æ–π, —Ç–∏–ø–æ–º –∏ telegram
    lastDirectionId = dirId;
    SB.from('directions').insert({
      id: dirId,
      name: name,
      project: {sites:'–°–∞–π—Ç—ã', content:'AI-–∫–æ–Ω—Ç–µ–Ω—Ç', ai:'–ò–ò-–∞–≥–µ–Ω—Ç—ã', med:'–†–ö–¢'}[currentDir] || '–°–∞–π—Ç—ã',
      status: '–ù–æ–≤—ã–π',
      stage: 'prospect',
      phone: phone,
      telegram_tag: telegram || null,
      city: city || '',
      description: comment || '–ó–∞—è–≤–∫–∞',
      source: '–§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞',
      site_type: serviceType === '–£–ª—É—á—à–µ–Ω–∏–µ' ? '–£–ª—É—á—à–µ–Ω–∏–µ: ' + (document.getElementById('fUpgradeType')?.value || '') : serviceType,
      price: servicePrice,
      business_type: company || '',
      site_url: serviceType === '–£–ª—É—á—à–µ–Ω–∏–µ' ? (document.getElementById('fCurrentSite')?.value || '').trim() || null : null
    }).then(function() {
      console.log('Direction created:', dirId);
    }).catch(function(e) { console.warn('CRM direction error:', e); });

    // Notify via n8n webhook (fire-and-forget)
    var currentSiteUrl = serviceType === '–£–ª—É—á—à–µ–Ω–∏–µ' ? (document.getElementById('fCurrentSite')?.value || '').trim() : '';
    var tgText = 'üìã –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞!\n\n' +
      'üë§ ' + name + '\nüìû ' + (phone || '‚Äî') +
      (telegram ? '\nüí¨ TG: ' + telegram : '') +
      '\nüè¢ ' + (company || '‚Äî') + '\nüìç ' + (city || '‚Äî') +
      '\nüìÇ ' + dirMap[currentDir] + '\n' + details +
      (currentSiteUrl ? '\nüåê –¢–µ–∫—É—â–∏–π —Å–∞–π—Ç: ' + currentSiteUrl : '') +
      (servicePrice ? '\nüí∞ ' + servicePrice.toLocaleString('ru') + '‚ÇΩ' : '') +
      (message ? '\nüí¨ ' + message : '');

    fetch('https://daniyal2212.app.n8n.cloud/webhook/rkt-ai', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'telegram_notify',
        chat_id: '798494835',
        message: tgText,
        userId: 'website'
      })
    }).catch(function(e) { console.warn('n8n notify error:', e); });

    // Fallback: Direct Telegram notification (–µ—Å–ª–∏ n8n –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç)
    sendTelegramDirect(tgText);

  } catch(e) {
    console.error('submitForm error:', e);
    toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message + '. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.','error');
    btn.disabled = false;
    btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
    return;
  }

  // Show success + anketa chat
  document.getElementById('formCard').style.display = 'none';
  document.getElementById('formSuccess').classList.add('show');
  startAnketaChat(dirId, name, getServiceType(), dirMap[currentDir]);
}

// ‚ïê‚ïê‚ïê DIRECT TELEGRAM NOTIFICATION (fallback) ‚ïê‚ïê‚ïê
async function sendTelegramDirect(text) {
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º bot token –∏–∑ Supabase settings
    var res = await fetch(SUPABASE_URL + '/rest/v1/settings?select=key,value&key=in.(telegram_bot_token,telegram_ceo_chat_id)', {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
    });
    var rows = await res.json();
    if (!Array.isArray(rows)) return;
    var cfg = {};
    rows.forEach(function(r) { cfg[r.key] = r.value; });
    var token = cfg.telegram_bot_token;
    var chatId = cfg.telegram_ceo_chat_id || '798494835';
    if (!token) return;

    fetch('https://api.telegram.org/bot' + token + '/sendMessage', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: chatId, text: text, parse_mode: 'HTML' })
    }).catch(function(e) { console.warn('TG direct err:', e); });
  } catch(e) { console.warn('TG direct load err:', e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANKETA AI CHAT ‚Äî —Å–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞—è–≤–∫–∏
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let anketaDirId = null;
let anketaMessages = [];
let anketaSending = false;
let anketaFiles = [];
let anketaCompleteness = 0;

// –¢—Ä–∏–≥–≥–µ—Ä—ã "—Ö–æ—á—É —á–µ–ª–æ–≤–µ–∫–∞"
const HUMAN_TRIGGERS = /–º–µ–Ω–µ–¥–∂–µ—Ä|—á–µ–ª–æ–≤–µ–∫|–æ–ø–µ—Ä–∞—Ç–æ—Ä|—Å–≤—è–∂|–ø–æ–∑–≤–æ–Ω|–ø–µ—Ä–µ–∑–≤–æ–Ω|–∂–∏–≤–æ–π|—Ä–µ–∞–ª—å–Ω|–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å|–ø–æ–∑–≤–∞—Ç—å|–Ω–∞–ø–∏—Å–∞—Ç—å.*–º–µ–Ω–µ–¥–∂–µ—Ä/i;

function startAnketaChat(dirId, clientName, serviceType, direction) {
  anketaDirId = dirId;
  var section = document.getElementById('anketaSection');
  if (!section) return;
  section.style.display = 'block';

  // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞
  var greetings = {
    '–°–∞–π—Ç—ã': '–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞—è–≤–∫—É, ' + clientName + '! üéâ\n\n–ß—Ç–æ–±—ã –º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ —Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Å–∞–π—Ç—É (' + serviceType + '), —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ:\n\n‚Ä¢ –ö–∞–∫–æ–π —É –≤–∞—Å –±–∏–∑–Ω–µ—Å? (—Ä–µ—Å—Ç–æ—Ä–∞–Ω, –º–∞–≥–∞–∑–∏–Ω, —É—Å–ª—É–≥–∏, –∫–ª–∏–Ω–∏–∫–∞...)\n‚Ä¢ –ï—Å—Ç—å –ª–∏ —É–∂–µ –ª–æ–≥–æ—Ç–∏–ø –∏ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å?\n‚Ä¢ –ö–∞–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã –Ω—É–∂–Ω—ã –Ω–∞ —Å–∞–π—Ç–µ?',
    'AI-–∫–æ–Ω—Ç–µ–Ω—Ç': '–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞—è–≤–∫—É, ' + clientName + '! üéâ\n\n–ß—Ç–æ–±—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ AI-–∫–æ–Ω—Ç–µ–Ω—Ç—É (' + serviceType + '), —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ:\n\n‚Ä¢ –î–ª—è –∫–∞–∫–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –Ω—É–∂–µ–Ω –∫–æ–Ω—Ç–µ–Ω—Ç?\n‚Ä¢ –ö–∞–∫–∏–µ –ø–ª–æ—â–∞–¥–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ? (Instagram, YouTube, TikTok...)\n‚Ä¢ –ï—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è?',
    '–ò–ò-–∞–≥–µ–Ω—Ç—ã': '–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞—è–≤–∫—É, ' + clientName + '! üéâ\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –∑–∞–¥–∞—á–µ (' + serviceType + '):\n\n‚Ä¢ –ö–∞–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω—É–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å?\n‚Ä¢ –ö–∞–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã/—Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Å–µ–π—á–∞—Å?\n‚Ä¢ –°–∫–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–æ—Ç–æ–º?',
    '–ú–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ': '–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞—è–≤–∫—É, ' + clientName + '! üéâ\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ:\n\n‚Ä¢ –ö–∞–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?\n‚Ä¢ –û–±—ä—ë–º –∑–∞–∫—É–ø–∫–∏?\n‚Ä¢ –î–ª—è –∫–∞–∫–æ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è?'
  };

  var greeting = greetings[direction] || '–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞—è–≤–∫—É, ' + clientName + '! üéâ\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ.';
  addAnketaMsg(greeting, 'bot');

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º greeting –≤ anketa_chat
  saveAnketaChatMsg(dirId, 'assistant', greeting);

  // Quick buttons –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–∏–ø–∞
  var quickBtns = {
    '–°–∞–π—Ç—ã': [
      {label: 'üçΩ –†–µ—Å—Ç–æ—Ä–∞–Ω', text: '–£ –º–µ–Ω—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω/–∫–∞—Ñ–µ'},
      {label: 'üõç –ú–∞–≥–∞–∑–∏–Ω', text: '–£ –º–µ–Ω—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω'},
      {label: 'üíá –£—Å–ª—É–≥–∏', text: '–Ø –æ–∫–∞–∑—ã–≤–∞—é —É—Å–ª—É–≥–∏ (—Å–∞–ª–æ–Ω, –∫–ª–∏–Ω–∏–∫–∞ –∏ —Ç.–¥.)'},
      {label: 'üè¢ –ö–æ–º–ø–∞–Ω–∏—è', text: '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∞–π—Ç –∫–æ–º–ø–∞–Ω–∏–∏'}
    ],
    'AI-–∫–æ–Ω—Ç–µ–Ω—Ç': [
      {label: 'üì± Reels', text: '–ù—É–∂–Ω—ã Reels/Shorts –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π'},
      {label: 'üì∏ –§–æ—Ç–æ', text: '–ù—É–∂–Ω—ã —Ñ–æ—Ç–æ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞'},
      {label: 'üé® –î–∏–∑–∞–π–Ω', text: '–ù—É–∂–µ–Ω –¥–∏–∑–∞–π–Ω –∏ –≥—Ä–∞—Ñ–∏–∫–∞'},
      {label: 'üë§ –ò–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä', text: '–•–æ—á—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä–∞'}
    ],
    '–ò–ò-–∞–≥–µ–Ω—Ç—ã': [
      {label: 'ü§ñ Telegram-–±–æ—Ç', text: '–ù—É–∂–µ–Ω Telegram-–±–æ—Ç —Å –ò–ò'},
      {label: 'üìä CRM', text: '–ù—É–∂–Ω–∞ CRM-–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è'},
      {label: '‚öôÔ∏è n8n', text: '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —á–µ—Ä–µ–∑ n8n'},
      {label: 'üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è', text: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –º–µ–∂–¥—É —Å–æ–±–æ–π'}
    ]
  };

  var btns = quickBtns[direction] || [];
  var quickEl = document.getElementById('anketaQuick');
  quickEl.innerHTML = btns.map(function(b) {
    return '<button class="anketa-quick-btn" onclick="sendAnketaQuick(\'' + b.text.replace(/'/g, "\\'") + '\')">' + b.label + '</button>';
  }).join('');

  // Scroll to anketa
  setTimeout(function() { section.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 300);
}

function addAnketaMsg(text, who) {
  var body = document.getElementById('anketaBody');
  var div = document.createElement('div');
  div.className = 'anketa-msg ' + who;
  if (who === 'bot') {
    div.innerHTML = text.replace(/\n/g, '<br>');
  } else {
    div.textContent = text;
  }
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
}

function sendAnketaQuick(text) {
  document.getElementById('anketaQuick').style.display = 'none';
  addAnketaMsg(text, 'user');
  processAnketaMessage(text);
}

function sendAnketaMessage() {
  var inp = document.getElementById('anketaInput');
  var text = inp.value.trim();
  if (!text || anketaSending) return;
  inp.value = '';
  addAnketaMsg(text, 'user');
  processAnketaMessage(text);
}

async function processAnketaMessage(text) {
  if (anketaSending) return;
  anketaSending = true;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º "—Ö–æ—á—É —á–µ–ª–æ–≤–µ–∫–∞"
  if (HUMAN_TRIGGERS.test(text)) {
    requestHumanContact(text);
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  saveAnketaChatMsg(anketaDirId, 'user', text);
  anketaMessages.push({ role: 'user', content: text });

  // –ü–æ–∫–∞–∑–∞—Ç—å typing
  var typing = document.getElementById('anketaTyping');
  typing.classList.add('show');
  document.getElementById('anketaSendBtn').disabled = true;

  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º AI-–∫–∞—Å–∫–∞–¥ (—Ç–µ –∂–µ –∫–ª—é—á–∏ —á—Ç–æ —É AI Chat v10)
    var systemPrompt = buildAnketaSystemPrompt();
    var msgs = anketaMessages.slice(-12);
    var cascade = aiGetCascade();

    var reply = '';
    var extractedData = null;

    for (var i = 0; i < cascade.length; i++) {
      try {
        var result = await aiCallProvider(cascade[i], text, systemPrompt, msgs, 20000);
        reply = result.text;

        // –ü–∞—Ä—Å–∏–º JSON –±–ª–æ–∫ —Å extracted data
        var jsonMatch = reply.match(/```json\s*([\s\S]*?)```/);
        if (jsonMatch) {
          try {
            extractedData = JSON.parse(jsonMatch[1]);
            reply = reply.replace(/```json[\s\S]*?```/, '').trim();
          } catch(e) {}
        }

        // –ü–∞—Ä—Å–∏–º inline JSON {extracted:..., completeness:...}
        if (!extractedData) {
          var inlineMatch = reply.match(/\{[\s\S]*"extracted"[\s\S]*\}/);
          if (inlineMatch) {
            try {
              extractedData = JSON.parse(inlineMatch[0]);
              reply = reply.replace(inlineMatch[0], '').trim();
            } catch(e) {}
          }
        }

        break; // –£—Å–ø–µ—Ö
      } catch(e) {
        continue; // –°–ª–µ–¥—É—é—â–∞—è –º–æ–¥–µ–ª—å
      }
    }

    if (!reply) {
      reply = '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞–ø—Ä—è–º—É—é: @AIhroject_bot';
    }

    typing.classList.remove('show');
    addAnketaMsg(reply, 'bot');
    anketaMessages.push({ role: 'assistant', content: reply });

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
    saveAnketaChatMsg(anketaDirId, 'assistant', reply, extractedData);

    // –û–±–Ω–æ–≤–ª—è–µ–º completeness
    if (extractedData && extractedData.completeness !== undefined) {
      anketaCompleteness = Math.round(extractedData.completeness * 100);
      document.getElementById('anketaProgressBar').style.width = anketaCompleteness + '%';
      document.getElementById('anketaProgressText').textContent = '–ó–∞–ø–æ–ª–Ω–µ–Ω–æ: ' + anketaCompleteness + '%';

      // –û–±–Ω–æ–≤–ª—è–µ–º direction –≤ –ë–î
      updateDirectionQuestionnaire(anketaDirId, extractedData);
    }

    // –ï—Å–ª–∏ completeness >= 70%, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    if (anketaCompleteness >= 70) {
      setTimeout(function() { showRegisterSuggestion(); }, 2000);
    }

  } catch(e) {
    typing.classList.remove('show');
    addAnketaMsg('–û—à–∏–±–∫–∞: ' + e.message + '\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'bot');
  }

  anketaSending = false;
  document.getElementById('anketaSendBtn').disabled = false;
  document.getElementById('anketaInput').focus();
}

function buildAnketaSystemPrompt() {
  var dirNames = {sites:'—Å–∞–π—Ç', content:'AI-–∫–æ–Ω—Ç–µ–Ω—Ç', ai:'–ò–ò-–∞–≥–µ–Ω—Ç', med:'–º–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'};
  return '–¢—ã –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ RCT. –ö–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Å—Ç–∞–≤–∏–ª –∑–∞—è–≤–∫—É –Ω–∞ ' + (dirNames[currentDir] || '—É—Å–ª—É–≥—É') + '.\n' +
    '–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–±—Ä–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.\n\n' +
    '–ü–†–ê–í–ò–õ–ê:\n' +
    '1. –ó–∞–¥–∞–≤–∞–π –ø–æ 1-2 –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π\n' +
    '2. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º\n' +
    '3. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫–æ—Ä–æ—Ç–∫–æ\n' +
    '4. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º ‚Äî –æ—Ç–≤–µ—Ç—å —á—Ç–æ –ø–µ—Ä–µ–¥–∞–ª –∑–∞—è–≤–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä—É\n\n' +
    '–ß–¢–û –ù–£–ñ–ù–û –£–ó–ù–ê–¢–¨ (–¥–ª—è ' + (dirNames[currentDir] || '—É—Å–ª—É–≥–∏') + '):\n' +
    (currentDir === 'sites' ?
      '- –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞ (—Ä–µ—Å—Ç–æ—Ä–∞–Ω, –º–∞–≥–∞–∑–∏–Ω, —É—Å–ª—É–≥–∏, –∫–ª–∏–Ω–∏–∫–∞ –∏ —Ç.–¥.)\n- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏/–±—Ä–µ–Ω–¥–∞\n- –ï—Å—Ç—å –ª–∏ –ª–æ–≥–æ—Ç–∏–ø –∏ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å\n- –ö–∞–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã –Ω—É–∂–Ω—ã –Ω–∞ —Å–∞–π—Ç–µ\n- –ï—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç—ã, —Ñ–æ—Ç–æ)\n- –ï—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã/—Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã —Å–∞–π—Ç–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –Ω—Ä–∞–≤—è—Ç—Å—è\n- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è\n- –°—Ä–æ–∫–∏\n' :
    currentDir === 'content' ?
      '- –î–ª—è –∫–∞–∫–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞\n- –ü–ª–æ—â–∞–¥–∫–∏ (Instagram, YouTube, TikTok)\n- –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞\n- –°—Ç–∏–ª—å –∏ —Ç–æ–Ω\n- –ß–∞—Å—Ç–æ—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π\n- –ë—é–¥–∂–µ—Ç\n' :
    currentDir === 'ai' ?
      '- –ö–∞–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å\n- –¢–µ–∫—É—â–∏–µ —Å–∏—Å—Ç–µ–º—ã/—Å–µ—Ä–≤–∏—Å—ã\n- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n- –ë—é–¥–∂–µ—Ç –∏ —Å—Ä–æ–∫–∏\n' :
      '- –ö–∞–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n- –û–±—ä—ë–º\n- –£—á—Ä–µ–∂–¥–µ–Ω–∏–µ\n- –ë—é–¥–∂–µ—Ç\n') +
    '\n–í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å JSON –±–ª–æ–∫ (–Ω–µ–≤–∏–¥–∏–º—ã–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):\n' +
    '```json\n{"extracted":{"business_type":"...","company":"...","services":"...","style":"...", ...—Ç–æ–ª—å–∫–æ —Ç–æ —á—Ç–æ —É–∑–Ω–∞–ª},"completeness":0.3}\n```\n' +
    'completeness ‚Äî –æ—Ç 0.0 –¥–æ 1.0, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–æ–±—Ä–∞–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.';
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ anketa_chat
function saveAnketaChatMsg(dirId, role, content, extractedData) {
  var h = { 'Content-Type':'application/json', 'apikey':SUPABASE_KEY, 'Authorization':'Bearer '+SUPABASE_KEY, 'Prefer':'return=minimal' };
  var body = {
    direction_id: dirId,
    role: role,
    content: content
  };
  if (extractedData) body.extracted_data = extractedData;

  fetch(SUPABASE_URL + '/rest/v1/anketa_chat', {
    method: 'POST',
    headers: h,
    body: JSON.stringify(body)
  }).catch(function(e) { console.warn('anketa_chat save err:', e); });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ questionnaire –∏ completeness –≤ directions
function updateDirectionQuestionnaire(dirId, data) {
  var h = { 'Content-Type':'application/json', 'apikey':SUPABASE_KEY, 'Authorization':'Bearer '+SUPABASE_KEY, 'Prefer':'return=minimal' };
  var patch = {};
  if (data.completeness !== undefined) patch.anketa_completeness = data.completeness;
  if (data.extracted) {
    patch.questionnaire = JSON.stringify({
      _version: 2,
      _last_updated: new Date().toISOString(),
      business_info: data.extracted
    });
    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–ª—è –µ—Å–ª–∏ –∏–∑–≤–ª–µ—á–µ–Ω—ã
    if (data.extracted.business_type) patch.business_type = data.extracted.business_type;
    if (data.extracted.style) patch.style = data.extracted.style;
  }

  fetch(SUPABASE_URL + '/rest/v1/directions?id=eq.' + dirId, {
    method: 'PATCH',
    headers: h,
    body: JSON.stringify(patch)
  }).catch(function(e) { console.warn('direction patch err:', e); });
}

// –ó–∞–ø—Ä–æ—Å —Å–≤—è–∑–∏ —Å —á–µ–ª–æ–≤–µ–∫–æ–º
function requestHumanContact(userText) {
  var name = document.getElementById('fName').value.trim();
  var phone = document.getElementById('fPhone').value.trim();
  var telegram = document.getElementById('fTelegram').value.trim();
  var dirMap = {sites:'–°–∞–π—Ç—ã', content:'AI-–∫–æ–Ω—Ç–µ–Ω—Ç', ai:'–ò–ò-–∞–≥–µ–Ω—Ç—ã', med:'–ú–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'};

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ urgent –∑–∞—è–≤–∫—É
  var h = { 'Content-Type':'application/json', 'apikey':SUPABASE_KEY, 'Authorization':'Bearer '+SUPABASE_KEY, 'Prefer':'return=minimal' };
  fetch(SUPABASE_URL + '/rest/v1/client_requests', {
    method: 'POST',
    headers: h,
    body: JSON.stringify({
      name: name,
      phone: phone,
      telegram: telegram || null,
      direction: dirMap[currentDir] || '',
      comment: '–ó–ê–ü–†–û–° –°–í–Ø–ó–ò –° –ß–ï–õ–û–í–ï–ö–û–ú: ' + userText,
      status: 'new',
      source: 'human_request'
    })
  }).catch(function(e) {});

  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É —á–µ—Ä–µ–∑ TG
  var tgText = 'üÜò –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º!\n\nüë§ ' + name +
    '\nüìû ' + (phone || '‚Äî') + (telegram ? '\nüí¨ TG: ' + telegram : '') +
    '\nüìÇ ' + (dirMap[currentDir] || '‚Äî') +
    '\nüí¨ ' + userText;

  fetch('https://daniyal2212.app.n8n.cloud/webhook/rkt-ai', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'telegram_notify',
      chat_id: '798494835',
      message: tgText,
      userId: 'website'
    })
  }).catch(function(e) {});

  sendTelegramDirect(tgText);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ –∞–Ω–∫–µ—Ç–µ
function handleAnketaFiles(event) {
  var files = event.target.files;
  var preview = document.getElementById('anketaFilePreview');
  anketaFiles = Array.from(files);

  preview.innerHTML = '';
  anketaFiles.forEach(function(f) {
    if (f.type.startsWith('image/')) {
      var img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      preview.appendChild(img);
    }
  });
}

// –ü—Ä–æ–ø—É—Å–∫ –∞–Ω–∫–µ—Ç—ã
function skipAnketa() {
  document.getElementById('anketaSection').style.display = 'none';
  showRegisterSuggestion();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
function showRegisterSuggestion() {
  var section = document.getElementById('registerSection');
  if (!section || section.style.display === 'block') return;
  section.style.display = 'block';

  // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
  var nameEl = document.getElementById('regName');
  var phoneEl = document.getElementById('regPhone');
  var tgEl = document.getElementById('regTelegram');

  if (nameEl) nameEl.value = document.getElementById('fName').value.trim();
  if (phoneEl) phoneEl.value = document.getElementById('fPhone').value.trim();
  if (tgEl) tgEl.value = document.getElementById('fTelegram').value.trim();

  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
async function quickRegister() {
  var password = document.getElementById('regPassword').value.trim();
  if (!password || password.length < 4) {
    toast('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞)','error');
    return;
  }

  var name = document.getElementById('regName').value.trim();
  var phone = document.getElementById('regPhone').value.trim();
  var telegram = document.getElementById('regTelegram').value.trim();

  try {
    var h = { 'Content-Type':'application/json', 'apikey':SUPABASE_KEY, 'Authorization':'Bearer '+SUPABASE_KEY, 'Prefer':'return=minimal' };
    var { error } = await SB.from('client_credentials').insert({
      phone: phone,
      name: name,
      password_hash: password, // –í –∏–¥–µ–∞–ª–µ —Ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      telegram: telegram || null,
      direction_id: lastDirectionId,
      created_at: new Date().toISOString()
    });

    if (error) {
      // –ú–æ–∂–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if (error.message && error.message.includes('duplicate')) {
        toast('–ê–∫–∫–∞—É–Ω—Ç —Å —ç—Ç–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.','error');
      } else {
        toast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message,'error');
      }
      return;
    }

    document.getElementById('registerSection').innerHTML = '<div class="register-card"><div class="check" style="font-size:32px">üéâ</div><div class="register-title">–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!</div><div class="register-sub">–í–æ–π–¥–∏—Ç–µ –≤ <a href="/client/" style="color:var(--accent)">–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a> —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞</div></div>';
  } catch(e) {
    toast('–û—à–∏–±–∫–∞: ' + e.message,'error');
  }
}

function skipRegister() {
  document.getElementById('registerSection').style.display = 'none';
}

// ‚ïê‚ïê‚ïê FEEDBACK FORM ‚Äî –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π ‚ïê‚ïê‚ïê
function openFeedbackForm() {
  // –°–∫—Ä—ã–≤–∞–µ–º AI —á–∞—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ñ–∏–¥–±–µ–∫–∞
  var existing = document.getElementById('feedbackOverlay');
  if (existing) { existing.style.display = 'flex'; return; }

  var overlay = document.createElement('div');
  overlay.id = 'feedbackOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:20000;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.style.display = 'none'; };

  overlay.innerHTML = '<div style="background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:28px;max-width:420px;width:100%">' +
    '<h3 style="font-family:var(--font-d);font-size:16px;margin-bottom:4px">üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h3>' +
    '<p style="font-size:12px;color:var(--text2);margin-bottom:16px">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∑–∞–º–µ—á–∞–Ω–∏—è, –æ—Ç–∑—ã–≤—ã ‚Äî –≤—Å—ë –≤–∞–∂–Ω–æ –¥–ª—è –Ω–∞—Å</p>' +
    '<input class="form-input" id="fbName" placeholder="–í–∞—à–µ –∏–º—è" style="margin-bottom:8px">' +
    '<input class="form-input" id="fbContact" placeholder="Email –∏–ª–∏ Telegram (@username)" style="margin-bottom:8px">' +
    '<textarea class="form-textarea" id="fbMessage" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="min-height:80px;margin-bottom:12px"></textarea>' +
    '<button class="btn-submit" onclick="submitFeedback()" style="margin:0">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>' +
    '<button style="display:block;width:100%;padding:8px;background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;margin-top:8px" onclick="document.getElementById(\'feedbackOverlay\').style.display=\'none\'">–ó–∞–∫—Ä—ã—Ç—å</button>' +
    '</div>';

  document.body.appendChild(overlay);
}

async function submitFeedback() {
  var name = document.getElementById('fbName').value.trim();
  var contact = document.getElementById('fbContact').value.trim();
  var message = document.getElementById('fbMessage').value.trim();

  if (!message) { toast('–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ','error'); return; }

  try {
    var h = { 'Content-Type':'application/json', 'apikey':SUPABASE_KEY, 'Authorization':'Bearer '+SUPABASE_KEY, 'Prefer':'return=minimal' };
    await fetch(SUPABASE_URL + '/rest/v1/client_requests', {
      method: 'POST',
      headers: h,
      body: JSON.stringify({
        name: name || '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å',
        phone: contact || '',
        comment: message,
        source: 'feedback',
        status: 'new',
        direction: '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å'
      })
    });

    // Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    var tgText = 'üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —Å —Å–∞–π—Ç–∞!\n\n' +
      'üë§ ' + (name || '–ê–Ω–æ–Ω–∏–º') + '\n' +
      'üì± ' + (contact || '‚Äî') + '\n' +
      'üí¨ ' + message;
    sendTelegramDirect(tgText);

    document.getElementById('feedbackOverlay').innerHTML = '<div style="background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:40px;max-width:420px;width:100%;text-align:center">' +
      '<div style="font-size:40px;margin-bottom:12px">üéâ</div>' +
      '<h3 style="font-family:var(--font-d);font-size:16px;margin-bottom:8px">–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!</h3>' +
      '<p style="font-size:13px;color:var(--text2)">–ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –µ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º</p>' +
      '<button style="margin-top:16px;padding:10px 24px;background:var(--accent);color:var(--bg);border:none;border-radius:8px;cursor:pointer;font-family:var(--font-b)" onclick="document.getElementById(\'feedbackOverlay\').style.display=\'none\'">–ó–∞–∫—Ä—ã—Ç—å</button>' +
      '</div>';
  } catch(e) {
    toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message,'error');
  }
}
</script>

<!-- AI CHAT v10 Multi-LLM -->
<button class="ai-fab" id="aiFab" onclick="aiToggle()" aria-label="–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç">ü§ñ</button>
<div class="ai-panel" id="aiPanel">
  <div class="ai-head"><div class="ai-head-dot"></div><div class="ai-head-info"><div class="ai-head-title">ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RCT</div><div class="ai-head-sub">Multi-AI ¬∑ Groq + Gemini + Claude + DeepSeek</div></div><button class="ai-close" onclick="aiToggle()">‚úï</button></div>
  <div class="ai-body" id="aiBody"><div class="ai-msg bot">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RCT.<br><br>–†–∞—Å—Å–∫–∞–∂—É –æ–± —É—Å–ª—É–≥–∞—Ö, —Ü–µ–Ω–∞—Ö, —Å—Ä–æ–∫–∞—Ö ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ!</div></div>
  <div class="ai-quick" id="aiQuick">
    <button class="ai-quick-btn" onclick="aiSendQuick('–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Å–∞–π—Ç?')">üí∞ –¶–µ–Ω—ã</button>
    <button class="ai-quick-btn" onclick="aiSendQuick('–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –º–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏')">üè• –ú–µ–¥</button>
    <button class="ai-quick-btn" onclick="aiSendQuick('–ß—Ç–æ —Ç–∞–∫–æ–µ AI-–∫–æ–Ω—Ç–µ–Ω—Ç?')">üé¨ –ö–æ–Ω—Ç–µ–Ω—Ç</button>
    <button class="ai-quick-btn" onclick="aiSendQuick('–•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å')">üìù –ó–∞–∫–∞–∑–∞—Ç—å</button>
    <button class="ai-quick-btn" onclick="aiSendQuick('–•–æ—á—É —Å–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º')">üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä</button>
    <button class="ai-quick-btn" onclick="openFeedbackForm()">üí¨ –û—Ç–∑—ã–≤</button>
  </div>
  <div class="ai-typing" id="aiTyping"><span></span><span></span><span></span></div>
  <div class="ai-foot"><input id="aiInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();aiSend()}"><button id="aiSendBtn" onclick="aiSend()">‚û§</button></div>
</div>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RCT AI CHAT v10 ‚Äî Multi-LLM Cascade: Groq ‚Üí Gemini ‚Üí Claude ‚Üí DeepSeek
// –í—Å–µ –∫–ª—é—á–∏ –∏ –ø—Ä–æ–º–ø—Ç –∏–∑ Supabase. –ï–¥–∏–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AI_SB = {
  url: 'https://prparzgqevfelwsndmkc.supabase.co',
  key: 'sb_publishable_gFeXATQGYxKx08BpeOedZg_7buTwVJq'
};

let aiCfg = {};
let aiOpen = false;
let aiMessages = [];
let aiSession = 'web_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
let aiLeadSaved = false;
let aiReady = false;

const DIR_MAP = {'–°–∞–π—Ç—ã':'–°–∞–π—Ç—ã','AI-–∫–æ–Ω—Ç–µ–Ω—Ç':'AI-–∫–æ–Ω—Ç–µ–Ω—Ç','–ò–ò-–∞–≥–µ–Ω—Ç—ã':'–ò–ò-–∞–≥–µ–Ω—Ç—ã','–ú–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ':'–†–ö–¢'};

// ‚ïê‚ïê‚ïê –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–ê ‚ïê‚ïê‚ïê
async function aiLoadConfig() {
  try {
    var res = await fetch(AI_SB.url + '/rest/v1/settings?select=key,value', {
      headers: { 'apikey': AI_SB.key, 'Authorization': 'Bearer ' + AI_SB.key }
    });
    var rows = await res.json();
    if (!Array.isArray(rows)) return;
    rows.forEach(function(r) { aiCfg[r.key] = r.value || ''; });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–ª—é—á
    var cascade = aiGetCascade();
    aiReady = cascade.length > 0;

    if (aiCfg.ai_chat_greeting) {
      var first = document.querySelector('#aiBody .ai-msg.bot');
      if (first) first.innerHTML = aiCfg.ai_chat_greeting.replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
    }
  } catch(e) { aiReady = false; }
}

function aiGetCascade() {
  var order;
  try { order = JSON.parse(aiCfg.ai_cascade || '["groq","gemini","claude","deepseek"]'); } catch(e) { order = ['groq','gemini','claude','deepseek']; }
  // –§–∏–ª—å—Ç—Ä—É–µ–º ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å –∫–ª—é—á
  return order.filter(function(p) {
    if (p === 'groq') return !!aiCfg.groq_api_key;
    if (p === 'gemini') return !!aiCfg.gemini_api_key;
    if (p === 'claude') return !!aiCfg.claude_api_key;
    if (p === 'deepseek') return !!aiCfg.deepseek_api_key;
    return false;
  });
}

aiLoadConfig();

// ‚ïê‚ïê‚ïê UI FUNCTIONS ‚ïê‚ïê‚ïê
function aiToggle() {
  aiOpen = !aiOpen;
  document.getElementById('aiPanel').classList.toggle('show', aiOpen);
  document.getElementById('aiFab').classList.toggle('open', aiOpen);
  if (aiOpen) document.getElementById('aiInput').focus();
}

function aiAddMsg(text, who, badge) {
  var body = document.getElementById('aiBody');
  var div = document.createElement('div');
  div.className = 'ai-msg ' + who;
  if (who === 'bot') {
    div.innerHTML = text.replace(/\n/g, '<br>');
    if (badge) div.innerHTML += '<span class="ai-model">' + badge + '</span>';
  } else { div.textContent = text; }
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
}

function aiShowTyping(on) {
  var t = document.getElementById('aiTyping');
  if (t) t.classList.toggle('show', on);
  document.getElementById('aiBody').scrollTop = document.getElementById('aiBody').scrollHeight;
}

function aiSetInput(off) {
  document.getElementById('aiSendBtn').disabled = off;
  document.getElementById('aiInput').disabled = off;
}

function aiSendQuick(text) {
  document.getElementById('aiQuick').style.display = 'none';
  aiAddMsg(text, 'user');
  aiCallCascade(text);
}

function aiSend() {
  var inp = document.getElementById('aiInput');
  var text = inp.value.trim();
  if (!text) return;
  inp.value = '';
  document.getElementById('aiQuick').style.display = 'none';
  aiAddMsg(text, 'user');
  aiCallCascade(text);
}

// ‚ïê‚ïê‚ïê –ö–ê–°–ö–ê–î: –ø—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –æ—á–µ—Ä–µ–¥–∏ ‚ïê‚ïê‚ïê
async function aiCallCascade(text) {
  if (!aiReady) {
    await aiLoadConfig();
    if (!aiReady) {
      aiAddMsg('‚ö†Ô∏è –ù–∏ –æ–¥–∏–Ω API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: HUB ‚Üí –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Üí –¥–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á.\n\n–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º: @AIhroject_bot', 'bot');
      return;
    }
  }

  aiSetInput(true);
  aiShowTyping(true);
  aiMessages.push({ role: 'user', content: text });
  if (aiMessages.length > 20) aiMessages = aiMessages.slice(-20);

  // –î–µ—Ç–µ–∫—Ü–∏—è "—Ö–æ—á—É —á–µ–ª–æ–≤–µ–∫–∞" –≤ –æ—Å–Ω–æ–≤–Ω–æ–º AI —á–∞—Ç–µ
  if (HUMAN_TRIGGERS && HUMAN_TRIGGERS.test(text)) {
    requestHumanContact(text);
  }

  var cascade = aiGetCascade();
  var timeout = parseInt(aiCfg.ai_timeout_ms || '15000');
  var systemPrompt = aiCfg.ai_knowledge_base || '–¢—ã –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RCT. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º.';
  var lastError = '';

  for (var i = 0; i < cascade.length; i++) {
    var provider = cascade[i];
    var t0 = Date.now();
    try {
      var result = await aiCallProvider(provider, text, systemPrompt, timeout);
      var duration = Date.now() - t0;

      // –ü–∞—Ä—Å–∏–º [LEAD]
      var reply = result.text;
      var leadMatch = reply.match(/\[LEAD\](.*?)\[\/LEAD\]/s);
      if (leadMatch && !aiLeadSaved) {
        try {
          var lead = JSON.parse(leadMatch[1]);
          if (lead.name && lead.phone) { saveLead(lead); aiLeadSaved = true; }
        } catch(e) {}
        reply = reply.replace(/\[LEAD\].*?\[\/LEAD\]/s, '').trim();
      }

      aiShowTyping(false);
      var badge = result.badge + ' ¬∑ ' + (duration/1000).toFixed(1) + '—Å';
      aiAddMsg(reply, 'bot', badge);
      aiMessages.push({ role: 'assistant', content: reply });

      // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—Ö
      aiLog('chat', text, reply.substring(0, 500), result.model, provider, duration, '', '', result.tokIn, result.tokOut);
      aiSetInput(false);
      document.getElementById('aiInput').focus();
      return; // –£—Å–ø–µ—Ö ‚Äî –≤—ã—Ö–æ–¥–∏–º

    } catch(e) {
      var duration = Date.now() - t0;
      lastError = provider + ': ' + e.message;
      aiLog('error', text, '', provider, provider, duration, e.code || 'ERR', e.message);
      // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å
      continue;
    }
  }

  // –í—Å–µ –º–æ–¥–µ–ª–∏ —É–ø–∞–ª–∏
  aiShowTyping(false);
  aiAddMsg('‚ö†Ô∏è –í—Å–µ –ò–ò-–º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.\n\n–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞–ø—Ä—è–º—É—é:\nü§ñ @AIhroject_bot\nüìß info@rct-hub.ru\nüì± +7 987 225-52-25', 'bot');
  aiSetInput(false);
}

// ‚ïê‚ïê‚ïê –ü–†–û–í–ê–ô–î–ï–†–´ ‚ïê‚ïê‚ïê
async function aiCallProvider(provider, text, systemPrompt, timeout) {
  var msgs = aiMessages.slice(-10);

  if (provider === 'groq') return await aiCallGroq(text, systemPrompt, msgs, timeout);
  if (provider === 'gemini') return await aiCallGemini(text, systemPrompt, msgs, timeout);
  if (provider === 'claude') return await aiCallClaude(text, systemPrompt, msgs, timeout);
  if (provider === 'deepseek') return await aiCallDeepSeek(text, systemPrompt, msgs, timeout);
  throw { message: 'Unknown provider', code: 'UNKNOWN' };
}

// ‚îÄ‚îÄ‚îÄ GROQ (OpenAI-compatible) ‚îÄ‚îÄ‚îÄ
async function aiCallGroq(text, system, msgs, timeout) {
  var ctrl = new AbortController();
  var tm = setTimeout(function(){ ctrl.abort(); }, timeout);
  var model = aiCfg.groq_model || 'llama-3.3-70b-versatile';
  
  var apiMsgs = [{ role: 'system', content: system }];
  msgs.forEach(function(m) { apiMsgs.push({ role: m.role, content: m.content }); });

  var res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + aiCfg.groq_api_key },
    body: JSON.stringify({ model: model, messages: apiMsgs, max_tokens: 1500, temperature: 0.7 }),
    signal: ctrl.signal
  });
  clearTimeout(tm);

  if (!res.ok) { var e = await res.text(); throw { message: e.substring(0, 200), code: String(res.status) }; }
  var data = await res.json();
  return {
    text: data.choices[0].message.content,
    model: model,
    badge: '‚ö° Groq',
    tokIn: data.usage?.prompt_tokens || 0,
    tokOut: data.usage?.completion_tokens || 0
  };
}

// ‚îÄ‚îÄ‚îÄ GEMINI ‚îÄ‚îÄ‚îÄ
async function aiCallGemini(text, system, msgs, timeout) {
  var ctrl = new AbortController();
  var tm = setTimeout(function(){ ctrl.abort(); }, timeout);
  var model = aiCfg.gemini_model || 'gemini-2.0-flash';

  var contents = [];
  msgs.forEach(function(m) {
    contents.push({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.content }] });
  });

  var res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + aiCfg.gemini_api_key, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      system_instruction: { parts: [{ text: system }] },
      contents: contents,
      generationConfig: { maxOutputTokens: 1500, temperature: 0.7 }
    }),
    signal: ctrl.signal
  });
  clearTimeout(tm);

  if (!res.ok) { var e = await res.text(); throw { message: e.substring(0, 200), code: String(res.status) }; }
  var data = await res.json();
  var reply = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
  if (!reply) throw { message: 'Empty response', code: 'EMPTY' };
  return {
    text: reply,
    model: model,
    badge: '‚ú® Gemini',
    tokIn: data.usageMetadata?.promptTokenCount || 0,
    tokOut: data.usageMetadata?.candidatesTokenCount || 0
  };
}

// ‚îÄ‚îÄ‚îÄ CLAUDE ‚îÄ‚îÄ‚îÄ
async function aiCallClaude(text, system, msgs, timeout) {
  var ctrl = new AbortController();
  var tm = setTimeout(function(){ ctrl.abort(); }, timeout);
  var isComplex = text.length > 300 || /HTML|–∫–æ–¥|script|python|–ø—Ä–æ–≥—Ä–∞–º–º|–ø–æ–¥—Ä–æ–±–Ω|–∞–Ω–∞–ª–∏–∑/i.test(text);
  var model = isComplex ? (aiCfg.claude_model_smart || 'claude-sonnet-4-5-20250929') : (aiCfg.claude_model_fast || 'claude-haiku-4-5-20251001');

  var res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': aiCfg.claude_api_key,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({ model: model, max_tokens: isComplex ? 4000 : 1500, system: system, messages: msgs }),
    signal: ctrl.signal
  });
  clearTimeout(tm);

  if (!res.ok) { var e = await res.text(); throw { message: e.substring(0, 200), code: String(res.status) }; }
  var data = await res.json();
  var reply = data.content.map(function(c) { return c.text || ''; }).join('');
  var modelName = model.includes('haiku') ? 'Haiku' : 'Sonnet';
  return {
    text: reply,
    model: model,
    badge: 'üß† Claude ' + modelName,
    tokIn: data.usage?.input_tokens || 0,
    tokOut: data.usage?.output_tokens || 0
  };
}

// ‚îÄ‚îÄ‚îÄ DEEPSEEK (OpenAI-compatible) ‚îÄ‚îÄ‚îÄ
async function aiCallDeepSeek(text, system, msgs, timeout) {
  var ctrl = new AbortController();
  var tm = setTimeout(function(){ ctrl.abort(); }, timeout);
  var model = aiCfg.deepseek_model || 'deepseek-chat';

  var apiMsgs = [{ role: 'system', content: system }];
  msgs.forEach(function(m) { apiMsgs.push({ role: m.role, content: m.content }); });

  var res = await fetch('https://api.deepseek.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + aiCfg.deepseek_api_key },
    body: JSON.stringify({ model: model, messages: apiMsgs, max_tokens: 1500, temperature: 0.7 }),
    signal: ctrl.signal
  });
  clearTimeout(tm);

  if (!res.ok) { var e = await res.text(); throw { message: e.substring(0, 200), code: String(res.status) }; }
  var data = await res.json();
  return {
    text: data.choices[0].message.content,
    model: model,
    badge: 'üêã DeepSeek',
    tokIn: data.usage?.prompt_tokens || 0,
    tokOut: data.usage?.completion_tokens || 0
  };
}

// ‚ïê‚ïê‚ïê –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ‚ïê‚ïê‚ïê
function aiLog(type, userMsg, botReply, model, provider, duration, errCode, errMessage, tokIn, tokOut) {
  try {
    fetch(AI_SB.url + '/rest/v1/ai_logs', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'apikey':AI_SB.key, 'Authorization':'Bearer '+AI_SB.key, 'Prefer':'return=minimal' },
      body: JSON.stringify({
        type: type, source: 'web', session_id: aiSession,
        user_message: (userMsg||'').substring(0, 1000),
        bot_reply: (botReply||'').substring(0, 2000),
        model: model||'', provider: provider||'',
        duration_ms: duration||0,
        tokens_in: tokIn||0, tokens_out: tokOut||0,
        error_code: errCode||'', error_message: (errMessage||'').substring(0, 1000),
        page: location.pathname
      })
    });
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê –°–û–•–†–ê–ù–ï–ù–ò–ï –õ–ò–î–ê ‚ïê‚ïê‚ïê
async function saveLead(lead) {
  var dir = lead.direction || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
  var project = DIR_MAP[dir] || '–°–∞–π—Ç—ã';
  var dirId = 'DIR' + Date.now().toString(36).toUpperCase();
  var h = { 'Content-Type':'application/json', 'apikey':AI_SB.key, 'Authorization':'Bearer '+AI_SB.key, 'Prefer':'return=minimal' };

  try { await fetch(AI_SB.url+'/rest/v1/directions',{method:'POST',headers:h,body:JSON.stringify({id:dirId,name:lead.name,project:project,status:'–ù–æ–≤—ã–π',stage:'prospect',phone:lead.phone,city:lead.city||'',description:lead.comment||'–ó–∞—è–≤–∫–∞ –∏–∑ –ò–ò-—á–∞—Ç–∞',source:'–ò–ò-—á–∞—Ç ('+location.pathname+')'})}); } catch(e){}
  try { await fetch(AI_SB.url+'/rest/v1/client_requests',{method:'POST',headers:h,body:JSON.stringify({name:lead.name,phone:lead.phone,direction:dir,city:lead.city||'',comment:lead.comment||'',source:'ai_chat',page:location.pathname,session_id:aiSession,status:'new'})}); } catch(e){}

  var webhookUrl = aiCfg.n8n_webhook_url || 'https://daniyal2212.app.n8n.cloud/webhook/rkt-ai';
  try { fetch(webhookUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'telegram_notify',chat_id:aiCfg.telegram_ceo_chat_id||'798494835',message:'\ud83c\udd95 –ó–∞—è–≤–∫–∞ —Å –ò–ò-—á–∞—Ç–∞!\n\n\ud83d\udc64 '+lead.name+'\n\ud83d\udcf1 '+lead.phone+'\n\ud83d\udccb '+dir+' ‚Üí '+project+'\n\ud83c\udfd9 '+(lead.city||'‚Äî')+'\n\ud83d\udcac '+(lead.comment||'‚Äî'),chatId:aiCfg.telegram_ceo_chat_id||'798494835'})}); } catch(e){}

  aiLog('lead', lead.name+' | '+lead.phone, dir, '', '', 0, '', '');
}

</script>
</body></html>