<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RKT HUB v14 ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Unbounded:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ===== CSS VARIABLES ===== */
:root {
  --bg: #0a0e17;
  --bg2: #111827;
  --bg3: #1a2234;
  --bg4: #1f2b3d;
  --accent: #00d4aa;
  --accent2: #00b894;
  --accent-glow: rgba(0, 212, 170, 0.15);
  --red: #ff6b6b;
  --red-glow: rgba(255, 107, 107, 0.15);
  --orange: #ffa94d;
  --orange-glow: rgba(255, 169, 77, 0.15);
  --yellow: #ffd43b;
  --blue: #4dabf7;
  --blue-glow: rgba(75, 171, 247, 0.15);
  --purple: #b197fc;
  --purple-glow: rgba(177, 151, 252, 0.15);
  --green: #51cf66;
  --pink: #f06595;
  --text: #e8ecf1;
  --text2: #8899aa;
  --text3: #5a6a7a;
  --border: #243044;
  --border2: #2d3f56;
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
  --shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
  --transition: all 0.2s ease;
  --sidebar-w: 260px;
}

/* ===== RESET ===== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
code, pre, .mono, .login-input, .ai-input, .search-input { font-family: 'JetBrains Mono', monospace !important; }
html { scroll-behavior: smooth; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.5;
}

body::before {
  content: '';
  position: fixed;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(0, 212, 170, 0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(75, 171, 247, 0.04) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(177, 151, 252, 0.03) 0%, transparent 50%);
  z-index: 0;
  pointer-events: none;
}

a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text2); }

/* Auth tabs & telegram button */
.auth-tab { flex:1;padding:10px;border:none;background:transparent;color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;border-radius:8px;transition:all .2s;font-family:inherit }
.auth-tab.active { background:var(--accent);color:#fff }
.auth-tab:not(.active):hover { background:var(--bg4) }
.tg-login-btn { width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid #0088cc;background:rgba(0,136,204,.08);color:#0088cc;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .2s;font-family:inherit }
.tg-login-btn:hover { background:rgba(0,136,204,.15);border-color:#006daa }

/* Staff picker cards */
.staff-pick {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 14px; border-radius: 10px; cursor: pointer;
  border: 1px solid transparent; transition: all .15s;
  background: var(--bg3);
}
.staff-pick:hover { border-color: var(--accent); background: rgba(0,212,170,.06); }
.staff-pick .sp-ava {
  width: 38px; height: 38px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 16px; color: #fff; flex-shrink: 0;
}
.staff-pick .sp-info { flex: 1; min-width: 0; }
.staff-pick .sp-info .sp-n { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.staff-pick .sp-info .sp-r { font-size: 11px; color: var(--text2); }
.staff-pick .sp-tag { font-size: 11px; color: var(--text3); }

/* ============================================================
   LOGIN SCREEN
   ============================================================ */
.login-screen {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  z-index: 9999;
  background: var(--bg);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 20px 0;
}

.login-card {
  background: var(--bg2);
  margin: auto;
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 52px 44px;
  width: 440px;
  max-width: 92vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  animation: loginFadeIn 0.5s ease;
}

@keyframes loginFadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.login-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent), var(--blue), var(--purple), var(--accent));
  background-size: 300% 100%;
  animation: gradientShift 4s ease infinite;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.login-icon { font-size: 72px; margin-bottom: 20px; display: block; }

.login-logo {
  font-family: 'Unbounded', sans-serif;
  font-size: 36px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 6px;
}

.login-sub { color: var(--text2); font-size: 13px; margin-bottom: 36px; }

.login-label {
  display: block;
  text-align: left;
  font-size: 11px;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 10px;
  font-weight: 600;
}

.login-input {
  width: 100%;
  padding: 16px 20px;
  background: var(--bg);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  text-align: center;
  letter-spacing: 3px;
  transition: var(--transition);
  margin-bottom: 10px;
}

.login-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px var(--accent-glow);
}

.login-input::placeholder { color: var(--text3); font-size: 13px; letter-spacing: 0; }

.login-hint { font-size: 11px; color: var(--text2); margin-bottom: 28px; line-height: 1.8; }
.login-hint a { color: var(--accent); font-weight: 600; }

.login-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
  border: none;
  border-radius: var(--radius);
  font-family: 'JetBrains Mono', monospace;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

.login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 170, 0.3); }
.login-btn:active { transform: translateY(0); }
.login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
.btn:disabled, .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; pointer-events: none; }

.login-error {
  color: var(--red);
  font-size: 13px;
  margin-top: 16px;
  display: none;
  padding: 10px;
  background: var(--red-glow);
  border-radius: var(--radius-sm);
}

/* ============================================================
   APP LAYOUT
   ============================================================ */
.app {
  position: relative;
  z-index: 1;
  display: flex;
  min-height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
  width: var(--sidebar-w);
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  z-index: 100;
  transition: transform 0.3s ease, width 0.3s ease;
  overflow: hidden;
}
.sidebar nav { flex: 1; overflow-y: auto; overflow-x: hidden; }

/* Sidebar collapse button */
.sidebar-collapse-btn {
  position: absolute; top: 28px; right: -14px;
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--bg2); border: 1px solid var(--border);
  color: var(--text2); font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  z-index: 101; transition: all 0.3s;
}
.sidebar-collapse-btn:hover { background: var(--accent); color: var(--bg); }

/* Sidebar collapsed state */
.sidebar.collapsed { width: 60px !important; }
.sidebar.collapsed .logo-section span,
.sidebar.collapsed .logo-section .subtitle,
.sidebar.collapsed .nav-item .label,
.sidebar.collapsed .nav-section,
.sidebar.collapsed .user-name,
.sidebar.collapsed .user-role-text,
.sidebar.collapsed .user-info span:not(.user-avatar) { display: none !important; }
.sidebar.collapsed .logo-section h1 { font-size: 14px; }
.sidebar.collapsed .nav-item { justify-content: center; padding: 12px 8px !important; }
.sidebar.collapsed .nav-item .icon { margin: 0; font-size: 18px; }
.sidebar.collapsed .logout-btn { font-size: 0; padding: 10px; justify-content: center; }
.sidebar.collapsed .logout-btn::before { content: '\01F6AA'; font-size: 16px; }
.sidebar.collapsed .logo-section { padding: 16px 10px 14px; text-align: center; }
.sidebar.collapsed + .main { margin-left: 60px !important; }
.sidebar.collapsed .sidebar-collapse-btn { transform: rotate(180deg); }
.sidebar.collapsed .nav-project-header .label,
.sidebar.collapsed .nav-project-header .arrow { display: none !important; }
.sidebar.collapsed .nav-project-header { justify-content: center; padding: 12px 8px !important; }
.sidebar.collapsed .nav-sub { display: none !important; }
@media (max-width: 900px) { .sidebar-collapse-btn { display: none; } }

.logo-section {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
  position: relative;
}

.logo-section h1 {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.logo-section .subtitle { font-size: 11px; color: var(--text2); margin-top: 4px; }

.nav { flex: 1; padding: 12px; }

.nav-section {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 2.5px;
  padding: 20px 12px 8px;
  font-weight: 600;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
  font-size: 13px;
  color: var(--text2);
  text-decoration: none;
  margin-bottom: 2px;
  position: relative;
}

.nav-item:hover { background: var(--bg3); color: var(--text); text-decoration: none; }
.nav-item.active { background: var(--accent-glow); color: var(--accent); }

.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0; top: 25%; bottom: 25%;
  width: 3px;
  background: var(--accent);
  border-radius: 0 3px 3px 0;
}

.nav-item .icon { font-size: 18px; width: 26px; text-align: center; flex-shrink: 0; }
.nav-item .label { flex: 1; }

.nav-item .badge {
  background: var(--accent);
  color: var(--bg);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 12px;
  min-width: 22px;
  text-align: center;
}

.nav-item .badge-orange { background: var(--orange); }
.nav-item .badge-red { background: var(--red); }
.nav-item.hidden { display: none; }

/* Project nav items with sub-sections */
.nav-project { position: relative; }
.nav-project-header {
  display: flex; align-items: center; gap: 12px;
  padding: 11px 14px; border-radius: var(--radius-sm);
  cursor: pointer; transition: var(--transition);
  font-size: 13px; color: var(--text2); margin-bottom: 2px;
}
.nav-project-header:hover { background: var(--bg3); color: var(--text); }
.nav-project-header.active { background: var(--accent-glow); color: var(--accent); }
.nav-project-header .icon { font-size: 18px; width: 26px; text-align: center; flex-shrink: 0; }
.nav-project-header .label { flex: 1; font-weight: 500; }
.nav-project-header .arrow {
  font-size: 12px; color: var(--text3);
  transition: transform 0.3s; flex-shrink: 0;
}
.nav-project-header.open .arrow { transform: rotate(90deg); }
.nav-sub {
  max-height: 0; overflow: hidden;
  transition: max-height 0.3s ease;
  padding-left: 12px;
}
.nav-sub.open { max-height: 400px; }
.nav-sub .nav-item {
  font-size: 12px; padding: 8px 12px 8px 26px;
  color: var(--text3); gap: 8px;
}
.nav-sub .nav-item:hover { color: var(--text); }
.nav-sub .nav-item.active { color: var(--accent); background: var(--accent-glow); }
.nav-sub .nav-item .icon { font-size: 14px; width: 20px; }

  /* Admin Tabs */
  .admin-tabs {
    display: flex; gap: 4px; margin-bottom: 16px;
    background: var(--bg2); padding: 4px;
    border-radius: var(--radius-lg); border: 1px solid var(--border);
    overflow-x: auto; -webkit-overflow-scrolling: touch;
  }
  .admin-tab-btn {
    flex: 1; font-size: 12px; padding: 10px;
    border-radius: var(--radius-sm); border: none; cursor: pointer;
    white-space: nowrap; transition: all 0.2s;
    background: transparent; color: var(--text3);
  }
  .admin-tab-btn.active {
    background: var(--accent); color: var(--bg); font-weight: 600;
  }

/* User bar ‚Äî –ø—Ä–∏–∂–∞—Ç –∫ –Ω–∏–∑—É —á–µ—Ä–µ–∑ flex */
.user-bar {
  padding: 16px 20px;
  border-top: 2px solid var(--red);
  background: var(--bg3);
  flex-shrink: 0;
  z-index: 10;
}

.user-info { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }

.user-avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700; color: var(--bg); flex-shrink: 0;
}

.user-name { font-size: 13px; font-weight: 600; line-height: 1.3; }
.user-role-text { font-size: 11px; color: var(--text2); }

.logout-btn {
  width: 100%;
  padding: 12px;
  background: rgba(255, 107, 107, 0.25);
  border: 1px solid var(--red);
  border-radius: var(--radius-sm);
  color: #ff6b6b;
  font-family: inherit;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-top: 10px;
}

.logout-btn:hover { border-color: var(--red); color: #fff; background: var(--red); }

/* ===== MAIN ===== */
.main {
  flex: 1;
  margin-left: var(--sidebar-w);
  padding: 32px 24px 60px;
  min-height: 100vh;
  overflow-x: hidden;
  box-sizing: border-box;
}

/* ===== PAGE HEADER ===== */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 28px;
  flex-wrap: wrap;
  gap: 12px;
}

.page-header h2 {
  font-family: 'Unbounded', sans-serif;
  font-size: 26px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-header .actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* ===== BREADCRUMB ===== */
.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 18px;
  font-size: 12px;
  color: var(--text2);
}

.breadcrumb a { cursor: pointer; color: var(--text2); transition: var(--transition); }
.breadcrumb a:hover { color: var(--accent); text-decoration: none; }
.breadcrumb .sep { color: var(--text3); }
.breadcrumb .current { color: var(--text); font-weight: 600; }

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  transition: var(--transition);
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
}

.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3); }

.btn-secondary {
  background: var(--bg3);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

.btn-danger {
  background: var(--red-glow);
  color: var(--red);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.btn-danger:hover { background: rgba(255, 107, 107, 0.25); }

.btn-sm { padding: 6px 14px; font-size: 11px; }
.btn-xs { padding: 4px 10px; font-size: 10px; }
.btn-approve { background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(0, 212, 170, 0.3); }
.btn-reject { background: var(--red-glow); color: var(--red); border: 1px solid rgba(255, 107, 107, 0.3); }

.btn-ai {
  background: linear-gradient(135deg, var(--purple), #7950f2);
  color: #fff;
}

.btn-ai:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 15px var(--purple-glow);
}

/* ============================================================
   PROJECT GRID ‚Äî Main screen
   ============================================================ */
.project-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
  gap: 20px;
  margin-bottom: 28px;
}

.project-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.project-card:hover {
  border-color: var(--accent);
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0, 212, 170, 0.15);
}

.project-card-top {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
}

.project-card-header {
  padding: 28px 28px 16px;
  position: relative;
}

.project-card-header .emoji {
  font-size: 52px;
  margin-bottom: 14px;
  display: block;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}

.project-card-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 6px;
}

.project-card-header .desc {
  font-size: 12px;
  color: var(--text2);
  line-height: 1.6;
}

.project-card-stats {
  padding: 0 28px 12px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}

.pcs { text-align: center; padding: 10px 0; }

.pcs .v {
  font-family: 'Unbounded', sans-serif;
  font-size: 24px;
  font-weight: 800;
}

.pcs .l { font-size: 10px; color: var(--text2); margin-top: 2px; }

.project-card-progress {
  padding: 0 28px 24px;
}

.project-card-progress .bar {
  height: 6px;
  background: var(--bg);
  border-radius: 3px;
  overflow: hidden;
}

.project-card-progress .fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s ease;
}

.project-card-progress .info {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
  font-size: 11px;
  color: var(--text2);
}

.status-tag {
  position: absolute;
  top: 18px; right: 18px;
  font-size: 10px;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 600;
}

/* Add new project card */
.project-card.add-card {
  border: 2px dashed var(--border);
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 260px;
  flex-direction: column;
  gap: 12px;
}

.project-card.add-card:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

.project-card.add-card .add-icon {
  font-size: 48px;
  opacity: 0.5;
}

.project-card.add-card .add-text {
  font-size: 14px;
  color: var(--text2);
  font-weight: 600;
}

/* ===== SUBPROJECT GRID ===== */
.subproject-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.subproject-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.subproject-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0, 212, 170, 0.1);
}

.subproject-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.subproject-card .sp-emoji { font-size: 36px; margin-bottom: 10px; display: block; }

.subproject-card h4 {
  font-family: 'Unbounded', sans-serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 4px;
}

.subproject-card .sp-desc {
  font-size: 11px;
  color: var(--text2);
  line-height: 1.5;
  margin-bottom: 12px;
}

.subproject-card .sp-stats {
  display: flex;
  gap: 16px;
  font-size: 11px;
  color: var(--text2);
}

.subproject-card .sp-stats span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.subproject-card.add-sub {
  border: 2px dashed var(--border);
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 8px;
  min-height: 160px;
}

.subproject-card.add-sub:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

/* ===== METRICS ===== */
.metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.metric-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  position: relative;
  overflow: hidden;
  transition: var(--transition);
}

.metric-card:hover {
  border-color: var(--border2);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.metric-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.metric-card:nth-child(1)::after { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
.metric-card:nth-child(2)::after { background: linear-gradient(90deg, var(--blue), #228be6); }
.metric-card:nth-child(3)::after { background: linear-gradient(90deg, var(--orange), #fd7e14); }
.metric-card:nth-child(4)::after { background: linear-gradient(90deg, var(--purple), #7950f2); }
.metric-card:nth-child(5)::after { background: linear-gradient(90deg, var(--green), #37b24d); }

.metric-card .m-icon { font-size: 30px; margin-bottom: 10px; }
.metric-card .m-value { font-family: 'Unbounded', sans-serif; font-size: 32px; font-weight: 900; line-height: 1; }
.metric-card .m-label { font-size: 12px; color: var(--text2); margin-top: 6px; }
.metric-card .m-sub { font-size: 10px; color: var(--text3); margin-top: 4px; }

/* ===== CARDS & TABLES ===== */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 24px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 22px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.card-header h3 {
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.table-wrap { overflow-x: auto; }

table { width: 100%; border-collapse: collapse; font-size: 13px; }

thead th {
  text-align: left;
  padding: 12px 18px;
  color: var(--text2);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  border-bottom: 1px solid var(--border);
  background: var(--bg3);
  white-space: nowrap;
  position: sticky;
  top: 0;
  z-index: 2;
}

tbody td {
  padding: 13px 18px;
  border-bottom: 1px solid rgba(36, 48, 68, 0.4);
  vertical-align: middle;
}

tbody tr { transition: background 0.15s; }
tbody tr:hover td { background: rgba(0, 212, 170, 0.03); }
tbody tr:last-child td { border-bottom: none; }

/* ===== STATUS & BADGES ===== */
.status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.s-active { background: var(--accent-glow); color: var(--accent); }
.s-talks { background: var(--orange-glow); color: var(--orange); }
.s-research { background: var(--blue-glow); color: var(--blue); }
.s-pause { background: rgba(136, 153, 170, 0.15); color: var(--text2); }
.s-urgent { background: var(--red-glow); color: var(--red); }
.s-work { background: var(--purple-glow); color: var(--purple); }
.s-done { background: rgba(81, 207, 102, 0.15); color: var(--green); }

.p1 { color: var(--red); font-weight: 700; }
.p2 { color: var(--orange); font-weight: 600; }
.p3 { color: var(--text2); }

.progress-wrap { display: flex; align-items: center; gap: 10px; }

.progress-bar {
  width: 90px; height: 7px;
  background: var(--bg);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}

.progress-text { font-size: 11px; color: var(--text2); font-weight: 600; min-width: 30px; }

/* ===== ACTION BUTTONS ===== */
.actions-cell { display: flex; gap: 5px; }

.act-btn {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 14px;
  transition: var(--transition);
}

.act-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
.act-btn.del:hover { border-color: var(--red); color: var(--red); background: var(--red-glow); }
.act-btn.view:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-glow); }
.act-btn.ai:hover { border-color: var(--purple); color: var(--purple); background: var(--purple-glow); }

/* ===== FILTERS ===== */
.filters-bar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 18px;
  align-items: center;
}

.filter-chip {
  padding: 7px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.filter-chip:hover { border-color: var(--accent); color: var(--text); }
.filter-chip.active { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); font-weight: 600; }

.search-input {
  padding: 8px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  width: 220px;
  transition: var(--transition);
}

.search-input:focus { outline: none; border-color: var(--accent); width: 280px; }
.search-input::placeholder { color: var(--text3); }

/* ===== TABS ===== */
.tabs {
  display: flex;
  gap: 4px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
  overflow-x: auto;
}

.tab {
  padding: 10px 18px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: var(--transition);
  white-space: nowrap;
  font-family: 'JetBrains Mono', monospace;
}

.tab:hover { color: var(--text); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

/* ============================================================
   AI CHAT PANEL ‚Äî Inside task view
   ============================================================ */
.ai-panel {
  background: var(--bg2);
  border: 1px solid var(--purple);
  border-radius: var(--radius);
  overflow: hidden;
  margin-top: 20px;
}

.ai-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  background: linear-gradient(135deg, rgba(177, 151, 252, 0.1), rgba(121, 80, 242, 0.05));
  border-bottom: 1px solid rgba(177, 151, 252, 0.2);
}

.ai-panel-header h4 {
  font-size: 14px;
  font-weight: 600;
  color: var(--purple);
  display: flex;
  align-items: center;
  gap: 8px;
}

.ai-chat-messages {
  padding: 16px 20px;
  max-height: 400px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.ai-msg {
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  line-height: 1.6;
  max-width: 90%;
  animation: fadeInMsg 0.3s ease;
}

@keyframes fadeInMsg {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.ai-msg.assistant {
  background: rgba(177, 151, 252, 0.08);
  border: 1px solid rgba(177, 151, 252, 0.15);
  color: var(--text);
  align-self: flex-start;
}

.ai-msg.user {
  background: var(--accent-glow);
  border: 1px solid rgba(0, 212, 170, 0.2);
  color: var(--text);
  align-self: flex-end;
}

.ai-msg.system {
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text2);
  font-size: 12px;
  text-align: center;
  align-self: center;
}

.ai-suggestions {
  padding: 12px 20px;
  border-top: 1px solid rgba(177, 151, 252, 0.15);
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.ai-suggestion-btn {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid rgba(177, 151, 252, 0.3);
  background: rgba(177, 151, 252, 0.05);
  color: var(--purple);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: var(--transition);
}

.ai-suggestion-btn:hover {
  background: rgba(177, 151, 252, 0.15);
  border-color: var(--purple);
}

.ai-input-area {
  display: flex;
  gap: 8px;
  padding: 14px 20px;
  border-top: 1px solid rgba(177, 151, 252, 0.15);
  background: rgba(26, 34, 52, 0.5);
}

.ai-input {
  flex: 1;
  padding: 10px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  transition: var(--transition);
}

.ai-input:focus {
  outline: none;
  border-color: var(--purple);
  box-shadow: 0 0 0 3px var(--purple-glow);
}

.ai-input::placeholder { color: var(--text3); }

.ai-send-btn {
  padding: 10px 18px;
  background: linear-gradient(135deg, var(--purple), #7950f2);
  color: #fff;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.ai-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px var(--purple-glow); }
.ai-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* Loading dots animation */
.ai-loading { display: flex; gap: 4px; padding: 8px 0; }
.ai-loading span {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--purple);
  animation: aiDots 1.4s infinite both;
}
.ai-loading span:nth-child(2) { animation-delay: 0.2s; }
.ai-loading span:nth-child(3) { animation-delay: 0.4s; }

@keyframes aiDots {
  0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1); }
}

/* ============================================================
   ANKETA AI CHAT
   ============================================================ */
.anketa-chat { display:flex; flex-direction:column; height:100%; min-height:400px; background:var(--bg); border:1px solid var(--border); border-radius:var(--radius-lg); overflow:hidden; }
.anketa-chat.compact { min-height:280px; max-height:420px; }
.anketa-chat-header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; background:rgba(26,34,52,0.6); flex-shrink:0; }
.anketa-chat-header h3 { margin:0; font-size:14px; flex:1; }
.anketa-completeness-bar { width:120px; height:6px; background:var(--bg3); border-radius:3px; overflow:hidden; flex-shrink:0; }
.anketa-completeness-bar > div { height:100%; background:linear-gradient(90deg,var(--purple),var(--green)); border-radius:3px; transition:width 0.5s ease; }
.anketa-completeness-pct { font-size:11px; color:var(--text2); font-weight:600; min-width:28px; text-align:right; }
.anketa-subtabs { display:flex; gap:0; border-bottom:1px solid var(--border); flex-shrink:0; }
.anketa-subtab { flex:1; padding:8px 12px; text-align:center; font-size:12px; font-weight:600; cursor:pointer; border-bottom:2px solid transparent; color:var(--text2); transition:var(--transition); background:none; border-top:none; border-left:none; border-right:none; }
.anketa-subtab:hover { color:var(--text); background:rgba(177,151,252,0.05); }
.anketa-subtab.active { color:var(--purple); border-bottom-color:var(--purple); }
.anketa-messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:10px; scroll-behavior:smooth; }
.anketa-msg { padding:10px 14px; border-radius:12px; font-size:13px; line-height:1.5; max-width:85%; animation:fadeInMsg 0.3s ease; word-wrap:break-word; }
.anketa-msg.assistant { background:rgba(177,151,252,0.08); border:1px solid rgba(177,151,252,0.15); color:var(--text); align-self:flex-start; }
.anketa-msg.user { background:var(--accent-glow); border:1px solid rgba(0,212,170,0.2); color:var(--text); align-self:flex-end; }
.anketa-msg.system { background:var(--bg3); border:1px solid var(--border); color:var(--text2); font-size:11px; text-align:center; align-self:center; max-width:100%; }
.anketa-msg .media-grid { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
.anketa-msg .media-thumb { width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid var(--border); cursor:pointer; transition:var(--transition); }
.anketa-msg .media-thumb:hover { transform:scale(1.05); border-color:var(--purple); }
.anketa-msg .file-card { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:var(--bg2); border:1px solid var(--border); border-radius:8px; margin-top:8px; font-size:12px; }
.anketa-msg .file-card .file-actions { display:flex; gap:4px; margin-left:8px; }
.anketa-msg .file-card .file-actions button { padding:2px 8px; font-size:11px; border-radius:4px; border:1px solid var(--border); background:var(--bg3); color:var(--text); cursor:pointer; }
.anketa-msg .file-card .file-actions button:hover { border-color:var(--purple); color:var(--purple); }
.anketa-site-preview { margin-top:10px; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:var(--bg2); }
.anketa-site-preview-header { display:flex; justify-content:space-between; align-items:center; padding:6px 12px; background:var(--bg3); border-bottom:1px solid var(--border); font-size:12px; color:var(--text-muted); }
.anketa-preview-devices { display:flex; gap:4px; }
.preview-device-btn { background:none; border:1px solid var(--border); border-radius:4px; padding:2px 6px; cursor:pointer; font-size:12px; color:var(--text-muted); transition:var(--transition); }
.preview-device-btn.active { border-color:var(--purple); color:var(--purple); background:rgba(128,90,213,0.1); }
.preview-device-btn:hover { border-color:var(--purple); }
.anketa-site-iframe { width:100%; height:450px; border:none; background:#fff; display:block; margin:0 auto; transition:width 0.3s ease; }
.anketa-stage-btn { display:inline-flex; align-items:center; gap:8px; margin-top:10px; padding:8px 16px; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer; transition:var(--transition); border:none; }
.anketa-stage-btn.accept { background:rgba(0,212,170,0.15); color:var(--green); border:1px solid rgba(0,212,170,0.3); }
.anketa-stage-btn.accept:hover { background:rgba(0,212,170,0.25); }
.anketa-stage-btn.decline { background:rgba(255,107,107,0.1); color:var(--text2); border:1px solid var(--border); }
.anketa-stage-btn.decline:hover { background:rgba(255,107,107,0.15); color:var(--red); }
.anketa-input-area { display:flex; gap:8px; padding:12px 16px; border-top:1px solid var(--border); background:rgba(26,34,52,0.5); flex-shrink:0; align-items:flex-end; }
.anketa-input-area input[type="text"] { flex:1; padding:10px 14px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px; transition:var(--transition); }
.anketa-input-area input[type="text"]:focus { outline:none; border-color:var(--purple); box-shadow:0 0 0 3px var(--purple-glow); }
.anketa-attach-btn { width:36px; height:36px; border-radius:8px; border:1px solid var(--border); background:var(--bg3); color:var(--text2); font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:var(--transition); flex-shrink:0; }
.anketa-attach-btn:hover { border-color:var(--purple); color:var(--purple); background:rgba(177,151,252,0.1); }
.anketa-send-btn { width:36px; height:36px; border-radius:8px; border:none; background:linear-gradient(135deg,var(--purple),#7950f2); color:#fff; font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:var(--transition); flex-shrink:0; }
.anketa-send-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px var(--purple-glow); }
.anketa-send-btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; box-shadow:none; }
.anketa-media-preview { display:flex; gap:6px; flex-wrap:wrap; padding:6px 16px 0; }
.anketa-media-preview .preview-item { position:relative; }
.anketa-media-preview .preview-item img { width:50px; height:50px; object-fit:cover; border-radius:6px; border:1px solid var(--border); }
.anketa-media-preview .preview-item .remove-btn { position:absolute; top:-4px; right:-4px; width:16px; height:16px; border-radius:50%; background:var(--red); color:#fff; border:none; font-size:9px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.anketa-summary-panel { padding:12px 16px; border-bottom:1px solid var(--border); background:rgba(177,151,252,0.03); display:none; }
.anketa-summary-panel.open { display:block; }
.anketa-chip { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:12px; font-size:11px; background:var(--bg3); border:1px solid var(--border); color:var(--text); margin:2px 4px 2px 0; cursor:pointer; transition:var(--transition); }
.anketa-chip:hover { border-color:var(--purple); color:var(--purple); }
.anketa-chip .chip-label { color:var(--text2); font-size:10px; }
.anketa-cursor { animation:blink-cursor 0.7s step-end infinite; color:var(--accent); font-weight:bold; }
@keyframes blink-cursor { 50% { opacity:0; } }

/* ============================================================
   TASK DETAIL VIEW
   ============================================================ */
.task-detail {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.task-detail-header {
  padding: 28px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.task-detail-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 12px;
}

.task-meta {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  font-size: 12px;
  color: var(--text2);
}

.task-meta .meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  background: var(--bg);
  border-radius: 20px;
}

.task-detail-body {
  padding: 28px;
}

.task-detail-body .detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 20px;
}

.task-steps {
  margin-top: 20px;
}

.task-steps h4 {
  font-size: 14px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.task-step {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid rgba(36, 48, 68, 0.4);
}

.task-step:last-child { border-bottom: none; }

.task-step .step-check {
  width: 22px; height: 22px;
  border-radius: 50%;
  border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  flex-shrink: 0;
  margin-top: 2px;
}

.task-step .step-check:hover { border-color: var(--accent); }
.task-step .step-check.done { border-color: var(--green); background: var(--green); color: var(--bg); }
.task-step .step-text { font-size: 13px; line-height: 1.5; }
.task-step .step-text.done { text-decoration: line-through; color: var(--text3); }

.tab-sm { padding: 4px 12px; font-size: 11px; }
/* ===== SITE GENERATOR ===== */
.sg-form { display: flex; flex-direction: column; gap: 16px; }
.sg-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media (max-width: 600px) { .sg-row { grid-template-columns: 1fr; } }
.sg-field { display: flex; flex-direction: column; gap: 6px; }
.sg-field label { font-size: 12px; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.sg-field input, .sg-field textarea, .sg-field select {
  background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 10px 14px; color: var(--text); font-family: inherit; font-size: 13px;
  transition: var(--transition);
}
.sg-field input:focus, .sg-field textarea:focus, .sg-field select:focus {
  outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow);
}
.sg-field textarea { resize: vertical; min-height: 60px; }
.sg-field select { cursor: pointer; }
.site-preview-frame {
  border: 2px solid var(--border); border-radius: var(--radius-lg); overflow: hidden;
  margin-top: 12px; box-shadow: var(--shadow-lg); background: #fff;
}
.spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(6px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-overlay.show { display: flex; }

.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 560px;
  max-width: 92vw;
  max-height: 88vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.25s ease;
}
.modal.wide { width: 720px; }
.form-section-title { font-size: 13px; font-weight: 700; color: var(--accent); margin: 18px 0 10px; padding-top: 14px; border-top: 1px solid var(--border); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 22px 28px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.modal-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 17px;
  font-weight: 700;
}

.modal-close {
  width: 34px; height: 34px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 20px;
  display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}

.modal-close:hover { color: var(--red); border-color: var(--red); background: var(--red-glow); }

.modal-body { padding: 28px; }

.form-group { margin-bottom: 18px; }

.form-group label {
  display: block;
  font-size: 11px;
  color: var(--text2);
  margin-bottom: 7px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  font-weight: 600;
}

.form-group .required::after { content: ' *'; color: var(--red); }

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 11px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.form-group textarea { min-height: 90px; resize: vertical; }
.form-group select { cursor: pointer; }
.form-group select option { background: var(--bg2); color: var(--text); }

.modal-footer {
  padding: 18px 28px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  background: rgba(26, 34, 52, 0.3);
}

/* Detail grid for modals */
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.detail-item {
  padding: 12px;
  background: var(--bg);
  border-radius: var(--radius-sm);
}

.detail-label {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 4px;
}

.detail-value { font-size: 13px; color: var(--text); word-break: break-word; }
.detail-full { grid-column: 1 / -1; }

/* ===== CONFIRM DIALOG ===== */
.confirm-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1100;
  justify-content: center;
  align-items: center;
}

.confirm-overlay.show { display: flex; }

.confirm-box {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  width: 400px;
  max-width: 90vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
}

.confirm-box .icon { font-size: 40px; margin-bottom: 16px; }
.confirm-box h4 { font-size: 16px; margin-bottom: 8px; }
.confirm-box p { color: var(--text2); font-size: 13px; margin-bottom: 24px; }
.confirm-actions { display: flex; gap: 10px; justify-content: center; }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 28px; right: 28px;
  padding: 14px 24px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index: 2000;
  max-width: 400px;
  box-shadow: var(--shadow);
}

.toast.show { transform: translateY(0); opacity: 1; }
.toast-success { background: var(--accent); color: var(--bg); }
.toast-error { background: var(--red); color: #fff; }
.toast-warning { background: var(--orange); color: var(--bg); }
.toast-info { background: var(--blue); color: var(--bg); }

/* ===== PAGES ===== */
.page { display: none; }
.page.active { display: block; animation: pageIn 0.3s ease; }

@keyframes pageIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.empty { text-align: center; padding: 50px; color: var(--text2); }
.empty .icon { font-size: 44px; margin-bottom: 14px; opacity: 0.6; }
.empty p { font-size: 14px; }

/* ===== STATUS BAR ===== */
.status-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  padding: 6px 24px;
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: var(--text3);
  z-index: 50;
}

.status-bar .dot {
  display: inline-block;
  width: 7px; height: 7px;
  border-radius: 50%;
  margin-right: 6px;
}

.dot-green { background: var(--accent); }
.dot-red { background: var(--red); }

/* ===== MOBILE ===== */
.mobile-toggle { display: none; }

/* ---- Tablet landscape (769-1024px) ---- */
@media (max-width: 1024px) and (min-width: 769px) {
  .sidebar { width: 60px !important; overflow-x: hidden; }
  .main { margin-left: 60px !important; padding: 24px 16px 60px !important; }
  /* –°–∫—Ä—ã–≤–∞–µ–º collapse-–∫–Ω–æ–ø–∫—É: sidebar —É–∂–µ –≤ –∏–∫–æ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ, –∫–Ω–æ–ø–∫–∞ —Ç–æ—Ä—á–∏—Ç –∑–∞ –µ—ë –∫—Ä–∞–π */
  .sidebar-collapse-btn { display: none !important; }
  .sidebar .logo-section { padding: 16px 10px 14px; text-align: center; }
  .sidebar .logo-section span, .sidebar .nav-item .label,
  .sidebar .user-bar .user-name, .sidebar .user-role-text,
  .sidebar .nav-section, .sidebar .user-bar .user-role-text { display: none !important; }
  .sidebar .logout-btn { font-size: 0; padding: 10px; min-height: 40px; }
  .sidebar .logout-btn::before { content: '\1F6AA'; font-size: 18px; }
  .sidebar .nav-item { justify-content: center; padding: 12px; }
  .sidebar .nav-item .icon { margin: 0; font-size: 20px; }
  .sidebar .nav-item .badge { position: absolute; top: 4px; right: 4px; min-width: 16px; height: 16px; font-size: 9px; }
  .sidebar .nav-item::before { left: -4px !important; }
  .sidebar .user-bar { justify-content: center; padding: 12px 8px; }
  .sidebar .user-bar .user-avatar { margin: 0; }
  /* Admin panel: 2 cols for provider cards */
  #page-admin [style*="grid-template-columns:repeat(auto-fit"] { grid-template-columns: repeat(2, 1fr) !important; }
  #page-admin [style*="grid-template-columns:1fr 1fr 1fr"] { grid-template-columns: 1fr 1fr !important; }
  /* General layout adjustments */
  .page-header h2 { font-size: 22px !important; }
  .metrics { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; }
  .detail-grid, .form-row { grid-template-columns: 1fr 1fr !important; }
  .kanban-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
}
/* ---- Wide tablet fix (1025-1280px) ---- */
@media (max-width: 1280px) and (min-width: 1025px) {
  #page-admin [style*="grid-template-columns:repeat(auto-fit"] { grid-template-columns: repeat(2, 1fr) !important; }
  #page-admin [style*="grid-template-columns:1fr 1fr 1fr"] { grid-template-columns: 1fr 1fr !important; }
}

/* ---- Mobile (consolidated) ---- */
@media (max-width: 768px) {
  /* Base mobile */
  .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1050; }
  .mobile-overlay.show { display: block; }
  .main { margin-left: 0 !important; padding: 12px !important; }
  .page-header h2 { font-size: 20px !important; }
  .metrics { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .table-wrap, .data-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table.data-table { min-width: 600px; }
  .login-card { padding: 32px 20px !important; width: 100% !important; max-width: 100% !important; }
  .kanban-wrap, .pipeline-wrap { flex-direction: column !important; }
  .kanban-col, .pipeline-col { min-width: 100% !important; flex: 1 !important; }
  .detail-grid, .form-row { grid-template-columns: 1fr !important; }
  .sp-two-col { grid-template-columns: 1fr !important; }
  #mobileMenuBtn { display: block !important; }
  /* Touch targets: minimum 44px for all interactive elements */
  .btn, button, .tab, .nav-item, select, input[type="checkbox"], input[type="radio"] {
    min-height: 44px !important; min-width: 44px !important;
  }
  .btn { width: 100% !important; padding: 12px 16px !important; font-size: 14px !important; }
  .btn-sm { min-height: 44px !important; width: auto !important; padding: 8px 14px !important; }
  /* Full-screen modals */
  .modal { width: 100vw !important; max-width: 100vw !important; max-height: 100vh !important;
    border-radius: 0 !important; margin: 0 !important; }
  .modal-overlay { padding: 0 !important; }
  /* Full-screen slide-over */
  .slide-over, .slideover, [class*="slide-over"], #slideover-panel {
    width: 100vw !important; max-width: 100vw !important; border-radius: 0 !important;
  }
  /* Staff/Client cards: single column (auto-fill AND auto-fit) */
  [style*="grid-template-columns:repeat(auto-fill"] { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:repeat(auto-fit"] { grid-template-columns: 1fr !important; }
  /* AI chat full width */
  .ai-global-panel, #ai-global-panel { width: 100vw !important; max-width: 100vw !important;
    right: 0 !important; border-radius: 0 !important; }
  /* Notification panel full width */
  .notif-panel { width: 100vw !important; max-width: 100vw !important; }
  /* Safe area for iOS */
  .main { padding-bottom: calc(20px + env(safe-area-inset-bottom)) !important; }
  .sidebar { padding-bottom: env(safe-area-inset-bottom); }
  /* Sticky mobile header */
  .status-bar { position: sticky !important; top: 0; z-index: 100; padding: 8px 12px !important;
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
  /* Kanban: vertical scroll */
  .kanban-wrap { overflow-x: auto !important; -webkit-overflow-scrolling: touch; padding-bottom: 16px; }
  .kanban-col { min-width: 280px !important; flex: 0 0 280px !important; }
  /* Form inputs larger */
  input, textarea, select { font-size: 16px !important; /* Prevents zoom on iOS */ }
  .form-label, label { font-size: 13px !important; }
  /* Close buttons larger for touch */
  .modal-close, [onclick*="closeModal"], [onclick*="closeWizard"] { min-width: 36px !important; min-height: 36px !important; font-size: 20px !important; }
  /* Wizard responsive */
  #site-wizard-overlay > div { max-width: 100% !important; border-radius: 12px 12px 0 0 !important; max-height: 95vh !important; }
  /* Two-column grids to single column */
  .sp-two-col { grid-template-columns: 1fr !important; }
  /* Slide-over actions wrap */
  .so-actions, #so-actions { display: flex !important; flex-wrap: wrap !important; gap: 8px !important; }
  .so-actions button, #so-actions button { flex: 1 1 calc(50% - 4px) !important; min-width: 140px !important; }
  /* Project cards single column */
  .project-card { margin-bottom: 12px; }
  /* Table wrap with scroll indicator */
  .table-wrap::after { content: '‚Üí'; position: sticky; right: 0; padding: 4px 8px;
    background: var(--bg2); color: var(--text3); font-size: 11px; }
  /* Workflow banner stacked */
  .workflow-banner { flex-direction: column !important; text-align: center; gap: 8px !important; }
  .wf-action { width: 100%; }
  .wf-action button { width: 100% !important; }
  /* Pipeline stages scrollable */
  .so-progress, #so-progress { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  /* Client card panel full screen */
  .client-card-panel { width: 100vw !important; max-width: 100vw !important; border-radius: 0 !important; }
  /* z-index hierarchy for overlays */
  .modal-overlay { z-index: 3000 !important; }
  .modal { z-index: 3001 !important; }
  .notif-panel { z-index: 2000 !important; }
  .ai-global-panel, #ai-global-panel { z-index: 2500 !important; }
  .slide-over, #slideover-panel { z-index: 1500 !important; }
  .sidebar { z-index: 1100 !important; }
  /* Tabs horizontal scroll */
  .tabs, #pv-tabs, #sp-tabs {
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch;
    flex-wrap: nowrap !important;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar, #pv-tabs::-webkit-scrollbar, #sp-tabs::-webkit-scrollbar { display: none; }
  .tabs .tab, #pv-tabs .tab, #sp-tabs .tab {
    white-space: nowrap !important;
    flex-shrink: 0 !important;
  }
  /* Admin tabs mobile */
  .admin-tabs .admin-tab-btn {
    flex: 0 0 auto !important; min-width: auto !important;
  }
  /* Clients filters wrap */
  .clients-filters { flex-wrap: wrap !important; }
  /* Kanban mobile move buttons */
  .k-mobile-move { display: flex !important; gap: 4px; margin-top: 6px; }
  .k-mobile-move button { min-height: 32px !important; min-width: 40px !important; width: auto !important;
    padding: 4px 10px !important; border-radius: 6px; border: 1px solid var(--border);
    background: var(--bg3); color: var(--text2); font-size: 14px; cursor: pointer;
    flex: 1; transition: all .2s; }
  .k-mobile-move button:active { background: var(--accent); color: var(--bg); }
}
/* ---- Small ---- */
@media (max-width: 480px) {
  .metrics { grid-template-columns: 1fr !important; }
  .btn { padding: 10px 14px !important; font-size: 13px !important; }
  .page-header .actions { flex-wrap: wrap; gap: 6px; }
  .login-card { padding: 24px 16px !important; }
  /* Even more compact kanban + scroll-snap */
  .kanban-wrap { scroll-snap-type: x mandatory; }
  .kanban-col { min-width: 260px !important; flex: 0 0 260px !important; scroll-snap-align: start; }
  .kanban-card { padding: 8px 10px !important; }
  /* Stack details vertically */
  .so-detail-item { grid-column: span 2 !important; }
  /* Full width tabs */
  .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; white-space: nowrap; }
  .tab { white-space: nowrap; flex-shrink: 0; }
  /* Stats grids 2-col on small screens */
  #leadsStats, #clientsStats { grid-template-columns: 1fr 1fr !important; }
}

/* ===== NOTIFICATION CSS ===== */
.notif-bell { position: relative; cursor: pointer; font-size: 20px; padding: 8px; border-radius: 8px; transition: all 0.2s; user-select: none; }
.notif-bell:hover { background: var(--bg3); }
.notif-badge { position: absolute; top: 2px; right: 2px; background: var(--red, #ff6b6b); color: #fff; font-size: 10px; font-weight: 700; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; line-height: 1; }
.notif-panel { position: fixed; top: 0; right: -400px; width: 400px; max-width: 100vw; height: 100vh; background: var(--bg2); border-left: 1px solid var(--border); z-index: 2000; transition: right 0.3s ease; overflow-y: auto; box-shadow: -4px 0 30px rgba(0,0,0,0.3); }
.notif-panel.open { right: 0; }
.notif-item { padding: 14px 20px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
.notif-item:hover { background: var(--bg3); }
.notif-item.unread { border-left: 3px solid var(--accent); }
.notif-time { font-size: 11px; color: var(--text3, #666); margin-top: 4px; }
.notif-text { font-size: 13px; line-height: 1.5; }

/* ===== SIDEBAR TOOLTIPS ===== */
@media (min-width: 769px) and (max-width: 1024px) {
  .sidebar .nav-item { position: relative; }
  .sidebar .nav-item[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute; left: 100%; top: 50%; transform: translateY(-50%);
    background: var(--bg4, var(--bg3)); color: var(--text);
    padding: 6px 12px; border-radius: 6px; white-space: nowrap;
    font-size: 12px; margin-left: 8px; z-index: 999;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3); pointer-events: none;
  }
}

@media (max-width: 900px) {
  .sidebar { transform: translateX(-100%); width: 280px !important; position: fixed; top: 0; left: 0; bottom: 0; z-index: 1100; }
  .sidebar.open, .sidebar.mobile-open { transform: translateX(0); box-shadow: var(--shadow-lg); }
  .sidebar.open .logo-section span, .sidebar.open .nav-item .label,
  .sidebar.open .user-bar .user-name, .sidebar.open .user-role-text,
  .sidebar.open .nav-section,
  .sidebar.mobile-open .logo-section span, .sidebar.mobile-open .nav-item .label,
  .sidebar.mobile-open .user-bar span, .sidebar.mobile-open .nav-section { display: revert !important; }
  .main { margin-left: 0 !important; width: 100% !important; max-width: 100% !important; padding: 20px 16px 60px !important; }
  .metrics { grid-template-columns: repeat(2, 1fr); }
  .project-grid { grid-template-columns: 1fr; }
  .subproject-grid { grid-template-columns: 1fr; }
  .detail-grid { grid-template-columns: 1fr; }
  .page-header h2 { font-size: 20px; }
  .task-detail-body .detail-grid { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
  .modal.wide { width: 95vw; }
  #aiGlobalPanel { width: calc(100vw - 32px) !important; right: 16px !important; bottom: 16px !important; height: 70vh !important; }
  #page-admin [style*="grid-template-columns:repeat(auto-fit"] { grid-template-columns: 1fr !important; }
  #page-admin [style*="grid-template-columns:1fr 1fr 1fr"] { grid-template-columns: 1fr !important; }
  #page-admin [style*="grid-template-columns:1fr 1fr"] { grid-template-columns: 1fr !important; }

  .mobile-toggle {
    display: flex !important;
    position: fixed;
    top: 14px; left: 14px;
    z-index: 200;
    width: 44px; height: 44px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    align-items: center; justify-content: center;
    cursor: pointer;
    color: var(--text);
    font-size: 22px;
    box-shadow: var(--shadow);
  }
}

/* ============== PIPELINE (vertical for Sites) ============== */
.kanban-wrap{display:flex;gap:10px;overflow-x:auto;padding:12px 0;min-height:400px;-webkit-overflow-scrolling:touch}
.kanban-col{min-width:220px;max-width:240px;flex:0 0 220px;background:var(--bg3);border-radius:var(--radius);display:flex;flex-direction:column;border:1px solid var(--border)}
.kanban-col-header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:12px;font-weight:700}
.kanban-col-header .k-count{background:var(--bg);padding:2px 8px;border-radius:10px;font-size:11px;font-weight:500}
.kanban-col-header .k-sum{font-size:10px;color:var(--accent);font-weight:600;margin-top:2px}
.kanban-col-body{flex:1;padding:8px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;min-height:60px}
.kanban-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;cursor:pointer;transition:all .2s;position:relative}
.kanban-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.kanban-card.overdue{border-left:3px solid var(--red)}
.kanban-card .k-name{font-size:13px;font-weight:600;margin-bottom:4px;color:var(--text)}
.kanban-card .k-meta{font-size:10px;color:var(--text3);display:flex;flex-wrap:wrap;gap:6px}
.kanban-card .k-price{color:var(--accent);font-weight:600}
.kanban-card .k-type{color:var(--purple)}
.kanban-card .k-city{color:var(--blue)}
.kanban-card .k-paid{color:var(--green);font-weight:600}
.kanban-card .k-unpaid{color:var(--orange)}
.kanban-card .k-manager{color:var(--text2)}
.kanban-card .k-delete-btn{position:absolute;top:4px;right:4px;background:none;border:none;cursor:pointer;font-size:12px;opacity:0;transition:opacity .2s;padding:2px 4px;border-radius:4px}
.kanban-card:hover .k-delete-btn{opacity:.6}
.k-ai-btns{display:flex;gap:4px;margin-top:6px}
.k-ai-btns button{flex:1;padding:3px 6px;font-size:10px;border:1px solid var(--border);background:transparent;color:var(--text3);border-radius:4px;cursor:pointer;font-family:inherit;transition:all .2s}
.k-ai-btns button:hover{background:rgba(0,212,170,.12);border-color:var(--accent);color:var(--accent)}
.kanban-card .k-delete-btn:hover{opacity:1;background:rgba(231,76,60,.15)}
.kanban-card.dragging{opacity:.5;transform:rotate(2deg)}
.kanban-col.drag-over{background:rgba(0,212,170,.08);border-color:var(--accent)}
/* Vertical pipeline */
.pipeline-vertical{display:flex;flex-direction:column;gap:12px}
.pipe-stage{background:var(--bg3);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.pipe-stage-hdr{padding:12px 16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-weight:700;font-size:13px;border-bottom:1px solid var(--border)}
.pipe-stage-hdr .pipe-dot{width:10px;height:10px;border-radius:50%;margin-right:8px;flex-shrink:0}
.pipe-stage-hdr .pipe-info{display:flex;align-items:center;gap:8px}
.pipe-stage-hdr .pipe-stats{font-size:11px;font-weight:400;color:var(--text2);display:flex;gap:10px}
.pipe-stage-body{padding:8px;display:flex;flex-direction:column;gap:6px}
.pipe-client{display:flex;align-items:center;gap:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;cursor:pointer;transition:all .2s}
.pipe-client:hover{border-color:var(--accent);box-shadow:0 2px 8px rgba(0,0,0,.2)}
.pipe-client .pc-name{font-weight:600;font-size:13px;flex:1}
.pipe-client .pc-price{font-weight:600;color:var(--accent);font-size:13px}
.pipe-client .pc-meta{font-size:10px;color:var(--text3);display:flex;gap:8px;margin-top:2px}
.pipe-client .pc-del{opacity:0;color:var(--red);cursor:pointer;font-size:16px;padding:4px 6px;border-radius:6px;transition:all .15s}
.pipe-client:hover .pc-del{opacity:1}
.pipe-client .pc-del:hover{background:var(--red-glow)}

/* ============== SLIDE-OVER ============== */
.slideover-overlay{position:fixed;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.5);z-index:700;display:none;opacity:0;transition:opacity .3s}
.slideover-overlay.open{display:block;opacity:1}
.slideover{position:fixed;top:0;right:-520px;bottom:0;width:500px;max-width:90vw;background:var(--bg2);z-index:710;transition:right .3s ease;display:flex;flex-direction:column;box-shadow:-10px 0 40px rgba(0,0,0,.5)}
.slideover.open{right:0}
.so-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start}
.so-close{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
.so-body{flex:1;overflow-y:auto;padding:20px 24px}
.so-progress{display:flex;align-items:center;margin:16px 0;padding:2px 0;overflow-x:auto}
.so-progress .so-step{width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);background:var(--bg3);cursor:pointer;transition:all .15s;flex-shrink:0}
.so-progress .so-step:hover{border-color:var(--accent)}
.so-progress .so-step.active{border-color:var(--accent);background:var(--accent);box-shadow:0 0 8px var(--accent-glow)}
.so-progress .so-step.done{border-color:var(--green);background:var(--green)}
.so-progress .so-line{flex:1;height:2px;background:var(--border);transition:background .2s;min-width:6px}
.so-progress .so-line.done{background:var(--green)}
.so-stage-labels{display:flex;justify-content:space-between;margin-bottom:16px}
.so-stage-labels span{font-size:9px;color:var(--text3);text-align:center;flex:1}
.so-section{margin-bottom:20px}
.so-section h4{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px}
.so-detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.so-detail-item{padding:10px 12px;background:var(--bg3);border-radius:8px}
.so-detail-item .so-label{font-size:10px;color:var(--text3);margin-bottom:2px}
.so-detail-item .so-value{font-size:14px;font-weight:600;color:var(--text)}
.so-actions{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
.so-actions button{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:12px;cursor:pointer;transition:all .2s;font-family:inherit}
.so-actions button:hover{border-color:var(--accent);background:rgba(0,212,170,.08)}
.so-checklist{list-style:none;padding:0}
.so-checklist li{padding:8px 0;border-bottom:1px solid var(--bg3);display:flex;align-items:center;gap:8px;font-size:13px}
.so-checklist li.done{color:var(--text3);text-decoration:line-through}
.so-checklist li .check{width:18px;height:18px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;flex-shrink:0}
.so-checklist li.done .check{background:var(--green);border-color:var(--green);color:#fff}
.so-next-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),#00b894);border:none;border-radius:8px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;margin-top:12px;font-family:inherit}

/* ============== GUIDED WORKFLOW ============== */
.workflow-banner{background:linear-gradient(135deg,rgba(255,169,77,.1),rgba(253,126,20,.05));border:1px solid rgba(255,169,77,.3);border-radius:var(--radius);padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;gap:14px}
.workflow-banner .wf-step{font-size:24px}
.workflow-banner .wf-info h4{font-size:14px;font-weight:600;color:var(--orange);margin-bottom:2px}
.workflow-banner .wf-info p{font-size:12px;color:var(--text2)}
.workflow-banner .wf-action{margin-left:auto}
.workflow-banner .wf-action button{padding:8px 16px;background:var(--orange);border:none;border-radius:6px;color:#fff;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}

/* ============== REVENUE CHART ============== */
.chart-container{background:var(--bg3);border-radius:var(--radius);padding:20px;margin:16px 0;border:1px solid var(--border)}
.chart-bars{display:flex;align-items:flex-end;gap:6px;height:140px;padding:0 4px}
.chart-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.chart-bar{width:100%;border-radius:4px 4px 0 0;background:linear-gradient(180deg,var(--accent),#00b894);min-height:2px;transition:height .5s}
.chart-bar-label{font-size:9px;color:var(--text3)}
.chart-bar-value{font-size:9px;color:var(--accent);font-weight:600}

/* ============== KANBAN VIEW TOGGLE ============== */
.view-toggle{display:flex;gap:4px;background:var(--bg3);border-radius:8px;padding:3px;border:1px solid var(--border)}
.view-toggle button{padding:6px 14px;border-radius:6px;border:none;background:transparent;color:var(--text2);font-size:12px;cursor:pointer;font-family:inherit;transition:all .2s}
.view-toggle button.active{background:var(--accent);color:#fff;font-weight:600}

/* ============== CLIENT QUESTIONNAIRE SCREEN ============== */
.client-screen { display:none; min-height:100vh; background:var(--bg); color:var(--text); font-family:var(--font); }
.client-header { background:linear-gradient(135deg, var(--purple), #6c5ce7); padding:20px 24px; text-align:center; }
.client-header h1 { margin:0; font-size:20px; color:#fff; font-weight:700; }
.client-header p { margin:4px 0 0; font-size:13px; color:rgba(255,255,255,0.8); }
.client-chat-wrap { max-width:700px; margin:0 auto; padding:16px; display:flex; flex-direction:column; height:calc(100vh - 80px); }
.client-chat-messages { flex:1; overflow-y:auto; padding:12px 0; display:flex; flex-direction:column; gap:10px; }
.client-msg { max-width:85%; padding:10px 14px; border-radius:14px; font-size:14px; line-height:1.5; word-break:break-word; }
.client-msg.assistant { align-self:flex-start; background:var(--bg2); border:1px solid var(--border); border-bottom-left-radius:4px; }
.client-msg.user { align-self:flex-end; background:linear-gradient(135deg,rgba(128,90,213,0.15),rgba(108,92,231,0.15)); border:1px solid rgba(128,90,213,0.2); border-bottom-right-radius:4px; }
.client-msg.system { align-self:center; background:rgba(0,212,170,0.1); border:1px solid rgba(0,212,170,0.2); font-size:12px; color:var(--green); text-align:center; border-radius:10px; }
.client-input-wrap { display:flex; gap:8px; padding:12px 0; align-items:flex-end; }
.client-input-wrap textarea { flex:1; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--bg2); color:var(--text); font-size:14px; font-family:inherit; resize:none; min-height:42px; max-height:120px; outline:none; transition:border-color 0.2s; }
.client-input-wrap textarea:focus { border-color:var(--purple); }
.client-send-btn { width:42px; height:42px; border-radius:50%; border:none; background:linear-gradient(135deg,var(--purple),#6c5ce7); color:#fff; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all 0.2s; }
.client-send-btn:hover { transform:scale(1.05); }
.client-send-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
.client-upload-btn { width:42px; height:42px; border-radius:50%; border:1px solid var(--border); background:var(--bg2); color:var(--text2); font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all 0.2s; }
.client-upload-btn:hover { border-color:var(--purple); color:var(--purple); }
.client-typing { padding:8px 14px; font-size:12px; color:var(--text-muted); font-style:italic; }
.client-media-preview { display:flex; gap:6px; flex-wrap:wrap; padding:4px 0; }
.client-media-preview img { width:60px; height:60px; object-fit:cover; border-radius:8px; border:1px solid var(--border); }
.client-completeness { background:var(--bg2); border-radius:10px; padding:8px 14px; margin-bottom:8px; border:1px solid var(--border); }
.client-completeness-bar { height:6px; background:var(--bg3); border-radius:3px; overflow:hidden; margin-top:6px; }
.client-completeness-fill { height:100%; background:linear-gradient(90deg,var(--purple),var(--green)); border-radius:3px; transition:width 0.5s ease; }



@media (max-width: 1024px) {
  #page-admin [style*="grid-template-columns:repeat(4"] { grid-template-columns: repeat(2, 1fr) !important; }
  #page-admin [style*="grid-template-columns: repeat(4"] { grid-template-columns: repeat(2, 1fr) !important; }
  #page-admin [style*="grid-template-columns:1fr 1fr 1fr"] { grid-template-columns: 1fr 1fr !important; }
  #adm-status-banner { flex-wrap: wrap; gap: 8px !important; }
}

@media (max-width: 768px) {
  #page-admin [style*="grid-template-columns:repeat(4"] { grid-template-columns: 1fr 1fr !important; }
  #page-admin [style*="grid-template-columns: repeat(4"] { grid-template-columns: 1fr 1fr !important; }
  #page-admin [style*="grid-template-columns:repeat(auto-fit"] { grid-template-columns: 1fr !important; }
  #page-admin [style*="grid-template-columns:1fr 1fr"] { grid-template-columns: 1fr !important; }
  #page-admin [style*="grid-template-columns:1fr 1fr 1fr"] { grid-template-columns: 1fr !important; }
  #adm-status-banner { flex-wrap: wrap; font-size: 12px !important; gap: 8px !important; padding: 12px 14px !important; }
  #adm-status-banner > div:last-child { width: auto; }
  #adm-panel-keys .card { padding: 16px !important; }
  #adm-knowledge { rows: 8; font-size: 11px !important; }
  #adm-cascade { gap: 6px !important; }
  #adm-cascade > div { padding: 8px 12px !important; font-size: 12px; }
  /* Admin tabs scrollable + touch targets */
  #page-admin [style*="display:flex;gap:4px"] { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  #page-admin [style*="display:flex;gap:4px"] button { min-height: 40px !important; padding: 8px 14px !important; white-space: nowrap; }
}

@media (max-width: 480px) {
  #page-admin [style*="grid-template-columns:repeat(2"] { grid-template-columns: 1fr !important; }
  #page-admin [style*="grid-template-columns: repeat(2"] { grid-template-columns: 1fr !important; }
  #page-admin [style*="grid-template-columns:1fr 1fr"] { grid-template-columns: 1fr !important; }
  #page-admin [style*="display:flex;gap:4px"] { flex-direction: column; }
  #adm-status-banner { flex-direction: column; align-items: flex-start !important; }
}

</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" onerror="document.getElementById('loginError').textContent='‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.';document.getElementById('loginError').style.display='block'"></script>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card" style="width:440px;max-width:95vw;box-sizing:border-box;padding:48px 40px">
    <span class="login-icon">üè•</span>
    <div class="login-logo">RKT HUB</div>
    <div class="login-sub">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏</div>

    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 16px;margin-bottom:20px;text-align:left;font-size:13px;color:var(--text2);line-height:1.6">
      üí° <strong style="color:var(--text)">–ö–∞–∫ –≤–æ–π—Ç–∏:</strong> –≤–≤–µ–¥–∏—Ç–µ –∏–º—è, @telegram –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω, –∑–∞—Ç–µ–º –ø–∞—Ä–æ–ª—å.<br>
      –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –í–∫–ª–∞–¥–∫–∞ ¬´–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è¬ª –∏–ª–∏ –±–æ—Ç <a href="https://t.me/AIhroject_bot" style="color:var(--accent)">@AIhroject_bot</a>.
    </div>

    <!-- AUTH TABS -->
    <div style="display:flex;gap:0;margin-bottom:20px;background:var(--bg3);border-radius:10px;padding:3px;border:1px solid var(--border)">
      <button id="authTabLogin" class="auth-tab active" onclick="showAuthTab('login')">üîë –í—Ö–æ–¥</button>
      <button id="authTabReg" class="auth-tab" onclick="showAuthTab('register')">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button id="authTabIntake" class="auth-tab" onclick="showAuthTab('intake')">üì© –ó–∞—è–≤–∫–∞</button>
    </div>

    <!-- ===== LOGIN FORM ===== -->
    <div id="authLogin">
      <div style="display:grid;gap:10px">
        <input class="login-input" id="loginId" type="text" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω, @telegram –∏–ª–∏ email" autocomplete="username" autofocus>
        <div style="position:relative">
          <input class="login-input" id="loginPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" onkeydown="if(event.key==='Enter')doPasswordLogin()" style="padding-right:44px">
          <button onclick="togglePassVis('loginPass',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--text3)" title="–ü–æ–∫–∞–∑–∞—Ç—å">üëÅ</button>
        </div>
      </div>
      <button class="login-btn" onclick="doPasswordLogin()" style="margin-top:14px">
        <span id="loginBtnText">–í–æ–π—Ç–∏</span>
      </button>
      <div class="login-error" id="loginError"></div>

      <div style="display:flex;align-items:center;gap:12px;margin:18px 0 14px">
        <div style="flex:1;height:1px;background:var(--border)"></div>
        <span style="font-size:11px;color:var(--text3)">–∏–ª–∏</span>
        <div style="flex:1;height:1px;background:var(--border)"></div>
      </div>

      <button class="tg-login-btn" onclick="doTelegramLogin()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.94 8.13l-1.97 9.28c-.15.67-.54.83-1.09.52l-3.02-2.23-1.45 1.4c-.16.16-.3.3-.61.3l.22-3.05 5.55-5.02c.24-.22-.05-.33-.37-.13l-6.87 4.33-2.96-.92c-.64-.2-.66-.64.13-.95l11.57-4.46c.54-.2 1.01.13.83.93z"/></svg>
        –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram
      </button>

      <div style="text-align:center;margin-top:14px">
        <a href="#" onclick="showForgotPass();return false" style="color:var(--text3);font-size:12px">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
      </div>
    </div>

    <!-- ===== REGISTER FORM ===== -->
    <div id="authRegister" style="display:none">
      <div style="display:grid;gap:10px">
        <input class="login-input" id="regName" type="text" placeholder="üë§ –§–ò–û *">
        <input class="login-input" id="regPhone" type="tel" placeholder="üì± –¢–µ–ª–µ—Ñ–æ–Ω * (+7 900 123-45-67)">
        <input class="login-input" id="regUsername" type="text" placeholder="üí¨ Telegram @—Ç–µ–≥">
        <select class="login-input" id="regProject" style="padding:12px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px">
          <option value="">üìÇ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç *</option>
          <option value="–°–∞–π—Ç—ã">üåê –°–∞–π—Ç—ã</option>
          <option value="–†–ö–¢">üè• –†–ö–¢</option>
        </select>
        <div style="position:relative">
          <input class="login-input" id="regPass" type="password" placeholder="üîí –ü–∞—Ä–æ–ª—å * (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)" autocomplete="new-password" style="padding-right:44px">
          <button onclick="togglePassVis('regPass',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--text3)">üëÅ</button>
        </div>
        <div style="position:relative">
          <input class="login-input" id="regPass2" type="password" placeholder="üîí –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å *" autocomplete="new-password" onkeydown="if(event.key==='Enter')doPasswordRegister()" style="padding-right:44px">
          <button onclick="togglePassVis('regPass2',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--text3)">üëÅ</button>
        </div>
      </div>
      <label style="display:flex;align-items:flex-start;gap:8px;font-size:12px;color:var(--text2);cursor:pointer;margin-top:10px">
        <input type="checkbox" id="regConsent" style="margin-top:2px;accent-color:var(--accent);flex-shrink:0">
        <span>–Ø —Å–æ–≥–ª–∞—à–∞—é—Å—å —Å <a href="#" onclick="showLegalPage('privacy');return false" style="color:var(--accent)">–ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a> –∏ <a href="#" onclick="showLegalPage('terms');return false" style="color:var(--accent)">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º</a> –∏ –¥–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</span>
      </label>
      <button class="login-btn" style="margin-top:14px" onclick="doPasswordRegister()">
        <span id="regBtnText">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
      </button>
      <div class="login-error" id="regError"></div>

      <div style="display:flex;align-items:center;gap:12px;margin:18px 0 14px">
        <div style="flex:1;height:1px;background:var(--border)"></div>
        <span style="font-size:11px;color:var(--text3)">–∏–ª–∏</span>
        <div style="flex:1;height:1px;background:var(--border)"></div>
      </div>

      <button class="tg-login-btn" onclick="doTelegramLogin()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.94 8.13l-1.97 9.28c-.15.67-.54.83-1.09.52l-3.02-2.23-1.45 1.4c-.16.16-.3.3-.61.3l.22-3.05 5.55-5.02c.24-.22-.05-.33-.37-.13l-6.87 4.33-2.96-.92c-.64-.2-.66-.64.13-.95l11.57-4.46c.54-.2 1.01.13.83.93z"/></svg>
        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
      </button>
    </div>

    <!-- ===== FORGOT PASSWORD ===== -->
    <div id="authForgot" style="display:none">
      <div style="text-align:center;margin-bottom:16px">
        <div style="font-size:36px;margin-bottom:8px">üîë</div>
        <div style="font-size:14px;color:var(--text2)">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, @—Ç–µ–≥ –∏–ª–∏ Telegram ID.<br>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –ø—Ä–∏–¥—ë—Ç –≤ Telegram.</div>
      </div>
      <input class="login-input" id="forgotId" type="text" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω, @telegram –∏–ª–∏ Telegram ID">
      <button class="login-btn" style="margin-top:12px" onclick="doForgotPass()">
        <span id="forgotBtnText">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
      </button>
      <div class="login-error" id="forgotError"></div>
      <div style="text-align:center;margin-top:12px">
        <a href="#" onclick="showAuthTab('login');return false" style="color:var(--accent);font-size:13px">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É</a>
      </div>
    </div>

    <!-- ===== PUBLIC INTAKE FORM ===== -->
    <div id="authIntake" style="display:none">
      <div style="text-align:center;margin-bottom:16px">
        <div style="font-size:36px;margin-bottom:8px">üì©</div>
        <div style="font-size:14px;color:var(--text2);line-height:1.5">–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–∞.<br>–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è!</div>
      </div>
      <div id="intakeFormFields" style="display:grid;gap:10px">
        <input class="login-input" id="intakeName" type="text" placeholder="üë§ –í–∞—à–µ –∏–º—è *">
        <input class="login-input" id="intakeContact" type="text" placeholder="üì± –¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ @telegram *">
        <select class="login-input" id="intakeType" style="padding:12px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px">
          <option value="">üåê –¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞ *</option>
        </select>
        <textarea class="login-input" id="intakeDesc" rows="3" placeholder="üìù –û–ø–∏—à–∏—Ç–µ —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ (—Ç–µ–º–∞—Ç–∏–∫–∞, –ø–æ–∂–µ–ª–∞–Ω–∏—è, –ø—Ä–∏–º–µ—Ä—ã...)" style="resize:vertical;min-height:60px;font-family:inherit"></textarea>
        <input class="login-input" id="intakeBudget" type="text" placeholder="üí∞ –ë—é–¥–∂–µ—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
      </div>
      <label style="display:flex;align-items:flex-start;gap:8px;font-size:12px;color:var(--text2);cursor:pointer;margin-top:10px">
        <input type="checkbox" id="intakeConsent" style="margin-top:2px;accent-color:var(--accent);flex-shrink:0">
        <span>–Ø —Å–æ–≥–ª–∞—à–∞—é—Å—å —Å <a href="#" onclick="showLegalPage('privacy');return false" style="color:var(--accent)">–ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a> –∏ –¥–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</span>
      </label>
      <button class="login-btn" id="intakeBtn" style="margin-top:14px" onclick="submitPublicIntake()">
        <span id="intakeBtnText">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</span>
      </button>
      <div class="login-error" id="intakeError"></div>
      <div id="intakeSuccess" style="display:none;text-align:center;padding:20px">
        <div style="font-size:48px;margin-bottom:12px">‚úÖ</div>
        <div style="font-size:16px;font-weight:600;color:var(--text);margin-bottom:8px">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.5">–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.<br>–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!</div>
        <div style="margin-top:16px">
          <a href="#" onclick="resetIntakeForm();return false" style="color:var(--accent);font-size:13px;margin-right:16px">üì© –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</a>
          <a href="#" onclick="showAuthTab('login');return false" style="color:var(--text3);font-size:13px">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É</a>
        </div>
      </div>
    </div>
    <div style="text-align:center;margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
      <a href="#" onclick="showLegalPage('privacy');return false" style="color:var(--text3);font-size:11px;margin-right:16px">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
      <a href="#" onclick="showLegalPage('terms');return false" style="color:var(--text3);font-size:11px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</a>
      <div style="font-size:10px;color:var(--text3);margin-top:8px">¬© 2024‚Äì2026 –†–ö–¢ ‚Äî –†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ¬∑ –ö–∞–∑–∞–Ω—å, –û–≠–ó ¬´–ò–Ω–Ω–æ–ø–æ–ª–∏—Å¬ª</div>
    </div>
  </div>
</div>

<button class="mobile-toggle" id="mobileToggle" onclick="toggleSidebar()">‚ò∞</button>

<!-- MAIN APP -->
<div class="app" id="mainApp" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-section">
      <h1>RKT HUB</h1>
      <div class="subtitle">v6.0 ‚Ä¢ –ü—Ä–æ–µ–∫—Ç—ã + –ò–ò</div>
      <button class="sidebar-collapse-btn" onclick="toggleSidebarCollapse()" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">&#8249;</button>
    </div>

    <nav class="nav" id="sidebarNav">
      <div class="nav-section">–ì–ª–∞–≤–Ω–æ–µ</div>
      <a class="nav-item active" onclick="showPage('home')" data-page="home">
        <span class="icon">üè†</span><span class="label">–ì–ª–∞–≤–Ω–∞—è</span>
      </a>
      <a class="nav-item" onclick="showPage('dashboard')" data-page="dashboard">
        <span class="icon">üìä</span><span class="label">–î–∞—à–±–æ—Ä–¥ –ì–î</span>
      </a>
      <a class="nav-item" onclick="toggleAiPanel()" data-page="ai" style="border:1px solid rgba(177,151,252,0.2)">
        <span class="icon">ü§ñ</span><span class="label">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
        <span class="badge" style="background:var(--purple)">AI</span>
      </a>

      <div class="nav-section">–ü—Ä–æ–µ–∫—Ç—ã</div>
      <!-- Dynamic project items rendered by renderSidebarProjects() -->
      <div id="sidebarProjectsList"></div>

      <div class="nav-section">–†–∞–±–æ—Ç–∞</div>
      <a class="nav-item" onclick="showPage('kanban')" data-page="kanban">
        <span class="icon">üîÑ</span><span class="label">–°–¥–µ–ª–∫–∏</span>
        <span class="badge" id="badge-deals">0</span>
      </a>
      <a class="nav-item" onclick="showPage('tasks')" data-page="tasks">
        <span class="icon">‚úÖ</span><span class="label">–ó–∞–¥–∞—á–∏</span>
        <span class="badge" id="badge-tasks">0</span>
      </a>
      <a class="nav-item" onclick="showPage('clients')" data-page="clients">
        <span class="icon">üë•</span><span class="label">–ö–ª–∏–µ–Ω—Ç—ã</span>
        <span class="badge" id="badge-clients">0</span>
      </a>
      <a class="nav-item" onclick="showPage('leads')" data-page="leads" id="nav-leads">
        <span class="icon">üìù</span><span class="label">–ó–∞—è–≤–∫–∏</span>
        <span class="badge" id="badge-leads">0</span>
      </a>
      <a class="nav-item" onclick="showPage('partners')" data-page="partners">
        <span class="icon">ü§ù</span><span class="label">–ü–∞—Ä—Ç–Ω—ë—Ä—ã</span>
        <span class="badge" id="badge-partners">0</span>
      </a>
      <a class="nav-item" onclick="showPage('comms')" data-page="comms">
        <span class="icon">üí¨</span><span class="label">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</span>
      </a>

      <div class="nav-section">–°–∏—Å—Ç–µ–º–∞</div>
      <a class="nav-item" onclick="showPage('staff')" data-page="staff" id="nav-staff">
        <span class="icon">üë§</span><span class="label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
      </a>
      <a class="nav-item" onclick="showPage('approvals')" data-page="approvals" id="nav-approvals">
        <span class="icon">üìã</span><span class="label">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</span>
        <span class="badge badge-orange" id="badge-approvals">0</span>
      </a>
      <a class="nav-item" onclick="showPage('settings')" data-page="settings">
        <span class="icon">‚öôÔ∏è</span><span class="label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </a>
      <a class="nav-item" onclick="showPage('admin')" data-page="admin" id="nav-admin">
        <span class="icon">üõ°Ô∏è</span><span class="label">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span>
      </a>
    </nav>

    <div class="user-bar" id="userBar">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="userName">‚Äî</div>
          <div class="user-role-text" id="userRoleText">‚Äî</div>
        </div>
      </div>
      <button class="logout-btn" onclick="doLogout()">üö™ –í—ã–π—Ç–∏</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">

    <!-- ======== HOME: TOP-LEVEL PROJECTS ======== -->
    <div class="page active" id="page-home">
      <div class="page-header">
        <h2>üè† –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h2>
        <div class="actions">
          <button class="btn" onclick="toggleAiPanel()" style="background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff">ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</button>
          <button class="btn btn-secondary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="metrics" id="home-metrics"></div>
      <div class="project-grid" id="project-grid"></div>
    </div>

    <!-- ======== PROJECT VIEW (subprojects) ======== -->
    <div class="page" id="page-project">
      <div class="breadcrumb">
        <a onclick="showPage('home')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a>
        <span class="sep">‚Ä∫</span>
        <span class="current" id="pv-name">‚Äî</span>
      </div>
      <div class="page-header">
        <h2 id="pv-title">üìÅ –ü—Ä–æ–µ–∫—Ç</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-sub" onclick="openAddSubproject()">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button>
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-secondary" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
        </div>
      </div>
      <div class="metrics" id="pv-metrics"></div>
      <div class="subproject-grid" id="subproject-grid"></div>

      <!-- Project-level tabs -->
      <div class="tabs" id="pv-tabs">
        <div class="tab active" data-tab="overview" onclick="showPvTab('overview')">üìä –û–±–∑–æ—Ä</div>
        <div class="tab" data-tab="pipeline" onclick="showPvTab('pipeline')" style="display:none">üéØ –í–æ—Ä–æ–Ω–∫–∞</div>
        <div class="tab" data-tab="clients" onclick="showPvTab('clients')" style="display:none">üë• –ö–ª–∏–µ–Ω—Ç—ã</div>
        <div class="tab" data-tab="tasks" onclick="showPvTab('tasks')">‚úÖ –ó–∞–¥–∞—á–∏</div>
        <div class="tab" data-tab="partners" onclick="showPvTab('partners')">ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã</div>
        <div class="tab" data-tab="staff" onclick="showPvTab('staff')">üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div>
        <div class="tab" data-tab="timeline" onclick="showPvTab('timeline')">üìÖ –ü–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫</div>
        <div class="tab" data-tab="comms" onclick="showPvTab('comms')">üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</div>
        <div class="tab" data-tab="docs" onclick="showPvTab('docs')">üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã</div>
        <div class="tab tab-finance" data-tab="finance" onclick="showPvTab('finance')" style="display:none">üí∞ –§–∏–Ω–∞–Ω—Å—ã</div>
        <div class="tab tab-salaries" data-tab="salaries" onclick="showPvTab('salaries')" style="display:none">üë• –ó–∞—Ä–ø–ª–∞—Ç—ã</div>
      </div>
      <div id="pv-content"></div>
    </div>

    <!-- ======== SUBPROJECT VIEW (workspace) ======== -->
    <div class="page" id="page-subproject">
      <div class="breadcrumb">
        <a onclick="showPage('home')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a>
        <span class="sep">‚Ä∫</span>
        <a onclick="openProject(currentProject)" id="sp-parent">‚Äî</a>
        <span class="sep">‚Ä∫</span>
        <span class="current" id="sp-name">‚Äî</span>
      </div>
      <div class="page-header">
        <h2 id="sp-title">üìÅ –ü–æ–¥–ø—Ä–æ–µ–∫—Ç</h2>
        <div class="actions" id="sp-actions">
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-primary" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
          <button class="btn btn-secondary" onclick="openModal('comm')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
        </div>
      </div>
      <!-- Client quick-info bar (for –°–∞–π—Ç—ã only) -->
      <div id="sp-client-bar" style="display:none"></div>
      <div class="metrics" id="sp-metrics"></div>

      <div class="tabs" id="sp-tabs">
        <div class="tab active" data-tab="overview" onclick="showSpTab('overview')">üìä –û–±–∑–æ—Ä</div>
        <div class="tab" data-tab="tasks" onclick="showSpTab('tasks')">‚úÖ –ó–∞–¥–∞—á–∏</div>
        <div class="tab" data-tab="client-info" onclick="showSpTab('client-info')" style="display:none">üìã –ê–Ω–∫–µ—Ç–∞</div>
        <div class="tab" data-tab="partners" onclick="showSpTab('partners')">ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã</div>
        <div class="tab" data-tab="projects" onclick="showSpTab('projects')">üìÅ –ü—Ä–æ–µ–∫—Ç—ã</div>
        <div class="tab" data-tab="comms" onclick="showSpTab('comms')">üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</div>
        <div class="tab" data-tab="files" onclick="showSpTab('files')">üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã</div>
        <div class="tab tab-sitegen" data-tab="sitegen" onclick="showSpTab('sitegen')" style="display:none">üåê –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∞–π—Ç–æ–≤</div>
      </div>
      <div id="sp-content"></div>
    </div>

    <!-- ======== TASK DETAIL with AI ======== -->
    <div class="page" id="page-taskdetail">
      <div class="breadcrumb" id="td-breadcrumb"></div>
      <div id="td-content"></div>
    </div>

    <!-- ======== DASHBOARD ======== -->
    <div class="page" id="page-dashboard">
      <div class="page-header">
        <h2>üìä –î–∞—à–±–æ—Ä–¥ –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞</h2>
        <div class="actions">
          <button class="btn btn-secondary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="metrics" id="dash-metrics"></div>
      <div id="dash-revenue-chart"></div>
      <div id="dash-pipeline-summary" style="margin-bottom:16px"></div>
      <div id="dash-earnings" style="margin-bottom:16px"></div>
      <div class="card" style="border:1px solid rgba(177,151,252,0.2);background:linear-gradient(135deg,rgba(177,151,252,0.03),rgba(121,80,242,0.01))">
        <div class="card-header" style="display:flex;align-items:center;justify-content:space-between">
          <h3>ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
          <button class="btn btn-sm" onclick="toggleAiPanel()" style="background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff;border:none;font-size:11px">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç ‚Üí</button>
        </div>
        <div style="padding:0 20px 16px;display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–°–æ—Å—Ç–∞–≤—å –æ—Ç—á—ë—Ç –ø–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üìä –û—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã?'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ü–æ–¥–≥–æ—Ç–æ–≤—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üìã –ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∏—Å–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">‚ö†Ô∏è –†–∏—Å–∫–∏</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th></th></tr></thead><tbody id="dash-overdue"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üìÅ –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody id="dash-projects"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th></tr></thead><tbody id="dash-comms"></tbody></table></div>
      </div>
    </div>

    <!-- ======== PARTNERS ======== -->
    <div class="page" id="page-partners">
      <div class="page-header">
        <h2>ü§ù –í—Å–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-partner" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
          <button class="btn btn-secondary" onclick="exportCSV('partners')">üì• CSV</button>
        </div>
      </div>
      <div class="filters-bar">
        <div id="partner-filters"></div>
        <input class="search-input" id="partner-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderPartners()">
      </div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th></th></tr></thead>
        <tbody id="partners-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== TASKS ======== -->
    <div class="page" id="page-tasks">
      <div class="page-header">
        <h2>‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-secondary" onclick="exportCSV('tasks')">üì• CSV</button>
        </div>
      </div>
      <div class="filters-bar" style="display:flex;flex-direction:column;gap:8px">
        <div id="task-filters"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <select id="task-filter-status" onchange="renderTasks()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;color:var(--text);font-family:inherit;font-size:12px">
            <option value="active">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ</option>
            <option value="–í—Å–µ">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="‚è≥ –í –æ—á–µ—Ä–µ–¥–∏">‚è≥ –í –æ—á–µ—Ä–µ–¥–∏</option>
            <option value="üîÑ –í —Ä–∞–±–æ—Ç–µ">üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
            <option value="‚úÖ –ì–æ—Ç–æ–≤–æ">‚úÖ –ì–æ—Ç–æ–≤–æ</option>
          </select>
          <select id="task-filter-person" onchange="renderTasks()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;color:var(--text);font-family:inherit;font-size:12px">
            <option value="–í—Å–µ">üë§ –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
          </select>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer">
            <input type="checkbox" id="task-show-gantt" onchange="renderTasks()"> üìÖ –ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫
          </label>
          <input class="search-input" id="task-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderTasks()">
        </div>
      </div>
      <div id="task-gantt" style="margin-bottom:12px"></div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th style="width:40px">‚Ññ</th><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead>
        <tbody id="tasks-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== STAFF ======== -->
    <div class="page" id="page-staff">
      <div class="page-header">
        <h2>üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-staff" onclick="openModal('staff')">+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
        </div>
      </div>
      <!-- Step 1: Choose project -->
      <div class="staff-projects" id="staff-projects">
        <div class="tabs" id="staff-project-tabs"></div>
      </div>
      <!-- Step 2: Choose direction (after project selected) -->
      <div class="staff-directions" id="staff-direction-tabs" style="margin-top:8px"></div>
      <!-- Stats & Search -->
      <div style="display:flex;align-items:center;gap:12px;margin:12px 0;flex-wrap:wrap">
        <div id="staff-stats" style="flex:1"></div>
        <input type="text" id="staff-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderStaff()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 14px;color:var(--text);font-family:inherit;font-size:13px;width:200px">
      </div>
      <!-- Pending registrations (CEO only) -->
      <div id="staff-pending" style="margin-bottom:16px"></div>
      <div id="staff-content"></div>
    </div>

    <!-- ======== APPROVALS ======== -->
    <div class="page" id="page-approvals">
      <div class="page-header"><h2>üìã –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</h2></div>
      <div id="approvals-content"></div>
    </div>

    <!-- ======== COMMS ======== -->
    <div class="page" id="page-comms">
      <div class="page-header">
        <h2>üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('comm')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
        </div>
      </div>
      <div class="filters-bar">
        <input class="search-input" id="comm-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderComms()">
      </div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th><th></th></tr></thead>
        <tbody id="comms-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== SETTINGS ======== -->
    <div class="page" id="page-settings">
      <div class="page-header"><h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></div>
      <div class="card" style="padding:28px">
        <h3 style="margin-bottom:20px;font-size:15px">üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <div class="form-group"><label>üîó Supabase URL</label><input type="text" id="settingsApiUrl" readonly onchange="updateConfig('API_URL',this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>AI URL</label><input type="text" id="settingsAiUrl" onchange="updateConfig('AI_URL',this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>ü§ñ Telegram Bot (@username)</label><input type="text" id="settingsTgBot" onchange="updateConfig('TG_BOT',this.value)" placeholder="RktHubBot" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>üîë Telegram Bot Token</label><input type="password" id="settingsTgToken" onchange="updateConfig('TG_BOT_TOKEN',this.value)" placeholder="123456:ABC-..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <h3 style="margin:20px 0 12px;font-size:15px">ü§ñ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π AI –¥–ª—è —á–∞—Ç–∞</h3>
        <p style="font-size:11px;color:var(--text3);margin:-4px 0 12px">Groq –∏ Gemini ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ AI –¥–ª—è —á–∞—Ç–∞. Claude (—á–µ—Ä–µ–∑ n8n) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–æ–≤/—Ñ–∞–π–ª–æ–≤ –∏ –∫–∞–∫ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø–∞—Å–Ω–æ–π.</p>
        <div class="form-group"><label>‚ö° Groq API Key <a href="https://console.groq.com" target="_blank" style="font-size:10px;color:var(--accent)">(–ø–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ)</a></label><input type="password" id="settingsGroqKey" onchange="updateConfig('GROQ_KEY',this.value)" placeholder="gsk_..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"><p style="font-size:10px;color:var(--text3);margin:4px 0 0">–û—Å–Ω–æ–≤–Ω–æ–π –¥–ª—è —á–∞—Ç–∞. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 1000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å, 30/–º–∏–Ω</p></div>
        <div class="form-group"><label>‚ú® Gemini API Key <a href="https://aistudio.google.com/apikey" target="_blank" style="font-size:10px;color:var(--accent)">(–ø–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ)</a></label><input type="password" id="settingsGeminiKey" onchange="updateConfig('GEMINI_KEY',this.value)" placeholder="AIza..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"><p style="font-size:10px;color:var(--text3);margin:4px 0 0">–ó–∞–ø–∞—Å–Ω–æ–π –¥–ª—è —á–∞—Ç–∞. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 250 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å, 10/–º–∏–Ω</p></div>
        <div class="form-group"><label>üì¶ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</label><input type="text" id="settingsWriteUrl" value="Supabase PostgreSQL" readonly onchange="updateConfig('WRITE_URL',this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>üìã –°—Ç–∞—Ç—É—Å</label><input type="text" id="settingsSheetId" value="‚úÖ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω–∞" readonly onchange="updateConfig('SHEET_ID',this.value)" placeholder="1Te4CsdcN1rvpznHNyPa24MuH5ZSx45DUUDREWO5mtoE" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--accent);width:100%;font-family:monospace;font-size:12px;font-weight:600"></div>
        <p style="font-size:11px;color:var(--text3);margin-top:-8px">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∏–∑ URL —Ç–∞–±–ª–∏—Ü—ã: docs.google.com/spreadsheets/d/<b style="color:var(--accent)">–í–û–¢_–≠–¢–û–¢_ID</b>/edit</p>
        <h3 style="margin:20px 0 12px;font-size:15px">üåê –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–∞–π—Ç–æ–≤ (GitHub Pages)</h3>
        <p style="font-size:11px;color:var(--text3);margin:-4px 0 12px">–î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–∞–π—Ç–æ–≤ –Ω—É–∂–µ–Ω GitHub Token. –°–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑.</p>
        <div class="form-group"><label>üîë GitHub Token <a href="https://github.com/settings/tokens?type=beta" target="_blank" style="font-size:10px;color:var(--accent)">(—Å–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω)</a></label><input type="password" id="settingsGithubToken" placeholder="github_pat_xxxx..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"><p style="font-size:10px;color:var(--text3);margin:4px 0 0">Fine-grained token ‚Üí Repo: <b>rkt-sites</b> ‚Üí Contents: Read and Write</p></div>
        <div class="form-group"><label>üìÇ GitHub –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</label><input type="text" id="settingsGithubRepo" placeholder="daniyal251/rkt-sites" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"><p style="font-size:10px;color:var(--text3);margin:4px 0 0">–§–æ—Ä–º–∞—Ç: username/repo-name</p></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn btn-secondary" onclick="testConnection()">üîå –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>
        </div>
        <div id="settings-status" style="margin-top:8px;font-size:12px"></div>
      </div>
      <div class="card" style="padding:28px;margin-top:16px">
        <h3 style="margin-bottom:20px;font-size:15px">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
        <div class="detail-grid">
          <div class="detail-item"><div class="detail-label">–ò–º—è</div><div class="detail-value" id="s-name">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–†–æ–ª—å</div><div class="detail-value" id="s-role">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div><div class="detail-value" id="s-dir">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">Telegram ID</div><div class="detail-value" id="s-tgid">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div><div class="detail-value" id="s-phone">‚Äî</div></div>
        </div>
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);display:flex;gap:8px">
          <button class="btn btn-secondary" onclick="changeMyPassword()" style="font-size:13px">üîí –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
          <button class="btn btn-danger" onclick="doLogout()" style="font-size:13px">üö™ –í—ã–π—Ç–∏</button>
        </div>
      </div>
      <div class="card" style="padding:28px;margin-top:16px">
        <h3 style="margin-bottom:16px;font-size:15px">üîê –ó–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</h3>
        <div id="s-perms" style="font-size:13px;line-height:2"></div>
        </div>
      </div>
      <!-- Statistics section removed per CEO request -->
    </div>

    <!-- ======== CLIENTS PAGE ======== -->
    <div class="page" id="page-clients">
      <div class="page-header">
        <h2>üë• –ö–ª–∏–µ–Ω—Ç—ã</h2>
        <div class="actions">
          <button class="btn-primary" onclick="openModal('direction')">+ –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
        </div>
      </div>
      <!-- Filters -->
      <div class="clients-filters" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px">
        <select id="clientsFilterProject" onchange="renderClientsPage()" style="padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px">
          <option value="">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
          <option value="–°–∞–π—Ç—ã">üåê –°–∞–π—Ç—ã</option>
          <option value="AI-–∫–æ–Ω—Ç–µ–Ω—Ç">üé¨ AI-–∫–æ–Ω—Ç–µ–Ω—Ç</option>
          <option value="–ò–ò-–∞–≥–µ–Ω—Ç—ã">ü§ñ –ò–ò-–∞–≥–µ–Ω—Ç—ã</option>
          <option value="–†–ö–¢">üè• –†–ö–¢</option>
        </select>
        <select id="clientsFilterStage" onchange="renderClientsPage()" style="padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px">
          <option value="">–í—Å–µ —Å—Ç–∞–¥–∏–∏</option>
          <option value="prospect">–ü–æ–∏—Å–∫</option>
          <option value="contact">–ö–æ–Ω—Ç–∞–∫—Ç</option>
          <option value="proposal">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</option>
          <option value="negotiation">–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã</option>
          <option value="contract">–î–æ–≥–æ–≤–æ—Ä</option>
          <option value="prepayment">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
          <option value="production">–†–∞–±–æ—Ç–∞</option>
          <option value="completed">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
          <option value="rejected">–û—Ç–∫–∞–∑</option>
        </select>
        <select id="clientsFilterManager" onchange="renderClientsPage()" style="padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px">
          <option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option>
        </select>
        <input id="clientsSearch" oninput="renderClientsPage()" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, Telegram..." style="flex:1;min-width:200px;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px">
      </div>
      <div id="clientsStats" style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap"></div>
      <div id="clientsTable" style="overflow-x:auto"></div>
    </div>

    <!-- ======== LEADS PAGE ======== -->
    <div class="page" id="page-leads">
      <div class="page-header">
        <h2>üìù –ó–∞—è–≤–∫–∏</h2>
        <div class="actions">
          <button class="btn btn-secondary" onclick="renderLeadsPage()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div id="leadsStats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:16px"></div>
      <div id="leadsTable" style="overflow-x:auto"></div>
    </div>

    <!-- ======== ADMIN PANEL ======== -->
    <div class="page" id="page-admin">
      <div class="page-header">
        <h2>üõ°Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
        <div class="actions">
          <button class="btn btn-secondary" onclick="adminRefresh()" style="font-size:13px">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ STATUS BANNER ‚îÄ‚îÄ‚îÄ -->
      <div id="adm-status-banner" style="padding:14px 20px;border-radius:var(--radius-lg);margin-bottom:20px;display:flex;align-items:center;gap:12px;font-size:13px;background:linear-gradient(135deg,rgba(0,229,160,.08),rgba(0,184,148,.04));border:1px solid rgba(0,229,160,.15);flex-wrap:wrap;overflow:visible">
        <div style="width:10px;height:10px;border-radius:50%;background:var(--accent);flex-shrink:0;animation:pulse 2s infinite"></div>
        <div style="flex:1;min-width:0;word-break:break-word"><span style="font-weight:600;color:var(--text)">–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞</span> <span style="color:var(--text3)">¬∑ –ò–ò-—á–∞—Ç —á–∏—Ç–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —ç—Ç–æ–π –ø–∞–Ω–µ–ª–∏</span></div>
        <div id="adm-key-indicator" style="padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap;flex-shrink:0">...</div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ‚îÄ -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;text-align:center;position:relative;overflow:hidden">
          <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),#00b894)"></div>
          <div style="font-size:32px;font-weight:800;color:var(--accent);letter-spacing:-1px" id="adm-chats-today">0</div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px;text-transform:uppercase;letter-spacing:1px">üí¨ –ß–∞—Ç–æ–≤</div>
        </div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;text-align:center;position:relative;overflow:hidden">
          <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--orange),#e67e22)"></div>
          <div style="font-size:32px;font-weight:800;color:var(--text);letter-spacing:-1px" id="adm-errors-today">0</div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px;text-transform:uppercase;letter-spacing:1px">‚ö†Ô∏è –û—à–∏–±–æ–∫</div>
        </div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;text-align:center;position:relative;overflow:hidden">
          <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#9b59b6,#8e44ad)"></div>
          <div style="font-size:32px;font-weight:800;color:#b197fc;letter-spacing:-1px" id="adm-leads-today">0</div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px;text-transform:uppercase;letter-spacing:1px">üìù –ó–∞—è–≤–æ–∫</div>
        </div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;text-align:center;position:relative;overflow:hidden">
          <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#f1c40f,#f39c12)"></div>
          <div style="font-size:32px;font-weight:800;color:#f1c40f;letter-spacing:-1px" id="adm-tokens-today">0</div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px;text-transform:uppercase;letter-spacing:1px">ü™ô –¢–æ–∫–µ–Ω–æ–≤</div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ -->
      <div class="admin-tabs">
        <button class="admin-tab-btn active" onclick="admTab('keys')" id="adm-tab-keys">üîë –ö–ª—é—á–∏</button>
        <button class="admin-tab-btn" onclick="admTab('logs')" id="adm-tab-logs">üìã –õ–æ–≥–∏</button>
        <button class="admin-tab-btn" onclick="admTab('leads')" id="adm-tab-leads">üìù –ó–∞—è–≤–∫–∏</button>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ TAB: KEYS ‚îÄ‚îÄ‚îÄ -->
      <div id="adm-panel-keys">
        <!-- ‚îÄ‚îÄ 4 –ü–†–û–í–ê–ô–î–ï–†–ê ‚îÄ‚îÄ -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">
          <div class="card" style="padding:20px;border:1px solid var(--border);position:relative;overflow:hidden">
            <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#f55036,#ff6b4a)"></div>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <div style="font-size:20px">‚ö°</div>
              <div><div style="font-size:13px;font-weight:700">Groq</div><div style="font-size:10px;color:var(--accent)">–ë–ï–°–ü–õ–ê–¢–ù–û ¬∑ 1000 –∑–∞–ø—Ä/–¥–µ–Ω—å</div></div>
              <div id="adm-st-groq" style="margin-left:auto;width:8px;height:8px;border-radius:50%;background:var(--text3)"></div>
            </div>
            <input type="password" id="adm-groq-key" placeholder="gsk_..." oninput="debouncedAdmKeySave()" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 10px;color:var(--text);font-family:monospace;font-size:11px;box-sizing:border-box;margin-bottom:8px">
            <div style="display:flex;gap:6px"><button class="btn btn-secondary" onclick="admTestProvider('groq')" style="flex:1;font-size:11px;padding:6px">üß™ –¢–µ—Å—Ç</button><a href="https://console.groq.com" target="_blank" class="btn btn-secondary" style="flex:1;font-size:11px;padding:6px;text-align:center;text-decoration:none">üîó –ü–æ–ª—É—á–∏—Ç—å</a></div>
          </div>

          <div class="card" style="padding:20px;border:1px solid var(--border);position:relative;overflow:hidden">
            <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#4285f4,#34a853)"></div>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <div style="font-size:20px">‚ú®</div>
              <div><div style="font-size:13px;font-weight:700">Gemini</div><div style="font-size:10px;color:var(--accent)">–ë–ï–°–ü–õ–ê–¢–ù–û ¬∑ 1500 –∑–∞–ø—Ä/–¥–µ–Ω—å</div></div>
              <div id="adm-st-gemini" style="margin-left:auto;width:8px;height:8px;border-radius:50%;background:var(--text3)"></div>
            </div>
            <input type="password" id="adm-gemini-key" placeholder="AIza..." oninput="debouncedAdmKeySave()" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 10px;color:var(--text);font-family:monospace;font-size:11px;box-sizing:border-box;margin-bottom:8px">
            <div style="display:flex;gap:6px"><button class="btn btn-secondary" onclick="admTestProvider('gemini')" style="flex:1;font-size:11px;padding:6px">üß™ –¢–µ—Å—Ç</button><a href="https://aistudio.google.com/apikey" target="_blank" class="btn btn-secondary" style="flex:1;font-size:11px;padding:6px;text-align:center;text-decoration:none">üîó –ü–æ–ª—É—á–∏—Ç—å</a></div>
          </div>

          <div class="card" style="padding:20px;border:1px solid var(--border);position:relative;overflow:hidden">
            <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#b197fc,#8b5cf6)"></div>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <div style="font-size:20px">üß†</div>
              <div><div style="font-size:13px;font-weight:700">Claude</div><div style="font-size:10px;color:var(--orange)">–ü–õ–ê–¢–ù–û ¬∑ –õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ</div></div>
              <div id="adm-st-claude" style="margin-left:auto;width:8px;height:8px;border-radius:50%;background:var(--text3)"></div>
            </div>
            <input type="password" id="adm-claude-key" placeholder="sk-ant-api03-..." oninput="debouncedAdmKeySave()" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 10px;color:var(--text);font-family:monospace;font-size:11px;box-sizing:border-box;margin-bottom:8px">
            <div style="display:flex;gap:6px"><button class="btn btn-secondary" onclick="admTestProvider('claude')" style="flex:1;font-size:11px;padding:6px">üß™ –¢–µ—Å—Ç</button><a href="https://console.anthropic.com/settings/keys" target="_blank" class="btn btn-secondary" style="flex:1;font-size:11px;padding:6px;text-align:center;text-decoration:none">üîó –ü–æ–ª—É—á–∏—Ç—å</a></div>
          </div>

          <div class="card" style="padding:20px;border:1px solid var(--border);position:relative;overflow:hidden">
            <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#00b4d8,#0077b6)"></div>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <div style="font-size:20px">üêã</div>
              <div><div style="font-size:13px;font-weight:700">DeepSeek</div><div style="font-size:10px;color:var(--accent)">–î–Å–®–ï–í–û ¬∑ –û—Ç–ª–∏—á–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º</div></div>
              <div id="adm-st-deepseek" style="margin-left:auto;width:8px;height:8px;border-radius:50%;background:var(--text3)"></div>
            </div>
            <input type="password" id="adm-deepseek-key" placeholder="sk-..." oninput="debouncedAdmKeySave()" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 10px;color:var(--text);font-family:monospace;font-size:11px;box-sizing:border-box;margin-bottom:8px">
            <div style="display:flex;gap:6px"><button class="btn btn-secondary" onclick="admTestProvider('deepseek')" style="flex:1;font-size:11px;padding:6px">üß™ –¢–µ—Å—Ç</button><a href="https://platform.deepseek.com" target="_blank" class="btn btn-secondary" style="flex:1;font-size:11px;padding:6px;text-align:center;text-decoration:none">üîó –ü–æ–ª—É—á–∏—Ç—å</a></div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ –ö–ê–°–ö–ê–î ‚îÄ‚îÄ -->
        <div class="card" style="padding:20px;border:1px solid var(--border);margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <div style="font-size:20px">üîÑ</div>
            <div style="flex:1"><div style="font-size:14px;font-weight:700">–ö–∞—Å–∫–∞–¥ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)</div><div style="font-size:11px;color:var(--text3)">–ü–µ—Ä–≤–∞—è –º–æ–¥–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç. –ï—Å–ª–∏ —É–ø–∞–ª–∞ ‚Äî —Å–ª–µ–¥—É—é—â–∞—è. –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞.</div></div>
          </div>
          <div id="adm-cascade" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>

        <!-- ‚îÄ‚îÄ –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô ‚îÄ‚îÄ -->
        <div class="card" style="padding:20px;border:1px solid var(--border);margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <div style="font-size:20px">üìö</div>
            <div style="flex:1"><div style="font-size:14px;font-weight:700">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ò–ò</div><div style="font-size:11px;color:var(--text3)">–û–¥–∏–Ω –ø—Ä–æ–º–ø—Ç –¥–ª—è –í–°–ï–• –º–æ–¥–µ–ª–µ–π. –°–∞–π—Ç + Telegram –±–æ—Ç —á–∏—Ç–∞—é—Ç –æ—Ç—Å—é–¥–∞.</div></div>
          </div>
          <textarea id="adm-knowledge" rows="12" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;color:var(--text);font-size:12px;line-height:1.5;resize:vertical;font-family:inherit;box-sizing:border-box"></textarea>
        </div>

        <!-- ‚îÄ‚îÄ –ù–ê–°–¢–†–û–ô–ö–ò ‚îÄ‚îÄ -->
        <div class="card" style="padding:20px;border:1px solid var(--border);margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
            <div style="font-size:20px">‚öôÔ∏è</div>
            <div style="font-size:14px;font-weight:700">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">
            <div>
              <label style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px">‚è± –¢–∞–π–º–∞—É—Ç (–º—Å)</label>
              <input type="number" id="adm-timeout" value="15000" min="5000" max="60000" step="5000" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;color:var(--text);font-size:12px;box-sizing:border-box">
            </div>
            <div>
              <label style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px">üí¨ –ò–ò-—á–∞—Ç –Ω–∞ —Å–∞–π—Ç–µ</label>
              <select id="adm-chat-enabled" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;color:var(--text);font-size:12px">
                <option value="true">‚úÖ –í–∫–ª—é—á—ë–Ω</option>
                <option value="false">‚ùå –í—ã–∫–ª—é—á–µ–Ω</option>
              </select>
            </div>
            <div>
              <label style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px">üì¢ Telegram Chat ID</label>
              <input type="text" id="adm-tg-chat" value="798494835" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;color:var(--text);font-family:monospace;font-size:12px;box-sizing:border-box">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
            <div>
              <label style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px">üîó n8n Webhook</label>
              <input type="text" id="adm-webhook" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;color:var(--text);font-family:monospace;font-size:12px;box-sizing:border-box">
            </div>
            <div>
              <label style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px">ü§ñ Telegram Bot Token</label>
              <input type="password" id="adm-tg-token" placeholder="123456:ABC-..." style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;color:var(--text);font-family:monospace;font-size:12px;box-sizing:border-box">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
            <div>
              <label style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px">üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</label>
              <input type="text" id="adm-greeting" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;color:var(--text);font-size:12px;box-sizing:border-box">
            </div>
            <div></div>
          </div>

          <div style="display:flex;gap:10px;align-items:center">
            <button class="btn btn-primary" onclick="adminSaveSettings()" style="padding:12px 28px;font-size:13px;font-weight:600">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
            <div id="adm-save-status" style="font-size:12px"></div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ TAB: LOGS ‚îÄ‚îÄ‚îÄ -->
      <div id="adm-panel-logs" style="display:none">
        <div class="card" style="padding:20px;border:1px solid var(--border)">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div style="font-size:14px;font-weight:700;color:var(--text)">üìã –õ–æ–≥ –ò–ò-—á–∞—Ç–∞</div>
            <select id="adm-log-filter" onchange="adminLoadLogs()" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);font-size:12px">
              <option value="all">–í—Å–µ –∑–∞–ø–∏—Å–∏</option>
              <option value="error">‚ö†Ô∏è –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏</option>
              <option value="chat">üí¨ –¢–æ–ª—å–∫–æ —á–∞—Ç—ã</option>
              <option value="lead">üìù –¢–æ–ª—å–∫–æ –∑–∞—è–≤–∫–∏</option>
            </select>
          </div>
          <div id="adm-logs" style="max-height:500px;overflow-y:auto;border-radius:var(--radius-sm)">
            <div style="color:var(--text3);font-size:13px;text-align:center;padding:40px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ TAB: LEADS ‚îÄ‚îÄ‚îÄ -->
      <div id="adm-panel-leads" style="display:none">
        <div class="card" style="padding:20px;border:1px solid var(--border)">
          <div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:16px">üìù –ó–∞—è–≤–∫–∏ —Å —Å–∞–π—Ç–∞ –∏ –ò–ò-—á–∞—Ç–∞</div>
          <div id="adm-leads" style="max-height:500px;overflow-y:auto;border-radius:var(--radius-sm)">
            <div style="color:var(--text3);font-size:13px;text-align:center;padding:40px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ======== KANBAN PIPELINE VIEW ======== -->
    <div class="page" id="page-kanban">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <div>
          <h2 style="font-size:22px;font-weight:700">üîÑ –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</h2>
          <p style="font-size:13px;color:var(--text3);margin-top:4px">Drag-and-drop –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫</p>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="kanban-filter-manager" onchange="renderKanban()" style="padding:6px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:12px"><option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option></select>
          <button class="btn btn-primary btn-sm" onclick="openAddSubproject()">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button>
        </div>
      </div>
      <div id="kanban-container" class="kanban-wrap"></div>
    </div>

  </main>
</div>

<!-- ======== SLIDE-OVER DEAL CARD ======== -->
<div class="slideover-overlay" id="slideoverOverlay" onclick="if(event.target===this)closeSlideOver()"></div>
<div class="slideover" id="slideoverPanel">
  <div class="so-header">
    <div>
      <h3 id="so-name" style="font-size:20px;font-weight:700">–ö–ª–∏–µ–Ω—Ç</h3>
      <p id="so-type" style="font-size:12px;color:var(--text3);margin-top:2px"></p>
    </div>
    <button class="so-close" onclick="closeSlideOver()">‚úï</button>
  </div>
  <div class="so-body">
    <div id="so-workflow-banner"></div>
    <div class="so-progress" id="so-progress"></div>
    <div class="so-stage-labels" id="so-stage-labels"></div>
    <div class="so-section">
      <h4>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
      <div class="so-detail-grid" id="so-details"></div>
    </div>
    <div class="so-section">
      <h4>‚ö° –î–µ–π—Å—Ç–≤–∏—è</h4>
      <div class="so-actions" id="so-actions"></div>
    </div>
    <div id="so-rkt-crm"></div>
    <div id="so-touch-log"></div>
    <div class="so-section">
      <h4>üìã –ó–∞–¥–∞—á–∏</h4>
      <ul class="so-checklist" id="so-tasks"></ul>
    </div>
    <button class="so-next-btn" id="so-next-btn" onclick="advanceDealStage()">‚û°Ô∏è –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø</button>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalBox">
    <div class="modal-header">
      <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer" id="modalFooter">
      <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="modalSaveBtn" onclick="saveModal()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="modal" style="width:620px">
    <div class="modal-header">
      <h3 id="detailTitle">–î–µ—Ç–∞–ª–∏</h3>
      <button class="modal-close" onclick="closeDetail()">‚úï</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDetail()">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn btn-primary" id="detailEditBtn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="icon">‚ö†Ô∏è</div>
    <h4 id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h4>
    <p id="confirmText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
    <div class="confirm-actions">
      <button class="btn btn-secondary" onclick="closeConfirm(false)">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-danger" onclick="closeConfirm(true)">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<button id="aiFab" onclick="toggleAiPanel()" style="position:fixed;bottom:40px;right:28px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#b197fc,#7950f2);border:none;color:#fff;font-size:28px;cursor:pointer;z-index:500;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(177,151,252,0.4);transition:all .3s">ü§ñ</button>

<div id="aiGlobalPanel" style="position:fixed;bottom:40px;right:28px;width:440px;max-width:calc(100vw - 56px);height:600px;max-height:calc(100vh - 80px);background:var(--bg2);border:1px solid var(--purple);border-radius:16px;z-index:600;display:none;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.6),0 0 40px rgba(177,151,252,0.1)">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:linear-gradient(135deg,rgba(177,151,252,0.12),rgba(121,80,242,0.06));border-bottom:1px solid rgba(177,151,252,0.2);border-radius:16px 16px 0 0">
    <h4 style="font-size:15px;font-weight:700;color:var(--purple);display:flex;align-items:center;gap:10px">ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RKT HUB</h4>
    <button onclick="toggleAiPanel()" style="width:30px;height:30px;border-radius:50%;border:1px solid rgba(177,151,252,0.3);background:transparent;color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center">‚úï</button>
  </div>
  <div style="padding:10px 16px;border-bottom:1px solid rgba(177,151,252,0.1);display:flex;gap:6px;flex-wrap:wrap">
    <button onclick="globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã?')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</button>
    <button onclick="globalAiQuick('–°–æ—Å—Ç–∞–≤—å –æ—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìä –û—Ç—á—ë—Ç</button>
    <button onclick="globalAiQuick('–ù–∞–ø–∏—à–∏ –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìß –ü–∏—Å—å–º–æ</button>
    <button onclick="globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Å–∞–º—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ?')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</button>
    <button onclick="globalAiQuick('–ü–æ–¥–≥–æ—Ç–æ–≤—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìã –ü–ª–∞–Ω</button>
  </div>
  <div id="ai-global-messages" style="flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px">
    <div class="ai-msg system">–ü—Ä–∏–≤–µ—Ç! –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RKT HUB. –ü–æ–º–æ–≥—É —Å –∑–∞–¥–∞—á–∞–º–∏, –ö–ü, –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º.</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;padding:0 16px 8px">
      <button onclick="aiQuick('–ü–æ–¥–≥–æ—Ç–æ–≤—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–ö–ü) –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞')" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit">üìÑ –°–æ–∑–¥–∞—Ç—å –ö–ü</button>
      <button onclick="aiQuick('–ü–æ–∫–∞–∂–∏ –æ—Ç—á—ë—Ç –ø–æ –∑–∞–¥–∞—á–∞–º –∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–º')" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit">üìä –û—Ç—á—ë—Ç</button>
      <button onclick="aiQuick('–ß—Ç–æ –¥–µ–ª–∞—Ç—å –Ω–æ–≤–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É? –û–±—ä—è—Å–Ω–∏ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞')" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit">üÜò –ü–æ–º–æ—â—å</button>
      <button onclick="aiQuick('–°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω —Ä–∞–±–æ—Ç—ã –Ω–∞ –Ω–µ–¥–µ–ª—é')" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit">üìã –ü–ª–∞–Ω</button>
    </div>
  </div>
  <div style="display:flex;gap:8px;padding:14px 16px;border-top:1px solid rgba(177,151,252,0.15);background:rgba(26,34,52,0.5);border-radius:0 0 16px 16px">
    <div style="display:flex;flex-direction:column;gap:4px;padding:8px 12px">
    <div id="ai-file-badge" style="display:none;font-size:11px;color:var(--accent);padding:2px 8px;background:var(--accent-glow);border-radius:6px;cursor:pointer" onclick="window._aiAttachedFile=null;this.style.display='none';toast('üìé –§–∞–π–ª –æ—Ç–≤—è–∑–∞–Ω','info')">üìé</div>
    <div style="display:flex;gap:8px">
    <button onclick="attachFileToAI()" style="padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;font-size:16px" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</button>
    <input id="ai-global-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ..." onkeydown="if(event.key==='Enter')sendGlobalAi()" style="flex:1;padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px">
    <button id="ai-global-send" onclick="sendGlobalAi()" style="padding:10px 18px;background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff;border:none;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;cursor:pointer">‚û§</button>
    </div></div>
  </div>
</div>

<!-- CLIENT QUESTIONNAIRE SCREEN (public, no auth required) -->
<div class="client-screen" id="clientScreen">
  <div class="client-header">
    <h1 id="clientTitle">–ê–Ω–∫–µ—Ç–∞</h1>
    <p id="clientSubtitle">–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –º—ã —Å–¥–µ–ª–∞–ª–∏ –¥–ª—è –≤–∞—Å –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
  </div>
  <div class="client-chat-wrap">
    <div class="client-completeness" id="clientCompleteness">
      <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2)">
        <span>–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∫–µ—Ç—ã</span>
        <span id="clientPct">0%</span>
      </div>
      <div class="client-completeness-bar"><div class="client-completeness-fill" id="clientBar" style="width:0%"></div></div>
    </div>
    <div class="client-chat-messages" id="clientMessages"></div>
    <div class="client-media-preview" id="clientMediaPreview" style="display:none"></div>
    <div class="client-input-wrap">
      <button class="client-upload-btn" onclick="clientAttachFile()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ">üìé</button>
      <textarea id="clientInput" rows="1" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendClientMsg()}"></textarea>
      <button class="client-send-btn" id="clientSendBtn" onclick="sendClientMsg()">‚û§</button>
      <input type="file" id="clientFileInput" multiple accept="image/*" style="display:none" onchange="clientFilesSelected(this)">
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="status-bar" id="statusBar">
  <button id="mobileMenuBtn" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" onclick="toggleMobileMenu()" style="display:none;background:none;border:none;color:var(--text);font-size:24px;cursor:pointer;padding:4px 8px;margin-right:8px">‚ò∞</button>
  <div><span class="dot dot-green" id="statusDot"></span> <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span></div>
  <div style="margin-left:auto;display:flex;align-items:center;gap:12px">
    <div class="notif-bell" role="button" tabindex="0" aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" onclick="toggleNotifPanel()">üîî<span class="notif-badge" id="notifBadge" style="display:none">0</span></div>
    <div id="statusTime"></div>
  </div>
</div>

<script>
// ============================================================
// CONFIG & STATE
// ============================================================
const CONFIG = {
  SUPABASE_URL: 'https://prparzgqevfelwsndmkc.supabase.co',
  SUPABASE_KEY: 'sb_publishable_gFeXATQGYxKx08BpeOedZg_7buTwVJq',
  AI_URL: 'https://daniyal2212.app.n8n.cloud/webhook/rkt-ai',
  TG_BOT: 'AIhroject_bot',    // @username –±–æ—Ç–∞ –±–µ–∑ @
  TG_BOT_TOKEN: '',           // –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–∑–∞–ø–æ–ª–Ω–∏—Ç—å!)
  GROQ_KEY: '',               // Groq API Key (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, console.groq.com)
  GEMINI_KEY: '',             // Gemini API Key (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, aistudio.google.com)
  GITHUB_REPO: 'daniyal251/rkt-sites', // GitHub Pages repo for client sites
  REFRESH: 120000,
  VERSION: '15.1.0'
};

// Debounce utility ‚Äî prevents multiple rapid calls
function debounce(fn, delay) {
  let timer = null;
  let running = false;
  return function(...args) {
    if (timer) clearTimeout(timer);
    timer = setTimeout(async () => {
      if (running) return;
      running = true;
      try { await fn.apply(this, args); } finally { running = false; }
    }, delay);
  };
}
const debouncedLoadData = debounce(() => loadData(), 500);

// filterByRole cache ‚Äî invalidated on each loadData
let _filterCache = new Map();
let _filterCacheVersion = 0;

// Supabase client
let SB = null;
try {
  if (window.supabase) {
    SB = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
  } else {
    console.error('Supabase library not loaded! Check CDN or internet connection.');
    document.title = 'RKT HUB ‚Äî –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
  }
} catch(e) {
  console.error('Supabase init error:', e);
  document.title = 'RKT HUB ‚Äî –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
}

// ============================================================
// COLUMN MAPPING: Supabase (English) ‚Üî Frontend (Russian)
// ============================================================
const COL_MAP = {
  staff: {
    id:'ID', name:'–ò–º—è', role:'–†–æ–ª—å', project:'–ü—Ä–æ–µ–∫—Ç', direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
    telegram_id:'Telegram_ID', username:'Username', phone:'–¢–µ–ª–µ—Ñ–æ–Ω', email:'Email', hire_date:'–î–∞—Ç–∞_–Ω–∞–π–º–∞',
    status:'–°—Ç–∞—Ç—É—Å', created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è', updated_at:'–û–±–Ω–æ–≤–ª–µ–Ω–æ', pin_hash:'pin_hash',
    salary_pct:'–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü', extra_projects:'–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã', permissions:'–ü—Ä–∞–≤–∞'
  },
  partners: {
    id:'ID', name:'–ù–∞–∑–≤–∞–Ω–∏–µ', country:'–°—Ç—Ä–∞–Ω–∞', direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', product:'–ü—Ä–æ–¥—É–∫—Ç',
    status:'–°—Ç–∞—Ç—É—Å', contact:'–ö–æ–Ω—Ç–∞–∫—Ç', website:'–°–∞–π—Ç', notes:'–ü—Ä–∏–º–µ—á–∞–Ω–∏—è',
    created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è'
  },
  directions: {
    id:'ID', name:'–ù–∞–∑–≤–∞–Ω–∏–µ', project:'–ü—Ä–æ–µ–∫—Ç', status:'–°—Ç–∞—Ç—É—Å', stage:'stage',
    manager:'–ú–µ–Ω–µ–¥–∂–µ—Ä', description:'–û–ø–∏—Å–∞–Ω–∏–µ', link:'–°—Å—ã–ª–∫–∞', phone:'–¢–µ–ª–µ—Ñ–æ–Ω', city:'–ì–æ—Ä–æ–¥',
    site_type:'–¢–∏–ø —Å–∞–π—Ç–∞', price:'–¶–µ–Ω–∞', paid:'–û–ø–ª–∞—á–µ–Ω–æ', business_type:'–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞',
    style:'–°—Ç–∏–ª—å', questionnaire:'–ê–Ω–∫–µ—Ç–∞', client_name:'–ö–ª–∏–µ–Ω—Ç', created_at:'–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è',
    services:'–£—Å–ª—É–≥–∏', comment:'–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', address:'–ê–¥—Ä–µ—Å', social:'–°–æ—Ü—Å–µ—Ç–∏',
    work_hours:'–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã', prices:'–¶–µ–Ω—ã',
    source:'–ò—Å—Ç–æ—á–Ω–∏–∫', next_contact:'–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç', touches:'–ö–∞—Å–∞–Ω–∏—è',
    reject_reason:'–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞', feedback:'–§–∏–¥–±–µ–∫', created:'–°–æ–∑–¥–∞–Ω',
    site_html:'site_html', site_url:'site_url',
    logo_url:'logo_url', photos:'photos',
    telegram_tag:'Telegram',
    equipment_type:'–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è',
    oem_partner:'OEM-–ø–∞—Ä—Ç–Ω—ë—Ä',
    rzn_status:'–°—Ç–∞—Ç—É—Å –†–ó–ù',
    rzn_checklist:'–ß–µ–∫–ª–∏—Å—Ç –†–ó–ù',
    logistics_status:'–°—Ç–∞—Ç—É—Å –ª–æ–≥–∏—Å—Ç–∏–∫–∏',
    contract_amount:'–°—É–º–º–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞',
    procurement_type:'–¢–∏–ø –∑–∞–∫—É–ø–∫–∏',
    procurement_deadline:'–î–µ–¥–ª–∞–π–Ω –∑–∞–∫—É–ø–∫–∏',
    procurement_number:'–ù–æ–º–µ—Ä –∑–∞–∫—É–ø–∫–∏',
    touch_log:'–ò—Å—Ç–æ—Ä–∏—è –∫–∞—Å–∞–Ω–∏–π'
  },
  tasks: {
    id:'ID', description:'–û–ø–∏—Å–∞–Ω–∏–µ', direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', project:'–ü—Ä–æ–µ–∫—Ç',
    priority:'–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', status:'–°—Ç–∞—Ç—É—Å', deadline:'–î–µ–¥–ª–∞–π–Ω', assignee:'–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π',
    notes:'–ü—Ä–∏–º–µ—á–∞–Ω–∏—è', link:'–°—Å—ã–ª–∫–∞', comment:'–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è'
  },
  projects: {
    id:'ID', name:'–ù–∞–∑–≤–∞–Ω–∏–µ', direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', status:'–°—Ç–∞—Ç—É—Å', priority:'–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç',
    progress:'–ü—Ä–æ–≥—Ä–µ—Å—Å', partner:'–ü–∞—Ä—Ç–Ω—ë—Ä', budget:'–ë—é–¥–∂–µ—Ç', deadline:'–î–µ–¥–ª–∞–π–Ω',
    description:'–û–ø–∏—Å–∞–Ω–∏–µ', created_at:'–°–æ–∑–¥–∞–Ω–æ', updated_at:'–û–±–Ω–æ–≤–ª–µ–Ω–æ'
  },
  approvals: {
    id:'ID', type:'–¢–∏–ø', description:'–û–ø–∏—Å–∞–Ω–∏–µ', from_name:'–û—Ç_–∫–æ–≥–æ', from_role:'–†–æ–ª—å',
    telegram_id:'Telegram_ID', direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', project:'–ü—Ä–æ–µ–∫—Ç', sheet:'–õ–∏—Å—Ç',
    status:'–°—Ç–∞—Ç—É—Å', request_date:'–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞', decision_date:'–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è',
    ceo_decision:'–†–µ—à–µ–Ω–∏–µ_CEO', data:'–î–∞–Ω–Ω—ã–µ', created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è'
  },
  communications: {
    id:'ID', partner:'–ü–∞—Ä—Ç–Ω—ë—Ä', type:'–¢–∏–ø', subject:'–¢–µ–º–∞', comm_date:'–î–∞—Ç–∞',
    author:'–ê–≤—Ç–æ—Ä', result:'–†–µ–∑—É–ª—å—Ç–∞—Ç', created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è'
  },
  documents: {
    id:'ID', filename:'–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞', folder:'–ü–∞–ø–∫–∞', uploaded_by:'–ó–∞–≥—Ä—É–∑–∏–ª',
    upload_date:'–î–∞—Ç–∞', link:'–°—Å—ã–ª–∫–∞', drive_id:'Drive_ID', size:'–†–∞–∑–º–µ—Ä',
    created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è', project:'–ü—Ä–æ–µ–∫—Ç', file_type:'–¢–∏–ø'
  }
};

// Reverse maps (Russian ‚Üí English) for writing
const COL_MAP_REV = {};
for (const [table, map] of Object.entries(COL_MAP)) {
  COL_MAP_REV[table] = {};
  for (const [en, ru] of Object.entries(map)) { COL_MAP_REV[table][ru] = en; }
}

function mapFromDb(table, rows) {
  const map = COL_MAP[table];
  if (!map) return rows;
  return rows.map(row => {
    const out = {};
    for (const [key, val] of Object.entries(row)) {
      out[map[key] || key] = val;
    }
    return out;
  });
}

function mapToDb(table, row) {
  const map = COL_MAP_REV[table];
  if (!map) return row;
  const out = {};
  for (const [key, val] of Object.entries(row)) {
    const dbKey = map[key] || key.toLowerCase();
    if (dbKey !== '–¥–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è' && dbKey !== '–æ–±–Ω–æ–≤–ª–µ–Ω–æ') { // auto-managed
      out[dbKey] = val;
    }
  }
  return out;
}

function tableForSheet(sheet) {
  const m = {'–ü–∞—Ä—Ç–Ω—ë—Ä—ã':'partners','–ó–∞–¥–∞—á–∏':'tasks','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è':'directions',
    '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏':'staff','–ü—Ä–æ–µ–∫—Ç—ã':'projects','–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è':'approvals',
    '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏':'communications','–î–æ–∫—É–º–µ–Ω—Ç—ã':'documents'};
  return m[sheet] || sheet;
}

let DATA = { partners:[], tasks:[], directions:[], staff:[], projects:[], approvals:[], comms:[], documents:[] };
let USER = null;

function normalizeRole(role) {
  const r = (role||'').toLowerCase().trim();
  const map = {
    '–≥–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä': 'CEO', '–≥–µ–Ω–¥–∏—Ä–µ–∫—Ç–æ—Ä': 'CEO', '–≥–µ–Ω–¥–∏—Ä': 'CEO', '–≥–¥': 'CEO', '–¥–∏—Ä–µ–∫—Ç–æ—Ä': 'CEO',
    '–∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å': '–ó–∞–º', '–∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞': '–ó–∞–º', '–∑–∞–º–¥–∏—Ä': '–ó–∞–º', '–∑–∞–º': '–ó–∞–º',
    '–º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º': '–ú–µ–Ω–µ–¥–∂–µ—Ä', '–ø—Ä–æ–¥–∞–∂–Ω–∏–∫': '–ú–µ–Ω–µ–¥–∂–µ—Ä', '–º–µ–Ω–µ–¥–∂–µ—Ä': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
    '—Ä–∞–∑—Ä–∞–±': '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç': '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', 'dev': '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', '—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫': '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫',
    '–∏–Ω–∂–µ–Ω–µ—Ä': '–ò–Ω–∂–µ–Ω–µ—Ä', '—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
    'ceo': 'CEO'
  };
  // Exact match first
  if (map[r]) return map[r];
  // Prefix match: "–∑–∞–º –ø–æ —Å–∞–π—Ç–∞–º" starts with "–∑–∞–º" ‚Üí –ó–∞–º
  if (r.startsWith('–∑–∞–º')) return '–ó–∞–º';
  if (r.startsWith('—Ä—É–∫–æ–≤–æ–¥')) return '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å';
  if (r.startsWith('–º–µ–Ω–µ–¥–∂–µ—Ä')) return '–ú–µ–Ω–µ–¥–∂–µ—Ä';
  if (r.startsWith('–¥–∏—Ä–µ–∫—Ç–æ—Ä') || r.startsWith('–≥–µ–Ω–µ—Ä–∞–ª—å–Ω') || r.startsWith('–≥–µ–Ω–¥') || r === 'ceo') return 'CEO';
  if (r.startsWith('—Ä–∞–∑—Ä–∞–±') || r.startsWith('–ø—Ä–æ–≥—Ä–∞–º–º') || r.startsWith('dev')) return '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫';
  if (r.startsWith('–∏–Ω–∂–µ–Ω–µ—Ä')) return '–ò–Ω–∂–µ–Ω–µ—Ä';
  // Check if role is already a valid ROLES key
  if (ROLES[role]) return role;
  return role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
}
let currentModal = '';
let editingItem = null;
let confirmCallback = null;
let currentFilters = { partners: '–í—Å–µ', tasks: '–í—Å–µ' };
let refreshTimer = null;

// Navigation state
let currentProject = null;       // Top-level project key (e.g. 'rkt', 'sites')
let currentSubproject = null;    // Subproject direction (e.g. '–ö–¢', '–ü—ã—à–∫–∏ –º–∏—Ä–∞')
let currentPvTab = 'overview';   // Project view tab
let currentSpTab = 'overview';   // Subproject view tab
let currentTaskId = null;        // Task open for detail+AI
let aiMessages = [];             // AI chat history for current task

// ============================================================
// TOP-LEVEL PROJECTS DEFINITION
// ============================================================
const PROJECTS = {
  rkt: {
    name: '–†–ö–¢',
    emoji: 'üè•',
    color: 'var(--accent)',
    gradient: 'linear-gradient(90deg, #00d4aa, #00b894)',
    desc: '–†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è',
    subprojects: {
      '–ö–¢':       { emoji: 'üî¨', color: 'var(--accent)', desc: '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Ç–æ–º–æ–≥—Ä–∞—Ñ—ã ‚Äî –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Å Syno-Tech' },
      '–†–µ–Ω—Ç–≥–µ–Ω':  { emoji: 'üì°', color: 'var(--blue)', desc: '–†–µ–Ω—Ç–≥–µ–Ω–æ–≤—Å–∫–∏–µ –∞–ø–ø–∞—Ä–∞—Ç—ã ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–Ω–µ–π–∫–∏' },
      '–†–æ–±–æ—Ç—ã':   { emoji: 'ü§ñ', color: 'var(--purple)', desc: '–•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∏–µ —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã' },
      '–£—Ä–æ–ª–æ–≥–∏—è': { emoji: 'üíä', color: 'var(--orange)', desc: '–£—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' },
      'PACS':     { emoji: 'üíª', color: 'var(--pink)', desc: '–°–∏—Å—Ç–µ–º—ã –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π' },
      '–£–ó–ò':      { emoji: 'ü©∫', color: 'var(--green)', desc: '–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Äî –ø–ª–∞–Ω —Å 2028' }
    }
  },
  sites: {
    name: '–°–∞–π—Ç—ã',
    emoji: 'üåê',
    color: 'var(--blue)',
    gradient: 'linear-gradient(90deg, #4dabf7, #228be6)',
    desc: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –≤–µ–¥–µ–Ω–∏–µ –≤–µ–±-—Å–∞–π—Ç–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞',
    subprojects: {
      '–ü—ã—à–∫–∏ –º–∏—Ä–∞':  { emoji: 'üç©', color: 'var(--orange)', desc: '–°–∞–π—Ç –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –ü—ã—à–∫–∏ –º–∏—Ä–∞' },
      '–ë—Ä–µ–∂–Ω–µ–≤':     { emoji: 'üèõ', color: 'var(--red)', desc: '–°–∞–π—Ç –¥–ª—è —Ä–µ—Å—Ç–æ–∫–ª—É–±–∞ –ë—Ä–µ–∂–Ω–µ–≤' },
      '–ö–µ—Ä–∞—Ç–∏–Ω –ê–≥—Ä—ã–∑': { emoji: 'üíá', color: 'var(--pink)', desc: '–°–∞–π—Ç –∫–µ—Ä–∞—Ç–∏–Ω–æ–≤–æ–≥–æ –≤—ã–ø—Ä—è–º–ª–µ–Ω–∏—è, –ê–≥—Ä—ã–∑' }
    },
    canAddSub: true // can add new subprojects (sites)
  },
  content: {
    name: 'AI-–∫–æ–Ω—Ç–µ–Ω—Ç',
    emoji: 'üé¨',
    color: 'var(--purple)',
    gradient: 'linear-gradient(90deg, #8b5cf6, #a855f7)',
    desc: '–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π',
    subprojects: {
      '–í–∏–¥–µ–æ': { emoji: 'üé•', color: 'var(--purple)', desc: '–†–µ–∫–ª–∞–º–Ω—ã–µ –≤–∏–¥–µ–æ, Reels, Shorts, TikTok' },
      '–§–æ—Ç–æ':  { emoji: 'üì∏', color: 'var(--blue)', desc: '–§–æ—Ç–æ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞, –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤, –∫–∞—Ç–∞–ª–æ–≥–æ–≤' },
      '–ò–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä—ã': { emoji: 'üë§', color: 'var(--pink)', desc: '–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ AI-–∏–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä—ã' },
      '–°–æ—Ü—Å–µ—Ç–∏':  { emoji: 'üì±', color: 'var(--orange)', desc: '–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è Telegram, VK, Instagram' },
      '–î–∏–∑–∞–π–Ω':   { emoji: 'üé®', color: 'var(--accent)', desc: '–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏, –æ–±–ª–æ–∂–∫–∏, —Å—Ç–∏–∫–µ—Ä—ã' }
    },
    canAddSub: true
  },
  ai: {
    name: '–ò–ò-–∞–≥–µ–Ω—Ç—ã',
    emoji: 'ü§ñ',
    color: 'var(--orange)',
    gradient: 'linear-gradient(90deg, #f59e0b, #f97316)',
    desc: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è',
    subprojects: {
      'News Bot': { emoji: 'üì∞', color: 'var(--orange)', desc: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –Ω–æ–≤–æ—Å—Ç–Ω–æ–π –±–æ—Ç @nov1osti' },
      'RKT HUB':  { emoji: '‚ö°', color: 'var(--accent)', desc: '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏' },
      'Telegram-–±–æ—Ç—ã': { emoji: 'ü§ñ', color: 'var(--blue)', desc: '–ß–∞—Ç-–±–æ—Ç—ã —Å Claude AI' },
      'CRM': { emoji: 'üìä', color: 'var(--purple)', desc: 'CRM-–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –≤–æ—Ä–æ–Ω–∫–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞' },
      'n8n': { emoji: '‚öôÔ∏è', color: 'var(--green)', desc: '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤' }
    },
    canAddSub: true
  }
};

// ============================================================
// SITES BUSINESS: PRICING & SALARY MODEL
// ============================================================
const SITE_PRICING = {
  '–í–∏–∑–∏—Ç–∫–∞':     { price: 5000,  emoji: 'üìÑ', desc: '1-3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –±–∞–∑–æ–≤—ã–π –¥–∏–∑–∞–π–Ω' },
  '–õ–µ–Ω–¥–∏–Ω–≥':     { price: 10000, emoji: 'üéØ', desc: '1 –ø—Ä–æ–¥–∞—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –∞–Ω–∏–º–∞—Ü–∏–∏' },
  '–ö–∞—Ç–∞–ª–æ–≥':     { price: 15000, emoji: 'üõí', desc: '5+ —Å—Ç—Ä–∞–Ω–∏—Ü, –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤' },
  '–ü—Ä–µ–º–∏—É–º':     { price: 25000, emoji: '‚≠ê', desc: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω, SEO, CRM' },
  '–°–≤–∞–¥–µ–±–Ω—ã–π':   { price: 8000,  emoji: 'üíç', desc: '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ, RSVP, —Ñ–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è' },
  '–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ':   { price: 7000,  emoji: 'üé®', desc: '–ì–∞–ª–µ—Ä–µ—è —Ä–∞–±–æ—Ç, —Ä–µ–∑—é–º–µ, –∫–æ–Ω—Ç–∞–∫—Ç—ã' },
  '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ':  { price: 8000, emoji: 'üéâ', desc: '–°–æ–±—ã—Ç–∏–µ, –ø—Ä–æ–≥—Ä–∞–º–º–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' },
  '–ë–ª–æ–≥/–ú–µ–¥–∏–∞':  { price: 10000, emoji: 'üì∞', desc: '–ë–ª–æ–≥, —Å—Ç–∞—Ç—å–∏, –º–µ–¥–∏–∞–∫–æ–Ω—Ç–µ–Ω—Ç' },
  '–î—Ä—É–≥–æ–µ':      { price: 0,     emoji: 'üìå', desc: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç (—Ü–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É)' },
  '–î–æ–º–µ–Ω+—Ö–æ—Å—Ç–∏–Ω–≥': { price: 3000, emoji: 'üåê', desc: '–î–æ–º–µ–Ω .ru + —Ö–æ—Å—Ç–∏–Ω–≥ –Ω–∞ –≥–æ–¥' }
};

// Default salary percentages by role
const DEFAULT_SALARY_PCT = {
  '–ú–µ–Ω–µ–¥–∂–µ—Ä': 10,
  '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫': 10,
  '–ò–Ω–∂–µ–Ω–µ—Ä': 10,
  'CEO': 0,
  '–ó–∞–º': 0,
  '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': 0,
  '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': 0
};

// ============================================================
// DYNAMIC SUBPROJECTS: sync from database directions
// ============================================================
const SP_EMOJIS = ['üè™','üçï','üíà','üèãÔ∏è','üéì','üè†','üöó','üíê','üç∞','üé≠','üéµ','üì∏','üßÅ','üçú','‚òï','üõçÔ∏è','üé®','üè•','üì±','üîß'];
const SP_COLORS = ['var(--orange)','var(--blue)','var(--pink)','var(--purple)','var(--green)','var(--red)','var(--accent)','var(--yellow)'];

function syncSubprojectsFromDb(projKey) {
  const proj = PROJECTS[projKey];
  if (!proj) return;
  const projName = proj.name; // e.g. '–†–ö–¢' or '–°–∞–π—Ç—ã'
  
  // Get all directions for this project from database
  const dbDirs = (DATA.directions || []).filter(d => (d['–ü—Ä–æ–µ–∫—Ç']||'') === projName);
  
  // Keep hardcoded ones as defaults, add any new from DB
  const existing = new Set(Object.keys(proj.subprojects));
  
  dbDirs.forEach((d, idx) => {
    const name = d['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';
    if (!name || existing.has(name)) return;
    proj.subprojects[name] = {
      emoji: SP_EMOJIS[idx % SP_EMOJIS.length],
      color: SP_COLORS[idx % SP_COLORS.length],
      desc: d['–û–ø–∏—Å–∞–Ω–∏–µ'] || (projName === '–°–∞–π—Ç—ã' ? siteDescFromDir(d) : name)
    };
    existing.add(name);
  });
  
  // Also update descriptions from DB data for existing ones
  dbDirs.forEach(d => {
    const name = d['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';
    if (!name || !proj.subprojects[name]) return;
    if (projName === '–°–∞–π—Ç—ã') {
      proj.subprojects[name].desc = siteDescFromDir(d);
    }
  });
}

function siteDescFromDir(d) {
  const type = d['–¢–∏–ø —Å–∞–π—Ç–∞'] || '';
  const price = d['–¶–µ–Ω–∞'] || d['price'] || 0;
  const paid = d['–û–ø–ª–∞—á–µ–Ω–æ'] === true || d['–û–ø–ª–∞—á–µ–Ω–æ'] === 'TRUE';
  const status = d['–°—Ç–∞—Ç—É—Å'] || '';
  let desc = '';
  if (type) desc += type;
  if (price) desc += ' ¬∑ ' + Number(price).toLocaleString('ru') + '‚ÇΩ';
  if (paid) desc += ' ‚úÖ –æ–ø–ª–∞—á–µ–Ω–æ';
  else if (price) desc += ' ¬∑ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ';
  if (status && status !== '–í —Ä–∞–±–æ—Ç–µ') desc += ' ¬∑ ' + status;
  return desc || '–ö–ª–∏–µ–Ω—Ç';
}

const SITE_PIPELINE = [
  { step: 1, name: 'üîç –ù–∞–π—Ç–∏ –ª–∏–¥–∞ –Ω–∞ –∫–∞—Ä—Ç–∞—Ö',        role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 0, auto: false },
  { step: 2, name: 'üìû –ü–µ—Ä–≤—ã–π –∑–≤–æ–Ω–æ–∫/—Å–æ–æ–±—â–µ–Ω–∏–µ',     role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 0, auto: false },
  { step: 3, name: 'üìû Follow-up #2 (–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å)',   role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 2, auto: true },
  { step: 4, name: 'üìû Follow-up #3 (–Ω–∞–ø–æ–º–Ω–∏—Ç—å)',     role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 5, auto: true },
  { step: 5, name: 'üé® –°–æ–∑–¥–∞—Ç—å –¥–µ–º–æ-–ø—Ä–æ—Ç–æ—Ç–∏–ø',       role: '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', days: 3, auto: true },
  { step: 6, name: 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø –∫–ª–∏–µ–Ω—Ç—É',  role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 4, auto: true },
  { step: 7, name: 'üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ö–ü',   role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 5, auto: true },
  { step: 8, name: 'üí¨ –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å',       role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 7, auto: false },
  { step: 9, name: 'üí∞ –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç + –æ–ø–ª–∞—Ç–∞',     role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 10, auto: true },
  { step: 10, name: 'üîß –ó–∞–ª–∏—Ç—å —Å–∞–π—Ç –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥',     role: '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', days: 12, auto: true },
  { step: 11, name: '‚úÖ –°–¥–∞—á–∞ –∫–ª–∏–µ–Ω—Ç—É',              role: '–ó–∞–º',        days: 14, auto: false },
  { step: 12, name: 'üëë –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ CEO',             role: 'CEO',        days: 15, auto: true }
];

function getSiteStaffByRole(role) {
  // Include staff from main project and extra_projects
  const staff = DATA.staff.filter(s => {
    if (s['–°—Ç–∞—Ç—É—Å'] !== '–ê–∫—Ç–∏–≤–Ω—ã–π') return false;
    if (s['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã') return true;
    try {
      const extra = JSON.parse(s['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] || '[]');
      return Array.isArray(extra) && extra.includes('–°–∞–π—Ç—ã');
    } catch(e) { return false; }
  });

  const byRole = staff.filter(s => {
    const r = normalizeRole(s['–†–æ–ª—å']||'');
    if (role === '–ú–µ–Ω–µ–¥–∂–µ—Ä') return r === '–ú–µ–Ω–µ–¥–∂–µ—Ä';
    if (role === '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫') return r === '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫' || r === '–ò–Ω–∂–µ–Ω–µ—Ä';
    if (role === '–ó–∞–º') return r === '–ó–∞–º';
    if (role === 'CEO') return r === 'CEO';
    return false;
  });
  if (byRole.length) return byRole[0]['–ò–º—è'];

  // Escalation chain: –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ ‚Üí –ú–µ–Ω–µ–¥–∂–µ—Ä ‚Üí –ó–∞–º ‚Üí CEO
  // –ú–µ–Ω–µ–¥–∂–µ—Ä ‚Üí –ó–∞–º ‚Üí CEO
  const FALLBACK_CHAIN = {
    '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫': ['–ú–µ–Ω–µ–¥–∂–µ—Ä', '–ó–∞–º', 'CEO'],
    '–ú–µ–Ω–µ–¥–∂–µ—Ä':    ['–ó–∞–º', 'CEO'],
    '–ó–∞–º':         ['CEO'],
    'CEO':         []
  };
  const chain = FALLBACK_CHAIN[role] || ['–ó–∞–º', 'CEO'];
  for (const fallbackRole of chain) {
    const fb = staff.find(s => normalizeRole(s['–†–æ–ª—å']||'') === fallbackRole);
    if (fb) {
      console.log('[RKT] getSiteStaffByRole: fallback', role, '‚Üí', fallbackRole, '=', fb['–ò–º—è']);
      return fb['–ò–º—è'];
    }
  }

  return USER ? USER.name : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
}

function calcSiteFinancials() {
  const dirs = DATA.directions.filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const tasks = DATA.tasks.filter(t => t['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const staff = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π');

  let totalRevenue = 0, totalStaffCost = 0;
  const clientStats = [];
  const staffEarnings = {};

  // Initialize earnings for all staff with their salary_pct
  staff.forEach(s => {
    const pct = parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[s['–†–æ–ª—å']] || 0;
    staffEarnings[s['–ò–º—è']] = { role: s['–†–æ–ª—å'], pct, earned: 0, sites: 0 };
  });

  dirs.forEach(d => {
    const type = d['–¢–∏–ø —Å–∞–π—Ç–∞'] || '–õ–µ–Ω–¥–∏–Ω–≥';
    const pricing = SITE_PRICING[type] || SITE_PRICING['–õ–µ–Ω–¥–∏–Ω–≥'];
    const status = d['–°—Ç–∞—Ç—É—Å'] || '';
    const isDone = status.includes('–ì–æ—Ç–æ–≤–æ') || status.includes('‚úÖ') || status.includes('–û–ø–ª–∞—á–µ–Ω');
    const isPaid = status.includes('–û–ø–ª–∞—á–µ–Ω') || d['–û–ø–ª–∞—á–µ–Ω–æ'] === '–î–∞';

    const clientTasks = tasks.filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === d['–ù–∞–∑–≤–∞–Ω–∏–µ']);
    const doneTasks = clientTasks.filter(t => t['–°—Ç–∞—Ç—É—Å'] === '–ì–æ—Ç–æ–≤–æ' || t['–°—Ç–∞—Ç—É—Å'] === '‚úÖ –ì–æ—Ç–æ–≤–æ');
    const progress = clientTasks.length ? Math.round(doneTasks.length / clientTasks.length * 100) : 0;

    const revenue = isPaid ? pricing.price : 0;
    const plannedRevenue = pricing.price;
    totalRevenue += revenue;

    let clientStaffCost = 0;

    if (isDone || isPaid) {
      // Find all staff assigned to tasks for this client
      const assignedStaff = new Set();
      clientTasks.forEach(t => {
        const assignee = t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] || '';
        if (assignee && staffEarnings[assignee]) {
          assignedStaff.add(assignee);
        }
      });

      // Each assigned employee earns their salary_pct % from the site price
      assignedStaff.forEach(name => {
        const se = staffEarnings[name];
        const pay = Math.round(pricing.price * se.pct / 100);
        se.earned += pay;
        se.sites++;
        clientStaffCost += pay;
      });

      totalStaffCost += clientStaffCost;
    }

    clientStats.push({
      name: d['–ù–∞–∑–≤–∞–Ω–∏–µ'], type, pricing, status, progress,
      revenue, plannedRevenue, isPaid, isDone,
      tasksTotal: clientTasks.length, tasksDone: doneTasks.length,
      staffCost: clientStaffCost
    });
  });

  return {
    clients: clientStats,
    totalRevenue,
    plannedRevenue: dirs.length * 10000,
    totalStaffCost,
    totalCost: totalStaffCost,
    profit: totalRevenue - totalStaffCost,
    staffEarnings,
    staffCount: staff.length,
    clientCount: dirs.length,
    paidCount: clientStats.filter(c => c.isPaid).length,
    inProgressCount: clientStats.filter(c => !c.isDone && !c.isPaid).length
  };
}
// ============================================================
const ROLES = {
  'CEO': {
    emoji: 'üëë', level: 4,
    canWrite: true, canDelete: true, canApprove: true, canManageStaff: true, seeAll: true,
    canEditTasks: true, canEditPartners: true, canEditStaff: true, canEditProjects: true,
    canAssignTasks: true, canViewFinance: true, canExport: true, canSettings: true,
    canCreateSiteTask: true, canGenerateSite: true,
    writeSheets: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ó–∞–¥–∞—á–∏','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è','–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏','–ü—Ä–æ–µ–∫—Ç—ã','–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    desc: '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ'
  },
  '–ó–∞–º': {
    emoji: '‚≠ê', level: 3,
    canWrite: true, canDelete: false, canApprove: false, canManageStaff: true, seeAll: false,
    canEditTasks: true, canEditPartners: true, canEditStaff: true, canEditProjects: false,
    canAssignTasks: true, canViewFinance: true, canExport: true, canSettings: false,
    canCreateSiteTask: true, canGenerateSite: true,
    writeSheets: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ó–∞–¥–∞—á–∏','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'],
    needsApproval: ['–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏','–ü—Ä–æ–µ–∫—Ç—ã'],
    desc: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏–º –ø—Ä–æ–µ–∫—Ç–æ–º: –∑–∞–¥–∞—á–∏, –ø–∞—Ä—Ç–Ω—ë—Ä—ã, –∫–æ–º–∞–Ω–¥–∞'
  },
  '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': {
    emoji: 'üìã', level: 2,
    canWrite: true, canDelete: false, canApprove: false, canManageStaff: false, seeAll: false,
    canEditTasks: true, canEditPartners: false, canEditStaff: false, canEditProjects: false,
    canAssignTasks: true, canViewFinance: false, canExport: false, canSettings: false,
    canCreateSiteTask: true, canGenerateSite: true,
    writeSheets: ['–ó–∞–¥–∞—á–∏','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    needsApproval: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è','–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏','–ü—Ä–æ–µ–∫—Ç—ã'],
    desc: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ –≤ —Å–≤–æ—ë–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏'
  },
  '–ú–µ–Ω–µ–¥–∂–µ—Ä': {
    emoji: 'üíº', level: 1,
    canWrite: true, canDelete: false, canApprove: false, canManageStaff: false, seeAll: false,
    canEditTasks: true, canEditPartners: false, canEditStaff: false, canEditProjects: false,
    canAssignTasks: false, canViewFinance: false, canExport: false, canSettings: false,
    canCreateSiteTask: true, canGenerateSite: false,
    writeSheets: ['–ó–∞–¥–∞—á–∏','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    needsApproval: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'],
    desc: '–†–∞–±–æ—Ç–∞ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á'
  },
  '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': {
    emoji: 'üë§', level: 0,
    canWrite: false, canDelete: false, canApprove: false, canManageStaff: false, seeAll: false,
    canEditTasks: false, canEditPartners: false, canEditStaff: false, canEditProjects: false,
    canAssignTasks: false, canViewFinance: false, canExport: false, canSettings: false,
    canCreateSiteTask: false, canGenerateSite: false,
    writeSheets: [],
    needsApproval: ['–ó–∞–¥–∞—á–∏','–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    desc: '–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –∑–∞–¥–∞—á'
  }
};

function getUserPerms() {
  const base = ROLES[USER?.role] || ROLES['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
  if (!USER) return base;
  const staff = (DATA.staff||[]).find(s => (s['–ò–º—è']||s.name) === USER.name);
  if (!staff) return base;
  let overrides;
  try { overrides = JSON.parse(staff['–ü—Ä–∞–≤–∞'] || '{}'); } catch(e) { return base; }
  if (!overrides || typeof overrides !== 'object' || !Object.keys(overrides).length) return base;
  return { ...base, ...overrides };
}

// Check if user can directly write to a sheet or needs approval
function canDirectWrite(sheet) {
  const p = getUserPerms();
  if (p.writeSheets && p.writeSheets.includes(sheet)) return 'direct';
  if (p.needsApproval && p.needsApproval.includes(sheet)) return 'approval';
  return 'denied';
}

// ============================================================
// FORM DEFINITIONS
// ============================================================
function getDirectionOptions(forProject) {
  let opts = [];
  if (forProject && forProject !== '–í—Å–µ') {
    // Find project by name and return only its subprojects
    const proj = Object.values(PROJECTS).find(p => p.name === forProject);
    if (proj) {
      Object.keys(proj.subprojects).forEach(sp => opts.push(sp));
    }
  } else {
    // All subprojects
    Object.values(PROJECTS).forEach(p => {
      Object.keys(p.subprojects).forEach(sp => { if (!opts.includes(sp)) opts.push(sp); });
    });
  }
  opts.push('–û–±—â–µ–µ');
  return opts;
}

function getStaffOptions(forProject) {
  let active = (DATA.staff||[]).filter(s => (s['–°—Ç–∞—Ç—É—Å']||'')!=='–û—Ç–∫–ª—é—á—ë–Ω');
  if (forProject && forProject !== '–í—Å–µ') {
    active = active.filter(s => (s['–ü—Ä–æ–µ–∫—Ç']||'') === forProject);
  }
  const names = active.map(s => (s['–ò–º—è']||s.name||'').trim()).filter(Boolean);
  // Unique, sorted
  return [...new Set(names)].sort((a,b) => a.localeCompare(b,'ru'));
}

function getProjectOptions() {
  return Object.values(PROJECTS).map(p => p.name);
}

const FORM_DEFS = {
  partner: {
    title: '–ü–∞—Ä—Ç–Ω—ë—Ä', sheet: '–ü–∞—Ä—Ç–Ω—ë—Ä—ã',
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏' },
      { name: '–°—Ç—Ä–∞–Ω–∞', type: 'text', placeholder: '–ö–∏—Ç–∞–π, –†–æ—Å—Å–∏—è...' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–ü—Ä–æ–¥—É–∫—Ç', type: 'text', placeholder: '–ü—Ä–æ–¥—É–∫—Ç' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['Research', '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–ê–∫—Ç–∏–≤–Ω—ã–π', '–ü–∞—É–∑–∞'] },
      { name: '–ö–æ–Ω—Ç–∞–∫—Ç', type: 'text', placeholder: '–ò–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞' },
      { name: 'Email', type: 'text', placeholder: 'email@company.com' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...' },
      { name: '–°–∞–π—Ç', type: 'text', placeholder: 'https://' },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–ó–∞–º–µ—Ç–∫–∏...' }
    ]
  },
  project: {
    title: '–ü—Ä–æ–µ–∫—Ç', sheet: '–ü—Ä–æ–µ–∫—Ç—ã',
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–û–ø–∏—Å–∞–Ω–∏–µ...' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', '–í —Ä–∞–±–æ—Ç–µ', '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–ó–∞–≤–µ—Ä—à—ë–Ω'] },
      { name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', type: 'select', options: ['P1', 'P2', 'P3'] },
      { name: '–ü—Ä–æ–≥—Ä–µ—Å—Å', type: 'text', placeholder: '0-100' },
      { name: '–ü–∞—Ä—Ç–Ω—ë—Ä', type: 'text', placeholder: '–ü–∞—Ä—Ç–Ω—ë—Ä' },
      { name: '–ë—é–¥–∂–µ—Ç', type: 'text', placeholder: '–ë—é–¥–∂–µ—Ç' },
      { name: '–î–µ–¥–ª–∞–π–Ω', type: 'date' },
      { name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'text', placeholder: '–ö—Ç–æ –≤–µ–¥—ë—Ç' }
    ]
  },
  task: {
    title: '–ó–∞–¥–∞—á–∞', sheet: '–ó–∞–¥–∞—á–∏',
    fields: [
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions(currentProject ? (PROJECTS[currentProject]||{}).name : null) },
      { name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', type: 'select', options: ['P1', 'P2', 'P3'] },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['‚è≥ –í –æ—á–µ—Ä–µ–¥–∏', '–í —Ä–∞–±–æ—Ç–µ', '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', '–ì–æ—Ç–æ–≤–æ'] },
      { name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'select', options: () => getStaffOptions(currentProject ? (PROJECTS[currentProject]||{}).name : null) },
      { name: '–ü—Ä–æ–µ–∫—Ç', type: 'select', options: () => getProjectOptions() },
      { name: '–î–µ–¥–ª–∞–π–Ω', type: 'date' },
      { name: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', type: 'textarea', placeholder: '–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...' }
    ]
  },
  staff: {
    title: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', sheet: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
    fields: [
      { name: '–ò–º—è', type: 'text', required: true, placeholder: '–§–ò–û' },
      { name: '–†–æ–ª—å', type: 'select', options: ['CEO', '–ó–∞–º', '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', '–ú–µ–Ω–µ–¥–∂–µ—Ä', '–ò–Ω–∂–µ–Ω–µ—Ä', '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'], onchange: 'updatePermDefaultsOnRoleChange(this.value)' },
      { name: '–ü—Ä–æ–µ–∫—Ç', type: 'select', options: () => ['–í—Å–µ', ...Object.values(PROJECTS).map(p=>p.name)], onchange: 'updateDirectionOptions(this.value)' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', id: 'field-direction', options: () => ['–í—Å–µ', ...getDirectionOptions()] },
      { name: '–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü', type: 'number', placeholder: '% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ (0-100)' },
      { name: 'Telegram_ID', type: 'text', placeholder: '–ß–∏—Å–ª–æ–≤–æ–π Telegram ID' },
      { name: 'Username', type: 'text', placeholder: '@username' },
      { name: 'Email', type: 'text', placeholder: 'email' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...', required: true },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['–ê–∫—Ç–∏–≤–Ω—ã–π', '–û–∂–∏–¥–∞–µ—Ç', '–û—Ç–∫–ª—é—á—ë–Ω'] }
    ]
  },
  comm: {
    title: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è', sheet: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏',
    fields: [
      { name: '–ü–∞—Ä—Ç–Ω—ë—Ä', type: 'text', required: true, placeholder: '–° –∫–µ–º –æ–±—â–∞–ª–∏—Å—å' },
      { name: '–¢–∏–ø', type: 'select', options: ['–ó–≤–æ–Ω–æ–∫', 'Email', '–í—Å—Ç—Ä–µ—á–∞', '–ß–∞—Ç', 'Zoom', 'Telegram'] },
      { name: '–¢–µ–º–∞', type: 'text', placeholder: '–¢–µ–º–∞' },
      { name: '–†–µ–∑—É–ª—å—Ç–∞—Ç', type: 'textarea', placeholder: '–ò—Ç–æ–≥, –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏...' },
      { name: '–°–ª–µ–¥—É—é—â–∏–π_—à–∞–≥', type: 'text', placeholder: '–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ' },
      { name: '–î–∞—Ç–∞_—Å–ª–µ–¥—É—é—â–µ–≥–æ', type: 'date' }
    ]
  },
  site: {
    title: '–°–∞–π—Ç (–ø–æ–¥–ø—Ä–æ–µ–∫—Ç)', sheet: null, // handled locally
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞' },
      { name: '–°—Å—ã–ª–∫–∞', type: 'text', placeholder: 'https://...' },
      { name: '–ö–ª–∏–µ–Ω—Ç', type: 'text', placeholder: '–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...' },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...' }
    ]
  }
};

// ============================================================
// HELPERS
// ============================================================
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escA(s) { return String(s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }
function translitCyr(str) {
  const m = {'–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'yo','–∂':'zh','–∑':'z','–∏':'i','–π':'j','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'h','—Ü':'ts','—á':'ch','—à':'sh','—â':'shch','—ä':'','—ã':'y','—å':'','—ç':'e','—é':'yu','—è':'ya'};
  return str.split('').map(c => { const lo=c.toLowerCase(); if(m[lo]!==undefined){const t=m[lo];return c===lo?t:t.charAt(0).toUpperCase()+t.slice(1)}return c; }).join('');
}
function slugify(str) { return translitCyr(str).replace(/[^a-zA-Z0-9_-]/g, '_').replace(/_+/g,'_').replace(/^_|_$/g,''); }
function emptyRow(c,m,cta) { return '<tr><td colspan="'+c+'" class="empty" style="padding:32px;text-align:center"><div class="icon" style="font-size:32px;margin-bottom:8px">üì≠</div><p style="color:var(--text2);margin-bottom:12px">'+m+'</p>'+(cta?'<button class="btn btn-primary btn-sm" onclick="'+cta.action+'" style="display:inline-block;width:auto">'+cta.label+'</button>':'')+'</td></tr>'; }

function statusBadge(s) {
  if (!s) return '';
  let c = 's-active';
  if (s==='–ê–∫—Ç–∏–≤–Ω—ã–π'||s.includes('–ì–æ—Ç–æ–≤–æ')) c='s-done';
  else if (s==='–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã') c='s-talks';
  else if (s==='Research'||s.includes('–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ')) c='s-research';
  else if (s==='–ü–∞—É–∑–∞') c='s-pause';
  else if (s.includes('—Ä–∞–±–æ—Ç–µ')||s.includes('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞')||s.includes('–ø—Ä–æ–≤–µ—Ä–∫–µ')) c='s-work';
  else if (s.includes('–û–∂–∏–¥–∞–µ—Ç')||s.includes('–æ—á–µ—Ä–µ–¥–∏')) c='s-urgent';
  else if (s.includes('–û–¥–æ–±—Ä–µ–Ω–æ')) c='s-done';
  else if (s.includes('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')) c='s-urgent';
  return '<span class="status '+c+'">'+esc(s)+'</span>';
}

function prBadge(p) {
  if (!p) return '';
  return '<span class="'+(p==='P1'?'p1':p==='P2'?'p2':'p3')+'">'+esc(p)+'</span>';
}

function progBar(v) {
  v = parseInt(v)||0;
  const c = v>=80?'var(--green)':v>=50?'var(--accent)':v>=25?'var(--orange)':'var(--red)';
  return '<div class="progress-wrap"><div class="progress-bar"><div class="progress-fill" style="width:'+v+'%;background:'+c+'"></div></div><span class="progress-text">'+v+'%</span></div>';
}

function actBtns(type, id, name) {
  const p = getUserPerms();
  let h = '<div class="actions-cell">';
  h += '<button class="act-btn view" onclick="viewItem(\''+type+'\',\''+escA(id)+'\')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅ</button>';
  if (type === 'task') {
    h += '<button class="act-btn ai" onclick="openTaskDetail(\''+escA(id)+'\')" title="–û—Ç–∫—Ä—ã—Ç—å —Å –ò–ò">ü§ñ</button>';
  }
  h += '<button class="act-btn" onclick="editItem(\''+type+'\',\''+escA(id)+'\')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>';
  if (p.canDelete) h += '<button class="act-btn del" onclick="confirmDelete(\''+type+'\',\''+escA(id)+'\',\''+escA(name)+'\')" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>';
  h += '</div>';
  return h;
}

function toast(m,t) {
  const e = document.getElementById('toast');
  e.textContent = m;
  e.className = 'toast toast-'+(t||'success')+' show';
  setTimeout(()=>e.classList.remove('show'), 3000);
}

function showPasswordModal(staffName, password, note) {
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center';
  overlay.onclick = function(e) { if (e.target === overlay) document.body.removeChild(overlay); };
  var box = document.createElement('div');
  box.style.cssText = 'background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:380px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.5)';
  box.innerHTML = '<div style="font-size:32px;margin-bottom:12px">üîë</div>' +
    '<div style="font-size:15px;font-weight:600;margin-bottom:4px;color:var(--text)">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è ' + esc(staffName) + '</div>' +
    '<div style="font-size:24px;font-weight:800;color:var(--accent);background:var(--bg3);border-radius:10px;padding:14px;margin:16px 0;font-family:JetBrains Mono,monospace;letter-spacing:2px;user-select:all">' + esc(password) + '</div>' +
    (note ? '<div style="font-size:12px;color:var(--text3);margin-bottom:16px">‚ö†Ô∏è ' + esc(note) + '</div>' : '') +
    '<div style="display:flex;gap:8px">' +
    '<button onclick="navigator.clipboard.writeText(\'' + password + '\');toast(\'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!\',\'success\')" style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--accent);background:rgba(0,212,170,0.1);color:var(--accent);font-size:13px;font-weight:600;cursor:pointer">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>' +
    '<button onclick="this.closest(\'div\').closest(\'div\').closest(\'div\').remove()" style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:13px;cursor:pointer">–ó–∞–∫—Ä—ã—Ç—å</button>' +
    '</div>';
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function setStatus(s) {
  const d=document.getElementById('statusDot'), t=document.getElementById('statusText');
  if (s==='connected') { d.className='dot dot-green'; t.textContent='–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚Ä¢ '+new Date().toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'}); }
  else if (s==='loading') { d.className='dot dot-green'; t.textContent='–ó–∞–≥—Ä—É–∑–∫–∞...'; }
  else { d.className='dot dot-red'; t.textContent='–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'; }
}

function updateStatusTime() {
  const e=document.getElementById('statusTime');
  if(e) e.textContent=new Date().toLocaleString('ru',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});
}

function today() { return new Date().toISOString().split('T')[0]; }

// Russian date formatting: "12 —Ñ–µ–≤—Ä–∞–ª—è 2026"
function formatDateRu(dateStr) {
  if (!dateStr) return '‚Äî';
  try {
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    const months = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];
    return d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
  } catch(e) { return dateStr; }
}

// Short Russian date: "12 —Ñ–µ–≤"
function formatDateShort(dateStr) {
  if (!dateStr) return '‚Äî';
  try {
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    const months = ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
    return d.getDate() + ' ' + months[d.getMonth()];
  } catch(e) { return dateStr; }
}

// ============================================================
// AUTHENTICATION
// ============================================================
function checkSavedLogin() {
  loadSavedSettings();
  loadNotifications();
  initMobileMenu();
  const s = localStorage.getItem('rkt_user');
  if (s) { try { USER=JSON.parse(s); if(USER&&(USER.tgId||USER.phone||USER.name)){USER.role=normalizeRole(USER.role);showApp();return;} } catch(e){} localStorage.removeItem('rkt_user'); }
  // Not logged in ‚Äî load staff cache
  loadStaffCache();
}

// ============ PASSWORD AUTH ============
let _staffCache = [];
const ROLE_COLORS = {'CEO':'#e74c3c','–ó–∞–º':'#e67e22','–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':'#3498db','–ú–µ–Ω–µ–¥–∂–µ—Ä':'#00d4aa','–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫':'#9b59b6','–ò–Ω–∂–µ–Ω–µ—Ä':'#1abc9c','–°–æ—Ç—Ä—É–¥–Ω–∏–∫':'#7f8c8d'};

async function hashPassword(pass) {
  const data = new TextEncoder().encode(pass + '_rkt_hub_2026');
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// Load staff cache (for internal use, not displayed to user)
async function loadStaffCache() {
  if (!SB) { console.warn('No Supabase connection'); return; }
  try {
    const { data, error } = await SB.from('staff').select('*');
    if (error) throw error;
    _staffCache = (data||[]).map(s => mapFromDb('staff',[s])[0]).filter(Boolean);
  } catch(e) {
    console.error('loadStaffCache:', e);
  }
}

// ---- LEGAL PAGES (152-–§–ó) ----
function showLegalPage(type) {
  var modal = document.getElementById('legalModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'legalModal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
    modal.onclick = function(e) { if (e.target === modal) modal.style.display = 'none'; };
    document.body.appendChild(modal);
  }
  var content = type === 'privacy' ? getPrivacyPolicyHTML() : getTermsHTML();
  var title = type === 'privacy' ? 'üîí –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏' : 'üìã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ';
  modal.innerHTML = '<div style="background:var(--bg2,#1a1a2e);border:1px solid var(--border,#333);border-radius:12px;max-width:700px;width:100%;max-height:80vh;overflow-y:auto;padding:30px;color:var(--text,#e0e0e0)">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h2 style="font-size:18px;margin:0">' + title + '</h2><button onclick="document.getElementById(\'legalModal\').style.display=\'none\'" style="background:none;border:none;color:var(--text2,#aaa);font-size:24px;cursor:pointer;line-height:1">&times;</button></div>' +
    content + '</div>';
  modal.style.display = 'flex';
}

function getPrivacyPolicyHTML() {
  return '<div style="font-size:13px;line-height:1.7;color:var(--text2,#ccc)">' +
    '<p style="margin-bottom:12px"><strong>–î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ —Å–∏–ª—É:</strong> 16 —Ñ–µ–≤—Ä–∞–ª—è 2026 –≥.</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è</h3>' +
    '<p>–ù–∞—Å—Ç–æ—è—â–∞—è –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—â–∏—Ç—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–µ—Ä–≤–∏—Å–∞ RKT HUB (–¥–∞–ª–µ–µ ‚Äî –°–µ—Ä–≤–∏—Å), —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ –∞–¥—Ä–µ—Å—É rct-hub.ru.</p>' +
    '<p><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:</strong> –†–ö–¢ ‚Äî –†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏<br>' +
    '<strong>–ê–¥—Ä–µ—Å:</strong> –†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω, –≥. –ö–∞–∑–∞–Ω—å, –û–≠–ó ¬´–ò–Ω–Ω–æ–ø–æ–ª–∏—Å¬ª<br>' +
    '<strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> info@rct-hub.ru</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">2. –ö–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –º—ã —Å–æ–±–∏—Ä–∞–µ–º</h3>' +
    '<p>–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –°–µ—Ä–≤–∏—Å–∞ –º—ã –º–æ–∂–µ–º —Å–æ–±–∏—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</p>' +
    '<ul style="margin:8px 0;padding-left:20px">' +
    '<li>–§–∞–º–∏–ª–∏—è, –∏–º—è, –æ—Ç—á–µ—Å—Ç–≤–æ</li>' +
    '<li>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</li>' +
    '<li>–ê–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã</li>' +
    '<li>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram</li>' +
    '<li>–ì–æ—Ä–æ–¥ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è</li>' +
    '<li>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ (–æ–ø–∏—Å–∞–Ω–∏–µ, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏, —Ñ–∞–π–ª—ã)</li>' +
    '</ul>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">3. –¶–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>' +
    '<ul style="margin:8px 0;padding-left:20px">' +
    '<li>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</li>' +
    '<li>–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</li>' +
    '<li>–£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —É—Å–ª—É–≥</li>' +
    '<li>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–Ω—ã—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤</li>' +
    '</ul>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">4. –ü—Ä–∞–≤–æ–≤—ã–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>' +
    '<p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏:</p>' +
    '<ul style="margin:8px 0;padding-left:20px">' +
    '<li>–°–æ–≥–ª–∞—Å–∏—è —Å—É–±—ä–µ–∫—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Å—Ç. 6 –ø.1 –ø–ø.1 –§–ó-152)</li>' +
    '<li>–ò—Å–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ (—Å—Ç. 6 –ø.1 –ø–ø.5 –§–ó-152)</li>' +
    '</ul>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">5. –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º</h3>' +
    '<p>–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –°–µ—Ä–≤–∏—Å–∞ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–µ–¥—É—é—â–∏—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ —É—Å–ª—É–≥:</p>' +
    '<ul style="margin:8px 0;padding-left:20px">' +
    '<li><strong>Supabase Inc.</strong> ‚Äî –æ–±–ª–∞—á–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</li>' +
    '<li><strong>n8n</strong> ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤</li>' +
    '<li><strong>Telegram Bot API</strong> ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</li>' +
    '<li><strong>Anthropic (Claude AI)</strong> ‚Äî –ò–ò-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</li>' +
    '</ul>' +
    '<p>–î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ —Ü–µ–ª—è—Ö –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥ –∏ –≤ –æ–±—ä—ë–º–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–º –¥–ª—è –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">6. –°—Ä–æ–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è</h3>' +
    '<p>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥ –∏ 3 (—Ç—Ä—ë—Ö) –ª–µ—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞, –µ—Å–ª–∏ –∏–Ω–æ–µ –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –†–§.</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">7. –ü—Ä–∞–≤–∞ —Å—É–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö</h3>' +
    '<p>–í—ã –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤–æ:</p>' +
    '<ul style="margin:8px 0;padding-left:20px">' +
    '<li>–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</li>' +
    '<li>–¢—Ä–µ–±–æ–≤–∞—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è, –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</li>' +
    '<li>–û—Ç–æ–∑–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö</li>' +
    '<li>–û–±–∂–∞–ª–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤ –†–æ—Å–∫–æ–º–Ω–∞–¥–∑–æ—Ä</li>' +
    '</ul>' +
    '<p>–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–≤–æ–∏—Ö –ø—Ä–∞–≤ –Ω–∞–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å –Ω–∞ info@rct-hub.ru.</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">8. –§–∞–π–ª—ã cookie –∏ localStorage</h3>' +
    '<p>–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç localStorage –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –†–µ–∫–ª–∞–º–Ω—ã–µ –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–∫–µ—Ä—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">9. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ü–æ–ª–∏—Ç–∏–∫–∏</h3>' +
    '<p>–û–ø–µ—Ä–∞—Ç–æ—Ä –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞ —Å–æ–±–æ–π –ø—Ä–∞–≤–æ –≤–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç–æ—è—â—É—é –ü–æ–ª–∏—Ç–∏–∫—É. –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ rct-hub.ru.</p>' +
    '<p style="margin-top:16px;color:var(--text3,#888)">–ù–∞—Å—Ç–æ—è—â–∞—è –ü–æ–ª–∏—Ç–∏–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–º –∑–∞–∫–æ–Ω–æ–º –æ—Ç 27.07.2006 ‚Ññ 152-–§–ó ¬´–û –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö¬ª.</p>' +
    '</div>';
}

function getTermsHTML() {
  return '<div style="font-size:13px;line-height:1.7;color:var(--text2,#ccc)">' +
    '<p style="margin-bottom:12px"><strong>–î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ —Å–∏–ª—É:</strong> 16 —Ñ–µ–≤—Ä–∞–ª—è 2026 –≥.</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è</h3>' +
    '<p>–ù–∞—Å—Ç–æ—è—â–µ–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ (–¥–∞–ª–µ–µ ‚Äî –°–æ–≥–ª–∞—à–µ–Ω–∏–µ) —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º —Å–µ—Ä–≤–∏—Å–∞ RKT HUB (–†–ö–¢ ‚Äî –†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –¥–∞–ª–µ–µ ‚Äî –û–ø–µ—Ä–∞—Ç–æ—Ä) –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å–µ—Ä–≤–∏—Å–∞ (–¥–∞–ª–µ–µ ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å).</p>' +
    '<p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –°–µ—Ä–≤–∏—Å–∞ –æ–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –∏ –±–µ–∑–æ–≥–æ–≤–æ—Ä–æ—á–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –°–æ–≥–ª–∞—à–µ–Ω–∏—è.</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">2. –ü—Ä–µ–¥–º–µ—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è</h3>' +
    '<p>–û–ø–µ—Ä–∞—Ç–æ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å—É RKT HUB –¥–ª—è:</p>' +
    '<ul style="margin:8px 0;padding-left:20px">' +
    '<li>–ü–æ–¥–∞—á–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É —Å–∞–π—Ç–æ–≤ –∏ digital-—É—Å–ª—É–≥–∏</li>' +
    '<li>–£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏ —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</li>' +
    '<li>–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</li>' +
    '<li>–û–±–º–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ —Ñ–∞–π–ª–∞–º–∏ –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞</li>' +
    '</ul>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">3. –ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å—Ç–æ—Ä–æ–Ω</h3>' +
    '<p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è:</strong></p>' +
    '<ul style="margin:8px 0;padding-left:20px">' +
    '<li>–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</li>' +
    '<li>–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –°–µ—Ä–≤–∏—Å –≤ –Ω–µ–∑–∞–∫–æ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö</li>' +
    '<li>–û–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å —Å–≤–æ–∏—Ö —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</li>' +
    '</ul>' +
    '<p><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä –æ–±—è–∑—É–µ—Ç—Å—è:</strong></p>' +
    '<ul style="margin:8px 0;padding-left:20px">' +
    '<li>–û–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –°–µ—Ä–≤–∏—Å–∞</li>' +
    '<li>–ó–∞—â–∏—â–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</li>' +
    '<li>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ä–æ–∫–∏</li>' +
    '</ul>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">4. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</h3>' +
    '<p>–û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—É—é –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –°–µ—Ä–≤–∏—Å–∞ –≤—Å–ª–µ–¥—Å—Ç–≤–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç, —Å–±–æ–µ–≤ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–ª–∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤ –Ω–µ–ø—Ä–µ–æ–¥–æ–ª–∏–º–æ–π —Å–∏–ª—ã.</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">5. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</h3>' +
    '<p>–í—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –°–µ—Ä–≤–∏—Å–∞ (–¥–∏–∑–∞–π–Ω, –∫–æ–¥, —Ç–µ–∫—Å—Ç—ã) —è–≤–ª—è—é—Ç—Å—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é –û–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ –∑–∞—â–∏—â–µ–Ω—ã –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –†–§.</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">6. –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–ø–æ—Ä–æ–≤</h3>' +
    '<p>–°–ø–æ—Ä—ã —Ä–µ—à–∞—é—Ç—Å—è –ø—É—Ç—ë–º –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤. –ü—Ä–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Å—É–¥–µ–±–Ω–æ–≥–æ —É—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–∏.</p>' +
    '<h3 style="font-size:15px;color:var(--text,#e0e0e0);margin:16px 0 8px">7. –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>' +
    '<p>–†–ö–¢ ‚Äî –†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏<br>' +
    '–ê–¥—Ä–µ—Å: –†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω, –≥. –ö–∞–∑–∞–Ω—å, –û–≠–ó ¬´–ò–Ω–Ω–æ–ø–æ–ª–∏—Å¬ª<br>' +
    'Email: info@rct-hub.ru<br>' +
    'Telegram: @AIhroject_bot</p>' +
    '</div>';
}

// ---- UI TAB SWITCHING ----
function showAuthTab(tab) {
  document.getElementById('authLogin').style.display = tab==='login' ? 'block' : 'none';
  document.getElementById('authRegister').style.display = tab==='register' ? 'block' : 'none';
  document.getElementById('authForgot').style.display = tab==='forgot' ? 'block' : 'none';
  document.getElementById('authIntake').style.display = tab==='intake' ? 'block' : 'none';
  document.getElementById('authTabLogin').classList.toggle('active', tab==='login');
  document.getElementById('authTabReg').classList.toggle('active', tab==='register');
  document.getElementById('authTabIntake')?.classList.toggle('active', tab==='intake');
  // Clear errors
  ['loginError','regError','forgotError','intakeError'].forEach(id => { const e=document.getElementById(id); if(e){e.style.display='none'; e.style.color='';} });
  // Reset intake success on re-entry
  if (tab==='intake') {
    const s = document.getElementById('intakeSuccess');
    if (s) s.style.display = 'none';
    const f = document.getElementById('intakeFormFields');
    if (f) f.style.display = 'grid';
    const b = document.getElementById('intakeBtn');
    if (b) b.style.display = '';
    populateIntakeTypes();
  }
  // Focus first input
  if (tab==='login') document.getElementById('loginId')?.focus();
  if (tab==='register') document.getElementById('regName')?.focus();
  if (tab==='forgot') document.getElementById('forgotId')?.focus();
  if (tab==='intake') document.getElementById('intakeName')?.focus();
}

function showForgotPass() { showAuthTab('forgot'); }

// Populate intake type dropdown from SITE_PRICING
function populateIntakeTypes() {
  const sel = document.getElementById('intakeType');
  if (!sel || sel.options.length > 1) return;
  for (const [name, info] of Object.entries(SITE_PRICING)) {
    if (name === '–î–æ–º–µ–Ω+—Ö–æ—Å—Ç–∏–Ω–≥') continue; // This is an add-on, not a project type
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = info.emoji + ' ' + name + (info.price ? ' ‚Äî –æ—Ç ' + info.price.toLocaleString('ru') + '‚ÇΩ' : ' ‚Äî —Ü–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É');
    sel.appendChild(opt);
  }
}

// Submit public intake form (no auth required)
async function submitPublicIntake() {
  const name = document.getElementById('intakeName').value.trim();
  const contact = document.getElementById('intakeContact').value.trim();
  const type = document.getElementById('intakeType').value;
  const desc = document.getElementById('intakeDesc').value.trim();
  const budget = document.getElementById('intakeBudget').value.trim();

  const errEl = document.getElementById('intakeError');
  const showErr = (msg) => { errEl.textContent = msg; errEl.style.display = 'block'; };

  if (!name) { showErr('‚ùå –£–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è'); return; }
  if (!contact) { showErr('‚ùå –£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Telegram –¥–ª—è —Å–≤—è–∑–∏'); return; }
  if (!type) { showErr('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç–∞'); return; }
  if (!document.getElementById('intakeConsent')?.checked) { showErr('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö'); return; }

  const btn = document.getElementById('intakeBtnText');
  btn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';

  try {
    if (!SB) throw new Error('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');

    // Ensure staff cache is loaded for notifications
    if (!_staffCache || !_staffCache.length) await loadStaffCache();

    const pricing = SITE_PRICING[type] || {};
    const dirId = 'DIR' + Date.now().toString(36).toUpperCase();

    const { error } = await SB.from('directions').insert({
      id: dirId,
      name: name + ' (' + type + ')',
      project: '–°–∞–π—Ç—ã',
      status: '–ù–æ–≤—ã–π',
      stage: 'prospect',
      site_type: type,
      price: pricing.price || 0,
      paid: false,
      client_name: name,
      phone: contact,
      description: (desc || '–ó–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞') + (budget ? '\n–ë—é–¥–∂–µ—Ç: ' + budget : ''),
      source: '–ó–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞',
      created_at: new Date().toISOString().split('T')[0]
    });

    if (error) throw error;

    // Notify leadership (CEO + –ó–∞–º)
    const msg = 'üì© *–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞!*\n\n' +
      'üë§ ' + name + '\n' +
      'üì± ' + contact + '\n' +
      'üåê –¢–∏–ø: ' + (pricing.emoji || 'üìå') + ' ' + type +
      (pricing.price ? ' (' + pricing.price.toLocaleString('ru') + '‚ÇΩ)' : '') + '\n' +
      (budget ? 'üí∞ –ë—é–¥–∂–µ—Ç: ' + budget + '\n' : '') +
      (desc ? 'üìù ' + desc.slice(0, 200) + '\n' : '') +
      '\nüîó –û—Ç–∫—Ä–æ–π—Ç–µ RKT HUB –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏';

    notifyLeadership(msg);

    // Show success, hide form
    document.getElementById('intakeSuccess').style.display = 'block';
    document.getElementById('intakeFormFields').style.display = 'none';
    document.getElementById('intakeBtn').style.display = 'none';
    errEl.style.display = 'none';

  } catch(e) {
    console.error('Intake error:', e);
    showErr('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –Ω–∞–ø—Ä—è–º—É—é.');
  }

  btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
}

// Reset intake form for new submission
function resetIntakeForm() {
  document.getElementById('intakeName').value = '';
  document.getElementById('intakeContact').value = '';
  document.getElementById('intakeType').selectedIndex = 0;
  document.getElementById('intakeDesc').value = '';
  document.getElementById('intakeBudget').value = '';
  document.getElementById('intakeSuccess').style.display = 'none';
  document.getElementById('intakeFormFields').style.display = 'grid';
  document.getElementById('intakeBtn').style.display = '';
  document.getElementById('intakeName')?.focus();
}

function togglePassVis(inputId, btn) {
  const inp = document.getElementById(inputId);
  if (!inp) return;
  const isPass = inp.type === 'password';
  inp.type = isPass ? 'text' : 'password';
  btn.textContent = isPass ? 'üôà' : 'üëÅ';
}

function showLoginErr(m, color) { 
  const e=document.getElementById('loginError'); 
  e.textContent=m; e.style.display='block'; e.style.color=color||''; 
}

// ---- FIND STAFF BY IDENTIFIER ----
function findStaffByInput(input) {
  if (!input) return null;
  const q = input.trim();
  const allStaff = _staffCache;
  
  // @username
  if (q.startsWith('@')) {
    const uname = q.slice(1).toLowerCase();
    return allStaff.find(s => (s['Username']||'').toLowerCase().replace('@','') === uname);
  }
  // Phone
  if (/^\+?\d[\d\s\-()]{6,}$/.test(q)) {
    const clean = q.replace(/[\s\-()]/g, '');
    return allStaff.find(s => {
      const sp = (s['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[\s\-()]/g, '');
      return sp && (sp === clean || sp.endsWith(clean.slice(-10)) || clean.endsWith(sp.slice(-10)));
    });
  }
  // Email
  if (q.includes('@') && q.includes('.')) {
    return allStaff.find(s => (s['Email']||'').toLowerCase() === q.toLowerCase());
  }
  // Telegram ID (digits only)
  if (/^\d+$/.test(q)) {
    return allStaff.find(s => String(s.Telegram_ID||'').trim() === q);
  }
  // Name (exact then partial)
  const lower = q.toLowerCase();
  return allStaff.find(s => (s['–ò–º—è']||'').toLowerCase() === lower) ||
         allStaff.find(s => (s['–ò–º—è']||'').toLowerCase().includes(lower));
}

// ---- PASSWORD LOGIN ----

// ============================================================
// BRUTE-FORCE PROTECTION  (sessionStorage ‚Äî persists on reload)
// ============================================================
const MAX_LOGIN_ATTEMPTS = 5;
const LOCKOUT_MS = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

function checkLoginRate(identifier) {
  const key = 'rkt_login_' + identifier.toLowerCase();
  const now = Date.now();
  let state = {};
  try { state = JSON.parse(sessionStorage.getItem(key) || '{}'); } catch(e) {}

  // –£–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
  if (state.blockedUntil && now < state.blockedUntil) {
    return { blocked: true, sec: Math.ceil((state.blockedUntil - now) / 1000) };
  }
  // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: —Å–Ω—è—Ç—å —Ñ–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –µ—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ
  if (state.blockedUntil && now >= state.blockedUntil) {
    state = {};
  }
  // –°–±—Ä–æ—Å–∏—Ç—å –æ–∫–Ω–æ –µ—Å–ª–∏ –æ–Ω–æ —Å—Ç–∞—Ä—à–µ LOCKOUT_MS
  if (state.first && now - state.first > LOCKOUT_MS) {
    state = {};
  }

  state.count = (state.count || 0) + 1;
  if (!state.first) state.first = now;

  if (state.count >= MAX_LOGIN_ATTEMPTS) {
    state.blockedUntil = now + LOCKOUT_MS;
    sessionStorage.setItem(key, JSON.stringify(state));
    return { blocked: true, sec: Math.ceil(LOCKOUT_MS / 1000), fresh: true };
  }

  sessionStorage.setItem(key, JSON.stringify(state));
  return { blocked: false, attemptsLeft: MAX_LOGIN_ATTEMPTS - state.count };
}

function resetLoginRate(identifier) {
  sessionStorage.removeItem('rkt_login_' + identifier.toLowerCase());
}

async function doPasswordLogin() {
  const id = document.getElementById('loginId').value.trim();
  const pass = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';
  
  if (!SB) { showLoginErr('‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'); return; }
  if (!id) { showLoginErr('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, @—Ç–µ–≥ –∏–ª–∏ email'); return; }
  var _rate = checkLoginRate(id.toLowerCase());
  if (_rate.blocked) {
    const waitMin = Math.ceil(_rate.sec / 60);
    const waitMsg = _rate.sec > 90
      ? waitMin + ' –º–∏–Ω.'
      : _rate.sec + ' —Å–µ–∫.';
    showLoginErr('üîí –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ ' + waitMsg);
    return;
  }
  if (!pass) { showLoginErr('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'); return; }
  
  document.getElementById('loginBtnText').textContent = '‚è≥ –í—Ö–æ–¥...';
  
  try {
    // Load staff if not loaded
    if (!_staffCache.length) await loadStaffCache();
    
    const staff = findStaffByInput(id);
    if (!staff) {
      showLoginErr('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.');
      document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏';
      return;
    }

    // Check if user is pending approval
    const staffStatus = (staff['–°—Ç–∞—Ç—É—Å'] || staff.status || '–ê–∫—Ç–∏–≤–Ω—ã–π').trim();
    if (staffStatus === '–û–∂–∏–¥–∞–µ—Ç') {
      showLoginErr('‚è≥ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –µ—â—ë –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º.');
      document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏';
      return;
    }
    if (staffStatus === '–û—Ç–∫–ª—é—á—ë–Ω' || staffStatus === '‚ùå –£–¥–∞–ª—ë–Ω') {
      showLoginErr('üö´ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É.');
      document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏';
      return;
    }
    
    // Check password
    const hash = await hashPassword(pass);
    if (!staff['pin_hash']) {
      // No password set yet ‚Äî set it now and login
      try {
        await SB.from('staff').update({ pin_hash: hash }).eq('id', staff.ID||staff.id);
        staff['pin_hash'] = hash;
        const cached = _staffCache.find(s => (s.ID||s.id) === (staff.ID||staff.id));
        if (cached) cached['pin_hash'] = hash;
        showLoginErr('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –í—Ö–æ–¥–∏–º...', 'var(--green)');
        resetLoginRate(id);
        setTimeout(() => completeLogin(staff), 500);
        return;
      } catch(e2) {
        // pin_hash column may not exist ‚Äî login without password check
        console.warn('Cannot set password, pin_hash column may not exist:', e2);
        resetLoginRate(id);
        completeLogin(staff);
        return;
      }
    }

    if (hash !== staff['pin_hash']) {
      showLoginErr('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
      document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏';
      return;
    }

    // Success!
    resetLoginRate(id);
    completeLogin(staff);
    
  } catch(e) {
    console.error('Login error:', e);
    showLoginErr('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: '+e.message);
    document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏';
  }
}

// ---- PASSWORD REGISTER ----
async function doPasswordRegister() {
  const name = document.getElementById('regName').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const username = document.getElementById('regUsername').value.trim().replace(/^@/, '');
  const project = document.getElementById('regProject').value;
  const pass = document.getElementById('regPass').value;
  const pass2 = document.getElementById('regPass2').value;
  const errEl = document.getElementById('regError');
  errEl.style.display = 'none';
  errEl.style.color = '';
  
  if (!SB) { errEl.textContent='‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'; errEl.style.display='block'; return; }
  
  // Validation
  if (!name) { errEl.textContent='–£–∫–∞–∂–∏—Ç–µ –§–ò–û'; errEl.style.display='block'; return; }
  if (!phone) { errEl.textContent='–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω'; errEl.style.display='block'; return; }
  if (!project) { errEl.textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç'; errEl.style.display='block'; return; }
  if (!pass || pass.length < 4) { errEl.textContent='–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞'; errEl.style.display='block'; return; }
  if (pass !== pass2) { errEl.textContent='–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'; errEl.style.display='block'; return; }
  if (!document.getElementById('regConsent')?.checked) { errEl.textContent='‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö'; errEl.style.display='block'; return; }

  document.getElementById('regBtnText').textContent = '‚è≥ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
  
  try {
    if (!_staffCache.length) await loadStaffCache();
    
    // Check duplicates
    const cleanPhone = phone.replace(/[\s\-()]/g, '');
    const dup = _staffCache.find(s => {
      const sp = (s['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[\s\-()]/g, '');
      return (sp && cleanPhone && (sp === cleanPhone || sp.endsWith(cleanPhone.slice(-10)) || cleanPhone.endsWith(sp.slice(-10)))) ||
             (username && (s['Username']||'').toLowerCase().replace('@','') === username.toLowerCase());
    });
    if (dup) {
      errEl.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º '+(username && (dup['Username']||'').toLowerCase().replace('@','')===username.toLowerCase() ?'—Ç–µ–≥–æ–º':'—Ç–µ–ª–µ—Ñ–æ–Ω–æ–º')+' —É–∂–µ –µ—Å—Ç—å. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É –í—Ö–æ–¥.';
      errEl.style.display = 'block';
      document.getElementById('regBtnText').textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
      return;
    }
    
    const passHash = await hashPassword(pass);
    const newId = 'S' + Date.now().toString(36).toUpperCase();
    
    // Direct Supabase INSERT ‚Äî try with pin_hash first
    const baseRow = {
      id: newId, name: name, role: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', project: project,
      direction: null, telegram_id: null, username: username || null, email: null,
      phone: phone, status: '–û–∂–∏–¥–∞–µ—Ç'
    };
    
    // Attempt 1: with pin_hash
    let result = await SB.from('staff').insert({ ...baseRow, pin_hash: passHash });
    
    // Attempt 2: without pin_hash on ANY error
    if (result.error) {
      console.warn('Insert attempt 1 failed:', result.error.message, '‚Äî retrying without pin_hash');
      result = await SB.from('staff').insert(baseRow);
    }
    
    if (result.error) {
      console.error('Registration insert error:', result.error);
      errEl.textContent = '‚ùå ' + (result.error.message || '–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
      errEl.style.display = 'block';
      document.getElementById('regBtnText').textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
      return;
    }
    
    // Success! Send approval request for CEO
    try { await selfRegister({ staffId: newId, name, phone, username, email:'', role:'–ú–µ–Ω–µ–¥–∂–µ—Ä', project, telegram_id:'' }); } catch(e2) { console.warn('Approval request failed:', e2); }
    
    // Show pending approval message (no auto-login ‚Äî CEO must approve first)
    errEl.style.display = 'block';
    errEl.style.color = 'var(--green)';
    errEl.textContent = '‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º.';
    document.getElementById('regBtnText').textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
    setTimeout(() => showAuthTab('login'), 3000);
    
  } catch(e) {
    console.error('Register error:', e);
    errEl.textContent = '‚ùå ' + (e.message||'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
    errEl.style.display = 'block';
    document.getElementById('regBtnText').textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
  }
}

// ---- TELEGRAM LOGIN ----
function doTelegramLogin() {
  const botName = CONFIG.TG_BOT || 'AIhroject_bot';
  
  // Show TG login modal inline
  const container = document.getElementById('authLogin').style.display !== 'none' 
    ? document.getElementById('authLogin') 
    : document.getElementById('authRegister');
  
  // Replace current form with TG flow
  const prevHTML = container.innerHTML;
  container.innerHTML = `
    <div style="text-align:center">
      <div style="font-size:48px;margin-bottom:12px">üí¨</div>
      <div style="font-size:15px;font-weight:600;margin-bottom:8px">–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.5">
        1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ <b>@${botName}</b><br>
        2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É <code>/login</code><br>
        3. –ë–æ—Ç –ø—Ä–∏—à–ª—ë—Ç –∫–æ–¥ ‚Äî –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ
      </div>
      <a href="https://t.me/${botName}?start=login" target="_blank" class="tg-login-btn" style="margin-bottom:14px;text-decoration:none">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.94 8.13l-1.97 9.28c-.15.67-.54.83-1.09.52l-3.02-2.23-1.45 1.4c-.16.16-.3.3-.61.3l.22-3.05 5.55-5.02c.24-.22-.05-.33-.37-.13l-6.87 4.33-2.96-.92c-.64-.2-.66-.64.13-.95l11.57-4.46c.54-.2 1.01.13.83.93z"/></svg>
        –û—Ç–∫—Ä—ã—Ç—å @${botName}
      </a>
      <input class="login-input" id="tgCodeInput" type="text" placeholder="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –±–æ—Ç–∞" style="text-align:center;font-size:18px;letter-spacing:6px" maxlength="6" onkeydown="if(event.key==='Enter')verifyTgCode()">
      <button class="login-btn" style="margin-top:10px" onclick="verifyTgCode()">
        <span id="tgVerifyBtnText">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
      </button>
      <div class="login-error" id="tgError"></div>
      <div style="margin-top:14px">
        <a href="#" onclick="cancelTgLogin();return false" style="color:var(--text3);font-size:12px">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—ã—á–Ω–æ–º—É –≤—Ö–æ–¥—É</a>
      </div>
    </div>
  `;
  container._prevHTML = prevHTML;
}

function cancelTgLogin() {
  const loginDiv = document.getElementById('authLogin');
  const regDiv = document.getElementById('authRegister');
  if (loginDiv._prevHTML) { loginDiv.innerHTML = loginDiv._prevHTML; delete loginDiv._prevHTML; }
  if (regDiv._prevHTML) { regDiv.innerHTML = regDiv._prevHTML; delete regDiv._prevHTML; }
  // If nothing restored, just reload page
  if (!loginDiv.innerHTML.includes('loginId')) location.reload();
}

async function verifyTgCode() {
  const code = (document.getElementById('tgCodeInput')?.value||'').trim();
  const errEl = document.getElementById('tgError');
  if (!code) { errEl.textContent='–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –±–æ—Ç–∞'; errEl.style.display='block'; return; }
  
  document.getElementById('tgVerifyBtnText').textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
  errEl.style.display = 'none';
  
  try {
    if (!_staffCache.length) await loadStaffCache();
    
    let staff = null;
    
    // 1) Try as auth token from tg_auth_tokens (primary method)
    try {
      const { data } = await SB.from('tg_auth_tokens').select('*').eq('token', code).single();
      if (data) {
        // Check expiry (5 min)
        const created = new Date(data.created_at).getTime();
        if (Date.now() - created > 5 * 60 * 1000) {
          await SB.from('tg_auth_tokens').delete().eq('token', code).catch(()=>{});
          errEl.textContent = '‚ùå –ö–æ–¥ –∏—Å—Ç—ë–∫. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /login –≤ –±–æ—Ç–µ –∑–∞–Ω–æ–≤–æ.';
          errEl.style.display = 'block';
          document.getElementById('tgVerifyBtnText').textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
          return;
        }
        if (data.staff_id) {
          staff = _staffCache.find(s => (s.ID||s.id) === data.staff_id);
        } else if (data.telegram_id) {
          staff = _staffCache.find(s => String(s.Telegram_ID||s.telegram_id||'').trim() === String(data.telegram_id));
        }
        // Delete used token (one-time)
        await SB.from('tg_auth_tokens').delete().eq('token', code).catch(()=>{});
      }
    } catch(e) { /* table may not exist */ }
    
    // 2) Fallback: try as Telegram ID (numeric, for backward compat)
    if (!staff && /^\d{5,}$/.test(code)) {
      staff = _staffCache.find(s => String(s.Telegram_ID||s.telegram_id||'').trim() === code);
    }
    
    // 3) Try as @username
    if (!staff && code.startsWith('@')) {
      const uname = code.slice(1).toLowerCase();
      staff = _staffCache.find(s => (s['Username']||s.username||'').toLowerCase().replace('@','') === uname);
    }
    
    if (staff) {
      errEl.style.color = 'var(--green)';
      errEl.textContent = '‚úÖ –ù–∞–π–¥–µ–Ω: ' + (staff['–ò–º—è']||staff.name||'') + '. –í—Ö–æ–¥–∏–º...';
      errEl.style.display = 'block';
      setTimeout(() => { cancelTgLogin(); completeLogin(staff); }, 600);
    } else {
      errEl.textContent = '‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /login –≤ –±–æ—Ç–µ.';
      errEl.style.display = 'block';
      document.getElementById('tgVerifyBtnText').textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    }
  } catch(e) {
    errEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
    errEl.style.display = 'block';
    document.getElementById('tgVerifyBtnText').textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
  }
}

// ---- FORGOT PASSWORD ----
async function doForgotPass() {
  const id = document.getElementById('forgotId').value.trim();
  const errEl = document.getElementById('forgotError');
  errEl.style.display = 'none';
  
  if (!id) { errEl.textContent='–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ @—Ç–µ–≥'; errEl.style.display='block'; return; }
  
  document.getElementById('forgotBtnText').textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
  
  try {
    if (!_staffCache.length) await loadStaffCache();
    const staff = findStaffByInput(id);
    
    if (!staff) {
      errEl.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
      errEl.style.display = 'block';
      document.getElementById('forgotBtnText').textContent = '–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å';
      return;
    }
    
    // Generate temp password
    const tempPass = Math.random().toString(36).slice(2,8).toUpperCase();
    const hash = await hashPassword(tempPass);
    
    // Save new password hash
    await SB.from('staff').update({ pin_hash: hash }).eq('id', staff.ID||staff.id);
    
    // Try to send via Telegram bot (through n8n webhook)
    const tgId = staff.Telegram_ID || staff['Telegram_ID'] || staff.telegram_id;
    if (tgId) {
      try {
        await sendTelegramNotification(tgId, 'üîë –í–∞—à –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è RKT HUB:\n\n`' + tempPass + '`\n\n–°–º–µ–Ω–∏—Ç–µ –µ–≥–æ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –ü—Ä–æ—Ñ–∏–ª—å.');
        errEl.style.color = 'var(--green)';
        errEl.textContent = '‚úÖ –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!';
      } catch(e) {
        errEl.style.color = 'var(--orange)';
        errEl.textContent = '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ TG. –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: ' + tempPass;
      }
    } else {
      // No TG ‚Äî show password directly
      errEl.style.color = 'var(--orange)';
      errEl.textContent = '‚ö†Ô∏è Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω. –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: ' + tempPass;
    }
    errEl.style.display = 'block';
    document.getElementById('forgotBtnText').textContent = '–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å';
    
  } catch(e) {
    errEl.textContent = '‚ùå –û—à–∏–±–∫–∞: '+e.message;
    errEl.style.display = 'block';
    document.getElementById('forgotBtnText').textContent = '–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å';
  }
}

// ---- COMPLETE LOGIN ----
function completeLogin(staff) {
  const staffProject = (staff['–ü—Ä–æ–µ–∫—Ç'] || staff.project || '').trim();
  const staffDirection = (staff['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || staff.direction || '').trim();
  USER = {
    id: staff.ID || staff.id || '', tgId: String(staff.Telegram_ID || staff.telegram_id || '').trim(),
    name: (staff['–ò–º—è'] || staff.name || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫').trim(),
    role: normalizeRole(staff['–†–æ–ª—å'] || staff.role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'),
    originalRole: (staff['–†–æ–ª—å'] || staff.role || '').trim(),
    direction: staffDirection || '–í—Å–µ',
    project: staffProject,
    email: (staff['Email'] || staff.email || '').trim(),
    phone: (staff['–¢–µ–ª–µ—Ñ–æ–Ω'] || staff.phone || '').trim(),
    username: (staff['Username'] || staff.username || '').trim()
  };
  console.log('[RKT] completeLogin:', USER.name, '| role:', USER.role, '| project:', USER.project, '| direction:', USER.direction);
  localStorage.setItem('rkt_user', JSON.stringify(USER));
  showApp();
}

function doLogout() {
  USER=null; localStorage.removeItem('rkt_user');
  if(refreshTimer) clearInterval(refreshTimer);
  if(window._tgPollInterval) clearInterval(window._tgPollInterval);
  document.getElementById('mainApp').style.display='none';
  document.getElementById('loginScreen').style.display='flex';
  showAuthTab('login');
  document.getElementById('loginId').value='';
  document.getElementById('loginPass').value='';
  document.getElementById('loginError').style.display='none';
}


function showApp() {
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('mainApp').style.display='flex';
  const p = getUserPerms();
  document.getElementById('userName').textContent = USER.name;
  document.getElementById('userRoleText').textContent = p.emoji+' '+USER.role;
  document.getElementById('userAvatar').textContent = USER.name.charAt(0).toUpperCase();
  document.getElementById('settingsApiUrl').value = CONFIG.SUPABASE_URL;
  document.getElementById('settingsAiUrl').value = CONFIG.AI_URL;
  document.getElementById('settingsTgBot').value = CONFIG.TG_BOT || '';
  document.getElementById('settingsTgToken').value = CONFIG.TG_BOT_TOKEN || '';
  const groqEl = document.getElementById('settingsGroqKey');
  const geminiEl = document.getElementById('settingsGeminiKey');
  if (groqEl) groqEl.value = CONFIG.GROQ_KEY || '';
  if (geminiEl) geminiEl.value = CONFIG.GEMINI_KEY || '';
  const ghTokenEl = document.getElementById('settingsGithubToken');
  const ghRepoEl = document.getElementById('settingsGithubRepo');
  if (ghTokenEl) ghTokenEl.value = localStorage.getItem('github_token') || '';
  if (ghRepoEl) ghRepoEl.value = CONFIG.GITHUB_REPO || '';
  document.getElementById('s-name').textContent = USER.name;
  document.getElementById('s-role').textContent = p.emoji+' '+USER.role;
  document.getElementById('s-dir').textContent = USER.direction;
  document.getElementById('s-tgid').textContent = USER.username ? '@'+USER.username.replace('@','') : (USER.tgId||'‚Äî');
  document.getElementById('s-phone').textContent = USER.phone || '‚Äî';
  document.getElementById('btn-add-staff').style.display = p.canManageStaff?'':'none';
  
  // ROLE-BASED NAV VISIBILITY
  document.getElementById('nav-approvals').classList.toggle('hidden', !p.canApprove);
  // Settings ‚Äî only CEO
  const navSettings = document.querySelector('[data-page="settings"]');
  if (navSettings) navSettings.classList.toggle('hidden', USER.role !== 'CEO');
  const navAdmin = document.querySelector('[data-page="admin"]');
  if (navAdmin) navAdmin.classList.toggle('hidden', USER.role !== 'CEO');
  // Partners ‚Äî only CEO and –ó–∞–º
  const navPartners = document.querySelector('[data-page="partners"]');
  if (navPartners) navPartners.classList.toggle('hidden', p.level < 3);
  // Staff ‚Äî only CEO and –ó–∞–º
  const navStaff = document.querySelector('[data-page="staff"]');
  if (navStaff) navStaff.classList.toggle('hidden', !p.canManageStaff);
  // Comms ‚Äî hide for basic –°–æ—Ç—Ä—É–¥–Ω–∏–∫
  const navComms = document.querySelector('[data-page="comms"]');
  if (navComms) navComms.classList.toggle('hidden', p.level < 1);
  
  loadData();
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadData, CONFIG.REFRESH);
  updateStatusTime(); setInterval(updateStatusTime, 60000);
  startDeadlineChecks();
  
  // Restore navigation state after page refresh (within 24h)
  try {
    const nav = JSON.parse(localStorage.getItem('rkt_nav') || 'null');
    if (nav && nav.page && (Date.now() - nav.ts < 86400000)) {
      setTimeout(() => {
        if ((nav.page === 'project' || nav.page === 'subproject') && nav.project) {
          openProject(nav.project);
          if (nav.subproject) { setTimeout(() => openSubproject(nav.subproject), 150); }
        } else if (nav.page !== 'home') {
          showPage(nav.page);
        }
      }, 400);
    }
  } catch(e) {}
  
  // Supabase Realtime ‚Äî auto-reload on changes (deduplicated, debounced)
  SB.channel('rkt-hub-changes')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'tasks' }, (payload) => {
      var t = payload.new || {};
      addNotification('–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞: ' + (t.description || t['–û–ø–∏—Å–∞–Ω–∏–µ'] || '–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'), 'task');
      debouncedLoadData();
    })
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'tasks' }, () => debouncedLoadData())
    .on('postgres_changes', { event: '*', schema: 'public', table: 'directions' }, (payload) => {
      if (payload.eventType === 'INSERT') addNotification('–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –≤ –≤–æ—Ä–æ–Ω–∫–µ', 'deal');
      debouncedLoadData();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'approvals' }, (payload) => {
      if (payload.eventType === 'INSERT') addNotification('–ù–æ–≤–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ', 'approval');
      debouncedLoadData();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'staff' }, () => debouncedLoadData())
    .on('postgres_changes', { event: '*', schema: 'public', table: 'partners' }, () => debouncedLoadData())
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'client_requests' }, (payload) => {
      var r = payload.new || {};
      addNotification('üìã –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞!', (r.name || '–ö–ª–∏–µ–Ω—Ç') + ' ‚Äî ' + (r.direction || '') + ' ‚Äî ' + (r.phone || ''), 'lead');
      toast('üìã –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ' + (r.name || '–∫–ª–∏–µ–Ω—Ç–∞') + (r.direction ? ' (' + r.direction + ')' : ''), 'info');
      if (typeof adminLoadLeads === 'function') adminLoadLeads();
    })
    .subscribe();

  // Onboarding for first-time users
  setTimeout(checkOnboarding, 800);
}

// ============================================================
// DATA
// ============================================================
function normData(d) {
  const staffArr = Array.isArray(d.staff)?d.staff:[];
  // Normalize roles and filter out template/placeholder rows
  const cleanStaff = staffArr
    .filter(s => s['–ò–º—è'] && !['–§–ò–û','–ò–º—è','–§–∞–º–∏–ª–∏—è','–ü—Ä–∏–º–µ—Ä'].includes(s['–ò–º—è']))
    .map(s => { if(s['–†–æ–ª—å']) s['–†–æ–ª—å'] = normalizeRole(s['–†–æ–ª—å']); return s; });
  return {
    partners: (Array.isArray(d.partners)?d.partners:[]).filter(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ'] && !['–ù–∞–∑–≤–∞–Ω–∏–µ','–ü—Ä–∏–º–µ—Ä'].includes(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])),
    tasks: (Array.isArray(d.tasks)?d.tasks:[]).filter(t => t['–û–ø–∏—Å–∞–Ω–∏–µ'] && !['–û–ø–∏—Å–∞–Ω–∏–µ','–ü—Ä–∏–º–µ—Ä'].includes(t['–û–ø–∏—Å–∞–Ω–∏–µ'])),
    directions: Array.isArray(d.directions)?d.directions:[],
    staff: cleanStaff,
    projects: Array.isArray(d.projects)?d.projects:[],
    approvals: Array.isArray(d.approvals)?d.approvals:[],
    comms: Array.isArray(d.comms)?d.comms:[],
    documents: Array.isArray(d.documents)?d.documents:[]
  };
}

async function loadData() {
  _filterCache.clear();
  _filterCacheVersion++;
  setStatus('loading');
  try {
    const [staff, partners, tasks, directions, projects, approvals, comms, docs] = await Promise.all([
      SB.from('staff').select('*'),
      SB.from('partners').select('*'),
      SB.from('tasks').select('*'),
      SB.from('directions').select('*'),
      SB.from('projects').select('*'),
      SB.from('approvals').select('*'),
      SB.from('communications').select('*'),
      SB.from('documents').select('*')
    ]);
    
    DATA = normData({
      staff: mapFromDb('staff', staff.data || []),
      partners: mapFromDb('partners', partners.data || []),
      tasks: mapFromDb('tasks', tasks.data || []),
      directions: mapFromDb('directions', directions.data || []),
      projects: mapFromDb('projects', projects.data || []),
      approvals: mapFromDb('approvals', approvals.data || []),
      comms: mapFromDb('communications', comms.data || []),
      documents: mapFromDb('documents', docs.data || [])
    });
    // Sync USER from fresh DB data (role/project may have changed by CEO)
    if (USER && USER.id) {
      const freshStaff = (DATA.staff||[]).find(s => (s.ID||s.id) === USER.id);
      if (freshStaff) {
        const newRole = normalizeRole(freshStaff['–†–æ–ª—å'] || freshStaff.role || USER.role);
        const newProject = (freshStaff['–ü—Ä–æ–µ–∫—Ç'] || freshStaff.project || USER.project || '').trim();
        const newDir = (freshStaff['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || freshStaff.direction || USER.direction || '').trim();
        const newName = (freshStaff['–ò–º—è'] || freshStaff.name || USER.name).trim();
        if (newRole !== USER.role || newProject !== USER.project || newDir !== USER.direction || newName !== USER.name) {
          USER.role = newRole;
          USER.project = newProject;
          USER.direction = newDir || '–í—Å–µ';
          USER.name = newName;
          localStorage.setItem('rkt_user', JSON.stringify(USER));
          // Update sidebar display
          const p = getUserPerms();
          const nameEl = document.getElementById('userName');
          const roleEl = document.getElementById('userRoleText');
          if (nameEl) nameEl.textContent = USER.name;
          if (roleEl) roleEl.textContent = p.emoji + ' ' + USER.role;
          const avatarEl = document.getElementById('userAvatar');
          if (avatarEl) avatarEl.textContent = USER.name.charAt(0).toUpperCase();
          console.log('[RKT] USER synced from DB:', USER.name, USER.role, USER.project);
        }
      }
    }
    renderAll();
    setStatus('connected');
  } catch(e) {
    console.error('loadData error:', e);
    setStatus('error');
    toast('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.','error');
  }
}

async function apiWrite(sheet, row, action) {
  try {
    const table = tableForSheet(sheet);
    const dbRow = mapToDb(table, row);
    
    // Ensure ID
    if (!dbRow.id && row.ID) dbRow.id = row.ID;
    if (!dbRow.id) dbRow.id = genId(table.charAt(0).toUpperCase());
    
    if (action === 'delete') {
      const { error } = await SB.from(table).delete().eq('id', dbRow.id);
      if (error) throw error;
    } else if (dbRow.id && action === 'update') {
      const id = dbRow.id;
      delete dbRow.id;
      const { error } = await SB.from(table).update(dbRow).eq('id', id);
      if (error) throw error;
    } else {
      // Upsert: insert or update by id
      const { error } = await SB.from(table).upsert(dbRow, { onConflict: 'id' });
      if (error) throw error;
    }
    return true;
  } catch(e) {
    console.error('apiWrite error:', e);
    toast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.','error');
    return false;
  }
}

function genId(prefix) {
  return (prefix||'X') + Date.now().toString(36).toUpperCase();
}

// ============================================================
// FILTERING
// ============================================================
function filterByRole(arr) {
  // Cache: same array reference ‚Üí same result within one render cycle
  const cacheKey = arr;
  if (_filterCache.has(cacheKey)) return _filterCache.get(cacheKey);

  const p = getUserPerms();
  if (p.seeAll || !USER) { _filterCache.set(cacheKey, arr); return arr; }

  // Determine user's project key
  const userProjKey = getUserProjectKey();
  const userName = (USER.name || USER['–ò–º—è'] || '').trim();
  const userDir = (USER.direction || USER['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').trim();
  const userProj = (USER.project || USER['–ü—Ä–æ–µ–∫—Ç'] || '').trim();

  // If user has no specific project/direction restriction
  if (!userProjKey && (userDir === '–í—Å–µ' || !userDir)) {
    // Only CEO-level (seeAll) should see everything ‚Äî already handled above
    // For others with level >= 2: show everything in their project (fallback)
    if (p.level >= 2 && userProj) {
      // High-level user without detected project key ‚Äî still try to show project data
      const result = arr.filter(i => {
        const d = i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
        const proj = i['–ü—Ä–æ–µ–∫—Ç'] || '';
        if (proj === userProj || d === userProj) return true;
        if (userName && (i['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(userName)) return true;
        return false;
      });
      _filterCache.set(cacheKey, result);
      return result;
    }
    // For others: show only items assigned to them
    const result = arr.filter(i => userName && (i['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(userName));
    _filterCache.set(cacheKey, result);
    return result;
  }

  // Build list of all directions this user can see
  const myDirs = new Set(['–í—Å–µ', '–û–±—â–µ–µ', '']);
  if (userDir && userDir !== '–í—Å–µ') myDirs.add(userDir);
  if (userProj) myDirs.add(userProj);

  // –ó–∞–º/–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å: see all directions in their project
  if (p.level >= 2 && userProjKey) {
    getProjectDirs(userProjKey).forEach(d => myDirs.add(d));
    myDirs.add(PROJECTS[userProjKey].name);
  }

  // Also check extra_projects
  if (userName) {
    const myStaff = (DATA.staff || []).find(s => s['–ò–º—è'] === userName);
    if (myStaff) {
      try {
        const extra = JSON.parse(myStaff['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] || '[]');
        if (Array.isArray(extra)) {
          extra.forEach(ep => {
            myDirs.add(ep);
            const epKey = Object.keys(PROJECTS).find(k => PROJECTS[k].name === ep);
            if (epKey) getProjectDirs(epKey).forEach(d => myDirs.add(d));
          });
        }
      } catch(e) {}
    }
  }

  const result = arr.filter(i => {
    const d = i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
    const proj = i['–ü—Ä–æ–µ–∫—Ç'] || '';
    if (myDirs.has(d) || myDirs.has(proj)) return true;
    // All levels can see items assigned to them
    if (userName && (i['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(userName)) return true;
    return false;
  });
  _filterCache.set(cacheKey, result);
  return result;
}

// Find which PROJECTS key this user belongs to
function getUserProjectKey() {
  if (!USER) return null;

  // Gather all possible project/direction values (from both key styles)
  const userProject = (USER.project || USER['–ü—Ä–æ–µ–∫—Ç'] || '').trim();
  const userDirection = (USER.direction || USER['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').trim();
  const userOrigRole = (USER.originalRole || USER.role || '').trim();

  // 1. Check explicit project field
  if (userProject && userProject !== '–í—Å–µ') {
    // Match against project names
    const byName = Object.keys(PROJECTS).find(k => PROJECTS[k].name === userProject);
    if (byName) return byName;
    // Match against project keys directly
    if (PROJECTS[userProject]) return userProject;
    // Fuzzy match (case-insensitive, trimmed)
    const projLower = userProject.toLowerCase();
    const byNameLower = Object.keys(PROJECTS).find(k => PROJECTS[k].name.toLowerCase().trim() === projLower);
    if (byNameLower) return byNameLower;
  }

  // 2. Check direction ‚Üí which project has this as subproject
  if (userDirection && userDirection !== '–í—Å–µ') {
    // Direct match against project names (e.g. direction='–°–∞–π—Ç—ã')
    const byProjName = Object.keys(PROJECTS).find(k => PROJECTS[k].name === userDirection);
    if (byProjName) return byProjName;
    // Match against subproject names
    const byDir = Object.keys(PROJECTS).find(k => {
      return getProjectDirs(k).includes(userDirection);
    });
    if (byDir) return byDir;
    // Fuzzy match on direction
    const dirLower = userDirection.toLowerCase();
    const byDirFuzzy = Object.keys(PROJECTS).find(k => {
      if (PROJECTS[k].name.toLowerCase().trim() === dirLower) return true;
      return getProjectDirs(k).some(d => d.toLowerCase().trim() === dirLower);
    });
    if (byDirFuzzy) return byDirFuzzy;
  }

  // 3. Check role name for project hints (e.g. "–ó–∞–º –ø–æ –°–∞–π—Ç–∞–º")
  if (userOrigRole) {
    const roleLower = userOrigRole.toLowerCase();
    for (const [k, proj] of Object.entries(PROJECTS)) {
      if (roleLower.includes(proj.name.toLowerCase())) return k;
    }
  }

  // 4. Check DB staff record for project field (handles mapFromDb inconsistencies)
  if (USER.name) {
    const myStaff = (DATA.staff || []).find(s => s['–ò–º—è'] === USER.name || s.name === USER.name);
    if (myStaff) {
      const staffProject = (myStaff['–ü—Ä–æ–µ–∫—Ç'] || myStaff.project || '').trim();
      if (staffProject && staffProject !== '–í—Å–µ') {
        const byStaff = Object.keys(PROJECTS).find(k => PROJECTS[k].name === staffProject);
        if (byStaff) {
          // Also fix USER object for future calls
          USER.project = staffProject;
          return byStaff;
        }
      }
      // Check extra_projects
      try {
        const extra = JSON.parse(myStaff['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] || '[]');
        if (Array.isArray(extra) && extra.length > 0) {
          for (const ep of extra) {
            const byExtra = Object.keys(PROJECTS).find(k => PROJECTS[k].name === ep);
            if (byExtra) return byExtra;
          }
        }
      } catch(e) {}
    }
  }

  console.warn('[RKT] getUserProjectKey: could not determine project for', USER.name, '| project:', userProject, '| direction:', userDirection, '| role:', userOrigRole);
  return null; // Can't determine ‚Üí secure fallback
}

function filterBySearch(arr, sid, fields) {
  const e = document.getElementById(sid);
  if(!e) return arr;
  const q = e.value.toLowerCase().trim();
  if(!q) return arr;
  return arr.filter(i => fields.some(f => (i[f]||'').toLowerCase().includes(q)));
}

function filterByDir(arr, dir) {
  if(!dir||dir==='–í—Å–µ') return arr;
  return arr.filter(i => (i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').includes(dir));
}

// Which top-level project does a direction belong to?
function dirToProject(dir) {
  for (const [key, proj] of Object.entries(PROJECTS)) {
    if (proj.subprojects[dir]) return key;
  }
  return null;
}

// Get all direction names for a top-level project
function getProjectDirs(projKey) {
  const p = PROJECTS[projKey];
  return p ? Object.keys(p.subprojects) : [];
}

// Filter data by top-level project (all its subproject directions)
function filterByProject(arr, projKey) {
  const dirs = getProjectDirs(projKey);
  return arr.filter(i => {
    const dir = i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
    const proj = i['–ü—Ä–æ–µ–∫—Ç'] || '';
    // Match by direction belonging to this project
    if (dirs.includes(dir)) return true;
    // Match by explicit –ü—Ä–æ–µ–∫—Ç field
    const projName = PROJECTS[projKey] ? PROJECTS[projKey].name : '';
    if (proj === projName || proj === projKey) return true;
    return false;
  });
}

// ============================================================
// NAVIGATION
// ============================================================
function showPage(page) {
  if (page === 'kanban') { renderKanban(); }
  if (page === 'admin') { adminRefresh(); }
  if (page === 'clients') { renderClientsPage(); }
  if (page === 'leads') { renderLeadsPage(); }
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item[data-page]').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.nav-project-header').forEach(n => n.classList.remove('active'));
  const pe = document.getElementById('page-'+page);
  const ne = document.querySelector('.nav > [data-page="'+page+'"]');
  if(pe) pe.classList.add('active');
  if(ne) ne.classList.add('active');
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar').classList.remove('mobile-open');
  var ov = document.getElementById('mobileOverlay'); if (ov) ov.classList.remove('show');
  if(page==='home') { currentProject=null; currentSubproject=null; sidebarExpandedProject=null; }
  // –°–±—Ä–æ—Å –ø—Ä–æ–µ–∫—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  if (page !== 'project' && page !== 'subproject') {
    document.querySelectorAll('.nav-project-header').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.nav-sub .nav-item').forEach(n => n.classList.remove('active'));
  }
  // Lazy render: render the page we're switching to
  renderAll();
  // Update sidebar projects
  if (typeof renderSidebarProjects === 'function') renderSidebarProjects();
  // Save nav state for page refresh persistence
  try { localStorage.setItem('rkt_nav', JSON.stringify({ page, project: currentProject, subproject: currentSubproject, ts: Date.now() })); } catch(e){}
}

function toggleSidebar() {
  var sb = document.getElementById('sidebar') || document.querySelector('.sidebar');
  var overlay = document.getElementById('mobileOverlay');
  if (sb) { sb.classList.toggle('open'); sb.classList.toggle('mobile-open'); }
  if (overlay) overlay.classList.toggle('show');
}

// –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Å–∞–π–¥–±–∞—Ä–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
function toggleSidebarCollapse() {
  var sb = document.querySelector('.sidebar');
  if (!sb) return;
  sb.classList.toggle('collapsed');
  localStorage.setItem('sidebar_collapsed', sb.classList.contains('collapsed') ? '1' : '0');
}
// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å collapsed –∏–∑ localStorage
(function() {
  if (localStorage.getItem('sidebar_collapsed') === '1') {
    var sb = document.querySelector('.sidebar');
    if (sb) sb.classList.add('collapsed');
  }
})();

// ============================================================
// SIDEBAR PROJECTS ‚Äî Dynamic sub-navigation
// ============================================================
var sidebarExpandedProject = null;

const PROJECT_ICONS = { rkt: 'üè•', sites: 'üåê', content: 'üé¨', ai: 'ü§ñ' };

const PROJECT_TABS_CRM = [
  { key: 'overview', icon: 'üìä', label: '–û–±–∑–æ—Ä' },
  { key: 'pipeline', icon: 'üéØ', label: '–í–æ—Ä–æ–Ω–∫–∞' },
  { key: 'clients', icon: 'üë•', label: '–ö–ª–∏–µ–Ω—Ç—ã' },
  { key: 'tasks', icon: '‚úÖ', label: '–ó–∞–¥–∞—á–∏' },
  { key: 'team', icon: 'üë§', label: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏' },
  { key: 'finance', icon: 'üí∞', label: '–§–∏–Ω–∞–Ω—Å—ã' }
];

const PROJECT_TABS_STD = [
  { key: 'overview', icon: 'üìä', label: '–û–±–∑–æ—Ä' },
  { key: 'tasks', icon: '‚úÖ', label: '–ó–∞–¥–∞—á–∏' },
  { key: 'partners', icon: 'ü§ù', label: '–ü–∞—Ä—Ç–Ω—ë—Ä—ã' },
  { key: 'team', icon: 'üë§', label: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏' }
];

function renderSidebarProjects() {
  var el = document.getElementById('sidebarProjectsList');
  if (!el) return;
  var html = '';
  var projKeys = Object.keys(PROJECTS || {});

  projKeys.forEach(function(key) {
    var p = PROJECTS[key];
    var icon = PROJECT_ICONS[key] || 'üìÅ';
    var name = p.name || key;
    var isOpen = sidebarExpandedProject === key;
    var isActive = currentProject === key;
    var isCRM = !!p.canAddSub;
    var tabs = isCRM ? PROJECT_TABS_CRM : PROJECT_TABS_STD;

    html += '<div class="nav-project">';
    html += '<div class="nav-project-header' + (isActive ? ' active' : '') + (isOpen ? ' open' : '') + '" onclick="toggleSidebarProject(\'' + key + '\')">';
    html += '<span class="icon">' + icon + '</span>';
    html += '<span class="label">' + name + '</span>';
    html += '<span class="arrow">‚ñ∏</span>';
    html += '</div>';
    html += '<div class="nav-sub' + (isOpen ? ' open' : '') + '">';

    tabs.forEach(function(tab) {
      var tabActive = isActive && currentPvTab === tab.key;
      html += '<a class="nav-item' + (tabActive ? ' active' : '') + '" onclick="openProjectTab(\'' + key + '\',\'' + tab.key + '\')">';
      html += '<span class="icon">' + tab.icon + '</span><span class="label">' + tab.label + '</span>';
      html += '</a>';
    });

    html += '</div></div>';
  });

  el.innerHTML = html;
}

function toggleSidebarProject(projKey) {
  if (sidebarExpandedProject === projKey) {
    sidebarExpandedProject = null;
  } else {
    sidebarExpandedProject = projKey;
  }
  renderSidebarProjects();
}

function openProjectTab(projKey, tab) {
  sidebarExpandedProject = projKey;
  currentProject = projKey;
  currentSubproject = null;

  // –ú–∞–ø–ø–∏–Ω–≥ –≤–∫–ª–∞–¥–æ–∫ –∫ existingPvTabs
  var tabMap = {
    'overview': 'overview',
    'pipeline': 'pipeline',     // —Å–≤–æ—è –≤–∫–ª–∞–¥–∫–∞ –≤–æ—Ä–æ–Ω–∫–∏
    'clients': 'clients',       // —Å–≤–æ—è –≤–∫–ª–∞–¥–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
    'tasks': 'tasks',
    'team': 'staff',            // renderProjectView –æ–∂–∏–¥–∞–µ—Ç 'staff'
    'finance': 'finance',
    'partners': 'partners'
  };

  currentPvTab = tabMap[tab] || tab;
  showPage('project');

  // –û–±–Ω–æ–≤–∏—Ç—å —Å–∞–π–¥–±–∞—Ä
  renderSidebarProjects();

  // –ó–∞–∫—Ä—ã—Ç—å –º–æ–±–∏–ª—å–Ω—ã–π —Å–∞–π–¥–±–∞—Ä
  document.getElementById('sidebar').classList.remove('open','mobile-open');
  var ov = document.getElementById('mobileOverlay'); if(ov) ov.classList.remove('show');
}

function openProject(projKey) {
  sidebarExpandedProject = projKey;
  currentProject = projKey;
  currentSubproject = null;
  currentPvTab = 'overview';
  showPage('project');
  renderSidebarProjects();
  
  // FIX 8: Hide partner elements in –°–∞–π—Ç—ã project
  const isCRM = !!(PROJECTS[projKey] && PROJECTS[projKey].canAddSub);
  const pvPartnerBtn = document.querySelector('#page-project .actions [onclick*="partner"]');
  if (pvPartnerBtn) pvPartnerBtn.style.display = isCRM ? 'none' : '';
  const pvPartnerTab = document.querySelector('#pv-tabs [data-tab="partners"]');
  if (pvPartnerTab) pvPartnerTab.style.display = isCRM ? 'none' : '';
  // Show finance/salaries tabs in –°–∞–π—Ç—ã
  document.querySelectorAll('.tab-finance, .tab-salaries').forEach(t => t.style.display = isCRM ? '' : 'none');
  // Show pipeline/clients tabs only for CRM projects
  var pipeTab = document.querySelector('#pv-tabs [data-tab="pipeline"]');
  var clientsTab = document.querySelector('#pv-tabs [data-tab="clients"]');
  if (pipeTab) pipeTab.style.display = isCRM ? '' : 'none';
  if (clientsTab) clientsTab.style.display = isCRM ? '' : 'none';

  renderProjectView();
}

function openSubproject(spName) {
  currentSubproject = spName;
  currentSpTab = 'overview';
  showPage('subproject');
  const isCRM = !!(PROJECTS[currentProject] && PROJECTS[currentProject].canAddSub);
  const dir = isCRM ? (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === spName && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã')) : null;
  
  // === CONFIGURE TABS ===
  const tabs = {
    'overview': true,
    'tasks': true,
    'client-info': isCRM,
    'partners': !isCRM,
    'projects': !isCRM,
    'comms': !isCRM,
    'files': true,
    'sitegen': isCRM
  };
  document.querySelectorAll('#sp-tabs .tab').forEach(t => {
    const tab = t.getAttribute('data-tab');
    t.style.display = (tabs[tab] !== undefined ? tabs[tab] : true) ? '' : 'none';
  });
  
  // === CONFIGURE ACTION BUTTONS ===
  const actionsEl = document.getElementById('sp-actions');
  if (isCRM && dir) {
    const phone = dir['–¢–µ–ª–µ—Ñ–æ–Ω'] || '';
    const cleanPhone = phone.replace(/[^\d+]/g, '');
    const eid = escA(dir['ID']||dir.id||'');
    actionsEl.innerHTML = 
      (phone ? '<a href="tel:'+esc(cleanPhone)+'" class="btn btn-primary" style="text-decoration:none">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>' +
               '<a href="https://t.me/'+esc(cleanPhone.replace('+',''))+'" target="_blank" class="btn btn-secondary" style="text-decoration:none">üí¨ Telegram</a>' : '') +
      '<button class="btn btn-secondary" onclick="openModal(\'task\')">+ –ó–∞–¥–∞—á–∞</button>';
  } else {
    actionsEl.innerHTML = 
      '<button class="btn btn-primary" onclick="openModal(\'task\')">+ –ó–∞–¥–∞—á–∞</button>' +
      '<button class="btn btn-primary" onclick="openModal(\'partner\')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>' +
      '<button class="btn btn-secondary" onclick="openModal(\'comm\')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>';
  }
  
  // === CLIENT QUICK-INFO BAR (–°–∞–π—Ç—ã only) ===
  const clientBar = document.getElementById('sp-client-bar');
  if (isCRM && dir) {
    const stage = dir['stage']||'prospect';
    const stObj = STAGES.find(s=>s.id===stage)||STAGES[0];
    const stIdx = STAGES.findIndex(s=>s.id===stage);
    const price = Number(dir['–¶–µ–Ω–∞'])||0;
    const paid = !!dir['–û–ø–ª–∞—á–µ–Ω–æ'];
    
    clientBar.style.display = 'block';
    clientBar.innerHTML = '<div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;margin-bottom:12px;flex-wrap:wrap">' +
      // Stage stepper
      '<div style="display:flex;align-items:center;gap:2px;flex:1;min-width:300px">' +
      STAGES.map((s,i) => {
        const done = i < stIdx;
        const cur = i === stIdx;
        const bg = done ? 'var(--green)' : cur ? stObj.color : 'var(--bg4)';
        const txt = done || cur ? '#fff' : 'var(--text3)';
        return '<div style="flex:1;height:6px;border-radius:3px;background:'+bg+';position:relative" title="'+s.name+'">' +
          (cur ? '<div style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:10px;white-space:nowrap;color:'+stObj.color+';font-weight:700">'+s.name+'</div>' : '') +
          '</div>';
      }).join('') +
      '</div>' +
      // Key info chips
      '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">' +
        '<span style="background:'+stObj.color+';color:#fff;padding:4px 12px;border-radius:10px;font-size:12px;font-weight:600">'+stObj.name+'</span>' +
        (price ? '<span style="background:var(--bg4);padding:4px 12px;border-radius:10px;font-size:12px;font-weight:600">'+price.toLocaleString('ru')+'‚ÇΩ</span>' : '') +
        '<span style="color:'+(paid?'var(--green)':'var(--orange)')+';font-size:12px;font-weight:600">'+(paid?'‚úÖ –û–ø–ª–∞—á–µ–Ω':'‚è≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω')+'</span>' +
        (dir['–ú–µ–Ω–µ–¥–∂–µ—Ä'] ? '<span style="color:var(--text2);font-size:12px">üë§ '+esc(dir['–ú–µ–Ω–µ–¥–∂–µ—Ä'])+'</span>' : '') +
      '</div>' +
    '</div>';
  } else {
    clientBar.style.display = 'none';
  }
  
  renderSubprojectView();
}

function showPvTab(tab) {
  currentPvTab = tab;
  document.querySelectorAll('#pv-tabs .tab').forEach(t => t.classList.toggle('active', t.getAttribute('data-tab')===tab));
  renderProjectView();
}

function showSpTab(tab) {
  currentSpTab = tab;
  document.querySelectorAll('#sp-tabs .tab').forEach(t => t.classList.toggle('active', t.getAttribute('data-tab')===tab));
  renderSubprojectView();
}

// ============================================================
// RENDER: MASTER
// ============================================================
function renderAll() {
  // Lazy render: only render the visible page + always update badges
  const activePage = document.querySelector('.page.active');
  const pageId = activePage ? activePage.id : 'page-home';

  // Always sync subprojects and update badges (lightweight)
  if(currentProject) syncSubprojectsFromDb(currentProject);
  updateBadges();

  // Update sidebar project nav
  if (typeof renderSidebarProjects === 'function') renderSidebarProjects();

  switch(pageId) {
    case 'page-home': renderHome(); break;
    case 'page-dashboard': renderDashboard(); break;
    case 'page-partners': renderPartnerFilters(); renderPartners(); break;
    case 'page-tasks': renderTaskFilters(); renderTasks(); break;
    case 'page-staff': renderStaff(); break;
    case 'page-approvals': renderApprovals(); break;
    case 'page-comms': renderComms(); break;
    case 'page-settings': renderSettings(); break;
    case 'page-clients': renderClientsPage(); break;
    case 'page-project':
      if(currentProject && !currentSubproject) renderProjectView();
      break;
    case 'page-subproject':
      if(currentSubproject) renderSubprojectView();
      break;
    default:
      // Fallback: render everything
      renderHome(); renderDashboard(); renderPartnerFilters(); renderPartners();
      renderTaskFilters(); renderTasks(); renderStaff(); renderApprovals();
      renderComms(); renderSettings();
      if(currentProject && !currentSubproject) renderProjectView();
      if(currentSubproject) renderSubprojectView();
  }
}


function updateBadges() {
  const td = today();
  const fp = filterByRole(DATA.partners);
  const allActiveTasks = filterByRole(DATA.tasks).filter(t => {
    const st = t['–°—Ç–∞—Ç—É—Å']||'';
    return st !== '–ì–æ—Ç–æ–≤–æ' && st !== '‚úÖ –ì–æ—Ç–æ–≤–æ';
  });
  const overdueTasks = allActiveTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < td);
  const pa = DATA.approvals.filter(a => (a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç'));
  const fd = filterByRole(DATA.directions || []);

  document.getElementById('badge-partners').textContent = fp.length;

  const taskBadge = document.getElementById('badge-tasks');
  if (taskBadge) {
    const hasOverdue = overdueTasks.length > 0;
    taskBadge.textContent = hasOverdue ? overdueTasks.length : allActiveTasks.length;
    taskBadge.className = 'badge' + (hasOverdue ? ' badge-red' : '');
    taskBadge.title = hasOverdue
      ? overdueTasks.length + ' –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á'
      : allActiveTasks.length + ' –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á';
  }

  document.getElementById('badge-approvals').textContent = pa.length;
  var bc = document.getElementById('badge-clients');
  if (bc) bc.textContent = fd.length;
  var bd = document.getElementById('badge-deals');
  if (bd) {
    var activeDealsCount = fd.filter(function(d) { return d['stage'] !== 'done' && d['stage'] !== 'lost'; }).length;
    bd.textContent = activeDealsCount;
    bd.className = 'badge' + (activeDealsCount > 0 ? '' : ' badge-hidden');
  }
}

// ============================================================
// RENDER: HOME ‚Äî TOP-LEVEL PROJECT CARDS
// ============================================================
function renderHome() {
  const allPartners = filterByRole(DATA.partners);
  const allTasks = filterByRole(DATA.tasks);
  const allProjects = filterByRole(DATA.projects);
  const td = today();
  const overdue = allTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td && (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const active = allTasks.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');

  // Total metrics across all projects
  document.getElementById('home-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+allPartners.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+allProjects.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+active.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div></div>'+
    '<div class="metric-card"><div class="m-icon">üî¥</div><div class="m-value" style="color:'+(overdue.length?'var(--red)':'var(--green)')+'">'+overdue.length+'</div><div class="m-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>'+
    '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+DATA.staff.length+'</div><div class="m-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div></div>';

  // Project cards ‚Äî filter by user's project access
  let html = '';
  const visibleProjects = Object.entries(PROJECTS).filter(([key, proj]) => {
    const p = getUserPerms();
    if (p.seeAll) return true;
    const userPK = getUserProjectKey();
    if (!userPK) return false;
    if (key === userPK) return true;
    // Check extra_projects for this staff member
    if (USER) {
      const myStaff = (DATA.staff||[]).find(s => s['–ò–º—è'] === USER.name);
      if (myStaff) {
        try {
          const extra = JSON.parse(myStaff['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] || '[]');
          if (Array.isArray(extra) && extra.includes(proj.name)) return true;
        } catch(e) {}
      }
    }
    return false;
  });
  
  for (const [key, proj] of visibleProjects) {
    const dirs = getProjectDirs(key);
    const pp = allPartners.filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const pt = allTasks.filter(t => dirs.includes(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const ptActive = pt.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
    const ptOverdue = ptActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);
    const ppr = allProjects.filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const avgPr = ppr.length ? Math.round(ppr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/ppr.length) : 0;

    let stTag = '';
    if (ptOverdue.length) stTag = '<span class="status-tag" style="background:var(--red-glow);color:var(--red)">üî¥ '+ptOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.</span>';
    else if (ptActive.length) stTag = '<span class="status-tag" style="background:var(--accent-glow);color:var(--accent)">–í —Ä–∞–±–æ—Ç–µ</span>';
    else stTag = '<span class="status-tag" style="background:rgba(136,153,170,0.15);color:var(--text2)">–°—Ç–∞—Ä—Ç</span>';

    html += '<div class="project-card" onclick="openProject(\''+key+'\')">';
    html += '<div class="project-card-top" style="background:'+proj.gradient+'"></div>';
    html += stTag;
    html += '<div class="project-card-header">';
    html += '<span class="emoji">'+proj.emoji+'</span>';
    html += '<h3>'+esc(proj.name)+'</h3>';
    html += '<div class="desc">'+esc(proj.desc)+'</div>';
    html += '</div>';
    html += '<div class="project-card-stats">';
    var cardCount = proj.canAddSub ? (DATA.directions||[]).filter(function(d){return d['–ü—Ä–æ–µ–∫—Ç']===proj.name;}).length : Object.keys(proj.subprojects).length;
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+cardCount+'</div><div class="l">'+(proj.canAddSub?'–ö–ª–∏–µ–Ω—Ç–æ–≤':'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π')+'</div></div>';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+pp.length+'</div><div class="l">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+ptActive.length+'</div><div class="l">–ó–∞–¥–∞—á</div></div>';
    html += '</div>';
    html += '<div class="project-card-progress">';
    html += '<div class="bar"><div class="fill" style="width:'+avgPr+'%;background:'+proj.color+'"></div></div>';
    html += '<div class="info"><span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span><span>'+avgPr+'%</span></div>';
    html += '</div></div>';
  }

  // Add project card ‚Äî only CEO
  if (getUserPerms().level >= 4) {
    html += '<div class="project-card add-card" onclick="openModal(\'newproject\')">';
    html += '<span class="add-icon">‚ûï</span>';
    html += '<span class="add-text">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</span>';
    html += '</div>';
  }

  document.getElementById('project-grid').innerHTML = html;
}

// ============================================================
// RENDER: PROJECT VIEW (subprojects)
// ============================================================
function renderProjectView() {
  if(!currentProject) return;
  const proj = PROJECTS[currentProject];
  if(!proj) return;
  const td = today();

  document.getElementById('pv-name').textContent = proj.name;
  document.getElementById('pv-title').innerHTML = proj.emoji + ' ' + esc(proj.name);
  // Show quick site button only for projects that support subprojects (site projects)
  const qsBtn = document.getElementById('btn-quick-site');
  if (qsBtn) qsBtn.style.display = proj.canAddSub ? '' : 'none';
  document.getElementById('btn-add-sub').style.display = proj.canAddSub ? '' : 'none';

  const dirs = getProjectDirs(currentProject);
  const pp = filterByRole(DATA.partners).filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const pt = filterByRole(DATA.tasks).filter(t => dirs.includes(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const ppr = filterByRole(DATA.projects).filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const ptActive = pt.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const ptOverdue = ptActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);
  const avgPr = ppr.length ? Math.round(ppr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/ppr.length) : 0;

  // Metrics
  if (proj.canAddSub) {
    const allDirsM = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
    const activeM = allDirsM.filter(d => !['done','lost'].includes(d['stage']||'prospect'));
    const revenue = allDirsM.filter(d=>d['–û–ø–ª–∞—á–µ–Ω–æ']).reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
    const lostM = allDirsM.filter(d => d['stage']==='lost').length;
    const wonM = allDirsM.filter(d => d['stage']==='done').length;
    const winRate = (wonM+lostM) > 0 ? Math.round(wonM/(wonM+lostM)*100) : 0;
    const followupToday = allDirsM.filter(d => d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] <= td && !['done','lost'].includes(d['stage']||'prospect')).length;
    document.getElementById('pv-metrics').innerHTML =
      '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+allDirsM.length+'</div><div class="m-label">–ö–ª–∏–µ–Ω—Ç–æ–≤</div><div class="m-sub">'+activeM.length+' –≤ —Ä–∞–±–æ—Ç–µ</div></div>'+
      '<div class="metric-card"><div class="m-icon">üí∞</div><div class="m-value">'+revenue.toLocaleString('ru')+'‚ÇΩ</div><div class="m-label">–í—ã—Ä—É—á–∫–∞</div></div>'+
      '<div class="metric-card"><div class="m-icon">üìä</div><div class="m-value">'+winRate+'%</div><div class="m-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div><div class="m-sub">'+wonM+' –∏–∑ '+(wonM+lostM)+'</div></div>'+
      (followupToday ? '<div class="metric-card" style="border:1px solid var(--orange)"><div class="m-icon">üîî</div><div class="m-value" style="color:var(--orange)">'+followupToday+'</div><div class="m-label">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å!</div><div class="m-sub">—Å–µ–≥–æ–¥–Ω—è</div></div>' :
      '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+ptActive.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+(ptOverdue.length?'üî¥ '+ptOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.':'–≤ —Ä–∞–±–æ—Ç–µ')+'</div></div>');
  } else {
  document.getElementById('pv-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">üìÇ</div><div class="m-value">'+Object.keys(proj.subprojects).length+'</div><div class="m-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</div></div>'+
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+pp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+ptActive.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+(ptOverdue.length?'üî¥ '+ptOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.':'–≤ —Ä–∞–±–æ—Ç–µ')+'</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìà</div><div class="m-value">'+avgPr+'%</div><div class="m-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+ppr.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>';
  }

  // Subproject cards grid
  let sgHtml = '';
  // CLIENT-ORIENTED CRM for –°–∞–π—Ç—ã
  if (proj.canAddSub) {
    // Render vertical pipeline
    const allDirs = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
    const totalRev = allDirs.filter(d=>d['–û–ø–ª–∞—á–µ–Ω–æ']).reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
    const totalPipe = allDirs.filter(d=>!d['–û–ø–ª–∞—á–µ–Ω–æ']&&!['done','lost'].includes(d['stage']||'prospect')).reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
    const doneCount = allDirs.filter(d=>(d['stage'])==='done').length;
    const lostCount = allDirs.filter(d=>(d['stage'])==='lost').length;
    const activeCount = allDirs.filter(d=>!['done','lost'].includes(d['stage']||'prospect')).length;
    
    // Follow-up alerts - clients to call today
    const followups = allDirs.filter(d => d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] <= td && !['done','lost'].includes(d['stage']||'prospect'));
    
    // Compact stats row
    sgHtml += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px">';
    sgHtml += '<div class="card" style="padding:14px;text-align:center"><div style="font-size:11px;color:var(--text2)">üë• –ö–ª–∏–µ–Ω—Ç—ã</div><div style="font-size:22px;font-weight:700">'+allDirs.length+'</div><div style="font-size:10px;color:var(--text3)">'+activeCount+' –≤ —Ä–∞–±–æ—Ç–µ</div></div>';
    sgHtml += '<div class="card" style="padding:14px;text-align:center"><div style="font-size:11px;color:var(--text2)">üí∞ –ü–æ–ª—É—á–µ–Ω–æ</div><div style="font-size:22px;font-weight:700;color:var(--green)">'+totalRev.toLocaleString('ru')+'‚ÇΩ</div></div>';
    sgHtml += '<div class="card" style="padding:14px;text-align:center"><div style="font-size:11px;color:var(--text2)">üìä –í –≤–æ—Ä–æ–Ω–∫–µ</div><div style="font-size:22px;font-weight:700;color:var(--blue)">'+totalPipe.toLocaleString('ru')+'‚ÇΩ</div></div>';
    sgHtml += '<div class="card" style="padding:14px;text-align:center"><div style="font-size:11px;color:var(--text2)">‚úÖ –°–¥–∞–Ω–æ</div><div style="font-size:22px;font-weight:700">'+doneCount+'</div></div>';
    sgHtml += '<div class="card" style="padding:14px;text-align:center"><div style="font-size:11px;color:var(--text2)">‚ùå –û—Ç–∫–∞–∑—ã</div><div style="font-size:22px;font-weight:700;color:var(--red)">'+lostCount+'</div></div>';
    sgHtml += '</div>';
    
    // üîî Follow-up alerts - MOST IMPORTANT section
    if (followups.length) {
      sgHtml += '<div class="card" style="margin-bottom:16px;border:1px solid var(--orange);background:rgba(255,170,0,0.05)">';
      sgHtml += '<div style="padding:12px 16px;font-weight:700;color:var(--orange)">üîî –ù–∞–¥–æ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è ('+followups.length+')</div>';
      followups.forEach(d => {
        const cid = d['ID']||d.id||'';
        const cleanPh = (d['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[^\\d+]/g,'');
        sgHtml += '<div style="padding:8px 16px;display:flex;align-items:center;gap:10px;border-top:1px solid var(--border)">';
        sgHtml += '<span style="font-weight:600;flex:1;cursor:pointer" onclick="openSlideOver(\''+escA(cid)+'\')">'+esc(d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+'</span>';
        sgHtml += '<span style="font-size:12px;color:var(--text2)">'+esc(d['–¢–µ–ª–µ—Ñ–æ–Ω']||'–Ω–µ—Ç —Ç–µ–ª.')+'</span>';
        sgHtml += '<span style="font-size:11px;padding:2px 8px;border-radius:10px;background:rgba(255,170,0,0.15);color:var(--orange)">–ö–∞—Å–∞–Ω–∏–µ #'+(Number(d['–ö–∞—Å–∞–Ω–∏—è']||0)+1)+'</span>';
        if (cleanPh) sgHtml += '<button onclick="window.open(\'tel:'+cleanPh+'\')" style="padding:4px 10px;font-size:12px;background:var(--accent);border:none;border-radius:6px;color:#000;cursor:pointer">üìû</button>';
        sgHtml += '<button onclick="logTouch(\''+escA(cid)+'\')" style="padding:4px 10px;font-size:12px;background:var(--green);border:none;border-radius:6px;color:#000;cursor:pointer">‚úÖ –ü–æ–∑–≤–æ–Ω–∏–ª</button>';
        sgHtml += '</div>';
      });
      sgHtml += '</div>';
    }
    
    // Vertical pipeline
    const canDel = getUserPerms().level >= 3; // CEO + –ó–∞–º
    sgHtml += '<div class="pipeline-vertical">';
    STAGES.forEach(stage => {
      const deals = allDirs.filter(d => (d['stage']||'prospect') === stage.id);
      const sum = deals.reduce((s,d) => s + (Number(d['–¶–µ–Ω–∞'])||0), 0);
      // Hide empty 'lost' stage by default
      if (stage.id === 'lost' && !deals.length) return;
      
      sgHtml += '<div class="pipe-stage">';
      sgHtml += '<div class="pipe-stage-hdr" onclick="togglePipeStage(this)">';
      sgHtml += '<div class="pipe-info"><span class="pipe-dot" style="background:'+stage.color+'"></span>'+stage.name+'</div>';
      sgHtml += '<div class="pipe-stats"><span>'+deals.length+' –∫–ª–∏–µ–Ω—Ç'+(deals.length!==1?'–æ–≤':'')+'</span>';
      if (sum) sgHtml += '<span style="color:var(--accent)">'+sum.toLocaleString('ru')+'‚ÇΩ</span>';
      if (stage.pct) sgHtml += '<span style="font-size:10px;color:var(--text3)">~'+stage.pct+'%</span>';
      sgHtml += '<span>‚ñæ</span></div></div>';
      
      if (deals.length) {
        sgHtml += '<div class="pipe-stage-body">';
        deals.forEach(d => {
          const cid = d['ID']||d.id||'';
          const cname = d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?';
          const overdue = d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] <= td && !['done','lost'].includes(stage.id);
          const touches = Number(d['–ö–∞—Å–∞–Ω–∏—è']||0);
          sgHtml += '<div class="pipe-client'+(overdue?' overdue':'')+'" onclick="openSlideOver(\''+escA(cid)+'\')">';
          sgHtml += '<div style="flex:1"><div class="pc-name">'+esc(cname)+'</div>';
          sgHtml += '<div class="pc-meta">';
          if (d['–¢–∏–ø —Å–∞–π—Ç–∞']) sgHtml += '<span>'+esc(d['–¢–∏–ø —Å–∞–π—Ç–∞'])+'</span>';
          if (d['–ì–æ—Ä–æ–¥']) sgHtml += '<span>üìç'+esc(d['–ì–æ—Ä–æ–¥'])+'</span>';
          if (d['–ú–µ–Ω–µ–¥–∂–µ—Ä']) sgHtml += '<span>üë§'+esc(d['–ú–µ–Ω–µ–¥–∂–µ—Ä'].split(' ')[0])+'</span>';
          if (d['–ò—Å—Ç–æ—á–Ω–∏–∫']) sgHtml += '<span style="font-size:10px">'+esc(d['–ò—Å—Ç–æ—á–Ω–∏–∫'])+'</span>';
          if (touches) sgHtml += '<span style="font-size:10px">üìû√ó'+touches+'</span>';
          if (overdue) sgHtml += '<span style="color:var(--orange)">üîî –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å!</span>';
          else if (d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && !['done','lost'].includes(stage.id)) sgHtml += '<span style="font-size:10px;color:var(--text3)">üìÖ '+d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç']+'</span>';
          sgHtml += d['–û–ø–ª–∞—á–µ–Ω–æ'] ? '<span style="color:var(--green)">üí∞</span>' : '';
          sgHtml += '</div></div>';
          if (d['–¶–µ–Ω–∞']) sgHtml += '<div class="pc-price">'+Number(d['–¶–µ–Ω–∞']).toLocaleString('ru')+'‚ÇΩ</div>';
          if (canDel) sgHtml += '<div class="pc-del" onclick="event.stopPropagation();deleteClient(\''+escA(cid)+'\',\''+escA(cname)+'\')" title="–£–¥–∞–ª–∏—Ç—å">üóë</div>';
          sgHtml += '</div>';
        });
        sgHtml += '</div>';
      }
      sgHtml += '</div>';
    });
    sgHtml += '</div>';
    
    // Add client button
    sgHtml += '<button class="btn btn-primary" onclick="openAddSubproject()" style="margin-top:16px;width:100%">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>';
    
  } else {
  // Standard subproject cards (for –†–ö–¢ etc.)
  for (const [spName, spMeta] of Object.entries(proj.subprojects)) {
    const spp = pp.filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===spName);
    const spt = ptActive.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===spName);
    const spOverdue = spt.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);

    sgHtml += '<div class="subproject-card" onclick="openSubproject(\''+escA(spName)+'\')">';
    sgHtml += '<div style="position:absolute;top:0;left:0;right:0;height:3px;background:'+spMeta.color+'"></div>';
    sgHtml += '<span class="sp-emoji">'+spMeta.emoji+'</span>';
    sgHtml += '<h4>'+esc(spName)+'</h4>';
    sgHtml += '<div class="sp-desc">'+esc(spMeta.desc)+'</div>';
    sgHtml += '<div class="sp-stats">';
    sgHtml += '<span>ü§ù '+spp.length+'</span>';
    sgHtml += '<span>‚úÖ '+spt.length+'</span>';
    if (spOverdue.length) sgHtml += '<span style="color:var(--red)">üî¥ '+spOverdue.length+'</span>';
    sgHtml += '</div>';
    sgHtml += '</div>';
  }
  }

  document.getElementById('subproject-grid').innerHTML = sgHtml;

  // Tab content
  const content = document.getElementById('pv-content');
  let html = '';

  if (currentPvTab === 'overview') {
    // CLIENT STATUS SUMMARY (for –°–∞–π—Ç—ã project)
    if (proj.canAddSub) {
      const clientDirs = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === proj.name);
      if (clientDirs.length) {
        html += '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>üë• –°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–æ–≤ ('+clientDirs.length+')</h3></div>';
        html += '<div class="table-wrap"><table><thead><tr><th>–ö–ª–∏–µ–Ω—Ç</th><th>–≠—Ç–∞–ø</th><th>–¢–∏–ø —Å–∞–π—Ç–∞</th><th>üí∞ –¶–µ–Ω–∞</th><th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th><th>–û–ø–ª–∞—Ç–∞</th><th>–ì–æ—Ä–æ–¥</th></tr></thead><tbody>';
        clientDirs.sort((a,b) => {
          const sa = STAGES.findIndex(s=>s.id===(a['stage']||'prospect'));
          const sb = STAGES.findIndex(s=>s.id===(b['stage']||'prospect'));
          return sa - sb;
        }).forEach(d => {
          const st = d['stage']||'prospect';
          const stObj = STAGES.find(s=>s.id===st) || STAGES[0];
          const stIdx = STAGES.findIndex(s=>s.id===st);
          const paid = d['–û–ø–ª–∞—á–µ–Ω–æ'];
          const price = Number(d['–¶–µ–Ω–∞'])||0;
          const cid = d['ID']||d.id||'';
          // Find the current active task for this client
          const clientTasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||''));
          const activeTask = clientTasks.find(t => (t['–°—Ç–∞—Ç—É—Å']||'').includes('–í —Ä–∞–±–æ—Ç–µ') || (t['–°—Ç–∞—Ç—É—Å']||'').includes('–ù–æ–≤–∞—è'));
          html += '<tr onclick="openSlideOver(\''+escA(cid)+'\')" style="cursor:pointer" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π">';
          html += '<td><strong>'+esc(d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+'</strong></td>';
          html += '<td><span style="background:'+stObj.color+';color:#fff;padding:2px 10px;border-radius:10px;font-size:11px;white-space:nowrap">'+stObj.name+'</span></td>';
          html += '<td>'+esc(d['–¢–∏–ø —Å–∞–π—Ç–∞']||'‚Äî')+'</td>';
          html += '<td style="font-weight:600">'+(price?price.toLocaleString('ru')+'‚ÇΩ':'‚Äî')+'</td>';
          html += '<td>'+esc(d['–ú–µ–Ω–µ–¥–∂–µ—Ä']||'‚Äî')+'</td>';
          html += '<td style="color:'+(paid?'var(--green)':'var(--orange)')+'">'+( paid?'‚úÖ –û–ø–ª–∞—á–µ–Ω':'‚è≥')+'</td>';
          html += '<td>'+esc(d['–ì–æ—Ä–æ–¥']||'‚Äî')+'</td>';
          html += '</tr>';
          // Show current task as sub-row
          if (activeTask) {
            html += '<tr style="background:rgba(0,212,170,0.04);font-size:12px"><td colspan="7" style="padding:4px 12px 8px 20px">‚Ü≥ <span style="color:var(--accent)">–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞:</span> '+esc(activeTask['–û–ø–∏—Å–∞–Ω–∏–µ']||'')+'  <span style="color:var(--text2)">üë§ '+esc(activeTask['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+' ¬∑ üìÖ '+(activeTask['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</span></td></tr>';
          }
        });
        html += '</tbody></table></div></div>';
      }
      
      // === KPI / Sales Performance ===
      const thisMonth = today().slice(0,7); // YYYY-MM
      const monthClients = clientDirs.filter(d => (d['–°–æ–∑–¥–∞–Ω']||d['–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è']||'').startsWith(thisMonth));
      const monthWon = monthClients.filter(d => d['stage'] === 'done').length;
      const monthLost = monthClients.filter(d => d['stage'] === 'lost').length;
      const monthRev = monthClients.filter(d=>d['–û–ø–ª–∞—á–µ–Ω–æ']).reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
      const totalTouches = clientDirs.reduce((s,d) => s + (Number(d['–ö–∞—Å–∞–Ω–∏—è']||0)), 0);
      const avgTouches = clientDirs.length ? Math.round(totalTouches / clientDirs.length * 10) / 10 : 0;
      const followupsDue = clientDirs.filter(d => d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] <= td && !['done','lost'].includes(d['stage']||'prospect')).length;
      
      html += '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>üìä KPI –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</h3></div>';
      html += '<div style="padding:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:12px;text-align:center">';
      html += '<div><div style="font-size:22px;font-weight:700">'+monthClients.length+'</div><div style="font-size:11px;color:var(--text2)">–ù–æ–≤—ã—Ö –ª–∏–¥–æ–≤</div></div>';
      html += '<div><div style="font-size:22px;font-weight:700;color:var(--green)">'+monthWon+'</div><div style="font-size:11px;color:var(--text2)">–ó–∞–∫—Ä—ã—Ç–æ</div></div>';
      html += '<div><div style="font-size:22px;font-weight:700;color:var(--red)">'+monthLost+'</div><div style="font-size:11px;color:var(--text2)">–û—Ç–∫–∞–∑—ã</div></div>';
      html += '<div><div style="font-size:22px;font-weight:700;color:var(--accent)">'+monthRev.toLocaleString('ru')+'‚ÇΩ</div><div style="font-size:11px;color:var(--text2)">–í—ã—Ä—É—á–∫–∞</div></div>';
      html += '<div><div style="font-size:22px;font-weight:700">'+avgTouches+'</div><div style="font-size:11px;color:var(--text2)">–°—Ä. –∫–∞—Å–∞–Ω–∏–π</div></div>';
      if (followupsDue) html += '<div><div style="font-size:22px;font-weight:700;color:var(--orange)">'+followupsDue+'</div><div style="font-size:11px;color:var(--text2)">üîî –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</div></div>';
      html += '</div></div>';
    }
    
    // Overdue
    if (ptOverdue.length) {
      html += '<div class="card" style="border-color:rgba(255,107,107,0.4)"><div class="card-header" style="background:rgba(255,107,107,0.05)"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ptOverdue.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
      html += ptOverdue.map(t => '<tr style="cursor:pointer;background:rgba(255,107,107,0.03)" onclick="openTaskDetail(\''+escA(t.ID)+'\')"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td onclick="event.stopPropagation()">'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    // Active projects
    if (ppr.length) {
      html += '<div class="card"><div class="card-header"><h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã ('+ppr.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
      html += ppr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    // Recent tasks
    const pOrder = {P1:1,P2:2,P3:3};
    const topT = [...ptActive].sort((a,b) => (pOrder[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pOrder[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)).slice(0,10);
    html += '<div class="card"><div class="card-header"><h3>‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3></div>';
    html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += topT.length ? topT.map(t => {
      const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td;
      return '<tr style="cursor:pointer;'+(od?'background:rgba(255,107,107,0.03)':'')+'" onclick="openTaskDetail(\''+escA(t.ID)+'\')"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>';
    }).join('') : emptyRow(6,'–ù–µ—Ç –∑–∞–¥–∞—á');
    html += '</tbody></table></div></div>';

  } else if (currentPvTab === 'pipeline') {
    // –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂ –ø—Ä–æ–µ–∫—Ç–∞
    if (proj.canAddSub) {
      const allDirs = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === proj.name);
      const canDel = getUserPerms().level >= 3;
      html += '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>üéØ –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂ ‚Äî '+esc(proj.name)+'</h3><div class="actions"><button class="btn btn-primary btn-sm" onclick="openAddSubproject()">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button></div></div></div>';
      html += '<div class="pipeline-vertical">';
      STAGES.forEach(function(stage) {
        var deals = allDirs.filter(function(d) { return (d['stage']||'prospect') === stage.id; });
        var sum = deals.reduce(function(s,d) { return s + (Number(d['–¶–µ–Ω–∞'])||0); }, 0);
        if (stage.id === 'lost' && !deals.length) return;
        html += '<div class="pipe-stage">';
        html += '<div class="pipe-stage-hdr" onclick="togglePipeStage(this)">';
        html += '<div class="pipe-info"><span class="pipe-dot" style="background:'+stage.color+'"></span>'+stage.name+'</div>';
        html += '<div class="pipe-stats"><span>'+deals.length+' –∫–ª–∏–µ–Ω—Ç'+(deals.length!==1?'–æ–≤':'')+'</span>';
        if (sum) html += '<span style="color:var(--accent)">'+sum.toLocaleString('ru')+'‚ÇΩ</span>';
        if (stage.pct) html += '<span style="font-size:10px;color:var(--text3)">~'+stage.pct+'%</span>';
        html += '<span>‚ñæ</span></div></div>';
        if (deals.length) {
          html += '<div class="pipe-stage-body">';
          deals.forEach(function(d) {
            var cid = d['ID']||d.id||'';
            var cname = d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?';
            var overdue = d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] <= td && !['done','lost'].includes(stage.id);
            var touches = Number(d['–ö–∞—Å–∞–Ω–∏—è']||0);
            html += '<div class="pipe-client'+(overdue?' overdue':'')+'" onclick="openSlideOver(\''+escA(cid)+'\')">';
            html += '<div style="flex:1"><div class="pc-name">'+esc(cname)+'</div>';
            html += '<div class="pc-meta">';
            if (d['–¢–∏–ø —Å–∞–π—Ç–∞']) html += '<span>'+esc(d['–¢–∏–ø —Å–∞–π—Ç–∞'])+'</span>';
            if (d['–ì–æ—Ä–æ–¥']) html += '<span>üìç'+esc(d['–ì–æ—Ä–æ–¥'])+'</span>';
            if (d['–ú–µ–Ω–µ–¥–∂–µ—Ä']) html += '<span>üë§'+esc(d['–ú–µ–Ω–µ–¥–∂–µ—Ä'].split(' ')[0])+'</span>';
            if (touches) html += '<span style="font-size:10px">üìû√ó'+touches+'</span>';
            if (overdue) html += '<span style="color:var(--orange)">üîî –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å!</span>';
            html += d['–û–ø–ª–∞—á–µ–Ω–æ'] ? '<span style="color:var(--green)">üí∞</span>' : '';
            html += '</div></div>';
            if (d['–¶–µ–Ω–∞']) html += '<div class="pc-price">'+Number(d['–¶–µ–Ω–∞']).toLocaleString('ru')+'‚ÇΩ</div>';
            if (canDel) html += '<div class="pc-del" onclick="event.stopPropagation();deleteClient(\''+escA(cid)+'\',\''+escA(cname)+'\')" title="–£–¥–∞–ª–∏—Ç—å">üóë</div>';
            html += '</div>';
          });
          html += '</div>';
        }
        html += '</div>';
      });
      html += '</div>';
      html += '<button class="btn btn-primary" onclick="openAddSubproject()" style="margin-top:16px;width:100%">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>';
    } else {
      html += '<div class="empty"><div class="icon">üéØ</div><p>–í–æ—Ä–æ–Ω–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è CRM-–ø—Ä–æ–µ–∫—Ç–æ–≤</p></div>';
    }

  } else if (currentPvTab === 'clients') {
    // –¢–∞–±–ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
    if (proj.canAddSub) {
      var clientDirs = (DATA.directions||[]).filter(function(d) { return d['–ü—Ä–æ–µ–∫—Ç'] === proj.name; });
      var STAGE_LABELS = { prospect:'üîç –ü–æ–∏—Å–∫', contact:'üìû –ö–æ–Ω—Ç–∞–∫—Ç', proposal:'üìÑ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', negotiation:'ü§ù –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', contract:'üìã –î–æ–≥–æ–≤–æ—Ä', prepayment:'üí≥ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞', production:'‚öôÔ∏è –†–∞–±–æ—Ç–∞', done:'‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω', lost:'‚ùå –û—Ç–∫–∞–∑' };
      var totalPrice = clientDirs.reduce(function(s,d){return s+(Number(d['–¶–µ–Ω–∞'])||0);},0);
      var activeClients = clientDirs.filter(function(d){return !['done','lost'].includes(d.stage||'prospect');}).length;
      // Stats
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:16px">';
      html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--accent)">'+clientDirs.length+'</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–í—Å–µ–≥–æ</div></div>';
      html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--blue)">'+activeClients+'</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div></div>';
      html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--orange)">'+totalPrice.toLocaleString('ru')+'‚ÇΩ</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–°—É–º–º–∞</div></div>';
      html += '</div>';
      // Table
      if (clientDirs.length) {
        clientDirs.sort(function(a,b){return (b.created_at||'').localeCompare(a.created_at||'');});
        html += '<div class="card"><div class="card-header"><h3>üë• –ö–ª–∏–µ–Ω—Ç—ã ‚Äî '+esc(proj.name)+'</h3><div class="actions"><button class="btn btn-primary btn-sm" onclick="openAddSubproject()">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button></div></div>';
        html += '<div class="table-wrap"><table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr style="border-bottom:2px solid var(--border);text-align:left">';
        html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ö–ª–∏–µ–Ω—Ç</th>';
        html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>';
        html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–¢–∏–ø</th>';
        html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–°—Ç–∞–¥–∏—è</th>';
        html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–¶–µ–Ω–∞</th>';
        html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ú–µ–Ω–µ–¥–∂–µ—Ä</th>';
        html += '</tr></thead><tbody>';
        clientDirs.forEach(function(d) {
          var name = d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d.name||'‚Äî';
          var phone = d['–¢–µ–ª–µ—Ñ–æ–Ω']||d.phone||'';
          var tg = d['Telegram']||d.telegram_tag||'';
          var stage = d.stage||'prospect';
          var stageLabel = STAGE_LABELS[stage]||stage;
          var price = Number(d['–¶–µ–Ω–∞']||d.price)||0;
          var manager = d['–ú–µ–Ω–µ–¥–∂–µ—Ä']||d.manager||'‚Äî';
          var cid = d.id||d.ID;
          html += '<tr style="border-bottom:1px solid var(--border);cursor:pointer;transition:background .2s" onclick="openSlideOver(\''+escA(cid)+'\')" onmouseover="this.style.background=\'var(--bg3)\'" onmouseout="this.style.background=\'\'">';
          html += '<td style="padding:10px 8px;font-weight:600">'+esc(name)+'</td>';
          html += '<td style="padding:10px 8px"><div>'+(phone?'üìû '+esc(phone):'')+'</div>'+(tg?'<div style="color:var(--accent);font-size:12px">üí¨ '+esc(tg)+'</div>':'')+'</td>';
          html += '<td style="padding:10px 8px">'+esc(d['–¢–∏–ø —Å–∞–π—Ç–∞']||'‚Äî')+'</td>';
          html += '<td style="padding:10px 8px"><span style="font-size:12px">'+stageLabel+'</span></td>';
          html += '<td style="padding:10px 8px;font-weight:600">'+(price?price.toLocaleString('ru')+'‚ÇΩ':'‚Äî')+'</td>';
          html += '<td style="padding:10px 8px;color:var(--text2)">'+esc(manager)+'</td>';
          html += '</tr>';
        });
        html += '</tbody></table></div></div>';
      } else {
        html += '<div class="empty"><div class="icon">üë•</div><p>–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ</p><button class="btn btn-primary" onclick="openAddSubproject()" style="margin-top:12px">+ –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button></div>';
      }
    } else {
      html += '<div class="empty"><div class="icon">üë•</div><p>–ö–ª–∏–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è CRM-–ø—Ä–æ–µ–∫—Ç–æ–≤</p></div>';
    }

  } else if (currentPvTab === 'tasks') {
    html += renderTaskTable(pt);
  } else if (currentPvTab === 'partners') {
    html += renderPartnerTable(pp);
  } else if (currentPvTab === 'staff') {
    // Staff for this project
    const projName = PROJECTS[currentProject]?.name || '';
    const projectStaff = getStaffForProject(projName).filter(s => (s['–°—Ç–∞—Ç—É—Å']||'–ê–∫—Ç–∏–≤–Ω—ã–π')!=='–û–∂–∏–¥–∞–µ—Ç');
    const roleColors = {CEO:'linear-gradient(135deg,#00d4aa,#4dabf7)','–ó–∞–º':'linear-gradient(135deg,#b197fc,#7950f2)','–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':'linear-gradient(135deg,#ffa94d,#fd7e14)'};
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px">';
    const roleOrd = {'CEO':0,'–ó–∞–º':1,'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':2};
    [...projectStaff].sort((a,b)=>(roleOrd[a['–†–æ–ª—å']]??9)-(roleOrd[b['–†–æ–ª—å']]??9)).forEach(s => {
      const bg = roleColors[s['–†–æ–ª—å']]||'linear-gradient(135deg,var(--text3),var(--text2))';
      const tc = DATA.tasks.filter(t=>(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(s['–ò–º—è']||'___')&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ').length;
      html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;align-items:center;gap:12px">';
      html += '<div style="width:40px;height:40px;border-radius:50%;background:'+bg+';display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg);font-size:16px;flex-shrink:0">'+esc((s['–ò–º—è']||'?')[0])+'</div>';
      html += '<div><div style="font-weight:600;font-size:13px">'+esc(s['–ò–º—è']||'‚Äî')+'</div>';
      html += '<div style="font-size:11px;color:var(--text2)">'+({CEO:'üëë',–ó–∞–º:'‚≠ê',–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:'üìã'}[s['–†–æ–ª—å']]||'üë§')+' '+esc(s['–†–æ–ª—å']||'')+' ¬∑ '+esc(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'–í—Å–µ')+'</div>';
      if(tc) html += '<div style="font-size:10px;color:var(--orange)">üìã '+tc+' –∑–∞–¥–∞—á</div>';
      html += '</div></div>';
    });
    if(!projectStaff.length) html += '<div class="empty" style="grid-column:1/-1"><div class="icon">üë•</div><p>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p></div>';
    html += '</div>';
  } else if (currentPvTab === 'timeline') {
    // Gantt / Timeline
    html += renderTimeline(pt, dirs);
  } else if (currentPvTab === 'comms') {
    const pNames = pp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
    const dc = (DATA.comms||[]).filter(c => pNames.some(n => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'').includes(n)));
    html += renderCommTable(dc);
  } else if (currentPvTab === 'docs') {
    // Project-level documents
    const projName = PROJECTS[currentProject]?.name || '';
    const projDocs = (DATA.documents||[]).filter(d => {
      const folder = d['–ü–∞–ø–∫–∞']||d['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
      return folder.includes(projName) || (d['–ü—Ä–æ–µ–∫—Ç']||'') === projName || dirs.some(dir => folder.includes(dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'___'));
    });
    html += '<div class="card"><div class="card-header"><h3>üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ ¬´'+esc(projName)+'¬ª</h3>';
    html += '<div class="actions"><button class="btn btn-sm btn-primary" onclick="uploadProjectFile(\''+escA(projName)+'\')">üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button></div></div>';
    if (projDocs.length) {
      html += '<div class="table-wrap"><table><thead><tr><th>üìÑ –§–∞–π–ª</th><th>–ü–∞–ø–∫–∞/–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ó–∞–≥—Ä—É–∑–∏–ª</th><th>–î–∞—Ç–∞</th><th>–°—Å—ã–ª–∫–∞</th></tr></thead><tbody>';
      projDocs.forEach(d => {
        const icon = getFileIcon(d['–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞']||d['–§–∞–π–ª']||'');
        const link = d['–°—Å—ã–ª–∫–∞'] ? '<a href="'+esc(d['–°—Å—ã–ª–∫–∞'])+'" target="_blank" style="color:var(--accent)">–û—Ç–∫—Ä—ã—Ç—å</a>' : '‚Äî';
        html += '<tr><td>'+icon+' '+esc(d['–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞']||d['–§–∞–π–ª']||'‚Äî')+'</td><td>'+esc(d['–ü–∞–ø–∫–∞']||d['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'‚Äî')+'</td><td>'+esc(d['–ó–∞–≥—Ä—É–∑–∏–ª']||'‚Äî')+'</td><td>'+esc(d['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+link+'</td></tr>';
      });
      html += '</tbody></table></div>';
    } else {
      html += '<div style="padding:40px;text-align:center;color:var(--text2)"><div style="font-size:40px;margin-bottom:12px">üìÇ</div><p>–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª.</p></div>';
    }
    html += '</div>';
    // AI Knowledge hint
    html += '<div class="card" style="margin-top:12px;border-color:var(--purple);border-style:dashed"><div style="padding:20px;text-align:center">';
    html += '<div style="font-size:24px;margin-bottom:8px">üß†</div>';
    html += '<h4 style="margin-bottom:6px">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞</h4>';
    html += '<p style="font-size:13px;color:var(--text2);margin-bottom:12px">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –¢–ó, –¥–æ–≥–æ–≤–æ—Ä—ã, —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏. –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤.</p>';
    html += '<button class="btn btn-sm" onclick="uploadProjectFile(\''+escA(projName)+'\')" style="background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff;border:none">üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</button>';
    html += '</div></div>';
  } else if (currentPvTab === 'finance') {
    html += renderSiteFinance();
  } else if (currentPvTab === 'salaries') {
    html += renderSiteSalaries();
  }

  content.innerHTML = html;
}

// ============================================================
// RENDER: SUBPROJECT VIEW (workspace inside e.g. –ö–¢ or –ü—ã—à–∫–∏)
// ============================================================
function renderSubprojectView() {
  if (!currentSubproject||!currentProject) return;
  const proj = PROJECTS[currentProject];
  const spMeta = proj?.subprojects[currentSubproject] || { emoji:'üìå', color:'var(--text2)', desc:'' };
  const td = today();
  const isCRM = !!(PROJECTS[currentProject] && PROJECTS[currentProject].canAddSub);

  document.getElementById('sp-parent').textContent = proj.name;
  document.getElementById('sp-parent').setAttribute('onclick', "openProject('"+currentProject+"')");
  document.getElementById('sp-name').textContent = currentSubproject;
  document.getElementById('sp-title').innerHTML = spMeta.emoji + ' ' + esc(currentSubproject);

  const sp = filterByRole(DATA.partners).filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const st = filterByRole(DATA.tasks).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const spr = filterByRole(DATA.projects).filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const stActive = st.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const stDone = st.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')==='–ì–æ—Ç–æ–≤–æ');
  const stOverdue = stActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td);

  // === METRICS (role-appropriate) ===
  if (isCRM) {
    const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
    const stage = dir ? (dir['stage']||'prospect') : 'prospect';
    const stObj = STAGES.find(s=>s.id===stage)||STAGES[0];
    const stIdx = STAGES.findIndex(s=>s.id===stage);
    const progress = Math.round((stIdx / (STAGES.length-1)) * 100);
    document.getElementById('sp-metrics').innerHTML =
      '<div class="metric-card"><div class="m-icon">üìä</div><div class="m-value" style="color:'+stObj.color+'">'+stObj.name.replace(/[^\w–ê-–Ø–∞-—è—ë–Å\s]/g,'').trim()+'</div><div class="m-label">–≠—Ç–∞–ø</div><div class="m-sub">—à–∞–≥ '+(stIdx+1)+'/'+STAGES.length+'</div></div>'+
      '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+stDone.length+'/'+st.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+stActive.length+' –≤ —Ä–∞–±–æ—Ç–µ</div></div>'+
      '<div class="metric-card"><div class="m-icon">'+(stOverdue.length?'üî¥':'üü¢')+'</div><div class="m-value" style="color:'+(stOverdue.length?'var(--red)':'var(--green)')+'">'+(stOverdue.length?stOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.':'–í —Å—Ä–æ–∫')+'</div><div class="m-label">–î–µ–¥–ª–∞–π–Ω</div></div>'+
      '<div class="metric-card"><div class="m-icon">üìà</div><div class="m-value">'+progress+'%</div><div class="m-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div><div class="m-sub" style="width:100%;height:4px;background:var(--bg4);border-radius:2px;margin-top:4px"><div style="width:'+progress+'%;height:100%;background:var(--green);border-radius:2px"></div></div></div>';
  } else {
    const avgPr = spr.length ? Math.round(spr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/spr.length) : 0;
    const pNames = sp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
    const sc = (DATA.comms||[]).filter(c => pNames.some(n => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'').includes(n)));
    document.getElementById('sp-metrics').innerHTML =
      '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+sp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
      '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+stActive.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+stDone.length+' –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div>'+
      '<div class="metric-card"><div class="m-icon">üî¥</div><div class="m-value" style="color:'+(stOverdue.length?'var(--red)':'var(--green)')+'">'+stOverdue.length+'</div><div class="m-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>'+
      '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+spr.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div><div class="m-sub">'+avgPr+'% –ø—Ä–æ–≥—Ä–µ—Å—Å</div></div>';
  }

  const content = document.getElementById('sp-content');
  let html = '';

  // ====== –°–ê–ô–¢–´ CLIENT OVERVIEW ======
  if (isCRM && currentSpTab === 'overview') {
    const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
    if (dir) {
      const eid = escA(dir['ID']||dir.id||'');
      const stage = dir['stage']||'prospect';
      const stObj = STAGES.find(s=>s.id===stage)||STAGES[0];
      const stIdx = STAGES.findIndex(s=>s.id===stage);
      const wf = getWorkflowStep(dir);
      
      // === NEXT ACTION CARD (most important!) ===
      if (stage !== 'done' && stage !== 'lost') {
        const nextActions = {
          'prospect':    { icon:'üîç', title:'–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É', desc:'–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç ‚Äî –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ', btn:'üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å ‚Üí', fn:'openClientCard(\''+eid+'\')' },
          'contact':     { icon:'üìû', title:'–ñ–¥—ë–º –æ—Ç–≤–µ—Ç', desc:'–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ 1-2 –¥–Ω—è –µ—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª', btn:'–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ‚Üí', fn:'openClientCard(\''+eid+'\')' },
          'interest':    { icon:'‚úÖ', title:'–°–æ–±–µ—Ä–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∞–π—Ç–∞', desc:'–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É', btn:'–ó–∞–ø–æ–ª–Ω–∏—Ç—å ‚Üí', fn:'openClientCard(\''+eid+'\')' },
          'proto':       { icon:'üé®', title:'–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø', desc:'–û—Ç–∫—Ä–æ–π—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ —Å–æ–∑–¥–∞–π—Ç–µ –¥–µ–º–æ-—Å–∞–π—Ç', btn:'–û—Ç–∫—Ä—ã—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä ‚Üí', fn:'showSpTab(\'sitegen\')' },
          'proposal':    { icon:'üìã', title:'–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', desc:'–ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ + –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ü–µ–Ω—É', btn:'ü§ù –ù–∞—á–∞—Ç—å –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', fn:'setDealStage(\''+eid+'\',\'negotiation\')' },
          'negotiation': { icon:'ü§ù', title:'–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', desc:'–û–±—Å—É–¥–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –∏ –∑–∞–∫—Ä–æ–π—Ç–µ —Å–¥–µ–ª–∫—É', btn:'üí∞ –ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è', fn:'setDealStage(\''+eid+'\',\'payment\')' },
          'payment':     { icon:'üí∞', title:'–ü–æ–ª—É—á–∏—Ç–µ –æ–ø–ª–∞—Ç—É –∏ —Å–¥–∞–π—Ç–µ —Å–∞–π—Ç', desc:'–ó–∞–ª–µ–π—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥ –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç—É', btn:'‚úÖ –°–∞–π—Ç —Å–¥–∞–Ω!', fn:'setDealStage(\''+eid+'\',\'done\')' }
        };
        const na = nextActions[stage] || nextActions['prospect'];
        html += '<div class="card" style="border:2px solid '+stObj.color+';margin-bottom:16px;overflow:hidden">';
        html += '<div style="padding:20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap">';
        html += '<div style="font-size:40px;line-height:1">'+na.icon+'</div>';
        html += '<div style="flex:1;min-width:200px">';
        html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">'+na.title+'</div>';
        html += '<div style="font-size:13px;color:var(--text2)">'+na.desc+'</div>';
        html += '</div>';
        const perm = getUserPerms();
        // Show action button: always for view/edit actions, only canWrite for stage changes
        const isStageChange = ['proposal','negotiation','payment'].includes(stage);
        if (!isStageChange || perm.canWrite) {
          html += '<button class="btn btn-primary" onclick="'+na.fn+'" style="font-size:14px;padding:12px 24px;white-space:nowrap">'+na.btn+'</button>';
        }
        html += '</div></div>';
      } else if (stage === 'lost') {
        html += '<div class="card" style="border:2px solid var(--red);margin-bottom:16px;padding:20px;text-align:center;background:rgba(255,75,75,.04)">';
        html += '<div style="font-size:40px;margin-bottom:8px">‚ùå</div>';
        html += '<div style="font-size:18px;font-weight:700;color:var(--red)">–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è</div>';
        html += '<div style="color:var(--text2);margin-top:4px">–ü—Ä–∏—á–∏–Ω–∞: '+esc(dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']||'–Ω–µ —É–∫–∞–∑–∞–Ω–∞')+'</div>';
        html += '<button class="btn btn-secondary" onclick="advanceToStage(\''+eid+'\',\'prospect\')" style="margin-top:12px">üîÑ –í–µ—Ä–Ω—É—Ç—å –≤ –≤–æ—Ä–æ–Ω–∫—É</button>';
        html += '</div>';
      } else {
        html += '<div class="card" style="border:2px solid var(--green);margin-bottom:16px;padding:20px;text-align:center;background:rgba(0,212,170,.04)">';
        html += '<div style="font-size:40px;margin-bottom:8px">üéâ</div>';
        html += '<div style="font-size:18px;font-weight:700;color:var(--green)">–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</div>';
        html += '<div style="color:var(--text2);margin-top:4px">–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç</div>';
        html += '</div>';
      }

      // === SITE CREATION CTA (when no site yet) ===
      const hasSite = dir['site_html'] || dir['site_url'];
      if (!hasSite && getUserPerms().canGenerateSite) {
        html += '<div class="card" style="margin-bottom:16px;padding:24px;text-align:center;border:2px dashed var(--accent);background:rgba(0,212,170,.03)">';
        html += '<div style="font-size:48px;margin-bottom:12px">üåê</div>';
        html += '<div style="font-size:18px;font-weight:700;margin-bottom:6px">–°–æ–∑–¥–∞—Ç—å —Å–∞–π—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞</div>';
        html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–°–∫–∏–Ω—å—Ç–µ AI-–∞–≥–µ–Ω—Ç—É –≤—Å—ë —á—Ç–æ –µ—Å—Ç—å –æ –∫–ª–∏–µ–Ω—Ç–µ ‚Äî –æ–Ω —Å–æ–±–µ—Ä—ë—Ç –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞—Å—Ç —Å–∞–π—Ç</div>';
        html += '<button class="btn btn-primary" onclick="showSpTab(\'client-info\')" style="font-size:15px;padding:12px 32px">ü§ñ –û—Ç–∫—Ä—ã—Ç—å AI-–∞–≥–µ–Ω—Ç</button>';
        html += '</div>';
      } else if (hasSite && dir['site_url']) {
        html += '<div class="card" style="margin-bottom:16px;padding:20px;border:2px solid var(--green);background:rgba(0,212,170,.06)">';
        html += '<div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;flex-wrap:wrap">';
        html += '<div style="font-size:40px">‚úÖ</div>';
        html += '<div style="flex:1;min-width:200px"><div style="font-size:16px;font-weight:700">–°–∞–π—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω</div>';
        html += '<a href="'+escA(dir['site_url'])+'" target="_blank" style="font-size:13px;color:var(--accent);word-break:break-all">'+esc(dir['site_url'])+'</a></div>';
        html += '</div>';
        html += '<div style="display:flex;gap:10px;flex-wrap:wrap">';
        html += '<a href="'+escA(dir['site_url'])+'" target="_blank" class="btn btn-primary" style="flex:1;min-width:180px;text-align:center;text-decoration:none;font-size:15px;padding:14px 24px">üåê –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç</a>';
        html += '<button class="btn btn-secondary" onclick="showSpTab(\'sitegen\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>';
        html += '<button class="btn btn-secondary" onclick="sendSiteToClient()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>';
        html += '</div></div>';
      }

      // === CLIENT INFO + TASK CHECKLIST (2-column layout) ===
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px" class="sp-two-col">';
      
      // Left: Client info card
      html += '<div class="card" style="padding:0;overflow:hidden">';
      html += '<div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3>üìá –ö–ª–∏–µ–Ω—Ç</h3>';
      html += '<button class="btn btn-sm btn-secondary" onclick="openClientCard(\''+eid+'\')">‚úèÔ∏è</button></div>';
      html += '<div style="padding:12px 16px">';
      const fields = [
        ['üì± –¢–µ–ª–µ—Ñ–æ–Ω', dir['–¢–µ–ª–µ—Ñ–æ–Ω']],
        ['üìç –ì–æ—Ä–æ–¥', dir['–ì–æ—Ä–æ–¥']],
        ['üåê –¢–∏–ø —Å–∞–π—Ç–∞', dir['–¢–∏–ø —Å–∞–π—Ç–∞']],
        ['üí∞ –¶–µ–Ω–∞', dir['–¶–µ–Ω–∞'] ? Number(dir['–¶–µ–Ω–∞']).toLocaleString('ru')+'‚ÇΩ' : null],
        ['üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä', dir['–ú–µ–Ω–µ–¥–∂–µ—Ä']],
        ['üíº –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞', dir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || dir['–û–ø–∏—Å–∞–Ω–∏–µ']],
        ['üí≥ –û–ø–ª–∞—Ç–∞', dir['–û–ø–ª–∞—á–µ–Ω–æ'] ? '‚úÖ –û–ø–ª–∞—á–µ–Ω' : '‚è≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω']
      ];
      fields.forEach(([label, val]) => {
        if (val) {
          html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px">';
          html += '<span style="color:var(--text2)">'+label+'</span>';
          if (label.includes('–¢–µ–ª–µ—Ñ–æ–Ω') && val) {
            const clean = val.replace(/[^\d+]/g,'');
            html += '<span><a href="tel:'+esc(clean)+'" style="color:var(--accent)">'+esc(val)+'</a></span>';
          } else if (label.includes('–û–ø–ª–∞—Ç–∞')) {
            html += '<span style="color:'+(val.includes('‚úÖ')?'var(--green)':'var(--orange)')+'">'+val+'</span>';
          } else {
            html += '<span style="font-weight:500">'+esc(val)+'</span>';
          }
          html += '</div>';
        }
      });
      if (dir['–°—Å—ã–ª–∫–∞']) {
        html += '<div style="padding:6px 0;font-size:13px"><span style="color:var(--text2)">üîó –°—Å—ã–ª–∫–∞</span> <a href="'+esc(dir['–°—Å—ã–ª–∫–∞'])+'" target="_blank" style="color:var(--accent);word-break:break-all">'+esc(dir['–°—Å—ã–ª–∫–∞'])+'</a></div>';
      }
      html += '</div></div>';
      
      // Right: Task checklist
      html += '<div class="card" style="padding:0;overflow:hidden">';
      html += '<div class="card-header"><h3>‚úÖ –ó–∞–¥–∞—á–∏ ('+stDone.length+'/'+st.length+')</h3></div>';
      html += '<div style="padding:8px 16px;max-height:300px;overflow-y:auto">';
      if (st.length) {
        // Sort: active first, then done
        const sortedTasks = [...stActive, ...stDone];
        sortedTasks.forEach(t => {
          const done = (t['–°—Ç–∞—Ç—É—Å']||'')==='–ì–æ—Ç–æ–≤–æ';
          const od = !done && t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < td;
          const tid = t['ID']||t.id;
          html += '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer;'+(done?'opacity:0.5':'')+(od?';background:rgba(255,107,107,0.05);margin:0 -16px;padding:8px 16px':'')+'" onclick="openTaskDetail(\''+escA(tid)+'\')">';
          html += '<div style="width:22px;height:22px;border-radius:6px;border:2px solid '+(done?'var(--green)':od?'var(--red)':'var(--border2)')+';display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;font-size:12px" onclick="event.stopPropagation();toggleTaskDone(\''+escA(tid)+'\')">'+(done?'‚úì':'')+'</div>';
          html += '<div style="flex:1;min-width:0">';
          html += '<div style="font-size:12px;'+(done?'text-decoration:line-through;color:var(--text3)':'')+(od?';color:var(--red)':'')+'">'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+'</div>';
          html += '<div style="font-size:10px;color:var(--text3);display:flex;gap:8px;margin-top:2px">';
          if (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) html += '<span>üë§ '+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'].split(' ')[0])+'</span>';
          if (t['–î–µ–¥–ª–∞–π–Ω']) html += '<span style="'+(od?'color:var(--red);font-weight:600':'')+'">üìÖ '+t['–î–µ–¥–ª–∞–π–Ω'].slice(5)+'</span>';
          html += '</div></div></div>';
        });
      } else {
        html += '<div style="text-align:center;padding:20px;color:var(--text3)">–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç</div>';
      }
      html += '</div></div>';
      html += '</div>'; // end 2-col
      
      // === BUDGET CARD (for –ó–∞–º / CEO) ===
      const p = getUserPerms();
      if (p.canViewFinance && dir['–¶–µ–Ω–∞']) {
        const price = Number(dir['–¶–µ–Ω–∞'])||0;
        // Calculate staff costs for this client based on individual salary_pct
        const clientTasks = (DATA.tasks||[]).filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === dir['–ù–∞–∑–≤–∞–Ω–∏–µ']);
        const assignedNames = new Set();
        clientTasks.forEach(t => { if (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) assignedNames.add(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']); });
        let staffCost = 0;
        const staffBreakdown = [];
        assignedNames.forEach(name => {
          const emp = (DATA.staff||[]).find(s => s['–ò–º—è'] === name);
          if (emp) {
            const pct = parseInt(emp['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[emp['–†–æ–ª—å']] || 0;
            const pay = Math.round(price * pct / 100);
            staffCost += pay;
            if (pct > 0) staffBreakdown.push(esc(name) + ' ' + pct + '% (' + pay.toLocaleString('ru') + '‚ÇΩ)');
          }
        });
        const profit = price - staffCost;
        html += '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>üí∞ –ë—é–¥–∂–µ—Ç —Å–¥–µ–ª–∫–∏</h3></div>';
        html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px;text-align:center">';
        html += '<div><div style="font-size:11px;color:var(--text2)">–ö–ª–∏–µ–Ω—Ç –ø–ª–∞—Ç–∏—Ç</div><div style="font-size:18px;font-weight:700">'+price.toLocaleString('ru')+'‚ÇΩ</div></div>';
        html += '<div><div style="font-size:11px;color:var(--text2)">–§–û–¢ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div><div style="font-size:18px;font-weight:700;color:var(--orange)">'+staffCost.toLocaleString('ru')+'‚ÇΩ</div></div>';
        html += '<div><div style="font-size:11px;color:var(--text2)">–ü—Ä–∏–±—ã–ª—å</div><div style="font-size:18px;font-weight:700;color:var(--green)">'+profit.toLocaleString('ru')+'‚ÇΩ</div></div>';
        html += '</div>';
        if (staffBreakdown.length) {
          html += '<div style="padding:8px 16px 16px;font-size:11px;color:var(--text2)">'+staffBreakdown.join(' ¬∑ ')+'</div>';
        }
        html += '</div>';
      }

      // === AI CHAT (quick access from overview) ===
      html += '<div class="card" style="margin-bottom:16px;padding:0;overflow:hidden">';
      html += '<div class="card-header"><h3>ü§ñ AI-–∞–≥–µ–Ω—Ç</h3></div>';
      html += '<div id="anketa-chat-container-ov-' + eid + '" style="min-height:400px"></div>';
      html += '</div>';

    } else {
      html += '<div class="empty"><div class="icon">üöÄ</div><p>–ö–ª–∏–µ–Ω—Ç ¬´'+esc(currentSubproject)+'¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ</p></div>';
    }
    
  // ====== –°–ê–ô–¢–´ CLIENT INFO (Anketa tab) ‚Äî AI Chat + Manual Form ======
  } else if (isCRM && currentSpTab === 'client-info') {
    const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
    if (dir) {
      const eid = escA(dir['ID']||dir.id||'');
      const subMode = getAnketaSubMode(eid);

      // Sub-tabs: AI-–∞–≥–µ–Ω—Ç | –†—É—á–Ω–∞—è —Ñ–æ—Ä–º–∞ | Share buttons
      html += '<div class="anketa-subtabs" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">';
      html += '<div style="display:flex;gap:4px">';
      html += '<button class="anketa-subtab'+(subMode==='ai'?' active':'')+'" onclick="_anketaSubMode.set(\''+eid+'\',\'ai\');renderSubprojectView()">ü§ñ AI-–∞–≥–µ–Ω—Ç</button>';
      html += '<button class="anketa-subtab'+(subMode==='manual'?' active':'')+'" onclick="_anketaSubMode.set(\''+eid+'\',\'manual\');renderSubprojectView()">üìù –†—É—á–Ω–∞—è —Ñ–æ—Ä–º–∞</button>';
      html += '</div>';
      html += '<div style="display:flex;gap:4px">';
      html += '<button class="anketa-subtab" onclick="generateClientLink(\'' + eid + '\')" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞">üîó –°—Å—ã–ª–∫–∞</button>';
      html += '<button class="anketa-subtab" onclick="generateClientQR(\'' + eid + '\')" title="QR-–∫–æ–¥ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞">üì± QR</button>';
      html += '</div>';
      html += '</div>';

      if (subMode === 'ai') {
        // AI Chat container ‚Äî will be rendered async
        html += '<div id="anketa-chat-container-' + eid + '" style="min-height:500px"></div>';
      } else {
        // Manual form (existing form)
        html += '<div class="card" style="padding:20px">';
        html += '<h3 style="margin-bottom:16px">üìã –ê–Ω–∫–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞: '+esc(currentSubproject)+'</h3>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="sp-two-col">';
        const anketaFields = [
          {id:'cc-biz-type', label:'–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞', val:dir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞']||dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'', type:'text', ph:'–†–µ—Å—Ç–æ—Ä–∞–Ω, —Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã...'},
          {id:'cc-phone', label:'–¢–µ–ª–µ—Ñ–æ–Ω', val:dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'', type:'tel', ph:'+7 900 123-45-67'},
          {id:'cc-city', label:'–ì–æ—Ä–æ–¥', val:dir['–ì–æ—Ä–æ–¥']||'', type:'text', ph:'–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã'},
          {id:'cc-address', label:'–ê–¥—Ä–µ—Å', val:dir['–ê–¥—Ä–µ—Å']||'', type:'text', ph:'—É–ª. –õ–µ–Ω–∏–Ω–∞ 1'},
          {id:'cc-social', label:'–°–æ—Ü—Å–µ—Ç–∏', val:dir['–°–æ—Ü—Å–µ—Ç–∏']||'', type:'text', ph:'@instagram, vk.com/...'},
          {id:'cc-telegram', label:'Telegram –∫–ª–∏–µ–Ω—Ç–∞', val:dir['Telegram']||'', type:'text', ph:'@username'},
          {id:'cc-hours', label:'–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã', val:dir['–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã']||'', type:'text', ph:'–ü–Ω-–ü—Ç 9:00-18:00'},
        ];
        anketaFields.forEach(f => {
          html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">'+f.label+'</label>';
          html += '<input id="'+f.id+'" type="'+f.type+'" value="'+escA(f.val)+'" placeholder="'+f.ph+'" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
        });
        html += '</div>';
        html += '<div style="margin-top:12px"><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–£—Å–ª—É–≥–∏ / –ú–µ–Ω—é</label>';
        html += '<textarea id="cc-services" rows="3" placeholder="–ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ –ø–æ–∑–∏—Ü–∏–∏ –º–µ–Ω—é" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;resize:vertical">'+(dir['–£—Å–ª—É–≥–∏']||'')+'</textarea></div>';
        html += '<div style="margin-top:12px"><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–¶–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏</label>';
        html += '<textarea id="cc-prices" rows="3" placeholder="–°—Ç—Ä–∏–∂–∫–∞ ‚Äî 500‚ÇΩ, –ú–∞–Ω–∏–∫—é—Ä ‚Äî 1000‚ÇΩ..." style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;resize:vertical">'+(dir['–¶–µ–Ω—ã']||'')+'</textarea></div>';
        html += '<div style="margin-top:12px"><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –¥–∏–∑–∞–π–Ω—É</label>';
        html += '<textarea id="cc-wishes" rows="2" placeholder="–¶–≤–µ—Ç–∞, —Å—Ç–∏–ª—å, —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã..." style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;resize:vertical">'+(dir['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']||'')+'</textarea></div>';
        html += '<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px">';
        html += '<div style="font-size:14px;font-weight:600;margin-bottom:12px">üìé –§–∞–π–ª—ã –¥–ª—è —Å–∞–π—Ç–∞</div>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px" class="sp-two-col">';
        html += '<div>';
        html += '<label style="font-size:11px;color:var(--text2);display:block;margin-bottom:6px">üñºÔ∏è –õ–æ–≥–æ—Ç–∏–ø</label>';
        if (dir['logo_url']) {
          html += '<div id="cc-logo-preview" style="margin-bottom:8px"><img src="'+esc(dir['logo_url'])+'" style="max-width:120px;max-height:80px;border-radius:8px;border:1px solid var(--border)"></div>';
          html += '<button class="btn btn-sm" style="margin-bottom:4px" onclick="removeAnketaFile(\''+eid+'\',\'logo\')">üóë –£–¥–∞–ª–∏—Ç—å</button><br>';
        } else {
          html += '<div id="cc-logo-preview"></div>';
        }
        html += '<input type="file" id="cc-logo-file" accept="image/*" onchange="uploadAnketaFile(\''+eid+'\',\'logo\',this)" style="font-size:12px">';
        html += '</div>';
        html += '<div>';
        html += '<label style="font-size:11px;color:var(--text2);display:block;margin-bottom:6px">üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 5)</label>';
        const photos = (() => { try { return JSON.parse(dir['photos']||'[]'); } catch(e) { return []; } })();
        html += '<div id="cc-photos-preview" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
        photos.forEach((url, i) => {
          html += '<div style="position:relative;display:inline-block">';
          html += '<img src="'+esc(url)+'" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid var(--border)">';
          html += '<button onclick="removeAnketaPhoto(\''+eid+'\','+i+')" style="position:absolute;top:-4px;right:-4px;width:18px;height:18px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center">√ó</button>';
          html += '</div>';
        });
        html += '</div>';
        if (photos.length < 5) {
          html += '<input type="file" id="cc-photos-file" accept="image/*" multiple onchange="uploadAnketaFile(\''+eid+'\',\'photos\',this)" style="font-size:12px">';
        }
        html += '</div>';
        html += '</div></div>';
        html += '<div style="margin-top:16px;display:flex;gap:8px">';
        html += '<button class="btn btn-primary" onclick="saveAnketa(\''+eid+'\')" style="flex:1">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É</button>';
        const stage = dir['stage']||'prospect';
        if (stage === 'contact') {
          html += '<button class="btn btn-secondary" onclick="advanceAnketaToProto(\''+eid+'\')" style="flex:1">üé® –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å —Å–∞–π—Ç ‚Üí</button>';
        }
        html += '</div></div>';
      }
    }

  // ====== STANDARD OVERVIEW (–†–ö–¢ etc.) ======
  } else if (!isCRM && currentSpTab === 'overview') {
    if (stOverdue.length) {
      html += '<div class="card" style="border-color:rgba(255,107,107,0.4)"><div class="card-header" style="background:rgba(255,107,107,0.05)"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+stOverdue.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th></th></tr></thead><tbody>';
      html += stOverdue.map(t => '<tr style="cursor:pointer;background:rgba(255,107,107,0.03)" onclick="openTaskDetail(\''+escA(t.ID)+'\')"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td onclick="event.stopPropagation()">'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    if (spr.length) {
      html += '<div class="card"><div class="card-header"><h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã</h3></div><div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
      html += spr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–ü–∞—Ä—Ç–Ω—ë—Ä']||'')+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    const pO = {P1:1,P2:2,P3:3};
    const topT = [...stActive].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)).slice(0,10);
    html += '<div class="card"><div class="card-header"><h3>‚úÖ –ó–∞–¥–∞—á–∏ ('+stActive.length+')</h3></div><div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += topT.length ? topT.map(t => {
      const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
      return '<tr style="cursor:pointer;'+(od?'background:rgba(255,107,107,0.03)':'')+'" onclick="openTaskDetail(\''+escA(t.ID)+'\')"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td onclick="event.stopPropagation()">'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>';
    }).join('') : emptyRow(6,'–ù–µ—Ç –∑–∞–¥–∞—á');
    html += '</tbody></table></div></div>';
    if(sp.length) {
      html += '<div class="card"><div class="card-header"><h3>ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã ('+sp.length+')</h3></div><div class="table-wrap"><table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th></tr></thead><tbody>';
      html += sp.map(p => '<tr style="cursor:pointer" onclick="viewItem(\'partner\',\''+escA(p.ID)+'\')"><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    // AI Assistant hint card
    html += '<div class="card" style="margin-top:12px;border-color:rgba(177,151,252,0.3);cursor:pointer" onclick="toggleAiPanel()">';
    html += '<div style="display:flex;align-items:center;gap:12px;padding:16px">';
    html += '<div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#b197fc,#7950f2);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">ü§ñ</div>';
    html += '<div><div style="font-size:14px;font-weight:600">AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>';
    html += '<div style="font-size:12px;color:var(--text2)">–°–ø—Ä–æ—Å–∏—Ç–µ –æ –∑–∞–¥–∞—á–∞—Ö, –ø–∞—Ä—Ç–Ω—ë—Ä–∞—Ö, –æ—Ç—á—ë—Ç–∞—Ö –ø–æ ¬´' + esc(currentSubproject) + '¬ª</div>';
    html += '</div></div></div>';
    if(!html) html = '<div class="empty"><div class="icon">üöÄ</div><p>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ¬´'+esc(currentSubproject)+'¬ª –ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ.</p></div>';

  // ====== SHARED TABS ======
  } else if (currentSpTab==='tasks') { html += renderTaskTable(st);
  } else if (currentSpTab==='partners') { html += renderPartnerTable(sp);
  } else if (currentSpTab==='projects') {
    html += '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–ë—é–¥–∂–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += spr.length ? spr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+prBadge(p['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–ü–∞—Ä—Ç–Ω—ë—Ä']||'')+'</td><td>'+esc(p['–ë—é–¥–∂–µ—Ç']||'‚Äî')+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('project',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>').join('') : emptyRow(8,'–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤');
    html += '</tbody></table></div></div>';
  } else if (currentSpTab==='comms') {
    const pNames = sp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
    const sc = (DATA.comms||[]).filter(c => pNames.some(n => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'').includes(n)));
    html += renderCommTable(sc);
  } else if (currentSpTab==='sitegen') {
    const sgCheck = getSiteGenData();
    if (sgCheck.html) siteGenStep = 'preview';
    else if (siteGenStep !== 'loading') siteGenStep = 'form';
    html += renderSiteGenerator(); 
  } else if (currentSpTab==='files') { html += renderFilesSection(); }

  // PROTECTION: Don't destroy anketa DOM while user is typing or AI is responding
  if ((currentSpTab === 'client-info' || (currentSpTab === 'overview' && currentProject === 'sites')) && (_anketaSending || _uiInputActive)) {
    return; // skip this render cycle, preserve DOM state
  }
  content.innerHTML = html;
  if (currentSpTab==='sitegen') {
    initSiteGenerator();
  }
  if (currentSpTab==='files') initFileUpload();
  // Init anketa AI chat if in AI mode
  if (currentSpTab==='client-info' && currentProject==='sites') {
    const aDir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name'])===currentSubproject && d['–ü—Ä–æ–µ–∫—Ç']===(PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
    if (aDir) {
      const aDirId = aDir['ID']||aDir.id||'';
      const aMode = getAnketaSubMode(aDirId);
      if (aMode === 'ai') {
        setTimeout(() => renderAnketaChat(aDirId, 'anketa-chat-container-' + aDirId, {}), 50);
      }
    }
  }
  // Init AI chat on site overview tab
  if (isCRM && currentSpTab === 'overview') {
    const ovDir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
    if (ovDir) {
      const ovDirId = ovDir['ID']||ovDir.id||'';
      const ovContainer = 'anketa-chat-container-ov-' + ovDirId;
      if (document.getElementById(ovContainer)) {
        setTimeout(() => renderAnketaChat(ovDirId, ovContainer, {}), 100);
      }
    }
  }
  // Load saved AI chat for site preview
  if (isCRM && siteGenStep === 'preview') {
    setTimeout(() => loadSiteAiChat(currentSubproject), 200);
  }
}

// Reusable table renderers
function renderTaskTable(data) {
  const pO = {P1:1,P2:2,P3:3};
  const sorted = [...data].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9));
  const td = today();
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
  h += sorted.length ? sorted.map(t => {
    const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
    return '<tr style="cursor:pointer;'+(od?'background:rgba(255,107,107,0.05)':'')+'" onclick="openTaskDetail(\''+escA(t.ID)+'\')">' +
      '<td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td>' +
      '<td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td>' +
      '<td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td>' +
      '<td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td>' +
      '<td>'+esc(t['–ü—Ä–æ–µ–∫—Ç']||'‚Äî')+'</td>' +
      '<td>'+(od?'<span style="color:var(--red);font-weight:700">':'')+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+(od?'</span>':'')+'</td>' +
      '<td onclick="event.stopPropagation()">'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>';
  }).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–¥–∞—á');
  h += '</tbody></table></div></div>';
  return h;
}

function renderPartnerTable(data) {
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th>Email</th><th></th></tr></thead><tbody>';
  h += data.length ? data.map(p => '<tr style="cursor:pointer" onclick="viewItem(\'partner\',\''+escA(p.ID)+'\')"><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td><td>'+esc(p['Email']||'')+'</td><td onclick="event.stopPropagation()">'+actBtns('partner',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>').join('') : emptyRow(7,'–ù–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤');
  h += '</tbody></table></div></div>';
  return h;
}

function renderCommTable(data) {
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th><th></th></tr></thead><tbody>';
  h += data.length ? data.map(c => '<tr><td><strong>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</strong></td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">'+esc(c['–†–µ–∑—É–ª—å—Ç–∞—Ç']||'')+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td><td>'+actBtns('comm',c.ID||'',c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td></tr>').join('') : emptyRow(7,'–ù–µ—Ç –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π');
  h += '</tbody></table></div></div>';
  return h;
}

// ============================================================
// RENDER: DASHBOARD (–ì–î)
// ============================================================
function renderDashboard() {
  const p = getUserPerms();
  const isCEO = USER && USER.role === 'CEO';
  
  // === CEO/–ó–∞–º KPI PANEL ===
  if (isCEO || USER.role === '–ó–∞–º') {
    try {
      var allDirs = DATA.directions || [];
      var siteDirs = allDirs.filter(function(d) { return d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'); });
      var totalLeads = siteDirs.length;
      var wonDeals = siteDirs.filter(function(d) { return d.stage === 'done'; }).length;
      var lostDeals = siteDirs.filter(function(d) { return d.stage === 'lost'; }).length;
      var activeDeals = totalLeads - wonDeals - lostDeals;
      var convRate = totalLeads > 0 ? ((wonDeals / totalLeads) * 100).toFixed(1) : '0.0';
      var revenue = siteDirs.filter(function(d) { return d.stage === 'done'; }).reduce(function(s, d) { return s + (parseFloat(d['–¶–µ–Ω–∞']) || 0); }, 0);
      var todayDate = new Date().toISOString().split('T')[0];
      var overdueFollowups = siteDirs.filter(function(d) {
        return d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] < todayDate && ['done','lost'].indexOf(d.stage) < 0;
      });
      var kpi = '<div style="background:linear-gradient(135deg,var(--bg3),var(--bg2));border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px">';
      kpi += '<h3 style="font-size:15px;margin-bottom:16px;color:var(--text2)">üìä KPI –ü—Ä–æ–¥–∞–∂–∏ (–°–∞–π—Ç—ã)</h3>';
      kpi += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px" class="metrics">';
      kpi += '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--accent)">' + totalLeads + '</div><div style="font-size:12px;color:var(--text2)">–í—Å–µ–≥–æ</div></div>';
      kpi += '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--blue,#4babf7)">' + activeDeals + '</div><div style="font-size:12px;color:var(--text2)">–í —Ä–∞–±–æ—Ç–µ</div></div>';
      kpi += '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--green,#4ecdc4)">' + wonDeals + '</div><div style="font-size:12px;color:var(--text2)">–ó–∞–∫—Ä—ã—Ç–æ</div></div>';
      kpi += '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--yellow,#ffe66d)">' + convRate + '%</div><div style="font-size:12px;color:var(--text2)">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div></div>';
      kpi += '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--purple,#a855f7)">' + (typeof fmtMoney === "function" ? fmtMoney(revenue) : revenue.toLocaleString('ru-RU') + ' \u20BD') + '</div><div style="font-size:12px;color:var(--text2)">–í—ã—Ä—É—á–∫–∞</div></div>';
      kpi += '</div>';
      if (overdueFollowups.length > 0) {
        kpi += '<div style="margin-top:16px;padding:12px;background:rgba(255,107,107,0.1);border-radius:10px;border:1px solid rgba(255,107,107,0.2)">';
        kpi += '<span style="color:var(--red,#ff6b6b);font-weight:600">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö follow-up: ' + overdueFollowups.length + '</span>';
        kpi += '</div>';
      }
      // Per-stage funnel bars
      if (totalLeads > 0) {
        kpi += '<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px">';
        kpi += '<div style="font-size:12px;color:var(--text2);margin-bottom:10px;font-weight:600">üìä –í–æ—Ä–æ–Ω–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º</div>';
        STAGES.filter(function(s) { return s.id !== 'lost'; }).forEach(function(s) {
          var cnt = siteDirs.filter(function(d) { return (d['stage']||'prospect') === s.id; }).length;
          var pct = totalLeads > 0 ? Math.round(cnt / totalLeads * 100) : 0;
          kpi += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px">';
          kpi += '<div style="font-size:11px;color:var(--text2);width:110px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + s.name + '</div>';
          kpi += '<div style="flex:1;height:5px;background:var(--bg);border-radius:3px"><div style="width:' + pct + '%;height:100%;background:' + s.color + ';border-radius:3px;transition:width .3s"></div></div>';
          kpi += '<div style="font-size:11px;color:var(--text3);width:24px;text-align:right">' + cnt + '</div>';
          kpi += '</div>';
        });
        kpi += '</div>';
      }
      // Average deal cycle
      var closedWithDates = siteDirs.filter(function(d) { return d['stage'] === 'done' && (d['–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'] || d['–°–æ–∑–¥–∞–Ω'] || d['created_at']); });
      if (closedWithDates.length > 0) {
        var avgDays = Math.round(closedWithDates.reduce(function(sum, d) {
          var created = new Date(d['–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'] || d['–°–æ–∑–¥–∞–Ω'] || d['created_at']);
          return sum + (isNaN(created.getTime()) ? 30 : Math.max(1, Math.round((Date.now() - created.getTime()) / 86400000)));
        }, 0) / closedWithDates.length);
        kpi += '<div style="margin-top:8px;font-size:12px;color:var(--text2)">‚è± –°—Ä–µ–¥–Ω–∏–π —Ü–∏–∫–ª —Å–¥–µ–ª–∫–∏: <b style="color:var(--accent)">' + avgDays + ' –¥–Ω–µ–π</b></div>';
      }
      kpi += '</div>';
      var dashEl = document.getElementById('dashboardPage');
      if (dashEl) {
        var existing = dashEl.querySelector('.ceo-kpi-panel');
        if (existing) existing.remove();
        var div = document.createElement('div');
        div.className = 'ceo-kpi-panel';
        div.innerHTML = kpi;
        dashEl.prepend(div);
      }
    } catch(e) { console.warn('KPI render error:', e); }
  }
  
  // Filter data by user's scope
  let fp = filterByRole(DATA.partners);
  let ft = filterByRole(DATA.tasks);
  let fpr = filterByRole(DATA.projects);
  let fDirs = DATA.directions || [];
  
  // Non-CEO: filter by their direction/project
  if (!isCEO && USER && USER.direction && USER.direction !== '–í—Å–µ') {
    fp = fp.filter(x => (x['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === USER.direction || !x['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']);
    ft = ft.filter(x => (x['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === USER.direction || (x['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'') === USER.name);
    fpr = fpr.filter(x => (x['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === USER.direction);
    fDirs = fDirs.filter(x => {
      // Find if this direction belongs to user's project
      const projKey = Object.keys(PROJECTS).find(k => PROJECTS[k].name === USER.direction || getProjectDirs(k).includes(USER.direction));
      return projKey ? getProjectDirs(projKey).includes(x['–ù–∞–∑–≤–∞–Ω–∏–µ']) : true;
    });
  }
  // –ú–µ–Ω–µ–¥–∂–µ—Ä/–°–æ—Ç—Ä—É–¥–Ω–∏–∫: only their own tasks
  if (p.level <= 1 && USER) {
    ft = ft.filter(t => (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(USER.name));
  }
  
  const td = today();
  const active = ft.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const overdue = active.filter(t => t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td);

  // Dashboard title based on role
  const dashTitle = isCEO ? '–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã' : (USER?.direction || '–ú–æ–∏ –∑–∞–¥–∞—á–∏');
  
  document.getElementById('dash-metrics').innerHTML =
    (isCEO ? '<div class="metric-card"><div class="m-icon">üè¢</div><div class="m-value">'+Object.keys(PROJECTS).length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>' : '') +
    (p.level >= 3 ? '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+fp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div><div class="m-sub">'+fp.filter(x=>x['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π').length+' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>' : '') +
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+active.length+'</div><div class="m-label">'+(p.level<=1?'–ú–æ–∏ –∑–∞–¥–∞—á–∏':'–ó–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ')+'</div><div class="m-sub">'+(overdue.length?'üî¥ '+overdue.length+' –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ':'–≤—Å—ë –≤ —Å—Ä–æ–∫')+'</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+fpr.length+'</div><div class="m-label">–ü–æ–¥–ø—Ä–æ–µ–∫—Ç–æ–≤</div></div>'+
    (p.canManageStaff ? '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+DATA.staff.filter(s=>(s['–°—Ç–∞—Ç—É—Å']||'–ê–∫—Ç–∏–≤–Ω—ã–π')!=='–û–∂–∏–¥–∞–µ—Ç'&&s['–°—Ç–∞—Ç—É—Å']!=='‚ùå –£–¥–∞–ª—ë–Ω').length+'</div><div class="m-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div></div>' : '');

  // Revenue chart ‚Äî CEO/–ó–∞–º only
  const rchEl = document.getElementById('dash-revenue-chart');
  if (rchEl) rchEl.innerHTML = (p.level >= 3) ? renderRevenueChart() : '';

  // Pipeline summary ‚Äî based on user's visible directions
  const sDirs = fDirs.filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  const pEl = document.getElementById('dash-pipeline-summary');
  if (pEl && sDirs.length) {
    const tPipe = sDirs.filter(d=>(d['stage']||'prospect')!=='done').reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
    const tPaid = sDirs.filter(d=>d['–û–ø–ª–∞—á–µ–Ω–æ']).reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
    pEl.innerHTML = '<div class="card" style="padding:16px 20px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><h4 style="font-size:14px;font-weight:600">üîÑ –í–æ—Ä–æ–Ω–∫–∞</h4><a onclick="showPage(\'kanban\')" style="font-size:12px;color:var(--accent);cursor:pointer">Kanban ‚Üí</a></div>' +
      '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">' + STAGES.map(s => {
        const cnt = sDirs.filter(d=>(d['stage']||'prospect')===s.id).length;
        return cnt ? '<span style="padding:3px 10px;border-radius:12px;background:var(--bg);font-size:11px;color:var(--text2)">'+s.name+' <b>'+cnt+'</b></span>' : '';
      }).join('') + '</div>' +
      '<div style="font-size:12px;color:var(--text2)">üí∞ –ü–æ–ª—É—á–µ–Ω–æ: <b style="color:var(--green)">'+tPaid.toLocaleString('ru')+'‚ÇΩ</b> ¬∑ –í —Ä–∞–±–æ—Ç–µ: <b style="color:var(--accent)">'+tPipe.toLocaleString('ru')+'‚ÇΩ</b></div></div>';
  } else if (pEl) { pEl.innerHTML = ''; }

  // MY EARNINGS ‚Äî show for all employees (FIX 12)
  const earningsEl = document.getElementById('dash-earnings');
  if (earningsEl && USER) {
    // Use individual salary_pct for current user
    const myStaff = (DATA.staff||[]).find(s => s['–ò–º—è'] === USER.name);
    const myPct = myStaff ? (parseInt(myStaff['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[myStaff['–†–æ–ª—å']] || 0) : 0;
    const myDeals = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç']===(PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã') && d['–û–ø–ª–∞—á–µ–Ω–æ'] && d['–ú–µ–Ω–µ–¥–∂–µ—Ä'] === USER.name);
    const myTotal = myDeals.reduce((s,d) => {
      const price = Number(d['–¶–µ–Ω–∞'])||0;
      return s + Math.round(price * myPct / 100);
    }, 0);
    const myPending = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç']===(PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã') && !d['–û–ø–ª–∞—á–µ–Ω–æ'] && d['–ú–µ–Ω–µ–¥–∂–µ—Ä'] === USER.name);
    const pendingTotal = myPending.reduce((s,d) => {
      const price = Number(d['–¶–µ–Ω–∞'])||0;
      return s + Math.round(price * myPct / 100);
    }, 0);
    
    if (myDeals.length || myPending.length) {
      earningsEl.innerHTML = '<div class="card" style="padding:16px 20px"><h4 style="font-size:14px;font-weight:600;margin-bottom:10px">üí∞ –ú–æ–∏ –¥–æ—Ö–æ–¥—ã</h4>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
        '<div style="text-align:center;padding:12px;background:rgba(0,212,170,0.08);border-radius:8px"><div style="font-size:11px;color:var(--text2)">‚úÖ –ü–æ–ª—É—á–µ–Ω–æ</div><div style="font-size:22px;font-weight:700;color:var(--green)">'+myTotal.toLocaleString('ru')+'‚ÇΩ</div><div style="font-size:11px;color:var(--text3)">'+myDeals.length+' —Å–¥–µ–ª–æ–∫</div></div>' +
        '<div style="text-align:center;padding:12px;background:rgba(255,170,0,0.08);border-radius:8px"><div style="font-size:11px;color:var(--text2)">‚è≥ –û–∂–∏–¥–∞–µ—Ç—Å—è</div><div style="font-size:22px;font-weight:700;color:var(--orange)">'+pendingTotal.toLocaleString('ru')+'‚ÇΩ</div><div style="font-size:11px;color:var(--text3)">'+myPending.length+' –≤ —Ä–∞–±–æ—Ç–µ</div></div>' +
        '</div></div>';
    } else {
      earningsEl.innerHTML = '';
    }
  }

  // Overdue table
  document.getElementById('dash-overdue').innerHTML = overdue.length ? overdue.map(t =>
    '<tr style="background:rgba(255,107,107,0.03)"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>'
  ).join('') : emptyRow(6,'–ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á üéâ');

  // Active projects
  const ap = fpr.filter(p => (p['–°—Ç–∞—Ç—É—Å']||'')!=='–ó–∞–≤–µ—Ä—à—ë–Ω').slice(0,10);
  document.getElementById('dash-projects').innerHTML = ap.length ? ap.map(p =>
    '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>'
  ).join('') : emptyRow(5,'–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤');

  // Recent comms
  const rc = (DATA.comms||[]).slice(0,5);
  document.getElementById('dash-comms').innerHTML = rc.length ? rc.map(c =>
    '<tr><td>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td></tr>'
  ).join('') : emptyRow(5,'–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π');
}

// ============================================================
// RENDER: GLOBAL PAGES (Partners, Tasks, Staff, Approvals, Comms, Settings)
// ============================================================
function renderPartnerFilters() {
  const allDirs = ['–í—Å–µ', ...new Set(DATA.partners.map(i=>i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']).filter(Boolean))];
  const el = document.getElementById('partner-filters');
  if(el) el.innerHTML = allDirs.map(d => '<button class="filter-chip '+(currentFilters.partners===d?'active':'')+'" onclick="currentFilters.partners=\''+escA(d)+'\';renderAll()">'+esc(d)+'</button>').join('');
}

function renderTaskFilters() {
  const allDirs = ['–í—Å–µ', ...new Set(DATA.tasks.map(i=>i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']).filter(Boolean))];
  const el = document.getElementById('task-filters');
  if(el) el.innerHTML = allDirs.map(d => '<button class="filter-chip '+(currentFilters.tasks===d?'active':'')+'" onclick="currentFilters.tasks=\''+escA(d)+'\';renderTasks()">'+esc(d)+'</button>').join('');
  
  // Populate person dropdown
  const personEl = document.getElementById('task-filter-person');
  if (personEl) {
    const people = ['–í—Å–µ', ...new Set(DATA.tasks.map(t=>t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']).filter(Boolean))];
    const current = personEl.value;
    personEl.innerHTML = people.map(p => '<option value="'+esc(p)+'"'+(p===current?' selected':'')+'>'+esc(p==='–í—Å–µ'?'üë§ –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏':p)+'</option>').join('');
  }
}

// ============================================================
// CLIENTS PAGE ‚Äî Global view of all directions/clients
// ============================================================
function renderClientsPage(projectFilter) {
  var dirs = filterByRole(DATA.directions || []);

  // Apply filters
  var projFilter = projectFilter || (document.getElementById('clientsFilterProject') ? document.getElementById('clientsFilterProject').value : '');
  var stageFilter = document.getElementById('clientsFilterStage') ? document.getElementById('clientsFilterStage').value : '';
  var managerFilter = document.getElementById('clientsFilterManager') ? document.getElementById('clientsFilterManager').value : '';
  var searchTerm = document.getElementById('clientsSearch') ? document.getElementById('clientsSearch').value.trim().toLowerCase() : '';

  if (projFilter) dirs = dirs.filter(function(d) { return (d['–ü—Ä–æ–µ–∫—Ç'] || d.project) === projFilter; });
  if (stageFilter) dirs = dirs.filter(function(d) { return (d.stage || d['stage']) === stageFilter; });
  if (managerFilter) dirs = dirs.filter(function(d) { return (d['–ú–µ–Ω–µ–¥–∂–µ—Ä'] || d.manager) === managerFilter; });
  if (searchTerm) {
    dirs = dirs.filter(function(d) {
      var searchFields = [d['–ù–∞–∑–≤–∞–Ω–∏–µ'] || d.name, d['–¢–µ–ª–µ—Ñ–æ–Ω'] || d.phone, d['Telegram'] || d.telegram_tag, d['–ì–æ—Ä–æ–¥'] || d.city, d['–¢–∏–ø —Å–∞–π—Ç–∞'] || d.site_type, d['–û–ø–∏—Å–∞–Ω–∏–µ'] || d.description].join(' ').toLowerCase();
      return searchFields.indexOf(searchTerm) !== -1;
    });
  }

  // Populate manager filter
  var managerSelect = document.getElementById('clientsFilterManager');
  if (managerSelect && !managerSelect._populated) {
    var managers = {};
    (DATA.directions || []).forEach(function(d) {
      var m = d['–ú–µ–Ω–µ–¥–∂–µ—Ä'] || d.manager;
      if (m) managers[m] = true;
    });
    Object.keys(managers).sort().forEach(function(m) {
      var opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      managerSelect.appendChild(opt);
    });
    managerSelect._populated = true;
  }

  // Stats
  var statsEl = document.getElementById('clientsStats');
  if (statsEl) {
    var total = dirs.length;
    var newCount = dirs.filter(function(d) { return (d.stage || '') === 'prospect' || (d['–°—Ç–∞—Ç—É—Å'] || '') === '–ù–æ–≤—ã–π'; }).length;
    var activeCount = dirs.filter(function(d) { var s = d.stage || ''; return s !== 'completed' && s !== 'rejected' && s !== 'prospect'; }).length;
    var completedCount = dirs.filter(function(d) { return (d.stage || '') === 'completed'; }).length;
    var totalPrice = dirs.reduce(function(sum, d) { return sum + (Number(d['–¶–µ–Ω–∞'] || d.price) || 0); }, 0);

    statsEl.innerHTML = '<div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;text-align:center"><div style="font-size:20px;font-weight:800;color:var(--accent)">' + total + '</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–í—Å–µ–≥–æ</div></div>' +
      '<div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;text-align:center"><div style="font-size:20px;font-weight:800;color:var(--blue)">' + newCount + '</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–ù–æ–≤—ã—Ö</div></div>' +
      '<div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;text-align:center"><div style="font-size:20px;font-weight:800;color:var(--green)">' + activeCount + '</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div></div>' +
      '<div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;text-align:center"><div style="font-size:20px;font-weight:800;color:var(--orange)">' + totalPrice.toLocaleString('ru') + '‚ÇΩ</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–°—É–º–º–∞</div></div>';
  }

  // Update badge
  var badge = document.getElementById('badge-clients');
  if (badge) badge.textContent = dirs.length;

  // Table
  var tableEl = document.getElementById('clientsTable');
  if (!tableEl) return;

  if (dirs.length === 0) {
    tableEl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)">–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤' + (searchTerm ? ' –ø–æ –∑–∞–ø—Ä–æ—Å—É "' + searchTerm + '"' : '') + '</div>';
    return;
  }

  // Stage labels
  var STAGE_LABELS = { prospect: 'üîç –ü–æ–∏—Å–∫', contact: 'üìû –ö–æ–Ω—Ç–∞–∫—Ç', proposal: 'üìÑ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', negotiation: 'ü§ù –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', contract: 'üìã –î–æ–≥–æ–≤–æ—Ä', prepayment: 'üí≥ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞', production: '‚öôÔ∏è –†–∞–±–æ—Ç–∞', completed: '‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω', rejected: '‚ùå –û—Ç–∫–∞–∑' };

  var html = '<div class="table-wrap"><table class="data-table" style="width:100%;border-collapse:collapse;font-size:13px;min-width:700px">';
  html += '<thead><tr style="border-bottom:2px solid var(--border);text-align:left">';
  html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ö–ª–∏–µ–Ω—Ç</th>';
  html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>';
  html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ü—Ä–æ–µ–∫—Ç</th>';
  html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–¢–∏–ø</th>';
  html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–°—Ç–∞–¥–∏—è</th>';
  html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–¶–µ–Ω–∞</th>';
  html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ú–µ–Ω–µ–¥–∂–µ—Ä</th>';
  html += '</tr></thead><tbody>';

  dirs.sort(function(a, b) { return (b.created_at || '').localeCompare(a.created_at || ''); });

  dirs.forEach(function(d) {
    var name = d['–ù–∞–∑–≤–∞–Ω–∏–µ'] || d.name || '‚Äî';
    var phone = d['–¢–µ–ª–µ—Ñ–æ–Ω'] || d.phone || '';
    var tg = d['Telegram'] || d.telegram_tag || '';
    var project = d['–ü—Ä–æ–µ–∫—Ç'] || d.project || '';
    var siteType = d['–¢–∏–ø —Å–∞–π—Ç–∞'] || d.site_type || '‚Äî';
    var stage = d.stage || 'prospect';
    var stageLabel = STAGE_LABELS[stage] || stage;
    var price = Number(d['–¶–µ–Ω–∞'] || d.price) || 0;
    var manager = d['–ú–µ–Ω–µ–¥–∂–µ—Ä'] || d.manager || '‚Äî';
    var id = d.id || d.ID;

    html += '<tr style="border-bottom:1px solid var(--border);cursor:pointer;transition:background .2s" onclick="' + (typeof openSlideOver === 'function' ? 'openSlideOver(\'' + id + '\')' : '') + '" onmouseover="this.style.background=\'var(--bg3)\'" onmouseout="this.style.background=\'\'">';
    html += '<td style="padding:10px 8px;font-weight:600">' + esc(name) + '</td>';
    html += '<td style="padding:10px 8px"><div>' + (phone ? 'üìû ' + esc(phone) : '') + '</div>' + (tg ? '<div style="color:var(--accent);font-size:12px">üí¨ ' + esc(tg) + '</div>' : '') + '</td>';
    html += '<td style="padding:10px 8px">' + esc(project) + '</td>';
    html += '<td style="padding:10px 8px">' + esc(siteType) + '</td>';
    html += '<td style="padding:10px 8px"><span style="font-size:12px">' + stageLabel + '</span></td>';
    html += '<td style="padding:10px 8px;font-weight:600">' + (price ? price.toLocaleString('ru') + '‚ÇΩ' : '‚Äî') + '</td>';
    html += '<td style="padding:10px 8px;color:var(--text2)">' + esc(manager) + '</td>';
    html += '</tr>';
  });

  html += '</tbody></table></div>';
  tableEl.innerHTML = html;
}

function renderPartners() {
  let d = filterByRole(DATA.partners);
  d = filterByDir(d, currentFilters.partners==='–í—Å–µ'?null:currentFilters.partners);
  d = filterBySearch(d,'partner-search',['–ù–∞–∑–≤–∞–Ω–∏–µ','–°—Ç—Ä–∞–Ω–∞','–ü—Ä–æ–¥—É–∫—Ç','–ö–æ–Ω—Ç–∞–∫—Ç']);
  document.getElementById('partners-table').innerHTML = d.length ? d.map(p =>
    '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td><td>'+actBtns('partner',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>'
  ).join('') : emptyRow(7,'üë• –ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤',getUserPerms().canEditPartners?{label:'+ –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞',action:"openModal('partner')"}:null);
}

function renderTasks() {
  renderTaskFilters();
  let d = filterByRole(DATA.tasks);
  d = filterByDir(d, currentFilters.tasks==='–í—Å–µ'?null:currentFilters.tasks);
  d = filterBySearch(d,'task-search',['–û–ø–∏—Å–∞–Ω–∏–µ','–ù–∞–∑–≤–∞–Ω–∏–µ','–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π','–ü—Ä–æ–µ–∫—Ç']);
  
  // Status filter
  const statusFilter = document.getElementById('task-filter-status')?.value || 'active';
  if (statusFilter === 'active') d = d.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'') !== '‚úÖ –ì–æ—Ç–æ–≤–æ' && (t['–°—Ç–∞—Ç—É—Å']||'') !== '–ì–æ—Ç–æ–≤–æ');
  else if (statusFilter !== '–í—Å–µ') d = d.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'').includes(statusFilter.replace(/[^–∞-—è–ê-–Ø\s]/g,'').trim()));
  
  // Person filter
  const personFilter = document.getElementById('task-filter-person')?.value || '–í—Å–µ';
  if (personFilter !== '–í—Å–µ') d = d.filter(t => (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'') === personFilter);
  
  const pO = {P1:1,P2:2,P3:3};
  d = [...d].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9));
  const td = today();
  
  document.getElementById('tasks-table').innerHTML = d.length ? d.map((t,idx) => {
    const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ'&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='‚úÖ –ì–æ—Ç–æ–≤–æ';
    return '<tr style="cursor:pointer;'+(od?'background:rgba(255,107,107,0.05)':'') +'" onclick="openTaskDetail(\''+escA(t.ID)+'\')">' +
      '<td style="color:var(--text2);font-size:12px;text-align:center">'+(idx+1)+'</td>' +
      '<td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td>' +
      '<td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td>' +
      '<td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td>' +
      '<td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td>' +
      '<td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td>' +
      '<td>'+(od?'<span style="color:var(--red);font-weight:700">':'')+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+(od?'</span>':'')+'</td>' +
      '<td onclick="event.stopPropagation()">'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>';
  }).join('') : emptyRow(8,'üìã –ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç',getUserPerms().canEditTasks?{label:'+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É',action:"openModal('task')"}:null);

  // Gantt chart
  const ganttEl = document.getElementById('task-gantt');
  if (ganttEl) {
    const showGantt = document.getElementById('task-show-gantt')?.checked;
    ganttEl.innerHTML = showGantt ? renderTimeline(d) : '';
  }
}

// ============================================================
// TASK COMMENTS & QUICK STATUS HELPERS
// ============================================================

async function loadTaskComments(taskId) {
  const el = document.getElementById('task-comments-list');
  if (!el) return;

  const comments = getTaskComments(taskId);
  if (!comments.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--text2);font-size:12px;padding:16px">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
    return;
  }
  el.innerHTML = comments.map(c => {
    return '<div style="padding:8px;background:var(--bg2);border-radius:8px;margin-bottom:6px">' +
      '<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:4px">' +
      '<strong>' + esc(c.author) + '</strong>' +
      '<span>' + esc(c.date) + '</span></div>' +
      '<div style="font-size:13px">' + esc(c.text) + '</div></div>';
  }).join('');
  el.scrollTop = el.scrollHeight;
}

function getTaskComments(taskId) {
  try {
    return JSON.parse(localStorage.getItem('rkt_task_comments_' + taskId) || '[]');
  } catch(e) { return []; }
}

function saveTaskComments(taskId, comments) {
  localStorage.setItem('rkt_task_comments_' + taskId, JSON.stringify(comments));
}

async function addTaskComment() {
  const input = document.getElementById('task-comment-input');
  if (!input) return;
  const text = input.value.trim();
  if (!text || !currentTaskId) return;

  const comment = {
    author: USER ? USER.name : '–ê–Ω–æ–Ω–∏–º',
    text: text,
    date: new Date().toLocaleString('ru-RU', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})
  };

  const comments = getTaskComments(currentTaskId);
  comments.push(comment);
  saveTaskComments(currentTaskId, comments);

  input.value = '';
  loadTaskComments(currentTaskId);

  // Also try to save to Supabase (task_comments table if exists)
  try {
    await SB.from('task_comments').insert({
      task_id: currentTaskId,
      author: comment.author,
      text: comment.text,
      created_at: new Date().toISOString()
    });
  } catch(e) { /* table may not exist yet, localStorage is fallback */ }
}

async function quickChangeTaskStatus(taskId, newStatus) {
  const task = DATA.tasks.find(t => t.ID === taskId || t.id === taskId);
  if (!task) return;

  const row = Object.assign({}, task);
  row['–°—Ç–∞—Ç—É—Å'] = newStatus;

  const ok = await apiWrite('–ó–∞–¥–∞—á–∏', row);
  if (ok) {
    toast('–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω: ' + newStatus, 'success');
    task['–°—Ç–∞—Ç—É—Å'] = newStatus;
    if (newStatus === '‚úÖ –ì–æ—Ç–æ–≤–æ') {
      autoDelegate(task);
    }
    openTaskDetail(taskId);
    renderTasks();
  } else {
    toast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞','error');
  }
}

// ============================================================
// TASK DOCUMENTS (upload/list in task detail)
// ============================================================
async function loadTaskDocuments(taskId) {
  const el = document.getElementById('task-docs-list');
  if (!el) return;

  // Find documents linked to this task (by task_id field or by folder matching task ID)
  const taskDocs = (DATA.documents || []).filter(d =>
    (d.task_id === taskId) || (d.folder === 'task_' + taskId)
  );

  if (!taskDocs.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--text2);font-size:12px;padding:12px">–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>';
    return;
  }

  el.innerHTML = taskDocs.map(d => {
    const ext = (d.filename || '').split('.').pop().toLowerCase();
    const icon = {pdf:'üìÑ',doc:'üìù',docx:'üìù',xls:'üìä',xlsx:'üìä',png:'üñº',jpg:'üñº',jpeg:'üñº',gif:'üñº'} [ext] || 'üìÅ';
    return '<div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg2);border-radius:8px;margin-bottom:6px">' +
      '<span style="font-size:20px">' + icon + '</span>' +
      '<div style="flex:1;min-width:0">' +
      '<div style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + esc(d.filename || '–î–æ–∫—É–º–µ–Ω—Ç') + '</div>' +
      '<div style="font-size:11px;color:var(--text2)">' + esc(d.upload_date || '') + ' ‚Ä¢ ' + esc(d.size || '') + ' ‚Ä¢ ' + esc(d.uploaded_by || '') + '</div>' +
      '</div>' +
      (d.link ? '<a href="' + escA(d.link) + '" target="_blank" class="btn btn-sm btn-secondary" style="flex-shrink:0">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</a>' : '') +
      '</div>';
  }).join('');
}

async function uploadTaskDocuments(taskId) {
  const fileInput = document.getElementById('task-doc-file');
  if (!fileInput || !fileInput.files.length) return;

  const files = Array.from(fileInput.files);
  const maxSize = 10 * 1024 * 1024; // 10MB

  for (const file of files) {
    if (file.size > maxSize) {
      toast('–§–∞–π–ª "' + file.name + '" –ø—Ä–µ–≤—ã—à–∞–µ—Ç 10 –ú–ë', 'error');
      continue;
    }

    toast('üì§ –ó–∞–≥—Ä—É–∑–∫–∞: ' + file.name + '...', 'info');
    try {
      const timestamp = Date.now();
      const safeName = translitCyr(file.name).replace(/[^a-zA-Z0-9._-]/g, '_');
      const storagePath = 'documents/tasks/' + taskId + '/' + safeName;

      const { data, error } = await SB.storage.from('documents').upload(storagePath, file, {
        contentType: file.type || 'application/octet-stream',
        upsert: true
      });
      if (error) throw error;

      const { data: urlData } = SB.storage.from('documents').getPublicUrl(storagePath);
      const publicUrl = urlData?.publicUrl || '';

      // Save document record
      const docRow = {
        id: 'TD' + timestamp.toString(36).toUpperCase(),
        filename: file.name,
        folder: 'task_' + taskId,
        task_id: taskId,
        uploaded_by: USER?.name || '–ê–Ω–æ–Ω–∏–º',
        upload_date: new Date().toISOString().split('T')[0],
        link: publicUrl,
        size: formatFileSize(file.size),
        direction: '',
        project: ''
      };

      // Try to get task's project/direction
      const task = DATA.tasks.find(t => t.ID === taskId || t.id === taskId);
      if (task) {
        docRow.direction = task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
        docRow.project = task['–ü—Ä–æ–µ–∫—Ç'] || '';
      }

      await SB.from('documents').insert(docRow);
      if (!DATA.documents) DATA.documents = [];
      DATA.documents.push(docRow);

      toast('‚úÖ ' + file.name + ' –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
    } catch(e) {
      console.error('Upload task doc error:', e);
      toast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, 'error');
    }
  }

  fileInput.value = '';
  loadTaskDocuments(taskId);
}

// ============================================================
// TIMELINE / GANTT CHART
// ============================================================
function renderTimeline(tasks, directions) {
  // GANTT CHART: rows = clients/directions, columns = days, bars = tasks
  const p = getUserPerms();
  const userName = USER ? (USER.name || USER['–ò–º—è'] || '') : '';
  const allDirs = (directions || DATA.directions || []).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  const allTasks = (tasks || DATA.tasks || []).filter(t => t['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));

  if (!allTasks.length && !allDirs.length) {
    return '<div class="card" style="padding:20px;text-align:center;color:var(--text2)"><div style="font-size:32px;margin-bottom:8px">üìÖ</div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Gantt-–≥—Ä–∞—Ñ–∏–∫–∞</div>';
  }

  // Filter by role: CEO/–ó–∞–º see all, others see only their tasks
  let visibleDirs = allDirs;
  if (!p.seeAll && p.level < 3 && userName) {
    const myDirNames = new Set();
    allTasks.forEach(t => {
      if ((t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(userName)) myDirNames.add(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'');
    });
    visibleDirs = allDirs.filter(d => myDirNames.has(d['–ù–∞–∑–≤–∞–Ω–∏–µ']||''));
  }

  // Exclude done/lost if not many
  const activeDirs = visibleDirs.filter(d => !['done','lost'].includes(d['stage']||'prospect'));
  const displayDirs = activeDirs.length > 0 ? activeDirs : visibleDirs;

  if (!displayDirs.length) {
    return '<div class="card" style="padding:20px;text-align:center;color:var(--text2)"><div style="font-size:32px;margin-bottom:8px">üìÖ</div>–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è' +
      (p.level < 3 ? '<br><span style="font-size:12px">–ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç—ã —Å –≤–∞—à–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏</span>' : '') + '</div>';
  }

  const td = today();
  const tdDate = new Date(td);
  // Date range: 7 days before today ‚Üí 30 days after
  const rangeStart = new Date(tdDate); rangeStart.setDate(rangeStart.getDate() - 7);
  const rangeEnd = new Date(tdDate); rangeEnd.setDate(rangeEnd.getDate() + 35);
  const totalDays = Math.ceil((rangeEnd - rangeStart) / 86400000);

  // Generate day columns
  const days = [];
  for (let dd = new Date(rangeStart); dd <= rangeEnd; dd.setDate(dd.getDate() + 1)) {
    days.push(new Date(dd));
  }

  // Week markers
  const weeks = [];
  const monthNames = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
  days.forEach((dd, i) => {
    if (dd.getDay() === 1 || i === 0) {
      weeks.push({ idx: i, label: dd.getDate() + ' ' + monthNames[dd.getMonth()] });
    }
  });

  const todayIdx = days.findIndex(dd => dd.toISOString().slice(0,10) === td);
  const cellW = 28;
  const labelW = 180;
  const gridW = days.length * cellW;

  const statusColors = {
    '–ì–æ—Ç–æ–≤–æ': '#00d4aa', '‚úÖ –ì–æ—Ç–æ–≤–æ': '#00d4aa',
    '–í —Ä–∞–±–æ—Ç–µ': '#4dabf7', 'üîÑ –í —Ä–∞–±–æ—Ç–µ': '#4dabf7',
    '–ù–æ–≤–∞—è': '#ffa94d', '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞': '#ff6b6b'
  };

  let h = '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3>üìÖ Gantt-–≥—Ä–∞—Ñ–∏–∫</h3>';
  h += '<div style="display:flex;gap:8px;font-size:11px">';
  h += '<span style="color:#00d4aa">‚óè –ì–æ—Ç–æ–≤–æ</span>';
  h += '<span style="color:#4dabf7">‚óè –í —Ä–∞–±–æ—Ç–µ</span>';
  h += '<span style="color:#ffa94d">‚óè –ù–æ–≤–∞—è</span>';
  h += '<span style="color:#ff6b6b">‚óè –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞</span>';
  h += '</div></div>';
  h += '<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;padding:0 0 12px">';
  h += '<div style="display:grid;grid-template-columns:' + labelW + 'px ' + gridW + 'px;min-width:' + (labelW + gridW) + 'px">';

  // Header: week labels
  h += '<div style="border-bottom:2px solid var(--border);padding:4px 8px;font-size:11px;font-weight:700;color:var(--text2);position:sticky;left:0;background:var(--bg2);z-index:2">–ö–ª–∏–µ–Ω—Ç</div>';
  h += '<div style="position:relative;height:28px;border-bottom:2px solid var(--border)">';
  weeks.forEach(w => {
    h += '<span style="position:absolute;left:' + (w.idx * cellW) + 'px;font-size:10px;color:var(--text3);white-space:nowrap;padding:4px 2px">' + w.label + '</span>';
  });
  // Today marker in header
  if (todayIdx >= 0) {
    h += '<div style="position:absolute;left:' + (todayIdx * cellW + cellW/2) + 'px;top:0;bottom:0;width:2px;background:var(--accent);z-index:3"></div>';
  }
  h += '</div>';

  // Rows: one per direction
  displayDirs.forEach(dir => {
    const dirName = dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';
    const dirTasks = allTasks.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === dirName);
    const stageName = STAGES.find(s => s.id === (dir['stage']||'prospect'))?.name || '';

    // Row label
    h += '<div style="padding:6px 8px;border-bottom:1px solid var(--border);font-size:12px;position:sticky;left:0;background:var(--bg2);z-index:2;cursor:pointer;display:flex;flex-direction:column;justify-content:center" onclick="openSlideOver(\'' + escA(dir['ID']||dir.id||'') + '\')" title="' + esc(dirName) + '">';
    h += '<div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:' + (labelW - 16) + 'px">' + esc(dirName) + '</div>';
    h += '<div style="font-size:10px;color:var(--text3)">' + esc(stageName) + '</div>';
    h += '</div>';

    // Gantt bars area
    h += '<div style="position:relative;height:' + Math.max(32, dirTasks.length * 20 + 8) + 'px;border-bottom:1px solid var(--border)">';
    // Weekend background
    days.forEach((dd, i) => {
      if (dd.getDay() === 0 || dd.getDay() === 6) {
        h += '<div style="position:absolute;left:' + (i * cellW) + 'px;top:0;bottom:0;width:' + cellW + 'px;background:rgba(255,255,255,.02)"></div>';
      }
    });
    // Today marker
    if (todayIdx >= 0) {
      h += '<div style="position:absolute;left:' + (todayIdx * cellW + cellW/2) + 'px;top:0;bottom:0;width:2px;background:var(--accent);opacity:.3;z-index:1"></div>';
    }
    // Task bars
    dirTasks.forEach((t, ti) => {
      const dl = t['–î–µ–¥–ª–∞–π–Ω'] ? new Date(t['–î–µ–¥–ª–∞–π–Ω']) : null;
      const cr = t['–°–æ–∑–¥–∞–Ω–æ'] ? new Date(t['–°–æ–∑–¥–∞–Ω–æ']) : (dl ? new Date(dl.getTime() - 7*86400000) : null);
      if (!dl && !cr) return;
      const barStart = cr || new Date(dl.getTime() - 7*86400000);
      const barEnd = dl || new Date(cr.getTime() + 7*86400000);
      const startIdx = Math.max(0, Math.floor((barStart - rangeStart) / 86400000));
      const endIdx = Math.min(totalDays, Math.ceil((barEnd - rangeStart) / 86400000));
      if (endIdx <= 0 || startIdx >= totalDays) return;
      const left = startIdx * cellW;
      const width = Math.max(cellW, (endIdx - startIdx) * cellW);
      const st = t['–°—Ç–∞—Ç—É—Å'] || '';
      const isDone = st.includes('–ì–æ—Ç–æ–≤–æ');
      const isOverdue = dl && dl.toISOString().slice(0,10) < td && !isDone;
      const color = isOverdue ? '#ff6b6b' : (statusColors[st] || '#ffa94d');
      const y = ti * 20 + 4;

      h += '<div style="position:absolute;left:' + left + 'px;top:' + y + 'px;width:' + width + 'px;height:16px;background:' + color + '33;border:1px solid ' + color + '88;border-radius:3px;cursor:pointer;display:flex;align-items:center;padding:0 4px;overflow:hidden;z-index:2" title="' + esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']?' ¬∑ üë§'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']):'') + '" onclick="openTaskDetail(\'' + escA(t.ID||t.id||'') + '\')">';
      h += '<span style="font-size:8px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + (isDone?'‚úÖ ':isOverdue?'üî¥ ':'') + esc((t['–û–ø–∏—Å–∞–Ω–∏–µ']||'').slice(0,30)) + '</span>';
      h += '</div>';
    });
    h += '</div>';
  });

  h += '</div></div></div>';
  return h;
}


let staffProjectFilter = '–í—Å–µ';
let staffDirFilter = '–í—Å–µ';

function renderStaffTabs() {
  // Project tabs
  const projects = ['–í—Å–µ', '–†–ö–¢', '–°–∞–π—Ç—ã'];
  const projDirs = {};
  (DATA.directions || []).forEach(d => {
    const p = d['–ü—Ä–æ–µ–∫—Ç'] || '';
    if (p && !projects.includes(p)) projects.push(p);
    (projDirs[p] = projDirs[p] || []).push(d['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '');
  });
  
  const tabsEl = document.getElementById('staff-project-tabs');
  if (tabsEl) {
    tabsEl.innerHTML = projects.map(p => {
      const emoji = p==='–í—Å–µ'?'üè†':p==='–†–ö–¢'?'üè•':p==='–°–∞–π—Ç—ã'?'üåê':'üìÇ';
      const count = getStaffForProject(p).length;
      return '<div class="tab'+(staffProjectFilter===p?' active':'')+'" onclick="filterStaffProject(\''+escA(p)+'\')">'+emoji+' '+esc(p)+' <span style="opacity:.5;font-size:11px">('+count+')</span></div>';
    }).join('');
  }
  
  // Direction tabs (only when specific project selected)
  const dirEl = document.getElementById('staff-direction-tabs');
  if (dirEl) {
    if (staffProjectFilter === '–í—Å–µ') {
      dirEl.innerHTML = '';
    } else {
      const dirs = ['–í—Å–µ', ...(projDirs[staffProjectFilter] || [])];
      dirEl.innerHTML = '<div class="tabs">' + dirs.map(d => {
        const count = d === '–í—Å–µ' ? getStaffForProject(staffProjectFilter).length : 
          DATA.staff.filter(s => (s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')=== d || (d==='–í—Å–µ' && (s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')==='–í—Å–µ')).length;
        return '<div class="tab tab-sm'+(staffDirFilter===d?' active':'')+'" onclick="filterStaffDir(\''+escA(d)+'\')">'+esc(d)+' <span style="opacity:.5">('+count+')</span></div>';
      }).join('') + '</div>';
    }
  }
}

function filterStaffProject(proj) {
  staffProjectFilter = proj;
  staffDirFilter = '–í—Å–µ';
  renderStaff();
}
function filterStaffDir(dir) {
  staffDirFilter = dir;
  renderStaff();
}

function getStaffForProject(proj) {
  if (proj === '–í—Å–µ') return DATA.staff;
  const projDirs = (DATA.directions || []).filter(d => (d['–ü—Ä–æ–µ–∫—Ç']||'') === proj).map(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'');
  return DATA.staff.filter(s => {
    const dir = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
    const role = s['–†–æ–ª—å'] || '';
    const staffProj = s['–ü—Ä–æ–µ–∫—Ç'] || '';
    if (role === 'CEO') return true;
    if (staffProj === '–í—Å–µ') return true;
    if (staffProj === proj) return true;
    if (projDirs.includes(dir)) return true;
    // Check extra_projects
    try {
      const extra = JSON.parse(s['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] || '[]');
      if (Array.isArray(extra) && extra.includes(proj)) return true;
    } catch(e) {}
    return false;
  });
}

function renderStaff() {
  renderStaffTabs();
  
  const p = getUserPerms();
  let staff = getStaffForProject(staffProjectFilter);
  
  // FIX 6: Non-CEO users only see staff in their project/direction
  if (!p.seeAll && USER && USER.direction && USER.direction !== '–í—Å–µ') {
    const userProjKey = Object.keys(PROJECTS).find(k => getProjectDirs(k).includes(USER.direction) || PROJECTS[k].name === USER.direction);
    if (userProjKey) {
      const myDirs = getProjectDirs(userProjKey);
      staff = staff.filter(s => {
        const sd = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
        const sp = s['–ü—Ä–æ–µ–∫—Ç']||'';
        return sd === USER.direction || myDirs.includes(sd) || sp === PROJECTS[userProjKey]?.name || sd === '–í—Å–µ' || s['–†–æ–ª—å'] === 'CEO';
      });
    }
  }
  
  // Direction filter
  if (staffDirFilter !== '–í—Å–µ') {
    staff = staff.filter(s => {
      const d = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
      const role = s['–†–æ–ª—å']||'';
      return d === staffDirFilter || role === 'CEO' || role === '–ó–∞–º' || d === '–í—Å–µ';
    });
  }
  
  // Search
  const q = (document.getElementById('staff-search')?.value||'').toLowerCase().trim();
  if (q) staff = staff.filter(s => 
    (s['–ò–º—è']||'').toLowerCase().includes(q) || (s['–†–æ–ª—å']||'').toLowerCase().includes(q) ||
    (s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(q) || (s['Email']||'').toLowerCase().includes(q));
  
  // Stats
  const roles = {};
  staff.forEach(s => { const r=s['–†–æ–ª—å']||'–î—Ä—É–≥–æ–µ'; roles[r]=(roles[r]||0)+1; });
  const statsEl = document.getElementById('staff-stats');
  if (statsEl) {
    statsEl.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:6px">' +
      Object.entries(roles).map(([r,c]) => '<span style="padding:3px 10px;background:var(--bg3);border-radius:20px;font-size:11px;color:var(--text2)">' + 
        ({CEO:'üëë',–ó–∞–º:'‚≠ê',–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:'üìã'}[r]||'üë§') + ' ' + esc(r) + ': <b style="color:var(--text)">' + c + '</b></span>').join('') +
      '<span style="padding:3px 10px;background:var(--accent-glow);border-radius:20px;font-size:11px;color:var(--accent);font-weight:600">–í—Å–µ–≥–æ: ' + staff.length + '</span></div>';
  }
  
  // Pending registrations (CEO only)
  const pendingEl = document.getElementById('staff-pending');
  if (pendingEl && p.canManageStaff) {
    const pending = DATA.staff.filter(s => (s['–°—Ç–∞—Ç—É—Å']||'')==='–û–∂–∏–¥–∞–µ—Ç');
    if (pending.length) {
      let ph = '<div class="card" style="border-color:rgba(255,169,77,.4)"><div class="card-header" style="background:rgba(255,169,77,.05)"><h3>‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è ('+pending.length+')</h3></div><div style="padding:12px;display:flex;flex-wrap:wrap;gap:10px">';
      pending.forEach(s => {
        ph += '<div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px;min-width:200px">';
        ph += '<div style="font-weight:700">'+esc(s['–ò–º—è']||'‚Äî')+'</div>';
        ph += '<div style="font-size:11px;color:var(--text2)">'+esc(s['–†–æ–ª—å']||'')+ ' ¬∑ '+esc(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'</div>';
        if(s['Telegram_ID']) ph += '<div style="font-size:11px;color:var(--text3)">TG: '+esc(String(s['Telegram_ID']))+'</div>';
        if(s['Username']) ph += '<div style="font-size:11px;color:var(--text3)">@'+esc(String(s['Username']).replace('@',''))+'</div>';
        if(s['–¢–µ–ª–µ—Ñ–æ–Ω']) ph += '<div style="font-size:11px;color:var(--text3)">üìû '+esc(s['–¢–µ–ª–µ—Ñ–æ–Ω'])+'</div>';
        ph += '<div style="display:flex;gap:6px;margin-top:8px">';
        ph += '<button class="btn btn-sm btn-primary" onclick="approveStaff(\''+escA(s.ID)+'\')">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>';
        ph += '<button class="btn btn-sm btn-danger" onclick="rejectStaff(\''+escA(s.ID)+'\')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>';
        ph += '</div></div>';
      });
      ph += '</div></div>';
      pendingEl.innerHTML = ph;
    } else { pendingEl.innerHTML = ''; }
  }
  
  // Sort: CEO ‚Üí –ó–∞–º ‚Üí –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å ‚Üí rest
  const roleOrder = {'CEO':0,'–ó–∞–º':1,'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':2,'–ú–µ–Ω–µ–¥–∂–µ—Ä':3,'–ò–Ω–∂–µ–Ω–µ—Ä':4};
  staff = [...staff].filter(s=>(s['–°—Ç–∞—Ç—É—Å']||'–ê–∫—Ç–∏–≤–Ω—ã–π')!=='–û–∂–∏–¥–∞–µ—Ç').sort((a,b)=>(roleOrder[a['–†–æ–ª—å']]??9)-(roleOrder[b['–†–æ–ª—å']]??9));
  
  const roleColors = { CEO:'linear-gradient(135deg,#00d4aa,#4dabf7)','–ó–∞–º':'linear-gradient(135deg,#b197fc,#7950f2)',
    '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':'linear-gradient(135deg,#ffa94d,#fd7e14)','–ú–µ–Ω–µ–¥–∂–µ—Ä':'linear-gradient(135deg,#4dabf7,#228be6)' };
  
  let h = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px">';
  if (staff.length) {
    staff.forEach(s => {
      const bg = roleColors[s['–†–æ–ª—å']] || 'linear-gradient(135deg,var(--text3),var(--text2))';
      const initial = (s['–ò–º—è']||'?').charAt(0).toUpperCase();
      const dir = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–í—Å–µ';
      const role = s['–†–æ–ª—å'] || '';
      const taskCount = DATA.tasks.filter(t => (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(s['–ò–º—è']||'___') && (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ').length;
      
      h += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:all .2s">';
      h += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">';
      h += '<div style="width:44px;height:44px;border-radius:50%;background:'+bg+';display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:var(--bg);flex-shrink:0">'+esc(initial)+'</div>';
      h += '<div><div style="font-weight:700;font-size:14px">'+esc(s['–ò–º—è']||'‚Äî')+'</div>';
      h += '<div style="font-size:11px;color:var(--text2)">'+({CEO:'üëë',–ó–∞–º:'‚≠ê',–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:'üìã'}[role]||'üë§')+' '+esc(role)+'</div></div>';
      h += '</div>';
      
      // Badges
      h += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">';
      if (role==='–ó–∞–º') h += '<span style="padding:2px 8px;background:var(--purple-glow);color:var(--purple);border-radius:12px;font-size:10px;font-weight:600">–í–µ—Å—å –ø—Ä–æ–µ–∫—Ç</span>';
      else h += '<span style="padding:2px 8px;background:var(--blue-glow);color:var(--blue);border-radius:12px;font-size:10px;font-weight:600">üìÇ '+esc(dir)+'</span>';
      if (taskCount) h += '<span style="padding:2px 8px;background:var(--orange-glow);color:var(--orange);border-radius:12px;font-size:10px;font-weight:600">üìã '+taskCount+' –∑–∞–¥–∞—á</span>';
      h += '</div>';
      
      h += '<div style="display:flex;flex-direction:column;gap:3px;font-size:11px;color:var(--text3)">';
      if(s['Username']) h += '<span>üí¨ @'+esc(String(s['Username']).replace('@',''))+'</span>';
      if(s['–¢–µ–ª–µ—Ñ–æ–Ω']) h += '<span>üìû '+esc(s['–¢–µ–ª–µ—Ñ–æ–Ω'])+'</span>';
      if(s['Email']) h += '<span>‚úâÔ∏è '+esc(s['Email'])+'</span>';
      if(s['Telegram_ID']) h += '<span style="opacity:0.6">ID: '+esc(String(s['Telegram_ID']))+'</span>';
      h += '</div>';
      
      if(p.canManageStaff) {
        h += '<div style="display:flex;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);flex-wrap:wrap">';
        h += '<button class="btn btn-sm btn-secondary" onclick="editItem(\'staff\',\''+escA(s.ID)+'\')">‚úèÔ∏è</button>';
        h += s['pin_hash'] ? '<button class="btn btn-sm btn-secondary" onclick="resetStaffPassword(\''+escA(s.ID)+'\',\''+escA(s['–ò–º—è'])+'\')">üîì –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</button>' 
                           : '<span style="font-size:10px;color:var(--orange);padding:4px 8px">‚ö†Ô∏è –ù–µ—Ç –ø–∞—Ä–æ–ª—è</span>';
        h += '<button class="btn btn-sm btn-danger" onclick="confirmDelete(\'staff\',\''+escA(s.ID)+'\',\''+escA(s['–ò–º—è'])+'\')">üóë</button>';
        h += '</div>';
      }
      h += '</div>';
    });
  } else {
    h += '<div class="empty" style="grid-column:1/-1"><div class="icon">üë•</div><p>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤'+(staffProjectFilter!=='–í—Å–µ'?' –≤ ¬´'+esc(staffProjectFilter)+'¬ª':'')+'</p></div>';
  }
  h += '</div>';
  document.getElementById('staff-content').innerHTML = h;
}

async function resetStaffPassword(staffId, staffName) {
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è '+staffName+'?\n–ù–æ–≤—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –Ω–∞ —ç–∫—Ä–∞–Ω–µ.')) return;
  try {
    const tempPass = Math.random().toString(36).slice(2,8).toUpperCase();
    const hash = await hashPassword(tempPass);
    await SB.from('staff').update({ pin_hash: hash }).eq('id', staffId);
    const cached = _staffCache.find(s => (s.ID||s.id) === staffId);
    if (cached) cached['pin_hash'] = hash;
    const inData = (DATA.staff||[]).find(s => (s.ID||s.id) === staffId);
    if (inData) inData['pin_hash'] = hash;
    
    // Try send via TG
    const staff = cached || inData;
    const tgId = staff?.Telegram_ID || staff?.['Telegram_ID'];
    if (tgId && CONFIG.TG_BOT_TOKEN) {
      try {
        await fetch('https://api.telegram.org/bot'+CONFIG.TG_BOT_TOKEN+'/sendMessage', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ chat_id: tgId, text: 'üîë –í–∞—à –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è RKT HUB: '+tempPass })
        });
        toast('‚úÖ –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram –¥–ª—è '+staffName, 'success');
      } catch(e) {
        showPasswordModal(staffName, tempPass, 'Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø–µ—Ä–µ–¥–∞–π—Ç–µ –ª–∏—á–Ω–æ');
      }
    } else {
      showPasswordModal(staffName, tempPass, '–°–æ–æ–±—â–∏—Ç–µ –µ–º—É –ª–∏—á–Ω–æ');
    }
    renderStaff();
  } catch(e) {
    toast('‚ùå –û—à–∏–±–∫–∞: '+e.message, 'error');
  }
}

// ---- PASSWORD CHANGE WITH TELEGRAM CODE CONFIRMATION ----
let _pwdChangeState = {};

async function changeMyPassword() {
  if (!USER) return;
  const staff = _staffCache.find(s => (s.ID||s.id) === USER.id);
  if (!staff) { toast('‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
  
  const tgId = staff.Telegram_ID || staff.telegram_id || '';
  if (!tgId) {
    toast('‚ùå Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω. –ü—Ä–∏–≤—è–∂–∏—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ @' + (CONFIG.TG_BOT||'AIhroject_bot'), 'error');
    return;
  }
  
  _pwdChangeState = { staffId: USER.id, tgId, step: 1 };
  
  // Show password change modal
  let overlay = document.getElementById('pwdChangeOverlay');
  if (overlay) overlay.remove();
  
  overlay = document.createElement('div');
  overlay.id = 'pwdChangeOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn .2s';
  overlay.innerHTML = `
    <div style="background:var(--bg2);border-radius:16px;padding:28px;width:380px;max-width:90vw;box-shadow:0 8px 32px rgba(0,0,0,.4)">
      <div style="text-align:center;margin-bottom:18px">
        <div style="font-size:36px;margin-bottom:8px">üîê</div>
        <div style="font-size:16px;font-weight:700;color:var(--text)">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</div>
      </div>
      <div id="pwdStep1">
        <input class="login-input" id="pwdNew" type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)" style="margin-bottom:10px">
        <input class="login-input" id="pwdNew2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" onkeydown="if(event.key==='Enter')pwdSendCode()">
        <button class="login-btn" style="margin-top:12px;width:100%" onclick="pwdSendCode()">
          <span id="pwdSendBtnText">üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ Telegram</span>
        </button>
      </div>
      <div id="pwdStep2" style="display:none">
        <div style="text-align:center;font-size:13px;color:var(--text2);margin-bottom:14px;line-height:1.5">
          üì± –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤<br><b>Telegram</b>. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ:
        </div>
        <input class="login-input" id="pwdCode" type="text" placeholder="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥" style="text-align:center;font-size:20px;letter-spacing:8px" maxlength="6" onkeydown="if(event.key==='Enter')pwdVerifyCode()">
        <button class="login-btn" style="margin-top:12px;width:100%" onclick="pwdVerifyCode()">
          <span id="pwdVerifyBtnText">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
        </button>
        <div style="text-align:center;margin-top:10px">
          <a href="#" onclick="pwdSendCode();return false" style="color:var(--accent);font-size:12px">üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –∑–∞–Ω–æ–≤–æ</a>
        </div>
      </div>
      <div class="login-error" id="pwdError"></div>
      <div style="text-align:center;margin-top:14px">
        <a href="#" onclick="closePwdChange();return false" style="color:var(--text3);font-size:12px">‚Üê –û—Ç–º–µ–Ω–∞</a>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.onclick = (e) => { if (e.target === overlay) closePwdChange(); };
  document.getElementById('pwdNew').focus();
}

function closePwdChange() {
  const el = document.getElementById('pwdChangeOverlay');
  if (el) el.remove();
  _pwdChangeState = {};
}

async function pwdSendCode() {
  const errEl = document.getElementById('pwdError');
  errEl.style.display = 'none';
  
  const p1 = document.getElementById('pwdNew').value;
  const p2 = document.getElementById('pwdNew2').value;
  
  if (!p1 || p1.length < 4) { errEl.textContent='‚ùå –ü–∞—Ä–æ–ª—å –º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞'; errEl.style.display='block'; return; }
  if (p1 !== p2) { errEl.textContent='‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'; errEl.style.display='block'; return; }
  
  document.getElementById('pwdSendBtnText').textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
  
  // Generate 6-digit code
  const code = String(Math.floor(100000 + Math.random() * 900000));
  _pwdChangeState.code = code;
  _pwdChangeState.codeTime = Date.now();
  _pwdChangeState.newPassHash = await hashPassword(p1);
  
  // Save code to tg_auth_tokens
  try {
    await SB.from('tg_auth_tokens').insert({
      token: code,
      staff_id: _pwdChangeState.staffId,
      telegram_id: _pwdChangeState.tgId,
      type: 'password_change'
    });
  } catch(e) { /* table may not exist, use local check */ }
  
  // Send code via Telegram
  try {
    await sendTelegramNotification(
      _pwdChangeState.tgId,
      'üîê *–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è*\n\n–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: `' + code + '`\n\n‚è∞ –ö–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç 5 –º–∏–Ω—É—Ç.\n‚ö†Ô∏è –ï—Å–ª–∏ –≤—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ —Å–º–µ–Ω—É –ø–∞—Ä–æ–ª—è ‚Äî –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ.'
    );
  } catch(e) {
    errEl.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ Telegram';
    errEl.style.display = 'block';
    document.getElementById('pwdSendBtnText').textContent = 'üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ Telegram';
    return;
  }
  
  // Switch to step 2
  document.getElementById('pwdStep1').style.display = 'none';
  document.getElementById('pwdStep2').style.display = 'block';
  document.getElementById('pwdSendBtnText').textContent = 'üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ Telegram';
  document.getElementById('pwdCode').focus();
  toast('üì± –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram', 'success');
}

async function pwdVerifyCode() {
  const errEl = document.getElementById('pwdError');
  errEl.style.display = 'none';
  const entered = (document.getElementById('pwdCode')?.value||'').trim();
  
  if (!entered || entered.length !== 6) { errEl.textContent='–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥'; errEl.style.display='block'; return; }
  
  document.getElementById('pwdVerifyBtnText').textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
  
  // Check expiry (5 min)
  if (Date.now() - (_pwdChangeState.codeTime||0) > 5 * 60 * 1000) {
    errEl.textContent = '‚ùå –ö–æ–¥ –∏—Å—Ç—ë–∫. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π.';
    errEl.style.display = 'block';
    document.getElementById('pwdVerifyBtnText').textContent = '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    return;
  }
  
  // Verify code (local + DB)
  let valid = (entered === _pwdChangeState.code);
  
  if (!valid) {
    try {
      const { data } = await SB.from('tg_auth_tokens').select('*').eq('token', entered).eq('staff_id', _pwdChangeState.staffId).single();
      if (data) {
        valid = true;
        await SB.from('tg_auth_tokens').delete().eq('token', entered).catch(()=>{});
      }
    } catch(e) { /* table may not exist */ }
  }
  
  if (!valid) {
    errEl.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥';
    errEl.style.display = 'block';
    document.getElementById('pwdVerifyBtnText').textContent = '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    return;
  }
  
  // Code verified ‚Äî change password
  try {
    await SB.from('staff').update({ pin_hash: _pwdChangeState.newPassHash }).eq('id', _pwdChangeState.staffId);
    const staff = _staffCache.find(s => (s.ID||s.id) === _pwdChangeState.staffId);
    if (staff) staff['pin_hash'] = _pwdChangeState.newPassHash;
    
    // Cleanup used code from DB
    try { await SB.from('tg_auth_tokens').delete().eq('token', _pwdChangeState.code).catch(()=>{}); } catch(e) {}
    
    closePwdChange();
    toast('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!', 'success');
    
    // Notify via Telegram
    try {
      await sendTelegramNotification(_pwdChangeState.tgId, '‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω –≤ RKT HUB.');
    } catch(e) {}
  } catch(e) {
    errEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
    errEl.style.display = 'block';
    document.getElementById('pwdVerifyBtnText').textContent = '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
  }
}

async function approveStaff(id) {
  const staff = DATA.staff.find(s => s.ID === id);
  if (!staff) return;
  try {
    staff['–°—Ç–∞—Ç—É—Å'] = '–ê–∫—Ç–∏–≤–Ω—ã–π';
    await apiWrite('–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', { ID: id, '–°—Ç–∞—Ç—É—Å': '–ê–∫—Ç–∏–≤–Ω—ã–π' }, 'update');
    toast('‚úÖ ' + esc(staff['–ò–º—è']) + ' –æ–¥–æ–±—Ä–µ–Ω!', 'success');
    // Notify the approved staff member via Telegram
    const tgId = staff['Telegram_ID'];
    if (tgId) {
      sendTelegramNotification(tgId, '‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ RKT HUB –æ–¥–æ–±—Ä–µ–Ω–∞! –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.');
    }
    addNotification('‚úÖ –û–¥–æ–±—Ä–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫: ' + (staff['–ò–º—è']||''), 'staff');
    await loadData();
    renderStaff();
  } catch(e) {
    toast('‚ùå –û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
}

async function rejectStaff(id) {
  const staff = DATA.staff.find(s => s.ID === id);
  if (!staff) return;
  try {
    // Notify the rejected staff member via Telegram first
    const tgId = staff['Telegram_ID'];
    if (tgId) {
      sendTelegramNotification(tgId, '‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ RKT HUB –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞. –°–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è.');
    }
    // Delete the staff record
    await SB.from('staff').delete().eq('id', id);
    DATA.staff = DATA.staff.filter(s => (s.ID || s.id) !== id);
    toast('‚ùå –ó–∞—è–≤–∫–∞ ' + esc(staff['–ò–º—è'] || '') + ' –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'warning');
    addNotification('‚ùå –û—Ç–∫–ª–æ–Ω—ë–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫: ' + (staff['–ò–º—è']||''), 'staff');
    renderStaff();
  } catch(e) {
    toast('‚ùå –û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
}

// Send Telegram notification helper
// sendTelegramNotification ‚Äî defined below near notification section (uses n8n webhook)

// Self-registration function ‚Äî creates approval request (staff record already exists from doPasswordRegister)
async function selfRegister(data) {
  const staffInfo = {
    'ID': data.staffId || '',
    '–ò–º—è': data.name || '',
    '–†–æ–ª—å': data.role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
    '–ü—Ä–æ–µ–∫—Ç': data.project || '',
    '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': data.direction || '',
    'Telegram_ID': data.telegram_id || '',
    'Username': data.username || '',
    'Email': data.email || '',
    '–¢–µ–ª–µ—Ñ–æ–Ω': data.phone || '',
    '–°—Ç–∞—Ç—É—Å': '–û–∂–∏–¥–∞–µ—Ç',
    '–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è': today()
  };
  // Only create approval request for CEO (staff record already created in doPasswordRegister)
  try {
    const approval = {
      ID: 'A' + Date.now().toString(36).toUpperCase(),
      '–¢–∏–ø': 'üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
      '–û–ø–∏—Å–∞–Ω–∏–µ': (data.name||'?') + ' ‚Äî ' + (data.role||'–°–æ—Ç—Ä—É–¥–Ω–∏–∫') + ' (' + (data.project||'') + ')',
      '–û—Ç_–∫–æ–≥–æ': data.name || '?',
      '–†–æ–ª—å': data.role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
      '–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞': today(),
      '–õ–∏—Å—Ç': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
      '–î–∞–Ω–Ω—ã–µ': JSON.stringify(staffInfo)
    };
    await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', approval);
    // Notify CEO about new registration
    notifyLeadership('üë§ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é:\n' + (data.name||'?') + ' ‚Äî ' + (data.role||'–°–æ—Ç—Ä—É–¥–Ω–∏–∫') + '\n–ü—Ä–æ–µ–∫—Ç: ' + (data.project||'–Ω–µ —É–∫–∞–∑–∞–Ω'));
    return true;
  } catch(e) {
    console.warn('selfRegister approval creation failed:', e);
    return false;
  }
}

// Quick site task ‚Äî CEO/–ó–∞–º –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã
function openQuickSiteTask() {
  const html = `
    <div style="padding:20px">
      <h3 style="margin-bottom:16px">üåê –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ —Å–∞–π—Ç—É</h3>
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∑–∞–¥–∞—á–∏ –¥–ª—è –∑–∞–º–∞.</p>
      <div class="form-group">
        <label>üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="qs-link" placeholder="https://yandex.ru/maps/... –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞" style="width:100%">
      </div>
      <div class="form-group">
        <label>üìç –ì–æ—Ä–æ–¥</label>
        <input type="text" id="qs-city" placeholder="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã" value="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã" style="width:100%">
      </div>
      <div class="form-group">
        <label>üìû –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
        <input type="text" id="qs-phone" placeholder="+7..." style="width:100%">
      </div>
      <div class="form-group">
        <label>üë§ –ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞</label>
        <select id="qs-assignee" style="width:100%">
          ${DATA.staff.filter(s => s['–°—Ç–∞—Ç—É—Å']!=='–û–∂–∏–¥–∞–µ—Ç' && s['–°—Ç–∞—Ç—É—Å']!=='‚ùå –£–¥–∞–ª—ë–Ω').map(s =>
            '<option value="'+esc(s['–ò–º—è'])+'">'+esc(s['–ò–º—è'])+' ('+esc(s['–†–æ–ª—å'])+')</option>'
          ).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π CEO</label>
        <textarea id="qs-comment" rows="2" placeholder="–î–æ–ø. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∑–∞–º–∞..." style="width:100%"></textarea>
      </div>
      <button class="btn btn-primary" onclick="submitQuickSiteTask()" style="width:100%;margin-top:8px">üöÄ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    </div>`;
  document.getElementById('modalTitle').textContent = 'üåê –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–∞ —Å–∞–π—Ç';
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalSaveBtn').style.display = 'none';
  document.getElementById('modalOverlay').classList.add('show');
}

async function submitQuickSiteTask() {
  const link = document.getElementById('qs-link').value.trim();
  const city = document.getElementById('qs-city').value.trim();
  const phone = document.getElementById('qs-phone').value.trim();
  const assignee = document.getElementById('qs-assignee').value;
  const comment = document.getElementById('qs-comment').value.trim();

  if (!link) { toast('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }

  // Extract name from link or use as-is
  let bizName = link;
  if (link.includes('yandex.ru/maps') || link.includes('2gis')) {
    bizName = '–ö–ª–∏–µ–Ω—Ç_' + String(Date.now()).slice(-4);
  }

  const td = today();
  const proj = PROJECTS['—Å–∞–π—Ç—ã'] || PROJECTS['sites'] || Object.values(PROJECTS).find(p => p.canAddSub);
  const projName = proj ? proj.name : '–°–∞–π—Ç—ã';

  // 1. Create direction (subproject)
  await apiWrite('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', {
    ID: 'DIR'+String(Date.now()).slice(-6),
    '–ù–∞–∑–≤–∞–Ω–∏–µ': bizName,
    '–ü—Ä–æ–µ–∫—Ç': projName,
    '–°—Ç–∞—Ç—É—Å': 'üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞',
    '–≠—Ç–∞–ø': '–õ–∏–¥',
    '–°—Å—ã–ª–∫–∞': link,
    '–¢–µ–ª–µ—Ñ–æ–Ω': phone,
    '–ì–æ—Ä–æ–¥': city,
    '–î–∞—Ç–∞_—Å–æ–∑–¥–∞–Ω–∏—è': td
  });

  // 2. Auto-create pipeline tasks
  const pipeline = [
    { desc: 'üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É ¬´'+bizName+'¬ª, –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –æ —Å–∞–π—Ç–µ', days: 1, pr: 'P1' },
    { desc: 'üìã –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –¥–ª—è ¬´'+bizName+'¬ª', days: 2, pr: 'P1' },
    { desc: 'üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Å–∞–π—Ç–∞ ¬´'+bizName+'¬ª', days: 3, pr: 'P1' },
    { desc: 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—É ¬´'+bizName+'¬ª', days: 4, pr: 'P1' },
    { desc: 'üí¨ –ü–æ–ª—É—á–∏—Ç—å —Ñ–∏–¥–±–µ–∫ –æ—Ç ¬´'+bizName+'¬ª', days: 6, pr: 'P2' },
    { desc: 'üí≥ –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç –∑–∞ –¥–æ–º–µ–Ω/—Ö–æ—Å—Ç–∏–Ω–≥ ¬´'+bizName+'¬ª', days: 8, pr: 'P2' },
    { desc: 'üîß –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∞–π—Ç ¬´'+bizName+'¬ª –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥', days: 12, pr: 'P2' },
    { desc: '‚úÖ –°–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç ¬´'+bizName+'¬ª, –ø–æ–ª—É—á–∏—Ç—å –æ–ø–ª–∞—Ç—É', days: 14, pr: 'P3' }
  ];

  for (const task of pipeline) {
    const dl = new Date(); dl.setDate(dl.getDate() + task.days);
    await apiWrite('–ó–∞–¥–∞—á–∏', {
      ID: 'T'+String(Date.now()).slice(-6)+String(Math.random()).slice(2,4),
      '–û–ø–∏—Å–∞–Ω–∏–µ': task.desc + (comment ? '\nüí° CEO: '+comment : ''),
      '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': bizName,
      '–ü—Ä–æ–µ–∫—Ç': projName,
      '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': task.pr,
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
      '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': assignee,
      '–î–µ–¥–ª–∞–π–Ω': dl.toISOString().split('T')[0],
      '–°—Å—ã–ª–∫–∞': link,
      '–°–æ–∑–¥–∞–Ω–æ': td
    });
  }

  // Notify assignee about new client tasks via Telegram
  if (assignee) {
    notifyTaskAssigned('üöÄ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç ¬´'+bizName+'¬ª ‚Äî 8 –∑–∞–¥–∞—á', assignee, bizName);
  }

  closeModal();
  toast('üöÄ –°–æ–∑–¥–∞–Ω –∫–ª–∏–µ–Ω—Ç ¬´'+bizName+'¬ª + 8 –∑–∞–¥–∞—á –¥–ª—è '+assignee, 'success');
  debouncedLoadData();
}

function renderApprovals() {
  const el = document.getElementById('approvals-content');
  const p = getUserPerms();
  if (!p.canApprove) { el.innerHTML = '<div class="empty"><div class="icon">üîí</div><p>–¢–æ–ª—å–∫–æ –¥–ª—è CEO</p></div>'; return; }
  const pending = DATA.approvals.filter(a=>(a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç'));
  const done = DATA.approvals.filter(a=>!(a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç')).slice(0,20);

  let h = '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è ('+pending.length+')</h3></div>';
  if (pending.length) {
    h += pending.map(a => {
      let preview = '';
      try {
        const d = JSON.parse(a['–î–∞–Ω–Ω—ã–µ']||'{}');
        preview = Object.entries(d).filter(([k,v])=>v&&k!=='ID'&&k!=='row_number').slice(0,5).map(([k,v])=>'<span style="font-size:11px;background:var(--bg3);padding:2px 6px;border-radius:4px;margin:2px">'+esc(k)+': '+esc(String(v).substring(0,40))+'</span>').join(' ');
      } catch(e) {}
      return '<div class="card" style="padding:16px;margin:8px 16px;border-left:3px solid var(--accent)">' +
        '<div style="display:flex;justify-content:space-between;align-items:start;gap:12px">' +
        '<div style="flex:1">' +
        '<div style="font-weight:600;font-size:14px">'+esc(a['–¢–∏–ø']||'–ó–∞–ø—Ä–æ—Å')+'</div>' +
        '<div style="font-size:13px;color:var(--text2);margin:4px 0">'+esc(a['–û–ø–∏—Å–∞–Ω–∏–µ']||'')+'</div>' +
        '<div style="font-size:12px;color:var(--text3)">üë§ '+esc(a['–û—Ç_–∫–æ–≥–æ']||'?')+' ('+esc(a['–†–æ–ª—å']||'')+') ¬∑ üìÖ '+esc(a['–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞']||'')+'</div>' +
        (a['–õ–∏—Å—Ç'] ? '<div style="font-size:11px;margin-top:4px">üìã –õ–∏—Å—Ç: <b>'+esc(a['–õ–∏—Å—Ç'])+'</b></div>' : '') +
        (preview ? '<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:2px">'+preview+'</div>' : '') +
        '</div>' +
        '<div style="display:flex;gap:6px;flex-shrink:0">' +
        '<button class="btn btn-primary" style="padding:6px 16px" onclick="handleApproval(\''+escA(a.ID)+'\',true)">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>' +
        '<button class="btn btn-danger" style="padding:6px 12px" onclick="handleApproval(\''+escA(a.ID)+'\',false)">‚ùå</button>' +
        '</div></div></div>';
    }).join('');
  } else {
    h += '<div class="empty" style="padding:30px"><div class="icon">‚ú®</div><p>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö</p></div>';
  }
  h += '</div>';

  if (done.length) {
    h += '<div class="card"><div class="card-header"><h3>üìã –ò—Å—Ç–æ—Ä–∏—è</h3></div><div class="table-wrap"><table><thead><tr><th>–¢–∏–ø</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–û—Ç –∫–æ–≥–æ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è</th></tr></thead><tbody>';
    h += done.map(a => '<tr><td>'+esc(a['–¢–∏–ø'])+'</td><td>'+esc(a['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td><td>'+esc(a['–û—Ç_–∫–æ–≥–æ'])+'</td><td>'+esc(a['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(a['–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è']||'‚Äî')+'</td></tr>').join('');
    h += '</tbody></table></div></div>';
  }
  el.innerHTML = h;
}

function renderComms() {
  let d = DATA.comms||[];
  d = filterBySearch(d,'comm-search',['–ü–∞—Ä—Ç–Ω—ë—Ä','–¢–µ–º–∞','–†–µ–∑—É–ª—å—Ç–∞—Ç']);
  document.getElementById('comms-table').innerHTML = d.length ? d.map(c =>
    '<tr><td><strong>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</strong></td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">'+esc(c['–†–µ–∑—É–ª—å—Ç–∞—Ç']||'')+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td><td>'+actBtns('comm',c.ID||'',c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td></tr>'
  ).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π');
}

function renderSettings() {
  // Statistics section removed per CEO request

  // Permissions display
  const p = getUserPerms();
  const yn = (v) => v ? '<span style="color:var(--green)">‚úÖ</span>' : '<span style="color:var(--red)">‚ùå</span>';
  let ph = '<div style="margin-bottom:8px;color:var(--text2)">'+esc(p.desc||'')+'</div>';
  ph += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:4px">';
  ph += '<div>'+yn(p.canEditTasks)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</div>';
  ph += '<div>'+yn(p.canEditPartners)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏</div>';
  ph += '<div>'+yn(p.canEditStaff)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</div>';
  ph += '<div>'+yn(p.canEditProjects)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</div>';
  ph += '<div>'+yn(p.canAssignTasks)+' –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–∞—á</div>';
  ph += '<div>'+yn(p.canApprove)+' –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</div>';
  ph += '<div>'+yn(p.canDelete)+' –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π</div>';
  ph += '<div>'+yn(p.canCreateSiteTask)+' –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç-–∑–∞–¥–∞—á</div>';
  ph += '<div>'+yn(p.canGenerateSite)+' –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–π—Ç–æ–≤</div>';
  ph += '<div>'+yn(p.canExport)+' –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
  ph += '</div>';
  if (p.writeSheets && p.writeSheets.length) {
    ph += '<div style="margin-top:8px;font-size:12px;color:var(--text3)">üìù –ü—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å: '+p.writeSheets.join(', ')+'</div>';
  }
  if (p.needsApproval && p.needsApproval.length) {
    ph += '<div style="font-size:12px;color:var(--text3)">‚è≥ –ß–µ—Ä–µ–∑ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ: '+p.needsApproval.join(', ')+'</div>';
  }
  const permsEl = document.getElementById('s-perms');
  if (permsEl) permsEl.innerHTML = ph;
}

function updateConfig(key, value) {
  CONFIG[key] = value.trim();
  // Also persist bot token and webhook to Supabase settings
  const persistMap = { 'TG_BOT_TOKEN': 'tg_bot_token', 'AI_URL': 'n8n_webhook_url', 'TG_BOT': 'tg_bot_username' };
  if (persistMap[key] && SB) {
    SB.from('settings').upsert({ key: persistMap[key], value: value.trim(), updated_at: new Date().toISOString() }, { onConflict: 'key' }).then(() => {});
  }
}

// Dynamic direction filter when Project changes in form
function updateDirectionOptions(projName) {
  const sel = document.getElementById('field-–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
  if (!sel) return;
  const dirs = ['–í—Å–µ', ...getDirectionOptions(projName === '–í—Å–µ' ? null : projName)];
  sel.innerHTML = dirs.map(d => '<option value="'+escA(d)+'">'+esc(d)+'</option>').join('');
}

function saveSettings() {
  if (!USER || USER.role !== 'CEO') { toast('‚õî –¢–æ–ª—å–∫–æ CEO –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏','error'); return; }
  // Save GitHub token separately in localStorage (used by publishToGitHub)
  const ghTokenInput = document.getElementById('settingsGithubToken');
  if (ghTokenInput && ghTokenInput.value.trim()) {
    localStorage.setItem('github_token', ghTokenInput.value.trim());
  } else if (ghTokenInput && !ghTokenInput.value.trim()) {
    localStorage.removeItem('github_token');
  }
  const ghRepoInput = document.getElementById('settingsGithubRepo');
  if (ghRepoInput && ghRepoInput.value.trim()) {
    CONFIG.GITHUB_REPO = ghRepoInput.value.trim();
  }
  localStorage.setItem('rkt_config', JSON.stringify({
    AI_URL: CONFIG.AI_URL,
    TG_BOT: CONFIG.TG_BOT,
    TG_BOT_TOKEN: CONFIG.TG_BOT_TOKEN,
    GROQ_KEY: CONFIG.GROQ_KEY,
    GEMINI_KEY: CONFIG.GEMINI_KEY,
    GITHUB_REPO: CONFIG.GITHUB_REPO
  }));
  toast('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
}

function loadSavedSettings() {
  try {
    const saved = JSON.parse(localStorage.getItem('rkt_config') || '{}');
    if (saved.AI_URL) CONFIG.AI_URL = saved.AI_URL;
    if (saved.TG_BOT) CONFIG.TG_BOT = saved.TG_BOT;
    if (saved.TG_BOT_TOKEN) CONFIG.TG_BOT_TOKEN = saved.TG_BOT_TOKEN;
    if (saved.GROQ_KEY) CONFIG.GROQ_KEY = saved.GROQ_KEY;
    if (saved.GEMINI_KEY) CONFIG.GEMINI_KEY = saved.GEMINI_KEY;
    if (saved.GITHUB_REPO) CONFIG.GITHUB_REPO = saved.GITHUB_REPO;
  } catch(e) {}
}

async function testConnection() {
  const el = document.getElementById('settings-status');
  el.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é...';
  try {
    const testUrl = CONFIG.SUPABASE_URL + '/rest/v1/staff?select=id&limit=1';
    const ctrl = new AbortController();
    const tmr = setTimeout(() => ctrl.abort(), 10000);
    const r = await fetch(testUrl, {
      headers: { 'apikey': CONFIG.SUPABASE_KEY },
      signal: ctrl.signal
    });
    clearTimeout(tmr);
    if (r.ok) {
      el.innerHTML = '<span style="color:var(--green)">‚úÖ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω–∞! –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+(DATA.partners||[]).length+', –ó–∞–¥–∞—á: '+(DATA.tasks||[]).length+', –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: '+(DATA.staff||[]).length+'</span>';
    } else {
      el.innerHTML = '<span style="color:var(--red)">‚ùå HTTP ' + r.status + '</span>';
    }
    // Test AI
    if (CONFIG.AI_URL) {
      const aiR = await fetch(CONFIG.AI_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message:'test',userId:'test',context:'ping'}),
        signal: AbortSignal.timeout(10000)
      }).catch(() => null);
      if (aiR && aiR.ok) {
        el.innerHTML += '<br><span style="color:var(--green)">‚úÖ AI webhook (Claude) –¥–æ—Å—Ç—É–ø–µ–Ω</span>';
      } else {
        el.innerHTML += '<br><span style="color:var(--orange)">‚ö†Ô∏è AI webhook (Claude) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ n8n</span>';
      }
    }
    // Test Groq
    if (CONFIG.GROQ_KEY) {
      try {
        const groqR = await fetch('https://api.groq.com/openai/v1/models', {
          headers: { 'Authorization': 'Bearer ' + CONFIG.GROQ_KEY },
          signal: AbortSignal.timeout(5000)
        });
        el.innerHTML += groqR.ok
          ? '<br><span style="color:var(--green)">‚úÖ Groq API –ø–æ–¥–∫–ª—é—á—ë–Ω (‚ö° –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —á–∞—Ç)</span>'
          : '<br><span style="color:var(--red)">‚ùå Groq API –æ—à–∏–±–∫–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á</span>';
      } catch(e) { el.innerHTML += '<br><span style="color:var(--orange)">‚ö†Ô∏è Groq API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>'; }
    }
    // Test Gemini
    if (CONFIG.GEMINI_KEY) {
      try {
        const gemR = await fetch('https://generativelanguage.googleapis.com/v1beta/models?key=' + CONFIG.GEMINI_KEY, {
          signal: AbortSignal.timeout(5000)
        });
        el.innerHTML += gemR.ok
          ? '<br><span style="color:var(--green)">‚úÖ Gemini API –ø–æ–¥–∫–ª—é—á—ë–Ω (‚ú® –∑–∞–ø–∞—Å–Ω–æ–π —á–∞—Ç)</span>'
          : '<br><span style="color:var(--red)">‚ùå Gemini API –æ—à–∏–±–∫–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á</span>';
      } catch(e) { el.innerHTML += '<br><span style="color:var(--orange)">‚ö†Ô∏è Gemini API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>'; }
    }
    if (!CONFIG.GROQ_KEY && !CONFIG.GEMINI_KEY) {
      el.innerHTML += '<br><span style="color:var(--text2)">‚ÑπÔ∏è –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ AI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã ‚Äî —á–∞—Ç —á–µ—Ä–µ–∑ Claude (n8n)</span>';
    }
  } catch(e) {
    const msg = e.name === 'AbortError' ? '–¢–∞–π–º–∞—É—Ç ‚Äî —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç' : e.message;
    el.innerHTML = '<span style="color:var(--red)">‚ùå ' + msg + '</span>';
  }
}

// ============================================================
// SITE GENERATOR ‚Äî –∞–Ω–∫–µ—Ç–∞ + –ø—Ä–µ–≤—å—é —Å–∞–π—Ç–∞ —á–µ—Ä–µ–∑ Claude
// ============================================================
let siteGenCache = {}; // Per-subproject site data cache
let siteGenStep = 'form'; // form | loading | preview

function getSiteGenData() {
  const key = currentSubproject || '_default';
  if (!siteGenCache[key]) {
    siteGenCache[key] = {};
    // Auto-load saved site_html from database
    const dir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
    if (dir && dir['site_html'] && !siteGenCache[key].html) {
      siteGenCache[key].html = dir['site_html'];
      siteGenCache[key].name = dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';
    }
  }
  return siteGenCache[key];
}

// ============================================================
// SITES BUSINESS: FINANCE DASHBOARD
// ============================================================
function renderSiteFinance() {
  const fin = calcSiteFinancials();
  const avgCheck = fin.clientCount ? Math.round(fin.plannedRevenue / fin.clientCount) : 10000;
  const saved = JSON.parse(localStorage.getItem('rkt_site_plan') || '{}');
  
  let html = '';
  
  // ====== PLAN GENERATOR ======
  html += '<div class="card" style="border-color:var(--accent);border-width:2px"><div class="card-header" style="background:rgba(110,86,207,0.08)"><h3>üéØ –ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω</h3>';
  html += '<button class="btn btn-sm btn-primary" onclick="executeSitePlan()">üöÄ –†–∞—Å–∫–∏–¥–∞—Ç—å –∑–∞–¥–∞—á–∏</button></div>';
  html += '<div class="card-body">';
  
  // Period & target
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px">';
  html += '<div class="form-group"><label>üìÖ –ü–µ—Ä–∏–æ–¥</label><select id="plan-period" onchange="recalcPlan()">';
  ['–ù–µ–¥–µ–ª—è','2 –Ω–µ–¥–µ–ª–∏','–ú–µ—Å—è—Ü'].forEach(p => {
    html += '<option'+(saved.period===p?' selected':'')+'>'+p+'</option>';
  });
  html += '</select></div>';
  html += '<div class="form-group"><label>üéØ –¶–µ–ª–µ–≤–æ–µ –∫–æ–ª-–≤–æ —Å–∞–π—Ç–æ–≤</label><input type="number" id="plan-target" value="'+(saved.target||10)+'" min="1" max="500" onchange="recalcPlan()"></div>';
  html += '<div class="form-group"><label>üìÑ –û—Å–Ω–æ–≤–Ω–æ–π —Ç–∏–ø</label><select id="plan-type" onchange="recalcPlan()">';
  for (const [name, p] of Object.entries(SITE_PRICING)) {
    html += '<option value="'+name+'"'+(saved.type===name?' selected':'')+'>'+p.emoji+' '+name+' ‚Äî '+fmtMoney(p.price)+'</option>';
  }
  html += '</select></div>';
  html += '<div class="form-group"><label>üìÜ –°—Ç–∞—Ä—Ç –ø–ª–∞–Ω–∞</label><input type="date" id="plan-start" value="'+(saved.start||today())+'"></div>';
  html += '</div>';
  
  // Auto-calculated distribution
  const staff = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π');
  const devs = staff.filter(s => ['–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫','–ò–Ω–∂–µ–Ω–µ—Ä'].includes(s['–†–æ–ª—å']));
  const mgrs = staff.filter(s => s['–†–æ–ª—å']==='–ú–µ–Ω–µ–¥–∂–µ—Ä');
  const allWorkers = [...devs, ...mgrs];
  const target = parseInt(saved.target) || 10;
  const siteType = saved.type || '–õ–µ–Ω–¥–∏–Ω–≥';
  const pricing = SITE_PRICING[siteType] || SITE_PRICING['–õ–µ–Ω–¥–∏–Ω–≥'];
  
  html += '<div style="background:var(--bg2);border-radius:var(--radius);padding:16px;margin-bottom:16px">';
  html += '<div style="font-weight:700;margin-bottom:12px;font-size:15px">üìä –†–∞—Å—á—ë—Ç –ø–ª–∞–Ω–∞ –Ω–∞ <span id="plan-calc-target">'+target+'</span> —Å–∞–π—Ç–æ–≤</div>';
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px">';
  
  const planRev = target * pricing.price;
  // Calculate total staff cost based on actual salary percentages
  const planStaffPct = allWorkers.reduce((sum, s) => {
    return sum + (parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[s['–†–æ–ª—å']] || 0);
  }, 0);
  const planStaffCost = target * Math.round(pricing.price * planStaffPct / 100);
  const planProfit = planRev - planStaffCost;

  html += '<div style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--accent)">'+fmtMoney(planRev)+'</div><div style="font-size:11px;color:var(--text2)">–í—ã—Ä—É—á–∫–∞ (–ø–ª–∞–Ω)</div></div>';
  html += '<div style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--orange)">'+fmtMoney(planStaffCost)+'</div><div style="font-size:11px;color:var(--text2)">–§–û–¢ ('+planStaffPct+'%)</div></div>';
  html += '<div style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--green)">'+fmtMoney(planProfit)+'</div><div style="font-size:11px;color:var(--text2)">–ü—Ä–∏–±—ã–ª—å ('+(100-planStaffPct)+'%)</div></div>';
  html += '</div></div>';
  
  // Staff distribution
  html += '<div style="font-weight:600;margin-bottom:8px">üë• –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º:</div>';
  html += '<div class="table-wrap"><table><thead><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–†–æ–ª—å</th><th>%</th><th>–°–∞–π—Ç–æ–≤</th><th>–ó–∞—Ä–∞–±–æ—Ç–∞–µ—Ç</th><th>–ù–∞–≥—Ä—É–∑–∫–∞/–¥–µ–Ω—å</th></tr></thead><tbody>';

  const periodDays = saved.period === '2 –Ω–µ–¥–µ–ª–∏' ? 14 : (saved.period === '–ú–µ—Å—è—Ü' ? 30 : 7);

  if (allWorkers.length === 0) {
    const escalation = staff.find(s => ['CEO','–ó–∞–º'].includes(s['–†–æ–ª—å'])) || { '–ò–º—è': USER?.name || 'CEO', '–†–æ–ª—å': 'CEO' };
    html += '<tr><td><strong>'+esc(escalation['–ò–º—è'])+'</strong></td><td>üëë '+esc(escalation['–†–æ–ª—å'])+'</td>';
    html += '<td>‚Äî</td><td style="font-weight:700">'+target+'</td>';
    html += '<td style="color:var(--accent);font-weight:600">'+fmtMoney(planProfit)+'</td>';
    html += '<td>'+(target/periodDays).toFixed(1)+'/–¥–µ–Ω—å</td></tr>';
    html += '<tr><td colspan="6" style="text-align:center;color:var(--orange)">‚ö†Ô∏è –ù–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ ‚Äî –Ω–∞–π–º–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É!</td></tr>';
  } else {
    // Show each worker with their individual salary %
    const sitesPerWorker = allWorkers.length ? Math.ceil(target / allWorkers.length) : target;
    allWorkers.forEach((w, i) => {
      const role = w['–†–æ–ª—å'] || '?';
      const pct = parseInt(w['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[role] || 0;
      const myCount = i < allWorkers.length - 1 ? sitesPerWorker : Math.max(0, target - sitesPerWorker * (allWorkers.length - 1));
      const earn = myCount * Math.round(pricing.price * pct / 100);
      const roleIcon = {'–ú–µ–Ω–µ–¥–∂–µ—Ä':'üíº','–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫':'üíª','–ò–Ω–∂–µ–Ω–µ—Ä':'üîß'}[role] || 'üë§';
      html += '<tr><td><strong>'+esc(w['–ò–º—è'])+'</strong></td><td>'+roleIcon+' '+esc(role)+'</td>';
      html += '<td style="font-weight:600">'+pct+'%</td>';
      html += '<td style="font-weight:700">'+myCount+'</td>';
      html += '<td style="color:var(--accent);font-weight:600">'+fmtMoney(earn)+'</td>';
      html += '<td>'+(myCount/periodDays).toFixed(1)+'/–¥–µ–Ω—å</td></tr>';
    });

    if (!devs.length) html += '<tr><td colspan="6" style="color:var(--orange)">‚ö†Ô∏è –ù–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ‚Äî –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –Ω–∞ –ó–∞–º/CEO</td></tr>';
    if (!mgrs.length) html += '<tr><td colspan="6" style="color:var(--orange)">‚ö†Ô∏è –ù–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ ‚Äî –∑–∞–¥–∞—á–∏ –ø–æ–∏—Å–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –Ω–∞ –ó–∞–º/CEO</td></tr>';
  }
  
  html += '</tbody></table></div>';
  html += '</div></div>';
  
  // ====== EDITABLE PRICING ======
  html += '<div class="card"><div class="card-header"><h3>üí∞ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç</h3>';
  html += '<button class="btn btn-sm btn-secondary" onclick="openPricingEditor()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></div>';
  html += '<div class="table-wrap"><table><thead><tr><th>–¢–∏–ø —Å–∞–π—Ç–∞</th><th>–¶–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th></tr></thead><tbody>';
  for (const [name, p] of Object.entries(SITE_PRICING)) {
    html += '<tr><td>'+p.emoji+' <strong>'+esc(name)+'</strong></td>';
    html += '<td style="font-weight:700;color:var(--accent)">'+fmtMoney(p.price)+'</td>';
    html += '<td style="font-size:12px;color:var(--text2)">'+esc(p.desc)+'</td></tr>';
  }
  html += '</tbody></table></div>';
  // Staff salary percentages inline
  const staffForPct = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π');
  if (staffForPct.length) {
    html += '<div style="padding:12px 16px;background:var(--bg2);border-radius:0 0 var(--radius) var(--radius);font-size:12px;color:var(--text2)">';
    html += '<strong>–ü—Ä–æ—Ü–µ–Ω—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:</strong> ';
    html += staffForPct.map(s => {
      const pct = parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[s['–†–æ–ª—å']] || 0;
      return esc(s['–ò–º—è']) + ' ‚Äî ' + pct + '%';
    }).join(', ');
    html += ' <span style="color:var(--text2)">(–æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –ø—Ä–∏–±—ã–ª—å –∫–æ–º–ø–∞–Ω–∏–∏)</span>';
    html += '</div>';
  }
  html += '</div>';
  
  // ====== SUMMARY METRICS ======
  html += '<div class="metrics" style="margin-bottom:20px">';
  html += '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+fin.clientCount+'</div><div class="m-label">–ö–ª–∏–µ–Ω—Ç–æ–≤</div><div class="m-sub">'+fin.inProgressCount+' –≤ —Ä–∞–±–æ—Ç–µ / '+fin.paidCount+' –æ–ø–ª–∞—á–µ–Ω–æ</div></div>';
  html += '<div class="metric-card"><div class="m-icon">üí∞</div><div class="m-value">'+fmtMoney(fin.totalRevenue)+'</div><div class="m-label">–§–∞–∫—Ç –≤—ã—Ä—É—á–∫–∞</div></div>';
  html += '<div class="metric-card"><div class="m-icon">üí∏</div><div class="m-value">'+fmtMoney(fin.totalStaffCost)+'</div><div class="m-label">–§–∞–∫—Ç –§–û–¢</div></div>';
  html += '<div class="metric-card"><div class="m-icon">'+(fin.profit>=0?'üìà':'üìâ')+'</div><div class="m-value" style="color:'+(fin.profit>=0?'var(--green)':'var(--red)')+'">'+fmtMoney(fin.profit)+'</div><div class="m-label">–§–∞–∫—Ç –ø—Ä–∏–±—ã–ª—å</div></div>';
  html += '</div>';
  
  // ====== CLIENT PIPELINE ======
  html += '<div class="card"><div class="card-header"><h3>üìã –ö–ª–∏–µ–Ω—Ç—ã ‚Äî –≤–æ—Ä–æ–Ω–∫–∞</h3></div>';
  html += '<div class="table-wrap"><table><thead><tr><th>–ö–ª–∏–µ–Ω—Ç</th><th>–¢–∏–ø</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–í—ã—Ä—É—á–∫–∞</th><th>–û–ø–ª–∞—Ç–∞</th></tr></thead><tbody>';
  if (fin.clients.length) {
    fin.clients.forEach(c => {
      const statusColor = c.isPaid ? 'var(--green)' : (c.isDone ? 'var(--orange)' : 'var(--blue)');
      html += '<tr><td><strong>'+esc(c.name)+'</strong></td>';
      html += '<td>'+(SITE_PRICING[c.type]?.emoji||'üìÑ')+' '+esc(c.type)+'</td>';
      html += '<td>'+statusBadge(c.status)+'</td>';
      html += '<td>'+progBar(c.progress)+'</td>';
      html += '<td>'+fmtMoney(c.plannedRevenue)+'</td>';
      html += '<td style="color:'+statusColor+';font-weight:600">'+(c.isPaid?'‚úÖ –û–ø–ª–∞—á–µ–Ω–æ':(c.isDone?'‚è≥ –ñ–¥—ë–º –æ–ø–ª–∞—Ç—É':'üîÑ –í —Ä–∞–±–æ—Ç–µ'))+'</td></tr>';
    });
  } else {
    html += emptyRow(6, '–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤');
  }
  html += '</tbody></table></div></div>';
  
  return html;
}

// ============================================================
// PLAN: save, recalc, execute
// ============================================================
function recalcPlan() {
  const plan = {
    period: document.getElementById('plan-period')?.value || '–ù–µ–¥–µ–ª—è',
    target: document.getElementById('plan-target')?.value || '10',
    type: document.getElementById('plan-type')?.value || '–õ–µ–Ω–¥–∏–Ω–≥',
    start: document.getElementById('plan-start')?.value || today()
  };
  localStorage.setItem('rkt_site_plan', JSON.stringify(plan));
  // Re-render finance tab
  if (currentPvTab === 'finance') {
    document.getElementById('pv-content').innerHTML = renderSiteFinance();
  }
}

async function executeSitePlan() {
  const target = parseInt(document.getElementById('plan-target')?.value) || 10;
  const period = document.getElementById('plan-period')?.value || '–ù–µ–¥–µ–ª—è';
  const siteType = document.getElementById('plan-type')?.value || '–õ–µ–Ω–¥–∏–Ω–≥';
  const startDate = document.getElementById('plan-start')?.value || today();
  const periodDays = period === '2 –Ω–µ–¥–µ–ª–∏' ? 14 : (period === '–ú–µ—Å—è—Ü' ? 30 : 7);
  const pricing = SITE_PRICING[siteType] || SITE_PRICING['–õ–µ–Ω–¥–∏–Ω–≥'];

  // Calculate financial forecast
  const expectedRevenue = target * pricing.price;
  const staff = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π');
  const devs = staff.filter(s => ['–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫','–ò–Ω–∂–µ–Ω–µ—Ä'].includes(normalizeRole(s['–†–æ–ª—å']||'')));
  const mgrs = staff.filter(s => normalizeRole(s['–†–æ–ª—å']||'') === '–ú–µ–Ω–µ–¥–∂–µ—Ä');

  let totalSalaryCost = 0;
  staff.forEach(s => {
    const pct = parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || 0;
    if (pct > 0) totalSalaryCost += Math.round(expectedRevenue * pct / 100 / staff.length);
  });
  const expectedProfit = expectedRevenue - totalSalaryCost;
  const tasksPerPerson = Math.ceil(target * 3 / Math.max(staff.length, 1));

  if (!confirm('üöÄ –ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω\n\n' +
    'üìä –¶–µ–ª–µ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã: ' + target + ' √ó ¬´' + siteType + '¬ª\n' +
    'üìÖ –ü–µ—Ä–∏–æ–¥: ' + period + ' (—Å ' + startDate + ')\n\n' +
    'üí∞ –§–ò–ù–ê–ù–°–û–í–´–ô –ü–†–û–ì–ù–û–ó:\n' +
    '  –í—ã—Ä—É—á–∫–∞: ' + fmtMoney(expectedRevenue) + '\n' +
    '  –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã: ~' + fmtMoney(totalSalaryCost) + '\n' +
    '  –ü—Ä–∏–±—ã–ª—å: ~' + fmtMoney(expectedProfit) + '\n\n' +
    'üë• –ó–∞–≥—Ä—É–∑–∫–∞: ~' + tasksPerPerson + ' –∑–∞–¥–∞—á/—á–µ–ª.\n\n' +
    '–ë—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã ' + target + ' placeholder-–∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –ø–æ–ª–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏ –∑–∞–¥–∞—á.\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?'
  )) return;

  const fallbackPerson = staff.find(s => ['CEO','–ó–∞–º'].includes(normalizeRole(s['–†–æ–ª—å']||'')))?.['–ò–º—è'] || (USER?.name || 'CEO');
  const devNames = devs.length ? devs.map(d => d['–ò–º—è']) : [fallbackPerson];
  const mgrNames = mgrs.length ? mgrs.map(m => m['–ò–º—è']) : [fallbackPerson];

  let createdDirs = 0, createdTasks = 0;
  const startD = new Date(startDate);

  toast('‚è≥ –°–æ–∑–¥–∞—é –≥–µ–Ω–ø–ª–∞–Ω...', 'info');

  for (let i = 0; i < target; i++) {
    const dayOffset = Math.floor(i * periodDays / target);
    const dl = new Date(startD); dl.setDate(dl.getDate() + dayOffset);
    const deadlineStr = dl.toISOString().split('T')[0];

    const mgrName = mgrNames[i % mgrNames.length];
    const devName = devNames[i % devNames.length];
    const clientLabel = '–ü–ª–∞–Ω #' + (fin_planCounter++) + ' ‚Äî ' + siteType;
    const dirId = 'D' + Date.now().toString(36).toUpperCase() + String(Math.random()).slice(2,5);

    // Create placeholder direction (client)
    try {
      await SB.from('directions').insert({
        id: dirId,
        name: clientLabel,
        project: '–°–∞–π—Ç—ã',
        site_type: siteType,
        price: pricing.price,
        stage: 'prospect',
        source: '–ì–µ–Ω–ø–ª–∞–Ω',
        manager: mgrName,
        status: '–ê–∫—Ç–∏–≤–Ω—ã–π',
        created_at: today()
      });
      createdDirs++;
    } catch(e) { console.warn('GenPlan dir create error:', e); }

    // Create first 3 pipeline tasks for each client
    const initialSteps = SITE_PIPELINE.slice(0, 3);
    for (const step of initialSteps) {
      const assignee = step.role === '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫' ? devName :
                       step.role === '–ú–µ–Ω–µ–¥–∂–µ—Ä' ? mgrName :
                       getSiteStaffByRole(step.role);
      const taskDl = new Date(dl); taskDl.setDate(taskDl.getDate() + step.days);
      try {
        await SB.from('tasks').insert({
          id: 'T' + Date.now().toString(36).toUpperCase() + String(Math.random()).slice(2,5),
          description: step.name + ': ' + clientLabel,
          direction: clientLabel,
          project: '–°–∞–π—Ç—ã',
          priority: step.step <= 2 ? 'P1' : 'P2',
          status: step.step === 1 ? '–í —Ä–∞–±–æ—Ç–µ' : '–ù–æ–≤–∞—è',
          assignee: assignee,
          deadline: taskDl.toISOString().split('T')[0],
          created_at: today()
        });
        createdTasks++;
      } catch(e) { console.warn('GenPlan task create error:', e); }
    }

    if (i % 5 === 4) await new Promise(r => setTimeout(r, 200));
  }

  toast('‚úÖ –ì–µ–Ω–ø–ª–∞–Ω —Å–æ–∑–¥–∞–Ω!\nüìÇ ' + createdDirs + ' –∫–ª–∏–µ–Ω—Ç–æ–≤\nüìã ' + createdTasks + ' –∑–∞–¥–∞—á\nüí∞ –ü–ª–∞–Ω –≤—ã—Ä—É—á–∫–∏: ' + fmtMoney(expectedRevenue), 'success');

  // Save plan
  localStorage.setItem('rkt_site_plan', JSON.stringify({
    period, target: String(target), type: siteType, start: startDate,
    lastExecuted: today(), createdDirs, createdTasks,
    forecast: { revenue: expectedRevenue, costs: totalSalaryCost, profit: expectedProfit }
  }));

  await loadData();
  renderAll();
}
let fin_planCounter = 1;
// Init counter from existing tasks
try { fin_planCounter = DATA.tasks.filter(t => (t['–û–ø–∏—Å–∞–Ω–∏–µ']||'').includes('–ø–ª–∞–Ω')).length + 1; } catch(e) {}

function openPricingEditor() {
  let fieldsHtml = '<h3 style="margin-bottom:16px">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–π—Å-–ª–∏—Å—Ç</h3>';
  fieldsHtml += '<p style="font-size:12px;color:var(--text2);margin-bottom:16px">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ü—Ä–æ—Ü–µ–Ω—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.</p>';

  for (const [name, p] of Object.entries(SITE_PRICING)) {
    fieldsHtml += '<div style="background:var(--bg2);border-radius:var(--radius);padding:12px;margin-bottom:8px">';
    fieldsHtml += '<div style="font-weight:600;margin-bottom:8px">'+p.emoji+' '+name+'</div>';
    fieldsHtml += '<div class="form-group"><label style="font-size:11px">–¶–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É (‚ÇΩ)</label><input type="number" id="price-'+name+'" value="'+p.price+'" min="0" step="500"></div>';
    fieldsHtml += '</div>';
  }

  // Show staff salary percentages for reference
  const staffForPct = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π');
  if (staffForPct.length) {
    fieldsHtml += '<div style="background:var(--bg2);border-radius:var(--radius);padding:12px;margin-bottom:8px">';
    fieldsHtml += '<div style="font-weight:600;margin-bottom:8px">üë• –ü—Ä–æ—Ü–µ–Ω—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>';
    staffForPct.forEach(s => {
      const pct = parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[s['–†–æ–ª—å']] || 0;
      fieldsHtml += '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:13px">';
      fieldsHtml += '<span>'+esc(s['–ò–º—è'])+' ('+esc(s['–†–æ–ª—å'])+')</span>';
      fieldsHtml += '<span style="font-weight:600;color:var(--accent)">'+pct+'%</span>';
      fieldsHtml += '</div>';
    });
    fieldsHtml += '</div>';
  }

  fieldsHtml += '<div style="display:flex;gap:8px;margin-top:16px">';
  fieldsHtml += '<button class="btn btn-primary" onclick="savePricing()" style="flex:1">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>';
  fieldsHtml += '<button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>';
  fieldsHtml += '</div>';

  document.getElementById('modalTitle').textContent = 'üí∞ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç';
  document.getElementById('modalBody').innerHTML = fieldsHtml;
  document.getElementById('modalFooter').innerHTML = '';
  document.getElementById('modalOverlay').classList.add('show');
  currentModal = 'pricing';
}

function savePricing() {
  for (const [name, p] of Object.entries(SITE_PRICING)) {
    const price = parseInt(document.getElementById('price-'+name)?.value) || p.price;
    SITE_PRICING[name].price = price;
  }
  localStorage.setItem('rkt_site_pricing', JSON.stringify(SITE_PRICING));
  closeModal();
  toast('–ü—Ä–∞–π—Å-–ª–∏—Å—Ç –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
  if (currentPvTab === 'finance') {
    document.getElementById('pv-content').innerHTML = renderSiteFinance();
  }
}

// Load saved pricing on startup
try {
  const savedPricing = JSON.parse(localStorage.getItem('rkt_site_pricing'));
  if (savedPricing) {
    for (const [name, p] of Object.entries(savedPricing)) {
      if (SITE_PRICING[name]) SITE_PRICING[name].price = p.price || SITE_PRICING[name].price;
    }
  }
} catch(e) {}

function renderSiteSalaries() {
  const fin = calcSiteFinancials();
  const staff = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π');

  let html = '';

  // Staff overview
  html += '<div class="card"><div class="card-header"><h3>üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ¬´–°–∞–π—Ç—ã¬ª ‚Äî –ó–∞—Ä–ø–ª–∞—Ç—ã</h3>';
  html += '<button class="btn btn-sm btn-primary" onclick="openModal(\'staff\')">+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button></div>';
  html += '<div class="table-wrap"><table><thead><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–†–æ–ª—å</th><th>% –æ—Ç —Å–∞–π—Ç–∞</th><th>–°–∞–π—Ç–æ–≤</th><th>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>';

  if (staff.length) {
    staff.forEach(s => {
      const name = s['–ò–º—è'] || '?';
      const role = s['–†–æ–ª—å'] || '?';
      const earnings = fin.staffEarnings[name] || { pct: 0, earned: 0, sites: 0 };
      const pct = parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[role] || 0;

      const bg = role === 'CEO' ? 'var(--accent)' : role === '–ó–∞–º' ? 'var(--blue)' : role === '–ú–µ–Ω–µ–¥–∂–µ—Ä' ? 'var(--orange)' : 'var(--purple)';
      html += '<tr><td><div style="display:flex;align-items:center;gap:8px">';
      html += '<div style="width:32px;height:32px;border-radius:50%;background:'+bg+';display:flex;align-items:center;justify-content:center;color:var(--bg);font-weight:700;font-size:13px">'+esc(name[0])+'</div>';
      html += '<strong>'+esc(name)+'</strong></div></td>';
      html += '<td>'+({CEO:'üëë',–ó–∞–º:'‚≠ê',–ú–µ–Ω–µ–¥–∂–µ—Ä:'üíº',–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:'üíª',–ò–Ω–∂–µ–Ω–µ—Ä:'üîß'}[role]||'üë§')+' '+esc(role)+'</td>';
      html += '<td style="font-weight:600;color:var(--accent)">'+pct+'%</td>';
      html += '<td style="font-weight:600">'+earnings.sites+'</td>';
      html += '<td style="font-weight:700;color:var(--accent)">'+fmtMoney(earnings.earned)+'</td>';
      html += '<td>'+statusBadge(s['–°—Ç–∞—Ç—É—Å'])+'</td></tr>';
    });
  } else {
    html += emptyRow(6, '–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ ¬´–°–∞–π—Ç—ã¬ª');
  }
  html += '</tbody></table></div></div>';
  
  // Pipeline roles
  html += '<div class="card"><div class="card-header"><h3>üîÑ –ö–æ–Ω–≤–µ–π–µ—Ä ‚Äî –†–æ–ª–∏ –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ</h3></div>';
  html += '<div class="card-body"><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">';
  SITE_PIPELINE.forEach(p => {
    const assigned = getSiteStaffByRole(p.role);
    const roleColor = p.role === 'CEO' ? 'var(--accent)' : p.role === '–ú–µ–Ω–µ–¥–∂–µ—Ä' ? 'var(--orange)' : 'var(--purple)';
    html += '<div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px;border-left:3px solid '+roleColor+'">';
    html += '<div style="font-size:12px;color:var(--text2)">–®–∞–≥ '+p.step+'</div>';
    html += '<div style="font-weight:600;font-size:13px;margin:4px 0">'+esc(p.name)+'</div>';
    html += '<div style="font-size:11px;color:'+roleColor+'">'+esc(p.role)+' ‚Üí '+esc(assigned)+'</div>';
    if (p.auto) html += '<div style="font-size:10px;color:var(--green);margin-top:4px">‚ö° –ê–≤—Ç–æ-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</div>';
    html += '</div>';
  });
  html += '</div></div></div>';
  
  // Salary summary
  const totalFot = Object.values(fin.staffEarnings).reduce((s, e) => s + e.earned, 0);
  html += '<div class="card"><div class="card-header"><h3>üí∞ –ò—Ç–æ–≥–æ –§–û–¢</h3></div>';
  html += '<div class="card-body" style="text-align:center">';
  html += '<div style="font-size:28px;font-weight:700;color:var(--accent)">'+fmtMoney(totalFot)+'</div>';
  html += '<div style="color:var(--text2);margin-top:4px">–í—ã–ø–ª–∞—á–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</div>';
  html += '<div style="margin-top:12px;display:flex;gap:20px;justify-content:center">';
  html += '<div>–í—ã—Ä—É—á–∫–∞: <strong>'+fmtMoney(fin.totalRevenue)+'</strong></div>';
  html += '<div>–§–û–¢: <strong style="color:var(--orange)">'+fmtMoney(totalFot)+'</strong></div>';
  html += '<div>–ü—Ä–∏–±—ã–ª—å: <strong style="color:var(--green)">'+fmtMoney(fin.totalRevenue - totalFot)+'</strong></div>';
  html += '</div></div></div>';
  
  return html;
}

function fmtMoney(n) {
  if (!n && n !== 0) return '‚Äî';
  return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(n);
}

// ============================================================
// SITE GENERATOR
// ============================================================
function renderSiteGenerator() {
  const siteGenData = getSiteGenData();
  if (siteGenStep === 'preview' && siteGenData.html) return renderSitePreview();
  if (siteGenStep === 'loading') return '<div class="card"><div class="card-body" style="text-align:center;padding:60px">' +
    '<div class="spinner" style="margin:0 auto 20px"></div><h3 style="margin-bottom:10px">ü§ñ Claude –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∞–π—Ç...</h3>' +
    '<p style="color:var(--text2)">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 20-30 —Å–µ–∫—É–Ω–¥</p></div></div>';

  // Pre-fill from anketa data if available
  const ankDir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  const av = (key) => ankDir ? esc(ankDir[key]||'') : '';

  return '<div class="card"><div class="card-header"><h3>üåê –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∞–π—Ç–∞ –¥–ª—è ¬´' + esc(currentSubproject) + '¬ª</h3></div>' +
    '<div class="card-body" style="padding:20px">' +
    '<p style="color:var(--text2);margin-bottom:20px">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É ‚Äî Claude —Å–æ–∑–¥–∞—Å—Ç –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç-–≤–∏–∑–∏—Ç–∫—É —Å –≤–∞—à–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º.' +
    (ankDir && (ankDir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || ankDir['–£—Å–ª—É–≥–∏']) ? ' <span style="color:var(--green)">‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ –∞–Ω–∫–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>' : '') + '</p>' +
    '<div class="sg-form" id="sg-form">' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ *</label><input type="text" id="sg-name" placeholder="–ü—ã—à–∫–∏ –º–∏—Ä–∞" value="' + esc(currentSubproject || '') + '"></div>' +
    '<div class="sg-field"><label>–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞ *</label><input type="text" id="sg-type" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω, –∫–∞—Ñ–µ, —Å–∞–ª–æ–Ω..." value="' + av('–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞') + '"></div>' +
    '</div>' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–ì–æ—Ä–æ–¥</label><input type="text" id="sg-city" placeholder="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã" value="' + av('–ì–æ—Ä–æ–¥') + '"></div>' +
    '<div class="sg-field"><label>–ê–¥—Ä–µ—Å</label><input type="text" id="sg-address" placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1" value="' + av('–ê–¥—Ä–µ—Å') + '"></div>' +
    '</div>' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" id="sg-phone" placeholder="+7 900 123-45-67" value="' + av('–¢–µ–ª–µ—Ñ–æ–Ω') + '"></div>' +
    '<div class="sg-field"><label>Instagram / –°–æ—Ü—Å–µ—Ç–∏</label><input type="text" id="sg-social" placeholder="@pyshki_mira" value="' + av('–°–æ—Ü—Å–µ—Ç–∏') + '"></div>' +
    '</div>' +

    '<div class="sg-field"><label>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</label><input type="text" id="sg-hours" placeholder="–ü–Ω-–ü—Ç 10:00-22:00, –°–±-–í—Å 11:00-23:00" value="' + av('–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã') + '"></div>' +

    '<div class="sg-field"><label>–û–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ (—á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –£–¢–ü) *</label>' +
    '<textarea id="sg-desc" rows="4" placeholder="–£—é—Ç–Ω–æ–µ –∫–∞—Ñ–µ —Å –¥–æ–º–∞—à–Ω–∏–º–∏ –ø—ã—à–∫–∞–º–∏ –∏ –∫–æ—Ñ–µ. –†–∞–±–æ—Ç–∞–µ–º —Å 2020 –≥–æ–¥–∞. –°–≤–µ–∂–∞—è –≤—ã–ø–µ—á–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å...">' + (av('–û–ø–∏—Å–∞–Ω–∏–µ') || av('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π')) + '</textarea></div>' +

    '<div class="sg-field"><label>–£—Å–ª—É–≥–∏ / –ú–µ–Ω—é (–ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>' +
    '<textarea id="sg-services" rows="3" placeholder="–ü—ã—à–∫–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ, –ü—ã—à–∫–∏ —Å –Ω–∞—á–∏–Ω–∫–æ–π, –ö–æ—Ñ–µ, –ß–∞–π, –î–µ—Å–µ—Ä—Ç—ã, –î–æ—Å—Ç–∞–≤–∫–∞...">' + av('–£—Å–ª—É–≥–∏') + '</textarea></div>' +

    '<div class="sg-field"><label>–¶–µ–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>' +
    '<input type="text" id="sg-prices" placeholder="–ü—ã—à–∫–∏ –æ—Ç 50‚ÇΩ, –∫–æ—Ñ–µ –æ—Ç 150‚ÇΩ" value="' + av('–¶–µ–Ω—ã') + '"></div>' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞</label><select id="sg-theme">' +
    '<option value="auto">ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</option>' +
    '<option value="warm">üî• –¢—ë–ø–ª–∞—è (—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –∫–∞—Ñ–µ)</option>' +
    '<option value="cool">‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω–∞—è (–º–µ–¥–∏—Ü–∏–Ω–∞, IT)</option>' +
    '<option value="dark">üåô –¢—ë–º–Ω–∞—è (–±–∞—Ä—ã, –∫–ª—É–±—ã)</option>' +
    '<option value="nature">üåø –ü—Ä–∏—Ä–æ–¥–Ω–∞—è (—ç–∫–æ, —Å–∞–ª–æ–Ω—ã)</option>' +
    '<option value="luxury">‚ú® –ü—Ä–µ–º–∏—É–º (–±—É—Ç–∏–∫–∏, –æ—Ç–µ–ª–∏)</option>' +
    '</select></div>' +
    '<div class="sg-field"><label>–°—Ç–∏–ª—å</label><select id="sg-style">' +
    '<option value="modern">–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π</option>' +
    '<option value="minimal">–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</option>' +
    '<option value="retro">–†–µ—Ç—Ä–æ / –°–æ–≤–µ—Ç—Å–∫–∏–π</option>' +
    '<option value="classic">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option>' +
    '<option value="playful">–Ø—Ä–∫–∏–π / –ò–≥—Ä–∏–≤—ã–π</option>' +
    '</select></div>' +
    '</div>' +

    '<div class="sg-field"><label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>' +
    '<textarea id="sg-extra" rows="2" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É, —Ñ–æ—Ä–º—É –∑–∞–∫–∞–∑–∞, –≥–∞–ª–µ—Ä–µ—é —Ñ–æ—Ç–æ..."></textarea></div>' +

    '<div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">' +
    '<div style="flex:1;min-width:200px"><button class="btn btn-primary" onclick="generateSite()" style="width:100%">ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –ò–ò</button><div style="font-size:10px;color:var(--text2);text-align:center;margin-top:4px">Claude —Å–æ–∑–¥–∞—Å—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–∞–π—Ç (~30 —Å–µ–∫)</div></div>' +
    '<div><button class="btn btn-secondary" onclick="generateSiteLocal()" style="width:100%">‚ö° –ë—ã—Å—Ç—Ä—ã–π —à–∞–±–ª–æ–Ω</button><div style="font-size:10px;color:var(--text2);text-align:center;margin-top:4px">–ì–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω, –º–≥–Ω–æ–≤–µ–Ω–Ω–æ</div></div>' +
    '<div><button class="btn btn-secondary" onclick="fillSiteDemo()" style="width:100%">üìã –ü—Ä–∏–º–µ—Ä</button><div style="font-size:10px;color:var(--text2);text-align:center;margin-top:4px">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–º–∏</div></div>' +
    '</div>' +
    '</div></div></div>';
}

function renderSitePreview() {
  const sgd = getSiteGenData();
  const siteHtml = sgd.html || '';
  const dir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  const publishedUrl = dir && dir['site_url'] ? dir['site_url'] : '';

  let h = '';
  // Top toolbar
  h += '<div class="card" style="margin-bottom:12px"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">';
  h += '<h3>üåê ' + esc(sgd.name || currentSubproject) + '</h3>';
  h += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
  h += '<button class="btn btn-sm" onclick="downloadSiteHtml()">üíæ –°–∫–∞—á–∞—Ç—å</button>';
  h += '<button class="btn btn-sm" onclick="copySiteHtml()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>';
  h += '<button class="btn btn-sm" onclick="toggleSiteCodeEditor()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>';
  h += '<button class="btn btn-sm" style="background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff" onclick="scrollToSiteAi()">ü§ñ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="siteGenStep=\'form\';renderSubprojectView()">üìù –ê–Ω–∫–µ—Ç–∞</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="regenerateSite()">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>';
  h += '</div></div></div>';

  // Device preview toggle
  h += '<div style="display:flex;justify-content:center;gap:4px;margin-bottom:8px;background:var(--bg2);padding:4px;border-radius:10px;width:fit-content;margin-left:auto;margin-right:auto">';
  h += '<button onclick="setSitePreviewWidth(\'100%\')" class="btn btn-sm" id="preview-desktop" style="font-size:12px;padding:6px 14px;border-radius:8px;background:var(--accent);color:#fff">üíª –î–µ—Å–∫—Ç–æ–ø</button>';
  h += '<button onclick="setSitePreviewWidth(\'768px\')" class="btn btn-sm" id="preview-tablet" style="font-size:12px;padding:6px 14px;border-radius:8px">üì± –ü–ª–∞–Ω—à–µ—Ç</button>';
  h += '<button onclick="setSitePreviewWidth(\'375px\')" class="btn btn-sm" id="preview-mobile" style="font-size:12px;padding:6px 14px;border-radius:8px">üì± –ú–æ–±–∏–ª—å–Ω—ã–π</button>';
  h += '</div>';

  // Iframe preview
  h += '<div class="site-preview-frame" id="site-preview-container" style="display:flex;justify-content:center"><iframe id="site-preview-iframe" sandbox="allow-scripts allow-same-origin" style="width:100%;min-height:700px;border:none;border-radius:var(--radius);background:#fff;transition:width .3s ease"></iframe></div>';

  // AI Assistant block (unified ‚Äî always visible)
  h += '<div class="card" style="margin-top:12px;border-color:var(--purple);border-width:2px" id="site-ai-editor-block">';
  h += '<div class="card-header" style="border-bottom:1px solid var(--border)">';
  h += '<h3 style="display:flex;align-items:center;gap:6px">ü§ñ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Å–∞–π—Ç—É</h3>';
  h += '</div>';
  h += '<div style="padding:16px">';
  // Client context hint
  const contextDir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ']===currentSubproject);
  if (contextDir) {
    const btype = contextDir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || contextDir['business_type'] || '';
    const cdesc = contextDir['–û–ø–∏—Å–∞–Ω–∏–µ'] || '';
    if (btype || cdesc) {
      h += '<div style="padding:8px 12px;background:rgba(177,151,252,0.05);border:1px solid rgba(177,151,252,0.15);border-radius:8px;margin-bottom:12px;font-size:12px;color:var(--text2)">';
      h += 'üìã <strong>' + esc(currentSubproject) + '</strong>';
      if (btype) h += ' &middot; ' + esc(btype);
      if (cdesc) h += ' &middot; ' + esc(cdesc.slice(0, 100));
      h += '</div>';
    }
  }
  // Quick action buttons
  h += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">';
  h += '<button class="btn btn-sm btn-secondary" onclick="siteAiQuick(\'–°–¥–µ–ª–∞–π —Ç—ë–º–Ω—É—é —Ç–µ–º—É —Å —Ç—ë–º–Ω—ã–º —Ñ–æ–Ω–æ–º –∏ —Å–≤–µ—Ç–ª—ã–º —Ç–µ–∫—Å—Ç–æ–º\')">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="siteAiQuick(\'–î–æ–±–∞–≤—å —Å–µ–∫—Ü–∏—é –æ—Ç–∑—ã–≤–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å 3 –ø—Ä–∏–º–µ—Ä–∞–º–∏\')">‚≠ê –û—Ç–∑—ã–≤—ã</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="siteAiQuick(\'–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, —Å–¥–µ–ª–∞–π –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –≤—ë—Ä—Å—Ç–∫—É\')">üì± –ú–æ–±–∏–ª—å–Ω–∞—è</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="siteAiQuick(\'–î–æ–±–∞–≤—å —Ñ–æ—Ä–º—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ —Å –ø–æ–ª—è–º–∏: –ò–º—è, –¢–µ–ª–µ—Ñ–æ–Ω, –°–æ–æ–±—â–µ–Ω–∏–µ\')">üìã –§–æ—Ä–º–∞</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="siteAiQuick(\'–î–æ–±–∞–≤—å –≥–∞–ª–µ—Ä–µ—é —Ñ–æ—Ç–æ/—Ä–∞–±–æ—Ç —Å 6 –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞–º–∏\')">üñº –ì–∞–ª–µ—Ä–µ—è</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="siteAiQuick(\'–£–ª—É—á—à–∏ SEO: –¥–æ–±–∞–≤—å meta description, title, og:tags\')">üîç SEO</button>';
  h += '</div>';
  // Chat history
  h += '<div id="site-ai-chat-msgs" style="max-height:300px;overflow-y:auto;margin-bottom:12px;padding:8px;background:var(--bg2);border-radius:var(--radius);min-height:60px">';
  h += '<div style="text-align:center;color:var(--text2);font-size:12px;padding:12px">–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–∞–π—Ç–µ ‚Äî AI –≤–Ω–µ—Å—ë—Ç –ø—Ä–∞–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>';
  h += '</div>';
  // Input
  h += '<div style="display:flex;gap:8px">';
  h += '<input id="site-ai-edit-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–∑–º–µ–Ω–∏ —Ü–≤–µ—Ç —à–∞–ø–∫–∏ –Ω–∞ —Å–∏–Ω–∏–π, –¥–æ–±–∞–≤—å –∫–Ω–æ–ø–∫—É WhatsApp..." style="flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text1);font-size:13px;font-family:inherit" onkeydown="if(event.key===\'Enter\')sendSiteAiEdit()">';
  h += '<button class="btn btn-primary btn-sm" id="site-ai-edit-btn" onclick="sendSiteAiEdit()">‚ú® –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>';
  h += '</div>';
  h += '</div></div>';

  // Publish section
  h += '<div class="card" style="margin-top:12px;border-color:var(--accent);border-width:2px">';
  h += '<div class="card-body" style="text-align:center;padding:24px">';
  if (publishedUrl) {
    h += '<div style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:12px">‚úÖ –°–∞–π—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!</div>';
    h += '<a href="'+esc(publishedUrl)+'" target="_blank" style="color:var(--accent);font-size:14px;word-break:break-all">'+esc(publishedUrl)+'</a>';
    h += '<div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">';
    h += '<button class="btn btn-primary" onclick="publishSite()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é</button>';
    h += '<button class="btn btn-sm" onclick="navigator.clipboard.writeText(\''+escA(publishedUrl)+'\');toast(\'–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞\',\'success\')">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>';
    h += '<button class="btn btn-sm btn-primary" onclick="sendSiteToClient()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É</button>';
    h += '</div>';
  } else {
    h += '<div style="font-size:20px;margin-bottom:8px">üöÄ</div>';
    h += '<div style="font-size:16px;font-weight:700;margin-bottom:8px">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–∞–π—Ç</div>';
    h += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ —Å–∞–π—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –æ–¥–Ω–∏–º –Ω–∞–∂–∞—Ç–∏–µ–º. –í—ã –ø–æ–ª—É—á–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.</div>';
    h += '<button class="btn btn-primary" style="font-size:15px;padding:12px 32px" onclick="publishSite()">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥</button>';
  }
  h += '</div></div>';

  // Step-by-step instructions
  h += '<div class="card" style="margin-top:12px"><div class="card-body">';
  h += '<div style="font-size:14px;font-weight:700;margin-bottom:12px">üìå –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏</div>';
  h += '<div style="display:grid;gap:8px;font-size:13px">';
  h += '<div style="display:flex;gap:8px;align-items:start"><span style="background:var(--accent);color:#fff;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0">1</span><span>–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–∞–π—Ç –≤ –ø—Ä–µ–≤—å—é –≤—ã—à–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—Å—Ç—ã, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∞–¥—Ä–µ—Å.</span></div>';
  h += '<div style="display:flex;gap:8px;align-items:start"><span style="background:var(--accent);color:#fff;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0">2</span><span>–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –Ω–∞–∂–º–∏—Ç–µ <b>"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥"</b> –∏–ª–∏ <b>"–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"</b>.</span></div>';
  h += '<div style="display:flex;gap:8px;align-items:start"><span style="background:var(--accent);color:#fff;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0">3</span><span>–ö–æ–≥–¥–∞ —Å–∞–π—Ç –≥–æ—Ç–æ–≤ ‚Äî –Ω–∞–∂–º–∏—Ç–µ <b>"–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥"</b> —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É.</span></div>';
  h += '<div style="display:flex;gap:8px;align-items:start"><span style="background:var(--accent);color:#fff;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0">4</span><span>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∫–ª–∏–µ–Ω—Ç—É –∏–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ HTML —Ñ–∞–π–ª.</span></div>';
  h += '</div></div></div>';

  // Code editor (hidden by default)
  h += '<div class="card" style="margin-top:12px;display:none" id="site-code-editor-block">';
  h += '<div class="card-header"><h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä HTML</h3>';
  h += '<div style="display:flex;gap:8px">';
  h += '<button class="btn btn-sm btn-primary" onclick="applySiteCodeChanges()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="toggleSiteCodeEditor()">–ó–∞–∫—Ä—ã—Ç—å</button>';
  h += '</div></div>';
  h += '<textarea id="site-code-textarea" style="width:100%;min-height:400px;padding:12px;font-family:monospace;font-size:12px;border:none;background:var(--bg2);color:var(--text);resize:vertical">' + esc(siteHtml) + '</textarea>';
  h += '</div>';

  // Source code (read-only, hidden)
  h += '<div class="card" style="margin-top:12px"><div class="card-header"><h3>üìù –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</h3>';
  h += '<button class="btn btn-sm" onclick="toggleSiteCode()">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å</button></div>';
  h += '<div id="site-code-block" style="display:none;padding:16px;max-height:400px;overflow:auto">';
  h += '<pre style="white-space:pre-wrap;font-size:12px;color:var(--text2)">' + esc(siteHtml) + '</pre></div></div>';

  return h;
}

function toggleSiteCodeEditor() {
  const block = document.getElementById('site-code-editor-block');
  if (block) block.style.display = block.style.display === 'none' ? 'block' : 'none';
}

function applySiteCodeChanges() {
  const textarea = document.getElementById('site-code-textarea');
  if (!textarea) return;
  const newHtml = textarea.value;
  const sgd = getSiteGenData();
  sgd.html = newHtml;
  // Update iframe
  const iframe = document.getElementById('site-preview-iframe');
  if (iframe) {
    const doc = iframe.contentDocument || iframe.contentWindow.document;
    doc.open(); doc.write(newHtml); doc.close();
  }
  // Update source code block
  const pre = document.querySelector('#site-code-block pre');
  if (pre) pre.textContent = newHtml;
  toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –ø—Ä–µ–≤—å—é', 'success');
}

function toggleSiteAiEditor() {
  const block = document.getElementById('site-ai-editor-block');
  if (!block) return;
  if (block.style.display === 'none') block.style.display = 'block';
  block.scrollIntoView({behavior:'smooth', block:'center'});
  setTimeout(() => { const inp = document.getElementById('site-ai-edit-input'); if(inp) inp.focus(); }, 400);
}

function scrollToSiteAi() {
  const block = document.getElementById('site-ai-editor-block');
  if (block) {
    block.scrollIntoView({behavior:'smooth', block:'center'});
    setTimeout(() => { 
      const inp = document.getElementById('site-ai-edit-input'); if(inp) inp.focus();
      loadSiteAiChat(currentSubproject);
    }, 400);
  }
}

function siteAiQuick(text) {
  const input = document.getElementById('site-ai-edit-input');
  if (input) { input.value = text; sendSiteAiEdit(); }
}

async function sendSiteAiEdit() {
  const input = document.getElementById('site-ai-edit-input');
  const btn = document.getElementById('site-ai-edit-btn');
  if (!input) return;
  const instruction = input.value.trim();
  if (!instruction) return;
  input.value = '';
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...'; }

  // Add loading overlay on iframe preview
  const previewContainer = document.getElementById('site-preview-container');
  if (previewContainer) {
    const overlay = document.createElement('div');
    overlay.id = 'site-ai-loading-overlay';
    overlay.style.cssText = 'position:absolute;inset:0;background:rgba(10,14,23,0.7);display:flex;align-items:center;justify-content:center;border-radius:var(--radius);z-index:10;flex-direction:column;gap:12px';
    overlay.innerHTML = '<div class="spinner"></div><div style="color:var(--purple);font-size:14px;font-weight:600">AI –≤–Ω–æ—Å–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è...</div>';
    previewContainer.style.position = 'relative';
    previewContainer.appendChild(overlay);
  }

  const sgd = getSiteGenData();
  const currentHtml = sgd.html || '';
  if (!currentHtml) { toast('–ù–µ—Ç HTML –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è','error'); if(btn){btn.disabled=false;btn.textContent='‚ú® –ü—Ä–∏–º–µ–Ω–∏—Ç—å';} const ol=document.getElementById('site-ai-loading-overlay'); if(ol)ol.remove(); return; }

  // Show user message in chat
  const chatMsgs = document.getElementById('site-ai-chat-msgs');
  if (chatMsgs) {
    chatMsgs.innerHTML += '<div style="padding:8px;background:var(--bg);border-radius:8px;margin-bottom:6px;font-size:13px"><strong style="color:var(--accent)">–í—ã:</strong> ' + esc(instruction) + '</div>';
    chatMsgs.innerHTML += '<div id="site-ai-thinking" style="padding:8px;background:rgba(177,151,252,0.05);border-radius:8px;margin-bottom:6px;font-size:13px;color:var(--purple)"><span class="ai-loading" style="display:inline-flex;gap:3px;vertical-align:middle"><span></span><span></span><span></span></span> –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏ –≤–Ω–æ—à—É –ø—Ä–∞–≤–∫–∏...</div>';
    chatMsgs.scrollTop = chatMsgs.scrollHeight;
  }

  const systemPrompt = '–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. ' +
    '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–¥–∞—Ç—å —Ç–µ–±–µ –í–û–ü–†–û–° –∏–ª–∏ –¥–∞—Ç—å –ò–ù–°–¢–†–£–ö–¶–ò–Æ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Å–∞–π—Ç–∞. ' +
    '–í–ê–ñ–ù–û: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å (—á—Ç–æ –¥–µ–ª–∞—Ç—å, –∫–∞–∫, –∑–∞—á–µ–º, –ø–æ—á–µ–º—É, —Å–æ–≤–µ—Ç—ã), –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–π HTML ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç—å —Ç–µ–∫—Å—Ç–æ–º. ' +
    '–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–∞–π—Ç (–∏–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç, –¥–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫, —É–±—Ä–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç –∏ —Ç.–¥.), ' +
    '—Ç–æ–≥–¥–∞ –Ω–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç —Å–æ —Å—Ç—Ä–æ–∫–∏ "===HTML_START===" –∏ –≤–µ—Ä–Ω–∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π HTML —Ü–µ–ª–∏–∫–æ–º, –∞ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–≥–æ </html> –¥–æ–±–∞–≤—å "===HTML_END===" ' +
    '–∏ –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ –Ω–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º (—á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Ç—ã –∏–∑–º–µ–Ω–∏–ª). ' +
    '–°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –≤–Ω–æ—Å–∏ –¢–û–õ–¨–ö–û –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. ' +
    '–ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π CSS, –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –≤—ë—Ä—Å—Ç–∫—É. –ü–∏—à–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º.';

  const messages = [
    { role: 'user', content: '–¢–µ–∫—É—â–∏–π HTML —Å–∞–π—Ç–∞:\n\n' + currentHtml.slice(0, 60000) + '\n\n–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: ' + instruction + '\n\n–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π HTML —Ü–µ–ª–∏–∫–æ–º.' }
  ];

  try {
    // Try cascade first (fast)
    let result = await sendCascadeChat(messages, systemPrompt);
    let aiText = result ? result.text : '';
    let provider = result ? result.provider : '';

    // If cascade fails or returns non-HTML, fall back to Claude
    if (!aiText || (!aiText.includes('<!DOCTYPE') && !aiText.includes('<html') && !aiText.includes('<body'))) {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 90000);
      const res = await fetch(CONFIG.AI_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: '–¢–µ–∫—É—â–∏–π HTML —Å–∞–π—Ç–∞ (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ):\n\n' + currentHtml.slice(0, 40000) + '\n\n–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: ' + instruction + '\n\n–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π HTML —Ü–µ–ª–∏–∫–æ–º.',
          context: 'site_edit',
          source: 'web',
          user: USER?.name || '',
          systemPrompt: systemPrompt
        }),
        signal: controller.signal
      });
      clearTimeout(timeout);
      const raw = await res.json();
      let data = raw;
      if (Array.isArray(raw)) data = raw[0] || {};
      if (data.json) data = data.json;
      aiText = data.reply || data.response || data.text || data.message || '';
      if (!aiText && data.content) { try { aiText = data.content[0].text; } catch(e) {} }
      provider = 'claude';
    }

    // Extract HTML from response (may have markdown code blocks)
    let newHtml = aiText;
    const htmlMatch = aiText.match(/```(?:html)?\s*\n?([\s\S]*?)```/);
    if (htmlMatch) newHtml = htmlMatch[1];
    // Also try to extract between DOCTYPE and </html>
    const dtMatch = newHtml.match(/(<!DOCTYPE[\s\S]*<\/html>)/i);
    if (dtMatch) newHtml = dtMatch[1];

    if (newHtml && (newHtml.includes('<html') || newHtml.includes('<body') || newHtml.includes('<!DOCTYPE'))) {
      // Check for ===HTML_START=== / ===HTML_END=== markers
      let changeDescription = '';
      const startMarker = aiText.indexOf('===HTML_START===');
      const endMarker = aiText.indexOf('===HTML_END===');
      if (startMarker !== -1 && endMarker !== -1) {
        newHtml = aiText.substring(startMarker + 16, endMarker).trim();
        changeDescription = aiText.substring(endMarker + 14).trim();
        // Clean up HTML markers
        const dtm = newHtml.match(/(<!DOCTYPE[\s\S]*<\/html>)/i);
        if (dtm) newHtml = dtm[1];
      }

      // Apply changes
      sgd.html = newHtml;
      const iframe = document.getElementById('site-preview-iframe');
      if (iframe) {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        doc.open(); doc.write(newHtml); doc.close();
        iframe.style.boxShadow = '0 0 20px rgba(81,207,102,0.5)';
        iframe.style.border = '2px solid var(--green)';
        setTimeout(() => { iframe.style.boxShadow = ''; iframe.style.border = 'none'; }, 2000);
      }
      const textarea = document.getElementById('site-code-textarea');
      if (textarea) textarea.value = newHtml;
      const pre = document.querySelector('#site-code-block pre');
      if (pre) pre.textContent = newHtml;

      const badge = getAiProviderBadge(provider);
      const descText = changeDescription ? '<br><span style="color:var(--text2);font-size:12px">üìù ' + esc(changeDescription) + '</span>' : '';
      if (chatMsgs) {
        chatMsgs.innerHTML += '<div style="padding:8px;background:rgba(81,207,102,0.08);border-radius:8px;margin-bottom:6px;font-size:13px"><strong style="color:var(--green)">‚úÖ AI:</strong> –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã! ' + badge + descText + '</div>';
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
      }
      saveSiteAiChat(currentSubproject);
      toast('‚úÖ AI –æ–±–Ω–æ–≤–∏–ª —Å–∞–π—Ç', 'success');
    } else if (aiText && aiText.trim().length > 10) {
      // AI returned a text answer (question mode)
      const badge = getAiProviderBadge(provider);
      const formattedText = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
      if (chatMsgs) {
        chatMsgs.innerHTML += '<div style="padding:10px;background:rgba(177,151,252,0.08);border-radius:8px;margin-bottom:6px;font-size:13px"><strong style="color:var(--purple)">ü§ñ AI:</strong> ' + formattedText + ' ' + badge + '</div>';
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
      }
      saveSiteAiChat(currentSubproject);
      toast('üí¨ AI –æ—Ç–≤–µ—Ç–∏–ª', 'info');
    } else {
      // AI returned empty or non-useful response
      if (chatMsgs) {
        chatMsgs.innerHTML += '<div style="padding:8px;background:rgba(255,107,107,0.08);border-radius:8px;margin-bottom:6px;font-size:13px"><strong style="color:var(--red)">AI:</strong> –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å</div>';
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
      }
      saveSiteAiChat(currentSubproject);
      toast('AI –Ω–µ –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑', 'warning');
    }
  } catch(e) {
    console.error('Site AI edit error:', e);
    const isAbort = e.name === 'AbortError';
    if (chatMsgs) {
      chatMsgs.innerHTML += '<div style="padding:8px;background:rgba(255,107,107,0.08);border-radius:8px;font-size:13px"><strong style="color:var(--red)">‚ùå</strong> ' + (isAbort ? '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è' : esc(e.message)) + '</div>';
    }
    toast(isAbort ? '‚è± –¢–∞–π–º–∞—É—Ç ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑' : '–û—à–∏–±–∫–∞: ' + e.message, 'error');
    saveSiteAiChat(currentSubproject);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = '‚ú® –ü—Ä–∏–º–µ–Ω–∏—Ç—å'; }
    const ol = document.getElementById('site-ai-loading-overlay');
    if (ol) ol.remove();
    const th = document.getElementById('site-ai-thinking');
    if (th) th.remove();
  }
}

// === GITHUB PAGES PUBLISHING ===

// Site AI chat persistence
function saveSiteAiChat(spName) {
  if (!spName) return;
  const chatMsgs = document.getElementById('site-ai-chat-msgs');
  if (!chatMsgs) return;
  try {
    localStorage.setItem('rkt_site_ai_chat_' + spName, chatMsgs.innerHTML);
  } catch(e) { console.warn('Chat save error:', e); }
}

function loadSiteAiChat(spName) {
  if (!spName) return;
  const chatMsgs = document.getElementById('site-ai-chat-msgs');
  if (!chatMsgs) return;
  try {
    const saved = localStorage.getItem('rkt_site_ai_chat_' + spName);
    if (saved) {
      chatMsgs.innerHTML = saved;
      chatMsgs.scrollTop = chatMsgs.scrollHeight;
    }
  } catch(e) { console.warn('Chat load error:', e); }
}
async function promptGitHubToken() {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center';
    overlay.innerHTML = '<div style="background:var(--bg2);border-radius:12px;padding:24px;max-width:480px;width:90%">' +
      '<h3 style="margin-bottom:12px">üîë GitHub Token –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</h3>' +
      '<p style="font-size:13px;color:var(--text2);margin-bottom:16px">–î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–∞–π—Ç–æ–≤ –Ω—É–∂–µ–Ω GitHub Personal Access Token. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –æ–¥–∏–Ω —Ä–∞–∑:</p>' +
      '<ol style="font-size:12px;color:var(--text2);margin-bottom:16px;padding-left:20px">' +
      '<li>–û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://github.com/settings/tokens?type=beta" target="_blank" style="color:var(--accent)">github.com/settings/tokens</a></li>' +
      '<li>–ù–∞–∂–º–∏—Ç–µ "Generate new token" ‚Üí Fine-grained</li>' +
      '<li>Repository access ‚Üí Only select ‚Üí <b>' + CONFIG.GITHUB_REPO.split('/')[1] + '</b></li>' +
      '<li>Permissions ‚Üí Contents ‚Üí Read and Write</li>' +
      '<li>Generate token ‚Üí —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ</li></ol>' +
      '<input type="text" id="gh-token-input" placeholder="ghp_xxxx... –∏–ª–∏ github_pat_xxxx..." style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--bg3);color:var(--text);font-family:monospace;font-size:12px;margin-bottom:12px">' +
      '<div style="display:flex;gap:8px">' +
      '<button id="gh-token-save" class="btn btn-primary" style="flex:1">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>' +
      '<button id="gh-token-cancel" class="btn btn-secondary" style="flex:0">–û—Ç–º–µ–Ω–∞</button>' +
      '</div></div>';
    document.body.appendChild(overlay);
    overlay.querySelector('#gh-token-save').onclick = () => {
      const token = overlay.querySelector('#gh-token-input').value.trim();
      if (token) {
        localStorage.setItem('github_token', token);
        document.body.removeChild(overlay);
        resolve(token);
      } else {
        toast('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error');
      }
    };
    overlay.querySelector('#gh-token-cancel').onclick = () => {
      document.body.removeChild(overlay);
      resolve(null);
    };
  });
}

async function publishToGitHub(html, slug) {
  let token = localStorage.getItem('github_token');
  if (!token) {
    token = await promptGitHubToken();
    if (!token) return null;
  }

  const repo = CONFIG.GITHUB_REPO;
  const path = 'clients/' + slug + '.html';
  const apiBase = 'https://api.github.com/repos/' + repo + '/contents/' + path;

  // UTF-8 ‚Üí Base64 (supports Cyrillic)
  const content = btoa(unescape(encodeURIComponent(html)));

  // Check if file exists (need SHA for update)
  let sha = null;
  try {
    const checkRes = await fetch(apiBase, {
      headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github+json' }
    });
    if (checkRes.ok) {
      const d = await checkRes.json();
      sha = d.sha;
    } else if (checkRes.status === 401 || checkRes.status === 403) {
      // Token invalid ‚Äî clear and retry
      localStorage.removeItem('github_token');
      toast('‚ùå GitHub token –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π.', 'error');
      token = await promptGitHubToken();
      if (!token) return null;
      // Retry check
      const retryRes = await fetch(apiBase, {
        headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github+json' }
      });
      if (retryRes.ok) { sha = (await retryRes.json()).sha; }
    }
  } catch(e) { console.warn('GitHub check error:', e); }

  const body = { message: 'Publish: ' + slug, content: content };
  if (sha) body.sha = sha;

  const res = await fetch(apiBase, {
    method: 'PUT',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Accept': 'application/vnd.github+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    const errData = await res.json().catch(() => ({}));
    if (res.status === 401 || res.status === 403) {
      localStorage.removeItem('github_token');
      throw new Error('GitHub token –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
    }
    throw new Error('GitHub API: ' + (errData.message || res.status));
  }

  // GitHub Pages URL: user.github.io/repoName/path (for project repos)
  // or user.github.io/path (for user.github.io repo)
  const owner = repo.split('/')[0];
  const repoName = repo.split('/')[1];
  const isUserRepo = repoName === owner + '.github.io';
  const publicUrl = 'https://' + owner + '.github.io/' + (isUserRepo ? '' : repoName + '/') + path;
  return publicUrl;
}

async function publishSite() {
  const sgd = getSiteGenData();
  const html = sgd.html;
  if (!html) { toast('–ù–µ—Ç HTML –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏','error'); return; }
  const dir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  if (!dir) { toast('–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ','error'); return; }
  const dirId = dir['ID'] || dir.id;
  const fileName = slugify(currentSubproject||'site') + '.html';
  const filePath = 'sites/' + dirId + '/' + fileName;

  toast('–ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ GitHub Pages...','info');
  try {
    // Ensure charset meta tag exists
    let finalHtml = html;
    if (finalHtml && !finalHtml.includes('charset=') && !finalHtml.includes('charset =')) {
      finalHtml = finalHtml.replace(/<head>/i, '<head>\n<meta charset="UTF-8">');
    }

    // Publish to GitHub Pages
    const slug = slugify(currentSubproject || 'site');
    const publicUrl = await publishToGitHub(finalHtml, slug);
    if (!publicUrl) { toast('–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞','warning'); return; }

    // Save URL and HTML to directions table
    await SB.from('directions').update({
      site_url: publicUrl,
      site_html: finalHtml.substring(0, 50000) // limit to 50KB for DB
    }).eq('id', dirId);

    toast('‚úÖ –°–∞–π—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –Ω–∞ GitHub Pages!', 'success');
    // Copy URL to clipboard
    try { await navigator.clipboard.writeText(publicUrl); toast('üìã –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: ' + publicUrl, 'info'); } catch(e) {}
    await loadData();
    renderSubprojectView();
  } catch(e) {
    console.error('Publish error:', e);
    toast('‚ùå ' + (e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.'), 'error');
  }
}

function fillSiteDemo() {
  const demos = {
    '–ü—ã—à–∫–∏ –º–∏—Ä–∞': {name:'–ü—ã—à–∫–∏ –º–∏—Ä–∞',type:'–ö–∞—Ñ–µ-–ø–µ–∫–∞—Ä–Ω—è',city:'–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã',address:'–ø—Ä. –ú–∏—Ä–∞, 32',phone:'+7 917 234-56-78',social:'@pyshki_mira',hours:'–ü–Ω-–í—Å 08:00-22:00',desc:'–£—é—Ç–Ω–∞—è –ø–µ–∫–∞—Ä–Ω—è —Å –¥–æ–º–∞—à–Ω–∏–º–∏ –ø—ã—à–∫–∞–º–∏ –ø–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º —Ä–µ—Ü–µ–ø—Ç–∞–º. –°–≤–µ–∂–∞—è –≤—ã–ø–µ—á–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å, –∞—Ä–æ–º–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –∏ —Ç—ë–ø–ª–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞. –†–∞–±–æ—Ç–∞–µ–º —Å 2023 –≥–æ–¥–∞.',services:'–ü—ã—à–∫–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ, –ü—ã—à–∫–∏ —Å –≤–∞—Ä–µ–Ω—å–µ–º, –ü—ã—à–∫–∏ —Å —à–æ–∫–æ–ª–∞–¥–æ–º, –ü—ã—à–∫–∏ —Å—ã—Ä–Ω—ã–µ, –ö–æ—Ñ–µ —ç—Å–ø—Ä–µ—Å—Å–æ, –ö–∞–ø—É—á–∏–Ω–æ, –õ–∞—Ç—Ç–µ, –ß–∞–π, –ö–∞–∫–∞–æ, –î–æ—Å—Ç–∞–≤–∫–∞',prices:'–ü—ã—à–∫–∏ –æ—Ç 45‚ÇΩ, –∫–æ—Ñ–µ –æ—Ç 120‚ÇΩ, –∫–æ–º–±–æ –æ—Ç 199‚ÇΩ',theme:'warm',style:'playful'},
    '–ë—Ä–µ–∂–Ω–µ–≤': {name:'–ë—Ä–µ–∂–Ω–µ–≤',type:'–†–µ—Å—Ç–æ–∫–ª—É–±',city:'–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã',address:'—É–ª. –°–æ–≤–µ—Ç—Å–∫–∞—è, 15',phone:'+7 917 345-67-89',social:'@brezhnev_club',hours:'–ü–Ω-–ß—Ç 12:00-00:00, –ü—Ç-–°–± 12:00-03:00, –í—Å 12:00-22:00',desc:'–†–µ—Å—Ç–æ–∫–ª—É–± –≤ —Å–æ–≤–µ—Ç—Å–∫–æ–º —Å—Ç–∏–ª–µ. –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –°–°–°–†: —Ä–µ—Ç—Ä–æ-–∏–Ω—Ç–µ—Ä—å–µ—Ä, –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—Å–∫–∏–µ –±–ª—é–¥–∞ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∫—É—Ö–Ω—è. –ñ–∏–≤–∞—è –º—É–∑—ã–∫–∞ –ø–æ –ø—è—Ç–Ω–∏—Ü–∞–º.',services:'–û–±–µ–¥—ã, –£–∂–∏–Ω—ã, –ë–∞–Ω–∫–µ—Ç—ã, –ö–∞—Ä–∞–æ–∫–µ, –ñ–∏–≤–∞—è –º—É–∑—ã–∫–∞, –ë–∞—Ä, –ö–∞–ª—å—è–Ω, –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',prices:'–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ 1200‚ÇΩ, –±–∏–∑–Ω–µ—Å-–ª–∞–Ω—á 350‚ÇΩ',theme:'dark',style:'retro'},
  };
  const demo = demos[currentSubproject] || demos['–ü—ã—à–∫–∏ –º–∏—Ä–∞'];
  Object.keys(demo).forEach(k => {
    const el = document.getElementById('sg-' + k);
    if (el) el.value = demo[k];
  });
  toast('–ü—Ä–∏–º–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω!','success');
}

// ==================== SITE CREATION WIZARD ====================
let wizardStep = 1;
let wizardData = {};

function openSiteWizard() {
  if (!currentSubproject) { toast('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞','warning'); return; }
  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));

  // Pre-fill from existing direction data
  wizardData = {
    name: dir?.['–ù–∞–∑–≤–∞–Ω–∏–µ'] || dir?.['name'] || '',
    business_type: dir?.['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || dir?.['–û–ø–∏—Å–∞–Ω–∏–µ'] || '',
    city: dir?.['–ì–æ—Ä–æ–¥'] || '',
    phone: dir?.['–¢–µ–ª–µ—Ñ–æ–Ω'] || '',
    social: dir?.['–°–æ—Ü—Å–µ—Ç–∏'] || dir?.['social'] || '',
    description: dir?.['–û–ø–∏—Å–∞–Ω–∏–µ'] || '',
    services: dir?.['–£—Å–ª—É–≥–∏'] || '',
    prices: dir?.['–¶–µ–Ω—ã'] || '',
    work_hours: dir?.['–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã'] || '',
    address: dir?.['–ê–¥—Ä–µ—Å'] || '',
    theme: dir?.['–°—Ç–∏–ª—å'] || 'auto',
    style: 'modern',
    wishes: dir?.['–ê–Ω–∫–µ—Ç–∞'] || '',
    site_type: dir?.['–¢–∏–ø —Å–∞–π—Ç–∞'] || '–õ–µ–Ω–¥–∏–Ω–≥',
    logo_url: dir?.['logo_url'] || '',
    photos: dir?.['photos'] || ''
  };
  wizardStep = 1;
  renderWizard();
}

function renderWizard() {
  const steps = [
    { num:1, title:'–û –∫–ª–∏–µ–Ω—Ç–µ', icon:'üë§' },
    { num:2, title:'–ö–æ–Ω—Ç–µ–Ω—Ç', icon:'üìù' },
    { num:3, title:'–î–∏–∑–∞–π–Ω', icon:'üé®' },
    { num:4, title:'–ì–µ–Ω–µ—Ä–∞—Ü–∏—è', icon:'üöÄ' }
  ];

  let html = '<div id="site-wizard-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;display:flex;align-items:center;justify-content:center;padding:16px">';
  html += '<div style="background:var(--bg);border-radius:16px;max-width:640px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.4)">';

  // Header with progress
  html += '<div style="padding:20px 24px 0;position:sticky;top:0;background:var(--bg);border-radius:16px 16px 0 0;z-index:1">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">';
  html += '<div style="display:flex;align-items:center;gap:12px"><h2 style="margin:0;font-size:18px">üåê –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–∞</h2><span id="wizard-save-indicator" style="font-size:10px;color:var(--green)">üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span></div>';
  html += '<button onclick="closeWizard()" style="background:none;border:none;font-size:22px;cursor:pointer;color:var(--text2);padding:4px 8px">‚úï</button>';
  html += '</div>';

  // Progress bar
  html += '<div style="display:flex;gap:4px;margin-bottom:16px">';
  steps.forEach(s => {
    const active = s.num === wizardStep;
    const done = s.num < wizardStep;
    const bg = done ? 'var(--accent)' : active ? 'var(--accent)' : 'var(--bg3)';
    const opacity = active ? '1' : done ? '0.7' : '0.3';
    html += '<div style="flex:1;text-align:center">';
    html += '<div style="height:4px;background:'+bg+';border-radius:2px;margin-bottom:6px;opacity:'+opacity+'"></div>';
    html += '<div style="font-size:11px;color:'+(active?'var(--accent)':'var(--text2)')+'">'+s.icon+' '+s.title+'</div>';
    html += '</div>';
  });
  html += '</div></div>';

  // Content
  html += '<div style="padding:0 24px 24px">';
  const d = wizardData;

  if (wizardStep === 1) {
    html += '<h3 style="font-size:15px;margin:0 0 16px">üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>';
    html += wizField('–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ *', 'name', d.name, 'text', '–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã –ú–∞—Ä–∏—è');
    html += wizField('–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞ / –ø—Ä–æ–µ–∫—Ç–∞ *', 'business_type', d.business_type, 'text', '–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞—Ä–±–µ—Ä—à–æ–ø, –ö–∞—Ñ–µ, –°–≤–∞–¥—å–±–∞');
    html += wizField('–ì–æ—Ä–æ–¥', 'city', d.city, 'text', '–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–º–∞—Ç—ã');
    html += wizField('–¢–µ–ª–µ—Ñ–æ–Ω', 'phone', d.phone, 'text', '+7 777 123 4567');
    html += wizField('–°–æ—Ü—Å–µ—Ç–∏ (Instagram, Telegram)', 'social', d.social, 'text', '@username –∏–ª–∏ —Å—Å—ã–ª–∫–∞');
  } else if (wizardStep === 2) {
    html += '<h3 style="font-size:15px;margin:0 0 16px">üìù –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–∞–π—Ç–∞</h3>';
    html += wizField('–û–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ *', 'description', d.description, 'textarea', '–ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è, –¥–ª—è –∫–æ–≥–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –æ—Å–æ–±–µ–Ω–Ω—ã–º');
    html += wizField('–£—Å–ª—É–≥–∏ / –ú–µ–Ω—é', 'services', d.services, 'textarea', '–°—Ç—Ä–∏–∂–∫–∞ - 3000‚Ç∏, –û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ - 8000‚Ç∏...');
    html += wizField('–¶–µ–Ω—ã', 'prices', d.prices, 'text', '–æ—Ç 5000‚Ç∏ –∏–ª–∏ —Å–ø–∏—Å–æ–∫ —Ü–µ–Ω');
    html += wizField('–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã', 'work_hours', d.work_hours, 'text', '–ü–Ω-–ü—Ç 9:00-18:00, –°–± 10:00-15:00');
    html += wizField('–ê–¥—Ä–µ—Å', 'address', d.address, 'text', '—É–ª. –ê–±–∞—è 52, –æ—Ñ–∏—Å 301');
  } else if (wizardStep === 3) {
    html += '<h3 style="font-size:15px;margin:0 0 16px">üé® –î–∏–∑–∞–π–Ω —Å–∞–π—Ç–∞</h3>';
    // Theme selection
    html += '<div style="margin-bottom:16px"><label style="font-size:13px;font-weight:600;margin-bottom:8px;display:block">–¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞</label>';
    html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">';
    const themes = [
      { id:'auto', name:'–ê–≤—Ç–æ', emoji:'üéØ', desc:'–ò–ò –ø–æ–¥–±–µ—Ä—ë—Ç' },
      { id:'warm', name:'–¢—ë–ø–ª–∞—è', emoji:'üåÖ', desc:'–û—Ä–∞–Ω–∂–µ–≤—ã–π/–∫—Ä–∞—Å–Ω—ã–π' },
      { id:'cool', name:'–•–æ–ª–æ–¥–Ω–∞—è', emoji:'‚ùÑÔ∏è', desc:'–°–∏–Ω–∏–π/–≥–æ–ª—É–±–æ–π' },
      { id:'dark', name:'–¢—ë–º–Ω–∞—è', emoji:'üåô', desc:'–¢—ë–º–Ω—ã–π —Ñ–æ–Ω' },
      { id:'nature', name:'–ü—Ä–∏—Ä–æ–¥–∞', emoji:'üåø', desc:'–ó–µ–ª—ë–Ω—ã–π' },
      { id:'luxury', name:'–ü—Ä–µ–º–∏—É–º', emoji:'‚ú®', desc:'–ó–æ–ª–æ—Ç–æ/—á—ë—Ä–Ω—ã–π' }
    ];
    themes.forEach(t => {
      const sel = d.theme === t.id;
      html += '<div onclick="selectWizTheme(\''+t.id+'\')" data-wizard-theme="'+t.id+'" style="padding:12px;border-radius:10px;border:2px solid '+(sel?'var(--accent)':'var(--border)')+';cursor:pointer;text-align:center;background:'+(sel?'rgba(0,212,170,.08)':'var(--bg2)')+';transition:all .2s">';
      html += '<div style="font-size:24px">'+t.emoji+'</div>';
      html += '<div style="font-size:12px;font-weight:600;margin-top:4px">'+t.name+'</div>';
      html += '<div style="font-size:10px;color:var(--text2)">'+t.desc+'</div>';
      html += '</div>';
    });
    html += '</div></div>';
    // Style selection
    html += '<div style="margin-bottom:16px"><label style="font-size:13px;font-weight:600;margin-bottom:8px;display:block">–°—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞</label>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:8px">';
    const styles = ['modern','minimal','retro','classic','playful'];
    const styleLabels = { modern:'–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π', minimal:'–ú–∏–Ω–∏–º–∞–ª', retro:'–†–µ—Ç—Ä–æ', classic:'–ö–ª–∞—Å—Å–∏–∫–∞', playful:'–Ø—Ä–∫–∏–π' };
    styles.forEach(s => {
      const sel = d.style === s;
      html += '<button type="button" onclick="selectWizStyle(\''+s+'\')" data-wizard-style="'+s+'" style="padding:8px 16px;border-radius:20px;border:2px solid '+(sel?'var(--accent)':'var(--border)')+';cursor:pointer;font-size:12px;background:'+(sel?'rgba(0,212,170,.08)':'var(--bg2)')+';color:'+(sel?'var(--accent)':'var(--text1)')+';transition:all .2s">';
      html += (styleLabels[s]||s)+'</button>';
    });
    html += '</div></div>';
    html += wizField('–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è', 'wishes', d.wishes, 'textarea', '–õ—é–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: —Ü–≤–µ—Ç, —Å—Ç–∏–ª—å, –ø—Ä–∏–º–µ—Ä—ã —Å–∞–π—Ç–æ–≤...');
    // Show logo if exists
    if (d.logo_url) {
      html += '<div style="margin-top:8px;display:flex;align-items:center;gap:8px"><img src="'+escA(d.logo_url)+'" style="width:48px;height:48px;border-radius:8px;object-fit:cover"><span style="font-size:12px;color:var(--text2)">‚úÖ –õ–æ–≥–æ—Ç–∏–ø –∑–∞–≥—Ä—É–∂–µ–Ω</span></div>';
    }
  } else if (wizardStep === 4) {
    html += '<h3 style="font-size:15px;margin:0 0 16px">üöÄ –í—Å—ë –≥–æ—Ç–æ–≤–æ!</h3>';
    // Summary
    html += '<div style="background:var(--bg2);border-radius:12px;padding:16px;margin-bottom:16px">';
    const summary = [
      ['üìå –ù–∞–∑–≤–∞–Ω–∏–µ', d.name],
      ['üíº –¢–∏–ø', d.business_type],
      ['üìç –ì–æ—Ä–æ–¥', d.city],
      ['üì± –¢–µ–ª–µ—Ñ–æ–Ω', d.phone],
      ['üìù –û–ø–∏—Å–∞–Ω–∏–µ', d.description ? d.description.substring(0,80)+'...' : ''],
      ['üé® –¢–µ–º–∞', themes?.find(t=>t.id===d.theme)?.name || d.theme],
    ];
    summary.forEach(([label, val]) => {
      if (val) {
        html += '<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;border-bottom:1px solid var(--border)">';
        html += '<span style="color:var(--text2)">'+label+'</span><span style="font-weight:500">'+esc(val)+'</span></div>';
      }
    });
    html += '</div>';

    html += '<div id="wizard-gen-progress" style="display:none;margin-bottom:16px">';
    html += '<div style="background:var(--bg3);border-radius:8px;overflow:hidden;height:8px;margin-bottom:8px">';
    html += '<div id="wizard-progress-bar" style="height:100%;background:var(--accent);width:0%;transition:width .5s ease;border-radius:8px"></div></div>';
    html += '<div id="wizard-progress-text" style="font-size:12px;color:var(--text2);text-align:center">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>';
    html += '</div>';

    html += '<div id="wizard-gen-buttons">';
    html += '<button class="btn btn-primary" onclick="wizardGenerate()" style="width:100%;padding:14px;font-size:15px;margin-bottom:8px">ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç —Å –ò–ò</button>';
    html += '<div style="font-size:11px;color:var(--text2);text-align:center">Claude —Å–æ–∑–¥–∞—Å—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–∞–π—Ç (~30 —Å–µ–∫—É–Ω–¥)</div>';
    html += '</div>';

    html += '<div id="wizard-gen-error" style="display:none;margin-top:12px;padding:12px;background:rgba(255,75,75,.08);border-radius:8px;text-align:center">';
    html += '<div style="color:var(--red);font-weight:600;margin-bottom:8px">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç</div>';
    html += '<button class="btn btn-secondary" onclick="wizardGenerate()" style="font-size:13px">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>';
    html += '</div>';
  }

  // Navigation buttons
  html += '<div style="display:flex;justify-content:space-between;margin-top:20px;gap:12px">';
  if (wizardStep > 1) {
    html += '<button class="btn btn-secondary" onclick="wizardPrev()" style="padding:10px 24px">‚Üê –ù–∞–∑–∞–¥</button>';
  } else {
    html += '<div></div>';
  }
  if (wizardStep < 4) {
    html += '<button class="btn btn-primary" onclick="wizardNext()" style="padding:10px 24px">–î–∞–ª–µ–µ ‚Üí</button>';
  }
  html += '</div>';

  html += '</div></div></div>';

  // Remove existing wizard if any
  const existing = document.getElementById('site-wizard-overlay');
  if (existing) existing.remove();

  document.body.insertAdjacentHTML('beforeend', html);
}

const debouncedWizardSave = debounce(async function() {
  collectWizardFields();
  const ind = document.getElementById('wizard-save-indicator');
  if (ind) { ind.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é...'; ind.style.color = 'var(--text2)'; }
  await autoSaveWizardData();
  if (ind) { ind.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; ind.style.color = 'var(--green)'; }
}, 1500);

function wizField(label, key, value, type, placeholder) {
  const req = label.includes('*') ? ' <span style="color:var(--red)">*</span>' : '';
  const cleanLabel = label.replace(' *','');
  let h = '<div style="margin-bottom:14px">';
  h += '<label style="font-size:12px;font-weight:500;margin-bottom:4px;display:block;color:var(--text2)">'+cleanLabel+req+'</label>';
  if (type === 'textarea') {
    h += '<textarea data-wizard="'+key+'" oninput="debouncedWizardSave()" placeholder="'+escA(placeholder||'')+'" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg2);color:var(--text1);font-size:14px;min-height:80px;resize:vertical">'+esc(value||'')+'</textarea>';
  } else {
    h += '<input type="'+type+'" data-wizard="'+key+'" oninput="debouncedWizardSave()" value="'+escA(value||'')+'" placeholder="'+escA(placeholder||'')+'" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg2);color:var(--text1);font-size:14px">';
  }
  h += '</div>';
  return h;
}

function selectWizTheme(id) {
  wizardData.theme = id;
  document.querySelectorAll('[data-wizard-theme]').forEach(el => {
    const sel = el.dataset.wizardTheme === id;
    el.style.borderColor = sel ? 'var(--accent)' : 'var(--border)';
    el.style.background = sel ? 'rgba(0,212,170,.08)' : 'var(--bg2)';
  });
}

function selectWizStyle(id) {
  wizardData.style = id;
  document.querySelectorAll('[data-wizard-style]').forEach(el => {
    const sel = el.dataset.wizardStyle === id;
    el.style.borderColor = sel ? 'var(--accent)' : 'var(--border)';
    el.style.background = sel ? 'rgba(0,212,170,.08)' : 'var(--bg2)';
    el.style.color = sel ? 'var(--accent)' : 'var(--text1)';
  });
}

function collectWizardFields() {
  document.querySelectorAll('[data-wizard]').forEach(el => {
    wizardData[el.dataset.wizard] = el.value || '';
  });
}

function wizardNext() {
  collectWizardFields();
  // Validate required fields
  if (wizardStep === 1 && (!wizardData.name?.trim() || !wizardData.business_type?.trim())) {
    toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞','warning'); return;
  }
  if (wizardStep === 2 && !wizardData.description?.trim()) {
    toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞','warning'); return;
  }
  wizardStep++;
  autoSaveWizardData();
  renderWizard();
}

function wizardPrev() {
  collectWizardFields();
  wizardStep--;
  renderWizard();
}

function closeWizard() {
  // Auto-save before closing
  collectWizardFields();
  autoSaveWizardData();
  const overlay = document.getElementById('site-wizard-overlay');
  if (overlay) overlay.remove();
  toast('üíæ –î–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'info');
}

async function autoSaveWizardData() {
  // Save wizard data back to direction in background
  if (!currentSubproject) return;
  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  if (!dir || !dir.id) return;
  const d = wizardData;
  try {
    await SB.from('directions').update({
      description: d.description || null,
      city: d.city || null,
      phone: d.phone || null,
      social: d.social || null,
      services: d.services || null,
      prices: d.prices || null,
      work_hours: d.work_hours || null,
      address: d.address || null,
      style: d.theme || null,
      business_type: d.business_type || null,
      questionnaire: d.wishes || null
    }).eq('id', dir.id);
  } catch(e) { console.warn('Wizard auto-save failed:', e); }
}

async function wizardGenerate() {
  collectWizardFields();
  const d = wizardData;
  if (!d.name?.trim()) { toast('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞','error'); return; }

  // Show progress
  const progressDiv = document.getElementById('wizard-gen-progress');
  const progressBar = document.getElementById('wizard-progress-bar');
  const progressText = document.getElementById('wizard-progress-text');
  const buttonsDiv = document.getElementById('wizard-gen-buttons');
  const errorDiv = document.getElementById('wizard-gen-error');

  if (progressDiv) progressDiv.style.display = 'block';
  if (buttonsDiv) buttonsDiv.style.display = 'none';
  if (errorDiv) errorDiv.style.display = 'none';

  // Animate progress
  let progress = 0;
  const animateProgress = (target, text) => {
    progress = target;
    if (progressBar) progressBar.style.width = progress+'%';
    if (progressText) progressText.textContent = text;
  };

  animateProgress(10, '–°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ...');

  // Fill the site generator form fields in background
  await autoSaveWizardData();

  animateProgress(15, 'ü§ñ –ò–ò —Å–æ–∑–¥–∞—ë—Ç —Å–∞–π—Ç...');

  // Smooth progress animation while generating
  const progressInterval = setInterval(() => {
    if (progress < 85) {
      progress += Math.random() * 3;
      if (progressBar) progressBar.style.width = Math.min(progress, 85)+'%';
    }
  }, 500);

  try {
    // Set form values for generateSite()
    closeWizard();
    showSpTab('sitegen');

    // Fill site gen form with wizard data
    setTimeout(() => {
      const fields = {
        'sg-name': d.name, 'sg-type': d.business_type, 'sg-city': d.city,
        'sg-address': d.address, 'sg-phone': d.phone, 'sg-social': d.social,
        'sg-hours': d.work_hours, 'sg-desc': d.description, 'sg-services': d.services,
        'sg-prices': d.prices, 'sg-theme': d.theme, 'sg-style': d.style, 'sg-extra': d.wishes
      };
      for (const [id, val] of Object.entries(fields)) {
        const el = document.getElementById(id);
        if (el && val) el.value = val;
      }
      generateSite();
    }, 300);

  } catch(e) {
    console.error('Wizard generation failed:', e);
  } finally {
    clearInterval(progressInterval);
  }
}

function sendSiteToClient() {
  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  if (!dir?.['site_url']) { toast('–°–Ω–∞—á–∞–ª–∞ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ —Å–∞–π—Ç','warning'); return; }
  const url = dir['site_url'];
  const username = dir?.['–°–æ—Ü—Å–µ—Ç–∏']?.match(/@(\w+)/)?.[1] || '';
  const tgId = '';

  if (username) {
    // Open Telegram with the link
    const text = encodeURIComponent('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∞—à —Å–∞–π—Ç –≥–æ—Ç–æ–≤: ' + url);
    window.open('https://t.me/'+username+'?text='+text, '_blank');
    toast('–û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏','success');
  } else {
    // Copy to clipboard
    navigator.clipboard.writeText(url).then(() => {
      toast('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–ª–∏–µ–Ω—Ç—É: '+url,'success');
    }).catch(() => {
      prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:', url);
    });
  }
}

// ==================== END SITE WIZARD ====================

async function generateSite() {
  const name = document.getElementById('sg-name')?.value?.trim();
  const type = document.getElementById('sg-type')?.value?.trim();
  const desc = document.getElementById('sg-desc')?.value?.trim();
  if (!name || !type || !desc) { toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (*)','error'); return; }

  const sgd = getSiteGenData();
  Object.assign(sgd, {
    name, type, desc,
    city: document.getElementById('sg-city')?.value?.trim() || '',
    address: document.getElementById('sg-address')?.value?.trim() || '',
    phone: document.getElementById('sg-phone')?.value?.trim() || '',
    social: document.getElementById('sg-social')?.value?.trim() || '',
    hours: document.getElementById('sg-hours')?.value?.trim() || '',
    services: document.getElementById('sg-services')?.value?.trim() || '',
    prices: document.getElementById('sg-prices')?.value?.trim() || '',
    theme: document.getElementById('sg-theme')?.value || 'auto',
    style: document.getElementById('sg-style')?.value || 'modern',
    extra: document.getElementById('sg-extra')?.value?.trim() || ''
  });
  // Add logo/photos + anketa data from direction record
  const genDir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  if (genDir) {
    sgd.logo = genDir['logo_url'] || '';
    sgd.photos = genDir['photos'] || '';
    // Merge anketa data (only if form fields are empty)
    if (!sgd.city && genDir['–ì–æ—Ä–æ–¥']) sgd.city = genDir['–ì–æ—Ä–æ–¥'];
    if (!sgd.phone && genDir['–¢–µ–ª–µ—Ñ–æ–Ω']) sgd.phone = genDir['–¢–µ–ª–µ—Ñ–æ–Ω'];
    if (!sgd.address && genDir['–ê–¥—Ä–µ—Å']) sgd.address = genDir['–ê–¥—Ä–µ—Å'];
    if (!sgd.social && genDir['–°–æ—Ü—Å–µ—Ç–∏']) sgd.social = genDir['–°–æ—Ü—Å–µ—Ç–∏'];
    if (!sgd.hours && genDir['–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã']) sgd.hours = genDir['–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã'];
    if (!sgd.services && genDir['–£—Å–ª—É–≥–∏']) sgd.services = genDir['–£—Å–ª—É–≥–∏'];
    if (!sgd.prices && genDir['–¶–µ–Ω—ã']) sgd.prices = genDir['–¶–µ–Ω—ã'];
    if (!sgd.desc || sgd.desc === name) {
      // Enhance description with business type from anketa
      const bizType = genDir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || '';
      if (bizType) sgd.desc = bizType + '. ' + sgd.desc;
    }
    // Parse questionnaire JSON for additional info (v1 and v2)
    try {
      const q = JSON.parse(genDir['–ê–Ω–∫–µ—Ç–∞'] || '{}');
      if (q._version === 2) {
        // v2 questionnaire ‚Äî rich structured data from AI chat
        if (!sgd.type && q.business_info?.type) sgd.type = q.business_info.type;
        if (!sgd.city && q.business_info?.city) sgd.city = q.business_info.city;
        if (!sgd.address && q.business_info?.address) sgd.address = q.business_info.address;
        if (!sgd.phone && q.contact?.phone) sgd.phone = q.contact.phone;
        if (!sgd.social && q.contact?.social) sgd.social = q.contact.social;
        if (!sgd.hours && q.contact?.work_hours) sgd.hours = q.contact.work_hours;
        if (!sgd.services && q.content?.services) sgd.services = q.content.services;
        if (!sgd.prices && q.content?.prices) sgd.prices = q.content.prices;
        if (!sgd.desc && q.content?.description) sgd.desc = q.content.description;
        if (q.design?.theme && sgd.theme === 'auto') sgd.theme = q.design.theme;
        if (q.design?.style) sgd.style = q.design.style;
        if (q.design?.wishes) sgd.extra = (sgd.extra || '') + '\n' + q.design.wishes;
        if (q.design?.references?.length) sgd.extra = (sgd.extra || '') + '\n–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã: ' + q.design.references.join(', ');
        if (q.media?.logo_url && !sgd.logo) sgd.logo = q.media.logo_url;
        if (q.media?.photos?.length && !sgd.photos) sgd.photos = JSON.stringify(q.media.photos);
        // Custom fields (business-type-specific)
        if (q.custom && Object.keys(q.custom).length) {
          sgd.extra = (sgd.extra || '') + '\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: ' + Object.entries(q.custom).map(([k,v]) => k + ': ' + v).join(', ');
        }
      } else {
        // v1 questionnaire ‚Äî simple flat JSON
        if (q.wishes && !sgd.extra) sgd.extra = q.wishes;
      }
    } catch(e) {}
    // Warn if completeness is low
    const completeness = genDir.anketa_completeness || genDir['anketa_completeness'] || 0;
    if (completeness > 0 && completeness < 0.5) {
      if (!confirm('–ê–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ ' + Math.round(completeness * 100) + '%. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–±—Ä–∞—Ç—å –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ AI-–∞–≥–µ–Ω—Ç.\n\n–í—Å—ë —Ä–∞–≤–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å?')) {
        siteGenStep = 'form'; renderSubprojectView(); return;
      }
    }
  }
  siteGenStep = 'loading';
  renderSubprojectView();

  try {
    const prompt = buildSitePrompt(sgd);
    const ctrl = new AbortController();
    const tmr = setTimeout(() => ctrl.abort(), 180000);
    
    let response;
    try {
      response = await fetch(CONFIG.AI_URL, {
        method: 'POST', signal: ctrl.signal,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: prompt, direction: currentSubproject, user: USER?.name || '', source: 'web' })
      });
      if (!response.ok) throw new Error('HTTP ' + response.status);
    } catch(e) {
      // For site generation, GET won't work (URL too long) ‚Äî only POST
      throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Web AI workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ n8n. (' + e.message + ')');
    }
    clearTimeout(tmr);

    const raw2 = await response.json();
    let data2 = raw2; if (Array.isArray(raw2)) data2 = raw2[0]||{}; if (data2.json) data2 = data2.json;
    let html = data2.reply || data2.response || data2.text || '';
    
    // Extract HTML from response (Claude may wrap it in ```html blocks)
    const htmlMatch = html.match(/```html\s*([\s\S]*?)```/);
    if (htmlMatch) html = htmlMatch[1].trim();
    else if (!html.trim().startsWith('<!') && !html.trim().startsWith('<html')) {
      // If no HTML detected, try extracting between tags
      const startIdx = html.indexOf('<!DOCTYPE') !== -1 ? html.indexOf('<!DOCTYPE') : html.indexOf('<html');
      if (startIdx !== -1) html = html.substring(startIdx);
    }

    sgd.html = html;
    siteGenStep = 'preview';
    renderSubprojectView();
    
    // Load into iframe
    setTimeout(() => {
      const iframe = document.getElementById('site-preview-iframe');
      if (iframe) {
        const iDoc = iframe.contentDocument || iframe.contentWindow.document;
        iDoc.open(); iDoc.write(html); iDoc.close();
        // Auto-resize iframe
        setTimeout(() => {
          try { iframe.style.height = Math.max(700, iDoc.body.scrollHeight + 50) + 'px'; } catch(e){}
        }, 500);
      }
    }, 100);
    toast('–°–∞–π—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!','success');
  } catch(e) {
    // Fallback: generate site locally with template
    const fallbackHtml = generateLocalSite(sgd);
    if (fallbackHtml) {
      sgd.html = fallbackHtml;
      siteGenStep = 'preview';
      renderSubprojectView();
      setTimeout(() => {
        const iframe = document.getElementById('site-preview-iframe');
        if (iframe) {
          const iDoc = iframe.contentDocument || iframe.contentWindow.document;
          iDoc.open(); iDoc.write(fallbackHtml); iDoc.close();
        }
      }, 100);
      toast('‚ö†Ô∏è –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–æ–∑–¥–∞–Ω —à–∞–±–ª–æ–Ω–Ω—ã–π —Å–∞–π—Ç. –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é.','warning');
    } else {
      siteGenStep = 'form';
      renderSubprojectView();
      toast('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + e.message,'error');
    }
  }
}

function generateLocalSite(d) {
  const themes = {
    warm: {bg:'#FFF8F0',primary:'#E85D04',secondary:'#F48C06',text:'#370617',hero:'linear-gradient(135deg,#E85D04,#F48C06)'},
    cool: {bg:'#F0F4F8',primary:'#1E88E5',secondary:'#42A5F5',text:'#1A237E',hero:'linear-gradient(135deg,#1565C0,#42A5F5)'},
    dark: {bg:'#1a1a2e',primary:'#e94560',secondary:'#0f3460',text:'#eee',hero:'linear-gradient(135deg,#16213e,#0f3460)'},
    nature:{bg:'#F1F8E9',primary:'#2E7D32',secondary:'#66BB6A',text:'#1B5E20',hero:'linear-gradient(135deg,#2E7D32,#66BB6A)'},
    luxury:{bg:'#FFF8E1',primary:'#BF953F',secondary:'#FCF6BA',text:'#3E2723',hero:'linear-gradient(135deg,#BF953F,#AA771C)'},
    auto:  {bg:'#F8F9FA',primary:'#00d4aa',secondary:'#4dabf7',text:'#212529',hero:'linear-gradient(135deg,#00d4aa,#4dabf7)'}
  };
  const t = themes[d.theme] || themes.auto;
  const svc = (d.services||'').split(',').map(s=>s.trim()).filter(Boolean);
  const svcHtml = svc.length ? svc.map(s=>'<div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);text-align:center"><div style="font-size:28px;margin-bottom:8px">‚ú®</div><h3 style="margin:0;font-size:16px">'+s+'</h3></div>').join('') : '';
  
  return `<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${d.name||'–°–∞–π—Ç'}</title>
<meta name="description" content="${(d.desc||'').substring(0,160)}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;color:${t.text};background:${t.bg}}
.hero{background:${t.hero};color:white;padding:100px 20px;text-align:center}
.hero h1{font-size:clamp(28px,5vw,48px);margin-bottom:16px}
.hero p{font-size:18px;opacity:.9;max-width:600px;margin:0 auto 30px}
.btn{display:inline-block;padding:14px 32px;background:white;color:${t.primary};border-radius:50px;text-decoration:none;font-weight:700;transition:.3s;margin:6px}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
.btn-outline{background:transparent;border:2px solid white;color:white}
section{padding:60px 20px;max-width:1000px;margin:0 auto}
h2{font-size:28px;text-align:center;margin-bottom:30px;color:${t.primary}}
.services{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;padding:20px 0}
.contact{background:${t.primary};color:white;padding:50px 20px;text-align:center;border-radius:0}
.contact a{color:white;text-decoration:none;font-size:20px;display:block;margin:8px 0}
footer{text-align:center;padding:20px;font-size:13px;color:#888;background:#111;color:#666}

/* ‚ïê‚ïê‚ïê ADMIN PANEL RESPONSIVE ‚ïê‚ïê‚ïê */
#page-admin { overflow-x: hidden; }
#page-admin * { box-sizing: border-box; }
#page-admin input, #page-admin textarea, #page-admin select { max-width: 100%; }
#page-admin .page-header { flex-wrap: wrap; gap: 8px; }
#page-admin .page-header h2 { font-size: 22px; word-break: break-word; }
#adm-key-indicator { white-space: nowrap; flex-shrink: 0; }

/* Stats: default 2 columns, expand to 4 on wide screens */
#page-admin [style*="minmax(140px"] {
  grid-template-columns: repeat(2, 1fr) !important;
}
#page-admin [style*="minmax(260px"] {
  grid-template-columns: 1fr !important;
}
#adm-status-banner { flex-wrap: wrap !important; gap: 8px !important; }

@media (min-width: 1200px) {
  #page-admin [style*="minmax(140px"] {
    grid-template-columns: repeat(4, 1fr) !important;
  }
  #page-admin [style*="minmax(260px"] {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}

@media (max-width: 600px) {
  #page-admin .page-header h2 { font-size: 18px; }
  #adm-status-banner { flex-direction: column; align-items: flex-start !important; font-size: 12px !important; padding: 12px !important; }
  #adm-panel-keys .card { padding: 14px !important; }
  #page-admin [style*="display:flex;gap:4px"] { overflow-x: auto; -webkit-overflow-scrolling: touch; }
}

</style></head><body>
<div class="hero">
<h1>${d.name||'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å'}</h1>
<p>${d.desc||d.type||''}</p>
${d.phone?'<a href="tel:'+d.phone+'" class="btn">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>':''}
<a href="#contact" class="btn btn-outline">–°–≤—è–∑–∞—Ç—å—Å—è</a>
</div>
${d.desc?'<section><h2>–û –Ω–∞—Å</h2><p style="text-align:center;max-width:700px;margin:0 auto;line-height:1.8">'+d.desc+'</p></section>':''}
${svcHtml?'<section><h2>–£—Å–ª—É–≥–∏</h2><div class="services">'+svcHtml+'</div></section>':''}
${d.prices?'<section><h2>–¶–µ–Ω—ã</h2><p style="text-align:center;font-size:18px">'+d.prices+'</p></section>':''}
<div class="contact" id="contact">
<h2 style="color:white">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
${d.phone?'<a href="tel:'+d.phone+'">üìû '+d.phone+'</a>':''}
${d.address?'<p style="margin:12px 0">üìç '+(d.city?d.city+', ':'')+d.address+'</p>':''}
${d.hours?'<p style="margin:12px 0">üïê '+d.hours+'</p>':''}
${d.social?'<p style="margin:12px 0">üì± '+d.social+'</p>':''}
</div>
<footer>¬© ${new Date().getFullYear()} ${d.name||''} ¬∑ –°–¥–µ–ª–∞–Ω–æ –≤ RKT Hub</footer>
</body></html>`;
}

function regenerateSite() { siteGenStep = 'form'; renderSubprojectView(); setTimeout(generateSite, 100); }

function buildSitePrompt(d) {
  return `–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –°–æ–∑–¥–∞–π –ü–û–õ–ù–´–ô, –ë–û–õ–¨–®–û–ô, –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∞–π—Ç (landing page) –≤ –û–î–ù–û–ú HTML —Ñ–∞–π–ª–µ.
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û HTML –∫–æ–¥. –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π. –ë–µ–∑ \`\`\`html –æ–±—ë—Ä—Ç–∫–∏. –ù–∞—á–∏–Ω–∞–π —Å—Ä–∞–∑—É —Å <!DOCTYPE html>.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–î–ê–ù–ù–´–ï –ë–ò–ó–ù–ï–°–ê:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏: ${d.name}
- –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞: ${d.type}
- –ì–æ—Ä–æ–¥: ${d.city || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –ê–¥—Ä–µ—Å: ${d.address || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –¢–µ–ª–µ—Ñ–æ–Ω: ${d.phone || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –°–æ—Ü—Å–µ—Ç–∏: ${d.social || '–Ω–µ—Ç'}
- –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: ${d.hours || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –û–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞: ${d.desc}
- –£—Å–ª—É–≥–∏/–¢–æ–≤–∞—Ä—ã: ${d.services || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}
- –¶–µ–Ω—ã: ${d.prices || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}
- –¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞: ${d.theme}
- –°—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞: ${d.style}
- –ü–æ–∂–µ–ª–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ${d.extra || '–Ω–µ—Ç'}
- –õ–æ–≥–æ—Ç–∏–ø (URL): ${d.logo || '–Ω–µ—Ç'}
- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (URLs): ${d.photos || '–Ω–µ—Ç'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –°–ï–ö–¶–ò–ò (–º–∏–Ω–∏–º—É–º 10):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
1. **HEADER** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º (—Ç–µ–∫—Å—Ç), –º–µ–Ω—é-—Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ —Å–µ–∫—Ü–∏–∏, –∫–Ω–æ–ø–∫–æ–π CTA –∏ –º–æ–±–∏–ª—å–Ω—ã–º –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é
2. **HERO** ‚Äî –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–Ω–µ—Ä —Å –∫—Ä—É–ø–Ω—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º (H1), –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–∞ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, 2 –∫–Ω–æ–ø–∫–∏ (–æ—Å–Ω–æ–≤–Ω–∞—è + –≤—Ç–æ—Ä–∏—á–Ω–∞—è). –§–æ–Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω
3. **–û –ù–ê–°** ‚Äî –±–ª–æ–∫ –Ω–∞ 150+ —Å–ª–æ–≤ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, –º–∏—Å—Å–∏–µ–π, 3-4 –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∏–∫–æ–Ω–∫–∞–º–∏ (–æ–ø—ã—Ç, –∫–ª–∏–µ–Ω—Ç—ã, –ø—Ä–æ–µ–∫—Ç—ã, –Ω–∞–≥—Ä–∞–¥—ã). –ü—Ä–∏–¥—É–º–∞–π —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
4. **–£–°–õ–£–ì–ò** ‚Äî –º–∏–Ω–∏–º—É–º 6 –∫–∞—Ä—Ç–æ—á–µ–∫ —É—Å–ª—É–≥ —Å –∏–∫–æ–Ω–∫–∞–º–∏ (–∏—Å–ø–æ–ª—å–∑—É–π HTML entities/emoji), –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–∞ 2-3 —Å—Ç—Ä–æ–∫–∏ –∏ –∫–Ω–æ–ø–∫–æ–π "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"
5. **–ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê** ‚Äî 4-6 –ø—É–Ω–∫—Ç–æ–≤ –ø–æ—á–µ–º—É –≤—ã–±–∏—Ä–∞—é—Ç –Ω–∞—Å: –∏–∫–æ–Ω–∫–∞ + –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —Ç–µ–∫—Å—Ç. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ç–∫—É 2x3 –∏–ª–∏ 3x2
6. **–ì–ê–õ–ï–†–ï–Ø/–ü–û–†–¢–§–û–õ–ò–û** ‚Äî –º–∏–Ω–∏–º—É–º 6 –∫–∞—Ä—Ç–æ—á–µ–∫ —Å CSS-–≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ –∫–∞–∫ –∑–∞–≥–ª—É—à–∫–∞–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—Ü–≤–µ—Ç–Ω—ã–µ –±–ª–æ–∫–∏ 300x200), —Å hover-—ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
7. **–û–¢–ó–´–í–´** ‚Äî 3-4 –æ—Ç–∑—ã–≤–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ø—Ä–∏–¥—É–º–∞–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ), –∫–∞—Ä—É—Å–µ–ª—å –∏–ª–∏ —Å–µ—Ç–∫–∞, —Å –∏–º–µ–Ω–µ–º, –¥–æ–ª–∂–Ω–æ—Å—Ç—å—é, —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–∑—ã–≤–∞ –∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∑–≤—ë–∑–¥–∞–º–∏
8. **–¶–ï–ù–´** ‚Äî –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã: —Ç–∞–±–ª–∏—Ü–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ (3 –∫–æ–ª–æ–Ω–∫–∏ ‚Äî –±–∞–∑–æ–≤—ã–π, —Å—Ç–∞–Ω–¥–∞—Ä—Ç, –ø—Ä–µ–º–∏—É–º), –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –±–ª–æ–∫ "–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"
9. **FAQ** ‚Äî 5-6 –∞–∫–∫–æ—Ä–¥–µ–æ–Ω-–≤–æ–ø—Ä–æ—Å–æ–≤ —Å —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–º–∏—Å—è –æ—Ç–≤–µ—Ç–∞–º–∏ (–Ω–∞ JS)
10. **–ö–û–ù–¢–ê–ö–¢–´** ‚Äî —Ç–µ–ª–µ—Ñ–æ–Ω (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π tel:), –∞–¥—Ä–µ—Å, email, —Å–æ—Ü—Å–µ—Ç–∏, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã. –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞ iframe –µ—Å–ª–∏ –µ—Å—Ç—å –∞–¥—Ä–µ—Å. –§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, —Å–æ–æ–±—â–µ–Ω–∏–µ)
11. **FOOTER** ‚Äî –ª–æ–≥–æ—Ç–∏–ø, –Ω–∞–≤–∏–≥–∞—Ü–∏—è, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∫–æ–ø–∏—Ä–∞–π—Ç —Å —Ç–µ–∫—É—â–∏–º –≥–æ–¥–æ–º, —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ—Ü—Å–µ—Ç–∏

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –î–ò–ó–ê–ô–ù–£ –ò –ö–û–î–£:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
- CSS: –º–∏–Ω–∏–º—É–º 500 —Å—Ç—Ä–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (:root), –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã, box-shadow, border-radius
- –ê–Ω–∏–º–∞—Ü–∏–∏: CSS transitions –Ω–∞ hover –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –∫–∞—Ä—Ç–æ—á–µ–∫, IntersectionObserver –¥–ª—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ (fade-in + slide-up)
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å: media queries –¥–ª—è 1200px, 768px, 480px. –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º ‚Äî –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é, –æ–¥–Ω–æ–∫–æ–ª–æ–Ω–æ—á–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞
- –®—Ä–∏—Ñ—Ç—ã: Google Fonts ‚Äî Montserrat –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, Inter –¥–ª—è —Ç–µ–∫—Å—Ç–∞
- –¶–≤–µ—Ç–∞: —Å–æ–∑–¥–∞–π –ø–∞–ª–∏—Ç—Ä—É –∏–∑ 5 —Ü–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã "${d.theme}" (–æ—Å–Ω–æ–≤–Ω–æ–π, –∞–∫—Ü–µ–Ω—Ç, —Ñ–æ–Ω, —Ç–µ–∫—Å—Ç, —Ç–µ–∫—Å—Ç-–≤—Ç–æ—Ä–∏—á–Ω—ã–π)
- –ö–Ω–æ–ø–∫–∏: –º–∏–Ω–∏–º—É–º 2 —Å—Ç–∏–ª—è (primary —Å –∑–∞–ª–∏–≤–∫–æ–π, secondary —Å –æ–±–≤–æ–¥–∫–æ–π), hover-–∞–Ω–∏–º–∞—Ü–∏—è, border-radius
- –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞: scroll-behavior: smooth + JS –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- –ö–Ω–æ–ø–∫–∞ "–ù–∞–≤–µ—Ä—Ö": –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –≤–Ω–∏–∑
- Favicon: SVG emoji –≤ base64
- SEO: –ø–æ–ª–Ω—ã–µ meta tags (title, description, og:title, og:description, viewport)
- –í—Å–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ
- –ú–∏–Ω–∏–º—É–º 1000 —Å—Ç—Ä–æ–∫ HTML+CSS+JS –∫–æ–¥–∞
- –ë–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∫—Ä–æ–º–µ Google Fonts

–ö–†–ò–¢–ò–ß–ù–û: –°–∞–π—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ë–û–õ–¨–®–ò–ú –∏ –î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ú. –ö–∞–∂–¥–∞—è —Å–µ–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–Ω–µ placeholder). –ü—Ä–∏–¥—É–º–∞–π —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ "${d.name}" –≤ —Å—Ñ–µ—Ä–µ "${d.type}".

${d.logo ? '–õ–û–ì–û–¢–ò–ü: –ò—Å–ø–æ–ª—å–∑—É–π <img src="' + d.logo + '"> –≤ —à–∞–ø–∫–µ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞.' : ''}
${d.photos ? '–§–û–¢–û–ì–†–ê–§–ò–ò: –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ –≤–º–µ—Å—Ç–æ –∑–∞–≥–ª—É—à–µ–∫ –≤ –≥–∞–ª–µ—Ä–µ–µ/–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ: ' + d.photos : ''}

–í–µ—Ä–Ω–∏ –ü–û–õ–ù–´–ô —Ä–∞–±–æ—á–∏–π HTML —Ñ–∞–π–ª.`;
}

function generateSiteLocal() {
  const name = document.getElementById('sg-name')?.value?.trim();
  const type = document.getElementById('sg-type')?.value?.trim();
  const desc = document.getElementById('sg-desc')?.value?.trim();
  if (!name || !type || !desc) { toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (*)','error'); return; }
  const sgd = getSiteGenData();
  Object.assign(sgd, {
    name, type, desc,
    city: document.getElementById('sg-city')?.value?.trim() || '',
    address: document.getElementById('sg-address')?.value?.trim() || '',
    phone: document.getElementById('sg-phone')?.value?.trim() || '',
    social: document.getElementById('sg-social')?.value?.trim() || '',
    hours: document.getElementById('sg-hours')?.value?.trim() || '',
    services: document.getElementById('sg-services')?.value?.trim() || '',
    prices: document.getElementById('sg-prices')?.value?.trim() || '',
    theme: document.getElementById('sg-theme')?.value || 'auto',
    style: document.getElementById('sg-style')?.value || 'modern',
    extra: document.getElementById('sg-extra')?.value?.trim() || ''
  });
  sgd.html = generateLocalSite(sgd);
  siteGenStep = 'preview';
  renderSubprojectView();
  setTimeout(() => {
    const iframe = document.getElementById('site-preview-iframe');
    if (iframe) {
      const iDoc = iframe.contentDocument || iframe.contentWindow.document;
      iDoc.open(); iDoc.write(sgd.html); iDoc.close();
    }
  }, 100);
  toast('‚ö° –®–∞–±–ª–æ–Ω–Ω—ã–π —Å–∞–π—Ç —Å–æ–∑–¥–∞–Ω! –ú–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –ò–ò.','success');
}

function setSitePreviewWidth(w) {
  const iframe = document.getElementById('site-preview-iframe');
  if (iframe) iframe.style.width = w;
  // Update button styles
  ['desktop','tablet','mobile'].forEach(id => {
    const btn = document.getElementById('preview-'+id);
    if (btn) { btn.style.background = 'transparent'; btn.style.color = 'var(--text1)'; }
  });
  const activeId = w === '375px' ? 'preview-mobile' : w === '768px' ? 'preview-tablet' : 'preview-desktop';
  const activeBtn = document.getElementById(activeId);
  if (activeBtn) { activeBtn.style.background = 'var(--accent)'; activeBtn.style.color = '#fff'; }
}

function downloadSiteHtml() {
  const sgDl = getSiteGenData();
  if (!sgDl.html) return;
  const blob = new Blob([sgDl.html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (sgDl.name || 'site').replace(/\s/g,'_') + '.html';
  a.click(); URL.revokeObjectURL(a.href);
  toast('HTML —Å–∫–∞—á–∞–Ω!','success');
}

function copySiteHtml() {
  const sgCp = getSiteGenData();
  if (!sgCp.html) return;
  navigator.clipboard.writeText(sgCp.html).then(() => toast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!','success')).catch(() => toast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è','error'));
}

function toggleSiteCode() {
  const el = document.getElementById('site-code-block');
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function initSiteGenerator() {
  // Reset to form if no cached data for this subproject
  const sgInit = getSiteGenData();
  if (!sgInit.html) siteGenStep = 'form';
  else {
    siteGenStep = 'preview';
    // Reload cached HTML into iframe
    setTimeout(() => {
      const iframe = document.getElementById('site-preview-iframe');
      if (iframe && sgInit.html) {
        const iDoc = iframe.contentDocument || iframe.contentWindow.document;
        iDoc.open(); iDoc.write(sgInit.html); iDoc.close();
        setTimeout(() => {
          try { iframe.style.height = Math.max(700, iDoc.body.scrollHeight + 50) + 'px'; } catch(e){}
        }, 500);
      }
    }, 200);
  }
  // Auto-fill from direction/client record
  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç']===(PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  if (dir) {
    setTimeout(() => {
      const fill = (id, val) => { const el = document.getElementById(id); if (el && !el.value && val) el.value = val; };
      fill('sg-name', dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || currentSubproject);
      fill('sg-type', dir['–û–ø–∏—Å–∞–Ω–∏–µ'] || dir['–í–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏'] || '');
      fill('sg-city', dir['–ì–æ—Ä–æ–¥'] || '');
      fill('sg-phone', dir['–¢–µ–ª–µ—Ñ–æ–Ω'] || '');
      fill('sg-desc', dir['–£—Å–ª—É–≥–∏'] || '');
      fill('sg-services', dir['–£—Å–ª—É–≥–∏'] || '');
      fill('sg-extra', dir['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'] || dir['–ü–æ–∂–µ–ª–∞–Ω–∏—è'] || '');
      fill('sg-address', dir['–ê–¥—Ä–µ—Å'] || '');
      fill('sg-social', dir['–°–æ—Ü—Å–µ—Ç–∏'] || dir['Instagram'] || '');
      fill('sg-hours', dir['–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã'] || dir['–ì—Ä–∞—Ñ–∏–∫'] || '');
    }, 100);
  } else {
    const nameEl = document.getElementById('sg-name');
    if (nameEl && !nameEl.value) nameEl.value = currentSubproject || '';
  }
}

// ============================================================
// FILES / DOCUMENTS SECTION
// ============================================================
function renderFilesSection() {
  const docs = (DATA.documents || []).filter(d => {
    const folder = (d['–ü–∞–ø–∫–∞']||'').toLowerCase();
    const sp = (currentSubproject||'').toLowerCase();
    return folder.includes(sp) || (d['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase() === sp;
  });
  
  let html = '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center">' +
    '<h3>üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è ¬´' + esc(currentSubproject) + '¬ª</h3>' +
    '<div style="display:flex;gap:8px">' +
    '<button class="btn btn-sm btn-primary" onclick="uploadFileWeb()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>' +
    '<button class="btn btn-sm btn-secondary" onclick="openAiFileModal()">ü§ñ –°–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ –ò–ò</button>' +
    '</div></div>';

  if (!docs.length) {
    html += '<div class="card-body" style="padding:40px;text-align:center">' +
      '<div style="font-size:48px;margin-bottom:12px">üìÅ</div>' +
      '<p style="color:var(--text2)">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>' +
      '<p style="color:var(--text3);font-size:13px;margin-top:8px">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –±–æ—Ç—É –≤ Telegram ‚Äî –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ –≤ Google Drive –∏ –ø—Ä–∏–≤—è–∂–µ—Ç –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é</p>' +
      '</div>';
  } else {
    html += '<div class="table-wrap"><table><thead><tr><th>üìÑ –§–∞–π–ª</th><th>üìÅ –ü–∞–ø–∫–∞</th><th>üë§ –ó–∞–≥—Ä—É–∑–∏–ª</th><th>üìÖ –î–∞—Ç–∞</th><th>üîó</th></tr></thead><tbody>';
    docs.forEach(d => {
      const icon = getFileIcon(d['–§–∞–π–ª'] || '');
      const link = d['–°—Å—ã–ª–∫–∞'] ? '<a href="'+esc(d['–°—Å—ã–ª–∫–∞'])+'" target="_blank" style="color:var(--accent)">–û—Ç–∫—Ä—ã—Ç—å</a>' : '‚Äî';
      html += '<tr><td>' + icon + ' ' + esc(d['–§–∞–π–ª']||'‚Äî') + '</td><td>' + esc(d['–ü–∞–ø–∫–∞']||'‚Äî') + '</td><td>' + esc(d['–ó–∞–≥—Ä—É–∑–∏–ª']||'‚Äî') + '</td><td>' + esc(d['–î–∞—Ç–∞']||'‚Äî') + '</td><td>' + link + '</td></tr>';
    });
    html += '</tbody></table></div>';
  }
  html += '</div>';

  // Upload via web form (hidden)
  html += '<input type="file" id="file-upload-input" style="display:none" onchange="handleFileUpload(this)" multiple>';
  
  return html;
}

function getFileIcon(name) {
  const ext = (name.split('.').pop() || '').toLowerCase();
  const icons = {pdf:'üìï',doc:'üìò',docx:'üìò',xls:'üìó',xlsx:'üìó',ppt:'üìô',pptx:'üìô',jpg:'üñº',jpeg:'üñº',png:'üñº',gif:'üñº',mp4:'üé¨',mov:'üé¨',zip:'üì¶',rar:'üì¶',txt:'üìù',csv:'üìä'};
  return icons[ext] || 'üìÑ';
}

function uploadFileWeb() {
  document.getElementById('file-upload-input')?.click();
}

async function uploadProjectFile(projName) {
  const input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif';
  input.click();
  input.onchange = async () => {
    if (!input.files || !input.files.length) return;
    showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...');
    let uploaded = 0;
    for (const file of input.files) {
      if (file.size > 10 * 1024 * 1024) { toast('‚ö†Ô∏è –§–∞–π–ª '+file.name+' > 10 –ú–ë','warning'); continue; }
      try {
        const safeName = slugify(file.name.replace(/\.[^.]+$/,'')) + '.' + file.name.split('.').pop();
        const storagePath = 'documents/projects/' + slugify(projName) + '/' + safeName;
        const { data, error } = await SB.storage.from('documents').upload(storagePath, file, { cacheControl: '3600', upsert: true });
        if (error) throw error;
        const { data: urlData } = SB.storage.from('documents').getPublicUrl(storagePath);
        const docRow = {
          '–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞': file.name,
          '–ü–∞–ø–∫–∞': projName,
          '–ü—Ä–æ–µ–∫—Ç': projName,
          '–ó–∞–≥—Ä—É–∑–∏–ª': USER?.name || '?',
          '–°—Å—ã–ª–∫–∞': urlData?.publicUrl || '',
          '–î–∞—Ç–∞': today(),
          '–¢–∏–ø': file.type || 'file'
        };
        await apiWrite('–î–æ–∫—É–º–µ–Ω—Ç—ã', docRow);
        if (!DATA.documents) DATA.documents = [];
        DATA.documents.push(docRow);
        uploaded++;
      } catch(e) { console.error('Upload error:', e); toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message, 'error'); }
    }
    hideLoading();
    if (uploaded) {
      toast('üìé –ó–∞–≥—Ä—É–∂–µ–Ω–æ '+uploaded+' —Ñ–∞–π–ª(–æ–≤)', 'success');
      renderProjectView();
    }
  };
}

async function handleFileUpload(input) {
  if (!input.files || !input.files.length) return;
  // Validate each file
  for (var fi = 0; fi < input.files.length; fi++) {
    var vf = input.files[fi];
    if (vf.size > MAX_FILE_SIZE) {
      toast('–§–∞–π–ª ¬´' + vf.name + '¬ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10 –ú–ë)', 'error');
      input.value = ''; return;
    }
    if (ALLOWED_FILE_TYPES.length && ALLOWED_FILE_TYPES.indexOf(vf.type) < 0 && !/\.(pdf|doc|docx|xls|xlsx|jpg|jpeg|png|gif|webp|txt|csv|zip)$/i.test(vf.name)) {
      toast('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞: ' + vf.name, 'error');
      input.value = ''; return;
    }
  }
  
  for (const file of input.files) {
    toast('üì§ –ó–∞–≥—Ä—É–∑–∫–∞: ' + file.name + '...','info');
    
    try {
      const folder = (currentSubproject || '–û–±—â–µ–µ').replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9_ -]/g, '');
      const timestamp = Date.now();
      const safeName = file.name.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9._-]/g, '_');
      const path = folder + '/' + timestamp + '_' + safeName;
      
      // 1. Upload to Supabase Storage
      const { data: uploadData, error: uploadErr } = await SB.storage
        .from('documents')
        .upload(path, file, { contentType: file.type, upsert: false });
      
      if (uploadErr) throw uploadErr;
      
      // 2. Get public URL
      const { data: urlData } = SB.storage.from('documents').getPublicUrl(path);
      const publicUrl = urlData?.publicUrl || '';
      
      // 3. Save metadata to documents table
      const docRow = {
        id: 'D' + timestamp.toString(36).toUpperCase(),
        filename: file.name,
        folder: currentSubproject || '–û–±—â–µ–µ',
        uploaded_by: USER?.name || '–í–µ–±',
        upload_date: new Date().toISOString().split('T')[0],
        link: publicUrl,
        size: formatFileSize(file.size),
        direction: currentSubproject || '',
        project: PROJECTS[currentProject]?.name || ''
      };
      
      const { error: metaErr } = await SB.from('documents').insert(docRow);
      if (metaErr) console.warn('Meta save error:', metaErr);
      
      toast('‚úÖ ' + file.name + ' –∑–∞–≥—Ä—É–∂–µ–Ω!','success');
    } catch(e) {
      console.error('Upload error:', e);
      // Fallback: save just metadata via API
      try {
        await apiWrite('–î–æ–∫—É–º–µ–Ω—Ç—ã', {
          '–§–∞–π–ª': file.name,
          '–ü–∞–ø–∫–∞': currentSubproject || '–û–±—â–µ–µ',
          '–ó–∞–≥—Ä—É–∑–∏–ª': USER?.name || '–í–µ–±',
          '–î–∞—Ç–∞': new Date().toISOString().split('T')[0],
          '–†–∞–∑–º–µ—Ä': formatFileSize(file.size)
        });
        toast('‚ö†Ô∏è ' + file.name + ' ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (—Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω: ' + e.message + ')','warning');
      } catch(e2) {
        toast('‚ùå –û—à–∏–±–∫–∞: ' + e.message,'error');
      }
    }
  }
  
  input.value = '';
  setTimeout(() => { loadData(); renderSubprojectView(); }, 800);
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' –ë';
  if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' –ö–ë';
  return (bytes/1048576).toFixed(1) + ' –ú–ë';
}

function initFileUpload() {
  // Nothing extra needed
}

// ============================================================
// AI FILE CREATION
// ============================================================
const AI_FILE_TYPES = [
  { id: 'contract', name: '–î–æ–≥–æ–≤–æ—Ä', icon: 'üìú', desc: '–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ–∫–∞–∑–∞–Ω–∏–µ —É—Å–ª—É–≥', ext: 'txt' },
  { id: 'proposal', name: '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', icon: 'üìã', desc: '–ö–ü –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ —Å —Ü–µ–Ω–∞–º–∏ –∏ —É—Å–ª–æ–≤–∏—è–º–∏', ext: 'txt' },
  { id: 'pricelist', name: '–ü—Ä–∞–π—Å-–ª–∏—Å—Ç', icon: 'üí∞', desc: '–¢–∞–±–ª–∏—Ü–∞ —Ü–µ–Ω –Ω–∞ —É—Å–ª—É–≥–∏', ext: 'txt' },
  { id: 'brief', name: '–ë—Ä–∏—Ñ', icon: 'üìù', desc: '–ë—Ä–∏—Ñ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (–æ–ø—Ä–æ—Å–Ω–∏–∫)', ext: 'txt' },
  { id: 'report', name: '–û—Ç—á—ë—Ç', icon: 'üìä', desc: '–û—Ç—á—ë—Ç –æ —Ä–∞–±–æ—Ç–µ / —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö', ext: 'txt' },
  { id: 'letter', name: '–î–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ', icon: 'üìß', desc: '–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É –∏–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—É', ext: 'txt' },
  { id: 'custom', name: '–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç', icon: '‚úçÔ∏è', desc: '–õ—é–±–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ –≤–∞—à–µ–º—É –æ–ø–∏—Å–∞–Ω–∏—é', ext: 'txt' },
  { id: 'site', name: 'HTML-—Å–∞–π—Ç', icon: 'üåê', desc: '–ì–æ—Ç–æ–≤—ã–π –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∞–π—Ç', ext: 'html' }
];

function openAiFileModal() {
  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  const clientName = dir ? (dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||dir['name']||'') : (currentSubproject||'');
  const clientBiz = dir ? (dir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞']||dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'') : '';
  const clientPhone = dir ? (dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'') : '';
  const clientCity = dir ? (dir['–ì–æ—Ä–æ–¥']||'') : '';

  let html = '<div class="modal-overlay" id="ai-file-modal" onclick="if(event.target===this)closeAiFileModal()">';
  html += '<div class="modal" style="max-width:560px;width:95%">';
  html += '<div class="modal-header"><h2>ü§ñ –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ –ò–ò</h2><button class="modal-close" onclick="closeAiFileModal()">√ó</button></div>';
  html += '<div class="modal-body" style="padding:20px">';

  // Client context
  if (clientName) {
    html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px">';
    html += '<div style="font-weight:600;margin-bottom:4px">üìá –ö–ª–∏–µ–Ω—Ç: ' + esc(clientName) + '</div>';
    if (clientBiz) html += '<div style="color:var(--text2)">üíº ' + esc(clientBiz) + '</div>';
    if (clientCity) html += '<div style="color:var(--text2)">üìç ' + esc(clientCity) + '</div>';
    html += '</div>';
  }

  // File type selector
  html += '<label style="font-weight:600;display:block;margin-bottom:8px">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>';
  html += '<div id="ai-file-types" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">';
  AI_FILE_TYPES.forEach((ft, i) => {
    html += '<div class="ai-file-type-card' + (i===0?' active':'') + '" data-type="' + ft.id + '" onclick="selectAiFileType(\'' + ft.id + '\')" ';
    html += 'style="padding:12px;border:2px solid ' + (i===0?'var(--accent)':'var(--border)') + ';border-radius:8px;cursor:pointer;transition:all .2s">';
    html += '<div style="font-size:20px;margin-bottom:4px">' + ft.icon + '</div>';
    html += '<div style="font-weight:600;font-size:13px">' + ft.name + '</div>';
    html += '<div style="font-size:11px;color:var(--text2);margin-top:2px">' + ft.desc + '</div>';
    html += '</div>';
  });
  html += '</div>';

  // Description
  html += '<label style="font-weight:600;display:block;margin-bottom:8px">–û–ø–∏—Å–∞–Ω–∏–µ / –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>';
  html += '<textarea id="ai-file-desc" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ —á—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ...\n–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–ü –¥–ª—è –∫–∞—Ñ–µ –ü—ã—à–∫–∏ –º–∏—Ä–∞, 3 —Ç–∏–ø–∞ —Å–∞–π—Ç–∞, —Å–∫–∏–¥–∫–∞ 10% –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞" ';
  html += 'style="width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:\'JetBrains Mono\',monospace;font-size:13px;resize:vertical"></textarea>';

  // Generate button
  html += '<div style="margin-top:16px;display:flex;gap:8px">';
  html += '<button id="ai-file-gen-btn" class="btn btn-primary" onclick="createAiFile()" style="flex:1;padding:14px;font-size:15px">ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>';
  html += '<button class="btn btn-secondary" onclick="closeAiFileModal()">–û—Ç–º–µ–Ω–∞</button>';
  html += '</div>';

  // Result area (hidden initially)
  html += '<div id="ai-file-result" style="display:none;margin-top:16px">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
  html += '<label style="font-weight:600">–†–µ–∑—É–ª—å—Ç–∞—Ç</label>';
  html += '<div style="display:flex;gap:8px">';
  html += '<button class="btn btn-sm btn-primary" onclick="downloadAiFile()">üíæ –°–∫–∞—á–∞—Ç—å</button>';
  html += '<button class="btn btn-sm btn-secondary" onclick="copyAiFileText()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>';
  html += '<button class="btn btn-sm btn-secondary" onclick="saveAiFileToDocuments()">üì§ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>';
  html += '</div></div>';
  html += '<pre id="ai-file-content" style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;max-height:300px;overflow:auto;white-space:pre-wrap;font-size:12px"></pre>';
  html += '</div>';

  html += '</div></div></div>';

  document.body.insertAdjacentHTML('beforeend', html);
}

let _aiFileSelectedType = 'contract';
let _aiFileResult = '';
let _aiFileExt = 'txt';

function selectAiFileType(typeId) {
  _aiFileSelectedType = typeId;
  const ft = AI_FILE_TYPES.find(t => t.id === typeId);
  _aiFileExt = ft ? ft.ext : 'txt';
  document.querySelectorAll('.ai-file-type-card').forEach(card => {
    const isActive = card.getAttribute('data-type') === typeId;
    card.classList.toggle('active', isActive);
    card.style.borderColor = isActive ? 'var(--accent)' : 'var(--border)';
  });
}

function closeAiFileModal() {
  const modal = document.getElementById('ai-file-modal');
  if (modal) modal.remove();
  _aiFileResult = '';
}

async function createAiFile() {
  const desc = (document.getElementById('ai-file-desc')?.value || '').trim();
  const ft = AI_FILE_TYPES.find(t => t.id === _aiFileSelectedType);
  if (!ft) return;

  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  const clientName = dir ? (dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||dir['name']||'') : (currentSubproject||'');
  const clientBiz = dir ? (dir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞']||dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'') : '';
  const clientCity = dir ? (dir['–ì–æ—Ä–æ–¥']||'') : '';
  const clientPhone = dir ? (dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'') : '';
  const siteType = dir ? (dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'') : '';
  const price = dir ? (dir['–¶–µ–Ω–∞']||'') : '';

  const btn = document.getElementById('ai-file-gen-btn');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...'; }

  // Build prompt based on file type
  let prompt = '';
  const clientCtx = '–ö–ª–∏–µ–Ω—Ç: ' + clientName + (clientBiz ? ', –±–∏–∑–Ω–µ—Å: ' + clientBiz : '') + (clientCity ? ', –≥–æ—Ä–æ–¥: ' + clientCity : '') + (clientPhone ? ', —Ç–µ–ª: ' + clientPhone : '') + (siteType ? ', —Ç–∏–ø —Å–∞–π—Ç–∞: ' + siteType : '') + (price ? ', —Ü–µ–Ω–∞: ' + price + '‚ÇΩ' : '');

  if (_aiFileSelectedType === 'site') {
    prompt = '–¢—ã –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –°–æ–∑–¥–∞–π –ø–æ–ª–Ω—ã–π HTML-—Å–∞–π—Ç (–æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π, —Å CSS –≤–Ω—É—Ç—Ä–∏) –¥–ª—è: ' + clientCtx + '.\n' + (desc ? '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: ' + desc : '') + '\n\n–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û HTML-–∫–æ–¥, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π. –ú–∏–Ω–∏–º—É–º 500 —Å—Ç—Ä–æ–∫. –ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–π –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å–∞–π—Ç —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º.';
  } else {
    const typeNames = { contract: '–¥–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ–∫–∞–∑–∞–Ω–∏–µ —É—Å–ª—É–≥ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Å–∞–π—Ç–∞', proposal: '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–ö–ü) –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–∞', pricelist: '–ø—Ä–∞–π—Å-–ª–∏—Å—Ç –Ω–∞ —É—Å–ª—É–≥–∏ –≤–µ–±-—Å—Ç—É–¥–∏–∏', brief: '–±—Ä–∏—Ñ (–æ–ø—Ä–æ—Å–Ω–∏–∫) –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–∞–π—Ç–∞', report: '–æ—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ', letter: '–¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ', custom: '–¥–æ–∫—É–º–µ–Ω—Ç' };
    const typeName = typeNames[_aiFileSelectedType] || '–¥–æ–∫—É–º–µ–Ω—Ç';
    prompt = '–°–æ–∑–¥–∞–π ' + typeName + ' –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.\n\n' + clientCtx + '\n\n–ö–æ–º–ø–∞–Ω–∏—è-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: –û–û–û "–í–µ–±-—Å—Ç—É–¥–∏—è" (–ø—Ä–æ–µ–∫—Ç –°–∞–π—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏ –†–ö–¢ ‚Äî –†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏).\n' +
      '–ù–∞—à–∏ —Ü–µ–Ω—ã: –í–∏–∑–∏—Ç–∫–∞ 5000‚ÇΩ, –õ–µ–Ω–¥–∏–Ω–≥ 10000‚ÇΩ, –ö–∞—Ç–∞–ª–æ–≥ 15000‚ÇΩ, –ü—Ä–µ–º–∏—É–º 25000‚ÇΩ, –î–æ–º–µ–Ω+—Ö–æ—Å—Ç–∏–Ω–≥ 3000‚ÇΩ.\n\n' +
      (desc ? '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: ' + desc + '\n\n' : '') +
      '–í–ê–ñ–ù–û:\n- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤\n- –î–æ–∫—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º, –≥–æ—Ç–æ–≤—ã–º –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é\n- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –∞–±–∑–∞—Ü—ã\n- –ï—Å–ª–∏ —ç—Ç–æ –¥–æ–≥–æ–≤–æ—Ä ‚Äî –≤–∫–ª—é—á–∏ –≤—Å–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã (–ø—Ä–µ–¥–º–µ—Ç, —Å—Ä–æ–∫–∏, –æ–ø–ª–∞—Ç–∞, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã)\n- –ï—Å–ª–∏ —ç—Ç–æ –ö–ü ‚Äî —Å–¥–µ–ª–∞–π –µ–≥–æ –ø—Ä–æ–¥–∞—é—â–∏–º —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—ã–≥–æ–¥';
  }

  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 120000);
    const response = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: prompt,
        context: 'file_create',
        source: 'web',
        fileType: _aiFileSelectedType,
        user: USER ? USER['–ò–º—è'] : '',
        history: []
      }),
      signal: controller.signal
    });
    clearTimeout(timeout);

    if (!response.ok) throw new Error('HTTP ' + response.status);

    const raw = await response.json();
    let data = raw; if (Array.isArray(raw)) data = raw[0] || {}; if (data.json) data = data.json;
    let text = data.reply || data.response || data.text || data.message || '';
    if (!text && data.content) { try { text = data.content[0].text; } catch(e) {} }

    if (!text) throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò');

    _aiFileResult = text;
    _aiFileExt = ft.ext;

    // Show result
    const resultDiv = document.getElementById('ai-file-result');
    const contentPre = document.getElementById('ai-file-content');
    if (resultDiv) resultDiv.style.display = 'block';
    if (contentPre) contentPre.textContent = text;

    toast('–î–æ–∫—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'success');
  } catch(e) {
    console.error('AI file create error:', e);
    toast('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + e.message, 'error');
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å'; }
  }
}

function downloadAiFile() {
  if (!_aiFileResult) return;
  const ft = AI_FILE_TYPES.find(t => t.id === _aiFileSelectedType);
  const ext = ft ? ft.ext : 'txt';
  const mime = ext === 'html' ? 'text/html' : 'text/plain';
  const blob = new Blob([_aiFileResult], { type: mime + ';charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const name = (ft ? ft.name : 'document').replace(/\s/g, '_') + '_' + (currentSubproject||'file').replace(/\s/g, '_');
  a.download = name + '.' + ext;
  a.click();
  URL.revokeObjectURL(a.href);
  toast('–§–∞–π–ª —Å–∫–∞—á–∞–Ω!', 'success');
}

function copyAiFileText() {
  if (!_aiFileResult) return;
  navigator.clipboard.writeText(_aiFileResult)
    .then(() => toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä!', 'success'))
    .catch(() => toast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error'));
}

async function saveAiFileToDocuments() {
  if (!_aiFileResult) return;
  const ft = AI_FILE_TYPES.find(t => t.id === _aiFileSelectedType);
  const ext = ft ? ft.ext : 'txt';
  const mime = ext === 'html' ? 'text/html' : 'text/plain';
  const fileName = (ft ? ft.name : '–î–æ–∫—É–º–µ–Ω—Ç').replace(/\s/g, '_') + '_' + (currentSubproject||'').replace(/\s/g, '_') + '_' + new Date().toISOString().split('T')[0] + '.' + ext;

  toast('üì§ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ã...', 'info');
  try {
    const blob = new Blob([_aiFileResult], { type: mime + ';charset=utf-8' });
    const folder = (currentSubproject || '–û–±—â–µ–µ').replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9_ -]/g, '');
    const timestamp = Date.now();
    const path = folder + '/' + timestamp + '_' + fileName;

    const { data: uploadData, error: uploadErr } = await SB.storage
      .from('documents')
      .upload(path, blob, { contentType: mime, upsert: false });
    if (uploadErr) throw uploadErr;

    const { data: urlData } = SB.storage.from('documents').getPublicUrl(path);
    const publicUrl = urlData?.publicUrl || '';

    const docRow = {
      id: 'D' + timestamp.toString(36).toUpperCase(),
      filename: fileName,
      folder: currentSubproject || '–û–±—â–µ–µ',
      uploaded_by: (USER?.name || '–ò–ò') + ' (–ò–ò)',
      upload_date: new Date().toISOString().split('T')[0],
      link: publicUrl,
      size: formatFileSize(blob.size),
      direction: currentSubproject || '',
      project: PROJECTS[currentProject]?.name || ''
    };
    await SB.from('documents').insert(docRow);
    toast('–î–æ–∫—É–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ä–∞–∑–¥–µ–ª "–î–æ–∫—É–º–µ–Ω—Ç—ã"!', 'success');
    closeAiFileModal();
    debouncedLoadData();
    setTimeout(() => renderSubprojectView(), 500);
  } catch(e) {
    console.error('Save AI file error:', e);
    toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message, 'error');
  }
}

// ============================================================
// TASK DETAIL WITH AI ASSISTANT
// ============================================================
function openTaskDetail(taskId) {
  const task = DATA.tasks.find(t => t.ID === taskId || t.id === taskId);
  if (!task) { toast('–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','error'); return; }
  currentTaskId = taskId;
  aiMessages = [];

  // Breadcrumb
  let bc = '<a onclick="showPage(\'home\')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a><span class="sep">‚Ä∫</span>';
  const dir = task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
  const projKey = dirToProject(dir);
  if (projKey) {
    bc += '<a onclick="openProject(\''+projKey+'\')">'+esc(PROJECTS[projKey].name)+'</a><span class="sep">‚Ä∫</span>';
    bc += '<a onclick="openSubproject(\''+escA(dir)+'\')">'+esc(dir)+'</a><span class="sep">‚Ä∫</span>';
  }
  bc += '<span class="current">'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</span>';
  document.getElementById('td-breadcrumb').innerHTML = bc;

  // Task detail card
  let html = '<div class="task-detail">';
  html += '<div class="task-detail-header">';
  html += '<h3>'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</h3>';
  html += '<div class="task-meta">';
  html += '<div class="meta-item">'+prBadge(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+' '+esc(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'</div>';
  html += '<div class="meta-item">'+statusBadge(task['–°—Ç–∞—Ç—É—Å'])+'</div>';
  if(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) html += '<div class="meta-item">üìÇ '+esc(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</div>';
  if(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) html += '<div class="meta-item">üë§ '+esc(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'])+'</div>';
  if(task['–î–µ–¥–ª–∞–π–Ω']) {
    const od = task['–î–µ–¥–ª–∞–π–Ω']<today()&&(task['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
    html += '<div class="meta-item" style="'+(od?'color:var(--red);font-weight:700':'')+'">üìÖ '+esc(task['–î–µ–¥–ª–∞–π–Ω'])+(od?' üî¥':'')+'</div>';
  }
  html += '</div></div>';

  // Detail fields
  html += '<div class="task-detail-body">';
  html += '<div class="detail-grid">';
  const fields = [
    ['–ü—Ä–æ–µ–∫—Ç', task['–ü—Ä–æ–µ–∫—Ç']],
    ['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']],
    ['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']],
    ['–°—Ç–∞—Ç—É—Å', task['–°—Ç–∞—Ç—É—Å']],
    ['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']],
    ['–î–µ–¥–ª–∞–π–Ω', task['–î–µ–¥–ª–∞–π–Ω']]
  ];
  fields.forEach(([l,v]) => {
    if(v) html += '<div class="detail-item"><div class="detail-label">'+esc(l)+'</div><div class="detail-value">'+esc(v)+'</div></div>';
  });
  if(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']) {
    html += '<div class="detail-item detail-full"><div class="detail-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><div class="detail-value">'+esc(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'])+'</div></div>';
  }
  html += '</div>';

  // Action buttons
  html += '<div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">';
  html += '<button class="btn btn-primary" onclick="editItem(\'task\',\''+escA(taskId)+'\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>';
  html += '<button class="btn btn-secondary" onclick="changeTaskStatus(\''+escA(taskId)+'\')">üîÑ –°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>';
  const p = getUserPerms();
  if(p.canDelete) html += '<button class="btn btn-danger" onclick="confirmDelete(\'task\',\''+escA(taskId)+'\',\''+escA(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'\')">üóë –£–¥–∞–ª–∏—Ç—å</button>';
  html += '</div>';

  // Quick status change buttons
  if (p.canEditTasks) {
    html += '<div style="margin-top:12px;padding:12px;background:var(--bg2);border-radius:var(--radius)">';
    html += '<div style="font-size:12px;color:var(--text2);margin-bottom:8px">‚ö° –ë—ã—Å—Ç—Ä–∞—è —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞:</div>';
    html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
    const statuses = ['‚è≥ –í –æ—á–µ—Ä–µ–¥–∏', '–í —Ä–∞–±–æ—Ç–µ', 'üîç –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', '‚úÖ –ì–æ—Ç–æ–≤–æ'];
    statuses.forEach(s => {
      const isCurrent = (task['–°—Ç–∞—Ç—É—Å'] || '') === s;
      html += '<button class="btn btn-sm '+(isCurrent?'btn-primary':'btn-secondary')+'" onclick="quickChangeTaskStatus(\''+escA(taskId)+'\',\''+escA(s)+'\')" '+(isCurrent?'disabled':'')+'>'+esc(s)+'</button>';
    });
    html += '</div></div>';
  }

  html += '</div></div>';

  // COMMENTS SECTION
  html += '<div class="card" style="margin-top:16px">';
  html += '<div class="card-header"><h4 style="margin:0;font-size:15px">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4></div>';
  html += '<div style="padding:16px">';
  html += '<div id="task-comments-list" style="max-height:300px;overflow-y:auto;margin-bottom:12px">';
  html += '<div style="text-align:center;color:var(--text2);font-size:12px;padding:16px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  html += '</div>';
  html += '<div style="display:flex;gap:8px">';
  html += '<input id="task-comment-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg2);color:var(--text1);font-size:13px;font-family:inherit" onkeydown="if(event.key===\'Enter\')addTaskComment()">';
  html += '<button class="btn btn-primary btn-sm" onclick="addTaskComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>';
  html += '</div>';
  html += '</div></div>';

  // DOCUMENTS SECTION
  html += '<div class="card" style="margin-top:16px">';
  html += '<div class="card-header"><h4 style="margin:0;font-size:15px">üìé –î–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞–¥–∞—á–∏</h4></div>';
  html += '<div style="padding:16px">';
  html += '<div id="task-docs-list" style="margin-bottom:12px">';
  html += '<div style="text-align:center;color:var(--text2);font-size:12px;padding:12px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  html += '</div>';
  html += '<div style="display:flex;gap:8px;align-items:center">';
  html += '<label class="btn btn-sm btn-secondary" style="cursor:pointer;margin:0"><input type="file" id="task-doc-file" multiple style="display:none" onchange="uploadTaskDocuments(\''+escA(taskId)+'\')">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</label>';
  html += '<span style="font-size:11px;color:var(--text2)">PDF, Word, Excel, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –¥–æ 10 –ú–ë</span>';
  html += '</div>';
  html += '</div></div>';

  // AI ASSISTANT PANEL
  html += '<div class="ai-panel">';
  html += '<div class="ai-panel-header">';
  html += '<h4>ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∑–∞–¥–∞—á–µ</h4>';
  html += '<button class="btn btn-xs btn-secondary" onclick="aiGenerateSteps()">üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω</button>';
  html += '</div>';

  // AI messages
  html += '<div class="ai-chat-messages" id="ai-messages">';
  html += '<div class="ai-msg system">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –∑–∞–¥–∞—á–µ–π ¬´'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'¬ª. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.</div>';
  html += '</div>';

  // Quick actions
  html += '<div class="ai-suggestions">';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'plan\')">üìã –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'risks\')">‚ö†Ô∏è –†–∏—Å–∫–∏</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'email\')">üìß –ù–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'checklist\')">‚úÖ –ß–µ–∫–ª–∏—Å—Ç</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'next\')">‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏</button>';
  html += '</div>';

  // Input
  html += '<div class="ai-input-area">';
  html += '<input class="ai-input" id="ai-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ò–ò –æ –∑–∞–¥–∞—á–µ..." onkeydown="if(event.key===\'Enter\')sendAiMessage()">';
  html += '<button class="ai-send-btn" id="ai-send-btn" onclick="sendAiMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>';
  html += '</div>';
  html += '</div>';

  document.getElementById('td-content').innerHTML = html;
  showPage('taskdetail');

  // Load comments and documents after rendering
  loadTaskComments(taskId);
  loadTaskDocuments(taskId);
}

function changeTaskStatus(taskId) {
  const task = DATA.tasks.find(t => t.ID===taskId);
  if(!task) return;
  const statuses = ['‚è≥ –í –æ—á–µ—Ä–µ–¥–∏', '–í —Ä–∞–±–æ—Ç–µ', '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', '–ì–æ—Ç–æ–≤–æ'];
  const cur = task['–°—Ç–∞—Ç—É—Å']||'';
  const idx = statuses.indexOf(cur);
  const next = statuses[(idx+1)%statuses.length];
  task['–°—Ç–∞—Ç—É—Å'] = next;
  openTaskDetail(taskId);
  toast('–°—Ç–∞—Ç—É—Å: '+next, 'success');
  apiWrite('–ó–∞–¥–∞—á–∏', task);
}

// ============================================================
// AI CHAT FUNCTIONS
// ============================================================
async function sendAiMessage() {
  const input = document.getElementById('ai-input');
  const msg = input.value.trim();
  if(!msg) return;

  input.value = '';
  addAiMessage('user', msg);

  // Get task context
  const task = DATA.tasks.find(t => t.ID===currentTaskId);
  const context = task ? '–ó–∞–¥–∞—á–∞: '+( task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: '+(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'. –°—Ç–∞—Ç—É—Å: '+(task['–°—Ç–∞—Ç—É—Å']||'')+'. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: '+(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'. –î–µ–¥–ª–∞–π–Ω: '+(task['–î–µ–¥–ª–∞–π–Ω']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: '+(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –ü—Ä–æ–µ–∫—Ç: '+(task['–ü—Ä–æ–µ–∫—Ç']||'')+'. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: '+(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']||'') : '';

  await callAI(msg, context);
}

function aiQuickAction(type) {
  const task = DATA.tasks.find(t => t.ID===currentTaskId);
  if(!task) return;
  const name = task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'];

  const prompts = {
    plan: '–°–æ—Å—Ç–∞–≤—å –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª. –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ —Å –æ—Ü–µ–Ω–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏.',
    risks: '–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª? –ö–∞–∫ –∏—Ö –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å?',
    email: '–ù–∞–ø–∏—à–∏ –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É –ø–æ –∑–∞–¥–∞—á–µ ¬´'+name+'¬ª. –¢–æ–Ω ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.',
    checklist: '–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–ª—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª ‚Äî —á—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º.',
    next: '–ö–∞–∫–∏–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª? –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª–µ–µ?'
  };

  const msg = prompts[type] || '–ü–æ–º–æ–≥–∏ —Å –∑–∞–¥–∞—á–µ–π ¬´'+name+'¬ª';
  addAiMessage('user', msg);

  const context = '–ó–∞–¥–∞—á–∞: '+name+'. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: '+(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'. –°—Ç–∞—Ç—É—Å: '+(task['–°—Ç–∞—Ç—É—Å']||'')+'. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: '+(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'. –î–µ–¥–ª–∞–π–Ω: '+(task['–î–µ–¥–ª–∞–π–Ω']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: '+(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'.';
  callAI(msg, context);
}

function aiGenerateSteps() {
  aiQuickAction('plan');
}

// ==================== CASCADE AI FUNCTIONS ====================
let _aiActiveRequests = { groq: 0, gemini: 0 };

async function sendGroqChat(messages, systemPrompt) {
  if (!CONFIG.GROQ_KEY) return null;
  _aiActiveRequests.groq++;
  try {
    const msgs = [];
    if (systemPrompt) msgs.push({ role: 'system', content: systemPrompt });
    messages.forEach(m => msgs.push({ role: m.role || 'user', content: m.content || m.text || String(m) }));

    const ctrl = new AbortController();
    setTimeout(() => ctrl.abort(), 30000);

    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CONFIG.GROQ_KEY },
      body: JSON.stringify({
        model: 'meta-llama/llama-4-scout-17b-16e-instruct',
        messages: msgs,
        max_tokens: 4096,
        temperature: 0.7
      }),
      signal: ctrl.signal
    });

    if (res.status === 429) { console.warn('Groq rate limited'); return null; }
    if (!res.ok) {
      // Try fallback model
      const res2 = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CONFIG.GROQ_KEY },
        body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: msgs, max_tokens: 4096, temperature: 0.7 })
      });
      if (!res2.ok) return null;
      const data2 = await res2.json();
      return { text: data2.choices?.[0]?.message?.content || '', provider: 'groq' };
    }

    const data = await res.json();
    return { text: data.choices?.[0]?.message?.content || '', provider: 'groq' };
  } catch(e) {
    console.warn('Groq error:', e.message);
    return null;
  } finally {
    _aiActiveRequests.groq--;
  }
}

async function sendGeminiChat(messages, systemPrompt) {
  if (!CONFIG.GEMINI_KEY) return null;
  _aiActiveRequests.gemini++;
  try {
    const contents = [];
    messages.forEach(m => {
      const role = (m.role === 'assistant' || m.role === 'model') ? 'model' : 'user';
      contents.push({ role, parts: [{ text: m.content || m.text || String(m) }] });
    });

    const body = {
      contents,
      generationConfig: { maxOutputTokens: 4096, temperature: 0.7 }
    };
    if (systemPrompt) {
      body.systemInstruction = { parts: [{ text: systemPrompt }] };
    }

    const ctrl = new AbortController();
    setTimeout(() => ctrl.abort(), 30000);

    const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + CONFIG.GEMINI_KEY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
      signal: ctrl.signal
    });

    if (res.status === 429) { console.warn('Gemini rate limited'); return null; }
    if (!res.ok) return null;

    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    return { text, provider: 'gemini' };
  } catch(e) {
    console.warn('Gemini error:', e.message);
    return null;
  } finally {
    _aiActiveRequests.gemini--;
  }
}

async function sendCascadeChat(messages, systemPrompt) {
  // 1. Try Groq first (most generous free tier)
  if (CONFIG.GROQ_KEY && _aiActiveRequests.groq < 25) {
    const result = await sendGroqChat(messages, systemPrompt);
    if (result) return result;
  }

  // 2. Try Gemini as backup
  if (CONFIG.GEMINI_KEY && _aiActiveRequests.gemini < 8) {
    const result = await sendGeminiChat(messages, systemPrompt);
    if (result) return result;
  }

  // 3. Fallback to Claude via n8n
  return null; // caller handles n8n fallback
}

function getAiProviderBadge(provider) {
  const badges = {
    groq: '<span style="display:inline-block;font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(255,165,0,.15);color:#f90;margin-top:4px">‚ö° Groq</span>',
    gemini: '<span style="display:inline-block;font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(66,133,244,.15);color:#48f;margin-top:4px">‚ú® Gemini</span>',
    claude: '<span style="display:inline-block;font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(204,120,50,.15);color:#c84;margin-top:4px">ü§ñ Claude</span>'
  };
  return badges[provider] || '';
}
// ==================== END CASCADE AI ====================

async function callAI(userMsg, context) {
  // Show loading
  const container = document.getElementById('ai-messages');
  const loadingId = 'ai-loading-'+Date.now();
  container.innerHTML += '<div class="ai-msg assistant" id="'+loadingId+'"><div class="ai-loading"><span></span><span></span><span></span></div></div>';
  container.scrollTop = container.scrollHeight;

  const sendBtn = document.getElementById('ai-send-btn');
  if(sendBtn) sendBtn.disabled = true;

  let aiResponse = '';
  let aiProvider = 'claude';
  try {
    // Try cascade first (Groq ‚Üí Gemini)
    const systemPrompt = '–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç CRM-—Å–∏—Å—Ç–µ–º—ã RKT HUB. –ü–æ–º–æ–≥–∞–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Å –∑–∞–¥–∞—á–∞–º–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É. –ö–æ–Ω—Ç–µ–∫—Å—Ç: ' + (context || '–æ–±—â–∏–π —á–∞—Ç') + '. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + (USER ? USER.name : '–ê–Ω–æ–Ω–∏–º') + '. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.\n\n–í–ê–ñ–ù–û: –¢—ã —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –¥–∞—ë—à—å —Å–æ–≤–µ—Ç—ã. –¢—ã –ù–ï –º–æ–∂–µ—à—å –º–µ–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Å–∏—Å—Ç–µ–º–µ (–∑–∞–¥–∞—á–∏, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö, —Å—Ç–∞–¥–∏–∏). –ù–µ —É—Ç–≤–µ—Ä–∂–¥–∞–π —á—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ –µ—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª. –†–∞–∑–¥–µ–ª—ã HUB: –ü—Ä–æ–µ–∫—Ç—ã, –î–∞—à–±–æ—Ä–¥, –ü–∞—Ä—Ç–Ω—ë—Ä—ã, –ó–∞–¥–∞—á–∏, –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏, –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è, –ù–∞—Å—Ç—Ä–æ–π–∫–∏. –í —Å–∏—Å—Ç–µ–º–µ –ù–ï–¢: –¥–æ–º–µ–Ω–æ–≤, –±–∏–ª–ª–∏–Ω–≥–∞, email-—Ä–∞—Å—Å—ã–ª–æ–∫, —Ö–æ—Å—Ç–∏–Ω–≥–∞, DNS. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç ‚Äî —Å–∫–∞–∂–∏ —á—Ç–æ –µ—ë –ø–æ–∫–∞ –Ω–µ—Ç –≤ RKT HUB.';
    const msgs = aiMessages.filter(m=>m.role==='user'||m.role==='assistant').slice(-10).map(m => ({ role: m.role, content: m.content }));
    msgs.push({ role: 'user', content: userMsg });

    const cascadeResult = await sendCascadeChat(msgs, systemPrompt);
    if (cascadeResult && cascadeResult.text) {
      aiResponse = cascadeResult.text;
      aiProvider = cascadeResult.provider;
    } else {
      // Fallback to Claude via n8n
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000);
      const response = await fetch(CONFIG.AI_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: userMsg,
          context: context,
          source: 'web',
          history: aiMessages.filter(m=>m.role==='user'||m.role==='assistant').slice(-20),
          user: USER ? USER['–ò–º—è'] : ''
        }),
        signal: controller.signal
      });
      clearTimeout(timeout);

      if (response.ok) {
        const raw3 = await response.json();
        let data3 = raw3; if (Array.isArray(raw3)) data3 = raw3[0]||{}; if (data3.json) data3 = data3.json;
        aiResponse = data3.reply || data3.response || data3.text || data3.message || '';
        if (!aiResponse && data3.content) { try { aiResponse = data3.content[0].text; } catch(e) {} }
      }
      aiProvider = 'claude';
    }
    if (!aiResponse) throw new Error('Empty response');
  } catch(e) {
    console.warn('Task AI fallback:', e.message);
    aiResponse = generateLocalAIResponse(userMsg, context);
    aiProvider = 'local';
  }

  const loadEl = document.getElementById(loadingId);
  if(loadEl) loadEl.remove();
  addAiMessage('assistant', aiResponse + '\n' + getAiProviderBadge(aiProvider));
  if(sendBtn) sendBtn.disabled = false;
}

function generateLocalAIResponse(msg, context) {
  // Smart local fallback when AI endpoint is not available
  const lower = msg.toLowerCase();

  if (lower.includes('–ø–ª–∞–Ω') || lower.includes('—à–∞–≥')) {
    return 'üìã **–ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**\n\n1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π\n2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\n3. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ª–∏—Ü–∞–º–∏\n4. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã\n5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n6. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–¥–∞—á–∏\n\n‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ä–æ–∫: —Ä–∞–∑–±–µ–π—Ç–µ –Ω–∞ —ç—Ç–∞–ø—ã –ø–æ 1-2 –¥–Ω—è –∫–∞–∂–¥—ã–π.\n\nüí° –°–æ–≤–µ—Ç: –Ω–∞—á–Ω–∏—Ç–µ —Å –ø—É–Ω–∫—Ç–∞ 1 —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å.';
  }
  if (lower.includes('—Ä–∏—Å–∫')) {
    return '‚ö†Ô∏è **–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∏—Å–∫–∏:**\n\n1. –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤/–ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤\n2. –ù–µ—Ö–≤–∞—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–ª–∏ –±—é–¥–∂–µ—Ç–∞\n3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ\n4. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏\n\nüõ° **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**\n- –ó–∞–ª–æ–∂–∏—Ç–µ –±—É—Ñ–µ—Ä –ø–æ —Å—Ä–æ–∫–∞–º (15-20%)\n- –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –ø–ª–∞–Ω –ë –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —ç—Ç–∞–ø–æ–≤\n- –†–µ–≥—É–ª—è—Ä–Ω–æ —Å–≤–µ—Ä—è–π—Ç–µ—Å—å —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º';
  }
  if (lower.includes('–ø–∏—Å—å–º') || lower.includes('email')) {
    return 'üìß **–®–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞:**\n\n–£–≤–∞–∂–∞–µ–º—ã–π [–ò–º—è],\n\n–í —Ä–∞–º–∫–∞—Ö –Ω–∞—à–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ —Ö–æ—Ç–µ–ª –±—ã –æ–±—Å—É–¥–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ –∑–∞–¥–∞—á–µ.\n\n–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ —ç—Ç–∞–ø–µ [—ç—Ç–∞–ø]. –î–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ [–¥–µ–π—Å—Ç–≤–∏–µ].\n\n–ü—Ä–µ–¥–ª–∞–≥–∞—é –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É/–∑–≤–æ–Ω–æ–∫ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n'+((USER?USER.name:''))||'[–í–∞—à–µ –∏–º—è]';
  }
  if (lower.includes('—á–µ–∫–ª–∏—Å—Ç') || lower.includes('–ø—Ä–æ–≤–µ—Ä–∫')) {
    return '‚úÖ **–ß–µ–∫–ª–∏—Å—Ç:**\n\n‚òê –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã\n‚òê –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –ø–æ–ª—É—á–µ–Ω–æ\n‚òê –ë—é–¥–∂–µ—Ç —É—Ç–≤–µ—Ä–∂–¥—ë–Ω\n‚òê –°—Ä–æ–∫–∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã\n‚òê –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã\n‚òê –†–∏—Å–∫–∏ —É—á—Ç–µ–Ω—ã\n‚òê –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¢–ó\n‚òê –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ–ª—É—á–µ–Ω–∞';
  }
  if (lower.includes('—Å–ª–µ–¥—É—é—â') || lower.includes('–¥–∞–ª–µ–µ') || lower.includes('next')) {
    return '‚û°Ô∏è **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**\n\n1. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏\n2. –£–≤–µ–¥–æ–º–∏—Ç—å –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—Ü –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏\n3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ —Å–∏—Å—Ç–µ–º–µ\n4. –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤—É (—á—Ç–æ –ø–æ—à–ª–æ —Ö–æ—Ä–æ—à–æ / —á—Ç–æ —É–ª—É—á—à–∏—Ç—å)\n5. –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É';
  }

  return 'ü§ñ –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∑–∞–¥–∞—á—É. –í–æ—Ç —á—Ç–æ –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å:\n\n' + context + '\n\n–ß—Ç–æ–±—ã —è –¥–∞–ª –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç, —É—Ç–æ—á–Ω–∏—Ç–µ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç ‚Äî –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, —Ä–∏—Å–∫–∏, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏–ª–∏ –¥—Ä—É–≥–æ–π –∞—Å–ø–µ–∫—Ç.';
}

function addAiMessage(role, text) {
  aiMessages.push({ role, content: text });
  const container = document.getElementById('ai-messages');
  const div = document.createElement('div');
  div.className = 'ai-msg ' + role;
  div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// ============================================================
// GLOBAL AI ASSISTANT PANEL
// ============================================================
let globalAiMessages = JSON.parse(localStorage.getItem('rkt_ai_history') || '[]');
let aiPanelOpen = false;

function saveAiHistory() {
  try { localStorage.setItem('rkt_ai_history', JSON.stringify(globalAiMessages.slice(-30))); } catch(e){}
}

function restoreAiHistory() {
  const container = document.getElementById('ai-global-messages');
  if (!container || !globalAiMessages.length) return;
  globalAiMessages.forEach(m => {
    const div = document.createElement('div');
    div.className = 'ai-msg ' + (m.role === 'user' ? 'user' : 'assistant');
    div.innerHTML = (m.content||'').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    container.appendChild(div);
  });
  container.scrollTop = container.scrollHeight;
}

function toggleAiPanel() {
  const panel = document.getElementById('aiGlobalPanel');
  const fab = document.getElementById('aiFab');
  aiPanelOpen = !aiPanelOpen;
  if (aiPanelOpen) {
    panel.style.display = 'flex';
    fab.style.display = 'none';
    // Restore history on first open
    const container = document.getElementById('ai-global-messages');
    if (container && container.children.length <= 1) restoreAiHistory();
    setTimeout(() => document.getElementById('ai-global-input').focus(), 100);
  } else {
    panel.style.display = 'none';
    fab.style.display = 'flex';
  }
}

function getDataContext() {
  const ctx = { projects: {}, staff_count: DATA.staff.length, total_tasks: 0, overdue: [], upcoming: [], clients: [] };
  const now = new Date();
  for (const [key, proj] of Object.entries(PROJECTS)) {
    const tasks = DATA.tasks.filter(t => {
      for (const sub of Object.keys(proj.subprojects)) {
        if (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === sub || t['–ü—Ä–æ–µ–∫—Ç'] === proj.name) return true;
      }
      return false;
    });
    // Add client/direction info for each subproject
    const subs = {};
    for (const sub of Object.keys(proj.subprojects)) {
      const dir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === sub);
      const subTasks = tasks.filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === sub);
      subs[sub] = { 
        tasks: subTasks.length, 
        stage: dir ? (dir.stage||'prospect') : null,
        manager: dir ? dir['–ú–µ–Ω–µ–¥–∂–µ—Ä'] : null,
        price: dir ? dir['–¶–µ–Ω–∞'] : null,
        paid: dir ? !!dir['–û–ø–ª–∞—á–µ–Ω–æ'] : false
      };
    }
    ctx.projects[proj.name] = { subprojects: subs, total_tasks: tasks.length };
    ctx.total_tasks += tasks.length;
    tasks.forEach(t => {
      if (t['–î–µ–¥–ª–∞–π–Ω'] && t['–°—Ç–∞—Ç—É—Å'] !== '–ì–æ—Ç–æ–≤–æ' && t['–°—Ç–∞—Ç—É—Å'] !== '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') {
        const dl = new Date(t['–î–µ–¥–ª–∞–π–Ω']);
        if (dl < now) ctx.overdue.push({ task: t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'], deadline: t['–î–µ–¥–ª–∞–π–Ω'], direction: t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'], assignee: t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] });
        else if (dl - now < 7*86400000) ctx.upcoming.push({ task: t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'], deadline: t['–î–µ–¥–ª–∞–π–Ω'], direction: t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'], assignee: t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] });
      }
    });
  }
  // Add all clients/directions
  (DATA.directions||[]).forEach(d => {
    ctx.clients.push({ name: d['–ù–∞–∑–≤–∞–Ω–∏–µ'], stage: d.stage||'prospect', price: d['–¶–µ–Ω–∞'], paid: !!d['–û–ø–ª–∞—á–µ–Ω–æ'], manager: d['–ú–µ–Ω–µ–¥–∂–µ—Ä'], project: d['–ü—Ä–æ–µ–∫—Ç'] });
  });
  ctx.partners_count = DATA.partners.length;
  ctx.comms_count = DATA.comms.length;
  return ctx;
}

// === Chat ‚Üí Telegram reminder handler ===
async function handleChatReminder(msg) {
  const lower = msg.toLowerCase();

  // Check for "–Ω–∞–ø–æ–º–Ω–∏ –≤—Å–µ–º" pattern
  if (lower.match(/–Ω–∞–ø–æ–º–Ω.*–≤—Å–µ[–º—Ö]|–æ—Ç–ø—Ä–∞–≤.*–≤—Å–µ[–º—Ö]|—É–≤–µ–¥–æ–º.*–≤—Å–µ[—Ö–º]/)) {
    const activeTasks = (DATA.tasks||[]).filter(t => {
      const st = (t['–°—Ç–∞—Ç—É—Å']||'');
      return st !== '–ì–æ—Ç–æ–≤–æ' && st !== '‚úÖ –ì–æ—Ç–æ–≤–æ' && t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'];
    });
    if (!activeTasks.length) return 'üìã –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.';

    let sent = 0;
    const seenNames = new Set();
    for (const t of activeTasks) {
      const name = t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'];
      if (seenNames.has(name)) continue;
      seenNames.add(name);
      const s = (DATA.staff||[]).find(st => st['–ò–º—è'] === name);
      const tgId = s && (s['Telegram_ID'] || s.telegram_id);
      if (tgId) {
        const myTasks = activeTasks.filter(tt => tt['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] === name);
        const taskList = myTasks.map(tt => '‚Ä¢ ' + (tt['–û–ø–∏—Å–∞–Ω–∏–µ']||tt['–ù–∞–∑–≤–∞–Ω–∏–µ'])).join('\n');
        await sendTelegramNotification(tgId, 'üì¢ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç ' + (USER?.name||'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å') + ':\n\n–£ –≤–∞—Å ' + myTasks.length + ' –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á:\n' + taskList + '\n\n–°–æ–æ–±—â–µ–Ω–∏–µ: ' + msg);
        sent++;
      }
    }
    return '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ' + sent + ' –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ Telegram (' + seenNames.size + ' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º).\n\nüìã –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á: ' + activeTasks.length;
  }

  // Check for "–Ω–∞–ø–æ–º–Ω–∏ [–∏–º—è]" pattern
  const reminderMatch = lower.match(/(?:–Ω–∞–ø–æ–º–Ω–∏|–Ω–∞–ø–æ–º–Ω–∏—Ç—å|–æ—Ç–ø—Ä–∞–≤—å|—Å–∫–∞–∂–∏|—É–≤–µ–¥–æ–º–∏)\s+(\S+)/);
  if (reminderMatch) {
    const targetName = reminderMatch[1];
    const staff = (DATA.staff||[]).find(s => {
      const name = (s['–ò–º—è']||'').toLowerCase();
      return name.includes(targetName) || targetName.includes(name.split(' ')[0]?.toLowerCase()||'___');
    });

    if (staff) {
      const tgId = staff['Telegram_ID'] || staff.telegram_id;
      if (!tgId) return '‚ö†Ô∏è –£ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ' + staff['–ò–º—è'] + ' –Ω–µ —É–∫–∞–∑–∞–Ω Telegram ID. –î–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.';

      // Extract message after name
      const msgPart = msg.replace(/^.*?(?:–Ω–∞–ø–æ–º–Ω–∏|–Ω–∞–ø–æ–º–Ω–∏—Ç—å|–æ—Ç–ø—Ä–∞–≤—å|—Å–∫–∞–∂–∏|—É–≤–µ–¥–æ–º–∏)\s+\S+\s*/i, '').trim() || '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç ' + (USER?.name||'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å');
      await sendTelegramNotification(tgId, 'üì¢ ' + (USER?.name||'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å') + ': ' + msgPart);
      return '‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ **' + staff['–ò–º—è'] + '** –≤ Telegram!\n\nüí¨ –¢–µ–∫—Å—Ç: ' + msgPart;
    }
  }

  return null; // Not a reminder command ‚Äî pass to AI
}

async function sendGlobalAi() {
  const input = document.getElementById('ai-global-input');
  let msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  input.disabled = true;

  // Handle attached file
  let fileInfo = '';
  if (window._aiAttachedFile) {
    const f = window._aiAttachedFile;
    fileInfo = '\n\n[–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω —Ñ–∞–π–ª: ' + f.name + ' (' + formatFileSize(f.size) + ')]';
    // Read text files
    if (f.name.match(/\.(txt|csv|md|json)$/i) && f.size < 100000) {
      try {
        const text = await f.text();
        fileInfo += '\n–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:\n' + text.substring(0, 5000);
      } catch(e) {}
    }
    window._aiAttachedFile = null;
    const badge = document.getElementById('ai-file-badge');
    if (badge) badge.style.display = 'none';
  }
  msg += fileInfo;

  // === Intercept reminder/notification commands ===
  const reminderResult = await handleChatReminder(msg);
  if (reminderResult) {
    // Show in chat as user + system response
    const container2 = document.getElementById('ai-global-messages');
    const uDiv = document.createElement('div');
    uDiv.className = 'ai-msg user';
    uDiv.textContent = msg.split('\n')[0];
    container2.appendChild(uDiv);
    globalAiMessages.push({ role: 'user', content: msg });

    const rDiv = document.createElement('div');
    rDiv.className = 'ai-msg assistant';
    rDiv.innerHTML = reminderResult.replace(/\n/g, '<br>');
    container2.appendChild(rDiv);
    globalAiMessages.push({ role: 'assistant', content: reminderResult });
    saveAiHistory();
    container2.scrollTop = container2.scrollHeight;
    input.disabled = false;
    input.focus();
    return;
  }

  const container = document.getElementById('ai-global-messages');
  const userDiv = document.createElement('div');
  userDiv.className = 'ai-msg user';
  userDiv.textContent = msg.split('\n')[0]; // Show first line only in chat
  container.appendChild(userDiv);
  globalAiMessages.push({ role: 'user', content: msg });
  saveAiHistory();

  // Typing indicator
  const typing = document.createElement('div');
  typing.className = 'ai-msg system';
  typing.innerHTML = '‚è≥ –î—É–º–∞—é...';
  typing.id = 'ai-typing';
  container.appendChild(typing);
  container.scrollTop = container.scrollHeight;

  const dataCtx = getDataContext();
  let aiText = '';
  let aiProvider = 'claude';

  try {
    // Try cascade first (Groq ‚Üí Gemini ‚Üí Claude)
    const systemPrompt = '–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç CRM-—Å–∏—Å—Ç–µ–º—ã RKT HUB. –ü–æ–º–æ–≥–∞–π —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º–∏, –∑–∞–¥–∞—á–∞–º–∏ –∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + (USER?.name || '–ê–Ω–æ–Ω–∏–º') + ', —Ä–æ–ª—å: ' + (USER?.role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫') + '. –¢–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç: ' + (currentSubproject || currentProject || '–Ω–µ –≤—ã–±—Ä–∞–Ω') + '. –î–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã: ' + JSON.stringify(dataCtx).substring(0, 2000) + '. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ–ª–µ–∑–Ω–æ.\n\n–ü–†–ê–í–ò–õ–ê: –¢—ã –ù–ï –º–æ–∂–µ—à—å –º–µ–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Äî —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—Ç—å –∏ —Å–æ–≤–µ—Ç–æ–≤–∞—Ç—å. –ù–µ –≥–æ–≤–æ—Ä–∏ ¬´–ì–æ—Ç–æ–≤–æ/–°–¥–µ–ª–∞–Ω–æ¬ª –µ—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª –æ–ø–µ—Ä–∞—Ü–∏—é. –†–∞–∑–¥–µ–ª—ã —Å–∏—Å—Ç–µ–º—ã: –ü—Ä–æ–µ–∫—Ç—ã, –î–∞—à–±–æ—Ä–¥ –ì–î, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –ü–∞—Ä—Ç–Ω—ë—Ä—ã, –ó–∞–¥–∞—á–∏, –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏, –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è, –ù–∞—Å—Ç—Ä–æ–π–∫–∏. –í–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞: –û–±–∑–æ—Ä, –ó–∞–¥–∞—á–∏, –ü–∞—Ä—Ç–Ω—ë—Ä—ã, –ö–æ–º–∞–Ω–¥–∞, –ü–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫, –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏, –§–∏–Ω–∞–Ω—Å—ã, –ó–∞—Ä–ø–ª–∞—Ç—ã. –í —Å–∏—Å—Ç–µ–º–µ –ù–ï–¢ —Ä–∞–∑–¥–µ–ª–æ–≤: –î–æ–º–µ–Ω—ã, –ë–∏–ª–ª–∏–Ω–≥, Email, –•–æ—Å—Ç–∏–Ω–≥, DNS. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç ‚Äî —Å–∫–∞–∂–∏ ¬´—Ç–∞–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –≤ RKT HUB¬ª.';

    const chatMsgs = globalAiMessages.filter(m=>m.role==='user'||m.role==='assistant').slice(-10).map(m => ({ role: m.role, content: m.content }));
    chatMsgs.push({ role: 'user', content: msg });

    const cascadeResult = await sendCascadeChat(chatMsgs, systemPrompt);
    if (cascadeResult && cascadeResult.text) {
      aiText = cascadeResult.text;
      aiProvider = cascadeResult.provider;
    } else {
      // Fallback to Claude via n8n
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000);
      const response = await fetch(CONFIG.AI_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: msg,
          userId: USER?.tgId || '',
          context: 'chat',
          source: 'web',
          direction: currentSubproject || currentProject || '',
          user: USER?.name || '',
          dataContext: JSON.stringify(dataCtx),
          history: globalAiMessages.filter(m=>m.role==='user'||m.role==='assistant').slice(-20)
        }),
        signal: controller.signal
      });
      clearTimeout(timeout);
      if (!response.ok) throw new Error('HTTP ' + response.status);
      const raw = await response.json();
      let data = raw;
      if (Array.isArray(raw)) data = raw[0] || {};
      if (data.json) data = data.json;
      aiText = data.reply || data.response || data.text || data.message || data.output || '';
      if (!aiText && data.content) { try { aiText = data.content[0].text; } catch(e) {} }
      if (!aiText && typeof raw === 'string') aiText = raw;
      if (!aiText) throw new Error('Empty response. Raw: ' + JSON.stringify(raw).slice(0,200));
      aiProvider = 'claude';
    }
  } catch(e) {
    console.error('AI API error:', e.message, e);
    aiText = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
    aiProvider = 'error';
  }

  typing.remove();
  const aiDiv = document.createElement('div');
  aiDiv.className = 'ai-msg assistant';
  const badge = aiProvider !== 'error' ? getAiProviderBadge(aiProvider) : '';
  aiDiv.innerHTML = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') + (badge ? '<br>' + badge : '');
  container.appendChild(aiDiv);
  globalAiMessages.push({ role: 'assistant', content: aiText });
  saveAiHistory();
  container.scrollTop = container.scrollHeight;
  input.disabled = false;
  input.focus();
}

function globalAiQuick(question) {
  document.getElementById('ai-global-input').value = question;
  sendGlobalAi();
}

function generateGlobalFallback(msg, ctx) {
  const ml = msg.toLowerCase();
  const td = today();

  // Direction-specific queries: "—á—Ç–æ –ø–æ –ö–¢?", "—Å—Ç–∞—Ç—É—Å —Ä–æ–±–æ—Ç–æ–≤", etc.
  const dirKeywords = {
    '–∫—Ç':['–ö–¢','–∫—Ç','—Ç–æ–º–æ–≥—Ä–∞—Ñ','ct'], '—Ä–µ–Ω—Ç–≥–µ–Ω':['–†–µ–Ω—Ç–≥–µ–Ω','—Ä–µ–Ω—Ç–≥–µ–Ω','xray'],
    '—Ä–æ–±–æ—Ç':['–†–æ–±–æ—Ç—ã','—Ä–æ–±–æ—Ç','—Ö–∏—Ä—É—Ä–≥'], '—É—Ä–æ–ª–æ–≥':['–£—Ä–æ–ª–æ–≥–∏—è','—É—Ä–æ–ª–æ–≥'],
    'pacs':['PACS','pacs','–∞—Ä—Ö–∏–≤'], '—É–∑–∏':['–£–ó–ò','—É–∑–∏','—É–ª—å—Ç—Ä–∞–∑–≤—É–∫'],
    '—Å–∞–π—Ç':['–°–∞–π—Ç—ã','—Å–∞–π—Ç','web','–≤–µ–±'], '–ø—ã—à–∫–∏':['–ü—ã—à–∫–∏','–ø—ã—à–∫–∏','–ø–æ–Ω—á–∏–∫'],
    '–±—Ä–µ–∂–Ω–µ–≤':['–ë—Ä–µ–∂–Ω–µ–≤','–±—Ä–µ–∂–Ω–µ–≤'], '–∫–µ—Ä–∞—Ç–∏–Ω':['–ö–µ—Ä–∞—Ç–∏–Ω','–∫–µ—Ä–∞—Ç–∏–Ω','–∞–≥—Ä—ã–∑']
  };
  for (const [key, words] of Object.entries(dirKeywords)) {
    if (words.some(w => ml.includes(w.toLowerCase()))) {
      const allDirs = getDirectionOptions();
      const matchDir = allDirs.find(d => words.some(w => d.toLowerCase().includes(w.toLowerCase()))) || words[0];
      const dirPartners = DATA.partners.filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(key));
      const dirTasks = DATA.tasks.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(key));
      const openTasks = dirTasks.filter(t => t['–°—Ç–∞—Ç—É—Å'] !== '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' && t['–°—Ç–∞—Ç—É—Å'] !== '–ì–æ—Ç–æ–≤–æ' && t['–°—Ç–∞—Ç—É—Å'] !== '‚úÖ –ì–æ—Ç–æ–≤–æ');
      const overdueT = openTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < td);
      let r = 'üìÇ **'+matchDir+':**\n\n';
      r += 'ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+dirPartners.length+'\n';
      if (dirPartners.length) dirPartners.forEach(p => r += '  ‚Ä¢ '+(p['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+' ('+(p['–°—Ç—Ä–∞–Ω–∞']||'?')+') ‚Äî '+(p['–°—Ç–∞—Ç—É—Å']||'?')+'\n');
      r += '\n‚úÖ –ó–∞–¥–∞—á: '+dirTasks.length+' (–æ—Ç–∫—Ä—ã—Ç—ã—Ö: '+openTasks.length;
      if (overdueT.length) r += ', üî¥ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+overdueT.length;
      r += ')\n';
      if (openTasks.length) openTasks.slice(0,5).forEach(t => r += '  ‚Ä¢ '+(t['–ù–∞–∑–≤–∞–Ω–∏–µ']||t['–û–ø–∏—Å–∞–Ω–∏–µ']||'‚Äî')+' ‚Äî '+(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'?')+', –¥–µ–¥–ª–∞–π–Ω: '+(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'\n');
      return r;
    }
  }

  if (ml.includes('–ø—Ä–æ—Å—Ä–æ—á') || ml.includes('overdue')) {
    if (ctx.overdue.length === 0) return '‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç.';
    let r = 'üî¥ **–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ ('+ctx.overdue.length+'):**\n';
    ctx.overdue.forEach(t => r += '‚Ä¢ '+t.task+' ‚Äî –¥–µ–¥–ª–∞–π–Ω: '+t.deadline+', '+t.direction+'\n');
    r += '\nüí° –†–∞–∑–æ–±—Ä–∞—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ, –æ–±–Ω–æ–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω—ã.';
    return r;
  }
  if (ml.includes('–æ—Ç—á—ë—Ç') || ml.includes('–æ—Ç—á–µ—Ç') || ml.includes('report')) {
    let r = 'üìä **–°–≤–æ–¥–∫–∞ RKT HUB:**\n\n';
    for (const [name, info] of Object.entries(ctx.projects)) r += '‚Ä¢ **'+name+'**: '+info.subprojects+' –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π, '+info.tasks+' –∑–∞–¥–∞—á\n';
    r += '\nüë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: '+ctx.staff_count+'\nü§ù –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+ctx.partners_count;
    r += '\nüî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+ctx.overdue.length+'\n‚ö†Ô∏è –ë–ª–∏–∂–∞–π—à–∏–µ: '+ctx.upcoming.length;
    if (ctx.overdue.length) { r += '\n\n**–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ:**\n'; ctx.overdue.slice(0,5).forEach(t => r += '‚Ä¢ '+t.task+' ('+t.deadline+')\n'); }
    return r;
  }
  if (ml.includes('–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç') || ml.includes('priority')) {
    let r = '‚≠ê **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:**\n';
    if (ctx.overdue.length) { r += '1. üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ctx.overdue.length+'):\n'; ctx.overdue.forEach(t => r += '   ‚Ä¢ '+t.task+'\n'); }
    if (ctx.upcoming.length) r += '2. ‚è∞ –ë–ª–∏–∂–∞–π—à–∏–µ: '+ctx.upcoming.map(t=>t.task).join(', ')+'\n';
    r += '3. üìÇ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º';
    return r;
  }
  if (ml.includes('–ø–ª–∞–Ω')) {
    return 'üìã **–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é:**\n‚Ä¢ –ü–Ω: –†–µ–≤—å—é —Å—Ç–∞—Ç—É—Å–æ–≤\n‚Ä¢ –í—Ç-–°—Ä: –ö–ª—é—á–µ–≤—ã–µ –∑–∞–¥–∞—á–∏\n‚Ä¢ –ß—Ç: –í—Å—Ç—Ä–µ—á–∏ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏\n‚Ä¢ –ü—Ç: –ò—Ç–æ–≥–∏\n\nüìå –ó–∞–¥–∞—á: '+ctx.total_tasks+' | –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+ctx.overdue.length+' | –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: '+ctx.staff_count;
  }
  if (ml.includes('–ø–∏—Å—å–º') || ml.includes('email')) {
    return 'üìß –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º—É –∏ –æ —á—ë–º. –ü—Ä–∏–º–µ—Ä—ã:\n‚Ä¢ ¬´–ü–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É Syno Medical –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ—Å—Ç–∞–≤–∫–∏¬ª\n‚Ä¢ ¬´–ü–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞¬ª';
  }
  if (ml.includes('—Ä–∏—Å–∫')) {
    let r = '‚ö†Ô∏è **–†–∏—Å–∫–∏:**\n';
    if (ctx.overdue.length) r += '1. üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ctx.overdue.length+')\n';
    r += '2. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤\n3. –°—Ä–æ–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º –ø—Ä–æ–µ–∫—Ç–∞–º';
    return r;
  }
  if (ml.includes('–∫–æ–º–∞–Ω–¥') || ml.includes('—Å–æ—Ç—Ä—É–¥–Ω–∏–∫') || ml.includes('–∫—Ç–æ –≤')) {
    let r = 'üë• **–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ('+DATA.staff.length+'):**\n';
    DATA.staff.forEach(s => r += '‚Ä¢ '+(ROLES[s['–†–æ–ª—å']]?.emoji||'üë§')+' '+(s['–ò–º—è']||'?')+' ‚Äî '+(s['–†–æ–ª—å']||'?')+', '+(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'–í—Å–µ')+'\n');
    return r;
  }
  if (ml.includes('–ø–∞—Ä—Ç–Ω—ë—Ä') || ml.includes('–ø–∞—Ä—Ç–Ω–µ—Ä')) {
    let r = 'ü§ù **–ü–∞—Ä—Ç–Ω—ë—Ä—ã ('+DATA.partners.length+'):**\n';
    DATA.partners.forEach(p => r += '‚Ä¢ '+(p['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+' ('+(p['–°—Ç—Ä–∞–Ω–∞']||'?')+') ‚Äî '+(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'?')+', '+(p['–°—Ç–∞—Ç—É—Å']||'?')+'\n');
    return r;
  }
  return 'ü§ñ –í —Å–∏—Å—Ç–µ–º–µ '+ctx.total_tasks+' –∑–∞–¥–∞—á, '+ctx.staff_count+' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, '+ctx.partners_count+' –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.\n\nüí° –°–ø—Ä–æ—Å–∏—Ç–µ:\n‚Ä¢ **–ü–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é:** ¬´—á—Ç–æ –ø–æ –ö–¢?¬ª, ¬´—Å—Ç–∞—Ç—É—Å —Ä–æ–±–æ—Ç–æ–≤¬ª\n‚Ä¢ **–ó–∞–¥–∞—á–∏:** ¬´–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ¬ª, ¬´–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã¬ª\n‚Ä¢ **–û—Ç—á—ë—Ç:** ¬´–æ—Ç—á—ë—Ç¬ª, ¬´–ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é¬ª\n‚Ä¢ **–ö–æ–º–∞–Ω–¥–∞:** ¬´–∫—Ç–æ –≤ –∫–æ–º–∞–Ω–¥–µ?¬ª\n‚Ä¢ **–ü–∏—Å—å–º–æ:** ¬´–Ω–∞–ø–∏—à–∏ –ø–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É X¬ª';
}

function openModal(type, existingData) {
  if (type === 'newproject') {
    openAddProjectModal();
    return;
  }

  currentModal = type;
  editingItem = existingData || null;
  const def = FORM_DEFS[type];
  if(!def) return;

  // Auto-set direction
  const autoDir = currentSubproject || null;

  document.getElementById('modalTitle').textContent = (editingItem?'‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ':'‚ûï –î–æ–±–∞–≤–∏—Ç—å: ') + def.title;

  let html = '';
  for (const field of def.fields) {
    const autoProj = currentProject ? (PROJECTS[currentProject]||{}).name : '';
    const val = editingItem ? (editingItem[field.name]||'') : (field.name==='–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'&&autoDir ? autoDir : (field.name==='–ü—Ä–æ–µ–∫—Ç'&&autoProj ? autoProj : ''));
    const req = field.required ? 'required' : '';

    html += '<div class="form-group"><label class="'+req+'">'+esc(field.name)+'</label>';
    const opts = typeof field.options === 'function' ? field.options() : field.options;

    if (field.type==='select') {
      const changeAttr = field.onchange ? ' onchange="'+field.onchange+'"' : '';
      html += '<select id="field-'+field.name+'"'+changeAttr+'>';
      if (!field.required) html += '<option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>';
      for (const o of (opts||[])) html += '<option value="'+escA(o)+'"'+(val===o?' selected':'')+'>'+esc(o)+'</option>';
      html += '</select>';
    } else if (field.type==='textarea') {
      html += '<textarea id="field-'+field.name+'" placeholder="'+escA(field.placeholder||'')+'">'+esc(val)+'</textarea>';
    } else {
      html += '<input type="'+field.type+'" id="field-'+field.name+'" value="'+escA(val)+'" placeholder="'+escA(field.placeholder||'')+'">';
    }
    html += '</div>';
  }

  // Add extra_projects multi-select for CEO editing staff
  if (type === 'staff' && getUserPerms().seeAll) {
    const projNames = Object.values(PROJECTS).map(p => p.name);
    let extraProjects = [];
    try { extraProjects = JSON.parse((editingItem && editingItem['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã']) || '[]'); } catch(e) {}
    html += '<div class="form-group"><label>–î–æ–ø. –ø—Ä–æ–µ–∫—Ç—ã (CEO)</label>';
    html += '<div id="extra-projects-checkboxes" style="display:flex;flex-wrap:wrap;gap:8px;padding:8px 0">';
    projNames.forEach(pn => {
      const checked = extraProjects.includes(pn) ? ' checked' : '';
      html += '<label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:13px">';
      html += '<input type="checkbox" class="extra-proj-cb" value="'+escA(pn)+'"'+checked+'> '+esc(pn);
      html += '</label>';
    });
    html += '</div></div>';
  }

  // === Individual permissions checkboxes (CEO only) ===
  if (type === 'staff' && getUserPerms().seeAll) {
    const PERM_LABELS = {
      canWrite: '–ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö', canDelete: '–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π', canApprove: '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ',
      canManageStaff: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π', seeAll: '–í–∏–¥–µ—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã',
      canEditTasks: '–ó–∞–¥–∞—á–∏', canEditPartners: '–ü–∞—Ä—Ç–Ω—ë—Ä—ã', canEditStaff: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
      canEditProjects: '–ü—Ä–æ–µ–∫—Ç—ã', canAssignTasks: '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–∞—á',
      canViewFinance: '–§–∏–Ω–∞–Ω—Å—ã', canExport: '–≠–∫—Å–ø–æ—Ä—Ç', canSettings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
      canCreateSiteTask: '–°–∞–π—Ç-–∑–∞–¥–∞—á–∏', canGenerateSite: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–π—Ç–æ–≤'
    };
    const staffRole = (editingItem && editingItem['–†–æ–ª—å']) || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
    const roleDefaults = ROLES[staffRole] || ROLES['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
    let permOverrides = {};
    try { permOverrides = JSON.parse((editingItem && editingItem['–ü—Ä–∞–≤–∞']) || '{}'); } catch(e) {}
    if (!permOverrides || typeof permOverrides !== 'object') permOverrides = {};

    const PERM_GROUPS = [
      { title: 'üîë –û—Å–Ω–æ–≤–Ω—ã–µ', keys: ['canWrite','canDelete','canApprove','canManageStaff','seeAll'] },
      { title: 'üìÇ –†–∞–∑–¥–µ–ª—ã', keys: ['canEditTasks','canEditPartners','canEditStaff','canEditProjects','canAssignTasks'] },
      { title: '‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ', keys: ['canViewFinance','canExport','canSettings','canCreateSiteTask','canGenerateSite'] }
    ];

    html += '<div class="form-group" id="perms-section">';
    html += '<label style="font-size:14px;font-weight:600;margin-bottom:8px;display:block">üîê –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞</label>';
    html += '<div style="font-size:11px;color:var(--text2);margin-bottom:12px">–†–æ–ª—å: <b>'+esc(staffRole)+'</b> ‚Äî –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞ –ø–æ–¥—Å–≤–µ—á–µ–Ω—ã –∑–µ–ª—ë–Ω—ã–º</div>';

    PERM_GROUPS.forEach(group => {
      html += '<div style="font-size:11px;font-weight:600;color:var(--text2);margin:10px 0 4px;text-transform:uppercase;letter-spacing:0.5px">'+group.title+'</div>';
      group.keys.forEach(key => {
        const label = PERM_LABELS[key] || key;
        const roleVal = !!roleDefaults[key];
        const hasOverride = permOverrides.hasOwnProperty(key);
        const curVal = hasOverride ? !!permOverrides[key] : roleVal;
        const modified = hasOverride && permOverrides[key] !== roleVal;
        const accentStyle = modified ? 'color:var(--accent);font-weight:600' : '';
        html += '<label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;font-size:13px;padding:8px 10px;border-radius:8px;background:var(--bg2);margin-bottom:3px;'+accentStyle+'">';
        html += '<span>'+esc(label)+'</span>';
        html += '<input type="checkbox" class="perm-cb" data-perm="'+key+'" data-role-default="'+roleVal+'"'+(curVal?' checked':'')+' onchange="highlightPermChange(this)" style="width:18px;height:18px;accent-color:var(--accent)">';
        html += '</label>';
      });
    });

    html += '<button type="button" onclick="resetPermDefaults()" style="margin-top:10px;padding:8px 16px;font-size:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg2);color:var(--text2);cursor:pointer;width:100%">üîÑ –°–±—Ä–æ—Å –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –ø—Ä–∞–≤–∞–º —Ä–æ–ª–∏</button>';
    html += '</div>';
  }

  document.getElementById('modalBody').innerHTML = html;
  // Restore footer buttons (may be cleared by openPricingEditor)
  const mFooter = document.getElementById('modalFooter');
  if (mFooter && !document.getElementById('modalSaveBtn')) {
    mFooter.innerHTML = '<button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" id="modalSaveBtn" onclick="saveModal()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>';
  }
  // Restore save button visibility (may be hidden by openQuickSiteTask)
  const saveBtn = document.getElementById('modalSaveBtn');
  if (saveBtn) saveBtn.style.display = '';
  document.getElementById('modalOverlay').classList.add('show');

  // Auto-filter directions by selected project (for staff form)
  if (type === 'staff') {
    const projSel = document.getElementById('field-–ü—Ä–æ–µ–∫—Ç');
    if (projSel) updateDirectionOptions(projSel.value);
    if (editingItem) {
      const dirSel = document.getElementById('field-–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
      if (dirSel) dirSel.value = editingItem['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–í—Å–µ';
    }
  }

  // Auto-filter staff and directions by selected project (for task form)
  if (type === 'task') {
    const projSel = document.getElementById('field-–ü—Ä–æ–µ–∫—Ç');
    if (projSel) {
      projSel.addEventListener('change', function() {
        const sel = this.value;
        const dirSel = document.getElementById('field-–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
        if (dirSel) {
          const cur = dirSel.value;
          const opts = getDirectionOptions(sel);
          dirSel.innerHTML = '<option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>' + opts.map(o => '<option value="'+escA(o)+'"'+(cur===o?' selected':'')+'>'+esc(o)+'</option>').join('');
        }
        const staffSel = document.getElementById('field-–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π');
        if (staffSel) {
          const cur = staffSel.value;
          const opts = getStaffOptions(sel);
          staffSel.innerHTML = '<option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>' + opts.map(o => '<option value="'+escA(o)+'"'+(cur===o?' selected':'')+'>'+esc(o)+'</option>').join('');
        }
      });
      // If project was auto-set, trigger change to sync direction/staff filters
      if (!editingItem && projSel.value) {
        projSel.dispatchEvent(new Event('change'));
      }
    }
  }

  setTimeout(() => { const f=document.getElementById('field-'+def.fields[0].name); if(f)f.focus(); }, 200);
}

// === Permission checkbox helpers ===
function highlightPermChange(cb) {
  const roleDefault = cb.dataset.roleDefault === 'true';
  const isModified = cb.checked !== roleDefault;
  const label = cb.closest('label');
  if (label) {
    label.style.color = isModified ? 'var(--accent)' : '';
    label.style.fontWeight = isModified ? '600' : '';
  }
}

function resetPermDefaults() {
  document.querySelectorAll('.perm-cb').forEach(cb => {
    const roleDefault = cb.dataset.roleDefault === 'true';
    cb.checked = roleDefault;
    highlightPermChange(cb);
  });
  toast('–ü—Ä–∞–≤–∞ —Å–±—Ä–æ—à–µ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –¥–ª—è —Ä–æ–ª–∏', 'info');
}

function updatePermDefaultsOnRoleChange(newRole) {
  const roleDefaults = ROLES[newRole] || ROLES['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
  const roleLabel = document.querySelector('#perms-section .form-group > div:first-of-type b, #perms-section div[style*="font-size:11px"] b');
  if (roleLabel) roleLabel.textContent = newRole;
  document.querySelectorAll('.perm-cb').forEach(cb => {
    const key = cb.dataset.perm;
    const newDefault = !!roleDefaults[key];
    cb.dataset.roleDefault = String(newDefault);
    cb.checked = newDefault;
    highlightPermChange(cb);
  });
}

function openAddProjectModal() {
  currentModal = 'newproject';
  document.getElementById('modalTitle').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç';
  document.getElementById('modalBody').innerHTML =
    '<div class="form-group"><label class="required">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label><input type="text" id="field-projname" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç"></div>'+
    '<div class="form-group"><label>Emoji</label><input type="text" id="field-projemoji" placeholder="üè¢" value="üè¢"></div>'+
    '<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="field-projdesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞..."></textarea></div>'+
    '<div class="form-group"><label>–¶–≤–µ—Ç</label><select id="field-projcolor"><option value="var(--accent)">–ó–µ–ª—ë–Ω—ã–π</option><option value="var(--blue)">–°–∏–Ω–∏–π</option><option value="var(--purple)">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option><option value="var(--orange)">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option><option value="var(--pink)">–†–æ–∑–æ–≤—ã–π</option></select></div>';
  document.getElementById('modalOverlay').classList.add('show');
}

function openAddSubproject() {
  const projName = PROJECTS[currentProject]?.name || '';
  const proj = PROJECTS[currentProject];
  
  if (proj && proj.canAddSub) {
    // CRM client form ‚Äî works for –°–∞–π—Ç—ã, AI-–∫–æ–Ω—Ç–µ–Ω—Ç, –ò–ò-–∞–≥–µ–Ω—Ç—ã
    const isSiteProject = (currentProject === 'sites');
    
    // Site type selector (only for –°–∞–π—Ç—ã)
    const typeField = isSiteProject ? `
      <div class="form-group"><label>üåê –¢–∏–ø —Å–∞–π—Ç–∞</label><select id="nc-type">${
        Object.entries(SITE_PRICING).map(([k,v]) => 
          '<option value="'+k+'">'+v.emoji+' '+k+' ‚Äî '+v.price.toLocaleString("ru")+'‚ÇΩ</option>'
        ).join('')
      }</select></div>` : '';
    
    showCustomModal((isSiteProject ? 'üåê' : proj.emoji) + ' –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç ‚Äî ' + projName, `
      <div class="form-group"><label>üìã –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</label><input type="text" id="nc-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞"></div>
      <div class="form-group"><label>üë§ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label><input type="text" id="nc-contact" placeholder="–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞/–º–µ–Ω–µ–¥–∂–µ—Ä–∞"></div>
      <div class="form-group"><label>üì± –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞</label><input type="text" id="nc-phone" placeholder="+7..."></div>
      ${typeField}
      <div class="form-group"><label>üìç –ì–æ—Ä–æ–¥</label><input type="text" id="nc-city" placeholder="–ì–æ—Ä–æ–¥"></div>
      <div class="form-group"><label>üì° –ò—Å—Ç–æ—á–Ω–∏–∫ –ª–∏–¥–∞</label><select id="nc-source">
        <option value="–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã">üó∫Ô∏è –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</option>
        <option value="2–ì–ò–°">üìç 2–ì–ò–°</option>
        <option value="Google Maps">üåê Google Maps</option>
        <option value="Instagram">üì∑ Instagram</option>
        <option value="VK">üí¨ VK</option>
        <option value="–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è">ü§ù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</option>
        <option value="–•–æ–ª–æ–¥–Ω—ã–π –∑–≤–æ–Ω–æ–∫">üìû –•–æ–ª–æ–¥–Ω—ã–π –∑–≤–æ–Ω–æ–∫</option>
        <option value="–ó–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞">üì© –ó–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞</option>
        <option value="Telegram –±–æ—Ç">ü§ñ Telegram –±–æ—Ç</option>
        <option value="–î—Ä—É–≥–æ–µ">üìå –î—Ä—É–≥–æ–µ</option>
      </select></div>
      <div class="form-group" ${isSiteProject ? 'style="display:none"' : ''}><label>üí∞ –¶–µ–Ω–∞ (‚ÇΩ)</label><input type="number" id="nc-price" placeholder="0"></div>
      <div class="form-group"><label>üîó –°—Å—ã–ª–∫–∞ (–∫–∞—Ä—Ç—ã, —Å–æ—Ü—Å–µ—Ç–∏)</label><input type="text" id="nc-link" placeholder="https://..."></div>
      <div class="form-group"><label>üìÖ –ö–æ–≥–¥–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</label><input type="date" id="nc-followup"></div>
      <div class="form-group"><label>üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="nc-desc" rows="2" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ –∫–ª–∏–µ–Ω—Ç—É? –ö–∞–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏?"></textarea></div>
    `, async () => {
      const name = document.getElementById('nc-name').value.trim();
      if (!name) { toast('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','error'); return; }
      
      const city = document.getElementById('nc-city').value.trim();
      const phone = document.getElementById('nc-phone').value.trim();
      const link = document.getElementById('nc-link').value.trim();
      const desc = document.getElementById('nc-desc').value.trim();
      const source = document.getElementById('nc-source').value;
      const contact = document.getElementById('nc-contact').value.trim();
      const followup = document.getElementById('nc-followup').value;
      
      let price = 0;
      let type = '';
      if (isSiteProject) {
        type = document.getElementById('nc-type').value;
        const pricing = SITE_PRICING[type] || SITE_PRICING['–õ–µ–Ω–¥–∏–Ω–≥'];
        price = pricing.price;
      } else {
        price = Number(document.getElementById('nc-price').value) || 0;
      }
      
      // 1. Create direction (client)
      const dirRow = {
        '–ù–∞–∑–≤–∞–Ω–∏–µ': name,
        '–ü—Ä–æ–µ–∫—Ç': projName,
        '–°—Ç–∞—Ç—É—Å': '–í —Ä–∞–±–æ—Ç–µ',
        'stage': 'prospect',
        '–¢–∏–ø —Å–∞–π—Ç–∞': isSiteProject ? type : '',
        '–¶–µ–Ω–∞': price,
        '–û–ø–ª–∞—á–µ–Ω–æ': false,
        '–ö–ª–∏–µ–Ω—Ç': contact || name,
        '–¢–µ–ª–µ—Ñ–æ–Ω': phone,
        '–ì–æ—Ä–æ–¥': city,
        '–°—Å—ã–ª–∫–∞': link,
        '–û–ø–∏—Å–∞–Ω–∏–µ': desc,
        '–ò—Å—Ç–æ—á–Ω–∏–∫': source,
        '–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç': followup || addDays(today(), 1),
        '–ú–µ–Ω–µ–¥–∂–µ—Ä': USER?.name || '',
        '–ö–∞—Å–∞–Ω–∏—è': 0,
        '–°–æ–∑–¥–∞–Ω': today()
      };
      
      const ok1 = await apiWrite('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', dirRow);
      if (!ok1) { toast('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞','error'); return; }
      
      // 2. Auto-create pipeline tasks
      const td = today();
      let tasksList = [];
      if (isSiteProject && typeof SITE_PIPELINE !== 'undefined') {
        tasksList = SITE_PIPELINE.map(step => ({
          '–û–ø–∏—Å–∞–Ω–∏–µ': step.name + ': ' + name,
          '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': name,
          '–ü—Ä–æ–µ–∫—Ç': projName,
          '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': 'P2',
          '–°—Ç–∞—Ç—É—Å': step.step === 1 ? '–í —Ä–∞–±–æ—Ç–µ' : '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
          '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': getSiteStaffByRole(step.role),
          '–î–µ–¥–ª–∞–π–Ω': addDays(td, step.days)
        }));
      } else {
        // Generic first task for non-site CRM projects
        tasksList = [{
          '–û–ø–∏—Å–∞–Ω–∏–µ': 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º: ' + name,
          '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': name,
          '–ü—Ä–æ–µ–∫—Ç': projName,
          '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': 'P2',
          '–°—Ç–∞—Ç—É—Å': '–í —Ä–∞–±–æ—Ç–µ',
          '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': USER?.name || '',
          '–î–µ–¥–ª–∞–π–Ω': addDays(td, 1)
        }];
      }
      
      for (const t of tasksList) {
        await apiWrite('–ó–∞–¥–∞—á–∏', t);
      }
      
      toast('‚úÖ –ö–ª–∏–µ–Ω—Ç ¬´'+name+'¬ª —Å–æ–∑–¥–∞–Ω + '+tasksList.length+' –∑–∞–¥–∞—á','success');
      closeCustomModal();
      await loadData();
      syncSubprojectsFromDb(currentProject);
      renderProjectView();
    });
  } else {
    // Generic ‚Äî open directions modal
    openModal('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
  }
}

function addDays(dateStr, days) {
  const d = new Date(dateStr);
  d.setDate(d.getDate() + days);
  return d.toISOString().split('T')[0];
}

function showCustomModal(title, bodyHtml, onSave) {
  window._customModalSave = onSave;
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyHtml;
  document.getElementById('modalSaveBtn').onclick = () => { if(window._customModalSave) window._customModalSave(); };
  document.getElementById('modalOverlay').classList.add('show');
}

function closeCustomModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  window._customModalSave = null;
}


function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  document.getElementById('modalBox').classList.remove('wide');
  currentModal = '';
  editingItem = null;
}

// Send Telegram notification when task is assigned to staff
async function notifyTaskAssigned(taskDesc, assigneeName, direction) {
  addNotification('–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞: ' + taskDesc + ' ‚Üí ' + assigneeName, 'task');
  if (!assigneeName) return;
  // Find staff member's telegram_id
  const staff = DATA.staff.find(s => (s['–ò–º—è']||'').includes(assigneeName) || (assigneeName||'').includes(s['–ò–º—è']||'___'));
  if (!staff) return;
  const tgId = staff['Telegram_ID'] || staff.telegram_id;
  if (!tgId) return;
  
  try {
    await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'notify',
        source: 'web',
        chatId: tgId,
        message: 'üìã *–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞!*\n\n' + taskDesc + '\nüìÅ ' + (direction||'') + '\nüë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ' + assigneeName + '\n\nüåê –û—Ç–∫—Ä–æ–π—Ç–µ RKT HUB –¥–ª—è –¥–µ—Ç–∞–ª–µ–π'
      })
    });
  } catch(e) { console.warn('Notification failed:', e); }
}

async function saveModal() {
  // Handle new project
  if (currentModal === 'newproject') {
    const name = document.getElementById('field-projname').value.trim();
    if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }
    const key = name.toLowerCase().replace(/[^a-z–∞-—è—ë0-9]/gi,'_');
    const emoji = document.getElementById('field-projemoji').value.trim() || 'üìÅ';
    const desc = document.getElementById('field-projdesc').value.trim();
    const color = document.getElementById('field-projcolor').value;

    PROJECTS[key] = {
      name: name, emoji: emoji, color: color,
      gradient: 'linear-gradient(90deg, '+color+', '+color+')',
      desc: desc, subprojects: {}, canAddSub: true
    };
    closeModal();
    renderAll();
    toast('‚úÖ –ü—Ä–æ–µ–∫—Ç ¬´'+name+'¬ª —Å–æ–∑–¥–∞–Ω!','success');
    return;
  }

  // Handle new subproject
  if (currentModal === 'newsubproject') {
    const name = document.getElementById('field-subname').value.trim();
    if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }
    const emoji = document.getElementById('field-subemoji').value.trim() || 'üìå';
    const desc = document.getElementById('field-subdesc').value.trim();
    const proj = PROJECTS[currentProject];
    if (!proj) return;

    proj.subprojects[name] = { emoji: emoji, color: proj.color, desc: desc };

    // If site project, save extra questionnaire fields
    if (proj.canAddSub) {
      const url = document.getElementById('field-suburl')?.value || '';
      const client = document.getElementById('field-subclient')?.value || '';
      const phone = document.getElementById('field-subphone')?.value || '';
      const bizname = document.getElementById('field-subbizname')?.value || '';
      const biztype = document.getElementById('field-subbiztype')?.value || '';
      const email = document.getElementById('field-subemail')?.value || '';
      const city = document.getElementById('field-subcity')?.value || '';
      const style = document.getElementById('field-substyle')?.value || '';
      const colors = document.getElementById('field-subcolors')?.value || '';
      const pages = document.getElementById('field-subpages')?.value || '';
      const wishes = document.getElementById('field-subwishes')?.value || '';
      const domain = document.getElementById('field-subdomain')?.value || '';
      const budget = document.getElementById('field-subbudget')?.value || '';
      const deadline = document.getElementById('field-subdeadline')?.value || '';
      const content = document.getElementById('field-subcontent')?.value || '';
      const siteType = document.getElementById('field-subsitetype')?.value || '–õ–µ–Ω–¥–∏–Ω–≥';
      const pricing = SITE_PRICING[siteType] || SITE_PRICING['–õ–µ–Ω–¥–∏–Ω–≥'];

      // Build questionnaire JSON for AI
      const questionnaire = JSON.stringify({
        bizname, biztype, client, phone, email, city,
        style, colors, pages, wishes, domain, budget, deadline, content, url, siteType
      }).substring(0, 900);

      await apiWrite('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', {
        ID: 'DIR'+String(Date.now()).slice(-6),
        '–ù–∞–∑–≤–∞–Ω–∏–µ': name,
        '–ü—Ä–æ–µ–∫—Ç': proj.name,
        '–û–ø–∏—Å–∞–Ω–∏–µ': desc,
        '–°—Å—ã–ª–∫–∞': url,
        '–ö–ª–∏–µ–Ω—Ç': client,
        '–¢–µ–ª–µ—Ñ–æ–Ω': phone,
        '–ì–æ—Ä–æ–¥': city,
        '–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞': biztype,
        '–¢–∏–ø —Å–∞–π—Ç–∞': siteType,
        '–¶–µ–Ω–∞': String(pricing.price),
        '–°—Ç–∏–ª—å': style,
        '–ê–Ω–∫–µ—Ç–∞': questionnaire,
        'stage': 'prospect',
        '–ú–µ–Ω–µ–¥–∂–µ—Ä': USER?.name || '',
        '–°—Ç–∞—Ç—É—Å': '–í —Ä–∞–±–æ—Ç–µ'
      });
    }

    document.getElementById('modalBox').classList.remove('wide');
    closeModal();
    renderAll();
    if(currentProject) renderProjectView();
    toast('‚úÖ –ü–æ–¥–ø—Ä–æ–µ–∫—Ç ¬´'+name+'¬ª –¥–æ–±–∞–≤–ª–µ–Ω!','success');

    // Notify managers about new client in pipeline
    if (PROJECTS[currentProject] && PROJECTS[currentProject].canAddSub) {
      notifyStaffByRole(PROJECTS[currentProject].name, '–ú–µ–Ω–µ–¥–∂–µ—Ä',
        'üÜï *–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –≤ –≤–æ—Ä–æ–Ω–∫–µ!*\n\n' +
        'üè™ ' + name + '\n' +
        'üë§ –î–æ–±–∞–≤–∏–ª: ' + (USER?.name||'') + '\n' +
        '\nüåê –û—Ç–∫—Ä–æ–π—Ç–µ RKT HUB –¥–ª—è –¥–µ—Ç–∞–ª–µ–π'
      );
    }

    // Auto-create pipeline tasks for site projects with role-based assignment
    if (PROJECTS[currentProject] && PROJECTS[currentProject].canAddSub) {
      const td = today();
      for (const step of SITE_PIPELINE) {
        const assigned = getSiteStaffByRole(step.role);
        const dl = new Date(); dl.setDate(dl.getDate() + step.days);
        apiWrite('–ó–∞–¥–∞—á–∏', {
          ID: 'T'+String(Date.now()).slice(-6)+String(Math.random()).slice(2,4),
          '–û–ø–∏—Å–∞–Ω–∏–µ': step.name + ' –¥–ª—è ¬´'+name+'¬ª',
          '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': name,
          '–ü—Ä–æ–µ–∫—Ç': PROJECTS[currentProject].name,
          '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': step.step <= 3 ? 'P1' : (step.step <= 6 ? 'P2' : 'P3'),
          '–°—Ç–∞—Ç—É—Å': step.step === 1 ? '–í —Ä–∞–±–æ—Ç–µ' : '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
          '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': assigned,
          '–î–µ–¥–ª–∞–π–Ω': dl.toISOString().split('T')[0],
          '–°–æ–∑–¥–∞–Ω–æ': td
        });
      }
      toast('üìã –°–æ–∑–¥–∞–Ω–æ '+SITE_PIPELINE.length+' –∑–∞–¥–∞—á –¥–ª—è ¬´'+name+'¬ª —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è–º–∏', 'info');
      // Notify all assigned staff
      for (const step of SITE_PIPELINE) {
        const assigned = getSiteStaffByRole(step.role);
        if (assigned) notifyTaskAssigned(step.name + ' –¥–ª—è ¬´'+name+'¬ª', assigned, name);
      }
    }
    return;
  }

  // Standard form save
  const def = FORM_DEFS[currentModal];
  if(!def) return;

  for (const field of def.fields) {
    if (field.required) {
      const el = document.getElementById('field-'+field.name);
      if(!el||!el.value.trim()) { toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ¬´'+field.name+'¬ª','warning'); if(el)el.focus(); return; }
    }
  }

  const row = {};
  row.ID = editingItem ? editingItem.ID : currentModal.charAt(0).toUpperCase()+String(Date.now()).slice(-6);

  for (const field of def.fields) {
    const el = document.getElementById('field-'+field.name);
    let val = el ? el.value : '';
    // Sanitize number fields: empty ‚Üí null, otherwise parseInt
    if (field.type === 'number') {
      val = (val === '' || val === null || val === undefined) ? null : parseInt(val, 10);
      if (val !== null && isNaN(val)) val = null;
    }
    // Sanitize optional text fields: empty ‚Üí null (Supabase UNIQUE constraint fix)
    if (field.type !== 'number' && !field.required) {
      val = (val && String(val).trim()) ? String(val).trim() : null;
    }
    row[field.name] = val;
  }

  // Collect extra_projects checkboxes for staff
  if (currentModal === 'staff') {
    const cbs = document.querySelectorAll('.extra-proj-cb');
    if (cbs.length) {
      const selected = [];
      cbs.forEach(cb => { if (cb.checked) selected.push(cb.value); });
      row['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] = JSON.stringify(selected);
    }
    // Collect individual permission overrides
    const permCbs = document.querySelectorAll('.perm-cb');
    if (permCbs.length) {
      const role = row['–†–æ–ª—å'] || (editingItem && editingItem['–†–æ–ª—å']) || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
      const roleDefaults = ROLES[role] || ROLES['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
      const overrides = {};
      permCbs.forEach(cb => {
        const key = cb.dataset.perm;
        const roleVal = !!roleDefaults[key];
        if (cb.checked !== roleVal) {
          overrides[key] = cb.checked;
        }
      });
      row['–ü—Ä–∞–≤–∞'] = Object.keys(overrides).length ? JSON.stringify(overrides) : null;
    }
  }

  const td = today();
  if(def.sheet==='–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏'&&!editingItem) {
    row['–°—Ç–∞—Ç—É—Å']='–ê–∫—Ç–∏–≤–Ω—ã–π'; row['–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è']=td;
    // Set default salary_pct based on role if not explicitly set
    if (row['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü'] === null || row['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü'] === undefined || row['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü'] === '' || row['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü'] === 0) {
      row['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü'] = DEFAULT_SALARY_PCT[row['–†–æ–ª—å']] || 0;
    }
  }
  if(def.sheet==='–ü—Ä–æ–µ–∫—Ç—ã') { if(!editingItem) row['–°–æ–∑–¥–∞–Ω–æ']=td; row['–û–±–Ω–æ–≤–ª–µ–Ω–æ']=td; }
  if(def.sheet==='–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'&&!editingItem) { row['–î–∞—Ç–∞']=td; row['–ê–≤—Ç–æ—Ä']=USER?USER.name:''; }

  const perms = getUserPerms();
  const writeAccess = canDirectWrite(def.sheet);

  // Allow CEO to write directly; for staff sheet, allow self-registration for guests
  if (writeAccess === 'denied' && def.sheet !== '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏') {
    toast('‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ ¬´'+def.sheet+'¬ª','error');
    return;
  }
  // If denied for staff but user is not logged in, allow as approval request
  if (writeAccess === 'denied' && def.sheet === '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏') {
    // Self-register: write directly (will be inactive until CEO approves)
    row['–°—Ç–∞—Ç—É—Å'] = '–û–∂–∏–¥–∞–µ—Ç';
    document.getElementById('modalSaveBtn').disabled = true;
    const ok = await apiWrite('–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', row);
    document.getElementById('modalSaveBtn').disabled = false;
    if(ok) toast('‚è≥ –ó–∞—è–≤–∫–∞ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. CEO –¥–æ–ª–∂–µ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å.','info');
    closeModal();
    debouncedLoadData();
    return;
  }

  if (writeAccess === 'approval') {
    const approvalRow = {
      ID: 'APR'+String(Date.now()).slice(-6),
      '–¢–∏–ø': (editingItem ? '–ò–∑–º–µ–Ω–µ–Ω–∏–µ' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ') + ': '+def.title,
      '–û–ø–∏—Å–∞–Ω–∏–µ': row['–ù–∞–∑–≤–∞–Ω–∏–µ']||row['–û–ø–∏—Å–∞–Ω–∏–µ']||row['–ò–º—è']||row['–ü–∞—Ä—Ç–Ω—ë—Ä']||'',
      '–û—Ç_–∫–æ–≥–æ': USER?USER.name:'',
      '–†–æ–ª—å': USER?USER.role:'',
      'Telegram_ID': USER?USER.tgId:'',
      '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'',
      '–ü—Ä–æ–µ–∫—Ç': row['–ü—Ä–æ–µ–∫—Ç']||'',
      '–õ–∏—Å—Ç': def.sheet,
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
      '–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞': td,
      '–î–∞–Ω–Ω—ã–µ': JSON.stringify(row).substring(0,900)
    };
    document.getElementById('modalSaveBtn').disabled = true;
    const ok = await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', approvalRow);
    document.getElementById('modalSaveBtn').disabled = false;
    if(ok) {
      toast('‚è≥ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ CEO','info');
      notifyCEO('üì¨ *–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ*\n\n' +
        'üìã ' + (approvalRow['–¢–∏–ø']||'') + ': ' + (approvalRow['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + '\n' +
        'üë§ –û—Ç: ' + (approvalRow['–û—Ç_–∫–æ–≥–æ']||'') + '\n' +
        'üìÅ ' + (approvalRow['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    }
    closeModal();
    debouncedLoadData();
    return;
  }

  // Direct write
  document.getElementById('modalSaveBtn').disabled = true;
  const ok = await apiWrite(def.sheet, row);
  document.getElementById('modalSaveBtn').disabled = false;
  if(ok) {
    toast('‚úÖ '+def.title+' —Å–æ—Ö—Ä–∞–Ω—ë–Ω!','success');
    // Notify assignee if task created/assigned
    if (def.sheet === '–ó–∞–¥–∞—á–∏' && row['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] && !editingItem) {
      notifyTaskAssigned(row['–û–ø–∏—Å–∞–Ω–∏–µ']||row['–ù–∞–∑–≤–∞–Ω–∏–µ']||'', row['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'], row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']);
    }
    // Notify assignee if task status changed (editing existing task)
    if (def.sheet === '–ó–∞–¥–∞—á–∏' && editingItem && editingItem['–°—Ç–∞—Ç—É—Å'] !== row['–°—Ç–∞—Ç—É—Å']) {
      notifyTaskStatusChange(row, editingItem['–°—Ç–∞—Ç—É—Å'], row['–°—Ç–∞—Ç—É—Å']);
    }
    // Notify CEO about new approval requests
    if (def.sheet === '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è') {
      notifyCEO('üì¨ *–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ*\n\n' +
        'üìã ' + (row['–û–ø–∏—Å–∞–Ω–∏–µ']||row['–¢–∏–ø']||'') + '\n' +
        'üë§ –û—Ç: ' + (row['–û—Ç_–∫–æ–≥–æ']||'') + '\n' +
        'üìÅ ' + (row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    }
  }

  // Auto-delegation: if task in CRM project is marked done, create next step
  if (def.sheet === '–ó–∞–¥–∞—á–∏' && (row['–°—Ç–∞—Ç—É—Å'] === '–ì–æ—Ç–æ–≤–æ' || row['–°—Ç–∞—Ç—É—Å'] === '‚úÖ –ì–æ—Ç–æ–≤–æ') && PROJECTS[Object.keys(PROJECTS).find(k => PROJECTS[k].name === row['–ü—Ä–æ–µ–∫—Ç'])]?.canAddSub) {
    await autoDelegate(row);
  }
  
  closeModal();
  debouncedLoadData();
}

// ============================================================
// AUTO-DELEGATION: When a pipeline task is done, create next step
// ============================================================
async function autoDelegate(completedTask) {
  const desc = completedTask['–û–ø–∏—Å–∞–Ω–∏–µ'] || completedTask['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';
  const direction = completedTask['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
  
  // Find which pipeline step was completed
  let currentStep = -1;
  SITE_PIPELINE.forEach((p, i) => {
    const keywords = p.name.replace(/[^\w–∞-—è—ë]/gi, ' ').toLowerCase().split(/\s+/).filter(w => w.length > 3);
    if (keywords.some(k => desc.toLowerCase().includes(k))) currentStep = i;
  });
  
  if (currentStep < 0 || currentStep >= SITE_PIPELINE.length - 1) return;
  
  const nextStep = SITE_PIPELINE[currentStep + 1];
  const assigned = getSiteStaffByRole(nextStep.role);
  
  const dl = new Date();
  dl.setDate(dl.getDate() + (nextStep.days - SITE_PIPELINE[currentStep].days));
  
  const nextTask = {
    ID: 'T' + String(Date.now()).slice(-6) + String(Math.random()).slice(2,4),
    '–û–ø–∏—Å–∞–Ω–∏–µ': nextStep.name + ' –¥–ª—è ¬´' + direction + '¬ª',
    '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': direction,
    '–ü—Ä–æ–µ–∫—Ç': '–°–∞–π—Ç—ã',
    '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': currentStep < 3 ? 'P1' : 'P2',
    '–°—Ç–∞—Ç—É—Å': '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
    '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': assigned,
    '–î–µ–¥–ª–∞–π–Ω': dl.toISOString().split('T')[0],
    '–°–æ–∑–¥–∞–Ω–æ': today()
  };
  
  await apiWrite('–ó–∞–¥–∞—á–∏', nextTask);
  // Notify assignee about delegated task via Telegram
  if (assigned) notifyTaskAssigned(nextStep.name + ' –¥–ª—è ¬´' + direction + '¬ª', assigned, direction);
  toast('üîÑ –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–æ: ' + nextStep.name + ' ‚Üí ' + assigned, 'info');
  
  // If next step needs CEO approval (step 9), create approval
  if (nextStep.role === 'CEO') {
    await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', {
      ID: 'APR' + String(Date.now()).slice(-6),
      '–¢–∏–ø': '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å–¥–∞—á–∏',
      '–û–ø–∏—Å–∞–Ω–∏–µ': '–°–¥–∞—á–∞ –ø—Ä–æ–µ–∫—Ç–∞ ¬´' + direction + '¬ª',
      '–û—Ç_–∫–æ–≥–æ': completedTask['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] || '',
      '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': direction,
      '–ü—Ä–æ–µ–∫—Ç': '–°–∞–π—Ç—ã',
      '–õ–∏—Å—Ç': '–ó–∞–¥–∞—á–∏',
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
      '–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞': today()
    });
    toast('üëë –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ CEO –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'info');
  }
}

// ============================================================
// VIEW / EDIT / DELETE
// ============================================================
function viewItem(type, id) {
  if (type === 'partner') { openPartnerDetail(id); return; }
  const map = {partner:'partners',project:'projects',task:'tasks',staff:'staff',comm:'comms'};
  const item = DATA[map[type]]?.find(i => i.ID===id);
  if(!item) return;

  document.getElementById('detailTitle').textContent = 'üìã '+(item['–ù–∞–∑–≤–∞–Ω–∏–µ']||item['–û–ø–∏—Å–∞–Ω–∏–µ']||item['–ò–º—è']||item['–ü–∞—Ä—Ç–Ω—ë—Ä']||'–î–µ—Ç–∞–ª–∏');

  const fields = Object.entries(item).filter(([k])=>k!=='row_number');
  let html = '<div class="detail-grid">';
  for (const [k,v] of fields) {
    if(!v&&v!==0) continue;
    const long = String(v).length > 60;
    html += '<div class="detail-item '+(long?'detail-full':'')+'"><div class="detail-label">'+esc(k)+'</div><div class="detail-value">'+esc(v)+'</div></div>';
  }
  html += '</div>';
  document.getElementById('detailBody').innerHTML = html;
  document.getElementById('detailEditBtn').onclick = function() { closeDetail(); editItem(type,id); };
  document.getElementById('detailOverlay').classList.add('show');
}

function closeDetail() { document.getElementById('detailOverlay').classList.remove('show'); }

function openPartnerDetail(id) {
  const p = (DATA.partners||[]).find(i => i.ID===id);
  if(!p) { toast('–ü–∞—Ä—Ç–Ω—ë—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
  
  const perms = getUserPerms();
  const pName = p['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?';
  const relComms = (DATA.comms||[]).filter(c => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'') === pName);
  const relTasks = (DATA.tasks||[]).filter(t => {
    const dir = t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
    const pDir = p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
    return pDir && dir.toLowerCase().includes(pDir.toLowerCase());
  });
  
  let bc = '<a onclick="showPage(\'home\')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a><span class="sep">‚Ä∫</span>';
  bc += '<a onclick="showPage(\'partners\')">–ü–∞—Ä—Ç–Ω—ë—Ä—ã</a><span class="sep">‚Ä∫</span>';
  bc += '<span class="current">'+esc(pName)+'</span>';
  
  let html = '<div class="breadcrumb">'+bc+'</div>';
  html += '<div class="page-header" style="margin-bottom:20px"><h2>ü§ù '+esc(pName)+'</h2>';
  html += '<div class="actions">';
  html += '<button class="btn btn-primary" onclick="editItem(\'partner\',\''+escA(id)+'\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>';
  if (perms.canDelete) html += ' <button class="btn btn-danger" onclick="confirmDelete(\'partner\',\''+escA(id)+'\',\''+escA(pName)+'\')">üóë –£–¥–∞–ª–∏—Ç—å</button>';
  html += '</div></div>';
  
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:20px">';
  
  // Info card
  html += '<div class="card"><div class="card-header"><h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3></div>';
  html += '<div style="padding:16px;display:grid;gap:10px">';
  const fields = [
    ['üè¢ –ù–∞–∑–≤–∞–Ω–∏–µ', p['–ù–∞–∑–≤–∞–Ω–∏–µ']],['üåç –°—Ç—Ä–∞–Ω–∞', p['–°—Ç—Ä–∞–Ω–∞']],['üìÇ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']],
    ['üì¶ –ü—Ä–æ–¥—É–∫—Ç', p['–ü—Ä–æ–¥—É–∫—Ç']],['üìä –°—Ç–∞—Ç—É—Å', p['–°—Ç–∞—Ç—É—Å']],['üë§ –ö–æ–Ω—Ç–∞–∫—Ç', p['–ö–æ–Ω—Ç–∞–∫—Ç']],
    ['üìß Email', p['Email']],['üì± –¢–µ–ª–µ—Ñ–æ–Ω', p['–¢–µ–ª–µ—Ñ–æ–Ω']],['üîó –°–∞–π—Ç', p['–°–∞–π—Ç']]
  ];
  fields.forEach(([label, val]) => {
    if(val) {
      const isLink = String(val).startsWith('http');
      html += '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">';
      html += '<span style="color:var(--text2);font-size:13px">'+label+'</span>';
      html += '<span style="font-weight:600">'+(isLink?'<a href="'+esc(val)+'" target="_blank" style="color:var(--accent)">'+esc(val)+'</a>':esc(val))+'</span>';
      html += '</div>';
    }
  });
  if(p['–û–ø–∏—Å–∞–Ω–∏–µ']) html += '<div style="padding:8px 0"><span style="color:var(--text2);font-size:13px">üìù –û–ø–∏—Å–∞–Ω–∏–µ</span><p style="margin-top:6px">'+esc(p['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</p></div>';
  html += '</div></div>';
  
  // Stats
  html += '<div class="card"><div class="card-header"><h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3></div>';
  html += '<div style="padding:16px;display:grid;gap:16px;text-align:center;grid-template-columns:1fr 1fr">';
  html += '<div><div style="font-size:28px;font-weight:700">'+relComms.length+'</div><div style="font-size:12px;color:var(--text2)">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π</div></div>';
  html += '<div><div style="font-size:28px;font-weight:700">'+relTasks.length+'</div><div style="font-size:12px;color:var(--text2)">–ó–∞–¥–∞—á</div></div>';
  html += '</div></div>';
  html += '</div>';
  
  // Communications table
  html += '<div class="card"><div class="card-header"><h3>üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h3>';
  html += '<button class="btn btn-sm btn-primary" onclick="openModal(\'comm\',{\'–ü–∞—Ä—Ç–Ω—ë—Ä\':\''+escA(pName)+'\'})">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>';
  if(relComms.length) {
    html += '<div class="table-wrap"><table><thead><tr><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–î–∞—Ç–∞</th></tr></thead><tbody>';
    relComms.forEach(c => {
      html += '<tr><td>'+esc(c['–¢–∏–ø']||'')+'</td><td>'+esc(c['–¢–µ–º–∞']||'')+'</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">'+esc(c['–†–µ–∑—É–ª—å—Ç–∞—Ç']||'')+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td></tr>';
    });
    html += '</tbody></table></div>';
  } else {
    html += '<div style="padding:32px;text-align:center;color:var(--text2)">üì≠ –ù–µ—Ç –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π</div>';
  }
  html += '</div>';
  
  // Related tasks
  if(relTasks.length) {
    html += '<div class="card"><div class="card-header"><h3>‚úÖ –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3></div>';
    html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
    relTasks.forEach(t => {
      html += '<tr style="cursor:pointer" onclick="openTaskDetail(\''+escA(t.ID)+'\')"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>';
    });
    html += '</tbody></table></div></div>';
  }
  
  const container = document.getElementById('page-home');
  container.innerHTML = html;
  currentPage = 'partner-detail';
  document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
  container.classList.add('active');
}

function editItem(type, id) {
  const map = {partner:'partners',project:'projects',task:'tasks',staff:'staff',comm:'comms'};
  const item = DATA[map[type]]?.find(i => i.ID===id);
  if(item) openModal(type, item);
}

function confirmDelete(type, id, name) {
  if(!getUserPerms().canDelete) { toast('‚õî –¢–æ–ª—å–∫–æ CEO','error'); return; }
  const isDirection = (type === 'direction');
  const isProject = (type === 'project');
  document.getElementById('confirmTitle').textContent = isDirection ? 'üóë –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?' : isProject ? 'üóë –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?' : '–£–¥–∞–ª–∏—Ç—å?';
  document.getElementById('confirmText').textContent = isDirection
    ? '–ö–ª–∏–µ–Ω—Ç ¬´'+(name||id)+'¬ª –∏ –≤—Å–µ –µ–≥–æ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.'
    : isProject
    ? '–ü—Ä–æ–µ–∫—Ç ¬´'+(name||id)+'¬ª –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.'
    : '¬´'+(name||id)+'¬ª –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.';
  document.getElementById('confirmOverlay').classList.add('show');
  confirmCallback = async function(ok) {
    if(ok) {
      const sheetMap = {partner:'–ü–∞—Ä—Ç–Ω—ë—Ä—ã',task:'–ó–∞–¥–∞—á–∏',staff:'–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',comm:'–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏',direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è',project:'–ü—Ä–æ–µ–∫—Ç—ã'};
      const tableMap = {partner:'partners',task:'tasks',staff:'staff',comm:'communications',direction:'directions',project:'projects'};
      const dataMap = {partner:'partners',task:'tasks',staff:'staff',comm:'comms',direction:'directions',project:'projects'};
      try {
        const table = tableMap[type];
        if (table) {
          // Cascade delete for directions: delete related tasks first
          if (isDirection && name) {
            const relatedTasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === name);
            for (const t of relatedTasks) {
              const taskId = t['ID'] || t.id;
              if (taskId) {
                try { await SB.from('tasks').delete().eq('id', taskId); } catch(te) { console.warn('Task delete err:', te); }
              }
            }
            if (typeof siteGenCache !== 'undefined') delete siteGenCache[name];
          }
          // Cascade delete for projects: delete related tasks and directions
          if (isProject && name) {
            const relatedDirs = (DATA.directions||[]).filter(d => (d['–ü—Ä–æ–µ–∫—Ç']||'') === name);
            const relatedTasks = (DATA.tasks||[]).filter(t => (t['–ü—Ä–æ–µ–∫—Ç']||'') === name);
            for (const t of relatedTasks) {
              const taskId = t['ID'] || t.id;
              if (taskId) { try { await SB.from('tasks').delete().eq('id', taskId); } catch(e) {} }
            }
            for (const d of relatedDirs) {
              const dirId = d['ID'] || d.id;
              if (dirId) { try { await SB.from('directions').delete().eq('id', dirId); } catch(e) {} }
            }
          }
          await SB.from(table).delete().eq('id', id);
        }
      } catch(e) {
        console.error('Delete error:', e);
        if (sheetMap[type]) {
          await apiWrite(sheetMap[type], { ID: id, '–°—Ç–∞—Ç—É—Å': '‚ùå –£–¥–∞–ª—ë–Ω' }, 'update');
        }
      }
      // Remove from local data
      if(DATA[dataMap[type]]) DATA[dataMap[type]] = DATA[dataMap[type]].filter(i=>(i.ID||i.id)!==id);
      if (isDirection && name) {
        DATA.tasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') !== name);
      }
      if (isProject && name) {
        DATA.tasks = (DATA.tasks||[]).filter(t => (t['–ü—Ä–æ–µ–∫—Ç']||'') !== name);
        DATA.directions = (DATA.directions||[]).filter(d => (d['–ü—Ä–æ–µ–∫—Ç']||'') !== name);
      }
      if (isDirection && currentDealId === id) closeSlideOver();
      renderAll();
      toast('üóë –£–¥–∞–ª–µ–Ω–æ','warning');
      debouncedLoadData();
    }
  };
}

function closeConfirm(r) {
  document.getElementById('confirmOverlay').classList.remove('show');
  if(confirmCallback) { confirmCallback(r); confirmCallback=null; }
}

// ============================================================
// APPROVALS
// ============================================================
async function handleApproval(id, approved) {
  const item = DATA.approvals.find(a=>a.ID===id);
  if(!item) return;
  item['–°—Ç–∞—Ç—É—Å'] = approved?'‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ':'‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
  item['–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è'] = today();
  item['–†–µ—à–µ–Ω–∏–µ_CEO'] = USER?USER.name:'';
  await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', item);

  // If approved and has data ‚Äî write to target sheet
  if (approved && item['–î–∞–Ω–Ω—ã–µ'] && item['–õ–∏—Å—Ç']) {
    try {
      const rowData = JSON.parse(item['–î–∞–Ω–Ω—ã–µ']);
      // For staff approvals: set status to Active and update existing record
      if (item['–õ–∏—Å—Ç'] === '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏' && (rowData.ID || rowData.id)) {
        rowData['–°—Ç–∞—Ç—É—Å'] = '–ê–∫—Ç–∏–≤–Ω—ã–π';
        await SB.from('staff').update({ status: '–ê–∫—Ç–∏–≤–Ω—ã–π', role: rowData['–†–æ–ª—å'] || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫' }).eq('id', rowData.ID || rowData.id);
      } else {
        await apiWrite(item['–õ–∏—Å—Ç'], rowData);
      }
      toast('‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ –∏ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ ¬´'+item['–õ–∏—Å—Ç']+'¬ª','success');
      
      // Send Telegram notification to the applicant
      if (rowData['Telegram_ID'] || rowData.Telegram_ID) {
        const tgId = rowData['Telegram_ID'] || rowData.Telegram_ID;
        const msg = approved 
          ? '‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!\n\nüë§ ' + (rowData['–ò–º—è']||'') + '\nüìã –†–æ–ª—å: ' + (rowData['–†–æ–ª—å']||'–°–æ—Ç—Ä—É–¥–Ω–∏–∫') + '\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É RKT Hub –ø–æ —Å–≤–æ–µ–º—É Telegram ID.'
          : '‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.\n\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è.';
        sendTelegramNotification(tgId, msg);
      }
    } catch(e) {
      toast('‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ (–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã)','success');
    }
  } else if (!approved && item['–õ–∏—Å—Ç'] === '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏' && item['–î–∞–Ω–Ω—ã–µ']) {
    // Rejected staff registration ‚Äî disable the account
    try {
      const rowData = JSON.parse(item['–î–∞–Ω–Ω—ã–µ']);
      if (rowData.ID || rowData.id) {
        await SB.from('staff').update({ status: '–û—Ç–∫–ª—é—á—ë–Ω' }).eq('id', rowData.ID || rowData.id);
      }
    } catch(e) { console.warn('Failed to disable rejected staff:', e); }
    toast('‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ ‚Äî –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'error');
  } else {
    toast(approved?'‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ':'‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ', approved?'success':'error');
  }
  renderAll();
  debouncedLoadData();
}

// Send Telegram notification ‚Äî tries direct Bot API first, then n8n webhook fallback
async function sendTelegramNotification(chatId, message) {
  if (!chatId) return;
  // Try 1: Direct Telegram Bot API (fastest, no middleman)
  const botToken = CONFIG.TG_BOT_TOKEN;
  if (botToken) {
    try {
      const r = await fetch('https://api.telegram.org/bot' + botToken + '/sendMessage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: String(chatId), text: message, parse_mode: 'Markdown' })
      });
      if (r.ok) return; // success
    } catch(e) { console.warn('Direct TG failed, trying webhook:', e); }
  }
  // Try 2: n8n webhook (fallback)
  try {
    await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'telegram_notify',
        chat_id: String(chatId),
        message: message,
        source: 'web'
      })
    });
  } catch(e) {
    console.log('TG notification failed:', e);
  }
}

// Notify a specific staff member by name
async function notifyStaffByName(staffName, message) {
  if (!staffName) return;
  const s = (DATA.staff||[]).find(st => (st['–ò–º—è']||'') === staffName || (staffName||'').includes(st['–ò–º—è']||'___'));
  if (!s) return;
  const tgId = s['Telegram_ID'] || s.telegram_id;
  if (tgId) sendTelegramNotification(tgId, message);
}

// Notify all staff with a given role in a project
async function notifyStaffByRole(projectName, role, message) {
  const matches = (DATA.staff||[]).filter(s =>
    s['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π' &&
    (s['–ü—Ä–æ–µ–∫—Ç'] === projectName || s['–ü—Ä–æ–µ–∫—Ç'] === '–í—Å–µ') &&
    s['–†–æ–ª—å'] === role
  );
  for (const s of matches) {
    const tgId = s['Telegram_ID'] || s.telegram_id;
    if (tgId) sendTelegramNotification(tgId, message);
  }
}

// Notify CEO about important events
async function notifyCEO(message) {
  const ceo = (DATA.staff||[]).find(s => s['–†–æ–ª—å'] === 'CEO' && s['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π');
  if (ceo) {
    const tgId = ceo['Telegram_ID'] || ceo.telegram_id;
    if (tgId) sendTelegramNotification(tgId, message);
  }
}

// Notify CEO + –ó–∞–º (leadership) about important events
async function notifyLeadership(message) {
  const staff = DATA.staff || _staffCache || [];
  const leaders = staff.filter(s => {
    const r = normalizeRole(s['–†–æ–ª—å'] || s.role || '');
    return (r === 'CEO' || r === '–ó–∞–º') && (s['–°—Ç–∞—Ç—É—Å'] || s.status || '–ê–∫—Ç–∏–≤–Ω—ã–π') === '–ê–∫—Ç–∏–≤–Ω—ã–π';
  });
  for (const s of leaders) {
    const tgId = s['Telegram_ID'] || s.telegram_id;
    if (tgId) sendTelegramNotification(tgId, message);
  }
}

// Notify on task status change
async function notifyTaskStatusChange(task, oldStatus, newStatus) {
  const assignee = task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'];
  if (!assignee) return;
  // Don't notify if the user changed their own task
  if (USER && assignee === USER.name) return;
  const msg = 'üîÑ *–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –∏–∑–º–µ–Ω—ë–Ω*\n\n' +
    'üìã ' + (task['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + '\n' +
    'üìÅ ' + (task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') + '\n' +
    '‚ùå –ë—ã–ª–æ: ' + (oldStatus||'‚Äî') + '\n' +
    '‚úÖ –°—Ç–∞–ª–æ: ' + newStatus + '\n' +
    (USER ? '\nüë§ –ò–∑–º–µ–Ω–∏–ª: ' + USER.name : '');
  notifyStaffByName(assignee, msg);
}

// Check deadlines and send reminders ‚Äî ONCE PER DAY, batched by staff member
function checkDeadlines() {
  // Dedup: only send once per day (even if multiple users open CRM)
  const todayKey = 'rkt_deadline_sent_' + today();
  if (localStorage.getItem(todayKey)) return;

  const td = today();
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split('T')[0];

  // Collect all notifications, group by staff member
  const notifications = {}; // { staffName: [msg1, msg2, ...] }

  (DATA.tasks||[]).forEach(t => {
    const dl = t['–î–µ–¥–ª–∞–π–Ω'];
    const status = t['–°—Ç–∞—Ç—É—Å'] || '';
    const assignee = t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'];
    if (!dl || !assignee || status === '–ì–æ—Ç–æ–≤–æ' || status.includes('–ì–æ—Ç–æ–≤–æ')) return;

    let msg = '';
    if (dl === tomorrowStr) {
      msg = '‚è∞ –î–µ–¥–ª–∞–π–Ω –∑–∞–≤—Ç—Ä–∞: ' + (t['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + ' (' + (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') + ', —Å—Ä–æ–∫: ' + dl + ')';
    } else if (dl < td) {
      msg = 'üö® –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: ' + (t['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + ' (' + (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') + ', –±—ã–ª —Å—Ä–æ–∫: ' + dl + ')';
    }
    if (msg) {
      if (!notifications[assignee]) notifications[assignee] = [];
      notifications[assignee].push(msg);
    }
  });

  // Send ONE combined message per staff member, sequentially with 2s delays
  const entries = Object.entries(notifications);
  if (!entries.length) return;

  // Mark as sent TODAY ‚Äî prevents duplicate sends from other users/tabs
  localStorage.setItem(todayKey, String(Date.now()));
  // Clean up old keys (older than 3 days)
  for (let i = localStorage.length - 1; i >= 0; i--) {
    const k = localStorage.key(i);
    if (k && k.startsWith('rkt_deadline_sent_') && k !== todayKey) localStorage.removeItem(k);
  }

  entries.forEach((entry, i) => {
    setTimeout(() => {
      const [staffName, msgs] = entry;
      const combined = 'üìã *–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ –∑–∞–¥–∞—á–∞–º (' + msgs.length + '):*\n\n' + msgs.join('\n\n');
      notifyStaffByName(staffName, combined);
    }, i * 2000);
  });
}

// Run deadline check ‚Äî 1x per day via localStorage dedup, re-check every 4 hours (failsafe)
let _deadlineCheckTimer = null;
function startDeadlineChecks() {
  if (_deadlineCheckTimer) clearInterval(_deadlineCheckTimer);
  // First check after 30 seconds (allow data to load)
  setTimeout(checkDeadlines, 30000);
  // Re-check every 4 hours (failsafe if CRM stayed open overnight)
  _deadlineCheckTimer = setInterval(checkDeadlines, 4 * 3600000);
}

// ============================================================
// CSV EXPORT
// ============================================================
function exportCSV(type) {
  const map = {partners:DATA.partners, tasks:DATA.tasks, projects:DATA.projects};
  const data = filterByRole(map[type]||[]);
  if(!data.length) { toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö','warning'); return; }
  const headers = Object.keys(data[0]).filter(k=>k!=='row_number');
  let csv = '\uFEFF' + headers.join(';')+'\n';
  data.forEach(r => { csv += headers.map(h=>'"'+String(r[h]||'').replace(/"/g,'""')+'"').join(';')+'\n'; });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'RKT_'+type+'_'+today()+'.csv';
  a.click();
  toast('üì• –≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤','success');
}

// ============================================================
// KEYBOARD
// ============================================================
document.addEventListener('keydown', function(e) {
  if(e.key==='Enter'&&document.getElementById('loginScreen').style.display!=='none') { doPasswordLogin(); return; }
  if(e.key==='Escape') {
    if(document.getElementById('confirmOverlay').classList.contains('show')) closeConfirm(false);
    else if(document.getElementById('detailOverlay').classList.contains('show')) closeDetail();
    else if(document.getElementById('modalOverlay').classList.contains('show')) closeModal();
  }
});

// ============================================================
// INIT ‚Äî Load saved subprojects from directions
// ============================================================
function loadSavedSubprojects() {
  // Load directions from sheet and add as subprojects to matching projects
  if (DATA.directions && DATA.directions.length) {
    DATA.directions.forEach(d => {
      const name = d['–ù–∞–∑–≤–∞–Ω–∏–µ'];
      const projName = d['–ü—Ä–æ–µ–∫—Ç'] || '';
      if (!name) return;
      // Find which project this belongs to
      for (const [key, proj] of Object.entries(PROJECTS)) {
        if (proj.name === projName && !proj.subprojects[name]) {
          proj.subprojects[name] = {
            emoji: d['Emoji'] || 'üìå',
            color: proj.color,
            desc: d['–û–ø–∏—Å–∞–Ω–∏–µ'] || ''
          };
        }
      }
    });
  }
}

// Override renderAll to include saved subprojects
const _origRenderAll = renderAll;
renderAll = function() {
  loadSavedSubprojects();
  _origRenderAll();
};

// Check if client mode (?client=TOKEN) ‚Üí redirect to standalone order page
(function() {
  const params = new URLSearchParams(window.location.search);
  const clientToken = params.get('client');
  if (clientToken) {
    // Redirect to standalone order page
    window.location.href = '/order?token=' + encodeURIComponent(clientToken);
    return;
  }
  checkSavedLogin();
})();

// ============================================================
// CLIENT MODE ‚Äî public AI questionnaire for clients
// ============================================================
let _clientDir = null;
let _clientToken = '';
let _clientChat = [];
let _clientSending = false;
let _clientFiles = [];

async function initClientMode(token) {
  _clientToken = token;
  // Hide login and main app, show client screen
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('clientScreen').style.display = 'block';

  try {
    // Find direction by client_token
    const { data, error } = await SB.from('directions').select('*').eq('client_token', token).single();
    if (error || !data) {
      showClientError('–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª–∞');
      return;
    }
    _clientDir = data;
    const dirId = data.id || data.ID;

    // Update header
    document.getElementById('clientTitle').textContent = data['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '–ê–Ω–∫–µ—Ç–∞';
    const projName = data['–ü—Ä–æ–µ–∫—Ç'] || '';
    document.getElementById('clientSubtitle').textContent = '–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞' + (projName ? ' ‚Äî ' + projName : '');

    // Update completeness
    updateClientCompleteness(data.anketa_completeness || 0);

    // Load chat history
    const { data: msgs } = await SB.from('anketa_chat').select('*').eq('direction_id', dirId).order('created_at', { ascending: true });
    _clientChat = msgs || [];

    // Render existing messages
    const container = document.getElementById('clientMessages');
    _clientChat.forEach(m => {
      if (m.role === 'user' || m.role === 'assistant') {
        appendClientMsg(m.role, m.content, m.media_urls);
      }
    });

    // If no messages ‚Äî send auto-greeting
    if (!_clientChat.length) {
      sendClientAutoGreeting(dirId);
    }

    // Scroll to bottom
    container.scrollTop = container.scrollHeight;

  } catch(e) {
    console.error('initClientMode error:', e);
    showClientError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
  }
}

function showClientError(msg) {
  const container = document.getElementById('clientMessages');
  container.innerHTML = '<div class="client-msg system">' + esc(msg) + '</div>';
}

function appendClientMsg(role, content, mediaUrls) {
  const container = document.getElementById('clientMessages');
  const div = document.createElement('div');
  div.className = 'client-msg ' + role;

  let html = '';
  // Render media
  if (mediaUrls && mediaUrls.length) {
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">';
    mediaUrls.forEach(m => {
      if (m.type === 'image' || (m.url && /\.(jpg|jpeg|png|gif|webp)/i.test(m.url))) {
        html += '<img src="' + escA(m.url) + '" style="max-width:200px;max-height:150px;border-radius:8px;cursor:pointer" onclick="window.open(this.src)" alt="—Ñ–æ—Ç–æ">';
      }
    });
    html += '</div>';
  }
  // Render text with markdown-lite
  if (content) {
    html += esc(content).replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
  }
  div.innerHTML = html;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

async function sendClientAutoGreeting(dirId) {
  // Build greeting prompt
  const dir = _clientDir;
  const q = parseQuestionnaire(dir);
  const systemPrompt = buildClientSystemPrompt(dir, q);

  _clientSending = true;
  appendClientMsg('assistant', '');
  const typingDiv = document.getElementById('clientMessages').lastElementChild;
  typingDiv.innerHTML = '<em style="color:var(--text-muted)">AI –ø–µ—á–∞—Ç–∞–µ—Ç...</em>';

  try {
    const res = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: '–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –∫–ª–∏–µ–Ω—Ç–∞ –∏ –Ω–∞—á–Ω–∏ —Å–æ–±–∏—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∫–∞–∫ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏.',
        context: 'anketa',
        source: 'client_form',
        direction: dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '',
        directionId: dirId,
        user: '–ö–ª–∏–µ–Ω—Ç',
        questionnaire: q,
        stage: dir['stage'] || 'prospect',
        history: [],
        media: [],
        systemPrompt: systemPrompt,
        isClientMode: true
      }),
      signal: AbortSignal.timeout(60000)
    });
    const data = await res.json();
    const aiText = data.reply || data.message || data.response || '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ.';

    // Parse AI response
    const parsed = parseAnketaAIResponse(aiText);

    // Remove typing indicator and show response
    typingDiv.innerHTML = esc(parsed.visibleText).replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

    // Save to DB
    await SB.from('anketa_chat').insert({
      direction_id: dirId,
      role: 'assistant',
      content: parsed.visibleText,
      extracted_data: parsed.extracted || {}
    });

    // Update completeness if present
    if (parsed.extracted && parsed.extracted.completeness !== undefined) {
      updateClientCompleteness(parsed.extracted.completeness);
    }

  } catch(e) {
    typingDiv.innerHTML = '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ ‚Äî —è –ø–æ–º–æ–≥—É —Å–æ–±—Ä–∞—Ç—å –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.';
  }
  _clientSending = false;
}

async function sendClientMsg() {
  if (_clientSending) return;
  const input = document.getElementById('clientInput');
  const text = input.value.trim();
  if (!text && !_clientFiles.length) return;

  const dir = _clientDir;
  if (!dir) return;
  const dirId = dir.id || dir.ID;

  _clientSending = true;
  document.getElementById('clientSendBtn').disabled = true;
  input.value = '';

  // Upload files if any
  let mediaUrls = [];
  if (_clientFiles.length) {
    try {
      for (const file of _clientFiles) {
        const resized = await resizeImageFile(file);
        const path = 'client/' + dirId + '/' + Date.now() + '_' + slugify(file.name.replace(/\.[^.]+$/, '')) + '.' + (file.name.split('.').pop() || 'jpg');
        const { error } = await SB.storage.from('anketa').upload(path, resized, { contentType: resized.type, upsert: false });
        if (!error) {
          const { data: urlData } = SB.storage.from('anketa').getPublicUrl(path);
          if (urlData?.publicUrl) mediaUrls.push({ type: 'image', url: urlData.publicUrl, name: file.name });
        }
      }
    } catch(e) { console.warn('File upload error:', e); }
    _clientFiles = [];
    document.getElementById('clientMediaPreview').style.display = 'none';
    document.getElementById('clientMediaPreview').innerHTML = '';
  }

  // Show user message
  appendClientMsg('user', text, mediaUrls);

  // Save user message
  await SB.from('anketa_chat').insert({
    direction_id: dirId,
    role: 'user',
    content: text,
    media_urls: mediaUrls
  });

  // Show typing
  appendClientMsg('assistant', '');
  const typingDiv = document.getElementById('clientMessages').lastElementChild;
  typingDiv.innerHTML = '<em style="color:var(--text-muted)">AI –ø–µ—á–∞—Ç–∞–µ—Ç...</em>';

  try {
    // Build history (compact: last 10 messages)
    const history = _clientChat.slice(-10).map(m => ({ role: m.role, content: m.content }));
    history.push({ role: 'user', content: text });

    const q = parseQuestionnaire(dir);
    const systemPrompt = buildClientSystemPrompt(dir, q);

    const hasMedia = mediaUrls.length > 0;
    const timeout = hasMedia ? 90000 : 60000;

    const res = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: text,
        context: 'anketa',
        source: 'client_form',
        direction: dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '',
        directionId: dirId,
        user: '–ö–ª–∏–µ–Ω—Ç',
        questionnaire: q,
        stage: dir['stage'] || 'prospect',
        history: history,
        media: mediaUrls,
        systemPrompt: systemPrompt,
        isClientMode: true
      }),
      signal: AbortSignal.timeout(timeout)
    });
    const data = await res.json();
    const aiText = data.reply || data.message || data.response || '';

    const parsed = parseAnketaAIResponse(aiText);

    // Show AI response with typewriter
    typingDiv.innerHTML = '';
    const words = parsed.visibleText.split(/(\s+)/);
    let idx = 0;
    const typeInterval = setInterval(() => {
      if (idx >= words.length) { clearInterval(typeInterval); return; }
      const chunk = words.slice(idx, idx + 3).join('');
      typingDiv.innerHTML += esc(chunk).replace(/\n/g, '<br>');
      idx += 3;
      document.getElementById('clientMessages').scrollTop = document.getElementById('clientMessages').scrollHeight;
    }, 30);

    // Save assistant message
    const extractedForSave = Object.assign({}, parsed.extracted || {});
    await SB.from('anketa_chat').insert({
      direction_id: dirId,
      role: 'assistant',
      content: parsed.visibleText,
      extracted_data: extractedForSave
    });

    // Update questionnaire
    if (parsed.extracted && Object.keys(parsed.extracted).length) {
      const updatedQ = mergeQuestionnaire(q, parsed.extracted);
      await SB.from('directions').update({
        questionnaire: JSON.stringify(updatedQ),
        anketa_completeness: parsed.extracted.completeness || dir.anketa_completeness || 0
      }).eq('id', dirId);
      dir.questionnaire = JSON.stringify(updatedQ);
      if (parsed.extracted.completeness !== undefined) {
        dir.anketa_completeness = parsed.extracted.completeness;
        updateClientCompleteness(parsed.extracted.completeness);
      }
    }

    // Add to local chat history
    _clientChat.push({ role: 'user', content: text, media_urls: mediaUrls });
    _clientChat.push({ role: 'assistant', content: parsed.visibleText, extracted_data: extractedForSave });

  } catch(e) {
    console.error('sendClientMsg error:', e);
    const isAbort = e.name === 'AbortError' || (e.message && e.message.includes('abort'));
    typingDiv.innerHTML = isAbort
      ? '<span style="color:var(--yellow)">‚è± –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.</span>'
      : '<span style="color:var(--red)">–û—à–∏–±–∫–∞: ' + esc(e.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑') + '</span>';
  }

  _clientSending = false;
  document.getElementById('clientSendBtn').disabled = false;
}

function parseQuestionnaire(dir) {
  try {
    return JSON.parse(dir.questionnaire || '{}');
  } catch(e) { return {}; }
}

function buildClientSystemPrompt(dir, questionnaire) {
  const dirName = dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '–ö–ª–∏–µ–Ω—Ç';
  const project = dir['–ü—Ä–æ–µ–∫—Ç'] || '';
  const bizType = (questionnaire.business_info && questionnaire.business_info.type) || dir['–¢–∏–ø'] || '';
  const stage = dir['stage'] || 'prospect';
  const price = dir['–¶–µ–Ω–∞'] || '';

  // Serialize collected data
  let collectedStr = '';
  if (questionnaire && questionnaire._version === 2) {
    const sections = ['business_info', 'contact', 'content', 'design', 'media', 'custom'];
    sections.forEach(s => {
      if (questionnaire[s] && Object.keys(questionnaire[s]).length) {
        collectedStr += '\n' + s + ': ' + JSON.stringify(questionnaire[s]);
      }
    });
  }

  let prompt = '–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏' + (project ? ' ¬´' + project + '¬ª' : '') + '. ';
  prompt += '–¢—ã –æ–±—â–∞–µ—à—å—Å—è –ù–ê–ü–†–Ø–ú–£–Æ —Å –∫–ª–∏–µ–Ω—Ç–æ–º ¬´' + dirName + '¬ª.\n\n';

  prompt += '## –¢–í–û–Ø –ó–ê–î–ê–ß–ê:\n';
  prompt += '–°–æ–±—Ä–∞—Ç—å –º–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –µ–≥–æ –∑–∞–∫–∞–∑–∞. ';
  prompt += '–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ–¥–Ω–æ–º—É, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π –∫–ª–∏–µ–Ω—Ç–∞. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º.\n\n';

  prompt += '## –û –ö–õ–ò–ï–ù–¢–ï:\n';
  prompt += '- –ù–∞–∑–≤–∞–Ω–∏–µ/–ü—Ä–æ–µ–∫—Ç: ' + dirName + '\n';
  if (bizType) prompt += '- –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞: ' + bizType + '\n';
  if (price) prompt += '- –ë—é–¥–∂–µ—Ç: ' + price + '\n';
  prompt += '- –≠—Ç–∞–ø: ' + stage + '\n';

  if (collectedStr) {
    prompt += '\n## –£–ñ–ï –°–û–ë–†–ê–ù–û:\n' + collectedStr + '\n';
    prompt += '\n–ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π —Ç–æ, —á—Ç–æ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ. –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ù–ï–ó–ê–ü–û–õ–ù–ï–ù–ù–´–ú –ø–æ–ª—è–º.\n';
  }

  // Direction-specific questions
  prompt += '\n## –ß–¢–û –ù–£–ñ–ù–û –£–ó–ù–ê–¢–¨ (–∞–¥–∞–ø—Ç–∏—Ä—É–π –ø–æ–¥ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ):\n';

  if (project === '–°–∞–π—Ç—ã' || /—Å–∞–π—Ç|web|landing/i.test(bizType)) {
    prompt += '1. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –±–∏–∑–Ω–µ—Å–µ (—á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å, –≤–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è)\n';
    prompt += '2. –ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç —Å–∞–π—Ç–∞ (–ª–µ–Ω–¥–∏–Ω–≥, –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω)\n';
    prompt += '3. –ö–æ–Ω—Ç–∞–∫—Ç—ã (—Ç–µ–ª–µ—Ñ–æ–Ω, email, —Å–æ—Ü—Å–µ—Ç–∏, –∞–¥—Ä–µ—Å, —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã)\n';
    prompt += '4. –£—Å–ª—É–≥–∏/—Ç–æ–≤–∞—Ä—ã —Å —Ü–µ–Ω–∞–º–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º\n';
    prompt += '5. –°—Ç–∏–ª—å –∏ –¥–∏–∑–∞–π–Ω (–ª—é–±–∏–º—ã–µ —Ü–≤–µ—Ç–∞, –ø—Ä–∏–º–µ—Ä—ã —Å–∞–π—Ç–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –Ω—Ä–∞–≤—è—Ç—Å—è)\n';
    prompt += '6. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–ª–æ–≥–æ—Ç–∏–ø, —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏/–∏–Ω—Ç–µ—Ä—å–µ—Ä–∞, –∫–æ–º–∞–Ω–¥—ã)\n';
    prompt += '7. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è\n';
  } else if (project === '–†–ö–¢' || /–º–µ–¥–∏—Ü–∏–Ω|–æ–±–æ—Ä—É–¥|—Ä–µ–Ω—Ç–≥–µ–Ω/i.test(bizType)) {
    prompt += '1. –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ —Ç–∏–ø (–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞, –±–æ–ª—å–Ω–∏—Ü–∞, —á–∞—Å—Ç–Ω–∞—è –∫–ª–∏–Ω–∏–∫–∞)\n';
    prompt += '2. –ö–∞–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω—É–∂–Ω–æ (—Ç–∏–ø, –º–æ–¥–µ–ª—å, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)\n';
    prompt += '3. –ö–æ–Ω—Ç–∞–∫—Ç—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª–∏—Ü–∞\n';
    prompt += '4. –ë—é–¥–∂–µ—Ç –∏ —Å—Ä–æ–∫–∏\n';
    prompt += '5. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–ø–ª–æ—â–∞–¥—å –ø–æ–º–µ—â–µ–Ω–∏—è, —ç–ª–µ–∫—Ç—Ä–æ–ø–∏—Ç–∞–Ω–∏–µ)\n';
    prompt += '6. –ù—É–∂–Ω–∞ –ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞, –æ–±—É—á–µ–Ω–∏–µ, —Å–µ—Ä–≤–∏—Å–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ\n';
  } else {
    prompt += '1. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ/–∑–∞–∫–∞–∑–µ\n';
    prompt += '2. –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n';
    prompt += '3. –ë—é–¥–∂–µ—Ç –∏ —Å—Ä–æ–∫–∏\n';
    prompt += '4. –û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è\n';
    prompt += '5. –†–µ—Ñ–µ—Ä–µ–Ω—Å—ã/–ø—Ä–∏–º–µ—Ä—ã\n';
  }

  prompt += '\n## –ü–†–ê–í–ò–õ–ê:\n';
  prompt += '- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º\n';
  prompt += '- –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º ‚Äî —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç, –Ω–µ –º–µ–Ω–µ–¥–∂–µ—Ä\n';
  prompt += '- –ó–∞–¥–∞–≤–∞–π –ø–æ 1-2 –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π\n';
  prompt += '- –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –∏–∑–≤–ª–µ–∫–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\n';
  prompt += '- JSON –±–ª–æ–∫ –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ\n';
  prompt += '- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∂–∞—Ä–≥–æ–Ω\n\n';

  prompt += '## –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:\n';
  prompt += '–¢–µ–∫—Å—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ø—Ä–æ—Å—Ç–æ–π)\n\n';
  prompt += '```json\n{\n  "extracted": { /* –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ */ },\n  "completeness": 0.0-1.0\n}\n```\n';

  return prompt;
}

function updateClientCompleteness(val) {
  const pct = Math.round((val || 0) * 100);
  const pctEl = document.getElementById('clientPct');
  const barEl = document.getElementById('clientBar');
  if (pctEl) pctEl.textContent = pct + '%';
  if (barEl) barEl.style.width = pct + '%';
}

function clientAttachFile() {
  document.getElementById('clientFileInput').click();
}

function clientFilesSelected(input) {
  const files = Array.from(input.files || []);
  if (!files.length) return;
  _clientFiles = _clientFiles.concat(files);
  const preview = document.getElementById('clientMediaPreview');
  preview.style.display = 'flex';
  files.forEach(f => {
    if (f.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      preview.appendChild(img);
    }
  });
  input.value = '';
}

// ============================================================
// MANAGER: Share client link button
// ============================================================
async function generateClientLink(dirId) {
  const dir = (DATA.directions||[]).find(d => (d.ID||d.id) === dirId);
  if (!dir) { toast('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error'); return; }

  let token = dir.client_token;
  if (!token) {
    // Generate new token
    token = crypto.randomUUID ? crypto.randomUUID() : 'c' + Date.now().toString(36) + Math.random().toString(36).substr(2, 8);
    await SB.from('directions').update({ client_token: token }).eq('id', dirId);
    dir.client_token = token;
  }

  const url = 'https://rct-hub.ru/order?token=' + token;

  try { await navigator.clipboard.writeText(url); } catch(e) {}
  toast('üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
  return url;
}

async function generateClientQR(dirId) {
  const url = await generateClientLink(dirId);
  if (!url) return;
  // Open QR code via API
  const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(url);
  window.open(qrUrl, '_blank');
  toast('QR-–∫–æ–¥ –æ—Ç–∫—Ä—ã—Ç –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ', 'info');
}

// ============================================================
// GUIDED WORKFLOW ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
// ============================================================
function getWorkflowStep(dir) {
  const stage = dir['stage'] || 'prospect';
  const dirName = dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || dir['name'] || '';
  const tasks = (DATA.tasks||[]).filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === dirName);
  const steps = {
    'prospect': { step: 1, icon: 'üîç', title: '–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É', desc: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç ‚Äî –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ Telegram', action: '–ü–æ–∑–≤–æ–Ω–∏–ª ‚Üí –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç', nextStage: 'contact', required: ['–¢–µ–ª–µ—Ñ–æ–Ω'] },
    'contact': { step: 2, icon: 'üìû', title: '–ñ–¥—ë–º –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞', desc: '–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ 1-2 –¥–Ω—è –µ—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª. 80% —Å–¥–µ–ª–æ–∫ –ø–æ—Å–ª–µ 5+ –∑–≤–æ–Ω–∫–æ–≤!', action: '–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω', nextStage: 'interest', required: [] },
    'interest': { step: 3, icon: '‚úÖ', title: '–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø', desc: '–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω ‚Äî –ø–æ–∫–∞–∂–∏—Ç–µ –µ–º—É –¥–µ–º–æ-—Å–∞–π—Ç', action: '–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø', nextStage: 'proto', required: [] },
    'proto': { step: 4, icon: 'üé®', title: '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ö–ü', desc: '–ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø + –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å —Ü–µ–Ω–æ–π', action: '–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', nextStage: 'proposal', required: [] },
    'proposal': { step: 5, icon: 'üìã', title: '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', desc: '–°–æ–∑–≤–æ–Ω–∏—Ç–µ—Å—å, –æ–±—Å—É–¥–∏—Ç–µ –ø—Ä–∞–≤–∫–∏ –∏ —É—Å–ª–æ–≤–∏—è', action: '–ù–∞—á–∞—Ç—å –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', nextStage: 'negotiation', required: [] },
    'negotiation': { step: 6, icon: 'ü§ù', title: '–ó–∞–∫—Ä–æ–π—Ç–µ —Å–¥–µ–ª–∫—É', desc: '–ö–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ ‚Äî –≤—ã—Å—Ç–∞–≤—å—Ç–µ —Å—á—ë—Ç –∏ –ø–æ–ª—É—á–∏—Ç–µ –æ–ø–ª–∞—Ç—É', action: '–ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏–ª', nextStage: 'payment', required: [] },
    'payment': { step: 7, icon: 'üí∞', title: '–°–¥–∞–π—Ç–µ —Å–∞–π—Ç', desc: '–ó–∞–ª–µ–π—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥, –ø—Ä–∏–≤—è–∂–∏—Ç–µ –¥–æ–º–µ–Ω –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç—É', action: '–°–∞–π—Ç —Å–¥–∞–Ω!', nextStage: 'done', required: [] },
    'done': { step: 8, icon: '‚úÖ', title: '–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω', desc: '–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç', action: null, nextStage: null, required: [] },
    'lost': { step: 0, icon: '‚ùå', title: '–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è', desc: '–ü—Ä–∏—á–∏–Ω–∞: '+(dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']||'–Ω–µ —É–∫–∞–∑–∞–Ω–∞'), action: '–í–µ—Ä–Ω—É—Ç—å –≤ –≤–æ—Ä–æ–Ω–∫—É', nextStage: 'prospect', required: [] }
  };
  return steps[stage] || steps['prospect'];
}

function renderWorkflowBanner(dir) {
  const wf = getWorkflowStep(dir);
  const id = dir['ID'] || dir.id || '';
  const p = getUserPerms();
  const name = dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'';
  
  if (wf.step === 8) {
    return '<div class="workflow-banner" style="border-color:var(--green);background:rgba(0,212,170,.06)"><div class="wf-step">üéâ</div><div class="wf-info"><h4 style="color:var(--green)">–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</h4><p>–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç</p></div></div>';
  }
  
  // Find current active task for this client
  const clientTasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === name);
  const activeTask = clientTasks.find(t => (t['–°—Ç–∞—Ç—É—Å']||'').includes('–í —Ä–∞–±–æ—Ç–µ') || (t['–°—Ç–∞—Ç—É—Å']||'').includes('–ù–æ–≤–∞—è'));
  const responsible = activeTask ? (activeTask['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω') : (dir['–ú–µ–Ω–µ–¥–∂–µ—Ä']||'–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω');
  const deadline = activeTask ? (activeTask['–î–µ–¥–ª–∞–π–Ω']||'‚Äî') : '‚Äî';
  
  let missingHtml = '';
  if (wf.required.length) {
    const missing = wf.required.filter(r => {
      if (r === '–¢–µ–ª–µ—Ñ–æ–Ω') return !dir['–¢–µ–ª–µ—Ñ–æ–Ω'];
      if (r === '–û–ø–ª–∞—á–µ–Ω–æ') return !dir['–û–ø–ª–∞—á–µ–Ω–æ'];
      return false;
    });
    if (missing.length) {
      missingHtml = '<p style="color:var(--red);font-size:11px;margin-top:4px">‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ: ' + missing.join(', ') + '</p>';
    }
  }
  
  const actionBtn = wf.action && p.canWrite ? '<div class="wf-action"><button onclick="setDealStage(\''+id+'\',\''+wf.nextStage+'\')">'+wf.action+'</button></div>' : '';
  
  return '<div class="workflow-banner"><div class="wf-step">'+wf.icon+'</div><div class="wf-info"><h4>–®–∞–≥ '+wf.step+'/7: '+wf.title+'</h4><p>'+wf.desc+'</p>' +
    '<div style="display:flex;gap:12px;margin-top:6px;font-size:12px"><span style="color:var(--accent)">üë§ '+esc(responsible)+'</span><span style="color:var(--text2)">üìÖ '+esc(deadline)+'</span></div>' +
    missingHtml+'</div>'+actionBtn+'</div>';
}

// ============================================================
// ENHANCED SITE BUILDER ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–∞–π—Ç–æ–≤
// ============================================================
function renderFullSiteBuilder(dirName) {
  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === dirName && d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  if (!dir) return '<p class="empty">–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
  
  const cached = siteCache[dirName];
  
  let html = '<div style="margin-bottom:16px">';
  html += renderWorkflowBanner(dir);
  html += '</div>';
  
  // Site builder form
  html += '<div class="card" style="padding:20px;margin-bottom:16px"><h4 style="font-size:15px;font-weight:600;margin-bottom:16px">üé® –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–∞–π—Ç–∞</h4>';
  html += '<div class="form-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  html += '<div class="form-group"><label>üè¢ –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞</label><input id="sb-name" value="'+esc(dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')+'" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"></div>';
  html += '<div class="form-group"><label>üìÇ –¢–∏–ø –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</label><input id="sb-type" value="'+esc(dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'')+'" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω, –°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"></div>';
  html += '<div class="form-group"><label>üì± –¢–µ–ª–µ—Ñ–æ–Ω</label><input id="sb-phone" value="'+esc(dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'')+'" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"></div>';
  html += '<div class="form-group"><label>üìç –ì–æ—Ä–æ–¥</label><input id="sb-city" value="'+esc(dir['–ì–æ—Ä–æ–¥']||'')+'" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"></div>';
  html += '<div class="form-group" style="grid-column:span 2"><label>üìù –£—Å–ª—É–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input id="sb-services" placeholder="–°—Ç—Ä–∏–∂–∫–∏, –ú–∞–Ω–∏–∫—é—Ä, –ö–µ—Ä–∞—Ç–∏–Ω..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"></div>';
  html += '<div class="form-group" style="grid-column:span 2"><label>üé® –°—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞</label><select id="sb-style" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"><option>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º</option><option>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option><option>–Ø—Ä–∫–∏–π –∏ –º–æ–ª–æ–¥—ë–∂–Ω—ã–π</option><option>–ü—Ä–µ–º–∏—É–º / –õ—é–∫—Å</option><option>–£—é—Ç–Ω—ã–π –∏ —Ç—ë–ø–ª—ã–π</option></select></div>';
  html += '<div class="form-group" style="grid-column:span 2"><label>üí¨ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label><textarea id="sb-notes" rows="3" placeholder="–¶–≤–µ—Ç–∞, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit;resize:vertical"></textarea></div>';
  html += '</div>';
  html += '<div style="display:flex;gap:8px;margin-top:12px">';
  html += '<button class="btn btn-primary" onclick="generateFullSite(\''+escA(dirName)+'\')"><span id="sb-gen-spinner" style="display:none">‚è≥</span> ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç</button>';
  html += (cached ? '<button class="btn btn-secondary" onclick="downloadSite(\''+escA(dirName)+'\')">üì• –°–∫–∞—á–∞—Ç—å HTML</button>' : '');
  html += (cached ? '<button class="btn btn-secondary" onclick="editSiteCode(\''+escA(dirName)+'\')">üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>' : '');
  html += '</div></div>';
  
  // Preview
  if (cached) {
    html += '<div class="card" style="padding:0;overflow:hidden"><div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><h4 style="font-size:13px;font-weight:600">üëÅÔ∏è –ü—Ä–µ–≤—å—é —Å–∞–π—Ç–∞</h4><div style="display:flex;gap:6px"><button onclick="previewMobile()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:var(--text2);cursor:pointer;font-size:11px">üì± –ú–æ–±–∏–ª—å–Ω–∞—è</button><button onclick="previewDesktop()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:var(--text2);cursor:pointer;font-size:11px">üñ• –î–µ—Å–∫—Ç–æ–ø</button></div></div>';
    html += '<iframe id="site-preview-frame" srcdoc="'+esc(cached)+'" style="width:100%;height:600px;border:none;background:#fff"></iframe></div>';
  }
  
  // Code editor
  html += '<div id="code-editor-wrap" style="display:none;margin-top:16px"><div class="card" style="padding:16px"><h4 style="font-size:13px;font-weight:600;margin-bottom:8px">üîß –†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞</h4><textarea id="site-code-editor" style="width:100%;height:400px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;color:var(--text);font-family:\'JetBrains Mono\',monospace;font-size:12px;resize:vertical"></textarea><div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-primary" onclick="applySiteCode(\''+escA(dirName)+'\')">üíæ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button><button class="btn btn-secondary" onclick="document.getElementById(\'code-editor-wrap\').style.display=\'none\'">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>';
  
  return html;
}

function previewMobile() {
  const f = document.getElementById('site-preview-frame');
  if (f) { f.style.width = '375px'; f.style.margin = '0 auto'; f.style.display = 'block'; }
}
function previewDesktop() {
  const f = document.getElementById('site-preview-frame');
  if (f) { f.style.width = '100%'; f.style.margin = '0'; }
}
function editSiteCode(dirName) {
  const code = siteCache[dirName];
  if (!code) return;
  document.getElementById('code-editor-wrap').style.display = 'block';
  document.getElementById('site-code-editor').value = code;
}
function applySiteCode(dirName) {
  const code = document.getElementById('site-code-editor').value;
  siteCache[dirName] = code;
  const frame = document.getElementById('site-preview-frame');
  if (frame) frame.srcdoc = code;
  document.getElementById('code-editor-wrap').style.display = 'none';
  toast('‚úÖ –ö–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω');
}
function downloadSite(dirName) {
  const code = siteCache[dirName];
  if (!code) { toast('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–∞–π—Ç','error'); return; }
  const blob = new Blob([code], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (dirName||'site').replace(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9]/g,'_') + '.html';
  a.click();
  toast('üì• –§–∞–π–ª —Å–∫–∞—á–∞–Ω');
}

async function generateFullSite(dirName) {
  const spinner = document.getElementById('sb-gen-spinner');
  if (spinner) spinner.style.display = 'inline';
  
  const data = {
    name: document.getElementById('sb-name')?.value || dirName,
    type: document.getElementById('sb-type')?.value || '',
    phone: document.getElementById('sb-phone')?.value || '',
    city: document.getElementById('sb-city')?.value || '',
    services: document.getElementById('sb-services')?.value || '',
    style: document.getElementById('sb-style')?.value || '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º',
    notes: document.getElementById('sb-notes')?.value || ''
  };
  
  const prompt = `–°–æ–∑–¥–∞–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∞–π—Ç (HTML+CSS+JS –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ) –¥–ª—è –±–∏–∑–Ω–µ—Å–∞:
–ù–∞–∑–≤–∞–Ω–∏–µ: ${data.name}
–¢–∏–ø –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: ${data.type}  
–ì–æ—Ä–æ–¥: ${data.city}
–¢–µ–ª–µ—Ñ–æ–Ω: ${data.phone}
–£—Å–ª—É–≥–∏: ${data.services}
–°—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞: ${data.style}
–ü–æ–∂–µ–ª–∞–Ω–∏—è: ${data.notes}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–π –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é HTML —Ñ–∞–π–ª
- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω
- –°–µ–∫—Ü–∏–∏: —à–∞–ø–∫–∞ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π, –≥–µ—Ä–æ–π-–±–∞–Ω–Ω–µ—Ä, —É—Å–ª—É–≥–∏/–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –æ –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å –∫–∞—Ä—Ç–æ–π, –ø–æ–¥–≤–∞–ª
- –ö–Ω–æ–ø–∫–∏ CTA (–ø–æ–∑–≤–æ–Ω–∏—Ç—å, –∑–∞–ø–∏—Å–∞—Ç—å—Å—è)
- –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
- –Ø—Ä–∫–∏–π, –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –≤ —Å—Ç–∏–ª–µ "${data.style}"
- –í—Å—ë –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û HTML –∫–æ–¥ –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –º–∞—Ä–∫–¥–∞—É–Ω–∞`;

  try {
    const resp = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: prompt, userId: USER?.tgId||'', context: 'site_generator' })
    });
    const result = await resp.json();
    let r4 = result; if (Array.isArray(result)) r4 = result[0]||{}; if (r4.json) r4 = r4.json;
    let siteCode = r4.reply || r4.response || r4.output || r4.text || '';
    
    // Clean up markdown wrapper if present
    siteCode = siteCode.replace(/^```html?\n?/i, '').replace(/\n?```$/,'').trim();
    
    if (siteCode.includes('<html') || siteCode.includes('<body') || siteCode.includes('<div')) {
      siteCache[dirName] = siteCode;
      toast('‚úÖ –°–∞–π—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!');
      // Re-render to show preview
      const container = document.getElementById('sp-content');
      if (container) {
        const currentTab = document.querySelector('.sp-tab.active')?.dataset?.tab;
        if (currentTab === 'generator') {
          container.innerHTML = renderFullSiteBuilder(dirName);
        }
      }
    } else {
      toast('‚ö†Ô∏è AI –Ω–µ –≤–µ—Ä–Ω—É–ª HTML –∫–æ–¥','error');
    }
  } catch(err) {
    toast('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
  }
  if (spinner) spinner.style.display = 'none';
}

// ============================================================
// CLIENT CARD ‚Äî –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ —Å –∑–∞–¥–∞—á–∞–º–∏
// ============================================================
function openClientCard(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) { toast('–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
  
  const name = dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||dir['name']||'?';
  const stage = dir['stage']||'prospect';
  const stageObj = STAGES.find(s=>s.id===stage)||STAGES[0];
  const stageIdx = STAGES.findIndex(s=>s.id===stage);
  const clientTasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === name);
  const activeTasks = clientTasks.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'') !== '–ì–æ—Ç–æ–≤–æ');
  const doneTasks = clientTasks.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'') === '–ì–æ—Ç–æ–≤–æ');
  const td = today();
  const p = getUserPerms();
  const eid = escA(id);
  const ename = escA(name);
  
  let html = '<div style="padding:20px 24px">';
  
  // Stepper
  html += '<div style="display:flex;align-items:center;margin-bottom:24px;gap:0">';
  STAGES.forEach((s,i) => {
    const done = i < stageIdx;
    const cur = i === stageIdx;
    const bgC = done ? 'var(--green)' : cur ? stageObj.color : 'var(--bg3)';
    const txtC = done || cur ? '#fff' : 'var(--text2)';
    html += '<div style="display:flex;align-items:center">';
    html += '<div style="width:28px;height:28px;border-radius:50%;background:'+bgC+';color:'+txtC+';display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;'+(cur?'box-shadow:0 0 12px '+stageObj.color+';transform:scale(1.15)':'')+'">'+(done?'‚úì':(i+1))+'</div>';
    if (i < STAGES.length-1) html += '<div style="width:20px;height:2px;background:'+(i<stageIdx?'var(--green)':'var(--bg3)')+'"></div>';
    html += '</div>';
  });
  html += '</div>';
  html += '<div style="text-align:center;margin-bottom:20px"><span style="background:'+stageObj.color+';color:#fff;padding:4px 14px;border-radius:12px;font-size:12px;font-weight:600">'+stageObj.name+'</span></div>';
  
  // MAIN ACTION AREA
  html += '<div class="card" style="padding:20px;margin-bottom:16px;border:2px solid '+stageObj.color+';border-radius:12px">';
  
  if (stage === 'prospect') {
    // ============ –ü–û–ò–°–ö ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø–æ–∑–≤–æ–Ω–∏—Ç—å ============
    const hasPhone = !!dir['–¢–µ–ª–µ—Ñ–æ–Ω'];
    const hasType = !!dir['–¢–∏–ø —Å–∞–π—Ç–∞'];
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">üîç –®–∞–≥ 1: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ª–∏–¥–∞</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–ù–∞—à–ª–∏ –±–∏–∑–Ω–µ—Å –±–µ–∑ —Å–∞–π—Ç–∞ ‚Äî –≤–Ω–µ—Å–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ</div>';
    
    html += '<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">';
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–¢–µ–ª–µ—Ñ–æ–Ω *</label><input id="cc-lead-phone" type="tel" value="'+escA(dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'')+'" placeholder="+7 900 123-45-67" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–ì–æ—Ä–æ–¥</label><input id="cc-lead-city" type="text" value="'+escA(dir['–ì–æ—Ä–æ–¥']||'')+'" placeholder="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
    html += '</div>';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">üì± Telegram –∫–ª–∏–µ–Ω—Ç–∞</label><input id="cc-lead-telegram" type="text" value="'+escA(dir['Telegram']||'')+'" placeholder="@username" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
    
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–¢–∏–ø —Å–∞–π—Ç–∞ *</label>';
    html += '<select id="cc-lead-type" onchange="updateLeadPrice()" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px">';
    html += '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø ‚Äî</option>';
    for (const [t, pr] of Object.entries(SITE_PRICING)) {
      html += '<option value="'+escA(t)+'"'+(dir['–¢–∏–ø —Å–∞–π—Ç–∞']===t?' selected':'')+'>'+pr.emoji+' '+t+' ‚Äî '+pr.price.toLocaleString('ru')+'‚ÇΩ</option>';
    }
    html += '</select></div>';
    
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–¶–µ–Ω–∞ ‚ÇΩ *</label><input id="cc-lead-price" type="number" value="'+(Number(dir['–¶–µ–Ω–∞'])||'')+'" placeholder="10000" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–ú–µ–Ω–µ–¥–∂–µ—Ä</label><select id="cc-lead-manager" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px">';
    html += '<option value="">‚Äî –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω ‚Äî</option>';
    (DATA.staff||[]).filter(s=>s['–°—Ç–∞—Ç—É—Å']!=='–û–∂–∏–¥–∞–µ—Ç'&&s['–°—Ç–∞—Ç—É—Å']!=='‚ùå –£–¥–∞–ª—ë–Ω').forEach(s => {
      html += '<option value="'+escA(s['–ò–º—è'])+'"'+(dir['–ú–µ–Ω–µ–¥–∂–µ—Ä']===s['–ò–º—è']?' selected':'')+'>'+esc(s['–ò–º—è'])+' ('+esc(s['–†–æ–ª—å']||'')+')</option>';
    });
    html += '</select></div></div>';
    html += '</div>';
    
    html += '<button class="btn btn-secondary" onclick="saveLeadData(\''+eid+'\')" style="width:100%;margin-bottom:8px">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>';
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'contact\')" style="width:100%;font-size:14px;padding:12px">üìû –ü–æ–∑–≤–æ–Ω–∏–ª ‚Üí –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</button>';
    if (!hasPhone) html += '<div style="text-align:center;padding:4px;color:var(--orange);font-size:11px">‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–µ—Ä–µ–¥ –∑–≤–æ–Ω–∫–æ–º</div>';
    
  } else if (stage === 'contact') {
    // ============ –ü–ï–†–í–´–ô –ö–û–ù–¢–ê–ö–¢ ‚Äî –∂–¥—ë–º –æ—Ç–≤–µ—Ç, follow-up ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">üìû –®–∞–≥ 2: –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–ü–æ–∑–≤–æ–Ω–∏–ª–∏ –∫–ª–∏–µ–Ω—Ç—É. –ñ–¥—ë–º –æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç ‚Äî –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ 1-2 –¥–Ω—è.</div>';
    html += '<div style="background:var(--bg3);border-radius:8px;padding:14px;margin-bottom:16px;font-size:12px">';
    html += '<div style="font-weight:600;margin-bottom:6px">üí° –°–æ–≤–µ—Ç—ã –ø–æ –ø–µ—Ä–≤–æ–º—É –∑–≤–æ–Ω–∫—É:</div>';
    html += '<div>1. ¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø —É–≤–∏–¥–µ–ª –≤–∞—à –±–∏–∑–Ω–µ—Å –Ω–∞ –∫–∞—Ä—Ç–∞—Ö ‚Äî —É –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–∞–π—Ç–∞?¬ª</div>';
    html += '<div>2. ¬´–ú—ã –º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å —Å–∞–π—Ç –∑–∞ X –¥–Ω–µ–π. –í–æ—Ç –ø—Ä–∏–º–µ—Ä ‚Äî –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ.¬ª</div>';
    html += '<div>3. <b>80% —Å–¥–µ–ª–æ–∫ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ 5+ –∑–≤–æ–Ω–∫–æ–≤!</b></div>';
    html += '</div>';
    const cleanPhone = (dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[^\\d+]/g,'');
    if (cleanPhone) {
      html += '<div style="display:flex;gap:8px;margin-bottom:12px">';
      html += '<button class="btn btn-secondary" onclick="window.open(\'tel:'+cleanPhone+'\')" style="flex:1">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>';
      html += '<button class="btn btn-secondary" onclick="window.open(\'https://t.me/'+cleanPhone.replace('+','')+'\',\'_blank\')" style="flex:1">üí¨ Telegram</button>';
      html += '</div>';
    }
    html += '<button class="btn btn-secondary" onclick="logTouch(\''+eid+'\')" style="width:100%;margin-bottom:8px">üìû –ó–∞–ø–∏—Å–∞—Ç—å –∫–∞—Å–∞–Ω–∏–µ (–∑–≤–æ–Ω–æ–∫)</button>';
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'interest\')" style="width:100%;font-size:14px;padding:12px">‚úÖ –ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω!</button>';
    html += '<button class="btn" onclick="rejectDeal(\''+eid+'\')" style="width:100%;margin-top:8px;background:rgba(255,75,75,.1);color:var(--red)">‚ùå –û—Ç–∫–∞–∑–∞–ª—Å—è</button>';
    
  } else if (stage === 'interest') {
    // ============ –ò–ù–¢–ï–†–ï–° ‚Äî AI-—á–∞—Ç –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">‚úÖ –®–∞–≥ 3: –°–æ–±–µ—Ä–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∞–π—Ç–∞</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:12px">–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω! –°–∫–∏–Ω—å—Ç–µ –≤—Å—ë —á—Ç–æ –µ—Å—Ç—å ‚Äî —Ñ–æ—Ç–æ, –ø–µ—Ä–µ–ø–∏—Å–∫—É, –ø—Ä–∏–º–µ—Ä—ã. AI –∑–∞–¥–∞—Å—Ç –Ω—É–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.</div>';
    html += '<div id="cc-anketa-chat-'+eid+'" style="margin-bottom:12px"></div>';
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'proto\')" style="width:100%;font-size:14px;padding:12px">üé® –î–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã ‚Üí –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø</button>';
    
  } else if (stage === 'proto') {
    // ============ –ü–†–û–¢–û–¢–ò–ü ‚Äî —Å–æ–∑–¥–∞—Ç—å –¥–µ–º–æ-—Å–∞–π—Ç ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">üé® –®–∞–≥ 4: –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–∞–π—Ç–∞</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–û—Ç–∫—Ä–æ–π—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ —Å–æ–∑–¥–∞–π—Ç–µ –¥–µ–º–æ-—Å–∞–π—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç—É</div>';
    html += '<button class="btn btn-primary" onclick="closeClientCard();openSubproject(\''+ename+'\');setTimeout(()=>showSpTab(\'sitegen\'),300)" style="width:100%;font-size:15px;padding:14px;margin-bottom:8px">üé® –û—Ç–∫—Ä—ã—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>';
    html += '<button class="btn btn-secondary" onclick="advanceToStage(\''+eid+'\',\'proposal\')" style="width:100%">üìã –ü—Ä–æ—Ç–æ—Ç–∏–ø –≥–æ—Ç–æ–≤ ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ö–ü</button>';
    
  } else if (stage === 'proposal') {
    // ============ –ö–ü –û–¢–ü–†–ê–í–õ–ï–ù–û ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø + —Ü–µ–Ω—É ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">üìã –®–∞–≥ 5: –ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø + —Ü–µ–Ω—É. –í–∞–∂–Ω–æ: –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ, –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å—Å—ã–ª–∫—É!</div>';
    if (dir['–°—Å—ã–ª–∫–∞']) {
      html += '<div style="background:var(--bg3);border-radius:8px;padding:14px;margin-bottom:16px">';
      html += '<div style="font-size:11px;color:var(--text2);margin-bottom:4px">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ç–æ—Ç–∏–ø:</div>';
      html += '<a href="'+esc(dir['–°—Å—ã–ª–∫–∞'])+'" target="_blank" style="color:var(--blue);word-break:break-all">'+esc(dir['–°—Å—ã–ª–∫–∞'])+'</a></div>';
    }
    const phone2 = dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'';
    const tgTag = dir['Telegram']||'';
    const tgTarget = tgTag ? tgTag.replace('@','') : (phone2 ? phone2.replace(/[^0-9]/g,'') : '');
    if (tgTarget) {
      const tgLink = 'https://t.me/'+tgTarget+'?text='+encodeURIComponent('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–∞–π—Ç–∞ –¥–ª—è –≤–∞—Å: '+(dir['–°—Å—ã–ª–∫–∞']||''));
      html += '<a href="'+tgLink+'" target="_blank" class="btn btn-secondary" style="width:100%;margin-bottom:8px;text-align:center;display:block;background:rgba(0,136,204,0.1);color:#0088cc;border-color:#0088cc">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram'+(tgTag ? ' ('+esc(tgTag)+')' : '')+' </a>';
    }
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'negotiation\')" style="width:100%;font-size:14px;padding:12px">ü§ù –ö–ª–∏–µ–Ω—Ç –≤–∏–¥–µ–ª –ö–ü ‚Üí –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã</button>';
    
  } else if (stage === 'negotiation') {
    // ============ –ü–ï–†–ï–ì–û–í–û–†–´ ‚Äî –æ–±—Å—É–∂–¥–∞–µ–º, —Ç–æ—Ä–≥—É–µ–º—Å—è ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">ü§ù –®–∞–≥ 6: –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–û–±—Å—É–¥–∏—Ç–µ –ø—Ä–∞–≤–∫–∏, —É—Å–ª–æ–≤–∏—è, —Ü–µ–Ω—É. –ó–∞–∫—Ä–æ–π—Ç–µ —Å–¥–µ–ª–∫—É!</div>';
    html += '<div style="text-align:center;padding:20px;background:var(--bg3);border-radius:12px;margin-bottom:16px">';
    html += '<div style="font-size:13px;color:var(--text2)">–°—É–º–º–∞ —Å–¥–µ–ª–∫–∏:</div>';
    html += '<div style="font-size:32px;font-weight:700;color:var(--accent)">'+(Number(dir['–¶–µ–Ω–∞'])||0).toLocaleString('ru')+'‚ÇΩ</div></div>';
    html += '<button class="btn btn-secondary" onclick="addDealFeedback(\''+eid+'\')" style="width:100%;margin-bottom:8px">üí¨ –ó–∞–ø–∏—Å–∞—Ç—å —Ñ–∏–¥–±–µ–∫</button>';
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'payment\')" style="width:100%;font-size:14px;padding:12px">üí∞ –ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è ‚Üí –û–ø–ª–∞—Ç–∞</button>';
    html += '<button class="btn" onclick="rejectDeal(\''+eid+'\')" style="width:100%;margin-top:8px;background:rgba(255,75,75,.1);color:var(--red)">‚ùå –û—Ç–∫–∞–∑–∞–ª—Å—è</button>';
    
  } else if (stage === 'payment') {
    // ============ –û–ü–õ–ê–¢–ê ‚Äî –ø–æ–ª—É—á–∏—Ç—å –¥–µ–Ω—å–≥–∏, –∑–∞–ª–∏—Ç—å —Å–∞–π—Ç ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">üí∞ –®–∞–≥ 7: –ü–æ–ª—É—á–∏—Ç–µ –æ–ø–ª–∞—Ç—É –∏ —Å–¥–∞–π—Ç–µ —Å–∞–π—Ç</div>';
    html += '<div style="text-align:center;padding:20px;background:var(--bg3);border-radius:12px;margin-bottom:16px">';
    html += '<div style="font-size:13px;color:var(--text2)">–ö –æ–ø–ª–∞—Ç–µ:</div>';
    html += '<div style="font-size:32px;font-weight:700;color:var(--accent)">'+(Number(dir['–¶–µ–Ω–∞'])||0).toLocaleString('ru')+'‚ÇΩ</div></div>';
    if (dir['–û–ø–ª–∞—á–µ–Ω–æ']) {
      html += '<div style="text-align:center;padding:12px;background:rgba(0,212,170,0.1);border-radius:8px;color:var(--green);font-weight:600;margin-bottom:8px">‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞!</div>';
    } else {
      html += '<button class="btn btn-secondary" onclick="markPaid(\''+eid+'\');closeClientCard();setTimeout(()=>openClientCard(\''+eid+'\'),800)" style="width:100%;font-size:14px;padding:12px;margin-bottom:8px">üí∞ –û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>';
    }
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'done\')" style="width:100%;font-size:14px;padding:12px">‚úÖ –°–∞–π—Ç —Å–¥–∞–Ω ‚Üí –ó–∞–≤–µ—Ä—à–∏—Ç—å!</button>';
    
  } else if (stage === 'done') {
    // ============ –ó–ê–í–ï–†–®–Å–ù ============
    html += '<div style="text-align:center;padding:20px"><div style="font-size:48px;margin-bottom:8px">üéâ</div>';
    html += '<div style="font-size:18px;font-weight:700;color:var(--green)">–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-top:4px">–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª —Å–∞–π—Ç</div></div>';
    if (dir['–°—Å—ã–ª–∫–∞']) html += '<a href="'+esc(dir['–°—Å—ã–ª–∫–∞'])+'" target="_blank" class="btn btn-secondary" style="width:100%;text-align:center;display:block">üîó –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç</a>';
    
  } else if (stage === 'lost') {
    // ============ –û–¢–ö–ê–ó ============
    html += '<div style="text-align:center;padding:20px"><div style="font-size:48px;margin-bottom:8px">‚ùå</div>';
    html += '<div style="font-size:18px;font-weight:700;color:var(--red)">–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-top:4px">–ü—Ä–∏—á–∏–Ω–∞: '+esc(dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']||'–Ω–µ —É–∫–∞–∑–∞–Ω–∞')+'</div></div>';
    html += '<button class="btn btn-secondary" onclick="advanceToStage(\''+eid+'\',\'prospect\')" style="width:100%">üîÑ –í–µ—Ä–Ω—É—Ç—å –≤ –≤–æ—Ä–æ–Ω–∫—É</button>';
  }
  // === SALES SCRIPT BUTTON (for active sales stages) ===
  if (['prospect','contact','interest','proto','proposal','negotiation','payment'].indexOf(stage) >= 0) {
    html += '<button class="btn btn-secondary" onclick="showSalesScript(\''+escA(stage)+'\',\''+ename+'\',\''+escA(dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'')+'\' )" style="width:100%;margin-top:10px;background:rgba(75,171,247,0.08);color:var(--blue);border-color:rgba(75,171,247,0.3)">üìù –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–∞–∂–∏</button>';
  }
  html += '</div>';
  
  // CLIENT INFO (collapsed)
  html += '<details style="margin-bottom:12px"><summary style="padding:12px 16px;background:var(--bg3);border-radius:8px;cursor:pointer;font-size:13px;font-weight:600">üë§ –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞</summary>';
  html += '<div style="padding:12px;border:1px solid var(--border);border-top:0;border-radius:0 0 8px 8px;display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px">';
  html += '<div>üì± '+(dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'‚Äî')+'</div><div>üìç '+esc(dir['–ì–æ—Ä–æ–¥']||'‚Äî')+'</div>';
  html += '<div>üí∞ '+(Number(dir['–¶–µ–Ω–∞'])||0).toLocaleString('ru')+'‚ÇΩ</div><div>üí≥ '+(dir['–û–ø–ª–∞—á–µ–Ω–æ']?'‚úÖ':'‚è≥')+'</div>';
  html += '<div>üåê '+esc(dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'‚Äî')+'</div><div>üë§ '+esc(dir['–ú–µ–Ω–µ–¥–∂–µ—Ä']||'‚Äî')+'</div>';
  html += '</div>';
  if (p.canWrite) html += '<div style="padding:8px 12px;border:1px solid var(--border);border-top:0;border-radius:0 0 8px 8px"><button class="btn btn-sm btn-secondary" onclick="closeClientCard();openModal(\'direction\',\''+eid+'\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></div>';
  html += '</details>';
  
  // FINANCE PANEL (all steps except lead ‚Äî lead has its own inline)
  if (stage !== 'prospect') html += renderClientFinance(dir);
  
  // TASKS
  html += '<div class="card" style="padding:16px;margin-bottom:16px">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
  html += '<div style="font-size:13px;font-weight:700">üìã –ó–∞–¥–∞—á–∏ ('+activeTasks.length+')</div>';
  if (p.canWrite) html += '<button class="btn btn-sm btn-primary" onclick="closeClientCard();openModal(\'task\');setTimeout(()=>{const f=document.getElementById(\'field-–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ\');if(f)f.value=\''+ename+'\';},300)">‚ûï</button>';
  html += '</div>';
  if (activeTasks.length) {
    activeTasks.forEach(t => {
      const od = t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < td;
      const prC = t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']==='P1'?'var(--red)':t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']==='P2'?'var(--orange)':'var(--text2)';
      html += '<div style="padding:8px 10px;margin-bottom:4px;background:var(--bg3);border-radius:6px;border-left:3px solid '+prC+';cursor:pointer;font-size:12px" onclick="closeClientCard();openTaskDetail(\''+escA(t.ID||t.id)+'\')">';
      html += '<div style="font-weight:500">'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+'</div>';
      html += '<div style="display:flex;gap:8px;margin-top:2px;font-size:11px;color:var(--text2)">';
      if (t['–î–µ–¥–ª–∞–π–Ω']) html += '<span>üìÖ '+t['–î–µ–¥–ª–∞–π–Ω']+'</span>';
      if (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) html += '<span>üë§ '+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'])+'</span>';
      html += '</div></div>';
    });
  } else html += '<div style="text-align:center;padding:12px;color:var(--text2);font-size:12px">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div>';
  if (doneTasks.length) html += '<div style="margin-top:6px;font-size:11px;color:var(--text2)">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: '+doneTasks.length+'</div>';
  html += '</div></div>';
  
  const overlay = document.getElementById('client-card-overlay') || createClientCardOverlay();
  overlay.innerHTML = '<div class="client-card-panel" onclick="event.stopPropagation()">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid var(--border);background:var(--bg3)">' +
    '<div><h3 style="font-size:16px;font-weight:700;margin:0">'+esc(name)+'</h3><div style="font-size:11px;color:var(--text2);margin-top:2px">'+esc(dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'')+' ¬∑ '+esc(dir['–ì–æ—Ä–æ–¥']||'')+'</div></div>' +
    '<button onclick="closeClientCard()" style="background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer">‚úï</button>' +
    '</div>' + html + '</div>';
  overlay.style.display = 'flex';
  // Init compact anketa chat if on interest stage
  if (stage === 'interest') {
    setTimeout(() => renderAnketaChat(id, 'cc-anketa-chat-' + id, { compact: true }), 100);
  }
}

async function saveAnketa(id) {
  if (!id) { toast('–û—à–∏–±–∫–∞: ID –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
  // Unescape ID (from escA in onclick)
  const cleanId = id.replace(/\\'/g, "'").replace(/&quot;/g, '"');
  console.log('[RKT] saveAnketa called with id:', cleanId);

  const v = (sel) => { const el = document.getElementById(sel); return el ? el.value.trim() : ''; };
  const updates = {
    business_type: v('cc-biz-type') || null,
    services: v('cc-services') || null,
    phone: v('cc-phone') || null,
    city: v('cc-city') || null,
    comment: v('cc-wishes') || null,
    address: v('cc-address') || null,
    social: v('cc-social') || null,
    telegram_tag: v('cc-telegram') || null,
    work_hours: v('cc-hours') || null,
    prices: v('cc-prices') || null
  };
  // Also rebuild questionnaire JSON for AI site generation
  const questionnaire = JSON.stringify({
    biztype: v('cc-biz-type'), services: v('cc-services'), phone: v('cc-phone'),
    city: v('cc-city'), address: v('cc-address'), social: v('cc-social'),
    hours: v('cc-hours'), prices: v('cc-prices'), wishes: v('cc-wishes')
  });
  updates.questionnaire = questionnaire;

  // Remove null/undefined fields that don't exist in DB (avoid column-not-found errors)
  const safeUpdates = {};
  for (const [k, val] of Object.entries(updates)) {
    safeUpdates[k] = val;
  }
  console.log('[RKT] saveAnketa updates:', safeUpdates);

  try {
    // Try with cleaned ID first
    let { data, error } = await SB.from('directions').update(safeUpdates).eq('id', cleanId).select();

    // If no rows matched, try to find the real DB id from DATA
    if ((!data || data.length === 0) && !error) {
      const dir = (DATA.directions || []).find(d => (d['ID'] || d.id) === cleanId || (d['ID'] || d.id) === id);
      if (dir) {
        const realId = dir['ID'] || dir.id || dir._dbId;
        if (realId && realId !== cleanId) {
          console.log('[RKT] saveAnketa: retrying with realId from DATA:', realId);
          ({ data, error } = await SB.from('directions').update(safeUpdates).eq('id', realId).select());
        }
      }
    }

    if (error) {
      // Check if error is about missing columns
      if (error.message && error.message.includes('column')) {
        console.error('[RKT] saveAnketa column error ‚Äî need SQL migration:', error.message);
        toast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ë–î: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∞. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é (–¥–æ–±–∞–≤—å—Ç–µ –∫–æ–ª–æ–Ω–∫–∏ address, social, work_hours, prices, questionnaire –≤ —Ç–∞–±–ª–∏—Ü—É directions).', 'error');
      } else {
        throw error;
      }
      return;
    }
    if (!data || data.length === 0) {
      console.warn('[RKT] saveAnketa: no rows updated for id:', cleanId);
      toast('‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (ID=' + cleanId + '). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'warning');
      return;
    }
    toast('‚úÖ –ê–Ω–∫–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
    await loadData();
  } catch(e) {
    console.error('saveAnketa error:', e);
    toast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message, 'error');
  }
}

async function uploadAnketaFile(dirId, type, input) {
  const files = input.files;
  if (!files || !files.length) return;

  toast('–ó–∞–≥—Ä—É–∑–∫–∞...', 'info');
  try {
    if (type === 'logo') {
      const file = files[0];
      const ext = file.name.split('.').pop();
      const path = 'anketa/' + dirId + '/logo.' + ext;
      const { error } = await SB.storage.from('sites').upload(path, file, { contentType: file.type, upsert: true });
      if (error) throw error;
      const { data: urlData } = SB.storage.from('sites').getPublicUrl(path);
      await SB.from('directions').update({ logo_url: urlData.publicUrl }).eq('id', dirId);
      toast('–õ–æ–≥–æ—Ç–∏–ø –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
    } else if (type === 'photos') {
      const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === dirId);
      let photos = [];
      try { photos = JSON.parse(dir['photos'] || '[]'); } catch(e) {}
      const remaining = 5 - photos.length;
      const toUpload = Array.from(files).slice(0, remaining);
      for (const file of toUpload) {
        const ext = file.name.split('.').pop();
        const path = 'anketa/' + dirId + '/photo_' + Date.now() + '_' + Math.random().toString(36).slice(2,6) + '.' + ext;
        const { error } = await SB.storage.from('sites').upload(path, file, { contentType: file.type, upsert: true });
        if (error) throw error;
        const { data: urlData } = SB.storage.from('sites').getPublicUrl(path);
        photos.push(urlData.publicUrl);
      }
      await SB.from('directions').update({ photos: JSON.stringify(photos) }).eq('id', dirId);
      toast(toUpload.length + ' —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
    }
    await loadData();
    renderSubprojectView();
  } catch(e) {
    console.error('Upload error:', e);
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (e.message||e), 'error');
  }
}

async function removeAnketaFile(dirId, type) {
  try {
    if (type === 'logo') {
      await SB.from('directions').update({ logo_url: null }).eq('id', dirId);
      toast('–õ–æ–≥–æ—Ç–∏–ø —É–¥–∞–ª—ë–Ω', 'success');
    }
    await loadData();
    renderSubprojectView();
  } catch(e) {
    toast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
}

async function removeAnketaPhoto(dirId, index) {
  try {
    const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === dirId);
    let photos = [];
    try { photos = JSON.parse(dir['photos'] || '[]'); } catch(e) {}
    photos.splice(index, 1);
    await SB.from('directions').update({ photos: JSON.stringify(photos) }).eq('id', dirId);
    toast('–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
    await loadData();
    renderSubprojectView();
  } catch(e) {
    toast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
}

// ============================================================
// ANKETA AI CHAT SYSTEM ‚Äî per-direction AI agent
// ============================================================
const anketaChatCache = new Map(); // Map<dirId, Message[]>
let _anketaPendingFiles = []; // files queued for next send
let _anketaSummaryOpen = new Set();
let _anketaSubMode = new Map(); // Map<dirId, 'ai'|'manual'> ‚Äî which sub-tab is active
let _anketaSending = null; // dirId if AI request in flight, prevents renderAll from destroying DOM
let _uiInputActive = false; // true when user is focused on anketa input, prevents DOM rebuild

function getAnketaSubMode(dirId) { return _anketaSubMode.get(dirId) || 'ai'; }

async function loadAnketaChat(dirId) {
  if (anketaChatCache.has(dirId)) return anketaChatCache.get(dirId);
  try {
    const { data, error } = await SB.from('anketa_chat').select('*').eq('direction_id', dirId).order('created_at', { ascending: true });
    if (error) throw error;
    const msgs = (data || []).map(r => ({
      id: r.id, role: r.role, content: r.content,
      media_urls: r.media_urls || [], extracted_data: r.extracted_data || {},
      created_at: r.created_at
    }));
    anketaChatCache.set(dirId, msgs);
    return msgs;
  } catch(e) {
    console.error('loadAnketaChat error:', e);
    anketaChatCache.set(dirId, []);
    return [];
  }
}

async function saveAnketaChatMsg(dirId, role, content, mediaUrls, extractedData) {
  const msg = { direction_id: dirId, role, content, media_urls: mediaUrls || [], extracted_data: extractedData || {} };
  // Add to cache FIRST (before Supabase write) ‚Äî so if renderAll fires during write, data is in cache
  const local = { id: 'local_' + Date.now(), role, content, media_urls: mediaUrls || [], extracted_data: extractedData || {}, created_at: new Date().toISOString() };
  const cache = anketaChatCache.get(dirId) || [];
  cache.push(local);
  anketaChatCache.set(dirId, cache);
  try {
    const { data, error } = await SB.from('anketa_chat').insert(msg).select();
    if (error) throw error;
    const saved = data?.[0];
    // Update local entry with real ID from Supabase
    if (saved?.id) local.id = saved.id;
    if (saved?.created_at) local.created_at = saved.created_at;
    return local;
  } catch(e) {
    console.error('saveAnketaChatMsg error:', e);
    // local already added to cache above, just return it
    return local;
  }
}

function getAnketaDir(dirId) {
  return (DATA.directions || []).find(d => (d['ID'] || d.id) === dirId);
}

function getAnketaQuestionnaire(dir) {
  if (!dir) return {};
  try {
    const q = JSON.parse(dir['–ê–Ω–∫–µ—Ç–∞'] || dir.questionnaire || '{}');
    return q && typeof q === 'object' ? q : {};
  } catch(e) { return {}; }
}

function mergeQuestionnaire(existing, newData) {
  const merged = JSON.parse(JSON.stringify(existing));
  merged._version = 2;
  merged._last_updated = new Date().toISOString();
  for (const [section, fields] of Object.entries(newData)) {
    if (section.startsWith('_')) { merged[section] = fields; continue; }
    if (typeof fields === 'object' && fields !== null && !Array.isArray(fields)) {
      if (!merged[section]) merged[section] = {};
      for (const [k, v] of Object.entries(fields)) {
        if (v !== null && v !== undefined && v !== '') merged[section][k] = v;
      }
    } else {
      merged[section] = fields;
    }
  }
  return merged;
}

// Resize image on client before upload (Claude API max 1568px, 5MB)
function resizeImageFile(file, maxDim = 1568, quality = 0.85) {
  return new Promise((resolve) => {
    // Skip non-images and small files (< 1MB)
    if (!file.type.startsWith('image/') || file.size < 1024 * 1024) {
      return resolve(file);
    }
    // Skip GIF/SVG
    if (file.type === 'image/gif' || file.type === 'image/svg+xml') {
      return resolve(file);
    }
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);
      let { width, height } = img;
      // Already small enough?
      if (width <= maxDim && height <= maxDim && file.size < 3 * 1024 * 1024) {
        return resolve(file);
      }
      // Calculate new dimensions
      if (width > height) {
        if (width > maxDim) { height = Math.round(height * maxDim / width); width = maxDim; }
      } else {
        if (height > maxDim) { width = Math.round(width * maxDim / height); height = maxDim; }
      }
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      canvas.toBlob(blob => {
        if (blob && blob.size < file.size) {
          const resized = new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' });
          console.log('Resized image:', file.name, (file.size / 1024 / 1024).toFixed(1) + 'MB ‚Üí', (resized.size / 1024 / 1024).toFixed(1) + 'MB', width + 'x' + height);
          resolve(resized);
        } else {
          resolve(file); // Original is smaller, keep it
        }
      }, 'image/jpeg', quality);
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      resolve(file); // Fallback: return original
    };
    img.src = url;
  });
}

async function uploadAnketaMediaFiles(dirId, files) {
  const urls = [];
  for (let file of files) {
    // Resize images before upload (for Claude Vision: max 1568px)
    file = await resizeImageFile(file, 1568, 0.85);
    const ext = file.name.split('.').pop().toLowerCase();
    const isVideo = file.type.startsWith('video/');
    const isImage = file.type.startsWith('image/');
    const prefix = isVideo ? 'video' : isImage ? 'photo' : 'file';
    const path = 'anketa/' + dirId + '/' + prefix + '_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6) + '.' + ext;
    try {
      const { error } = await SB.storage.from('sites').upload(path, file, { contentType: file.type, upsert: true });
      if (error) throw error;
      const { data: urlData } = SB.storage.from('sites').getPublicUrl(path);
      urls.push({ url: urlData.publicUrl, type: isVideo ? 'video' : isImage ? 'image' : 'file', name: file.name });
    } catch(e) {
      console.error('Upload media error:', e);
      toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ' + file.name, 'error');
    }
  }
  return urls;
}

function attachAnketaMedia(dirId) {
  const input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  input.accept = 'image/*,video/*,.pdf,.doc,.docx';
  input.onchange = () => {
    const files = Array.from(input.files || []).slice(0, 5);
    _anketaPendingFiles = files;
    renderAnketaMediaPreview(dirId);
  };
  input.click();
}

function renderAnketaMediaPreview(dirId) {
  const container = document.getElementById('anketa-media-preview-' + dirId);
  if (!container) return;
  if (!_anketaPendingFiles.length) { container.innerHTML = ''; return; }
  let html = '';
  _anketaPendingFiles.forEach((f, i) => {
    html += '<div class="preview-item">';
    if (f.type.startsWith('image/')) {
      const url = URL.createObjectURL(f);
      html += '<img src="' + url + '" alt="' + escA(f.name) + '">';
    } else {
      html += '<div style="width:50px;height:50px;background:var(--bg3);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:18px;border:1px solid var(--border)">üìÑ</div>';
    }
    html += '<button class="remove-btn" onclick="_anketaPendingFiles.splice(' + i + ',1);renderAnketaMediaPreview(\'' + escA(dirId) + '\')">√ó</button>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function buildAnketaSystemPrompt(dir, questionnaire) {
  const name = dir?.['–ù–∞–∑–≤–∞–Ω–∏–µ'] || dir?.['name'] || '–ö–ª–∏–µ–Ω—Ç';
  const bizType = dir?.['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || dir?.['–û–ø–∏—Å–∞–Ω–∏–µ'] || questionnaire?.business_info?.type || '';
  const stage = dir?.['stage'] || 'prospect';
  const siteType = dir?.['–¢–∏–ø —Å–∞–π—Ç–∞'] || '';
  const price = dir?.['–¶–µ–Ω–∞'] || '';
  return '–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∞–π—Ç–∞. –¢—ã –æ–±—â–∞–µ—à—å—Å—è —Å –ú–ï–ù–ï–î–ñ–ï–†–û–ú, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞.\n\n' +
    '–ö–õ–ò–ï–ù–¢: ' + name + '\n' +
    '–¢–ò–ü –ë–ò–ó–ù–ï–°–ê: ' + (bizType || '–ø–æ–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + '\n' +
    '–¢–ò–ü –°–ê–ô–¢–ê: ' + (siteType || '–Ω–µ –≤—ã–±—Ä–∞–Ω') + (price ? ' (' + price + '‚ÇΩ)' : '') + '\n' +
    '–¢–ï–ö–£–©–ò–ô –≠–¢–ê–ü: ' + stage + '\n' +
    '–°–û–ë–†–ê–ù–ù–´–ï –î–ê–ù–ù–´–ï: ' + JSON.stringify(questionnaire) + '\n\n' +
    '## –¢–í–û–ò –ó–ê–î–ê–ß–ò:\n' +
    '1. –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –í–°–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∞–π—Ç–∞\n' +
    '2. –ê–¥–∞–ø—Ç–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥ —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞ (—Å–≤–∞–¥—å–±–∞ ‚â† —Ä–µ—Å—Ç–æ—Ä–∞–Ω ‚â† —Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã ‚â† —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è)\n' +
    '3. –ó–∞–¥–∞–≤–∞–π 1-2 –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑, –Ω–µ –¥–ª–∏–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏\n' +
    '4. –ö–æ–≥–¥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –§–û–¢–û–ì–†–ê–§–ò–ò ‚Äî —Ç—ã –í–ò–î–ò–®–¨ –∏—Ö! –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:\n' +
    '   - –§–æ—Ç–æ –º–µ–Ω—é: —Ä–∞—Å–ø–æ–∑–Ω–∞–π –í–°–ï –±–ª—é–¥–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ü–µ–Ω—ã, –≥—Ä–∞–º–º–æ–≤–∫–∏\n' +
    '   - –§–æ—Ç–æ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞: –æ–ø–∏—à–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É, —Å—Ç–∏–ª—å, —Ü–≤–µ—Ç–æ–≤—É—é –ø–∞–ª–∏—Ç—Ä—É –¥–ª—è –¥–∏–∑–∞–π–Ω–∞ —Å–∞–π—Ç–∞\n' +
    '   - –§–æ—Ç–æ –≤—ã–≤–µ—Å–æ–∫: –ø—Ä–æ—á–∏—Ç–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ, –∞–¥—Ä–µ—Å, —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã\n' +
    '   - –§–æ—Ç–æ –≤–∏–∑–∏—Ç–æ–∫: –∏–∑–≤–ª–µ–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã (—Ç–µ–ª–µ—Ñ–æ–Ω, email, —Å–æ—Ü—Å–µ—Ç–∏)\n' +
    '   - –°–∫—Ä–∏–Ω—à–æ—Ç—ã –ø–µ—Ä–µ–ø–∏—Å–æ–∫: –∏–∑–≤–ª–µ–∫–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\n' +
    '   –ò–∑–≤–ª–µ–∫–∞–π –ú–ê–ö–°–ò–ú–£–ú –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ —Ñ–æ—Ç–æ –∏ —Å—Ä–∞–∑—É –∑–∞–ø–æ–ª–Ω—è–π –ø–æ–ª—è –∞–Ω–∫–µ—Ç—ã!\n' +
    '5. –ö–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–µ ‚Äî –æ–±–Ω–æ–≤–ª—è–π\n' +
    '6. –ö–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç —Å–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç (–ö–ü, –¥–æ–≥–æ–≤–æ—Ä) ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç. –î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏: –û–û–û –†–ö–¢ (–≤–µ–±-—Å—Ç—É–¥–∏—è). –¶–µ–Ω—ã: –í–∏–∑–∏—Ç–∫–∞ 5000‚ÇΩ, –õ–µ–Ω–¥–∏–Ω–≥ 10000‚ÇΩ, –ö–∞—Ç–∞–ª–æ–≥ 15000‚ÇΩ, –ü—Ä–µ–º–∏—É–º 25000‚ÇΩ\n' +
    '7. –ö–æ–≥–¥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–æ–±—â–∞–µ—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ ("–ø–æ–∑–≤–æ–Ω–∏–ª", "—Å–æ–≥–ª–∞—Å–∏–ª—Å—è", "–æ–ø–ª–∞—Ç–∏–ª") ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø\n\n' +
    '## –ù–ï–û–ë–•–û–î–ò–ú–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:\n' +
    '- –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞, —Ç–∏–ø, –≥–æ—Ä–æ–¥, –∞–¥—Ä–µ—Å\n' +
    '- –¢–µ–ª–µ—Ñ–æ–Ω, —Å–æ—Ü—Å–µ—Ç–∏, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã\n' +
    '- –£—Å–ª—É–≥–∏/–º–µ–Ω—é —Å —Ü–µ–Ω–∞–º–∏, –æ–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ (150+ —Å–ª–æ–≤ –∏–¥–µ–∞–ª—å–Ω–æ)\n' +
    '- –ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –¥–∏–∑–∞–π–Ω—É (—Ç–µ–º–∞, —Å—Ç–∏–ª—å, —Ü–≤–µ—Ç–∞, —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã)\n' +
    '- –õ–æ–≥–æ—Ç–∏–ø –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏\n\n' +
    '## –î–õ–Ø –°–ü–ï–¶–ò–§–ò–ß–ù–´–• –¢–ò–ü–û–í –ë–ò–ó–ù–ï–°–ê:\n' +
    '- –°–≤–∞–¥—å–±–∞: –∏–º–µ–Ω–∞, –¥–∞—Ç–∞ —Å–≤–∞–¥—å–±—ã, –º–µ—Å—Ç–æ, –∏—Å—Ç–æ—Ä–∏—è, —Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞\n' +
    '- –†–µ—Å—Ç–æ—Ä–∞–Ω/–ö–∞—Ñ–µ: –º–µ–Ω—é, –¥–æ—Å—Ç–∞–≤–∫–∞, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞\n' +
    '- –°–∞–ª–æ–Ω/–ë–∞—Ä–±–µ—Ä: —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é, –º–∞—Å—Ç–µ—Ä–∞, –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ\n' +
    '- –ú–µ–¥–∏—Ü–∏–Ω–∞: —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –≤—Ä–∞—á–∏, —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã\n' +
    '- –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ: —Ä–∞–±–æ—Ç—ã, –Ω–∞–≤—ã–∫–∏, –±–∏–æ–≥—Ä–∞—Ñ–∏—è, –æ—Ç–∑—ã–≤—ã\n\n' +
    '## –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:\n' +
    '–í –ö–ê–ñ–î–û–ú –æ—Ç–≤–µ—Ç–µ –≤–∫–ª—é—á–∞–π JSON –±–ª–æ–∫ (—Å–∫—Ä—ã—Ç—ã–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):\n' +
    '```json\n{"extracted":{"business_info":{"type":"..."},"contact":{"phone":"..."},"content":{"services":"..."},"design":{},"media":{},"custom":{}},"completeness":0.35,"stage_suggestion":null,"file_action":null}\n```\n\n' +
    'extracted ‚Äî —Ç–æ–ª—å–∫–æ –ù–û–í–´–ï –∏–ª–∏ –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –¥–∞–Ω–Ω—ã–µ (–Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π —É–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ)\n' +
    'completeness ‚Äî –æ—Ç 0.0 –¥–æ 1.0, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –∞–Ω–∫–µ—Ç–∞\n' +
    'stage_suggestion ‚Äî ID —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç—Ç–∞–ø–∞ –µ—Å–ª–∏ –ø–æ—Ä–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å (prospect‚Üícontact‚Üíinterest‚Üíproto‚Üíproposal‚Üínegotiation‚Üípayment‚Üídone), –∏–ª–∏ null\n' +
    'file_action ‚Äî –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–ø—Ä–æ—Å–∏–ª —Å–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç: {"type":"proposal|contract|pricelist|brief","content":"–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞"}, –∏–Ω–∞—á–µ null\n\n' +
    '## –ü–†–ê–í–ò–õ–ê:\n' +
    '- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º\n' +
    '- –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –Ω–æ —Ç—â–∞—Ç–µ–ª—å–Ω—ã–º\n' +
    '- JSON –±–ª–æ–∫ –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ\n' +
    '- –î–ª—è file_action.content ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–π –ü–û–õ–ù–´–ô –≥–æ—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞\n' +
    '- –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Å–∏—Ç —Å–æ–∑–¥–∞—Ç—å/—Å–¥–µ–ª–∞—Ç—å/–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ö–ü, –¥–æ–≥–æ–≤–æ—Ä, –ø—Ä–∞–π—Å, –±—Ä–∏—Ñ –∏–ª–∏ –ª—é–±–æ–π –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–µ—Ä–Ω–∏ file_action —Å type –∏ content. –ù–µ –æ–ø–∏—Å—ã–≤–∞–π –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–º ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è!\n' +
    '- –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Å–∏—Ç "—Å–¥–µ–ª–∞–π —Å–∞–π—Ç" –∏–ª–∏ "—Å–æ–∑–¥–∞–π —Å–∞–π—Ç" ‚Äî —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é HTML —Å–∞–π—Ç–∞, –≤–µ—Ä–Ω–∏ file_action —Å type:"site" –∏ content —Å –ø–æ–ª–Ω—ã–º HTML –∫–æ–¥–æ–º';
}

function parseAnketaAIResponse(text) {
  let visibleText = text;
  let extracted = null;
  let completeness = null;
  let stageSuggestion = null;
  let fileAction = null;
  const jsonMatch = text.match(/```json\s*([\s\S]*?)```/);
  if (jsonMatch) {
    try {
      const parsed = JSON.parse(jsonMatch[1]);
      extracted = parsed.extracted || null;
      completeness = typeof parsed.completeness === 'number' ? parsed.completeness : null;
      stageSuggestion = parsed.stage_suggestion || null;
      fileAction = parsed.file_action || null;
    } catch(e) { console.warn('Anketa JSON parse failed:', e); }
    visibleText = text.replace(/```json[\s\S]*?```/g, '').trim();
  }
  return { visibleText, extracted, completeness, stageSuggestion, fileAction };
}

async function sendAnketaMsg(dirId) {
  const input = document.getElementById('anketa-input-' + dirId);
  if (!input) return;
  const text = input.value.trim();
  if (!text && !_anketaPendingFiles.length) return;
  input.value = '';
  input.disabled = true;
  const sendBtn = document.getElementById('anketa-send-' + dirId);
  if (sendBtn) sendBtn.disabled = true;

  // SET FLAG: prevent renderAll() from destroying anketa DOM during async operations
  _anketaSending = dirId;

  const dir = getAnketaDir(dirId);
  const questionnaire = getAnketaQuestionnaire(dir);

  // Upload pending files
  let mediaUrls = [];
  if (_anketaPendingFiles.length) {
    toast('üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...', 'info');
    mediaUrls = await uploadAnketaMediaFiles(dirId, _anketaPendingFiles);
    _anketaPendingFiles = [];
    renderAnketaMediaPreview(dirId);
  }

  // Build content with media references
  let fullContent = text;
  if (mediaUrls.length) {
    fullContent += '\n\n[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ: ' + mediaUrls.map(m => m.name + ' (' + m.type + ')').join(', ') + ']';
  }

  // Save user message
  await saveAnketaChatMsg(dirId, 'user', fullContent, mediaUrls, {});
  appendAnketaMsgToDOM(dirId, 'user', text, mediaUrls);

  // Show typing indicator
  const msgsContainer0 = document.getElementById('anketa-msgs-' + dirId);
  if (msgsContainer0) {
    const typing = document.createElement('div');
    typing.className = 'anketa-msg system';
    typing.id = 'anketa-typing-' + dirId;
    typing.innerHTML = '<div class="ai-loading"><span></span><span></span><span></span></div>';
    msgsContainer0.appendChild(typing);
    msgsContainer0.scrollTop = msgsContainer0.scrollHeight;
  }

  try {
    // Prepare history for AI (previous photos referenced as text, not re-sent)
    const chatHistory = (anketaChatCache.get(dirId) || []).slice(-20).map(m => {
      let c = String(m.content).slice(0, 3000);
      // For old user messages with media, replace URLs with short text references
      if (m.media_urls && Array.isArray(m.media_urls) && m.media_urls.length) {
        const names = m.media_urls.map(mu => mu.name || '—Ñ–∞–π–ª').join(', ');
        if (!c.includes('[–ë—ã–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã')) {
          c += '\n[–ë—ã–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã —Ñ–æ—Ç–æ: ' + names + ']';
        }
      }
      return { role: m.role === 'user' ? 'user' : 'assistant', content: c };
    });

    // Build system prompt
    const systemPrompt = buildAnketaSystemPrompt(dir, questionnaire);

    // Check if this looks like a document/content generation request (need more tokens + longer timeout)
    const lowerText = (text || '').toLowerCase();
    const isFileRequest = /(?:—Å–æ–∑–¥–∞–π|—Å–¥–µ–ª–∞–π|—Å–¥–µ–ª–∞–µ–º|–ø–æ–¥–≥–æ—Ç–æ–≤—å|–ø–æ–¥–≥–æ—Ç–æ–≤–∏–º|—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π|–Ω–∞–ø–∏—à–∏|–Ω–∞–ø–∏—à–µ–º|—Å–æ—Å—Ç–∞–≤—å|—Å–æ—Å—Ç–∞–≤–∏–º|–æ—Ñ–æ—Ä–º–∏|—Å—Ñ–æ—Ä–º–∏—Ä—É–π|–¥–∞–≤–∞–π\s+(?:—Å–¥–µ–ª–∞–µ–º|–ø–æ–¥–≥–æ—Ç–æ–≤–∏–º|–Ω–∞–ø–∏—à–µ–º|—Å–æ—Å—Ç–∞–≤–∏–º|–Ω–∞–ø–∏—à–∏))[^.]{0,40}(?:–∫–ø|–¥–æ–≥–æ–≤–æ—Ä|–ø—Ä–∞–π—Å|–±—Ä–∏—Ñ|–∫–æ–Ω—Ç—Ä–∞–∫—Ç|–¥–æ–∫—É–º–µ–Ω—Ç|–ø—Ä–µ–¥–ª–æ–∂–µ–Ω|–∫–æ–º–º–µ—Ä—á–µ—Å–∫|—Å–∞–π—Ç|—Ç–µ–∫—Å—Ç|–ø–∏—Å—å–º|–æ–ø–∏—Å–∞–Ω|–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü|—Å–º–µ—Ç|—Å–∫—Ä–∏–ø—Ç|—Å–æ–æ–±—â–µ–Ω)/i.test(lowerText)
      || /(?:–Ω–∞–ø–∏—à–∏|—Å–æ—Å—Ç–∞–≤—å|–ø–æ–¥–≥–æ—Ç–æ–≤—å|—Å–¥–µ–ª–∞–π|–æ—Ñ–æ—Ä–º–∏|–¥–∞–≤–∞–π)[^.]{0,20}(?:—Ç–µ–∫—Å—Ç|–ø–∏—Å—å–º|–∫–ø|–ø—Ä–µ–¥–ª–æ–∂–µ–Ω|–∏—Ç–µ–∫—Å—Ç)/i.test(lowerText);

    // Send to AI ‚Äî try cascade (fast Groq/Gemini) first for simple messages
    const hasMedia = mediaUrls.length > 0;
    const needsClaude = hasMedia || isFileRequest;
    let aiText = '';
    let aiProvider = 'claude';

    if (!needsClaude) {
      try {
        const cascadeMsgs = chatHistory.slice(-10).concat([{ role: 'user', content: fullContent }]);
        const cascadeResult = await sendCascadeChat(cascadeMsgs, systemPrompt);
        if (cascadeResult && cascadeResult.text) {
          aiText = cascadeResult.text;
          aiProvider = cascadeResult.provider || 'groq';
        }
      } catch(e) { console.warn('Cascade failed, falling back to Claude:', e.message); }
    }

    // Fallback to Claude via n8n (for media, file requests, or cascade failure)
    if (!aiText) {
      aiProvider = 'claude';
      const baseTimeout = isFileRequest ? 150000 : hasMedia ? 120000 : 90000;
      const requestBody = JSON.stringify({
        message: fullContent,
        context: 'anketa',
        source: 'web',
        direction: dir?.['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '',
        directionId: dirId,
        user: USER?.name || '',
        questionnaire: questionnaire,
        stage: dir?.['stage'] || 'prospect',
        history: chatHistory,
        media: mediaUrls,
        systemPrompt: systemPrompt,
        isFileRequest: isFileRequest
      });

      // Try up to 2 attempts (auto-retry on timeout)
      for (let attempt = 1; attempt <= 2; attempt++) {
        try {
          const controller = new AbortController();
          const attemptTimeout = attempt === 1 ? baseTimeout : baseTimeout + 60000;
          const timeout = setTimeout(() => controller.abort(), attemptTimeout);
          const response = await fetch(CONFIG.AI_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: requestBody,
            signal: controller.signal
          });
          clearTimeout(timeout);
          if (!response.ok) throw new Error('HTTP ' + response.status);

          const raw = await response.json();
          let data = raw;
          if (Array.isArray(raw)) data = raw[0] || {};
          if (data.json) data = data.json;
          aiText = data.reply || data.response || data.text || data.message || '';
          if (!aiText && data.content) { try { aiText = data.content[0].text; } catch(e) {} }
          if (aiText) break; // Success ‚Äî exit retry loop
        } catch(retryErr) {
          const isTimeout = retryErr.name === 'AbortError' || (retryErr.message && retryErr.message.includes('abort'));
          if (attempt < 2 && isTimeout) {
            console.warn('AI attempt ' + attempt + ' timed out, retrying with longer timeout...');
            // Update typing indicator to show retry
            const typingRetry = document.getElementById('anketa-typing-' + dirId);
            if (typingRetry) typingRetry.innerHTML = '<div class="ai-loading"><span></span><span></span><span></span></div> <span style="font-size:11px;color:var(--text3)">–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...</span>';
            continue;
          }
          throw retryErr; // Re-throw on final attempt or non-timeout error
        }
      }
    }
    if (!aiText) aiText = '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';

    // Parse AI response
    const parsed = parseAnketaAIResponse(aiText);

    // Update questionnaire if extracted data present
    if (parsed.extracted && Object.keys(parsed.extracted).length) {
      const updated = mergeQuestionnaire(questionnaire, parsed.extracted);
      if (parsed.completeness !== null) updated._completeness = parsed.completeness;
      const dbId = dir?.['ID'] || dir?.id || dirId;
      await SB.from('directions').update({
        questionnaire: JSON.stringify(updated),
        anketa_completeness: parsed.completeness || dir?.anketa_completeness || 0
      }).eq('id', dbId);
      // Update local data
      if (dir) {
        dir['–ê–Ω–∫–µ—Ç–∞'] = JSON.stringify(updated);
        dir.anketa_completeness = parsed.completeness || 0;
      }
    } else if (parsed.completeness !== null) {
      const dbId = dir?.['ID'] || dir?.id || dirId;
      await SB.from('directions').update({ anketa_completeness: parsed.completeness }).eq('id', dbId);
      if (dir) dir.anketa_completeness = parsed.completeness;
    }

    // Save assistant message (adds to cache BEFORE Supabase write)
    // Include fileAction and stageSuggestion in extracted_data so buttons survive re-render from cache
    const extractedForSave = Object.assign({}, parsed.extracted || {});
    if (parsed.fileAction) extractedForSave._fileAction = parsed.fileAction;
    if (parsed.stageSuggestion) extractedForSave._stageSuggestion = parsed.stageSuggestion;
    await saveAnketaChatMsg(dirId, 'assistant', parsed.visibleText, [], extractedForSave);

    // Remove typing indicator (re-query DOM ‚Äî it may have been recreated)
    const typingEl = document.getElementById('anketa-typing-' + dirId);
    if (typingEl) typingEl.remove();

    // Render assistant message ‚Äî with DOM existence check + fallback
    const providerBadge = getAiProviderBadge(aiProvider);
    const displayText = parsed.visibleText + (providerBadge ? '\n' + providerBadge : '');
    const msgsContainer = document.getElementById('anketa-msgs-' + dirId);
    if (msgsContainer) {
      appendAnketaMsgToDOM(dirId, 'assistant', displayText, [], parsed.stageSuggestion, parsed.fileAction);
    } else {
      // Container was destroyed by renderAll ‚Äî full re-render from cache
      const chatContainer = document.getElementById('anketa-chat-container-' + dirId);
      if (chatContainer) {
        renderAnketaChat(dirId, 'anketa-chat-container-' + dirId, {});
      }
    }

    // Update completeness bar
    updateAnketaCompletenessBar(dirId, parsed.completeness);

  } catch(e) {
    console.error('sendAnketaMsg error:', e);
    const typingEl = document.getElementById('anketa-typing-' + dirId);
    if (typingEl) typingEl.remove();
    const isAbort = e.name === 'AbortError' || (e.message && e.message.includes('abort'));
    const errMsg = isAbort
      ? '‚è± –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.'
      : '–û—à–∏–±–∫–∞: ' + (e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å AI');
    appendAnketaMsgToDOM(dirId, 'system', errMsg);
  }

  // CLEAR FLAG: allow renderAll() again
  _anketaSending = null;

  // Re-query DOM elements (they may have been recreated by renderAll)
  const newInput = document.getElementById('anketa-input-' + dirId);
  const newBtn = document.getElementById('anketa-send-' + dirId);
  if (newInput) { newInput.disabled = false; newInput.focus(); }
  if (newBtn) newBtn.disabled = false;
}

function _formatAnketaText(text) {
  if (!text) return '';
  return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
             .replace(/\n/g, '<br>')
             .replace(/`([^`]+)`/g, '<code style="background:var(--bg3);padding:1px 4px;border-radius:3px;font-size:12px">$1</code>');
}

function _renderAnketaMedia(mediaUrls) {
  if (!mediaUrls || !mediaUrls.length) return '';
  let html = '<div class="media-grid">';
  mediaUrls.forEach(m => {
    if (m.type === 'image') {
      html += '<img class="media-thumb" src="' + esc(m.url) + '" alt="' + escA(m.name) + '" onclick="window.open(\'' + escA(m.url) + '\',\'_blank\')">';
    } else if (m.type === 'video') {
      html += '<div style="display:inline-flex;align-items:center;gap:4px;padding:6px 10px;background:var(--bg3);border-radius:6px;font-size:11px">üé¨ <a href="' + esc(m.url) + '" target="_blank" style="color:var(--purple)">' + esc(m.name) + '</a></div>';
    } else {
      html += '<div style="display:inline-flex;align-items:center;gap:4px;padding:6px 10px;background:var(--bg3);border-radius:6px;font-size:11px">üìÑ <a href="' + esc(m.url) + '" target="_blank" style="color:var(--purple)">' + esc(m.name) + '</a></div>';
    }
  });
  html += '</div>';
  return html;
}

function appendAnketaMsgToDOM(dirId, role, text, mediaUrls, stageSuggestion, fileAction, skipTypewriter) {
  const container = document.getElementById('anketa-msgs-' + dirId);
  if (!container) return;
  const div = document.createElement('div');
  div.className = 'anketa-msg ' + role;

  const mediaHtml = _renderAnketaMedia(mediaUrls);
  const hasSpecialContent = stageSuggestion || (fileAction && fileAction.content);

  // TYPEWRITER for new assistant messages (not for history replay or special content)
  if (role === 'assistant' && text && !hasSpecialContent && !skipTypewriter) {
    div.innerHTML = mediaHtml + '<span class="anketa-typewriter"></span><span class="anketa-cursor">‚ñä</span>';
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;

    const formatted = _formatAnketaText(text);
    // Split into chunks preserving HTML tags
    const chunks = formatted.split(/(\s+|<br>|<[^>]+>)/g).filter(s => s.length > 0);
    const tw = div.querySelector('.anketa-typewriter');
    const cursor = div.querySelector('.anketa-cursor');
    let idx = 0;

    const typeInterval = setInterval(() => {
      if (idx >= chunks.length || !document.contains(div)) {
        clearInterval(typeInterval);
        if (cursor && document.contains(cursor)) cursor.remove();
        return;
      }
      // Add 3 chunks per tick (30ms x 3 = visually smooth but fast)
      const batch = chunks.slice(idx, idx + 3).join('');
      tw.innerHTML += batch;
      idx += 3;
      container.scrollTop = container.scrollHeight;
    }, 30);

    return; // typewriter handles rendering
  }

  // Standard render for user, system, history, or special content
  let html = mediaHtml;
  html += _formatAnketaText(text);

  // Stage suggestion button
  if (stageSuggestion) {
    const stageObj = (typeof STAGES !== 'undefined' ? STAGES : []).find(s => s.id === stageSuggestion);
    const stageName = stageObj ? stageObj.name : stageSuggestion;
    html += '<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">';
    html += '<button class="anketa-stage-btn accept" onclick="anketaAcceptStage(\'' + escA(dirId) + '\',\'' + escA(stageSuggestion) + '\')">‚úÖ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ —ç—Ç–∞–ø ¬´' + esc(stageName) + '¬ª</button>';
    html += '<button class="anketa-stage-btn decline" onclick="this.parentElement.style.display=\'none\'">‚ùå –ü–æ–∫–∞ –Ω–µ—Ç</button>';
    html += '</div>';
  }

  // File action (generated document)
  if (fileAction && fileAction.content) {
    const typeNames = { proposal: '–ö–ü', contract: '–î–æ–≥–æ–≤–æ—Ä', pricelist: '–ü—Ä–∞–π—Å-–ª–∏—Å—Ç', brief: '–ë—Ä–∏—Ñ', site: '–°–∞–π—Ç (HTML)' };
    const typeName = typeNames[fileAction.type] || '–î–æ–∫—É–º–µ–Ω—Ç';
    html += '<div class="file-card">';
    html += '<span>üìÑ ' + esc(typeName) + '</span>';
    html += '<div class="file-actions">';
    html += '<button onclick="downloadAnketaFile(\'' + escA(dirId) + '\',\'' + escA(fileAction.type || 'doc') + '\')">üíæ –°–∫–∞—á–∞—Ç—å</button>';
    html += '<button onclick="saveAnketaFileToDocuments(\'' + escA(dirId) + '\',\'' + escA(fileAction.type || 'doc') + '\')">üì§ –í –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>';
    if (fileAction.type === 'site') {
      html += '<button onclick="publishSiteFromAnketa(\'' + escA(dirId) + '\')">üîó –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>';
    }
    html += '</div></div>';
    // Site preview iframe
    if (fileAction.type === 'site') {
      html += '<div class="anketa-site-preview">';
      html += '<div class="anketa-site-preview-header">';
      html += '<span>üëÅ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–∞–π—Ç–∞</span>';
      html += '<div class="anketa-preview-devices">';
      html += '<button class="preview-device-btn active" onclick="setAnketaPreviewDevice(this,\'100%\')">üñ•</button>';
      html += '<button class="preview-device-btn" onclick="setAnketaPreviewDevice(this,\'768px\')">üì±</button>';
      html += '<button class="preview-device-btn" onclick="setAnketaPreviewDevice(this,\'375px\')">üì≤</button>';
      html += '</div></div>';
      html += '<iframe sandbox="allow-scripts" srcdoc="' + escA(fileAction.content) + '" class="anketa-site-iframe"></iframe>';
      html += '</div>';
    }
    window['_anketaFileContent_' + dirId] = fileAction.content;
    window['_anketaFileType_' + dirId] = fileAction.type;
  }

  div.innerHTML = html;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

async function anketaAcceptStage(dirId, newStage) {
  try {
    await advanceToStage(dirId, newStage);
    toast('‚úÖ –≠—Ç–∞–ø –ø–µ—Ä–µ–≤–µ–¥—ë–Ω', 'success');
  } catch(e) {
    toast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
}

function downloadAnketaFile(dirId, type) {
  const content = window['_anketaFileContent_' + dirId];
  if (!content) { toast('–ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'warning'); return; }
  const typeNames = { proposal: '–ö–ü', contract: '–î–æ–≥–æ–≤–æ—Ä', pricelist: '–ü—Ä–∞–π—Å', brief: '–ë—Ä–∏—Ñ', site: '–°–∞–π—Ç' };
  const name = (typeNames[type] || '–î–æ–∫—É–º–µ–Ω—Ç') + '_' + (currentSubproject || 'client').replace(/\s/g, '_') + '_' + new Date().toISOString().split('T')[0];
  const isSite = type === 'site';
  const blob = new Blob([content], { type: isSite ? 'text/html;charset=utf-8' : 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name + (isSite ? '.html' : '.txt');
  a.click();
  URL.revokeObjectURL(a.href);
  toast('–§–∞–π–ª —Å–∫–∞—á–∞–Ω!', 'success');
}

async function saveAnketaFileToDocuments(dirId, type) {
  const content = window['_anketaFileContent_' + dirId];
  if (!content) { toast('–ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞', 'warning'); return; }
  const typeNames = { proposal: '–ö–ü', contract: '–î–æ–≥–æ–≤–æ—Ä', pricelist: '–ü—Ä–∞–π—Å', brief: '–ë—Ä–∏—Ñ', site: '–°–∞–π—Ç' };
  const isSite = type === 'site';
  const ext = isSite ? '.html' : '.txt';
  const fileName = slugify((typeNames[type] || 'Dokument') + '_' + (currentSubproject || '') + '_' + new Date().toISOString().split('T')[0]) + ext;
  toast('üì§ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ã...', 'info');
  try {
    const blob = new Blob([content], { type: isSite ? 'text/html;charset=utf-8' : 'text/plain;charset=utf-8' });
    const folder = slugify(currentSubproject || 'Obshchee');
    const timestamp = Date.now();
    const path = folder + '/' + timestamp + '_' + fileName;
    const { error: uploadErr } = await SB.storage.from('documents').upload(path, blob, { contentType: 'text/plain', upsert: false });
    if (uploadErr) throw uploadErr;
    const { data: urlData } = SB.storage.from('documents').getPublicUrl(path);
    await SB.from('documents').insert({
      id: 'D' + timestamp.toString(36).toUpperCase(),
      filename: fileName, folder: currentSubproject || '–û–±—â–µ–µ',
      uploaded_by: (USER?.name || 'AI') + ' (AI)', upload_date: new Date().toISOString().split('T')[0],
      link: urlData?.publicUrl || '', size: formatFileSize(blob.size),
      direction: currentSubproject || '', project: PROJECTS[currentProject]?.name || ''
    });
    toast('–î–æ–∫—É–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
  } catch(e) {
    console.error('saveAnketaFileToDocuments error:', e);
    toast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
}

// Device switcher for site preview in anketa chat
function setAnketaPreviewDevice(btn, width) {
  const preview = btn.closest('.anketa-site-preview');
  if (!preview) return;
  const iframe = preview.querySelector('.anketa-site-iframe');
  if (iframe) iframe.style.maxWidth = width;
  preview.querySelectorAll('.preview-device-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// Publish site from anketa chat to Supabase Storage
async function publishSiteFromAnketa(dirId) {
  const html = window['_anketaFileContent_' + dirId];
  if (!html) { toast('–ù–µ—Ç HTML –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'error'); return; }
  const dir = (DATA.directions||[]).find(d => (d.ID||d.id) === dirId);
  if (!dir) { toast('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error'); return; }
  const dirName = dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || 'site';
  const fileName = slugify(dirName) + '.html';
  const filePath = 'sites/' + dirId + '/' + fileName;

  toast('üîó –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–∞–π—Ç–∞...', 'info');
  try {
    // Inject feedback widget into HTML
    const feedbackHtml = buildFeedbackWidget(dirId, dirName);
    let finalHtml = html;
    if (finalHtml.includes('</body>')) {
      finalHtml = finalHtml.replace('</body>', feedbackHtml + '\n</body>');
    } else {
      finalHtml += feedbackHtml;
    }

    // Ensure charset meta tag
    if (!finalHtml.includes('charset=') && !finalHtml.includes('charset =')) {
      finalHtml = finalHtml.replace(/<head>/i, '<head>\n<meta charset="UTF-8">');
    }

    // Publish to GitHub Pages
    const slug = slugify(dirName);
    const publicUrl = await publishToGitHub(finalHtml, slug);
    if (!publicUrl) { toast('–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞', 'warning'); return; }

    // Save URL to directions
    await SB.from('directions').update({
      site_url: publicUrl,
      site_html: html.substring(0, 50000)
    }).eq('id', dirId);

    // Show link in chat and copy to clipboard
    try { await navigator.clipboard.writeText(publicUrl); } catch(e2) {}
    appendAnketaMsgToDOM(dirId, 'system', '‚úÖ –°–∞–π—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –Ω–∞ GitHub Pages! –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:\n' + publicUrl);
    toast('‚úÖ –°–∞–π—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω! –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ üìã', 'success');
    await loadData();
  } catch(e) {
    console.error('publishSiteFromAnketa error:', e);
    toast('‚ùå ' + (e.message || '–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏'), 'error');
  }
}

// Build feedback widget HTML to inject into published site
function buildFeedbackWidget(dirId, dirName) {
  const webhookUrl = CONFIG.AI_URL;
  return `
<div id="rkt-feedback" style="position:fixed;bottom:20px;right:20px;z-index:9999;font-family:system-ui,-apple-system,sans-serif">
  <button id="rkt-fb-toggle" onclick="document.getElementById('rkt-fb-form').style.display='flex';this.style.display='none'"
    style="background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff;border:none;border-radius:50px;padding:12px 20px;font-size:14px;cursor:pointer;box-shadow:0 4px 15px rgba(108,92,231,0.4);transition:all 0.3s">
    üí¨ –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
  </button>
  <div id="rkt-fb-form" style="display:none;flex-direction:column;gap:10px;background:#fff;border-radius:16px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,0.15);width:300px;max-width:90vw">
    <div style="font-weight:600;font-size:15px;color:#333">–í–∞—à –æ—Ç–∑—ã–≤ –æ —Å–∞–π—Ç–µ</div>
    <textarea id="rkt-fb-text" placeholder="–ß—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è? –ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å?" rows="4"
      style="width:100%;border:1px solid #ddd;border-radius:8px;padding:10px;font-size:14px;resize:vertical;box-sizing:border-box;font-family:inherit"></textarea>
    <div style="display:flex;gap:8px">
      <button onclick="submitRktFeedback()"
        style="flex:1;background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff;border:none;border-radius:8px;padding:10px;font-size:14px;cursor:pointer;font-weight:600">
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
      </button>
      <button onclick="document.getElementById('rkt-fb-form').style.display='none';document.getElementById('rkt-fb-toggle').style.display='block'"
        style="background:#f0f0f0;color:#666;border:none;border-radius:8px;padding:10px 16px;font-size:14px;cursor:pointer">
        ‚úï
      </button>
    </div>
    <div id="rkt-fb-status" style="font-size:12px;color:#666;text-align:center;display:none"></div>
  </div>
</div>
<script>
function submitRktFeedback(){
  var t=document.getElementById('rkt-fb-text').value.trim();
  if(!t){alert('–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤');return}
  var s=document.getElementById('rkt-fb-status');
  s.style.display='block';s.textContent='–û—Ç–ø—Ä–∞–≤–∫–∞...';
  fetch('${webhookUrl}',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({message:t,context:'feedback',directionId:'${dirId}',direction:'${dirName.replace(/'/g,"\\'")}',source:'client_site'})
  }).then(function(){
    s.textContent='‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!';s.style.color='#00d4aa';
    document.getElementById('rkt-fb-text').value='';
    setTimeout(function(){document.getElementById('rkt-fb-form').style.display='none';document.getElementById('rkt-fb-toggle').style.display='block';s.style.display='none';s.style.color='#666'},2000);
  }).catch(function(){s.textContent='‚ùå –û—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';s.style.color='#e74c3c'});
}
<\/script>`;
}

function updateAnketaCompletenessBar(dirId, completeness) {
  if (completeness === null || completeness === undefined) return;
  const bar = document.getElementById('anketa-bar-' + dirId);
  const pct = document.getElementById('anketa-pct-' + dirId);
  const pctVal = Math.round(completeness * 100);
  if (bar) bar.style.width = pctVal + '%';
  if (pct) pct.textContent = pctVal + '%';
}

function toggleAnketaSummary(dirId) {
  const panel = document.getElementById('anketa-summary-' + dirId);
  if (!panel) return;
  if (_anketaSummaryOpen.has(dirId)) {
    _anketaSummaryOpen.delete(dirId);
    panel.classList.remove('open');
  } else {
    _anketaSummaryOpen.add(dirId);
    panel.classList.add('open');
    renderAnketaSummaryContent(dirId);
  }
}

function renderAnketaSummaryContent(dirId) {
  const panel = document.getElementById('anketa-summary-' + dirId);
  if (!panel) return;
  const dir = getAnketaDir(dirId);
  const q = getAnketaQuestionnaire(dir);
  let html = '';
  const chips = [];
  const addChip = (icon, label, val) => { if (val) chips.push({ icon, label, val }); };

  if (q._version === 2) {
    addChip('üè¢', '–¢–∏–ø', q.business_info?.type);
    addChip('üèô', '–ì–æ—Ä–æ–¥', q.business_info?.city);
    addChip('üìç', '–ê–¥—Ä–µ—Å', q.business_info?.address);
    addChip('üìû', '–¢–µ–ª–µ—Ñ–æ–Ω', q.contact?.phone);
    addChip('üì±', '–°–æ—Ü—Å–µ—Ç–∏', q.contact?.social);
    addChip('üïê', '–ß–∞—Å—ã', q.contact?.work_hours);
    addChip('üìã', '–£—Å–ª—É–≥–∏', q.content?.services ? (q.content.services.length > 40 ? q.content.services.slice(0, 40) + '...' : q.content.services) : '');
    addChip('üí∞', '–¶–µ–Ω—ã', q.content?.prices);
    addChip('üé®', '–°—Ç–∏–ª—å', q.design?.style);
    addChip('üñº', '–¢–µ–º–∞', q.design?.theme);
    if (q.custom) {
      for (const [k, v] of Object.entries(q.custom)) {
        if (v) addChip('‚ú®', k, String(v).length > 30 ? String(v).slice(0, 30) + '...' : String(v));
      }
    }
  } else {
    addChip('üè¢', '–¢–∏–ø', dir?.['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || dir?.['–û–ø–∏—Å–∞–Ω–∏–µ']);
    addChip('üèô', '–ì–æ—Ä–æ–¥', dir?.['–ì–æ—Ä–æ–¥']);
    addChip('üìû', '–¢–µ–ª–µ—Ñ–æ–Ω', dir?.['–¢–µ–ª–µ—Ñ–æ–Ω']);
    addChip('üì±', '–°–æ—Ü—Å–µ—Ç–∏', dir?.['–°–æ—Ü—Å–µ—Ç–∏']);
    addChip('üìã', '–£—Å–ª—É–≥–∏', dir?.['–£—Å–ª—É–≥–∏']);
  }

  if (chips.length === 0) {
    html = '<div style="font-size:12px;color:var(--text2);padding:4px 0">–î–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ —Å–æ–±—Ä–∞–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å AI-–∞–≥–µ–Ω—Ç–æ–º.</div>';
  } else {
    chips.forEach(c => {
      html += '<span class="anketa-chip" onclick="document.getElementById(\'anketa-input-' + escA(dirId) + '\').value=\'–ò–∑–º–µ–Ω–∏ ' + escA(c.label) + ' –Ω–∞ \';document.getElementById(\'anketa-input-' + escA(dirId) + '\').focus()">';
      html += c.icon + ' <span class="chip-label">' + esc(c.label) + ':</span> ' + esc(c.val);
      html += '</span>';
    });
  }
  panel.innerHTML = html;
}

// ============================================================
// ANKETA CHAT ‚Äî MAIN RENDER FUNCTION
// ============================================================
async function renderAnketaChat(dirId, containerId, options) {
  options = options || {};
  const container = document.getElementById(containerId);
  if (!container) return;
  const dir = getAnketaDir(dirId);
  const completeness = dir?.anketa_completeness || dir?.['anketa_completeness'] || 0;
  const pctVal = Math.round((completeness || 0) * 100);
  const eid = escA(dirId);
  const isCompact = options.compact;

  let html = '<div class="anketa-chat' + (isCompact ? ' compact' : '') + '">';

  // Header
  html += '<div class="anketa-chat-header">';
  html += '<h3>ü§ñ AI-–∞–≥–µ–Ω—Ç: ' + esc(dir?.['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '–ö–ª–∏–µ–Ω—Ç') + '</h3>';
  html += '<button onclick="toggleAnketaSummary(\'' + eid + '\')" style="background:none;border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:11px;color:var(--text2);cursor:pointer">' + (_anketaSummaryOpen.has(dirId) ? '–î–∞–Ω–Ω—ã–µ ‚ñ≤' : '–î–∞–Ω–Ω—ã–µ ‚ñº') + '</button>';
  html += '<div class="anketa-completeness-bar"><div id="anketa-bar-' + eid + '" style="width:' + pctVal + '%"></div></div>';
  html += '<span class="anketa-completeness-pct" id="anketa-pct-' + eid + '">' + pctVal + '%</span>';
  html += '</div>';

  // Summary panel (collapsible)
  html += '<div class="anketa-summary-panel' + (_anketaSummaryOpen.has(dirId) ? ' open' : '') + '" id="anketa-summary-' + eid + '"></div>';

  // Messages area
  html += '<div class="anketa-messages" id="anketa-msgs-' + eid + '">';
  html += '<div style="text-align:center;padding:20px"><div class="ai-loading"><span></span><span></span><span></span></div></div>';
  html += '</div>';

  // Media preview
  html += '<div class="anketa-media-preview" id="anketa-media-preview-' + eid + '"></div>';

  // Input area
  html += '<div class="anketa-input-area">';
  html += '<button class="anketa-attach-btn" onclick="attachAnketaMedia(\'' + eid + '\')" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</button>';
  html += '<input type="text" id="anketa-input-' + eid + '" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ –∫–ª–∏–µ–Ω—Ç–µ..." onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();sendAnketaMsg(\'' + eid + '\')}">';
  html += '<button class="anketa-send-btn" id="anketa-send-' + eid + '" onclick="sendAnketaMsg(\'' + eid + '\')" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>';
  html += '</div>';

  html += '</div>';
  container.innerHTML = html;

  // Add focus/blur listeners to protect DOM from renderAll while typing
  const anketaInput = document.getElementById('anketa-input-' + eid);
  if (anketaInput) {
    anketaInput.addEventListener('focus', () => { _uiInputActive = true; });
    anketaInput.addEventListener('blur', () => { setTimeout(() => { _uiInputActive = false; }, 500); });
    // Ctrl+V paste image support
    anketaInput.addEventListener('paste', (e) => {
      const items = e.clipboardData?.items;
      if (!items) return;
      const imageFiles = [];
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.startsWith('image/')) {
          const file = items[i].getAsFile();
          if (file) imageFiles.push(file);
        }
      }
      if (imageFiles.length) {
        e.preventDefault();
        imageFiles.forEach(f => _anketaPendingFiles.push(f));
        renderAnketaMediaPreview(eid);
        toast('üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ –∏–∑ –±—É—Ñ–µ—Ä–∞', 'success');
      }
    });
  }

  // Load chat history asynchronously
  const msgs = await loadAnketaChat(dirId);
  const msgsContainer = document.getElementById('anketa-msgs-' + eid);
  if (!msgsContainer) return;

  if (msgs.length === 0) {
    // First time ‚Äî send greeting
    msgsContainer.innerHTML = '';
    const greeting = dir?.['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || dir?.['–û–ø–∏—Å–∞–Ω–∏–µ']
      ? '–ü—Ä–∏–≤–µ—Ç! –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ **' + (dir?.['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '–∫–ª–∏–µ–Ω—Ç') + '**. –í–∏–∂—É, —á—Ç–æ —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞ ‚Äî ' + (dir?.['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || dir?.['–û–ø–∏—Å–∞–Ω–∏–µ']) + '. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –∫–ª–∏–µ–Ω—Ç–µ, —Å–∫–∏–Ω—å—Ç–µ —Ñ–æ—Ç–æ, –ø–µ—Ä–µ–ø–∏—Å–∫—É –∏–ª–∏ –ø—Ä–∏–º–µ—Ä—ã ‚Äî —è –±—É–¥—É –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∞–π—Ç–∞.'
      : '–ü—Ä–∏–≤–µ—Ç! –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ **' + (dir?.['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '–∫–ª–∏–µ–Ω—Ç') + '**. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –±–∏–∑–Ω–µ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞: —á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è, –∫–∞–∫–æ–π —Å–∞–π—Ç –Ω—É–∂–µ–Ω? –ú–æ–∂–µ—Ç–µ —Å–∫–∏–Ω—É—Ç—å —Ñ–æ—Ç–æ, —Å–∫—Ä–∏–Ω—à–æ—Ç—ã, –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî –≤—Å—ë —á—Ç–æ –µ—Å—Ç—å.';
    await saveAnketaChatMsg(dirId, 'assistant', greeting, [], {});
    appendAnketaMsgToDOM(dirId, 'assistant', greeting, [], null, null, true);
  } else {
    // Render existing messages
    msgsContainer.innerHTML = '';
    const displayMsgs = isCompact ? msgs.slice(-5) : msgs;
    if (isCompact && msgs.length > 5) {
      const showMore = document.createElement('div');
      showMore.className = 'anketa-msg system';
      showMore.innerHTML = '<a href="#" onclick="event.preventDefault();openSubproject(\'' + escA(dir?.['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '') + '\');setTimeout(()=>showSpTab(\'client-info\'),300)" style="color:var(--purple)">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ' + msgs.length + ' —Å–æ–æ–±—â–µ–Ω–∏–π ‚Üí</a>';
      msgsContainer.appendChild(showMore);
    }
    displayMsgs.forEach(m => {
      // Restore fileAction and stageSuggestion from extracted_data (saved during sendAnketaMsg)
      const ed = m.extracted_data || {};
      const fileAction = ed._fileAction || null;
      const stageSuggestion = ed._stageSuggestion || null;
      appendAnketaMsgToDOM(dirId, m.role, m.content, m.media_urls, stageSuggestion, fileAction, true);
    });
  }

  // Render summary if open
  if (_anketaSummaryOpen.has(dirId)) renderAnketaSummaryContent(dirId);
}

function updateLeadPrice() {
  const sel = document.getElementById('cc-lead-type');
  const priceEl = document.getElementById('cc-lead-price');
  if (sel && priceEl && sel.value) {
    const p = SITE_PRICING[sel.value];
    if (p && (!priceEl.value || priceEl.value === '0')) priceEl.value = p.price;
  }
}

async function saveLeadData(id) {
  const v = (sel) => { const el = document.getElementById(sel); return el ? el.value.trim() : ''; };
  const updates = {
    phone: v('cc-lead-phone') || null,
    city: v('cc-lead-city') || null,
    site_type: v('cc-lead-type') || null,
    price: Number(v('cc-lead-price')) || 0,
    manager: v('cc-lead-manager') || null,
    telegram_tag: v('cc-lead-telegram') || null
  };
  try {
    const { error } = await SB.from('directions').update(updates).eq('id', id);
    if (error) throw error;
    toast('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    await loadData();
  } catch(e) {
    console.error('saveLeadData error:', e);
    toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+e.message,'error');
  }
}

async function advanceLeadToAnketa(id) {
  const phone = document.getElementById('cc-lead-phone')?.value?.trim();
  const type = document.getElementById('cc-lead-type')?.value?.trim();
  if (!phone && !type) {
    toast('‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∏ —Ç–∏–ø —Å–∞–π—Ç–∞','warning');
  }
  await saveLeadData(id);
  await setDealStage(id, 'contact');
  closeClientCard();
  setTimeout(() => renderProjectView(), 300);
}

async function advanceAnketaToProto(id) {
  await saveAnketa(id);
  await setDealStage(id, 'proto');
  closeClientCard();
  setTimeout(() => renderProjectView(), 300);
}

// Universal stage advance with auto-save and auto-follow-up
async function advanceToStage(id, newStage) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  // Auto-log touch when advancing from contact stages
  const stage = dir['stage']||'prospect';
  if (['prospect','contact','proposal','negotiation'].includes(stage)) {
    dir['–ö–∞—Å–∞–Ω–∏—è'] = (Number(dir['–ö–∞—Å–∞–Ω–∏—è']||0)) + 1;
    try {
      const dbId = dir['ID'] || dir._dbId || dir.id;
      await SB.from('directions').update({touches: dir['–ö–∞—Å–∞–Ω–∏—è']}).eq('id', dbId);
    } catch(e) {}
  }
  await setDealStage(id, newStage);
  closeClientCard();
  setTimeout(() => renderProjectView(), 300);
}

// Budget/finance block for client card
function renderClientFinance(dir) {
  const price = Number(dir['–¶–µ–Ω–∞']) || 0;
  if (!price) return '';
  const paid = !!dir['–û–ø–ª–∞—á–µ–Ω–æ'];

  // Calculate staff costs based on individual salary_pct
  const clientTasks = (DATA.tasks||[]).filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === dir['–ù–∞–∑–≤–∞–Ω–∏–µ']);
  const assignedNames = new Set();
  clientTasks.forEach(t => { if (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) assignedNames.add(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']); });
  let staffCost = 0;

  let h = '<div class="card" style="padding:16px;margin-bottom:12px">';
  h += '<div style="font-size:13px;font-weight:700;margin-bottom:10px">üí∞ –§–∏–Ω–∞–Ω—Å—ã</div>';
  h += '<div style="display:grid;grid-template-columns:1fr auto;gap:4px 12px;font-size:12px">';
  h += '<div>üíµ –¶–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É</div><div style="font-weight:700">'+price.toLocaleString('ru')+'‚ÇΩ</div>';

  assignedNames.forEach(name => {
    const emp = (DATA.staff||[]).find(s => s['–ò–º—è'] === name);
    if (emp) {
      const pct = parseInt(emp['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[emp['–†–æ–ª—å']] || 0;
      if (pct > 0) {
        const pay = Math.round(price * pct / 100);
        staffCost += pay;
        h += '<div>üë§ '+esc(name)+' ('+pct+'%)</div><div>‚àí'+pay.toLocaleString('ru')+'‚ÇΩ</div>';
      }
    }
  });

  const profit = price - staffCost;
  h += '<div style="border-top:1px solid var(--border);padding-top:4px;font-weight:700;color:var(--green)">üìà –ü—Ä–∏–±—ã–ª—å –∫–æ–º–ø–∞–Ω–∏–∏</div>';
  h += '<div style="border-top:1px solid var(--border);padding-top:4px;font-weight:700;color:var(--green)">'+profit.toLocaleString('ru')+'‚ÇΩ</div>';
  h += '</div>';
  h += '<div style="margin-top:8px;font-size:11px;text-align:center;padding:6px;border-radius:6px;background:'+(paid?'rgba(0,212,170,0.1)':'rgba(255,170,0,0.1)')+';color:'+(paid?'var(--green)':'var(--orange)')+'">'+(paid?'‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞':'‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã')+'</div>';
  h += '</div>';
  return h;
}


function createClientCardOverlay() {
  const el = document.createElement('div');
  el.id = 'client-card-overlay';
  el.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;justify-content:flex-end;backdrop-filter:blur(4px)';
  el.onclick = () => closeClientCard();
  document.body.appendChild(el);
  const style = document.createElement('style');
  style.textContent = '.client-card-panel{width:520px;max-width:90vw;background:var(--bg2);height:100vh;overflow-y:auto;box-shadow:-8px 0 30px rgba(0,0,0,0.3);animation:slideInRight .25s ease}@keyframes slideInRight{from{transform:translateX(100%)}to{transform:translateX(0)}}';
  document.head.appendChild(style);
  return el;
}

function closeClientCard() {
  const el = document.getElementById('client-card-overlay');
  if (el) el.style.display = 'none';
}

// ============================================================
// KANBAN PIPELINE
// ============================================================
const STAGES = [
  {id:'prospect',name:'üîç –ü–æ–∏—Å–∫',color:'var(--text2)',tip:'–ù–∞–π–¥–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–∞—Ö, –∫–æ–Ω—Ç–∞–∫—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',pct:5},
  {id:'contact',name:'üìû –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç',color:'var(--blue)',tip:'–ü–æ–∑–≤–æ–Ω–∏–ª–∏/–Ω–∞–ø–∏—Å–∞–ª–∏, –∂–¥—ë–º –æ—Ç–≤–µ—Ç',pct:10},
  {id:'interest',name:'‚úÖ –ò–Ω—Ç–µ—Ä–µ—Å',color:'var(--purple)',tip:'–ö–ª–∏–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª, –≥–æ—Ç–æ–≤ —Å–º–æ—Ç—Ä–µ—Ç—å',pct:20},
  {id:'proto',name:'üé® –ü—Ä–æ—Ç–æ—Ç–∏–ø',color:'#9b59b6',tip:'–î–µ–º–æ-—Å–∞–π—Ç —Å–æ–∑–¥–∞–Ω –∏ –ø–æ–∫–∞–∑–∞–Ω',pct:40},
  {id:'proposal',name:'üìã –ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',color:'var(--orange)',tip:'–¶–µ–Ω–∞ –∏ —É—Å–ª–æ–≤–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã',pct:60},
  {id:'negotiation',name:'ü§ù –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã',color:'#e67e22',tip:'–û–±—Å—É–∂–¥–∞–µ–º, —Ç–æ—Ä–≥—É–µ–º—Å—è',pct:75},
  {id:'payment',name:'üí∞ –û–ø–ª–∞—Ç–∞',color:'var(--pink)',tip:'–ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏–ª',pct:90},
  {id:'done',name:'‚úÖ –°–¥–∞–Ω',color:'var(--green)',tip:'–°–∞–π—Ç –≥–æ—Ç–æ–≤ –∏ –ø–µ—Ä–µ–¥–∞–Ω',pct:100},
  {id:'lost',name:'‚ùå –û—Ç–∫–∞–∑',color:'var(--red)',tip:'–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è',pct:0}
];

let draggedCard = null;

function renderKanban() {
  const container = document.getElementById('kanban-container');
  if (!container) return;
  const dirs = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã'));
  const filterMgr = document.getElementById('kanban-filter-manager')?.value || '';
  const filtered = filterMgr ? dirs.filter(d => d['–ú–µ–Ω–µ–¥–∂–µ—Ä'] === filterMgr) : dirs;
  const td = today();

  // Update manager filter
  const mgrSelect = document.getElementById('kanban-filter-manager');
  if (mgrSelect) {
    const mgrs = [...new Set(dirs.map(d=>d['–ú–µ–Ω–µ–¥–∂–µ—Ä']).filter(Boolean))];
    const curVal = mgrSelect.value;
    mgrSelect.innerHTML = '<option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option>' + mgrs.map(m => `<option value="${esc(m)}"${m===curVal?' selected':''}>${esc(m)}</option>`).join('');
  }

  let html = '';
  STAGES.forEach((stage, stageIdx) => {
    const deals = filtered.filter(d => (d['stage']||'prospect') === stage.id);
    const sum = deals.reduce((s,d) => s + (Number(d['–¶–µ–Ω–∞'])||0), 0);
    const stageNum = stageIdx + 1;
    html += `<div class="kanban-col" data-stage="${stage.id}" ondragover="kanbanDragOver(event)" ondrop="kanbanDrop(event,this)" ondragleave="this.classList.remove('drag-over')" style="border-top:3px solid ${stage.color}">
      <div class="kanban-col-header" title="${esc(stage.tip||'')}">
        <div><span style="color:${stage.color};font-weight:800;margin-right:4px">${stageNum}.</span>${stage.name} <span class="k-count">${deals.length}</span></div>
        <div class="k-sum">${sum ? sum.toLocaleString('ru')+'‚ÇΩ' : ''}</div>
      </div>
      <div class="kanban-col-body">`;
    deals.forEach(d => {
      const id = d['ID']||d.id||'';
      const overdue = d['–î–µ–¥–ª–∞–π–Ω'] && d['–î–µ–¥–ª–∞–π–Ω'] < td && stage.id !== 'done';
      const cardBorderColor = overdue ? 'var(--red)' : stage.color;
      html += `<div class="kanban-card${overdue?' overdue':''}" draggable="true" data-id="${id}" onclick="openSlideOver('${escA(id)}')" ondragstart="kanbanDragStart(event,this)" ondragend="kanbanDragEnd(this)" style="border-left:4px solid ${cardBorderColor}">
        <div class="k-name">${esc(d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']||'?')}</div>
        <div class="k-meta">
          ${d['–¶–µ–Ω–∞']?'<span class="k-price">'+Number(d['–¶–µ–Ω–∞']).toLocaleString('ru')+'‚ÇΩ</span>':''}
          ${d['–¢–∏–ø —Å–∞–π—Ç–∞']?'<span class="k-type">'+esc(d['–¢–∏–ø —Å–∞–π—Ç–∞'])+'</span>':''}
          ${d['–ì–æ—Ä–æ–¥']?'<span class="k-city">üìç'+esc(d['–ì–æ—Ä–æ–¥'])+'</span>':''}
          ${d['–û–ø–ª–∞—á–µ–Ω–æ']?'<span class="k-paid">üí∞</span>':'<span class="k-unpaid">‚è≥</span>'}
          ${d['–ú–µ–Ω–µ–¥–∂–µ—Ä']?'<span class="k-manager">üë§'+esc(d['–ú–µ–Ω–µ–¥–∂–µ—Ä'])+'</span>':''}
        </div>
        <div class="k-ai-btns">
          <button onclick="event.stopPropagation();aiSummary('${escA(id)}')" title="AI-—Å–≤–æ–¥–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç—É">ü§ñ –ò—Ç–æ–≥</button>
          <button onclick="event.stopPropagation();aiNextStep('${escA(id)}')" title="AI —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥">üí° –®–∞–≥</button>
        </div>
        ${getUserPerms().canDelete ? '<button class="k-delete-btn" onclick="event.stopPropagation();confirmDelete(\'direction\',\''+escA(id)+'\',\''+escA(d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')+'\')" title="–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞">üóë</button>' : ''}
        <div class="k-mobile-move" style="display:none"><button onclick="event.stopPropagation();moveKanbanCard('${escA(id)}','left')" title="‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π —ç—Ç–∞–ø">‚óÄ</button><button onclick="event.stopPropagation();moveKanbanCard('${escA(id)}','right')" title="–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø ‚Üí">‚ñ∂</button></div>
      </div>`;
    });
    html += '</div></div>';
  });
  container.innerHTML = html;

  // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
  if (!localStorage.getItem('rkt_kanban_hint')) {
    const hint = document.createElement('div');
    hint.id = 'kanban-hint';
    hint.style.cssText = 'position:sticky;bottom:12px;left:0;right:0;margin:8px 0 0;background:rgba(0,212,170,.12);border:1px solid var(--accent);border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text2);cursor:pointer;z-index:10';
    hint.innerHTML = '<span style="font-size:18px">üëÜ</span><span>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É –≤–ø—Ä–∞–≤–æ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É. –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º ‚Äî –ª–∏—Å—Ç–∞–π—Ç–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ.</span><button onclick="event.stopPropagation();dismissKanbanHint()" style="margin-left:auto;background:none;border:none;color:var(--accent);cursor:pointer;font-size:18px;line-height:1" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>';
    hint.onclick = dismissKanbanHint;
    container.appendChild(hint);
  }
}

function dismissKanbanHint() {
  localStorage.setItem('rkt_kanban_hint', '1');
  const h = document.getElementById('kanban-hint');
  if (h) h.remove();
}

function kanbanDragStart(e, el) {
  draggedCard = el;
  el.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', el.dataset.id);
}
function kanbanDragEnd(el) { el.classList.remove('dragging'); draggedCard = null; }
function kanbanDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
async function kanbanDrop(e, col) {
  e.preventDefault();
  col.classList.remove('drag-over');
  const id = e.dataTransfer.getData('text/plain');
  const newStage = col.dataset.stage;
  if (!id || !newStage) return;
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  const oldStage = dir['stage']||'prospect';
  if (oldStage === newStage) return;
  dir['stage'] = newStage;
  try {
    const dbId = dir['ID'] || dir._dbId || dir.id;
    await SB.from('directions').update({stage: newStage}).eq('id', dbId);
    toast('‚úÖ ' + (dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'–°–¥–µ–ª–∫–∞') + ' ‚Üí ' + STAGES.find(s=>s.id===newStage)?.name);
    renderKanban();
  } catch(err) { toast('‚ùå –û—à–∏–±–∫–∞: '+err.message, 'error'); }
}

// Mobile kanban move (touch alternative)
async function moveKanbanCard(id, direction) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  const currentStage = dir['stage']||'prospect';
  const stageIds = STAGES.map(s => s.id);
  const idx = stageIds.indexOf(currentStage);
  if (idx < 0) return;
  const newIdx = direction === 'right' ? idx + 1 : idx - 1;
  if (newIdx < 0 || newIdx >= stageIds.length) { toast('–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –¥–∞–ª—å—à–µ','error'); return; }
  const newStage = stageIds[newIdx];
  dir['stage'] = newStage;
  try {
    const dbId = dir['ID'] || dir._dbId || dir.id;
    await SB.from('directions').update({stage: newStage}).eq('id', dbId);
    toast('‚úÖ ' + (dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'–°–¥–µ–ª–∫–∞') + ' ‚Üí ' + (STAGES[newIdx]?.name||newStage));
    renderKanban();
  } catch(err) { dir['stage'] = currentStage; toast('‚ùå –û—à–∏–±–∫–∞: '+err.message, 'error'); }
}

// ============================================================
// SLIDE-OVER DEAL CARD
// ============================================================
let currentDealId = null;

// Quick AI action
function aiQuick(text) {
  const input = document.getElementById('ai-global-input');
  if (input) { input.value = text; sendGlobalAi(); }
}

function togglePipeStage(hdr) {
  const body = hdr.parentElement.querySelector('.pipe-stage-body');
  if (!body) return;
  const arrow = hdr.querySelector('.pipe-stats span:last-child');
  if (body.style.display === 'none') {
    body.style.display = '';
    if (arrow) arrow.textContent = '‚ñæ';
  } else {
    body.style.display = 'none';
    if (arrow) arrow.textContent = '‚ñ∏';
  }
}

async function deleteClient(id, name) {
  const p = getUserPerms();
  if (p.level < 3) { toast('‚õî –¢–æ–ª—å–∫–æ CEO –∏ –ó–∞–º –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤','error'); return; }
  
  document.getElementById('confirmTitle').textContent = 'üóë –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?';
  document.getElementById('confirmText').textContent = '¬´' + name + '¬ª –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.';
  document.getElementById('confirmOverlay').classList.add('show');
  confirmCallback = async function(ok) {
    if (!ok) return;
    try {
      const { error: e1 } = await SB.from('directions').delete().eq('id', id);
      if (e1) throw e1;
      const { error: e2 } = await SB.from('tasks').delete().eq('direction', name);
      if (e2) console.warn('Task delete warn:', e2);
      toast('‚úÖ –ö–ª–∏–µ–Ω—Ç ¬´' + name + '¬ª —É–¥–∞–ª—ë–Ω', 'success');
      await loadData();
      syncSubprojectsFromDb(currentProject);
      renderProjectView();
    } catch(e) {
      toast('‚ùå –û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
  };
}

// File upload for AI chat
function attachFileToAI() {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = '.pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.csv,.xlsx';
  inp.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    window._aiAttachedFile = file;
    const badge = document.getElementById('ai-file-badge');
    if (badge) {
      badge.textContent = 'üìé ' + file.name;
      badge.style.display = 'inline-block';
    }
    toast('üìé –§–∞–π–ª –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω: ' + file.name, 'info');
  };
  inp.click();
}

function openSlideOver(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  currentDealId = id;
  const stage = dir['stage']||'prospect';
  const stageIdx = STAGES.findIndex(s=>s.id===stage);
  const td = today();

  document.getElementById('so-name').textContent = dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?';
  document.getElementById('so-type').textContent = (dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'‚Äî') + ' ¬∑ ' + (dir['–ì–æ—Ä–æ–¥']||'‚Äî');

  // Progress bar ‚Äî circles with connecting lines
  document.getElementById('so-progress').innerHTML = STAGES.map((s,i) =>
    (i > 0 ? `<div class="so-line ${i<=stageIdx?'done':''}"></div>` : '') +
    `<div class="so-step ${i<stageIdx?'done':''} ${i===stageIdx?'active':''}" title="${s.name}" onclick="setDealStageConfirm('${id}','${s.id}','${s.name.replace(/'/g,"\\'").replace(/`/g,'\\`')}')"></div>`
  ).join('');
  document.getElementById('so-stage-labels').innerHTML = STAGES.map(s =>
    `<span>${s.name.replace(/[^\s\w–ê-–Ø–∞-—è—ë–Å]/g,'').trim()}</span>`
  ).join('');

  // Guided workflow banner
  const wfBanner = document.getElementById('so-workflow-banner');
  const nextActions = {
    'prospect': {step:'1Ô∏è‚É£',title:'–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É',desc:'–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç ‚Äî –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ',action:'üìû –ü–æ–∑–≤–æ–Ω–∏–ª ‚Üí –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç',fn:"setDealStage('"+id+"','contact')"},
    'contact': {step:'2Ô∏è‚É£',title:'–ñ–¥—ë–º –æ—Ç–≤–µ—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞',desc:'–ö–ª–∏–µ–Ω—Ç –∑–Ω–∞–µ—Ç –æ –Ω–∞—Å. –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ 1-2 –¥–Ω—è –µ—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª',action:'‚úÖ –ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω',fn:"setDealStage('"+id+"','interest')"},
    'interest': {step:'3Ô∏è‚É£',title:'–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–∞–π—Ç–∞',desc:'–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω ‚Äî –ø–æ–∫–∞–∂–∏—Ç–µ –µ–º—É –¥–µ–º–æ-—Å–∞–π—Ç',action:'üé® –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø',fn:"openSubproject('"+escA(dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')+"')"},
    'proto': {step:'4Ô∏è‚É£',title:'–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ö–ü (–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)',desc:'–ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø + –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ü–µ–Ω—É –∏ —É—Å–ª–æ–≤–∏—è',action:'üìã –ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',fn:"setDealStage('"+id+"','proposal')"},
    'proposal': {step:'5Ô∏è‚É£',title:'–û–±—Å—É–¥–∏—Ç–µ —É—Å–ª–æ–≤–∏—è',desc:'–°–æ–∑–≤–æ–Ω–∏—Ç–µ—Å—å, –æ–±—Å—É–¥–∏—Ç–µ –ø—Ä–∞–≤–∫–∏, —Ç–æ—Ä–≥—É–π—Ç–µ—Å—å',action:'ü§ù –ù–∞—á–∞–ª–∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã',fn:"setDealStage('"+id+"','negotiation')"},
    'negotiation': {step:'6Ô∏è‚É£',title:'–ó–∞–∫—Ä–æ–π—Ç–µ —Å–¥–µ–ª–∫—É!',desc:'–ö–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ ‚Äî –≤—ã—Å—Ç–∞–≤—å—Ç–µ —Å—á—ë—Ç',action:'üí∞ –ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏–ª',fn:"setDealStage('"+id+"','payment')"},
    'payment': {step:'7Ô∏è‚É£',title:'–°–¥–∞–π—Ç–µ —Å–∞–π—Ç',desc:'–ó–∞–ª–µ–π—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥ –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç—É',action:'‚úÖ –°–∞–π—Ç —Å–¥–∞–Ω!',fn:"setDealStage('"+id+"','done')"}
  };
  if (nextActions[stage]) {
    const na = nextActions[stage];
    wfBanner.innerHTML = `<div class="workflow-banner"><div class="wf-step">${na.step}</div><div class="wf-info"><h4>${na.title}</h4><p>${na.desc}</p></div><div class="wf-action"><button onclick="${na.fn}">${na.action}</button></div></div>`;
  } else if (stage === 'done') {
    wfBanner.innerHTML = '<div class="workflow-banner" style="border-color:var(--green);background:rgba(0,212,170,.06)"><div class="wf-step">üéâ</div><div class="wf-info"><h4 style="color:var(--green)">–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</h4><p>–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç</p></div></div>';
  } else if (stage === 'lost') {
    wfBanner.innerHTML = '<div class="workflow-banner" style="border-color:var(--red);background:rgba(255,75,75,.06)"><div class="wf-step">‚ùå</div><div class="wf-info"><h4 style="color:var(--red)">–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è</h4><p>–ü—Ä–∏—á–∏–Ω–∞: '+(esc(dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']||'–Ω–µ —É–∫–∞–∑–∞–Ω–∞'))+'</p></div><div class="wf-action"><button onclick="setDealStage(\''+id+'\',\'prospect\')">üîÑ –í–µ—Ä–Ω—É—Ç—å –≤ –≤–æ—Ä–æ–Ω–∫—É</button></div></div>';
  } else {
    wfBanner.innerHTML = '';
  }

  // Details - expanded with sales data
  const touches = Number(dir['–ö–∞—Å–∞–Ω–∏—è']||0);
  const nextContact = dir['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç']||'';
  const isOverdue = nextContact && nextContact <= td && !['done','lost'].includes(stage);
  document.getElementById('so-details').innerHTML = `
    <div class="so-detail-item"><div class="so-label">üí∞ –¶–µ–Ω–∞</div><div class="so-value">${(Number(dir['–¶–µ–Ω–∞'])||0).toLocaleString('ru')}‚ÇΩ</div></div>
    <div class="so-detail-item"><div class="so-label">üí≥ –û–ø–ª–∞—Ç–∞</div><div class="so-value" style="color:${dir['–û–ø–ª–∞—á–µ–Ω–æ']?'var(--green)':'var(--orange)'}">${dir['–û–ø–ª–∞—á–µ–Ω–æ']?'‚úÖ –û–ø–ª–∞—á–µ–Ω':'‚è≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω'}</div></div>
    <div class="so-detail-item"><div class="so-label">üë§ –ö–æ–Ω—Ç–∞–∫—Ç</div><div class="so-value">${esc(dir['–ö–ª–∏–µ–Ω—Ç']||dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üì± –¢–µ–ª–µ—Ñ–æ–Ω</div><div class="so-value">${esc(dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä</div><div class="so-value">${esc(dir['–ú–µ–Ω–µ–¥–∂–µ—Ä']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üì° –ò—Å—Ç–æ—á–Ω–∏–∫</div><div class="so-value">${esc(dir['–ò—Å—Ç–æ—á–Ω–∏–∫']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üåê –¢–∏–ø</div><div class="so-value">${esc(dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üìç –ì–æ—Ä–æ–¥</div><div class="so-value">${esc(dir['–ì–æ—Ä–æ–¥']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üìû –ö–∞—Å–∞–Ω–∏–π</div><div class="so-value">${touches} –∏–∑ 8</div></div>
    <div class="so-detail-item"><div class="so-label">üìÖ –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</div><div class="so-value" style="color:${isOverdue?'var(--orange)':'inherit'}">${isOverdue?'üîî ':''}${nextContact ? formatDateRu(nextContact) : '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</div></div>
    ${dir['–°—Å—ã–ª–∫–∞']?'<div class="so-detail-item" style="grid-column:span 2"><div class="so-label">üîó –°—Å—ã–ª–∫–∞</div><div class="so-value"><a href="'+esc(dir['–°—Å—ã–ª–∫–∞'])+'" target="_blank" style="color:var(--accent)">'+esc(dir['–°—Å—ã–ª–∫–∞'])+'</a></div></div>':''}
    ${dir['–û–ø–∏—Å–∞–Ω–∏–µ']?'<div class="so-detail-item" style="grid-column:span 2"><div class="so-label">üìù –ó–∞–º–µ—Ç–∫–∞</div><div class="so-value">'+esc(dir['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</div></div>':''}
    ${dir['–§–∏–¥–±–µ–∫']?'<div class="so-detail-item" style="grid-column:span 2"><div class="so-label">üí¨ –§–∏–¥–±–µ–∫</div><div class="so-value">'+esc(dir['–§–∏–¥–±–µ–∫'])+'</div></div>':''}
  `;

  // Actions
  const p = getUserPerms();
  const cleanPh = (dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[^\d+]/g,'');
  document.getElementById('so-actions').innerHTML = `
    <button onclick="closeSlideOver();openSubproject('${escA(dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')}')" style="width:100%;padding:14px;font-size:15px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--blue));color:#fff;border:none;border-radius:var(--radius);cursor:pointer;margin-bottom:12px">üìÇ –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–ª–∏–µ–Ω—Ç–∞</button>
    ${cleanPh?'<button onclick="window.open(\'tel:'+cleanPh+'\')">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>':''}
    ${cleanPh?'<button onclick="window.open(\'https://t.me/'+cleanPh.replace('+','')+'\',\'_blank\')">üí¨ Telegram</button>':''}
    <button onclick="logTouch('${id}')">üìû –ó–∞–ø–∏—Å–∞—Ç—å –∫–∞—Å–∞–Ω–∏–µ</button>
    <button onclick="scheduleFollowUp('${id}')">üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</button>
    <button onclick="addDealFeedback('${id}')">üí¨ –§–∏–¥–±–µ–∫</button>
    <button onclick="addDealNote('${id}')">üìù –ó–∞–º–µ—Ç–∫–∞</button>

    ${p.canWrite?'<button onclick="closeSlideOver();openClientCard(\''+escA(id)+'\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>':''}
    ${!dir['–û–ø–ª–∞—á–µ–Ω–æ']&&p.canWrite?'<button onclick="markPaid(\''+id+'\')">üí∞ –û–ø–ª–∞—Ç–∞</button>':''}
    ${stage!=='lost'&&stage!=='done'?'<button onclick="rejectDeal(\''+id+'\')" style="background:rgba(255,75,75,.15);color:var(--red)">‚ùå –û—Ç–∫–∞–∑</button>':''}
    ${p.canDelete?'<button onclick="confirmDelete(\'direction\',\''+escA(id)+'\',\''+escA(dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')+'\')" style="background:rgba(231,76,60,.15);color:var(--red)">üóë –£–¥–∞–ª–∏—Ç—å</button>':''}
    <button id="so-ai-summary-btn" onclick="aiSummary('${id}')" style="background:rgba(0,212,170,.08);border-color:var(--accent);color:var(--accent)">ü§ñ AI –ò—Ç–æ–≥</button>
    <button id="so-ai-nextstep-btn" onclick="aiNextStep('${id}')" style="background:rgba(77,171,247,.08);border-color:var(--blue);color:var(--blue)">üí° AI –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥</button>
  `;

  // Tasks checklist
  const tasks = (DATA.tasks||[]).filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === dir['name']);
  document.getElementById('so-tasks').innerHTML = tasks.length ? tasks.map(t => {
    const done = t['–°—Ç–∞—Ç—É—Å'] === '–ì–æ—Ç–æ–≤–æ';
    return `<li class="${done?'done':''}"><span class="check" onclick="toggleTaskDone('${t['ID']||t.id}')">${done?'‚úì':''}</span>${esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')}</li>`;
  }).join('') : '<li style="color:var(--text3)">–ù–µ—Ç –∑–∞–¥–∞—á</li>';

  // Next stage button
  const nextBtn = document.getElementById('so-next-btn');
  if (stageIdx < STAGES.length - 1 && stage !== 'done') {
    nextBtn.style.display = 'block';
    nextBtn.textContent = '‚û°Ô∏è –ü–µ—Ä–µ–≤–µ—Å—Ç–∏: ' + STAGES[stageIdx+1].name;
  } else {
    nextBtn.style.display = 'none';
  }

  // –†–ö–¢ –ú–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ CRM
  const rktCrmEl = document.getElementById('so-rkt-crm');
  if ((dir['–ü—Ä–æ–µ–∫—Ç']||'') === '–†–ö–¢') {
    rktCrmEl.innerHTML = buildRktCrmHtml(id, dir);
  } else {
    rktCrmEl.innerHTML = '';
  }

  // Touch timeline (history)
  const touchLogEl = document.getElementById('so-touch-log');
  if (touchLogEl) {
    let tlog = [];
    try { tlog = JSON.parse(dir['–ò—Å—Ç–æ—Ä–∏—è –∫–∞—Å–∞–Ω–∏–π'] || '[]'); } catch(e) {}
    if (Array.isArray(tlog) && tlog.length > 0) {
      const typeIcon = { call:'üìû', msg:'üí¨', email:'üìß' };
      touchLogEl.innerHTML = `<div class="so-section"><h4>üìû –ò—Å—Ç–æ—Ä–∏—è –∫–∞—Å–∞–Ω–∏–π (${tlog.length})</h4><div style="display:flex;flex-direction:column;gap:5px">${
        tlog.slice().reverse().map(entry => {
          const icon = typeIcon[entry.type] || 'üìû';
          return `<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--bg3);border-radius:8px;font-size:12px">
            <span>${icon}</span>
            <div style="flex:1;font-weight:600">–ö–∞—Å–∞–Ω–∏–µ #${entry.n}${entry.note ? ' ‚Äî ' + esc(entry.note) : ''}</div>
            <div style="color:var(--text3);white-space:nowrap">${formatDateRu(entry.date)}</div>
          </div>`;
        }).join('')
      }</div></div>`;
    } else {
      touchLogEl.innerHTML = '';
    }
  }

  document.getElementById('slideoverOverlay').classList.add('open');
  document.getElementById('slideoverPanel').classList.add('open');
}

function closeSlideOver() {
  document.getElementById('slideoverOverlay').classList.remove('open');
  document.getElementById('slideoverPanel').classList.remove('open');
  currentDealId = null;
}

// ‚îÄ‚îÄ –†–ö–¢ CRM: Medical Equipment UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function buildRktCrmHtml(id, dir) {
  const eqType    = dir['–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è'] || '';
  const oemPart   = dir['OEM-–ø–∞—Ä—Ç–Ω—ë—Ä'] || '';
  const logStatus = dir['–°—Ç–∞—Ç—É—Å –ª–æ–≥–∏—Å—Ç–∏–∫–∏'] || '';
  const procType  = dir['–¢–∏–ø –∑–∞–∫—É–ø–∫–∏'] || '';
  const procDl    = dir['–î–µ–¥–ª–∞–π–Ω –∑–∞–∫—É–ø–∫–∏'] || '';
  const procNum   = dir['–ù–æ–º–µ—Ä –∑–∞–∫—É–ø–∫–∏'] || '';

  // Parse rzn_checklist ‚Äî may arrive as object or JSON string from Supabase
  let rznObj = {};
  const rznRaw = dir['–ß–µ–∫–ª–∏—Å—Ç –†–ó–ù'];
  if (rznRaw && typeof rznRaw === 'object') {
    rznObj = rznRaw;
  } else if (rznRaw) {
    try { rznObj = JSON.parse(rznRaw); } catch(e) { rznObj = {}; }
  }

  const EQ_OPTIONS  = ['–ö–¢ 16 —Å—Ä–µ–∑–æ–≤','–ö–¢ 32 —Å—Ä–µ–∑–∞','–ö–¢ 64 —Å—Ä–µ–∑–∞','–ö–¢ 128 —Å—Ä–µ–∑–æ–≤','–†–µ–Ω—Ç–≥–µ–Ω','–°-–¥—É–≥–∞'];
  const OEM_OPTIONS = ['Syno-Tech','Powersite','Varex','Canon'];
  const PROC_OPTIONS = ['–§–ó-44','–§–ó-223','–ü—Ä—è–º–æ–π'];
  const LOG_STEPS = [
    {val:'factory',       label:'–ù–∞ –∑–∞–≤–æ–¥–µ'},
    {val:'customs',       label:'–¢–∞–º–æ–∂–Ω—è'},
    {val:'delivery',      label:'–î–æ—Å—Ç–∞–≤–∫–∞'},
    {val:'installation',  label:'–ú–æ–Ω—Ç–∞–∂'},
    {val:'commissioning', label:'–í–≤–æ–¥ –≤ —ç–∫—Å–ø–ª.'},
  ];

  const logIdx = LOG_STEPS.findIndex(s => s.val === logStatus);

  const makeSelect = (fid, opts, cur, lbl) =>
    `<div style="display:flex;flex-direction:column;gap:4px">
      <label style="font-size:11px;color:var(--text3)">${lbl}</label>
      <select id="${fid}" style="padding:6px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
        <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
        ${opts.map(o=>`<option value="${esc(o)}"${cur===o?' selected':''}>${esc(o)}</option>`).join('')}
      </select>
    </div>`;

  const logStepsHtml = LOG_STEPS.map((s,i) => {
    const done   = logIdx >= 0 && i < logIdx;
    const active = i === logIdx;
    const bg     = done ? 'var(--accent)' : active ? 'var(--accent)' : 'var(--bg2)';
    const txt    = (done || active) ? '#000' : 'var(--text3)';
    const fw     = active ? '700' : '400';
    const opacity = done ? '0.55' : '1';
    return `<div onclick="setRktLogistics('${escA(id)}','${s.val}')"
      style="flex:1;text-align:center;padding:6px 3px;border-radius:6px;background:${bg};color:${txt};font-size:10px;font-weight:${fw};cursor:pointer;border:1px solid var(--border);transition:all .2s;opacity:${opacity}">${s.label}</div>`;
  }).join('<div style="width:3px"></div>');

  const RZN_ITEMS = [
    {key:'tech_file',  label:'–¢–µ—Ö.—Ñ–∞–π–ª CN‚ÜíRU'},
    {key:'toxicology', label:'–¢–æ–∫—Å–∏–∫–æ–ª–æ–≥–∏—è'},
    {key:'dossier',    label:'–î–æ—Å—å–µ –≤ –†–ó–ù'},
    {key:'ru_received',label:'–†–£ –ø–æ–ª—É—á–µ–Ω–æ'},
  ];
  const rznHtml = RZN_ITEMS.map(item =>
    `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);cursor:pointer;font-size:13px;color:var(--text)">
      <input type="checkbox" id="rzn-${item.key}" ${rznObj[item.key]?'checked':''} style="width:15px;height:15px;accent-color:var(--accent);cursor:pointer">
      ${esc(item.label)}
    </label>`
  ).join('');

  const blockStyle = 'background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px';
  const titleStyle = 'font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px';

  return `<div class="so-section" style="border-top:2px solid var(--accent);padding-top:12px;margin-top:4px">
  <h4 style="color:var(--accent);margin-bottom:10px">üè• –ú–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ CRM</h4>

  <!-- –ë–ª–æ–∫ 1: –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è OEM -->
  <div style="${blockStyle}">
    <div style="${titleStyle}">üîß –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è OEM</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      ${makeSelect('rkt-eq-type', EQ_OPTIONS, eqType, '–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è')}
      ${makeSelect('rkt-oem-partner', OEM_OPTIONS, oemPart, 'OEM-–ø–∞—Ä—Ç–Ω—ë—Ä')}
    </div>
  </div>

  <!-- –ë–ª–æ–∫ 2: –ß–µ–∫–ª–∏—Å—Ç –†–ó–ù -->
  <div style="${blockStyle}">
    <div style="${titleStyle}">üìã –ß–µ–∫–ª–∏—Å—Ç –†–ó–ù</div>
    ${rznHtml}
  </div>

  <!-- –ë–ª–æ–∫ 3: –¢—Ä–µ–∫–µ—Ä –ª–æ–≥–∏—Å—Ç–∏–∫–∏ -->
  <div style="${blockStyle}">
    <div style="${titleStyle}">üöö –¢—Ä–µ–∫–µ—Ä –ª–æ–≥–∏—Å—Ç–∏–∫–∏</div>
    <div style="display:flex;gap:3px">${logStepsHtml}</div>
    ${logStatus ? `<div style="font-size:11px;color:var(--text3);margin-top:6px;text-align:center">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: <strong style="color:var(--accent)">${esc(LOG_STEPS.find(s=>s.val===logStatus)?.label||logStatus)}</strong></div>` : '<div style="font-size:11px;color:var(--text3);margin-top:6px;text-align:center">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —à–∞–≥ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>'}
  </div>

  <!-- –ë–ª–æ–∫ 4: –ì–æ—Å–∑–∞–∫—É–ø–∫–∏ -->
  <div style="${blockStyle}">
    <div style="${titleStyle}">üèõ –ì–æ—Å–∑–∞–∫—É–ø–∫–∏</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
      ${makeSelect('rkt-proc-type', PROC_OPTIONS, procType, '–¢–∏–ø –∑–∞–∫—É–ø–∫–∏')}
      <div style="display:flex;flex-direction:column;gap:4px">
        <label style="font-size:11px;color:var(--text3)">–î–µ–¥–ª–∞–π–Ω</label>
        <input type="date" id="rkt-proc-deadline" value="${esc(procDl)}"
          style="padding:6px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:4px">
      <label style="font-size:11px;color:var(--text3)">–ù–æ–º–µ—Ä –∑–∞–∫—É–ø–∫–∏</label>
      <input type="text" id="rkt-proc-number" value="${esc(procNum)}" placeholder="–Ω–∞–ø—Ä. 0373100012625000001"
        style="padding:6px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;width:100%;box-sizing:border-box">
    </div>
  </div>

  <button onclick="saveRktCrm('${escA(id)}')"
    style="width:100%;padding:10px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –†–ö–¢</button>
</div>`;
}

async function saveRktCrm(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  const dbId = dir['ID'] || dir._dbId || dir.id;

  const rznObj = {};
  ['tech_file','toxicology','dossier','ru_received'].forEach(k => {
    rznObj[k] = !!(document.getElementById('rzn-'+k)?.checked);
  });

  const updates = {
    '–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è': document.getElementById('rkt-eq-type')?.value || '',
    'OEM-–ø–∞—Ä—Ç–Ω—ë—Ä':      document.getElementById('rkt-oem-partner')?.value || '',
    '–ß–µ–∫–ª–∏—Å—Ç –†–ó–ù':      rznObj,
    '–¢–∏–ø –∑–∞–∫—É–ø–∫–∏':      document.getElementById('rkt-proc-type')?.value || '',
    '–î–µ–¥–ª–∞–π–Ω –∑–∞–∫—É–ø–∫–∏':  document.getElementById('rkt-proc-deadline')?.value || null,
    '–ù–æ–º–µ—Ä –∑–∞–∫—É–ø–∫–∏':    document.getElementById('rkt-proc-number')?.value || '',
  };

  // Update in-memory
  Object.assign(dir, updates);

  try {
    const dbRow = mapToDb('directions', updates);
    const { error } = await SB.from('directions').update(dbRow).eq('id', dbId);
    if (error) throw error;
    toast('‚úÖ –î–∞–Ω–Ω—ã–µ –†–ö–¢ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
  } catch(err) {
    toast('‚ùå ' + err.message, 'error');
  }
}

async function setRktLogistics(id, step) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  const dbId = dir['ID'] || dir._dbId || dir.id;
  dir['–°—Ç–∞—Ç—É—Å –ª–æ–≥–∏—Å—Ç–∏–∫–∏'] = step;
  const STEP_NAMES = {factory:'–ù–∞ –∑–∞–≤–æ–¥–µ',customs:'–¢–∞–º–æ–∂–Ω—è',delivery:'–î–æ—Å—Ç–∞–≤–∫–∞',installation:'–ú–æ–Ω—Ç–∞–∂',commissioning:'–í–≤–æ–¥ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é'};
  try {
    const { error } = await SB.from('directions').update({ logistics_status: step }).eq('id', dbId);
    if (error) throw error;
    toast('üöö ' + (STEP_NAMES[step] || step));
    if (currentDealId === id) openSlideOver(id);
  } catch(err) {
    toast('‚ùå ' + err.message, 'error');
  }
}

// ‚îÄ‚îÄ –≠—Ç–∞–ø 3.3: AI Action Buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function aiSummary(leadId) {
  const lead = (DATA.directions||[]).find(d => (d['ID']||d.id) === leadId);
  if (!lead) return;
  const btn = document.getElementById('so-ai-summary-btn');
  const origText = btn ? btn.textContent : '';
  if (btn) btn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
  try {
    const resp = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        action: 'ai_assist',
        type: 'summary',
        lead_id: leadId,
        message: '–î–∞–π –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É –ø–æ –∫–ª–∏–µ–Ω—Ç—É: ' + JSON.stringify({
          –ù–∞–∑–≤–∞–Ω–∏–µ: lead['–ù–∞–∑–≤–∞–Ω–∏–µ'],
          –ü—Ä–æ–µ–∫—Ç:   lead['–ü—Ä–æ–µ–∫—Ç'],
          –≠—Ç–∞–ø:     lead['stage'],
          –¶–µ–Ω–∞:     lead['–¶–µ–Ω–∞'],
          –ö–∞—Å–∞–Ω–∏—è:  lead['–ö–∞—Å–∞–Ω–∏—è'],
          '–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç': lead['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'],
          –ú–µ–Ω–µ–¥–∂–µ—Ä: lead['–ú–µ–Ω–µ–¥–∂–µ—Ä'],
          –û–ø–∏—Å–∞–Ω–∏–µ: lead['–û–ø–∏—Å–∞–Ω–∏–µ'],
          –§–∏–¥–±–µ–∫:   lead['–§–∏–¥–±–µ–∫']
        })
      })
    });
    const data = await resp.json().catch(() => ({}));
    const reply = data.reply || data.text || data.message || data.output || 'AI –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç.';
    showCustomModal('ü§ñ AI –ò—Ç–æ–≥ ‚Äî ' + esc(lead['–ù–∞–∑–≤–∞–Ω–∏–µ']||''), `
      <div style="background:var(--bg3);border-radius:8px;padding:14px;font-size:14px;line-height:1.6;white-space:pre-wrap;color:var(--text)">${esc(reply)}</div>
    `, null);
  } catch(err) {
    toast('‚ùå AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ' + err.message, 'error');
  } finally {
    if (btn) btn.textContent = origText;
  }
}

async function aiNextStep(leadId) {
  const lead = (DATA.directions||[]).find(d => (d['ID']||d.id) === leadId);
  if (!lead) return;
  const btn = document.getElementById('so-ai-nextstep-btn');
  const origText = btn ? btn.textContent : '';
  if (btn) btn.textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑...';
  try {
    const resp = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        action: 'ai_assist',
        type: 'next_step',
        lead_id: leadId,
        message: '–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ —Å —ç—Ç–∏–º –∫–ª–∏–µ–Ω—Ç–æ–º? –†–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ' + JSON.stringify({
          –ù–∞–∑–≤–∞–Ω–∏–µ: lead['–ù–∞–∑–≤–∞–Ω–∏–µ'],
          –≠—Ç–∞–ø:     lead['stage'],
          –ö–∞—Å–∞–Ω–∏—è:  lead['–ö–∞—Å–∞–Ω–∏—è'],
          '–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç': lead['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'],
          –û–ø–∏—Å–∞–Ω–∏–µ: lead['–û–ø–∏—Å–∞–Ω–∏–µ'],
          –§–∏–¥–±–µ–∫:   lead['–§–∏–¥–±–µ–∫'],
          '–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞': lead['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']
        })
      })
    });
    const data = await resp.json().catch(() => ({}));
    const reply = data.reply || data.text || data.message || data.output || 'AI –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç.';
    showCustomModal('üí° AI –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî ' + esc(lead['–ù–∞–∑–≤–∞–Ω–∏–µ']||''), `
      <div style="background:rgba(77,171,247,.06);border:1px solid var(--blue);border-radius:8px;padding:14px;font-size:14px;line-height:1.6;white-space:pre-wrap;color:var(--text)">${esc(reply)}</div>
    `, null);
  } catch(err) {
    toast('‚ùå AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ' + err.message, 'error');
  } finally {
    if (btn) btn.textContent = origText;
  }
}

// Mapping: deal stage ‚Üí which SITE_PIPELINE steps should be completed by this stage
const STAGE_TO_STEPS = {
  'prospect':     { complete: [],         active: [1] },
  'contact':      { complete: [1],        active: [2] },
  'interest':     { complete: [1,2],      active: [3,4] },
  'proto':        { complete: [1,2,3,4],  active: [5,6] },
  'proposal':     { complete: [1,2,3,4,5,6], active: [7] },
  'negotiation':  { complete: [1,2,3,4,5,6,7], active: [8] },
  'payment':      { complete: [1,2,3,4,5,6,7,8], active: [9] },
  'done':         { complete: [1,2,3,4,5,6,7,8,9,10,11], active: [12] },
  'lost':         { complete: [],         active: [] }
};

async function setDealStage(id, newStage) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) { console.error('setDealStage: direction not found for id', id); toast('‚ùå –ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
  const oldStage = dir['stage']||'prospect';
  dir['stage'] = newStage;
  try {
    const dbId = dir['ID'] || dir._dbId || dir.id;
    if (!dbId) { console.error('setDealStage: no dbId!', dir); toast('‚ùå –ù–µ—Ç ID –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è','error'); return; }
    const { error } = await SB.from('directions').update({stage: newStage}).eq('id', dbId);
    if (error) throw error;
    const stageName = STAGES.find(s=>s.id===newStage)?.name || newStage;
    toast('‚úÖ ‚Üí ' + stageName);

    // Auto-update tasks based on new stage
    await syncTasksForStage(dir, newStage);

    await loadData();
    renderAll();
    if (currentDealId === id) openSlideOver(id);
  } catch(err) {
    dir['stage'] = oldStage;
    console.error('setDealStage error:', err);
    toast('‚ùå –û—à–∏–±–∫–∞: '+err.message,'error');
  }
}

// Sync tasks: complete old steps, activate new ones, create missing ones
async function syncTasksForStage(dir, stage) {
  const dirName = dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || dir['name'] || '';
  if (!dirName) return;
  const mapping = STAGE_TO_STEPS[stage];
  if (!mapping) return;

  // Get all tasks for this direction
  const clientTasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === dirName);

  // For each pipeline step, find matching task by keywords
  const matchTask = (stepNum) => {
    const pipeStep = SITE_PIPELINE.find(p => p.step === stepNum);
    if (!pipeStep) return null;
    const stepName = pipeStep.name.replace(/[^\w–∞-—è—ë]/gi, ' ').toLowerCase();
    const keywords = stepName.split(/\s+/).filter(w => w.length > 2);
    return clientTasks.find(t => {
      const desc = (t['–û–ø–∏—Å–∞–Ω–∏–µ']||'').toLowerCase();
      return keywords.filter(k => desc.includes(k)).length >= 2;
    });
  };

  const updates = [];

  // Mark completed steps as "–ì–æ—Ç–æ–≤–æ"
  for (const stepNum of mapping.complete) {
    const task = matchTask(stepNum);
    if (task && (task['–°—Ç–∞—Ç—É—Å']||'') !== '–ì–æ—Ç–æ–≤–æ' && (task['–°—Ç–∞—Ç—É—Å']||'') !== '‚úÖ –ì–æ—Ç–æ–≤–æ') {
      const taskId = task['ID'] || task.id;
      if (taskId) {
        updates.push(SB.from('tasks').update({status: '–ì–æ—Ç–æ–≤–æ'}).eq('id', taskId));
      }
    }
  }

  // Mark active steps as "–í —Ä–∞–±–æ—Ç–µ" (if they're not already done)
  for (const stepNum of mapping.active) {
    const task = matchTask(stepNum);
    if (task) {
      const st = task['–°—Ç–∞—Ç—É—Å']||'';
      if (st !== '–ì–æ—Ç–æ–≤–æ' && st !== '‚úÖ –ì–æ—Ç–æ–≤–æ' && st !== '–í —Ä–∞–±–æ—Ç–µ' && st !== 'üîÑ –í —Ä–∞–±–æ—Ç–µ') {
        const taskId = task['ID'] || task.id;
        if (taskId) {
          updates.push(SB.from('tasks').update({status: '–í —Ä–∞–±–æ—Ç–µ'}).eq('id', taskId));
        }
      }
    } else {
      // Task doesn't exist for this step ‚Äî create it
      const pipeStep = SITE_PIPELINE.find(p => p.step === stepNum);
      if (pipeStep) {
        const assigned = getSiteStaffByRole(pipeStep.role);
        const dl = new Date();
        dl.setDate(dl.getDate() + (pipeStep.days || 3));
        const newTask = {
          id: genId('T'),
          description: pipeStep.name + ': ' + dirName,
          direction: dirName,
          project: '–°–∞–π—Ç—ã',
          status: '–í —Ä–∞–±–æ—Ç–µ',
          priority: 'P2',
          assignee: assigned || '',
          deadline: dl.toISOString().slice(0,10)
        };
        updates.push(SB.from('tasks').insert(newTask));
      }
    }
  }

  if (updates.length > 0) {
    try {
      await Promise.all(updates);
      console.log('[RKT] syncTasksForStage: updated', updates.length, 'tasks for', dirName, '‚Üí', stage);
    } catch(e) {
      console.error('[RKT] syncTasksForStage error:', e);
    }
  }
}

async function advanceDealStage() {
  if (!currentDealId) return;
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === currentDealId);
  if (!dir) return;
  const cur = dir['stage']||'prospect';
  const idx = STAGES.findIndex(s=>s.id===cur);
  if (idx < STAGES.length - 1) {
    const nextStage = STAGES[idx+1];
    if (!confirm(`–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å ¬´${dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||currentDealId}¬ª ‚Üí ¬´${nextStage.name}¬ª?`)) return;
    await setDealStage(currentDealId, nextStage.id);
  }
}

function setDealStageConfirm(id, newStage, stageName) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  const oldName = STAGES.find(s=>s.id===(dir['stage']||'prospect'))?.name || dir['stage'];
  if (!confirm(`–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å ¬´${dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||id}¬ª\n${oldName} ‚Üí ${stageName}?`)) return;
  setDealStage(id, newStage);
}

async function markPaid(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  dir['–û–ø–ª–∞—á–µ–Ω–æ'] = true;
  try {
    const dbId = dir['ID'] || dir._dbId || dir.id;
    await SB.from('directions').update({paid: true}).eq('id', dbId);
    toast('üí∞ –û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ—á–µ–Ω–∞!');
    if (currentDealId === id) openSlideOver(id);
    renderKanban();
  } catch(err) { toast('‚ùå '+err.message,'error'); }
}

// ============================================================
// SALES CRM FUNCTIONS
// ============================================================

// –ó–∞–ø–∏—Å–∞—Ç—å –∫–∞—Å–∞–Ω–∏–µ (–∑–≤–æ–Ω–æ–∫/–∫–æ–Ω—Ç–∞–∫—Ç) ‚Äî —É–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ + –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ follow-up
async function logTouch(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  const touches = (Number(dir['–ö–∞—Å–∞–Ω–∏—è']||0)) + 1;
  dir['–ö–∞—Å–∞–Ω–∏—è'] = touches;
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π follow-up –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é: 1‚Üí2 –¥–Ω—è, 2‚Üí3, 3‚Üí5, 4‚Üí7, 5‚Üí14, 6‚Üí21, 7‚Üí30
  const intervals = [2, 3, 5, 7, 14, 21, 30, 90];
  const nextDays = intervals[Math.min(touches-1, intervals.length-1)];
  const nextDate = addDays(today(), nextDays);
  dir['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] = nextDate;
  // Append to touch log (history)
  let touchLog = [];
  try { touchLog = JSON.parse(dir['–ò—Å—Ç–æ—Ä–∏—è –∫–∞—Å–∞–Ω–∏–π'] || '[]'); } catch(e) {}
  if (!Array.isArray(touchLog)) touchLog = [];
  touchLog.push({ date: today(), n: touches, type: 'call', note: '' });
  dir['–ò—Å—Ç–æ—Ä–∏—è –∫–∞—Å–∞–Ω–∏–π'] = JSON.stringify(touchLog);
  try {
    const dbId = dir['ID'] || dir._dbId || dir.id;
    const baseUpdate = { touches, next_contact: nextDate };
    // Try with touch_log column first; gracefully fall back if column doesn't exist
    const { error: e1 } = await SB.from('directions').update({ ...baseUpdate, touch_log: touchLog }).eq('id', dbId);
    if (e1) await SB.from('directions').update(baseUpdate).eq('id', dbId);
    toast('üìû –ö–∞—Å–∞–Ω–∏–µ #'+touches+' –∑–∞–ø–∏—Å–∞–Ω–æ. –°–ª–µ–¥—É—é—â–∏–π –∑–≤–æ–Ω–æ–∫: '+nextDate);
    // –£–≤–µ–¥–æ–º–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ Telegram
    const mgr = dir['–ú–µ–Ω–µ–¥–∂–µ—Ä'];
    if (mgr) {
      notifyTaskAssigned('üìû –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É ¬´'+dir['–ù–∞–∑–≤–∞–Ω–∏–µ']+'¬ª '+nextDate, mgr, dir['–ù–∞–∑–≤–∞–Ω–∏–µ']);
    }
    if (currentDealId === id) openSlideOver(id);
    renderProjectView();
  } catch(err) { toast('‚ùå '+err.message,'error'); }
}

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (–¥–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞)
async function scheduleFollowUp(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  showCustomModal('üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', `
    <div class="form-group"><label>–ö–æ–≥–¥–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å?</label><input type="date" id="fu-date" value="${dir['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç']||addDays(today(),1)}"></div>
    <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∞</label><input type="text" id="fu-note" placeholder="–û —á—ë–º –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button type="button" onclick="document.getElementById('fu-date').value='${addDays(today(),1)}'" style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--bg2);cursor:pointer">–ó–∞–≤—Ç—Ä–∞</button>
      <button type="button" onclick="document.getElementById('fu-date').value='${addDays(today(),3)}'" style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--bg2);cursor:pointer">–ß–µ—Ä–µ–∑ 3 –¥–Ω—è</button>
      <button type="button" onclick="document.getElementById('fu-date').value='${addDays(today(),7)}'" style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--bg2);cursor:pointer">–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é</button>
    </div>
  `, async () => {
    const dt = document.getElementById('fu-date').value;
    const note = document.getElementById('fu-note').value.trim();
    if (!dt) { toast('‚ùå –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É','error'); return; }
    dir['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] = dt;
    if (note) dir['–û–ø–∏—Å–∞–Ω–∏–µ'] = (dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + '\\n['+today()+'] '+note;
    try {
      const dbId = dir['ID'] || dir._dbId || dir.id;
      const upd = {next_contact: dt};
      if (note) upd.description = dir['–û–ø–∏—Å–∞–Ω–∏–µ'];
      await SB.from('directions').update(upd).eq('id', dbId);
      toast('üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: '+dt);
      closeCustomModal();
      // –£–≤–µ–¥–æ–º–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
      const mgr = dir['–ú–µ–Ω–µ–¥–∂–µ—Ä'];
      if (mgr) notifyTaskAssigned('üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å ¬´'+dir['–ù–∞–∑–≤–∞–Ω–∏–µ']+'¬ª '+dt+(note?' ‚Äî '+note:''), mgr, dir['–ù–∞–∑–≤–∞–Ω–∏–µ']);
      if (currentDealId === id) openSlideOver(id);
      renderProjectView();
    } catch(err) { toast('‚ùå '+err.message,'error'); }
  });
}

// –ó–∞–ø–∏—Å–∞—Ç—å —Ñ–∏–¥–±–µ–∫ –∫–ª–∏–µ–Ω—Ç–∞
async function addDealFeedback(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  showCustomModal('üí¨ –§–∏–¥–±–µ–∫ –∫–ª–∏–µ–Ω—Ç–∞', `
    <div class="form-group"><label>–†–µ–∞–∫—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞</label><select id="fb-type">
      <option value="üëç –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π">üëç –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π ‚Äî –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω</option>
      <option value="üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π ‚Äî –¥—É–º–∞–µ—Ç</option>
      <option value="üëé –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π">üëé –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ‚Äî –Ω–µ —Ö–æ—á–µ—Ç</option>
      <option value="üìû –ù–µ –¥–æ–∑–≤–æ–Ω–∏–ª—Å—è">üìû –ù–µ –¥–æ–∑–≤–æ–Ω–∏–ª—Å—è</option>
      <option value="‚è≥ –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å –ø–æ–∑–∂–µ">‚è≥ –ü–æ–ø—Ä–æ—Å–∏–ª –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å –ø–æ–∑–∂–µ</option>
    </select></div>
    <div class="form-group"><label>–ß—Ç–æ —Å–∫–∞–∑–∞–ª –∫–ª–∏–µ–Ω—Ç?</label><textarea id="fb-text" rows="3" placeholder="–ß—Ç–æ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª? –ö–∞–∫–∏–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è? –ß—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å?"></textarea></div>
  `, async () => {
    const fbType = document.getElementById('fb-type').value;
    const fbText = document.getElementById('fb-text').value.trim();
    const fb = '['+today()+'] '+fbType+(fbText?' ‚Äî '+fbText:'');
    dir['–§–∏–¥–±–µ–∫'] = (dir['–§–∏–¥–±–µ–∫']||'') + (dir['–§–∏–¥–±–µ–∫']?'\\n':'') + fb;
    try {
      const dbId = dir['ID'] || dir._dbId || dir.id;
      await SB.from('directions').update({feedback: dir['–§–∏–¥–±–µ–∫']}).eq('id', dbId);
      toast('üí¨ –§–∏–¥–±–µ–∫ –∑–∞–ø–∏—Å–∞–Ω');
      closeCustomModal();
      if (currentDealId === id) openSlideOver(id);
    } catch(err) { toast('‚ùå '+err.message,'error'); }
  });
}

// –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
async function addDealNote(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  showCustomModal('üìù –ó–∞–º–µ—Ç–∫–∞', `
    <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç—É</label><textarea id="dn-text" rows="3" placeholder="–õ—é–±–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea></div>
  `, async () => {
    const note = document.getElementById('dn-text').value.trim();
    if (!note) return;
    dir['–û–ø–∏—Å–∞–Ω–∏–µ'] = (dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + (dir['–û–ø–∏—Å–∞–Ω–∏–µ']?'\\n':'') + '['+today()+'] '+note;
    try {
      const dbId = dir['ID'] || dir._dbId || dir.id;
      await SB.from('directions').update({description: dir['–û–ø–∏—Å–∞–Ω–∏–µ']}).eq('id', dbId);
      toast('üìù –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
      closeCustomModal();
      if (currentDealId === id) openSlideOver(id);
    } catch(err) { toast('‚ùå '+err.message,'error'); }
  });
}

// –û—Ç–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –ø–µ—Ä–µ–≤–æ–¥ –≤ "–û—Ç–∫–∞–∑" —Å –ø—Ä–∏—á–∏–Ω–æ–π
async function rejectDeal(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  showCustomModal('‚ùå –û—Ç–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞', `
    <div class="form-group"><label>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞</label><select id="rj-reason">
      <option value="–î–æ—Ä–æ–≥–æ">üí∞ –î–æ—Ä–æ–≥–æ</option>
      <option value="–ù–µ –Ω—É–∂–µ–Ω —Å–∞–π—Ç">ü§∑ –ù–µ –Ω—É–∂–µ–Ω —Å–∞–π—Ç</option>
      <option value="–í—ã–±—Ä–∞–ª –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞">üèÉ –í—ã–±—Ä–∞–ª –¥—Ä—É–≥—É—é —Å—Ç—É–¥–∏—é</option>
      <option value="–°–¥–µ–ª–∞–µ—Ç —Å–∞–º">üõ†Ô∏è –°–¥–µ–ª–∞–µ—Ç —Å–∞–º (Tilda, Wix)</option>
      <option value="–ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç">üìµ –ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–≤–æ–Ω–∫–∏</option>
      <option value="–ù–µ—Ç –±—é–¥–∂–µ—Ç–∞">üí∏ –ù–µ—Ç –±—é–¥–∂–µ—Ç–∞ —Å–µ–π—á–∞—Å</option>
      <option value="–î—Ä—É–≥–æ–µ">üìå –î—Ä—É–≥–æ–µ</option>
    </select></div>
    <div class="form-group"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input type="text" id="rj-comment" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏..."></div>
  `, async () => {
    const reason = document.getElementById('rj-reason').value;
    const comment = document.getElementById('rj-comment').value.trim();
    dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞'] = reason + (comment ? ' ‚Äî ' + comment : '');
    dir['stage'] = 'lost';
    try {
      const dbId = dir['ID'] || dir._dbId || dir.id;
      await SB.from('directions').update({stage: 'lost', reject_reason: dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']}).eq('id', dbId);
      toast('‚ùå –ö–ª–∏–µ–Ω—Ç ¬´'+dir['–ù–∞–∑–≤–∞–Ω–∏–µ']+'¬ª ‚Üí –û—Ç–∫–∞–∑: '+reason);
      closeCustomModal();
      closeSlideOver();
      await loadData();
      renderAll();
    } catch(err) { toast('‚ùå '+err.message,'error'); }
  });
}

async function toggleTaskDone(taskId) {
  const task = (DATA.tasks||[]).find(t => (t['ID']||t.id) === taskId);
  if (!task) return;
  const oldStatus = task['–°—Ç–∞—Ç—É—Å'];
  const newStatus = oldStatus === '–ì–æ—Ç–æ–≤–æ' ? 'üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è' : '–ì–æ—Ç–æ–≤–æ';
  task['–°—Ç–∞—Ç—É—Å'] = newStatus;
  try {
    const dbId = task['ID'] || task._dbId || task.id;
    await SB.from('tasks').update({status: newStatus}).eq('id', dbId);
    toast(newStatus === '–ì–æ—Ç–æ–≤–æ' ? '‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!' : 'üîÑ –ó–∞–¥–∞—á–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞');
    notifyTaskStatusChange(task, oldStatus, newStatus);
    if (currentDealId) openSlideOver(currentDealId);
  } catch(err) { toast('‚ùå '+err.message,'error'); }
}

// ============================================================
// REVENUE CHART (for Dashboard)
// ============================================================

// ============================================================
// IN-APP NOTIFICATIONS
// ============================================================
var NOTIFICATIONS = [];
var notifUnread = 0;

function addNotification(text, type, link) {
  type = type || 'info';
  NOTIFICATIONS.unshift({ id: Date.now(), text: text, type: type, time: new Date(), read: false, link: link || null });
  if (NOTIFICATIONS.length > 50) NOTIFICATIONS.pop();
  notifUnread++;
  renderNotifBadge();
  try { localStorage.setItem('rkt_notifs', JSON.stringify(NOTIFICATIONS.slice(0, 50))); } catch(e) {}
}
function renderNotifBadge() {
  var b = document.getElementById('notifBadge');
  if (b) { b.textContent = notifUnread; b.style.display = notifUnread > 0 ? 'flex' : 'none'; }
}
function toggleNotifPanel() {
  var p = document.getElementById('notifPanel');
  p.classList.toggle('open');
  if (p.classList.contains('open')) renderNotifList();
}
function closeNotifPanel() { document.getElementById('notifPanel').classList.remove('open'); }
function renderNotifList() {
  var el = document.getElementById('notifList');
  if (!NOTIFICATIONS.length) {
    el.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text3)"><div style="font-size:40px;margin-bottom:12px">üîï</div>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
    return;
  }
  var icons = { info: '‚ÑπÔ∏è', task: 'üìã', deal: 'üí∞', system: '‚öôÔ∏è', approval: '‚úÖ' };
  el.innerHTML = NOTIFICATIONS.slice(0, 30).map(function(n) {
    return '<div class="notif-item ' + (n.read ? '' : 'unread') + '" onclick="readNotif(' + n.id + ')">' +
      '<div class="notif-text">' + (icons[n.type] || '‚ÑπÔ∏è') + ' ' + esc(n.text) + '</div>' +
      '<div class="notif-time">' + timeAgo(n.time) + '</div></div>';
  }).join('');
}
function readNotif(id) {
  var n = NOTIFICATIONS.find(function(x) { return x.id === id; });
  if (n && !n.read) { n.read = true; notifUnread = Math.max(0, notifUnread - 1); renderNotifBadge(); }
  renderNotifList();
}
function markAllNotifRead() {
  NOTIFICATIONS.forEach(function(n) { n.read = true; });
  notifUnread = 0; renderNotifBadge(); renderNotifList();
}
function loadNotifications() {
  try {
    var saved = JSON.parse(localStorage.getItem('rkt_notifs') || '[]');
    saved.forEach(function(n) { n.time = new Date(n.time); NOTIFICATIONS.push(n); });
    notifUnread = NOTIFICATIONS.filter(function(n) { return !n.read; }).length;
    renderNotifBadge();
  } catch(e) {}
}
function timeAgo(date) {
  var d = new Date(date);
  var diff = (Date.now() - d.getTime()) / 1000;
  if (diff < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
  if (diff < 3600) return Math.floor(diff / 60) + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
  if (diff < 86400) return Math.floor(diff / 3600) + ' —á –Ω–∞–∑–∞–¥';
  return d.toLocaleDateString('ru-RU');
}

// ============================================================
// MOBILE MENU
// ============================================================
function toggleMobileMenu() {
  document.querySelector('.sidebar').classList.toggle('mobile-open');
  document.getElementById('mobileOverlay').classList.toggle('show');
}
function closeMobileMenu() {
  document.querySelector('.sidebar').classList.remove('mobile-open');
  document.querySelector('.sidebar').classList.remove('open');
  document.getElementById('mobileOverlay').classList.remove('show');
}
function initMobileMenu() {
  var btn = document.getElementById('mobileMenuBtn');
  if (!btn) return;
  function check() { btn.style.display = window.innerWidth <= 900 ? 'block' : 'none'; }
  check();
  window.addEventListener('resize', check);
  // Close sidebar on nav click (mobile)
  document.querySelectorAll('.sidebar .nav-item').forEach(function(item) {
    item.addEventListener('click', function() { if (window.innerWidth <= 900) closeMobileMenu(); });
  });
}

// ============================================================
// ONBOARDING
// ============================================================
function checkOnboarding() {
  if (localStorage.getItem('rkt_onboarded') || !USER || !USER.name) return;
  var roleTips = {
    'CEO': '–î–∞—à–±–æ—Ä–¥ KPI, –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –∏ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø.',
    '–ó–∞–º': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏, –∑–∞–¥–∞—á–∏ –∫–æ–º–∞–Ω–¥—ã, –ø–∞—Ä—Ç–Ω—ë—Ä—ã, –æ—Ç—á—ë—Ç—ã.',
    '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': '–ó–∞–¥–∞—á–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏, CRM.',
    '–ú–µ–Ω–µ–¥–∂–µ—Ä': 'CRM-–≤–æ—Ä–æ–Ω–∫–∞ —Å 9 —ç—Ç–∞–ø–∞–º–∏, —Ä–∞–±–æ—Ç–∞ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏, —Å–∫—Ä–∏–ø—Ç—ã –ø—Ä–æ–¥–∞–∂.',
    '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': '–í–∞—à–∏ –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–µ–∫—Ç–∞.'
  };
  var role = USER.role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
  var tip = roleTips[role] || roleTips['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
  var h = '<div style="text-align:center;padding:20px">';
  h += '<div style="font-size:64px;margin-bottom:16px">üëã</div>';
  h += '<h2 style="margin-bottom:8px">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + esc(USER.name) + '!</h2>';
  h += '<p style="color:var(--text2);margin-bottom:24px">–í–∞—à–∞ —Ä–æ–ª—å: <strong style="color:var(--accent)">' + esc(role) + '</strong></p>';
  h += '<div style="background:var(--bg3);border-radius:12px;padding:16px;margin-bottom:20px;text-align:left">';
  h += '<p style="margin-bottom:8px"><strong>–í–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã:</strong></p><p>' + esc(tip) + '</p></div>';
  h += '<div style="text-align:left;margin-bottom:20px;font-size:13px;color:var(--text2);line-height:1.8">';
  h += '<strong>–ü–æ–¥—Å–∫–∞–∑–∫–∏:</strong><br>';
  h += '‚Ä¢ –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º<br>';
  h += '‚Ä¢ –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–¥–µ–ª–∫–∏, —Å–∫—Ä–∏–ø—Ç—ã<br>';
  h += '‚Ä¢ ü§ñ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî –ø–æ–º–æ—â—å –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞<br>';
  h += '‚Ä¢ üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Äî –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Å–æ–±—ã—Ç–∏—è</div>';
  h += '<button class="btn btn-primary" style="width:100%" onclick="localStorage.setItem(\'rkt_onboarded\',\'1\');closeModal()">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É ‚Üí</button>';
  h += '</div>';
  showCustomModal('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RKT HUB', h);
}

// ============================================================
// SALES SCRIPTS (–∫–ª–∏–µ–Ω—Ç–æ–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
// ============================================================
function getSalesScript(stage, clientName, siteType) {
  var name = clientName || '[–ö–û–ú–ü–ê–ù–ò–Ø]';
  var type = siteType || '–õ–µ–Ω–¥–∏–Ω–≥';
  var scripts = {
    'prospect': {
      title: 'üìû –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞',
      text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–æ–≤—É—Ç [–ò–ú–Ø], –∫–æ–º–ø–∞–Ω–∏—è RKT Digital.\n' +
        '–ù–∞—à—ë–ª –≤–∞—à—É –∫–æ–º–ø–∞–Ω–∏—é ¬´' + name + '¬ª –∏ —Ö–æ—Ç–µ–ª –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–∞–π—Ç–∞.\n' +
        '–£ –≤–∞—Å –µ—Å—Ç—å –ø–∞—Ä–∞ –º–∏–Ω—É—Ç?\n\n' +
        '‚úÖ –ï—Å–ª–∏ –¥–∞: ¬´–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≤–∞—à –±–∏–∑–Ω–µ—Å? –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ö–æ—Ç–∏—Ç–µ —Ä–µ—à–∏—Ç—å —Å –ø–æ–º–æ—â—å—é —Å–∞–π—Ç–∞?¬ª\n' +
        '‚ùå –ï—Å–ª–∏ –Ω–µ—Ç: ¬´–ö–æ–≥–¥–∞ —É–¥–æ–±–Ω–æ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å? –ú–æ–≥—É –ø—Ä–∏—Å–ª–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ Telegram.¬ª\n' +
        'üö™ –û–±—Ö–æ–¥ —Å–µ–∫—Ä–µ—Ç–∞—Ä—è: ¬´–°–æ–µ–¥–∏–Ω–∏—Ç–µ —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º ‚Äî –≤–æ–ø—Ä–æ—Å –ø–æ digital-–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é –∫–æ–º–ø–∞–Ω–∏–∏.¬ª'
    },
    'contact': {
      title: 'üìã –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π',
      text: '–î–æ–±—Ä—ã–π –¥–µ–Ω—å, ' + name + '! –í–æ–∑–≤—Ä–∞—â–∞—é—Å—å –∫ –Ω–∞—à–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä—É.\n\n' +
        '1. –ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏/—Ç–æ–≤–∞—Ä—ã –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ?\n' +
        '2. –ö—Ç–æ –≤–∞—à–∞ —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è?\n' +
        '3. –ß—Ç–æ –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π —Å–∞–π—Ç –¥–ª—è –≤–∞—Å?\n' +
        '4. –ï—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã —Å–∞–π—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—Ä–∞–≤—è—Ç—Å—è?\n' +
        '5. –ö–∞–∫–æ–π –ø—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç?\n\n' +
        '‚Üí –ó–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –≤ –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞'
    },
    'interest': {
      title: 'üé® –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞',
      text: '–û—Ç–ª–∏—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏! –ü—Ä–æ—Ç–æ—Ç–∏–ø –¥–ª—è ¬´' + name + '¬ª –≥–æ—Ç–æ–≤.\n\n' +
        '‚Üí –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –¥–µ–º–æ —á–µ—Ä–µ–∑ Telegram\n' +
        '‚Üí ¬´–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å. –ß—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è?¬ª\n' +
        '‚Üí ¬´–ß—Ç–æ —Ö–æ—Ç–µ–ª–∏ –±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å?¬ª\n' +
        '‚Üí –ó–∞–ø–∏—à–∏—Ç–µ –≤—Å–µ –ø—Ä–∞–≤–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫—É'
    },
    'proto': {
      title: 'üîß –î–æ—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞',
      text: '–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç ¬´' + name + '¬ª:\n\n' +
        '‚Üí –í–Ω–µ—Å–∏—Ç–µ –ø—Ä–∞–≤–∫–∏ –ø–æ –∑–∞–º–µ—á–∞–Ω–∏—è–º –∫–ª–∏–µ–Ω—Ç–∞\n' +
        '‚Üí –ü–æ–∫–∞–∂–∏—Ç–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é\n' +
        '‚Üí ¬´–í—Å—ë –ª–∏ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç? –ì–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏?¬ª'
    },
    'proposal': {
      title: 'üí∞ –û—Ç–ø—Ä–∞–≤–∫–∞ –ö–ü',
      text: '–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ü–æ –≤–∞—à–µ–º—É –ø—Ä–æ–µ–∫—Ç—É ¬´' + type + '¬ª –¥–ª—è ¬´' + name + '¬ª:\n\n' +
        '–°—Ç–æ–∏–º–æ—Å—Ç—å: [–¶–ï–ù–ê] ‚ÇΩ\n' +
        '–°—Ä–æ–∫–∏: 5-10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π\n' +
        '–í–∫–ª—é—á–µ–Ω–æ: –¥–∏–∑–∞–π–Ω, –∞–¥–∞–ø—Ç–∏–≤, SEO-–æ—Å–Ω–æ–≤—ã, 2 —Ä–∞—É–Ω–¥–∞ –ø—Ä–∞–≤–æ–∫\n\n' +
        '‚Üí ¬´–ö–∞–∫ –≤–∞–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ? –ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Å–æ—Å—Ç–∞–≤—É —Ä–∞–±–æ—Ç?¬ª'
    },
    'negotiation': {
      title: 'ü§ù –†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏',
      text: '¬´–î–æ—Ä–æ–≥–æ¬ª ‚Üí ¬´–î–∞–≤–∞–π—Ç–µ —Å—Ä–∞–≤–Ω–∏–º: —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π –∑–∞ X‚ÇΩ, –º—ã ‚Äî –∑–∞ Y‚ÇΩ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π, –ø—Ä–∞–≤–∫–∞–º–∏ –∏ SEO. –û–∫—É–ø–∞–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ 2-3 –º–µ—Å—è—Ü–∞.¬ª\n\n' +
        '¬´–ü–æ–¥—É–º–∞—é¬ª ‚Üí ¬´–ö–æ–Ω–µ—á–Ω–æ! –ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–¥—É–º–∞—Ç—å? –ú–æ–≥—É –ø–æ–º–æ—á—å —Å —Ä–∞—Å—á—ë—Ç–∞–º–∏.¬ª\n\n' +
        '¬´–°–¥–µ–ª–∞—é —Å–∞–º¬ª ‚Üí ¬´–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –≤ SEO, —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏. –î–∞–≤–∞–π—Ç–µ —Å—Ä–∞–≤–Ω–∏–º?¬ª\n\n' +
        '¬´–£ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ¬ª ‚Üí ¬´–£—Ç–æ—á–Ω–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—Ö–æ–¥–∏—Ç –≤ –∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ? –ß–∞—Å—Ç–æ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –æ–±—ä—ë–º–µ —Ä–∞–±–æ—Ç.¬ª'
    },
    'payment': {
      title: 'üí≥ –û–ø–ª–∞—Ç–∞ –∏ –∑–∞–ø—É—Å–∫',
      text: '–û—Ç–ª–∏—á–Ω–æ! –î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–∞–±–æ—Ç –ø–æ ¬´' + name + '¬ª:\n\n' +
        '1. –í—ã—Å—Ç–∞–≤–ª—è—é —Å—á—ë—Ç –Ω–∞ [–°–£–ú–ú–ê] ‚ÇΩ\n' +
        '2. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã ‚Äî —Å—Ç–∞—Ä—Ç —Ä–∞–±–æ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 1 –¥–Ω—è\n' +
        '3. –°—Ä–æ–∫: [–°–†–û–ö] —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π\n' +
        '4. –°–≤—è–∑—å ‚Äî —á–µ—Ä–µ–∑ Telegram, –æ—Ç–≤–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤\n\n' +
        '‚Üí ¬´–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—é —Å–µ–π—á–∞—Å¬ª'
    }
  };
  return scripts[stage] || null;
}

function showSalesScript(stage, clientName, siteType) {
  var s = getSalesScript(stage, clientName, siteType);
  if (!s) { toast('–°–∫—Ä–∏–ø—Ç –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ –Ω–µ –∑–∞–¥–∞–Ω', 'info'); return; }
  var body = '<div style="padding:8px">';
  body += '<div style="background:var(--bg);border-radius:10px;padding:16px;white-space:pre-line;line-height:1.7;font-size:13px" id="scriptContent">' + esc(s.text).replace(/\\n/g, '\n') + '</div>';
  body += '<button class="btn btn-secondary" style="width:100%;margin-top:12px" onclick="var el=document.getElementById(\'scriptContent\');navigator.clipboard.writeText(el.innerText);toast(\'–°–∫—Ä–∏–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!\',\'success\')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç</button>';
  body += '</div>';
  showCustomModal(s.title, body);
}

// ============================================================
// FILE VALIDATION
// ============================================================
var ALLOWED_FILE_TYPES = [
  'application/pdf', 'image/jpeg', 'image/png', 'image/gif', 'image/webp',
  'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  'text/plain', 'text/csv', 'application/zip'
];
var MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB

// ============================================================
// DATA CACHING
// ============================================================
var DATA_CACHE = {};
var CACHE_TTL = 60000; // 60 seconds

function getCached(table) {
  var c = DATA_CACHE[table];
  if (c && Date.now() - c.time < CACHE_TTL) return c.data;
  return null;
}
function setCache(table, data) {
  DATA_CACHE[table] = { data: data, time: Date.now() };
}
function invalidateCache(table) {
  if (table) delete DATA_CACHE[table]; else DATA_CACHE = {};
}

function renderRevenueChart() {
  const dirs = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === (PROJECTS[currentProject] ? PROJECTS[currentProject].name : '–°–∞–π—Ç—ã') && d['–û–ø–ª–∞—á–µ–Ω–æ']);
  const weeks = {};
  dirs.forEach(d => {
    const date = d['–î–∞—Ç–∞']||d['–î–µ–¥–ª–∞–π–Ω']||today();
    const weekStart = new Date(date);
    weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
    const key = weekStart.toISOString().split('T')[0];
    weeks[key] = (weeks[key]||0) + (Number(d['–¶–µ–Ω–∞'])||0);
  });
  const sorted = Object.entries(weeks).sort((a,b)=>a[0].localeCompare(b[0])).slice(-8);
  if (!sorted.length) return '<div class="chart-container"><p style="text-align:center;color:var(--text3);font-size:13px">üìä –î–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ—Ç</p></div>';
  const max = Math.max(...sorted.map(([,v])=>v), 1);
  return `<div class="chart-container"><h4 style="font-size:13px;font-weight:600;margin-bottom:12px">üìà –í—ã—Ä—É—á–∫–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º</h4><div class="chart-bars">${sorted.map(([w,v]) => {
    const h = Math.max(4, (v/max)*120);
    const label = w.slice(5);
    return `<div class="chart-bar-wrap"><div class="chart-bar-value">${v>=1000?(v/1000).toFixed(0)+'–∫':v}</div><div class="chart-bar" style="height:${h}px"></div><div class="chart-bar-label">${label}</div></div>`;
  }).join('')}</div></div>`;
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN PANEL ‚Äî Settings, Logs, Leads
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADM_SETTINGS_MAP = {
  'adm-groq-key': 'groq_api_key',
  'adm-gemini-key': 'gemini_api_key',
  'adm-claude-key': 'claude_api_key',
  'adm-deepseek-key': 'deepseek_api_key',
  'adm-timeout': 'ai_timeout_ms',
  'adm-chat-enabled': 'ai_chat_enabled',
  'adm-tg-chat': 'telegram_ceo_chat_id',
  'adm-tg-token': 'tg_bot_token',
  'adm-webhook': 'n8n_webhook_url',
  'adm-greeting': 'ai_chat_greeting',
  'adm-knowledge': 'ai_knowledge_base'
};

const ADM_PROVIDERS = [
  { id:'groq', name:'Groq', icon:'‚ö°', keyField:'adm-groq-key', dbKey:'groq_api_key' },
  { id:'gemini', name:'Gemini', icon:'‚ú®', keyField:'adm-gemini-key', dbKey:'gemini_api_key' },
  { id:'claude', name:'Claude', icon:'üß†', keyField:'adm-claude-key', dbKey:'claude_api_key' },
  { id:'deepseek', name:'DeepSeek', icon:'üêã', keyField:'adm-deepseek-key', dbKey:'deepseek_api_key' }
];

function admTab(tab) {
  ['keys','logs','leads'].forEach(function(t) {
    var panel = document.getElementById('adm-panel-' + t);
    var btn = document.getElementById('adm-tab-' + t);
    if (panel) panel.style.display = t === tab ? '' : 'none';
    if (btn) {
      if (t === tab) btn.classList.add('active');
      else btn.classList.remove('active');
    }
  });
  if (tab === 'logs') adminLoadLogs();
  if (tab === 'leads') adminLoadLeads();
}

async function adminRefresh() {
  if (USER.role !== 'CEO') return;
  adminLoadSettings();
  adminLoadStats();
  adminLoadLogs();
  adminLoadLeads();
}

async function adminLoadSettings() {
  try {
    const { data } = await SB.from('settings').select('key,value');
    if (!data) return;
    const cfg = {};
    data.forEach(r => { cfg[r.key] = r.value || ''; });
    // Fill form fields
    for (const [elId, dbKey] of Object.entries(ADM_SETTINGS_MAP)) {
      const el = document.getElementById(elId);
      if (el && cfg[dbKey] !== undefined) el.value = cfg[dbKey];
    }
    // Provider status dots
    ADM_PROVIDERS.forEach(p => {
      const dot = document.getElementById('adm-st-' + p.id);
      if (dot) dot.style.background = cfg[p.dbKey] ? 'var(--accent)' : 'var(--text3)';
    });
    // Key indicator in banner
    const activeCount = ADM_PROVIDERS.filter(p => !!cfg[p.dbKey]).length;
    const ind = document.getElementById('adm-key-indicator');
    if (ind) {
      if (activeCount > 0) {
        ind.textContent = '‚úÖ ' + activeCount + '/4 –º–æ–¥–µ–ª–∏';
        ind.style.background = 'rgba(0,229,160,.15)'; ind.style.color = 'var(--accent)';
      } else {
        ind.textContent = '‚ùå –ù–µ—Ç –∫–ª—é—á–µ–π';
        ind.style.background = 'rgba(231,76,60,.15)'; ind.style.color = 'var(--red)';
      }
    }
    // Cascade order
    admRenderCascade(cfg.ai_cascade || '["groq","gemini","claude","deepseek"]');
  } catch(e) { console.warn('Admin settings load:', e); }
}

function admRenderCascade(cascadeJson) {
  let order;
  try { order = JSON.parse(cascadeJson); } catch(e) { order = ['groq','gemini','claude','deepseek']; }
  const names = {groq:'‚ö° Groq',gemini:'‚ú® Gemini',claude:'üß† Claude',deepseek:'üêã DeepSeek'};
  const colors = {groq:'#f55036',gemini:'#4285f4',claude:'#b197fc',deepseek:'#00b4d8'};
  const el = document.getElementById('adm-cascade');
  if (!el) return;
  el.innerHTML = order.map((p, i) => {
    return '<div style="display:flex;align-items:center;gap:8px;padding:10px 16px;border-radius:var(--radius-sm);background:var(--bg);border:1px solid var(--border);cursor:move;transition:opacity .15s" draggable="true" data-provider="'+p+'">' +
      '<span style="font-size:14px;font-weight:700;color:'+colors[p]+'">'+(i+1)+'</span>' +
      '<span style="font-size:13px">'+names[p]+'</span></div>';
  }).join('');
  // Drag-and-drop handlers
  let dragSrc = null;
  el.querySelectorAll('[data-provider]').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      dragSrc = this;
      e.dataTransfer.effectAllowed = 'move';
      this.style.opacity = '0.4';
    });
    item.addEventListener('dragend', function() {
      this.style.opacity = '';
      el.querySelectorAll('[data-provider]').forEach(function(i) { i.style.border = '1px solid var(--border)'; });
    });
    item.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      this.style.border = '1px solid var(--accent)';
    });
    item.addEventListener('dragleave', function() {
      this.style.border = '1px solid var(--border)';
    });
    item.addEventListener('drop', function(e) {
      e.preventDefault();
      this.style.border = '1px solid var(--border)';
      if (dragSrc && dragSrc !== this) {
        const items = Array.from(el.querySelectorAll('[data-provider]'));
        const srcIdx = items.indexOf(dragSrc);
        const tgtIdx = items.indexOf(this);
        if (srcIdx < tgtIdx) el.insertBefore(dragSrc, this.nextSibling);
        else el.insertBefore(dragSrc, this);
        // –ü–µ—Ä–µ–Ω—É–º–µ—Ä–æ–≤–∞—Ç—å
        el.querySelectorAll('[data-provider]').forEach(function(d, i) {
          d.querySelector('span:first-child').textContent = i + 1;
        });
      }
    });
  });
}

async function adminSaveSettings() {
  const statusEl = document.getElementById('adm-save-status');
  statusEl.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
  let saved = 0;
  for (const [elId, dbKey] of Object.entries(ADM_SETTINGS_MAP)) {
    const el = document.getElementById(elId);
    if (!el) continue;
    try {
      const { error } = await SB.from('settings').upsert({ key: dbKey, value: el.value, updated_at: new Date().toISOString() }, { onConflict: 'key' });
      if (!error) saved++;
    } catch(e) {}
  }
  // Save cascade order
  const cascadeEls = document.querySelectorAll('#adm-cascade [data-provider]');
  const cascade = Array.from(cascadeEls).map(e => e.dataset.provider);
  if (cascade.length) {
    try { await SB.from('settings').upsert({ key:'ai_cascade', value:JSON.stringify(cascade), updated_at:new Date().toISOString() }, { onConflict:'key' }); saved++; } catch(e){}
  }
  statusEl.innerHTML = '<span style="color:var(--accent)">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ' + saved + ' –Ω–∞—Å—Ç—Ä–æ–µ–∫</span>';
  setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
  adminLoadSettings(); // Refresh dots
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ API-–∫–ª—é—á–µ–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 1 —Å–µ–∫ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–≤–æ–¥–∞
const debouncedAdmKeySave = debounce(async function() {
  for (const [elId, dbKey] of Object.entries(ADM_SETTINGS_MAP)) {
    const el = document.getElementById(elId);
    if (!el || !el.value.trim()) continue;
    try { await SB.from('settings').upsert({ key: dbKey, value: el.value, updated_at: new Date().toISOString() }, { onConflict: 'key' }); } catch(e) {}
  }
  const s = document.getElementById('adm-save-status');
  if (s) { s.innerHTML = '<span style="color:var(--accent)">‚úÖ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>'; setTimeout(() => { s.innerHTML = ''; }, 2000); }
}, 1000);

async function admTestProvider(provider) {
  const p = ADM_PROVIDERS.find(x => x.id === provider);
  if (!p) return;
  const key = document.getElementById(p.keyField)?.value?.trim();
  const dot = document.getElementById('adm-st-' + provider);
  if (!key) { if(dot) dot.style.background='var(--red)'; toast('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á ' + p.name, 'error'); return; }
  if(dot) dot.style.background='var(--orange)';

  try {
    let ok = false;
    if (provider === 'groq') {
      const r = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
        body:JSON.stringify({model:'llama-3.3-70b-versatile',messages:[{role:'user',content:'Hi'}],max_tokens:5})
      }); ok = r.ok; if(!ok){const e=await r.text();throw new Error(e.substring(0,100));}
    } else if (provider === 'gemini') {
      const r = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+key, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({contents:[{parts:[{text:'Hi'}]}],generationConfig:{maxOutputTokens:5}})
      }); ok = r.ok; if(!ok){const e=await r.text();throw new Error(e.substring(0,100));}
    } else if (provider === 'claude') {
      const r = await fetch('https://api.anthropic.com/v1/messages', {
        method:'POST', headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
        body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:5,messages:[{role:'user',content:'Hi'}]})
      }); ok = r.ok; if(!ok){const e=await r.text();throw new Error(e.substring(0,100));}
    } else if (provider === 'deepseek') {
      const r = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
        body:JSON.stringify({model:'deepseek-chat',messages:[{role:'user',content:'Hi'}],max_tokens:5})
      }); ok = r.ok; if(!ok){const e=await r.text();throw new Error(e.substring(0,100));}
    }
    if(dot) dot.style.background='var(--accent)';
    toast('‚úÖ ' + p.name + ' —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success');
  } catch(e) {
    if(dot) dot.style.background='var(--red)';
    toast('‚ùå ' + p.name + ': ' + e.message, 'error');
  }
}

async function adminLoadStats() {
  const today = new Date().toISOString().split('T')[0];
  try {
    const { data: logs } = await SB.from('ai_logs').select('type,tokens_in,tokens_out').gte('created_at', today + 'T00:00:00');
    if (logs) {
      const chats = logs.filter(l => l.type === 'chat').length;
      const errors = logs.filter(l => l.type === 'error').length;
      const leads = logs.filter(l => l.type === 'lead').length;
      const tokens = logs.reduce((s, l) => s + (l.tokens_in || 0) + (l.tokens_out || 0), 0);
      document.getElementById('adm-chats-today').textContent = chats;
      document.getElementById('adm-errors-today').textContent = errors;
      document.getElementById('adm-errors-today').style.color = errors > 0 ? 'var(--red)' : 'var(--text3)';
      document.getElementById('adm-leads-today').textContent = leads;
      document.getElementById('adm-tokens-today').textContent = tokens > 1000 ? (tokens / 1000).toFixed(1) + 'k' : tokens;
    }
  } catch(e) {}
}

async function adminLoadLogs() {
  const filter = document.getElementById('adm-log-filter')?.value || 'all';
  const container = document.getElementById('adm-logs');
  try {
    let q = SB.from('ai_logs').select('*').order('created_at', { ascending: false }).limit(50);
    if (filter !== 'all') q = q.eq('type', filter);
    const { data } = await q;
    if (!data || !data.length) {
      container.innerHTML = '<div style="text-align:center;padding:48px 20px"><div style="font-size:40px;margin-bottom:12px;opacity:.4">üìã</div><div style="color:var(--text3);font-size:13px">–õ–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div><div style="color:var(--text3);font-size:11px;margin-top:4px">–ü–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ò–ò-—á–∞—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ</div></div>';
      return;
    }
    container.innerHTML = data.map(function(l) {
      const time = new Date(l.created_at).toLocaleString('ru', {hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});
      const isErr = l.type === 'error';
      const isLead = l.type === 'lead';
      const icon = isErr ? 'üî¥' : isLead ? 'üü¢' : 'üí¨';
      const label = isErr ? '–û—à–∏–±–∫–∞' : isLead ? '–ó–∞—è–≤–∫–∞' : '–ß–∞—Ç';
      const labelColor = isErr ? 'var(--red)' : isLead ? 'var(--accent)' : 'var(--text3)';
      const bg = isErr ? 'rgba(231,76,60,.04)' : '';
      const msg = isErr ? (l.error_code + ': ' + (l.error_message||'').slice(0,80)) : (l.user_message||'').slice(0,80);
      const tok = (l.tokens_in||0) + (l.tokens_out||0);
      const dur = l.duration_ms ? (l.duration_ms/1000).toFixed(1)+'—Å' : '';
      const model = (l.model||'').replace('claude-','').replace('-20250929','').replace('-20251001','').replace('haiku-4-5','Haiku').replace('sonnet-4-5','Sonnet');
      return '<div style="padding:12px 16px;border-bottom:1px solid var(--border);background:'+bg+';display:flex;align-items:center;gap:12px">' +
        '<div style="font-size:16px;flex-shrink:0">'+icon+'</div>' +
        '<div style="flex:1;min-width:0">' +
          '<div style="display:flex;align-items:center;gap:8px;margin-bottom:2px"><span style="font-size:11px;font-weight:600;color:'+labelColor+'">'+label+'</span>' +
          (model ? '<span style="font-size:10px;padding:1px 6px;border-radius:4px;background:rgba(177,151,252,.1);color:#b197fc">'+model+'</span>' : '') +
          (tok ? '<span style="font-size:10px;color:var(--text3)">'+tok+' tok</span>' : '') +
          (dur ? '<span style="font-size:10px;color:var(--text3)">'+dur+'</span>' : '') +
          '</div>' +
          '<div style="font-size:12px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+msg+'</div>' +
        '</div>' +
        '<div style="font-size:10px;color:var(--text3);white-space:nowrap;flex-shrink:0">'+time+'</div></div>';
    }).join('');
  } catch(e) {
    container.innerHTML = '<div style="text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px">‚ö†Ô∏è</div><div style="color:var(--red);font-size:12px">–¢–∞–±–ª–∏—Ü–∞ ai_logs –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.<br>–ó–∞–ø—É—Å—Ç–∏—Ç–µ migration_v8_admin.sql –≤ Supabase</div></div>';
  }
}

// ============================================================
// RENDER: LEADS PAGE (–ó–∞—è–≤–∫–∏)
// ============================================================
async function renderLeadsPage() {
  var statsEl = document.getElementById('leadsStats');
  var tableEl = document.getElementById('leadsTable');
  if (!tableEl) return;

  tableEl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div>';

  try {
    var { data: leads } = await SB.from('client_requests').select('*').order('created_at', { ascending: false });
    if (!leads) leads = [];

    // Also gather directions that came from forms
    var intakeDirs = (DATA.directions||[]).filter(function(d) {
      var src = (d['–ò—Å—Ç–æ—á–Ω–∏–∫']||'').toLowerCase();
      return src.includes('–∑–∞—è–≤–∫–∞') || src.includes('—á–∞—Ç') || src.includes('—Ñ–æ—Ä–º–∞') || src.includes('intake') || src.includes('order');
    });

    var allLeads = leads.slice();

    // Stats
    var totalLeads = allLeads.length;
    var newLeads = allLeads.filter(function(l) { return l.status === 'new'; }).length;
    var today = new Date().toISOString().slice(0,10);
    var todayLeads = allLeads.filter(function(l) { return (l.created_at||'').slice(0,10) === today; }).length;

    if (statsEl) {
      statsEl.innerHTML =
        '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--accent)">'+totalLeads+'</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div></div>'+
        '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--green)">'+newLeads+'</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–ù–æ–≤—ã—Ö</div></div>'+
        '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--blue)">'+todayLeads+'</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–°–µ–≥–æ–¥–Ω—è</div></div>'+
        '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--orange)">'+intakeDirs.length+'</div><div style="font-size:10px;color:var(--text3);text-transform:uppercase">–ò–∑ —Ñ–æ—Ä–º</div></div>';
    }

    // Update badge
    var badge = document.getElementById('badge-leads');
    if (badge) badge.textContent = newLeads || totalLeads || '0';

    if (!allLeads.length) {
      tableEl.innerHTML = '<div style="text-align:center;padding:48px 20px"><div style="font-size:40px;margin-bottom:12px;opacity:.4">üìù</div><div style="color:var(--text3);font-size:13px">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div><div style="color:var(--text3);font-size:11px;margin-top:4px">–ü–æ—è–≤—è—Ç—Å—è –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –ò–ò-—á–∞—Ç –∏–ª–∏ —Ñ–æ—Ä–º—É</div></div>';
      return;
    }

    var html = '<div class="table-wrap"><table class="data-table" style="width:100%;border-collapse:collapse;font-size:13px;min-width:600px">';
    html += '<thead><tr style="border-bottom:2px solid var(--border);text-align:left">';
    html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ò–º—è</th>';
    html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ö–æ–Ω—Ç–∞–∫—Ç</th>';
    html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>';
    html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–ò—Å—Ç–æ—á–Ω–∏–∫</th>';
    html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–î–∞—Ç–∞</th>';
    html += '<th style="padding:10px 8px;color:var(--text3);font-size:11px;text-transform:uppercase">–°—Ç–∞—Ç—É—Å</th>';
    html += '</tr></thead><tbody>';

    allLeads.forEach(function(l) {
      var time = l.created_at ? new Date(l.created_at).toLocaleString('ru', {day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
      var isNew = l.status === 'new';
      var statusHtml = isNew
        ? '<span style="background:rgba(0,229,160,.12);color:var(--accent);padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600">üÜï –ù–æ–≤–∞—è</span>'
        : '<span style="background:rgba(255,255,255,.04);color:var(--text3);padding:3px 10px;border-radius:6px;font-size:11px">'+esc(l.status||'‚Äî')+'</span>';
      html += '<tr style="border-bottom:1px solid var(--border);transition:background .2s" onmouseover="this.style.background=\'var(--bg3)\'" onmouseout="this.style.background=\'\'">';
      html += '<td style="padding:10px 8px;font-weight:600">'+esc(l.name||'–ë–µ–∑ –∏–º–µ–Ω–∏')+'</td>';
      html += '<td style="padding:10px 8px">'+(l.phone?'üìû '+esc(l.phone):'')+(l.email?'<div style="font-size:11px;color:var(--text2)">‚úâÔ∏è '+esc(l.email)+'</div>':'')+'</td>';
      html += '<td style="padding:10px 8px">'+esc(l.direction||'‚Äî')+'</td>';
      html += '<td style="padding:10px 8px;font-size:12px;color:var(--text2)">'+esc(l.source||'‚Äî')+'</td>';
      html += '<td style="padding:10px 8px;font-size:12px;color:var(--text2)">'+time+'</td>';
      html += '<td style="padding:10px 8px">'+statusHtml+'</td>';
      html += '</tr>';
      if (l.comment) {
        html += '<tr style="background:rgba(0,229,160,0.02);font-size:12px"><td colspan="6" style="padding:4px 12px 8px 20px;color:var(--text3)">üí¨ '+esc(l.comment.slice(0,120))+'</td></tr>';
      }
    });

    html += '</tbody></table></div>';
    tableEl.innerHTML = html;
  } catch(e) {
    tableEl.innerHTML = '<div style="text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px">‚ö†Ô∏è</div><div style="color:var(--red);font-size:12px">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—è–≤–∫–∏.<br>–¢–∞–±–ª–∏—Ü–∞ client_requests –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.</div></div>';
  }
}

async function adminLoadLeads() {
  const container = document.getElementById('adm-leads');
  try {
    const { data } = await SB.from('client_requests').select('*').order('created_at', { ascending: false }).limit(20);
    if (!data || !data.length) {
      container.innerHTML = '<div style="text-align:center;padding:48px 20px"><div style="font-size:40px;margin-bottom:12px;opacity:.4">üìù</div><div style="color:var(--text3);font-size:13px">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div><div style="color:var(--text3);font-size:11px;margin-top:4px">–ü–æ—è–≤—è—Ç—Å—è –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –ò–ò-—á–∞—Ç –∏–ª–∏ —Ñ–æ—Ä–º—É</div></div>';
      return;
    }
    container.innerHTML = data.map(function(l) {
      const time = new Date(l.created_at).toLocaleString('ru', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
      const isNew = l.status === 'new';
      const dirColors = {'–°–∞–π—Ç—ã':'#00e5a0','AI-–∫–æ–Ω—Ç–µ–Ω—Ç':'#f1c40f','–ò–ò-–∞–≥–µ–Ω—Ç—ã':'#b197fc','–ú–µ–¥–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ':'#3498db'};
      const dirColor = dirColors[l.direction] || 'var(--text3)';
      return '<div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px">' +
        '<div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,rgba(0,229,160,.1),rgba(0,184,148,.05));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">üë§</div>' +
        '<div style="flex:1;min-width:0">' +
          '<div style="font-size:13px;font-weight:600;color:var(--text)">' + (l.name||'–ë–µ–∑ –∏–º–µ–Ω–∏') + '</div>' +
          '<div style="display:flex;gap:8px;align-items:center;margin-top:3px;flex-wrap:wrap">' +
            '<span style="font-size:11px;color:var(--text2)">üì± ' + (l.phone||'‚Äî') + '</span>' +
            (l.direction ? '<span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(255,255,255,.04);color:'+dirColor+';border:1px solid '+dirColor+'33">' + l.direction + '</span>' : '') +
            (l.city ? '<span style="font-size:11px;color:var(--text3)">üèô ' + l.city + '</span>' : '') +
          '</div>' +
          (l.comment ? '<div style="font-size:11px;color:var(--text3);margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">üí¨ ' + l.comment.slice(0,60) + '</div>' : '') +
        '</div>' +
        '<div style="text-align:right;flex-shrink:0">' +
          '<div style="padding:3px 10px;border-radius:6px;font-size:10px;font-weight:600;' + (isNew ? 'background:rgba(0,229,160,.12);color:var(--accent)' : 'background:rgba(255,255,255,.04);color:var(--text3)') + '">' + (isNew ? 'üÜï –ù–æ–≤–∞—è' : l.status) + '</div>' +
          '<div style="font-size:10px;color:var(--text3);margin-top:4px">' + time + '</div>' +
          '<div style="font-size:10px;color:var(--text3)">' + (l.source||'') + '</div>' +
        '</div></div>';
    }).join('');
  } catch(e) {
    container.innerHTML = '<div style="text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px">‚ö†Ô∏è</div><div style="color:var(--red);font-size:12px">–¢–∞–±–ª–∏—Ü–∞ client_requests –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.<br>–ó–∞–ø—É—Å—Ç–∏—Ç–µ migration_v8_admin.sql –≤ Supabase</div></div>';
  }
}

</script>
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<!-- NOTIFICATION PANEL -->
<div class="notif-panel" id="notifPanel">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:20px;border-bottom:1px solid var(--border)">
    <h3 style="font-size:16px;font-weight:600">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
    <div style="display:flex;gap:8px">
      <button onclick="markAllNotifRead()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ</button>
      <button onclick="closeNotifPanel()" style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:20px">‚úï</button>
    </div>
  </div>
  <div id="notifList"></div>
</div>

<!-- Loading overlay for async operations -->
<div id="loading-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;
  display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px">
  <div class="spinner"></div>
  <div id="loading-text" style="color:#fff;font-size:14px;font-family:var(--font)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<script>
// Global loading helpers
function showLoading(text) {
  const el = document.getElementById('loading-overlay');
  if (el) { el.style.display = 'flex'; document.getElementById('loading-text').textContent = text || '–ó–∞–≥—Ä—É–∑–∫–∞...'; }
}
function hideLoading() {
  const el = document.getElementById('loading-overlay');
  if (el) el.style.display = 'none';
}
</script>
</body>
</html>
